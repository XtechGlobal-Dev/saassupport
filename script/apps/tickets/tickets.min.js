<<<<<<< HEAD
﻿
/*
 * ==========================================================
 * TICKETS SCRIPT
 * ==========================================================
 *
 * Tickets App main Javascript file. © 2017-2025 board.support. All rights reserved.
 * 
 */

'use strict';

(function ($) {

    var main;
    var main_panel;
    var conversation_area;
    var panel;
    var ticket_panel;
    var ticket_main_panel;
    var editor;
    var active_panel;
    var left_conversations;
    var cache_agents = {};
    var cache_account = {};
    var main_title;
    var ticket_main_title;
    var agent_profile;
    var user_profile;
    var width;
    var mobile = $(window).width() < 426;
    var recaptcha = false;

    /*
    * ----------------------------------------------------------
    * # FUNCTIONS
    * ----------------------------------------------------------
    */

    var SBTickets = {

        showInitials: function (container, className) {
            console.log(container);
            const containers = $('.' + container + ' .' + className);
            containers.each(function () {
                const container = $(this);
                const img = container.find('img');
                const name = img.attr("data-name") || "";
                const initials = name
                    .split(" ")
                    .map(word => word[0])
                    .join("")
                    .substring(0, 2)
                    .toUpperCase();

                
                const span = container.find(".initials");
                const userInitials = container.find('.user-initials');

                // Fallback: if image is broken, use initials
                function showInitialsFallback() {
                    img.hide();
                    if (span.length) {
                        userInitials.css("display", "inline-block");
                        span.text(initials || "NA");
                    }
                }

                // Attach error event
                img.on('error', function(){
                    console.log('error0');
                    showInitialsFallback();
                });

                // Trigger fallback if image is already broken (e.g. 404 cached)
                if (!img.prop('complete') || typeof img[0].naturalWidth === "undefined" || img[0].naturalWidth === 0) {
                    console.log('error');
                    showInitialsFallback();
                }

                // If the image source is a default user icon, show initials
                if (img.attr('src') && img.attr('src').includes('user.svg')) {
                    console.log('error2');
                    showInitialsFallback();
                }
            });
        },
        // Display the conversation area or a panel
        showPanel: function (name = '', title = false) {
            console.log('$$$1',name);
            let previous = active_panel;
            active_panel = name;
            main.addClass('sb-panel-active sb-load').removeClass('sb-panel-form').attr('data-panel', name);
            if (recaptcha) recaptcha.hide();
            switch (name) {
                case 'privacy':
                    SBF.ajax({
                        function: 'get-block-setting',
                        value: 'privacy'
                    }, (response) => {
                        setTitle(sb_(response['title']));
                        panel.append(`<div class="sb-privacy sb-init-form" data-decline="${sb_(response['decline'].replace(/"/g, ''))}"><div class="sb-text">${sb_(response['message'])}</div>` + (response['link'] != '' ? `<a target="_blank" href="${response['link']}">${sb_(response['link-name'])}</a>` : '') + `<div class="sb-buttons"><a class="sb-btn sb-approve">${sb_(response['btn-approve'])}</a><a class="sb-btn sb-decline">${sb_(response['btn-decline'])}</a></div></div>`);
                    });
                    this.showSidePanels(false);
                    break;
                case 'articles':
                    setTitle(sb_(title == false ? 'Articles' : title));
                    this.showSidePanels(false);
                    break;
                case 'edit-profile':
                case 'login':
                case 'registration':
                    $('.user_header').addClass('d-none');
                    $('.user_header .header_left h2').removeClass('sb-active');
                    $('.user_header .header_left h2:first').addClass('sb-active');

                    let is_edit_profile = name == 'edit-profile';
                    this.showSidePanels(false);
                    main.addClass('sb-panel-form');
                    if (name in cache_account) {
                        panel.html(cache_account[name]);
                        setTitle(sb_(panel.find('.sb-top').html()));
                    } else {
                        SBF.ajax({
                            function: 'get-rich-message',
                            name: (is_edit_profile ? 'registration' : name) + '-tickets'
                        }, (response) => {
                            panel.html(response);
                            let title = panel.find('.sb-top').html();
                            if (is_edit_profile) {
                                panel.find('.sb-top').html(sb_('Edit profile'));
                            }
                            setTitle(sb_(title));
                            setTimeout(function () {
                                setTitle(sb_(title));
                            }, 300);
                            panel.find('.sb-link-area').insertAfter('.sb-buttons');
                            panel.find('.sb-info').insertBefore('.sb-buttons');
                            cache_account[name] = panel.html();
                        });
                        panel.html('<div class="sb-loading"></div>');
                    }
                    break;
                case 'new-ticket':
                    let names = { 'title': 'Title', 'message': 'Message', 'panel': 'Create a new ticket', 'button': 'Create a new ticket' };
                    //this.showSidePanels(true); // Show the side panels by default
                    // if (SBF.setting('tickets_names')) {
                    //     let names_new = SBF.setting('tickets_names');
                    //     for (var key in names_new) {
                    //         if (names_new[key]) names[key.replace('tickets-names-', '')] = names_new[key];
                    //     }
                    // }
                    setTicketTitle(sb_(names.panel));
                    ticket_panel.html(`<div class="sb-info"></div><div id="subject" class="sb-input sb-input-text sb-ticket-title"><span>${sb_(names.title)}</span><input type="text" required></div>${main.find('.sb-ticket-fields').html()}<div id="description" class="sb-input sb-editor-cnt"><span>${sb_(names.message)}</span></div>   <div class="sb-btn sb-icon sb-create-ticket"><i class="sb-icon-plus"></i>${sb_(names.button)}</div>`);
                    ticket_main_panel.find('.sb-editor-cnt').append(editor);
                    if (SBF.setting('tickets_recaptcha')) {
                        if (recaptcha) {
                            recaptcha.show();
                        } else {
                            $.getScript('https://www.google.com/recaptcha/api.js?render=' + SBF.setting('tickets_recaptcha'), () => {
                                setTimeout(() => { recaptcha = $('.grecaptcha-badge') }, 500);
                            });
                        }
                    }
                    break;
                default:
                    $('.user_header').removeClass('d-none');
                    const pImg = activeUser().details?.profile_image ?? '';
                    console.log(activeUser().details);
                    
                    main.find('.user_profile .sb_name').html(activeUser()?.name);
                    main.find('.user_profile .user_type').html(activeUser()?.type);
                    main.find('.user_profile .avatar').attr('src',pImg).attr('data-name',activeUser()?.name);
                    this.showSidePanels(true);

                    setTimeout(function(){
                        SBTickets.showInitials('user_header','user_profile');
                    },30)
                    	
                    if (previous == 'new-ticket') {
                        editor.find('textarea').val('');
                        editor.sbActive(false).removeClass('sb-error');
                        conversation_area.after(editor);
                    }
                    panel.html('');
                    main.removeClass('sb-panel-active sb-load').removeAttr('data-panel');
                    setConversationName(SBChat.conversation);
                    break;
            }
            SBF.event('SBPanelActive', name);
            setTimeout(function () {
                main.removeClass('sb-load');
            }, 300);
        },

        // Display or hide the side panels
        showSidePanels: function (show = true) {
            let button = main.find('.sb-btn-collapse');
            setCollapsing();
            if (!show || width > 800) {
                let panels = main.find('.sb-panel-left,.sb-panel-right');
                if (show) {
                    panels.removeClass('sb-collapsed');
                } else {
                    panels.addClass('sb-collapsed');
                }
            } else if (width <= 800) {
                $(button).sbActive(true);
            }
            $(button).css('display', show ? '' : 'none');
        },

        // Get the agent details and display them
        setAgent: function (agent_id) {
            let label = main.find('.sb-agent-label').sbActive(false);
            SBChat.agent_id = agent_id;
            if (agent_id in cache_agents) {
                let agent = cache_agents[agent_id];
                $(agent_profile).setProfile(agent.name, agent.image).sbActive(true);
                SBChat.updateUsersActivity();
                if ('details' in agent) {
                    SBF.getLocationTimeString(agent.extra, (response) => {
                        $(label).html((agent.get('flag') ? `<img src="${SB_URL}/media/flags/${agent.get('flag')}">` : '<i class="sb-icon sb-icon-marker"></i>') + response).sbActive(true);
                    });
                }
            } else {
                SBF.ajax({
                    function: 'get-agent',
                    agent_id: agent_id
                }, (response) => {
                    if (response != false) {
                        cache_agents[agent_id] = new SBUser(response);
                        this.setAgent(agent_id);
                    }
                });
            }
        },

        // Activate a conversation
        activateConversation: function (conversation) {
            if (conversation instanceof SBConversation) {
                let last_agent = SBChat.lastAgent();
                let details = ['id', 'creation_time', 'last_update'];
                let code = '';

                // Activate the conversation
                this.selectConversation(conversation.id);
                setConversationName(conversation);
                main.find('.sb-panel-right .sb-scroll-area > div').sbActive(false);

                // Set the agent details
                if (last_agent) {
                    $(agent_profile).setProfile(last_agent['full_name'], last_agent['profile_image']);
                    this.setAgent(last_agent['user_id']);
                    setTimeout(() => { SBChat.updateUsersActivity() }, 300);
                } else {
                    $(agent_profile).sbActive(false);
                }

                // Set the ticket details
                if (conversation.get('department') != '') {
                    SBChat.getDepartmentCode(conversation.get('department'), (response) => {
                        let department = main.find('.sb-department');
                        $(department).html(`<span class="sb-title">${$(department).data('label')}</span>${response}`).sbActive(true);
                    });
                }
                for (var i = 0; i < details.length; i++) {
                    let values;
                    switch (details[i]) {
                        case 'id':
                            values = ['padlock', sb_('Ticket ID'), conversation.id];
                            break;
                        case 'creation_time':
                            values = ['calendar', sb_('Creation time'), SBF.beautifyTime(conversation.get('creation_time'), true)];
                            break;
                        case 'last_update':
                            values = ['reload', sb_('Last update'), SBF.beautifyTime(conversation.getLastMessage() ? conversation.getLastMessage().get('creation_time') : conversation.get('last_update_time'), true)];
                            break;
                    }
                    code += `<div data-id="${details[i]}"><i class="sb-icon sb-icon-${values[0]}"></i><span>${values[1]}</span><div>${values[2]}</div></div>`;
                }
                main.find('.sb-ticket-details').html(code);

                // Attachments
                let attachments = conversation.getAttachments();
                code = '';
                for (var i = 0; i < attachments.length; i++) {
                    code += `<a href="${attachments[i][1]}" target="_blank"><i class="sb-icon sb-icon-file"></i>${attachments[i][0]}</a>`;
                }
                main.find('.sb-conversation-attachments').html((code ? `<div class="sb-title">${sb_('Attachments')}</div>` : '') + code);

                // Miscellaneous
                conversation_area.sbLoading(false);
            } else {
                SBF.error('Value not of type SBConversation', 'activateConversation');
            }
        },

        // Apply the selected style to the active conversation
        selectConversation: function (conversation_id) {
            let conversation = left_conversations.find(`[data-conversation-id="${conversation_id}"]`);
            left_conversations.find('> li').sbActive(false);
            if (conversation.attr('data-conversation-status') == 1) {
                conversation.attr('data-conversation-status', 0);
            }
            conversation.find('[data-count]').remove();
            conversation.sbActive(true);
        },

        // Get the ID of the active conversation
        getActiveConversation: function (type = '') {
            let conversation = left_conversations.find(' > .sb-active');
            return conversation.length ? (type == 'ID' ? conversation.attr('data-conversation-id') : conversation) : false;
        },

        // Tickets welcome message
        welcome: function () {
            let message = SBF.setting('tickets_welcome_message');
            if (message && !SBF.storage('tickets-welcome')) {
                setTimeout(() => {
                    SBChat.sendMessage(SBF.setting('bot_id'), message);
                    SBF.storage('tickets-welcome', true);
                }, 1000);
            }
        },

        // Initialize the tickets area
        init: function () {
            if(activeUser())
            {
                $('.user_header').removeClass('d-none');
            }
            main = $('body').find('.sb-tickets');
            main_panel = main.find(' > div > .sb-panel-main');
            panel = main_panel.find('.sb-panel');
            ticket_panel = $('.tickets-list-area').find('.sb-panel');
            ticket_main_panel = $('.tickets-list-area').find('.sb-panel-main');
            editor = main_panel.find('.sb-editor');
            main_title = main_panel.find(' > .sb-top .sb-title');
            ticket_main_title = ticket_main_panel.find(' > .sb-top .sb-title');
            left_conversations = main.find('.sb-user-conversations');
            conversation_area = main_panel.find('.sb-list');
            agent_profile = main.find('.sb-profile-agent');
            user_profile = main.find('.sb-panel-right > .sb-top .sb-profile');
            width = main.width();
            cache_agents[SBF.setting('bot_id')] = { name: SBF.setting('bot_name'), image: SBF.setting('bot_image') };
            ticketsInit();

            if(activeUser())
            {
                const img = activeUser().details?.profile_image ?? '';
                main.find('.user_profile .avatar').attr('src',img).attr('data-name',activeUser()?.name);
                main.find('.user_profile .sb_name').html(activeUser()?.name);
                main.find('.user_profile .user_type').html(activeUser()?.type);
                this.showInitials('user_header','user_profile');
            }


            if (!main.length) {
                return;
            }
            
            if (SBF.setting('tickets_registration_required') && (!activeUser() || ['visitor', 'lead'].includes(activeUser().type))) {
                let redirect = SBF.setting('tickets_registration_redirect');
                if (redirect) {
                    document.location = redirect + (redirect.includes('?') ? '&' : '?') + 'sb=true';
                    return;
                } else {
                     console.log('asasas0');
                    main.addClass('sb-no-conversations');
                    SBTickets.showPanel(SBF.setting('tickets_default_form'));
                }
            } else {
                
                if (activeUser() && activeUser().conversations.length) {
                    if (!SBTickets.getActiveConversation()) {
                        SBChat.openConversation(SBF.getURL('conversation') ? SBF.getURL('conversation') : activeUser().conversations[0].id);
                    }

                    $(document).find('.header_left h2:first').trigger('click');  // load list of tickets
                } 
                else if(activeUser())
                {

                }
                else {
                    main.addClass('sb-no-conversations');
                    if (SBF.setting('privacy') && !SBF.storage('privacy_approved')) {
                        SBTickets.showPanel('privacy');
                    } else if (!SBF.setting('tickets_disable_first')) {
                        SBTickets.showPanel('new-ticket');
                        console.log();
                    } else {
                        setConversationName();
                    }
                    console.log('hhheeee13');
                }
            }
            //let height = parseInt(SBF.null(main.data('height')) ? ($(window).height()) : main.data('height'));
            let height = parseInt(window.innerHeight) ? (window.innerHeight) : main.data('height');
            let height_offset = parseInt(SBF.null(main.data('offset')) ? 0 : main.data('offset'));
            if (width <= 800) {
                main.addClass('sb-800');
                main.find('.sb-panel-left,.sb-panel-right').addClass('sb-collapsed');
                main.find('.sb-btn-collapse').sbActive(true);
            } else if (width <= 1000) {
                main.addClass('sb-1000');
            } else if (width <= 1300) {
                main.addClass('sb-1300');
            }
            setUserProfile();
            


            console.log(window.innerHeight);
            main.removeClass('sb-loading').find('.sb-tickets-area').attr('style', `height: ${height - height_offset }px;display:none`);
            setTimeout(function () {
                main.removeClass('sb-load');
            }, 300);
            SBChat.startRealTime();
            SBF.event('SBTicketsInit');
        },

        // Triggered when a message is sent
        onMessageSent: function () {
            if (active_panel == 'new-ticket') {
                let title = main_panel.find('.sb-ticket-title input').val();
                SBChat.updateConversations();
                main.find('.sb-panel-right .sb-scroll-area > div').sbActive(false);
                main.find('.sb-conversation-attachments,.sb-ticket-details').html('');
                main.removeClass('sb-no-conversations');
                SBTickets.showPanel();
                setTitle(title);
            }
        },

        // Triggered when a new conversation is received
        onConversationReceived: function (conversation) {
            if (conversation.id == SBChat.conversation.id) {
                if (SBTickets.getActiveConversation('ID') != conversation.id) {
                    setTimeout(() => {
                        SBTickets.activateConversation(SBChat.conversation);
                        if (left_conversations.length) {
                            left_conversations.scrollTop(left_conversations[0].scrollHeight);
                        }
                    }, 300);
                }
            }
        },

        // Triggered when a new message is received
        onNewMessageReceived: function (message, conversation_id) {
            if (message instanceof SBMessage && conversation_id == SBChat.conversation.id) {
                let last_agent = SBChat.lastAgent();
                let code = SBChat.conversation.getCode();
                let active_conversation = SBTickets.getActiveConversation();
                if (active_conversation) {
                    $(active_conversation).html(code);
                } else {
                    left_conversations.append(`<li data-conversation-id="${SBChat.conversation.id}" class="sb-active">${code}</li>`).find(' > p').remove();
                }
                if (last_agent && SBF.isAgent(message.get('user_type')) && last_agent.id != message.get('user_id')) {
                    SBTickets.setAgent(message.get('user_id'));
                }
            }
        }
    }
    window.SBTickets = SBTickets;

    // Set overflow hidden for 1s
    function setCollapsing() {
        main.addClass('sb-collapsing');
        setTimeout(function () {
            main.removeClass('sb-collapsing');
        }, 1000);
    }

    // Access the global user variable
    function activeUser(value) {
        if (typeof value == 'undefined') {
            return window.sb_current_user;
        } else {
            window.sb_current_user = value;
        }
    }

    // Support Board js translations
    function sb_(string) {
        return SBF.translate(string);
    }

    // Set the profile box of the user
    function setUserProfile() {
        if (activeUser() != false) {
            $(user_profile).setProfile(activeUser().get('last_name').charAt(0) == '#' ? sb_('Account') : activeUser().name);
        }
    }

    // More
    function loading(element) {
        if ($(element).sbLoading()) return true;
        else $(element).sbLoading(true);
        return false;
    }

    function setConversationName(conversation = false) {
        let name = conversation && 'title' in conversation.details && !SBF.null(conversation.details['title']) ? conversation.get('title') : SBF.setting('tickets_conversation_name');
        setTitle(!name || name == -1 ? activeUser().name : name);
    }

    // function submitTicketPartial() {
    //     let message = '';
    //     let settings = SBForm.getAll(panel);
    //     let department = 'department' in settings ? settings['department'][0] : null;
    //     let attachments = [];
    //     SBChat.clear();
    //     editor.sbActive(false);
    //     for (var key in settings) {
    //         if (settings[key][1] && settings[key][0]) {
    //             message += `*${sb_(settings[key][1])}*\n${key == 'department' ? panel.find('#department li.sb-active').html() : settings[key][0]}\n\n`;
    //         }
    //     }
    //     message += editor.find('textarea').val().trim();
    //     panel.find('.sb-attachments > div').each(function () {
    //         attachments.push([$(this).attr('data-name'), $(this).attr('data-value')]);
    //     });
    //     if (!activeUser()) {
    //         SBChat.addUserAndLogin(() => {
    //             SBChat.newConversation(2, -1, message, attachments, department, null, function () { SBTickets.welcome() });
    //         });
    //     } else {
    //         SBChat.newConversation(2, -1, message, attachments, department, null, function () { SBTickets.welcome() });
    //     }
    // }

    function convertTextToQuillFormat(text) {
        const delta = {
            ops: [{ insert: text.trim() + '\n' }]
        };
        return JSON.stringify(delta);
    }

    function createTicket() {
        if (loading(this)) return;

        let settings = SBForm.getAll(panel);
        let department = 'department' in settings ? settings['department'][0] : null;
        let finalAttachments = [];

        let message = '';
        editor.sbActive(false);
        message += editor.find('textarea').val().trim();
        panel.find('.sb-attachments > div').each(function () {
            const name = $(this).attr('data-name');
            const path = $(this).attr('data-value');
            const size = $(this).attr('data-size');
            const type = $(this).attr('data-type');

            if (name && path && typeof path === 'string') {
                finalAttachments.push({
                    filename: name,
                    original_filename: name,
                    file_path: path,
                    file_type: type,
                    file_size: size
                });
            }
        });


        //console.log(JSON.stringify(finalAttachments, null, 2));



        const customer_id = activeUser().details.id ?? 0;
        const customer_name = activeUser().details.first_name ? activeUser().details.first_name +' '+ activeUser().details.last_name: '';
        const customer_email = activeUser().details.email ?? '';


        let new_ticket =  true;
        let ticket_id = 0;
        let data = {};

        // Get settings
        let ticketDataPart1 = SBForm.getAll(panel);
        //let ticketDataPart2 = SBTicket.getAll(ticket_edit_box.find('.sb-additional-details'));
        //let ticketCustomFields = SBTicket.getAll(ticket_edit_box.find('#ticketCustomFieldsContainer'));

        //let ticketDataPart3 = ticket_edit_box.find('#description textarea').val();
        let conversationId = null;
        //let uploadedFiles = ticket_edit_box.find('#uploaded_files1').val() ?? null;
        let guest = 0;
        message = SBF.escape(message);
        message = convertTextToQuillFormat(message);


        const contact_id = [];
        contact_id.push(customer_id);
        contact_id.push('Contact ID');

        const cust_name = [];
        cust_name.push(customer_name);
        cust_name.push('Customer Name');

        const cust_email = [];
        cust_email.push(customer_email);
        cust_email.push('Customer Email');

        const status_id = [];
        status_id.push(1);
        status_id.push('Status ID');

        const description = [];
        description.push(message);
        description.push('Description');

        const conversation_id = [];
        conversation_id.push(conversationId);
        conversation_id.push('Conversation ID');

        const attachments = [];
        attachments.push(JSON.stringify(finalAttachments));
        attachments.push('Attachments');

        const withoutContact = [];
        withoutContact.push(guest);
        withoutContact.push('withoutContact');

        const customField = [];
        // const container = document.getElementById('ticketCustomFieldsContainer');
        // const fields = container.querySelectorAll('input, select, textarea');

        // const values = {};

        // fields.forEach(field => {
        //     const name = field.id.replace('custom_', ''); // fallback if name missing
        //     values[name] = field.value;
        // });

        // customField.push(values);
        // customField.push('custom_fields');

        let ticketData = { ...ticketDataPart1, description, status_id, contact_id, cust_name, cust_email, conversation_id, attachments, withoutContact, customField };
        console.log(ticketData);

        let output = {};
        $.map(ticketData, function (value, key) {
            data[key] = value[0];
        });

        let isFormValid = true;
        let emptyFields = [];

        // Validate all inputs, selects, and textareas inside the lightbox
        document.querySelectorAll('.sb-ticket-edit-box input, .sb-ticket-edit-box select, .sb-ticket-edit-box textarea').forEach(el => {
            // Skip validation for optional fields (no "required" attribute)
            //if (el.type != 'file' && el.type !== 'checkbox' && el.type !== 'hidden' && el.parentElement.id !== 'cc') {
            if (el.hasAttribute('required')) {
                // Check for empty text or unselected select
                if (el.value.trim() === '') {
                    const labelSpan = el.previousElementSibling;
                    if (labelSpan && labelSpan.tagName.toLowerCase() === 'span') {
                        emptyFields.push(labelSpan.textContent.trim());
                    }
                    else if (el.id == 'select-customer') {
                        emptyFields.push("Customer");
                        el.nextElementSibling.style.border = '1px solid red'; // Highlight the empty field
                    }
                    isFormValid = false;
                    el.style.border = '1px solid red'; // Highlight the empty field
                }
                else {
                    el.style.border = 'none'; // Highlight the empty field
                    if (el.id == 'select-customer') {

                        el.nextElementSibling.style.border = 'none'; // Highlight the empty field
                    }
                }

            }
        });

        if (!isFormValid) {
            SBTicket.showErrorMessage(ticket_edit_box, `${emptyFields.join(', ')} are required.`);
            $(this).sbLoading(false);
            return;
        }

        if (!data.user_type) {
            data.ticket_type = 'new';
        }

        // console.log(data);
        // Save the settings
        SBF.ajax({
            function: (new_ticket ? 'add-ticket' : 'update-ticket'),
            ticket_id: ticket_id,
            data1: ticketData,
        }, (response) => {
            
            $(this).sbLoading(false);

            //admin.sbHideLightbox();
            //if(!new_ticket)
            //SBTicket.updateRow(response);

            //SBTickets.updateRow(ticketData);
           // infoBottom(new_ticket ? 'New Ticket Created' : 'Ticket updated');

            setTimeout(function () {
                location.reload();
            }, 1500);

           // $(header).find('.sb-admin-nav #sb-tickets').click();

        });
    }

    function ticketsInit() {

        /*
        * ----------------------------------------------------------
        * # MISCELLANEOUS
        * ----------------------------------------------------------
        */

        main.on('click', '.sb-btn-collapse', function () {
            setCollapsing();
            main.find('.sb-panel-' + ($(this).hasClass('sb-left') ? 'left' : 'right')).toggleClass('sb-collapsed');
            $(this).toggleClass('sb-active');
        });

        editor.on('focus focusout', 'textarea', function () {
            $(this).parent().parent().toggleClass('sb-focus');
        });

        if (!mobile) {
            editor.on('click', '.sb-btn-emoji', function () {
                let settings = active_panel == 'new-ticket' ? [panel, 'padding-top', 415] : [main, 'margin-top', 335];
                if (editor.find('.sb-emoji').sbActive()) {
                    let offset_emoji = $(this).offset().top + $(settings[0])[0].scrollTop - window.scrollY;
                    let offset_tickets = main.offset().top - window.scrollY;
                    if (offset_emoji - offset_tickets < 380) {
                        $(settings[0]).css(settings[1], (settings[2] - (offset_emoji - offset_tickets)) + 'px');
                    }
                } else {
                    $(settings[0]).css(settings[1], '');
                }
            });
            editor.on('click', '.sb-emoji-list > ul > li', function () {
                let settings = active_panel == 'new-ticket' ? [panel, 'padding-top', 415] : [main, 'margin-top', 335];
                $(settings[0]).css(settings[1], '');
            });
        }

        /*
        * ----------------------------------------------------------
        * # MAIN PANEL
        * ----------------------------------------------------------
        */

        main_panel.on('click', '> .sb-top .sb-close', function () {
            SBTickets.showPanel();
            $('.tickets-list-area .sb-panel-main .sb-top').hide();
            $('.tickets-list-area .sb-panel-main').addClass('p-5');
            $('.tickets-list-area .sb-panel-main .sb-scroll-area').removeClass('text-middle');
        });

        /*
        * ----------------------------------------------------------
        * # CONVERSATION AREA
        * ----------------------------------------------------------
        */
        main_panel.on('click', '.sb-create-ticket', function () {
            let errors = false;
            editor.removeClass('sb-error');
            if (SBForm.errors(panel)) {
                SBForm.showErrorMessage(panel, 'Please fill in all the required fields.');
                errors = true;
            }
            if (!editor.find('textarea').val().trim() && !editor.hasClass('sb-audio-message-active')) {
                if (!errors) {
                    SBForm.showErrorMessage(panel, 'Please write a message.');
                }
                editor.addClass('sb-error');
                errors = true;
            }
            if (!errors && !SBChat.is_busy) {
                SBChat.busy(true);
                if (SBF.setting('tickets_recaptcha')) {
                    grecaptcha.ready(function () {
                        grecaptcha.execute(SBF.setting('tickets_recaptcha'), { action: 'submit' }).then(function (token) {
                            SBF.ajax({
                                function: 'recaptcha',
                                token: token
                            }, (response) => {
                                if (response === true) {
                                    //submitTicketPartial();
                                    createTicket();
                                    $('.grecaptcha-badge').hide();
                                } else SBChat.busy(false);
                            });
                        });
                    });
                    return;
                }
               // submitTicketPartial();
                createTicket();
            }
        });

        main.on('click', '.sb-new-ticket', function () {
            SBTickets.showPanel('new-ticket');
        });

        left_conversations.on('click', 'li', function () {
            SBChat.clear();
            SBTickets.selectConversation($(this).attr('data-conversation-id'));
            conversation_area.sbLoading(true);
            if (mobile) {
                main.find('.sb-panel-left').addClass('sb-collapsed');
            }
        });

        main.find('.sb-panel-left .sb-search-btn input').on('input', function () {
            let search = $(this).val();
            let button = $(this).prev();
            SBF.search(search, () => {
                if (search.length > 1) {
                    if (loading(button)) return;
                    SBF.ajax({
                        function: 'search-user-conversations',
                        search: search
                    }, (response) => {
                        button.sbLoading(false);
                        let conversations = [];
                        let count = response.length;
                        for (var i = 0; i < count; i++) {
                            if (!SBF.setting('tickets_close')) {
                                conversations.push(new SBConversation([new SBMessage(response[i])], response[i]));
                            }
                        }
                        left_conversations.html(count ? activeUser().getConversationsCode(conversations) : '<p>' + sb_('No results found1.') + '</p>');
                    });
                } else {
                    SBChat.populateConversations();
                }
            });
        });

        main.on('click', '.sb-panel-left .sb-search-btn i', function () {
            SBF.searchClear(this, () => { SBChat.populateConversations() });
        });

        /*
        * ----------------------------------------------------------
        * # REGISTRATION AND LOGIN
        * ----------------------------------------------------------
        */

        panel.on('click', '.sb-login-area', function () {
            SBTickets.showPanel('login');
        });

        panel.on('click', '.sb-registration-area', function () {
            SBTickets.showPanel('registration');
        });

        main.on('click', '.sb-profile-menu [data-value="edit-profile"]', function () {
            SBTickets.showPanel('edit-profile');
        });

        main.on('click', '.logout', function () {
            console.log('logout1111222');
            SBF.logout(false);
            SBTickets.showPanel('login');
            $('.user_header').addClass('d-none');
            $('.tickets-list-area').show();
            $('.sb-tickets-area').hide();
        });

        panel.on('click', '> .sb-buttons .sb-submit', function () {
            if (!$(this).sbLoading()) {
                let settings = SBForm.getAll(panel);
                let settings_extra = SBForm.getAll(panel.find('.sb-form-extra'));
                let is_edit_profile = active_panel == 'edit-profile';
                for (var key in settings) {
                    settings[key] = settings[key][0];
                }
                if (SBForm.errors(panel)) {
                    SBForm.showErrorMessage(panel, SBForm.getRegistrationErrorMessage(panel));
                } else {
                    $(this).sbLoading(true);
                    settings.user_type = 'user';
                    SBF.ajax({
                        function: is_edit_profile || activeUser() ? 'update-user' : 'add-user-and-login',
                        settings: settings,
                        settings_extra: settings_extra
                    }, (response) => {
                        if (response && !SBF.errorValidation(response)) {
                            SBF.loginCookie(response[1]);
                            if (!activeUser()) {
                                activeUser(new SBUser(response[0]));
                                for (var key in settings_extra) {
                                    activeUser().setExtra(key, settings_extra[key][0]);
                                }
                                SBPusher.start();
                                SBChat.initChat();
                            } else {
                                for (var key in settings) {
                                    activeUser().set(key, settings[key][0]);
                                }
                                for (var key in settings_extra) {
                                    activeUser().setExtra(key, settings_extra[key][0]);
                                }
                            }
                            setUserProfile();
                            if (is_edit_profile) {
                                SBTickets.showPanel();
                            } else {
                                SBF.event('SBRegistrationForm', { user: settings });
                                SBF.event('SBNewEmailAddress', { name: activeUser().name, email: activeUser().get('email') });
                                SBTickets.showPanel('new-ticket');
                            }
                            if (SBF.setting('wp_registration') && 'email' in settings && 'password' in settings) {
                                console.log(settings);
                                SBApps.wordpress.ajax('wp_registration', { user_id: response[0].id, first_name: response[0].first_name, last_name: response[0].last_name, password: settings.password[0], email: settings.email[0] });
                            } else if (SBF.setting('wp_users_system') == 'wp') {
                                SBApps.wordpress.ajax('wp_login', { user: settings.email[0], password: settings.password[0] });
                            }
                        } else {
                            SBForm.showErrorMessage(panel, SBForm.getRegistrationErrorMessage(response, 'response'));
                        }
                        $(this).sbLoading(false);
                    });
                }
            }
        });

        panel.on('click', '.sb-submit-login', function () {
            SBF.loginForm(this, panel, (response) => {
                activeUser(new SBUser(response[0]));
                setUserProfile();
                SBChat.populateConversations((response) => {
                    if (response.length == 0) {
                        main.addClass('sb-no-conversations');
                        SBTickets.showPanel('new-ticket');
                    } else {
                        SBChat.openConversation(response[0].id);
                        SBTickets.showPanel();
                    }
                });
            });
        });
    }

    function setTitle(title) {
        $(main_title).html(title).sbActive(title);
    }

    function setTicketTitle(title) {
        $(ticket_main_title).html(title).sbActive(title);
        $('.tickets-list-area .sb-panel-main').removeClass('p-5');
        $('.tickets-list-area .sb-panel-main .sb-top').show();
        $('.tickets-list-area .sb-panel-main .sb-scroll-area').addClass('text-middle');
    }
}(jQuery));
=======
"use strict";!function(e){function t(){c.addClass("sb-collapsing"),setTimeout(function(){c.removeClass("sb-collapsing")},1e3)}function s(e){if(void 0===e)return window.sb_current_user;window.sb_current_user=e}function i(e){return SBF.translate(e)}function n(){0!=s()&&e(m).setProfile("#"==s().get("last_name").charAt(0)?i("Account"):s().name)}function a(e=!1){let t=e&&"title"in e.details&&!SBF.null(e.details.title)?e.get("title"):SBF.setting("tickets_conversation_name");r(t&&-1!=t?t:s().name)}function o(){let t="",n=SBForm.getAll(f),a="department"in n?n.department[0]:null,o=[];SBChat.clear(),g.sbActive(!1);for(var l in n)n[l][1]&&n[l][0]&&(t+=`*${i(n[l][1])}*\n${"department"==l?f.find("#department li.sb-active").html():n[l][0]}\n\n`);t+=g.find("textarea").val().trim(),f.find(".sb-attachments > div").each(function(){o.push([e(this).attr("data-name"),e(this).attr("data-value")])}),s()?SBChat.newConversation(2,-1,t,o,a,null,function(){F.welcome()}):SBChat.addUserAndLogin(()=>{SBChat.newConversation(2,-1,t,o,a,null,function(){F.welcome()})})}function l(){c.on("click",".sb-btn-collapse",function(){t(),c.find(".sb-panel-"+(e(this).hasClass("sb-left")?"left":"right")).toggleClass("sb-collapsed"),e(this).toggleClass("sb-active")}),g.on("focus focusout","textarea",function(){e(this).parent().parent().toggleClass("sb-focus")}),w||(g.on("click",".sb-btn-emoji",function(){let t="new-ticket"==p?[f,"padding-top",415]:[c,"margin-top",335];if(g.find(".sb-emoji").sbActive()){let s=e(this).offset().top+e(t[0])[0].scrollTop-window.scrollY,i=c.offset().top-window.scrollY;s-i<380&&e(t[0]).css(t[1],t[2]-(s-i)+"px")}else e(t[0]).css(t[1],"")}),g.on("click",".sb-emoji-list > ul > li",function(){let t="new-ticket"==p?[f,"padding-top",415]:[c,"margin-top",335];e(t[0]).css(t[1],"")})),d.on("click","> .sb-top .sb-close",function(){F.showPanel()}),d.on("click",".sb-create-ticket",function(){let t=!1;if(g.removeClass("sb-error"),SBForm.errors(f)&&(SBForm.showErrorMessage(f,"Please fill in all the required fields."),t=!0),g.find("textarea").val().trim()||g.hasClass("sb-audio-message-active")||(t||SBForm.showErrorMessage(f,"Please write a message."),g.addClass("sb-error"),t=!0),!t&&!SBChat.is_busy){if(SBChat.busy(!0),SBF.setting("tickets_recaptcha"))return void grecaptcha.ready(function(){grecaptcha.execute(SBF.setting("tickets_recaptcha"),{action:"submit"}).then(function(t){SBF.ajax({function:"recaptcha",token:t},t=>{!0===t?(o(),e(".grecaptcha-badge").hide()):SBChat.busy(!1)})})});o()}}),c.on("click",".sb-new-ticket",function(){F.showPanel("new-ticket")}),u.on("click","li",function(){SBChat.clear(),F.selectConversation(e(this).attr("data-conversation-id")),b.sbLoading(!0),w&&c.find(".sb-panel-left").addClass("sb-collapsed")}),c.find(".sb-panel-left .sb-search-btn input").on("input",function(){let t=e(this).val(),n=e(this).prev();SBF.search(t,()=>{if(t.length>1){if(function(t){return!!e(t).sbLoading()||(e(t).sbLoading(!0),!1)}(n))return;SBF.ajax({function:"search-user-conversations",search:t},e=>{n.sbLoading(!1);let t=[],a=e.length;for(var o=0;o<a;o++)SBF.setting("tickets_close")||t.push(new SBConversation([new SBMessage(e[o])],e[o]));u.html(a?s().getConversationsCode(t):"<p>"+i("No results found.")+"</p>")})}else SBChat.populateConversations()})}),c.on("click",".sb-panel-left .sb-search-btn i",function(){SBF.searchClear(this,()=>{SBChat.populateConversations()})}),f.on("click",".sb-login-area",function(){F.showPanel("login")}),f.on("click",".sb-registration-area",function(){F.showPanel("registration")}),c.on("click",'.sb-profile-menu [data-value="edit-profile"]',function(){F.showPanel("edit-profile")}),c.on("click",'.sb-profile-menu [data-value="logout"]',function(){SBF.logout(!1),F.showPanel("login")}),f.on("click","> .sb-buttons .sb-submit",function(){if(!e(this).sbLoading()){let i=SBForm.getAll(f),a=SBForm.getAll(f.find(".sb-form-extra")),o="edit-profile"==p;for(var t in i)i[t]=i[t][0];SBForm.errors(f)?SBForm.showErrorMessage(f,SBForm.getRegistrationErrorMessage(f)):(e(this).sbLoading(!0),i.user_type="user",SBF.ajax({function:o||s()?"update-user":"add-user-and-login",settings:i,settings_extra:a},t=>{if(t&&!SBF.errorValidation(t)){if(SBF.loginCookie(t[1]),s()){for(var l in i)s().set(l,i[l][0]);for(var l in a)s().setExtra(l,a[l][0])}else{s(new SBUser(t[0]));for(var l in a)s().setExtra(l,a[l][0]);SBPusher.start(),SBChat.initChat()}n(),o?F.showPanel():(SBF.event("SBRegistrationForm",{user:i}),SBF.event("SBNewEmailAddress",{name:s().name,email:s().get("email")}),F.showPanel("new-ticket")),SBF.setting("wp_registration")&&"email"in i&&"password"in i?(console.log(i),SBApps.wordpress.ajax("wp_registration",{user_id:t[0].id,first_name:t[0].first_name,last_name:t[0].last_name,password:i.password[0],email:i.email[0]})):"wp"==SBF.setting("wp_users_system")&&SBApps.wordpress.ajax("wp_login",{user:i.email[0],password:i.password[0]})}else SBForm.showErrorMessage(f,SBForm.getRegistrationErrorMessage(t,"response"));e(this).sbLoading(!1)}))}}),f.on("click",".sb-submit-login",function(){SBF.loginForm(this,f,e=>{s(new SBUser(e[0])),n(),SBChat.populateConversations(e=>{0==e.length?(c.addClass("sb-no-conversations"),F.showPanel("new-ticket")):(SBChat.openConversation(e[0].id),F.showPanel())})})})}function r(t){e(h).html(t).sbActive(t)}var c,d,b,f,g,p,u,h,v,m,S,B={},C={},w=e(window).width()<426,k=!1,F={showPanel:function(t="",s=!1){let n=p;switch(p=t,c.addClass("sb-panel-active sb-load").removeClass("sb-panel-form").attr("data-panel",t),k&&k.hide(),t){case"privacy":SBF.ajax({function:"get-block-setting",value:"privacy"},e=>{r(i(e.title)),f.append(`<div class="sb-privacy sb-init-form" data-decline="${i(e.decline.replace(/"/g,""))}"><div class="sb-text">${i(e.message)}</div>`+(""!=e.link?`<a target="_blank" href="${e.link}">${i(e["link-name"])}</a>`:"")+`<div class="sb-buttons"><a class="sb-btn sb-approve">${i(e["btn-approve"])}</a><a class="sb-btn sb-decline">${i(e["btn-decline"])}</a></div></div>`)}),this.showSidePanels(!1);break;case"articles":r(i(0==s?"Articles":s)),this.showSidePanels(!1);break;case"edit-profile":case"login":case"registration":let l="edit-profile"==t;this.showSidePanels(!1),c.addClass("sb-panel-form"),t in C?(f.html(C[t]),r(i(f.find(".sb-top").html()))):(SBF.ajax({function:"get-rich-message",name:(l?"registration":t)+"-tickets"},e=>{f.html(e);let s=f.find(".sb-top").html();l&&f.find(".sb-top").html(i("Edit profile")),r(i(s)),setTimeout(function(){r(i(s))},300),f.find(".sb-link-area").insertAfter(".sb-buttons"),f.find(".sb-info").insertBefore(".sb-buttons"),C[t]=f.html()}),f.html('<div class="sb-loading"></div>'));break;case"new-ticket":let u={title:"Title",message:"Message",panel:"Create a new ticket",button:"Create a new ticket"};if(this.showSidePanels(!1),SBF.setting("tickets_names")){let e=SBF.setting("tickets_names");for(var o in e)e[o]&&(u[o.replace("tickets-names-","")]=e[o])}r(i(u.panel)),f.html(`<div class="sb-info"></div><div class="sb-input sb-input-text sb-ticket-title"><span>${i(u.title)}</span><input type="text" required></div>${c.find(".sb-ticket-fields").html()}<div class="sb-input sb-editor-cnt"><span>${i(u.message)}</span></div><div class="sb-btn sb-icon sb-create-ticket"><i class="sb-icon-plus"></i>${i(u.button)}</div>`),d.find(".sb-editor-cnt").append(g),SBF.setting("tickets_recaptcha")&&(k?k.show():e.getScript("https://www.google.com/recaptcha/api.js?render="+SBF.setting("tickets_recaptcha"),()=>{setTimeout(()=>{k=e(".grecaptcha-badge")},500)}));break;default:this.showSidePanels(!0),"new-ticket"==n&&(g.find("textarea").val(""),g.sbActive(!1).removeClass("sb-error"),b.after(g)),f.html(""),c.removeClass("sb-panel-active sb-load").removeAttr("data-panel"),a(SBChat.conversation)}SBF.event("SBPanelActive",t),setTimeout(function(){c.removeClass("sb-load")},300)},showSidePanels:function(s=!0){let i=c.find(".sb-btn-collapse");if(t(),!s||S>800){let e=c.find(".sb-panel-left,.sb-panel-right");s?e.removeClass("sb-collapsed"):e.addClass("sb-collapsed")}else S<=800&&e(i).sbActive(!0);e(i).css("display",s?"":"none")},setAgent:function(t){let s=c.find(".sb-agent-label").sbActive(!1);if(SBChat.agent_id=t,t in B){let i=B[t];e(v).setProfile(i.name,i.image).sbActive(!0),SBChat.updateUsersActivity(),"details"in i&&SBF.getLocationTimeString(i.extra,t=>{e(s).html((i.get("flag")?`<img src="${SB_URL}/media/flags/${i.get("flag")}">`:'<i class="sb-icon sb-icon-marker"></i>')+t).sbActive(!0)})}else SBF.ajax({function:"get-agent",agent_id:t},e=>{0!=e&&(B[t]=new SBUser(e),this.setAgent(t))})},activateConversation:function(t){if(t instanceof SBConversation){let n=SBChat.lastAgent(),o=["id","creation_time","last_update"],l="";this.selectConversation(t.id),a(t),c.find(".sb-panel-right .sb-scroll-area > div").sbActive(!1),n?(e(v).setProfile(n.full_name,n.profile_image),this.setAgent(n.user_id),setTimeout(()=>{SBChat.updateUsersActivity()},300)):e(v).sbActive(!1),""!=t.get("department")&&SBChat.getDepartmentCode(t.get("department"),t=>{let s=c.find(".sb-department");e(s).html(`<span class="sb-title">${e(s).data("label")}</span>${t}`).sbActive(!0)});for(s=0;s<o.length;s++){let e;switch(o[s]){case"id":e=["padlock",i("Ticket ID"),t.id];break;case"creation_time":e=["calendar",i("Creation time"),SBF.beautifyTime(t.get("creation_time"),!0)];break;case"last_update":e=["reload",i("Last update"),SBF.beautifyTime(t.getLastMessage()?t.getLastMessage().get("creation_time"):t.get("last_update_time"),!0)]}l+=`<div data-id="${o[s]}"><i class="sb-icon sb-icon-${e[0]}"></i><span>${e[1]}</span><div>${e[2]}</div></div>`}c.find(".sb-ticket-details").html(l);let r=t.getAttachments();l="";for(var s=0;s<r.length;s++)l+=`<a href="${r[s][1]}" target="_blank"><i class="sb-icon sb-icon-file"></i>${r[s][0]}</a>`;c.find(".sb-conversation-attachments").html((l?`<div class="sb-title">${i("Attachments")}</div>`:"")+l),b.sbLoading(!1)}else SBF.error("Value not of type SBConversation","activateConversation")},selectConversation:function(e){let t=u.find(`[data-conversation-id="${e}"]`);u.find("> li").sbActive(!1),1==t.attr("data-conversation-status")&&t.attr("data-conversation-status",0),t.find("[data-count]").remove(),t.sbActive(!0)},getActiveConversation:function(e=""){let t=u.find(" > .sb-active");return!!t.length&&("ID"==e?t.attr("data-conversation-id"):t)},welcome:function(){let e=SBF.setting("tickets_welcome_message");e&&!SBF.storage("tickets-welcome")&&setTimeout(()=>{SBChat.sendMessage(SBF.setting("bot_id"),e),SBF.storage("tickets-welcome",!0)},1e3)},init:function(){if(c=e("body").find(".sb-tickets"),d=c.find(" > div > .sb-panel-main"),f=d.find(".sb-panel"),g=d.find(".sb-editor"),h=d.find(" > .sb-top .sb-title"),u=c.find(".sb-user-conversations"),b=d.find(".sb-list"),v=c.find(".sb-profile-agent"),m=c.find(".sb-panel-right > .sb-top .sb-profile"),S=c.width(),B[SBF.setting("bot_id")]={name:SBF.setting("bot_name"),image:SBF.setting("bot_image")},l(),!c.length)return;if(!SBF.setting("tickets_registration_required")||s()&&!["visitor","lead"].includes(s().type))s()&&s().conversations.length?F.getActiveConversation()||SBChat.openConversation(SBF.getURL("conversation")?SBF.getURL("conversation"):s().conversations[0].id):(c.addClass("sb-no-conversations"),SBF.setting("privacy")&&!SBF.storage("privacy_approved")?F.showPanel("privacy"):SBF.setting("tickets_disable_first")?a():F.showPanel("new-ticket"));else{let e=SBF.setting("tickets_registration_redirect");if(e)return void(document.location=e+(e.includes("?")?"&":"?")+"sb=true");c.addClass("sb-no-conversations"),F.showPanel(SBF.setting("tickets_default_form"))}let t=parseInt(SBF.null(c.data("height"))?e(window).height():c.data("height")),i=parseInt(SBF.null(c.data("offset"))?0:c.data("offset"));S<=800?(c.addClass("sb-800"),c.find(".sb-panel-left,.sb-panel-right").addClass("sb-collapsed"),c.find(".sb-btn-collapse").sbActive(!0)):S<=1e3?c.addClass("sb-1000"):S<=1300&&c.addClass("sb-1300"),n(),c.removeClass("sb-loading").find(".sb-tickets-area").attr("style",`height: ${t-i}px`),setTimeout(function(){c.removeClass("sb-load")},300),SBChat.startRealTime(),SBF.event("SBTicketsInit")},onMessageSent:function(){if("new-ticket"==p){let e=d.find(".sb-ticket-title input").val();SBChat.updateConversations(),c.find(".sb-panel-right .sb-scroll-area > div").sbActive(!1),c.find(".sb-conversation-attachments,.sb-ticket-details").html(""),c.removeClass("sb-no-conversations"),F.showPanel(),r(e)}},onConversationReceived:function(e){e.id==SBChat.conversation.id&&F.getActiveConversation("ID")!=e.id&&setTimeout(()=>{F.activateConversation(SBChat.conversation),u.length&&u.scrollTop(u[0].scrollHeight)},300)},onNewMessageReceived:function(t,s){if(t instanceof SBMessage&&s==SBChat.conversation.id){let s=SBChat.lastAgent(),i=SBChat.conversation.getCode(),n=F.getActiveConversation();n?e(n).html(i):u.append(`<li data-conversation-id="${SBChat.conversation.id}" class="sb-active">${i}</li>`).find(" > p").remove(),s&&SBF.isAgent(t.get("user_type"))&&s.id!=t.get("user_id")&&F.setAgent(t.get("user_id"))}}};window.SBTickets=F}(jQuery);
>>>>>>> vendor-update
