<<<<<<< HEAD
﻿
/*
 * ==========================================================
 * MAIN SCRIPT
 * ==========================================================
 *
 * Main JavaScript file. This file is shared by frond-end and back-end. © 2017-2025 board.support. All rights reserved.
 * 
 */

'use strict';

(function ($) {

    var version = '3.8.1';
    var main;
    var global;
    var upload_target;
    var admin = false;
    var tickets = false;
    var timeout = false;
    var timeout_typing = false;

    var interval = false;
    var timeout_debounce = [];
    var previous_search;
    var sb_current_user = false;
    var chat;
    var chat_editor;
    var chat_textarea;
    var chat_header;
    var chat_status;
    var chat_emoji;
    var chat_scroll_area;
    var chat_overlay_panel;
    var label_date_items = false;
    var label_date_history = [9999999, ''];
    var label_date_timeout = [false, false];
    var document_title = document.title;
    var CHAT_SETTINGS = {};
    var mobile = $(window).width() < 465;
    var bot_id;
    var force_action = '';
    var dialogflow_human_takeover;
    var agents_online = false;
    var ND = 'undefined';
    var cookies_supported = true;
    var utc_offset_user = (new Date()).getTimezoneOffset() * 60000;
    var cloud_data = false;
    var articles_page = false;
    var ajax_calls;
    var audio_mp3;
    var audio_recorder_dom;
    var audio_recorder_dom_time;
    var audio_recorder;
    var audio_recorder_chunks = [];
    var audio_recorder_time = [0, false];
    var audio_recorder_time_player = [0, false];
    var audio_recorder_stream;
    var prevent_focusout = false;
    var init_push_notifications = false;
    var conversation_update_last_check = 0;
    var is_shopify = typeof Shopify !== ND;

    /*
    * ----------------------------------------------------------
    * EXTERNAL SCRIPTS
    * ----------------------------------------------------------
    */

    // Auto Expand Scroll Area | Schiocco
    $.fn.extend({ manualExpandTextarea: function () { var t = this[0]; t.style.height = "auto", t.style.maxHeight = "25px"; window.getComputedStyle(t); t.style.height = (t.scrollHeight > 350 ? 350 : t.scrollHeight) + "px", t.style.maxHeight = "", $(t).trigger("textareaChanged") }, autoExpandTextarea: function () { var t = this[0]; t.addEventListener("input", function (e) { $(t).manualExpandTextarea() }, !1) } });

    // Autolink-js
    (function () { var t = [].slice; String.prototype.autoLink = function () { var n, a, r, i, c, e, l; return e = /(^||[\s\n]|<[A-Za-z]*\/?>)((?:https?|ftp):\/\/[\-A-Z0-9+\u0026\u2019@#\/%?=()~_|!:,.;]*[\-A-Z0-9+\u0026@#\/%=~_|])/gi, 0 < (c = 1 <= arguments.length ? t.call(arguments, 0) : []).length ? (i = c[0], n = i.callback, r = function () { var t; for (a in t = [], i) l = i[a], "callback" !== a && t.push(" " + a + "='" + l + "'"); return t }().join(""), this.replace(e, function (t, a, i) { return "" + a + (("function" == typeof n ? n(i) : void 0) || "<a href='" + i + "'" + r + ">" + i + "</a>") })) : this.replace(e, "$1<a href='$2'>$2</a>") } }).call(this);

    /*
    * ----------------------------------------------------------
    * FUNCTIONS
    * ----------------------------------------------------------
    */

    var SBF = {
        visibility_status: 'visible',
        loop_prevention: false,

        // Main Ajax function
        ajax: function (data, onSuccess = false) {
            if (ajax_calls) {
                ajax_calls[0].push(data);
                ajax_calls[1].push(onSuccess);
            } else {
                ajax_calls = [[data], [onSuccess]];
                setTimeout(() => {
                    let onSuccessCalls = ajax_calls[1];
                    let data_auto = { 'login-cookie': SBF.loginCookie() }
                    if (activeUser()) {
                        data_auto.user_id = activeUser().id;
                    }
                    if (typeof SB_LANG != ND) {
                        data_auto.language = SB_LANG;
                    }
                    if (cloud_data) {
                        data_auto.cloud = cloud_data;
                    }
                    if (location.search.includes('debug')) {
                        data_auto.debug = true;
                    }
                    $.ajax({
                        method: 'POST',
                        url: SB_AJAX_URL,
                        data: $.extend({ function: 'ajax_calls', calls: ajax_calls[0] }, data_auto)
                    }).done((response) => {
                        let result;
                        if (Array.isArray(response)) {
                            result = response;
                        } else if (response === 'invalid-session') {
                            setTimeout(() => { SBF.reset() }, 1000);
                        } else if (admin && SB_ADMIN_SETTINGS.cloud && response.includes('no-credits') && !response.includes('"value":"no-credits')) {
                            return SBCloud.creditsAlertQuota();
                        } else {
                            try {
                                result = typeof response === 'string' || response instanceof String ? JSON.parse(response) : response;
                            } catch (e) {
                                this.ajax_error(response, data);
                                return;
                            }
                        }
                        for (var i = 0; i < result.length; i++) {
                            let result_sub = result[i];
                            if (!Array.isArray(result_sub)) {
                                result_sub = result;
                            }
                            if (result_sub[0] == 'success') {
                                onSuccess = onSuccessCalls[i];
                                if (onSuccess) {
                                    onSuccess(result_sub[1]);
                                }
                            } else if (SBF.errorValidation(result_sub)) {
                                if (onSuccess) {
                                    onSuccess(result_sub);
                                }
                            } else {
                                if (admin) {
                                    if (result_sub[1] == 'security-error') {
                                        setTimeout(() => { SBF.reset() }, 1000);
                                    }
                                    SBAdmin.conversations.busy = false;
                                }
                                SBChat.is_busy_update = false;
                                SBChat.busy(false);
                                if (result_sub[1] == 'login-data-error' && !this.loop_prevention) {
                                    return;
                                }
                                let result_sub_arr = JSON.parse(result_sub);
                                if (Array.isArray(result_sub_arr) && result_sub_arr[0] == 'error' && result_sub_arr[2] && result_sub_arr[3]) {
                                    SBF.error(result_sub_arr[3], result_sub_arr[2]);
                                } else {
                                    SBF.error(JSON.stringify(result_sub).replace(/\\/g, "").replace(/\"/g, "").replace(/\[/g, "").replace(/\]/g, "").replace('error,', ''), data.function);
                                }
                            }
                        }
                    }).fail((jqXHR, textStatus, error) => {
                        if (error) {
                            this.ajax_error('HTTP CURL ERROR');
                            console.log(error);
                        }
                    });
                    ajax_calls = false;
                }, 100);
            }
        },

        ajax_error: function (response, data = false) {
            if (admin) {
                SBAdmin.conversations.busy = false;
                SBApps.dialogflow.smart_reply_busy = false;
            }
            if (SBApps.dialogflow.busy) {
                SBApps.dialogflow.busy = false;
                if (!admin && SBChat.conversation) {
                    SBF.ajax({ function: 'open-ai-send-fallback-message', conversation_id: SBChat.conversation.id });
                    SBChat.typing(-1, 'stop');
                }
            }
            SBChat.is_busy_update = false;
            SBChat.busy(false);
            console.log(response);
            SBF.error(response.length > 500 ? response.substr(0, 500) + '... Check the console for more details.' : response, `SBF.ajax.${data ? data.function : ''}`);
        },

        // Cors function
        cors: function (method = 'GET', url, onSuccess) {
            let xhr = new XMLHttpRequest();
            if ('withCredentials' in xhr) {
                xhr.open(method, url, true);
            } else if (typeof XDomainRequest != ND) {
                xhr = new XDomainRequest();
                xhr.open(method, url);
            } else {
                return false;
            }
            xhr.onload = function () {
                onSuccess(xhr.responseText);
            };
            xhr.onerror = function () {
                return false;
            };
            xhr.send();
        },

        // Uploads
        upload: function (form, onSuccess) {
            if (cloud_data) form.append('cloud', cloud_data);
            jQuery.ajax({
                url: SB_URL + '/include/upload.php',
                cache: false,
                contentType: false,
                processData: false,
                data: form,
                type: 'POST',
                success: function (response) {
                    onSuccess(response);
                }
            });
        },

        // Get file type
        getFileType: function (url_or_name) {
            if (/.jpg|.jpeg|.png|.gif|.webp/.test(url_or_name)) {
                return 'image';
            }
            if (/.mp3|.ogg|.wav|.aac/.test(url_or_name)) {
                return 'audio';
            }
            if (/.mp4|.mkv|.vob|.3gp|.webm/.test(url_or_name)) {
                return 'video';
            }
            return 'file';
        },

        // UTC Time
        UTC: function (datetime) {
            return new Date(datetime).getTime() - utc_offset_user;
        },

        // Check if a variable is null or empty
        null: function (obj) { if (typeof (obj) !== ND && obj !== null && obj !== 'null' && obj !== false && (obj.length > 0 || typeof (obj) == 'number' || typeof (obj.length) == ND) && obj !== ND) return false; else return true; },

        // Deactivate and hide the elements
        deactivateAll: function () {
            global.find('.sb-popup, .sb-tooltip, .sb-list .sb-menu, .sb-select ul').sbActive(false);
        },

        // Deselect the content of the target
        deselectAll: function () {
            if (window.getSelection) {
                window.getSelection().removeAllRanges();
            } else if (document.selection) {
                document.selection.empty();
            }
        },

        // Get URL parameters
        getURL: function (name = false, url = false) {
            if (!url) {
                url = location.search;
            }
            if (name == false) {
                var c = url.split('?').pop().split('&');
                var p = {};
                for (var i = 0; i < c.length; i++) {
                    var d = c[i].split('=');
                    p[d[0]] = SBF.escape(d[1]);
                }
                return p;
            }
            if (url.indexOf('?') > 0) {
                url = url.substr(0, url.indexOf('?'));
            }
            return SBF.escape(decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(url) || [, ""])[1].replace(/\+/g, '%20') || ""));
        },

        URL: function () {
            return window.location.href.substr(0, window.location.href.indexOf('?'));
        },

        // Convert a string to slug and inverse
        stringToSlug: function (string) {
            let map = {
                'ก': 'k', 'ข': 'kh', 'ฃ': 'kh', 'ค': 'kh', 'ฅ': 'kh', 'ฆ': 'kh', 'ง': 'ng',
                'จ': 'ch', 'ฉ': 'ch', 'ช': 'ch', 'ซ': 's', 'ฌ': 'ch', 'ญ': 'y', 'ฎ': 'd',
                'ฏ': 't', 'ฐ': 'th', 'ฑ': 'th', 'ฒ': 'th', 'ณ': 'n', 'ด': 'd', 'ต': 't',
                'ถ': 'th', 'ท': 'th', 'ธ': 'th', 'น': 'n', 'บ': 'b', 'ป': 'p', 'ผ': 'ph',
                'ฝ': 'f', 'พ': 'ph', 'ฟ': 'f', 'ภ': 'ph', 'ม': 'm', 'ย': 'y', 'ร': 'r',
                'ล': 'l', 'ว': 'w', 'ศ': 's', 'ษ': 's', 'ส': 's', 'ห': 'h', 'ฬ': 'l',
                'อ': 'o', 'ฮ': 'h', 'ะ': 'a', 'ั': 'a', 'า': 'a', 'ำ': 'am', 'ิ': 'i',
                'ี': 'i', 'ึ': 'ue', 'ื': 'ue', 'ุ': 'u', 'ู': 'u', 'เ': 'e', 'แ': 'ae',
                'โ': 'o', 'ใ': 'ai', 'ไ': 'ai', 'ا': 'a', 'ب': 'b', 'ت': 't', 'ث': 'th', 'ج': 'j', 'ح': 'h', 'خ': 'kh',
                'د': 'd', 'ذ': 'dh', 'ر': 'r', 'ز': 'z', 'س': 's', 'ش': 'sh', 'ص': 's',
                'ض': 'd', 'ط': 't', 'ظ': 'z', 'ع': 'a', 'غ': 'gh', 'ف': 'f', 'ق': 'q',
                'ك': 'k', 'ل': 'l', 'م': 'm', 'ن': 'n', 'ه': 'h', 'و': 'w', 'ي': 'y',
                '你': 'ni', '好': 'hao', '世': 'shi', '界': 'jie', '我': 'wo', '是': 'shi',
                '中': 'zhong', '国': 'guo', '人': 'ren', '谢': 'xie', '再': 'zai', '见': 'jian'
            };
            let from = "åàáãäâèéëêìíïîòóöôùúüûñç·/_,:;";
            let to = "aaaaaaeeeeiiiioooouuuunc------";
            string = string.trim().toLowerCase().split('').map(char => map[char] || char).join('');
            for (var i = 0, l = from.length; i < l; i++) {
                string = string.replace(new RegExp(from.charAt(i), 'g'), to.charAt(i));
            }
            return string.replace(/[^a-z0-9 -]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-').replace(/^-+/, '').replace(/-+$/, '').replace(/ /g, '');
        },

        slugToString: function (string) {
            string = string.replace(/_/g, ' ').replace(/-/g, ' ');
            return string.charAt(0).toUpperCase() + string.slice(1);
        },

        // Random string
        random: function () {
            let chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let result = '';
            for (var i = 5; i > 0; --i) result += chars[Math.floor(Math.random() * 62)];
            return result;
        },

        // Check if a user type is an agent
        isAgent: function (user_type) {
            return user_type == 'agent' || user_type == 'admin' || user_type == 'bot';
        },

        // Get cors elapsed of a given date from now
        beautifyTime: function (datetime, extended = false, future = false) {
            let date;
            if (datetime == '0000-00-00 00:00:00') {
                return '';
            }
            if (datetime.indexOf('-') > 0) {
                let arr = datetime.split(/[- :]/);
                date = new Date(arr[0], arr[1] - 1, arr[2], arr[3], arr[4], arr[5]);
            } else {
                let arr = datetime.split(/[. :]/);
                date = new Date(arr[2], arr[1] - 1, arr[0], arr[3], arr[4], arr[5]);
            }
            let now = new Date();
            let date_string = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate(), date.getHours(), date.getMinutes(), date.getSeconds()));
            let diff_days = ((now - date_string) / 86400000) * (future ? -1 : 1);
            let days = [sb_('Sunday'), sb_('Monday'), sb_('Tuesday'), sb_('Wednesday'), sb_('Thursday'), sb_('Friday'), sb_('Saturday')];
            let time = date_string.toLocaleTimeString(navigator.language, { hour: '2-digit', minute: '2-digit' });
            if (time.charAt(0) === '0' && (time.includes('PM') || time.includes('AM'))) {
                time = time.substring(1);
            }
            if (diff_days < 1 && now.getDate() == date_string.getDate()) {
                return extended ? `<span>${sb_('Today')}</span> <span>${time}</span>` : `<span data-today>${time}</span>`;
            } else if (diff_days < 6) {
                return `<span>${days[date_string.getDay()]}</span>${extended ? ` <span>${time}</span>` : ''}`;
            } else {
                return `<span>${date_string.toLocaleDateString(undefined, { year: '2-digit', month: '2-digit', day: '2-digit' })}</span>${extended ? ` <span>${time}</span>` : ''}`;
            }
        },

        // Get the unix timestamp value of a date string with format yyyy-mm-dd hh:mm:ss
        unix: function (datetime) {
            let arr = datetime.split(/[- :]/);
            return Date.UTC(arr[0], arr[1] - 1, arr[2], arr[3], arr[4], arr[5]);
        },

        // Generate a string containing the agent location and time
        getLocationTimeString: function (details, onSuccess) {
            if (details.timezone) {
                let location = {};
                location.timezone = details.timezone.value;
                location.country = details.country ? details.country.value : location.timezone.split('/')[0].replace(/_/g, ' ');
                location.city = details.city ? details.city.value : location.timezone.split('/')[1].replace(/_/g, ' ');
                onSuccess(`${new Intl.DateTimeFormat(undefined, { timeZone: location.timezone, hour: '2-digit', minute: '2-digit' }).format(new Date())} ${sb_('in')} ${location.city ? location.city : ''}${location.country ? ', ' + location.country : ''}`);
            }
        },

        // Date string
        dateDB: function (date) {
            if (date == 'now') {
                date = (new Date).toISOString().replace('T', ' ');
                if (date.indexOf('.') > 0) {
                    date = date.substr(0, date.indexOf('.'));
                }
                return date;
            } else {
                return `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()} ${date.getHours()}:${date.getMinutes()}:${date.getSeconds()}`;
            }
        },

        // Set and get users last activity
        updateUsersActivity: function (user_id, return_user_id, onSuccess) {
            if (SBPusher.active) {
                onSuccess((admin && SB_ADMIN_SETTINGS.bot_id == return_user_id) || (!admin && CHAT_SETTINGS.bot_id == return_user_id) ? 'online' : (SBPusher.online_ids.includes(return_user_id) ? 'online' : 'offline'));
            } else {
                SBF.ajax({
                    function: 'update-users-last-activity',
                    user_id: user_id,
                    return_user_id: return_user_id,
                    check_slack: !admin && CHAT_SETTINGS.slack_active
                }, (response) => {
                    if (response === 'online') {
                        onSuccess('online');
                    } else {
                        onSuccess('offline');
                    }
                });
            }
        },

        // Search functions
        search: function (search, searchFunction) {
            search = search.toLowerCase();
            if (search == previous_search) {
                global.find('.sb-search-btn i').sbLoading(false);
                return;
            }
            clearTimeout(timeout);
            timeout = setTimeout(function () {
                previous_search = search;
                searchFunction();
            }, 1000);
        },

        searchClear: function (icon, onSuccess) {
            let search = $(icon).next().val();
            if (search) {
                $(icon).next().val('');
                onSuccess();
            }
        },

        // Support Board error JS reporting
        error: function (message, function_name) {
            let is_full_error = message.includes(function_name);
            if (admin && SBAdmin.is_logout) {
                return;
            }
            if (message instanceof Error) {
                message = message.message;
            }
            if (message[message.length - 1] == '.') {
                message = message.slice(0, -1);
            }
            if (admin) {
                if (message && !function_name.includes('update-users-last-activity') && !function_name.startsWith('security-error')) {
                    SBAdmin.infoPanel(`<pre>${is_full_error ? `` : `[Error] [${function_name}] `}${message}. Check the console for more details.</pre>`, 'info', false, 'error');
                }
                SBApps.dialogflow.smart_reply_busy = false;
            }
            global.find('.sb-loading').sbLoading(false);
            SBChat.busy(false);
            SBF.event('SBError', { message: message, function_name: function_name });
            throw new Error(is_full_error ? message : `Support Board Error [${function_name}]: ${message}.`);
        },

        errorValidation: function (response, code = true) {
            return Array.isArray(response) && response[0] === 'validation-error' && (code === true || response[1] == code);
        },

        // Login
        loginForm: function (button, area = false, onSuccess = false) {
            button = $(button);
            if (!button.sbLoading()) {
                if (area === false) {
                    area = button.closest('.sb-rich-login');
                } else {
                    area = $(area);
                }
                let email = $.trim(area.find('#email input').val());
                let password = $.trim(area.find('#password input').val());
                if (!email || !password) {
                    area.find('.sb-info').html(sb_('Please insert email and password.')).sbActive(true);
                    SBChat.scrollBottom();
                } else {
                    SBF.ajax({
                        function: 'login',
                        email: email,
                        password: password
                    }, (response) => {
                        if (response && Array.isArray(response)) {
                            if (!admin && this.isAgent(response[0].user_type)) {
                                SBForm.showErrorMessage(area, 'You cannot sign in as an agent.');
                                SBChat.scrollBottom();
                            } else {
                                let user = new SBUser(response[0]);
                                user.set('conversation_id', SBChat.conversation ? SBChat.conversation.id : false);
                                this.loginCookie(response[1]);
                                this.event('SBLoginForm', user);
                                if (onSuccess) {
                                    onSuccess(response);
                                }
                            }
                            if (SBF.setting('wp-users-system') == 'wp') {
                                SBApps.wordpress.ajax('wp-login', { user: email, password: password });
                            }
                        } else {
                            area.find('.sb-info').html(sb_(response === 'ip-ban' ? 'Too many login attempts. Please retry again in a few hours.' : 'Invalid email or password.')).sbActive(true);
                            if (!admin) {
                                SBChat.scrollBottom();
                            }
                        }
                        button.sbLoading(false);
                    });
                    area.find('.sb-info').html('').sbActive(false);
                    button.sbLoading(true);
                }
            }
        },

        // Set the login cookie
        loginCookie: function (value = false) {
            if (value === false) {
                return this.cookie('sb-login') ? this.cookie('sb-login') : storage('login');
            }
            if (CHAT_SETTINGS.cloud) {
                storage('login', value);
            } else {
                this.cookie('sb-login', value, 3650, 'set');
            }
        },

        // Login
        login: function (email = '', password = '', user_id = '', token = '', onSuccess = false) {
            SBF.ajax({
                function: 'login',
                email: email,
                password: password,
                user_id: user_id,
                token: token
            }, (response) => {
                if (response != false && Array.isArray(response)) {
                    this.loginCookie(response[1]);
                    if (onSuccess) {
                        onSuccess(response);
                    }
                    return true;
                } else {
                    return false;
                }
            });
        },

        // Logout
        logout: function (reload = true) {
            SBChat.stopRealTime();
            this.cookie('sb-login', '', '', false);
            this.cookie('sb-cloud', '', '', false);
            storage('open-conversation', '');
            storage('login', '');
            SBChat.conversations = false;
            activeUser(false);
            if (typeof sb_beams_client !== ND) {
                sb_beams_client.stop();
            }
            if (typeof SB_AJAX_URL !== ND) {
                SBF.ajax({
                    function: 'logout'
                }, () => {
                    SBF.event('SBLogout');
                    if (reload) {
                        setTimeout(() => { location.reload() }, 500);
                    }
                });
            }
        },

        // Return the active user
        activeUser: function () {
            return activeUser();
        },

        // Get the active user
        getActiveUser: function (database = false, onSuccess) {
            let app_login = SBApps.login();
            if (!app_login && (storage('wp-login') || storage('whmcs-login') || storage('perfex-login') || storage('aecommerce-login'))) {
                this.cookie('sb-login', '', '', 'delete');
                activeUser(false);
                storage('login', '');
                storage('wp-login', '');
                storage('whmcs-login', '');
                storage('perfex-login', '');
                storage('aecommerce-login', '');
            }
            SBF.ajax({
                function: 'get-active-user',
                db: database,
                login_app: JSON.stringify(app_login),
                user_token: SBF.getURL('token')
            }, (response) => {
                if (!response) {
                    onSuccess();
                    return false;
                } else {
                    if (response.cookie) {
                        SBF.loginCookie(response.cookie);
                    }
                    if (response.user_type) {
                        if (!admin && SBF.isAgent(response.user_type)) {
                            let message = 'You are logged in as both agent and user. Logout or use another browser, Incognito or Private mode, to login as user. Force a logout by running the function SBF.reset() in the console.';
                            if (!storage('double-login-alert')) {
                                storage('double-login-alert', true);
                                alert(message);
                            }
                            console.warn('Support Board: ' + message);
                            SBF.event('SBDoubleLoginError');
                        } else {
                            activeUser(new SBUser(response, response.phone ? { phone: response.phone } : {}));
                            SBPusher.start();
                            if (app_login) {
                                storage(app_login[1] + '-login', true);
                            }
                            onSuccess();
                            SBF.event('SBActiveUserLoaded', response);
                        }
                    }
                }
            });
        },

        // Clean
        reset: function () {
            let cookies = ['sb-login', 'sb-cloud', 'sb-dialogflow-disabled'];
            for (var i = 0; i < cookies.length; i++) {
                this.cookie(cookies[i], '', 0, false);
            }
            try { localStorage.removeItem('support-board') } catch (e) { }
            this.logout();
        },

        // Lightbox
        lightbox: function (content) {
            let lightbox = $(admin ? global : main).find('.sb-lightbox-media');
            lightbox.sbActive(true).find(' > div').html(content);
            if (admin) {
                SBAdmin.open_popup = lightbox;
            }
        },

        // Manage the local storage
        storage: function (key, value = ND) {
            try { if (typeof localStorage == ND) return false } catch (e) { return false }
            let settings = localStorage.getItem('support-board');
            if (settings === null) {
                settings = {};
            } else {
                settings = JSON.parse(settings);
            }
            if (value === ND) {
                return key in settings ? settings[key] : false;
            } else {
                if (!value) {
                    delete settings[key];
                } else {
                    settings[key] = value;
                }
                localStorage.setItem('support-board', JSON.stringify(settings));
            }
        },

        // Save the current time or check if the saved time is older than the given hours
        storageTime: function (key, hours = false) {
            let today = new Date();
            if (hours === false) {
                storage(key, today.getTime());
            } else {
                if (storage(key) == false) {
                    return true;
                }
                if ((today.getTime() - storage(key)) > (3600000 * hours)) {
                    storage(key, false);
                    return true;
                }
                return false;
            }
        },

        // Set or get a cookie
        cookie: function (name, value = false, expiration_days = false, action = 'get', seconds = false) {
            let cookie_https = location.protocol == 'https:' ? 'SameSite=None;Secure;' : '';
            let settings = window[admin ? 'SB_ADMIN_SETTINGS' : 'CHAT_SETTINGS'];
            let domain = settings && settings.cookie_domain ? 'domain=' + settings.cookie_domain + ';' : '';
            if (action == 'get') {
                if (!cookies_supported) {
                    return this.storage(name);
                }
                let cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i];
                    while (cookie.charAt(0) == ' ') {
                        cookie = cookie.substring(1);
                    }
                    if (cookie.indexOf(name) == 0) {
                        let value = cookie.substring(name.length + 1, cookie.length);
                        return this.null(value) ? false : value;
                    }
                }
                return false;
            } else if (action == 'set') {
                if (!cookies_supported) {
                    this.storage(name, value);
                } else {
                    let date = new Date();
                    date.setTime(date.getTime() + (expiration_days * (seconds ? 1 : 86400) * 1000));
                    document.cookie = name + "=" + value + ";expires=" + date.toUTCString() + ";path=/;" + cookie_https + domain;
                }
            } else if (this.cookie(name)) {
                if (!cookies_supported) {
                    this.storage(name, '');
                } else {
                    document.cookie = name + "=" + value + ";expires=Thu, 01 Jan 1970 00:00:01 GMT;path=/;" + cookie_https + domain;
                }
            }
        },

        // Return a front setting or set it
        setting: function (key, value = -1) {
            if (value !== -1) {
                if (typeof CHAT_SETTINGS !== ND) CHAT_SETTINGS[key] = value;
            } else return typeof CHAT_SETTINGS !== ND && key in CHAT_SETTINGS ? CHAT_SETTINGS[key] : false;
        },

        // Return the shortcode array
        shortcode: function (shortcode) {
            return SBRichMessages.shortcode(shortcode);
        },

        // Events and webhooks
        event: function (name, parameters) {
            $(document).trigger(name, parameters);
            let webhooks = admin ? (typeof SB_ADMIN_SETTINGS === ND ? false : SB_ADMIN_SETTINGS.webhooks) : CHAT_SETTINGS.webhooks;
            let webhooks_list = { SBGetUser: 'get-user', SBSMSSent: 'sms-sent', SBLoginForm: 'login', SBRegistrationForm: 'registration', SBUserDeleted: 'user-deleted', SBNewMessagesReceived: 'new-messages', SBNewConversationReceived: 'new-conversation', SBSlackMessageSent: 'slack-message-sent', SBMessageDeleted: 'message-deleted', SBRichMessageSubmit: 'rich-message', SBNewEmailAddress: 'new-email-address' };
            if (webhooks && name in webhooks_list) {
                if (webhooks !== true) {
                    if (!Array.isArray(webhooks)) {
                        webhooks = webhooks.replace(/ /g, '').split(',');
                    }
                    if (!webhooks.includes(webhooks_list[name])) {
                        return;
                    }
                }
                SBF.ajax({
                    function: 'webhooks',
                    function_name: name,
                    parameters: parameters
                });
            }
        },

        // Translate a string
        translate: function (string) {
            if ((!admin && SBF.null(CHAT_SETTINGS)) || (admin && typeof SB_TRANSLATIONS === ND)) {
                return string;
            }
            let translations = admin ? SB_TRANSLATIONS : CHAT_SETTINGS.translations;
            if (translations && translations[string]) {
                return translations[string] ? translations[string] : string;
            } else {
                return string;
            }
        },

        // Escape a string
        // escape: function (string) {
        //     return string ? string.replace(/</ig, '&lt;').replace(/javascript:|onclick|onerror|ontoggle|onmouseover|onload|oncontextmenu|ondblclick|onmousedown|onmouseenter|onmouseleave|onmousemove|onmouseout|onmouseup/ig, '') : '';
        // },

        // Escape a string or array of strings
        escape: function (input) {
            const sanitize = str =>
                str.replace(/</ig, '&lt;')
                    .replace(/\bjavascript:|\bon\w+\b/ig, '');

            if (typeof input === 'string') {
                return sanitize(input);
            } else if (Array.isArray(input)) {
                return input.map(str => typeof str === 'string' ? sanitize(str) : '');
            } else if (typeof input === 'object' && input !== null) {
                const escaped = {};
                for (const key in input) {
                    escaped[key] = typeof input[key] === 'string' ? sanitize(input[key]) : input[key];
                }
                return escaped;
            }
            return '';
        },

        // escape: function (string) {
        //     return string
        //     ? string
        //     .replace(/</ig, '&lt;')
        //     .replace(/\b(?:javascript:|onclick|onerror|ontoggle|onmouseover|onload|oncontextmenu|ondblclick|onmousedown|onmouseenter|onmouseleave|onmousemove|onmouseout|onmouseup)\b/ig, '')
        // : '';
        // },

        // Remove the Support Board syntax from a string
        strip: function (message) {
            message = message.replace('```', '');
            let patterns = [/\*([^\**]+)\*/, /\__([^\____]+)\__/, /\~([^\~~]+)\~/, /\`([^\``]+)\`/];
            for (var i = 0; i < 2; i++) {
                patterns.forEach(pattern => {
                    message = message.replace(pattern, (match) => match.replace(/[\*\_\~\`]/g, ''));
                });
            }
            return message.replace(/\\,/g, ',').replace(/\\:/g, ':');;
        },

        // Visibility change function
        visibilityChange: function (visibility = '') {
            this.visibility_status = visibility;
            let is_admin = admin && typeof SBAdmin !== ND;
            if (visibility == 'hidden') {
                if (!admin) {
                    SBChat.stopRealTime();
                }
                SBChat.tab_active = false;
                this.visibility_was_hidden = true;
            } else {
                if (activeUser() && !admin) {
                    SBChat.startRealTime();
                }
                SBChat.tab_active = true;
                clearInterval(interval);
                clearInterval(SBChat.audio_interval);
                if (SBChat.conversation) {
                    SBChat.conversation.updateMessagesStatus();
                    if (SBChat.chat_open || admin) {
                        SBChat.updateNotifications(SBChat.conversation.id);
                    }
                    if (is_admin) {
                        setTimeout(() => {
                            SBAdmin.conversations.notificationsCounterReset(SBChat.conversation.id);
                        }, 2000);
                    }
                }
                if (is_admin) {
                    if ((Date.now() - (mobile ? 60000 : 180000)) > conversation_update_last_check) {
                        SBAdmin.conversations.update();
                        conversation_update_last_check = Date.now();
                    }
                    if (mobile) {
                        SBChat.update();
                    }
                }
                document.title = document_title;
                this.serviceWorker.closeNotifications();
            }
        },

        // Convert a settings string to an Array
        settingsStringToArray: function (string) {
            if (this.null(string)) {
                return [];
            }
            let result = [];
            string = string.split(',');
            for (var i = 0; i < string.length; i++) {
                let values = string[i].split(':');
                result[values[0]] = values[1] == 'false' ? false : values[1] == 'true' ? true : values[1];
            }
            return result;
        },

        // Open a browser window
        openWindow: function (link, width = 550, height = 350) {
            let left = (screen.width / 2) - (width / 2);
            let top = (screen.height / 2) - (height / 2);
            window.open(link, 'targetWindow', 'toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=' + width + ',height=' + height + ', top=' + top + ', left=' + left);
            return false;
        },

        // Convert a date to local time
        convertUTCDateToLocalDate: function (datetime, utc_offset = 0) {
            datetime = new Date(datetime); // Y/m/d H:i:s
            datetime = new Date(datetime.getTime() + utc_offset * 3600000);
            return new Date(datetime.getTime() + utc_offset_user * -1);
        },

        // Load a JS or CSS file
        loadResource: function (src, js = false, onLoad = false, content = false) {
            let resource = document.createElement(js ? 'script' : 'link');
            if (src) {
                if (js) resource.src = src; else resource.href = src;
                resource.type = js ? 'text/javascript' : 'text/css';
            } else {
                resource.innerHTML = content;
            }
            if (onLoad) {
                resource.onload = function () {
                    onLoad();
                }
            }
            if (!js) {
                resource.rel = 'stylesheet';
            }
            document.head.appendChild(resource);
        },

        // Debounce
        debounce: function (bounceFunction, id, interval = 500) {
            if (!(id in timeout_debounce)) {
                timeout_debounce[id] = true;
                bounceFunction();
                setTimeout(() => {
                    delete timeout_debounce[id];
                }, interval);
            }
        },

        // Push Notifications
        serviceWorker: {
            sw: false,
            timeout: false,

            init: function () {
                if (navigator.serviceWorker) {
                    navigator.serviceWorker.register(admin || typeof SB_CLOUD_SW != 'undefined' ? SB_URL.replace('/script', '') + '/sw.js?v=' + version : CHAT_SETTINGS.push_notifications_url + '?v=' + version).then((registration) => {
                        registration.update();
                        this.sw = registration;
                    }).catch(function (error) {
                        console.warn(error);
                    });
                }
            },

            initPushNotifications: function () {
                if ((admin && (SB_ADMIN_SETTINGS.push_notifications_provider == 'pusher' || SB_ADMIN_SETTINGS.push_notifications_provider != 'onesignal')) || (!admin && (CHAT_SETTINGS.push_notifications_provider == 'pusher' || CHAT_SETTINGS.push_notifications_provider != 'pushalert'))) { // Deprecated: remove || CHAT_SETTINGS.push_notifications_provider != '' and || SB_ADMIN_SETTINGS.push_notifications_provider != 'pushalert'
                    SBPusher.initPushNotifications();
                } else {
                    $.getScript('https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js', () => {
                        window.OneSignalDeferred = window.OneSignalDeferred || [];
                        OneSignalDeferred.push((OneSignal) => {
                            OneSignal.init({
                                appId: SB_ADMIN_SETTINGS.push_notifications_id
                            });
                        });
                        OneSignalDeferred.push((OneSignal) => {
                            OneSignal.User.PushSubscription.addEventListener('change', (event) => {
                                if (event.current.optedIn) {
                                    let external_id = (admin && SB_ADMIN_SETTINGS.cloud ? SB_ADMIN_SETTINGS.cloud.cloud_user_id + '-' : (!admin && CHAT_SETTINGS.cloud ? CHAT_SETTINGS.cloud.cloud_user_id + '-' : '')) + (admin ? SB_ACTIVE_AGENT.id : activeUser().id);
                                    if (external_id == 1) {
                                        external_id = 'SB-1';
                                    }
                                    OneSignal.User.addTag('user_type', admin ? 'agents' : 'users');
                                    OneSignal.login(external_id);
                                }
                                SBF.event('SBPushNotificationSubscription', event.current);
                            });
                        });
                        init_push_notifications = false;
                    });
                }
            },

            closeNotifications: function (index = 0) {
                if (this.sw) {
                    this.sw.getNotifications().then((notifications) => {
                        if (notifications.length) {
                            for (let i = 0; i < notifications.length; i += 1) {
                                notifications[i].close();
                            }
                        } else if (index < 300 && SBF.visibility_status == 'visible') {
                            setTimeout(() => {
                                this.closeNotifications(index + 1);
                            }, 10);
                        }
                    });
                }
            },

            pushNotification: function (message, interests = false) {
                let icon = admin ? SB_ACTIVE_AGENT.profile_image : activeUser().image;
                SBF.ajax({
                    function: 'push-notification',
                    title: admin ? SB_ACTIVE_AGENT.full_name : activeUser().name,
                    message: SBF.strip(message),
                    icon: icon.indexOf('user.svg') > 0 ? CHAT_SETTINGS.notifications_icon : icon,
                    interests: interests ? interests : SBChat.getRecipientUserID(),
                    conversation_id: SBChat.conversation ? SBChat.conversation.id : false
                }, (response) => {
                    return response
                });
            }
        },

        beautifyAttachmentName: function (name) {
            let index = name.indexOf('_');
            return index !== -1 ? name.substring(index + 1) : name;
        }
    }

    /*
    * ----------------------------------------------------------
    * PUSHER
    * ----------------------------------------------------------
    */

    var SBPusher = {
        channels: {},
        channels_presence: [],
        active: false,
        pusher: false,
        started: false,
        pusher_beams: false,
        initialized: false,
        online_ids: [],
        beams_loaded: false,

        // Initialize Pusher
        init: function (onSuccess = false) {
            if (SBPusher.active) {
                if (this.pusher) {
                    return onSuccess ? onSuccess() : true;
                } else if (onSuccess) {
                    $(window).one('SBPusherInit', () => {
                        onSuccess();
                    });
                } else {
                    return;
                }
                this.initialized = true;
                if (typeof Pusher === ND) {
                    $.getScript('https://js.pusher.com/8.2.0/pusher.min.js', () => {
                        window.Pusher = Pusher;
                        this.init_2();
                    }, true);
                } else {
                    this.init_2();
                }
            }
        },

        init_2: function () {
            this.pusher = new Pusher(admin ? SB_ADMIN_SETTINGS.pusher_key : CHAT_SETTINGS.pusher_key, {
                cluster: admin ? SB_ADMIN_SETTINGS.pusher_cluster : CHAT_SETTINGS.pusher_cluster,
                channelAuthorization: {
                    endpoint: SB_URL + '/include/pusher.php',
                    params: {
                        login: SBF.loginCookie(),
                        cloud_user_id: CHAT_SETTINGS.cloud ? CHAT_SETTINGS.cloud.cloud_user_id : false
                    }
                }
            });
            SBF.event('SBPusherInit');
        },

        // Initialize Push notifications
        initPushNotifications: function () {
            if (activeUser() || admin) {
                if (this.beams_loaded) {
                    this.initPushNotifications_2();
                } else {
                    $.getScript('https://js.pusher.com/beams/2.0.0-beta.0/push-notifications-cdn.js', () => {
                        this.initPushNotifications_2();
                    }, true);
                }
            }
        },

        initPushNotifications_2: function () {
            window.navigator.serviceWorker.ready.then((serviceWorkerRegistration) => {
                this.pusher_beams = new PusherPushNotifications.Client({
                    instanceId: admin ? SB_ADMIN_SETTINGS.push_notifications_id : CHAT_SETTINGS.push_notifications_id,
                    serviceWorkerRegistration: serviceWorkerRegistration,
                });
                SBF.serviceWorker.closeNotifications();
                this.pusher_beams.start().then(() => this.pusher_beams.setDeviceInterests(admin ? [SB_ACTIVE_AGENT.id, 'agents'] : [activeUser().id, 'users'])).catch(console.error);
                init_push_notifications = false;
            });
        },

        // Start Pusher and Push notifications
        start: function () {
            if (!admin && !this.started && activeUser()) {
                if (this.active) {
                    this.init(() => {
                        this.event('client-typing', (response) => {
                            if (response.user_id == SBChat.agent_id && SBChat.conversation && response.conversation_id == SBChat.conversation.id) {
                                SBChat.typing(-1, 'start');
                                clearTimeout(timeout_typing);
                                timeout_typing = setTimeout(() => { SBChat.typing(-1, 'stop') }, 1000);
                            }
                        });
                        this.event('new-message', (response) => {
                            if (response && activeUser() && response.conversation_id && (!activeUser().getConversationByID(response.conversation_id) || !SBChat.conversation || SBChat.conversation.id != response.conversation_id)) {
                                SBChat.updateConversations();
                            } else {
                                SBChat.update();
                            }
                        });
                        this.presence(1, () => {
                            this.started = true;
                            SBChat.automations.runAll();
                        });
                    });
                }
                if (CHAT_SETTINGS.push_notifications_users) {
                    if (CHAT_SETTINGS.push_notifications_provider == 'pusher' || CHAT_SETTINGS.push_notifications_provider != 'onesignal') { // Deprecated: remove || CHAT_SETTINGS.push_notifications != ''
                        if (typeof Notification != ND && Notification.permission == 'granted') {
                            this.initPushNotifications();
                        } else {
                            init_push_notifications = true;
                        }
                    }
                }
            }
        },

        // Subscribe to a channel
        subscribe: function (channel_name, onSuccess = false) {
            if (!this.pusher) {
                return this.init(() => { this.subscribe(channel_name, onSuccess) });
            }
            channel_name = this.cloudChannelRename(channel_name);
            let channel = this.pusher.subscribe(channel_name);
            channel.bind('pusher:subscription_error', (error) => {
                return console.log(error);
            });
            channel.bind('pusher:subscription_succeeded', () => {
                this.channels[channel_name] = channel;
                if (onSuccess) onSuccess();
            })
        },

        // Add event listener for a channel
        event: function (event, callback, channel = 'private-user-' + activeUser().id) {
            if (!this.pusher) {
                return this.init(() => { this.event(event, callback, channel) });
            }
            let channel_original = channel;
            channel = this.cloudChannelRename(channel);
            if (channel in this.channels) {
                this.channels[channel].unbind(event);
                this.channels[channel].bind(event, (data) => {
                    callback(data);
                });
            } else {
                this.subscribe(channel_original, () => { this.event(event, callback, channel_original) });
            }
        },

        // Trigger an event
        trigger: function (event, data = {}, channel = 'private-user-' + activeUser().id) {
            if (event.indexOf('client-') == 0) {
                return this.channels[this.cloudChannelRename(channel)].trigger(event, data);
            } else {
                SBF.ajax({
                    function: 'pusher-trigger',
                    channel: channel,
                    event: event,
                    data: data
                }, (response) => {
                    return response
                });
            }
        },

        // Presence  
        presence: function (index = 1, onSuccess) {
            if (!this.pusher) {
                return this.init(() => { this.presence() });
            }
            let channel = this.pusher.subscribe(this.cloudChannelRename('presence-' + index));
            channel.bind('pusher:subscription_succeeded', (members) => {
                if (members.count > 98) {
                    return this.subscribe(index + 1);
                }
                members.each((member) => {
                    if (this.presenceCheck(member)) {
                        this.online_ids.push(member.id);
                    }
                });
                SBChat.updateUsersActivity();
                if (onSuccess) {
                    onSuccess();
                }
            })
            channel.bind('pusher:subscription_error', (error) => {
                return console.log(error);
            });
            channel.bind('pusher:member_added', (member) => {
                if (this.presenceCheck(member)) {
                    this.presenceAdd(member.id);
                }
                if (admin && SBF.storageTime('online-user-notification-' + member.id, 24)) {
                    SBAdmin.users.onlineUserNotification(member);
                    SBF.storageTime('online-user-notification-' + member.id);
                }
            });
            channel.bind('pusher:member_removed', (member) => {
                this.presenceRemove(member.id);
            });
            this.channels_presence.push(channel);
            if (!admin && CHAT_SETTINGS.slack_active) {
                this.event('add-user-presence', (response) => {
                    this.presenceAdd(response.agent_id)
                });
                SBF.ajax({
                    function: 'slack-presence',
                    list: true
                }, (response) => {
                    for (var i = 0; i < response.length; i++) {
                        this.presenceAdd(response[i]);
                    }
                    SBChat.updateUsersActivity();
                });
            }
        },

        presenceCheck: function (member) {
            let agent = SBF.isAgent(member.info.user_type);
            return ((admin && !agent) || (!admin && agent)) && !this.online_ids.includes(member.id);
        },

        presenceAdd: function (user_id) {
            if (typeof user_id != ND && !this.online_ids.includes(user_id)) {
                this.online_ids.push(user_id);
                this.presenceUpdateAdmin(user_id);
                SBChat.updateUsersActivity();
            }
        },

        presenceRemove: function (user_id) {
            if (typeof user_id == ND) {
                return;
            }
            let index = this.online_ids.indexOf(user_id);
            if (index !== -1) {
                this.online_ids.splice(index, 1);
                this.presenceUpdateAdmin(user_id);
                SBChat.updateUsersActivity();
            } else if (admin) {
                global.find(`.sb-conversation-busy[data-agent="${user_id}"]`).remove();
            }
        },

        presenceUnsubscribe: function () {
            for (var i = 0; i < this.channels_presence.length; i++) {
                this.channels_presence[i].unsubscribe(this.cloudChannelRename('presence-' + (i + 1)));
            }
        },

        presenceUpdateAdmin: function (user_id) {
            if (admin) {
                if (global.find('.sb-area-users.sb-active').length) {
                    SBAdmin.users.update();
                }
                if (activeUser() && activeUser().id == user_id) {
                    SBAdmin.users.updateUsersActivity();
                }
            }
        },

        cloudChannelRename: function (channel) {
            return (CHAT_SETTINGS.cloud || (admin && SB_ADMIN_SETTINGS.cloud)) ? channel + '-' + (admin ? SB_ADMIN_SETTINGS.cloud.cloud_user_id : CHAT_SETTINGS.cloud.cloud_user_id) : channel;
        }
    }

    /*
    * ----------------------------------------------------------
    * GLOBAL FUNCTIONS
    * ----------------------------------------------------------
    */

    window.SBF = SBF;
    window.SBPusher = SBPusher;
    window.sb_current_user = sb_current_user;

    /*
    * ----------------------------------------------------------
    * JQUERY FUNCTIONS
    * ----------------------------------------------------------
    */

    $.fn.sbActive = function (show = -1) {
        if (show === -1) {
            return $(this).hasClass('sb-active');
        }
        $(this).setClass('sb-active', show);
        return this;
    };

    $.fn.sbLoading = function (value = 'check') {
        if (value == 'check') {
            return $(this).hasClass('sb-loading');
        } else {
            $(this).setClass('sb-loading', value);
        }
        return this;
    }

    $.fn.sbTogglePopup = function (button = false) {
        let showed = true;
        if (admin) SBAdmin.open_popup = false;
        if ($(this).sbActive()) {
            $(this).sbActive(false);
            global.removeClass('sb-popup-active');
            showed = false;
        } else {
            global.addClass('sb-popup-active');
            global.find('.sb-popup').sbActive(false);
            if (button) $(this).css('left', $(button).offset().left + 15).sbActive(true);
            if (admin) setTimeout(() => { SBAdmin.open_popup = this }, 500);
            SBF.deselectAll();
        }
        return showed;
    };

    $.fn.sbUploadFiles = function (onSuccess, index = false) {
        let files = $(this).prop('files');
        for (var i = (index === false ? 0 : index); i < (index === false ? files.length : index + 1); i++) {
            let file = files[i];
            let size_mb = file.size / (1024 ** 2);
            let max_size = admin ? SB_ADMIN_SETTINGS.max_file_size : CHAT_SETTINGS.max_file_size;
            if (size_mb > max_size) {
                let message = sb_('Maximum upload size is {R}MB. File size: {R2}MB.').replace('{R}', max_size).replace('{R2}', size_mb.toFixed(2));
                if (admin) {
                    SBAdmin.infoPanel(message, 'info');
                } else {
                    alert(message);
                }
            }
            let form = new FormData();
            form.append('file', file);
            SBF.upload(form, onSuccess);
        }
        $(this).value = '';
    }

    $.fn.setProfile = function (name = false, profile_image = false) {
        if (SBF.null(name)) {
            name = activeUser() ? activeUser().name : '';

        }
        if (SBF.null(profile_image)) {
            profile_image = activeUser() ? activeUser().image : SB_URL + '/media/user.svg';
        }
        if (name) {
            $(this).removeClass('sb-profile-empty');
        }
        // $(this).find('img').attr('src', profile_image);
        // $(this).find('.sb-name').html(name);

        // header dp code start
        const profileBlocks = $('.header-right .user_avatar');
        profileBlocks.each(function () {

            const profile = $(this);
            profile.removeClass('sb-profile-empty');
            //profile.find('img').attr('src', profile_image).attr('data-name', activeUserName || '');

            const pro = profile.find(".sb-profile");
            const img = profile.find(".avatar_img");
            const user_name = img.attr('alt')
            profile.find('.sb-name').text(user_name || '');
            const initials = user_name.split(" ").map(word => word[0]).join("").substring(0, 2).toUpperCase();
            const avatar_initials = profile.find('.avatar_initials');
            const avatar_name = profile.find(".avatar_name");

            if (!img.attr('src') || img.attr('src').includes('user.svg')) {
                img.hide();
                avatar_name.text(initials || "NA");
                avatar_initials.show();
                pro.css('padding-left', '0');
            }
            img.on('error', function () {
                img.hide();
                avatar_name.text(initials || "NA");
                avatar_initials.show();
                pro.css('padding-left', '0');
            });

            // Trigger fallback if image is already broken (e.g. 404 cached)
            if (!img.prop('complete') || typeof img[0].naturalWidth === "undefined" || img[0].naturalWidth === 0) {
                img.hide();
                avatar_name.text(initials || "NA");
                avatar_initials.show();
                pro.css('padding-left', '0');
            }
        });
        // header dp code end 

        const img = $(this).find('img');
        img.attr('src', profile_image).attr('data-name', name);
        $(this).find('.sb-name').html(name);

        const span = $(this).find(".initials");
        const userInitials = $(this).find(".user-initials");

        img.show();
        userInitials.hide();

        const initials = name
            .split(" ")
            .map(word => word[0])
            .join("")
            .substring(0, 2)
            .toUpperCase();

        function showInitialsFallback() {
            img.hide();
            if (span.length) {
                userInitials.css("display", "inline-block");
                span.text(initials || "NA");
            }
        }

        // Attach error event
        img.on('error', showInitialsFallback);

        // Trigger fallback if image is already broken (e.g. 404 cached)
        if (!img.prop('complete') || typeof img[0].naturalWidth === "undefined" || img[0].naturalWidth === 0) {
            showInitialsFallback();
        }

        // If the image source is a default user icon, show initials
        if (img.attr('src') && img.attr('src').includes('user.svg')) {
            showInitialsFallback();
        }

        //await showInitials('header-right','user-profile');
        return this;
    };

    $.fn.setClass = function (class_name, add = true) {
        if (add) {
            $(this).addClass(class_name);
        } else {
            $(this).removeClass(class_name);
        }
        return this;
    }

    /*
    * ----------------------------------------------------------
    * FUNCTIONS
    * ----------------------------------------------------------
    */


    async function showInitials(container, className) {
        const containers = $('.' + container + ' .' + className);
        containers.each(function () {
            const container = $(this);
            const img = container.find('img');
            const name = img.attr("data-name") || "";
            const initials = name
                .split(" ")
                .map(word => word[0])
                .join("")
                .substring(0, 2)
                .toUpperCase();
            const span = container.find(".initials");
            const userInitials = container.find('.user-initials');

            // Fallback: if image is broken, use initials
            function showInitialsFallback() {
                img.hide();
                if (span.length) {
                    userInitials.css("display", "inline-block");
                    span.text(initials || "NA");
                }
            }

            // Attach error event
            img.on('error', showInitialsFallback);

            // Trigger fallback if image is already broken (e.g. 404 cached)
            if (!img.prop('complete') || typeof img[0].naturalWidth === "undefined" || img[0].naturalWidth === 0) {
                showInitialsFallback();
            }

            // If the image source is a default user icon, show initials
            if (img.attr('src') && img.attr('src').includes('user.svg')) {
                showInitialsFallback();
            }
        });
    }


    function sbDelta(e) {
        let delta = e.originalEvent.wheelDelta;
        if (typeof delta == ND) {
            delta = e.originalEvent.deltaY;
        }
        if (typeof delta == ND) {
            delta = e.originalEvent.detail * -1;
        }
        return delta;
    }

    function loading(element) {
        if ($(element).sbLoading()) {
            return true;
        } else {
            $(element).sbLoading(true);
        }
        return false;
    }

    function storage(key, value = ND) {
        return SBF.storage(key, value);
    }

    function sb_(string) {
        return SBF.translate(string);
    }

    function activeUser(value = -1) {
        if (value === -1) {
            return window.sb_current_user;
        } else {
            window.sb_current_user = value;
        }
    }

    function setAudio() {
        let volume = admin ? SB_ADMIN_SETTINGS.sound.volume : CHAT_SETTINGS.sound.volume;
        if (SBChat.audio && volume) {
            SBChat.audio.volume = volume;
        }
    }

    function getMinutesSeconds(seconds) {
        let minutes = Math.floor(seconds / 60);
        seconds = seconds - minutes * 60;
        return (minutes ? minutes : '0') + ':' + (seconds < 10 ? '0' + seconds : seconds);
    }

    /* 
    * ----------------------------------------------------------
    * USER
    * ----------------------------------------------------------
    */

    class SBUser {
        constructor(details = {}, extra = {}) {
            this.details = details;
            this.extra = extra;
            this.conversations = [];
            this.processArray(details);
        }

        get id() {
            return this.get('id') ? this.get('id') : this.get('user_id');
        }

        get type() {
            return this.get('user_type');
        }

        get email() {
            return this.get('email');
        }

        get name() {
            return this.details.first_name ? this.details.first_name + (this.details.last_name ? ' ' + this.details.last_name : '') : '';
        }

        get nameBeautified() {
            let default_name = admin ? SB_ADMIN_SETTINGS.visitor_default_name : CHAT_SETTINGS.visitor_default_name;
            return !default_name || (this.details.last_name && this.details.last_name.charAt(0) != '#') ? this.name : default_name;
        }

        get image() {
            return this.get('profile_image');
        }

        get language() {
            let language = this.getExtra('language');
            if (!language) {
                language = this.getExtra('browser_language');
            }
            return language ? language.value.toLowerCase() : '';
        }

        get(id) {
            if (id in this.details && !SBF.null(this.details[id])) {
                return this.details[id];
            }
            return '';
        }

        getExtra(id) {
            if (id in this.extra && !SBF.null(this.extra[id])) {
                return this.extra[id];
            }
            return '';
        }

        set(id, value) {
            this.details[id] = value;
        }

        setExtra(id, value) {
            this.extra[id] = value;
        }

        // Initialization
        processArray(details) {
            if (details && details.details) {
                for (var i = 0; i < details.details.length; i++) {
                    this.setExtra(details.details[i].slug, details.details[i]);
                }
                delete details.details;
                this.details = details;
            }
        }

        // Get user details and extra details
        update(onSuccess) {
            if (this.id) {
                SBF.ajax({
                    function: 'get-user',
                    user_id: this.id,
                    extra: true
                }, (response) => {
                    this.processArray(response);
                    onSuccess();
                    SBF.event('SBGetUser', this);
                });
            } else {
                SBF.error('Missing user ID', 'SBUser.update');
            }
        }

        // Get user conversations
        getConversations(onSuccess = false, exclude_id) {
            if (this.id) {
                SBF.ajax({
                    function: 'get-user-conversations',
                    user_id: this.id,
                    exclude_id: exclude_id,
                    agent: SBF.isAgent(this.type)
                }, (response) => {
                    if (!SBF.errorValidation(response)) {
                        let conversations = [];
                        for (var i = 0; i < response.length; i++) {
                            if (SBChat.isConversationAllowed(response[i].source, response[i].conversation_status_code)) {
                                conversations.push(new SBConversation([new SBMessage(response[i])], response[i]));
                            }
                        }
                        this.conversations = conversations;
                        if (onSuccess) {
                            onSuccess(conversations);
                        }
                    }
                });
            } else {
                SBF.error('Missing user ID', 'SBUser.getConversations');
            }
        }

        // Get conversations code
        getConversationsCode(conversations = false) {
            let code = '';
            let active_conversation_id = SBChat.conversation ? SBChat.conversation.id : -1;
            if (!conversations) {
                conversations = this.conversations;
            }
            for (var i = 0; i < conversations.length; i++) {
                if (conversations[i] instanceof SBConversation) {
                    if (!admin && !SBChat.isConversationAllowed(conversations[i].get('source'), conversations[i].status_code)) {
                        continue;
                    }
                    let red_notifications = 0;
                    let is_active_conversation = active_conversation_id == conversations[i].id;
                    if (!admin && !is_active_conversation) {
                        for (var j = 0; j < SBChat.notifications.length; j++) {
                            if (SBChat.notifications[j][0] == conversations[i].id) {
                                red_notifications++;
                            }
                        }
                    }
                    code += `<li ${is_active_conversation ? 'class="sb-active" ' : ''}data-conversation-status="${is_active_conversation ? 0 : conversations[i].status_code}" data-conversation-id="${conversations[i].id}" data-department="${conversations[i].get('department')}">${conversations[i].getCode()}${red_notifications ? '<span data-count="' + red_notifications + '">' + red_notifications + '</span>' : ''}</li>`;
                } else {
                    SBF.error('Conversation not of type SBConversation', 'SBUser.getConversationsCode');
                }
            }
            return code;
        }

        // Get single conversation
        getFullConversation(conversation_id = false, onSuccess = false) {
            if (conversation_id !== false) {
                SBF.ajax({
                    function: 'get-conversation',
                    conversation_id: conversation_id
                }, (response) => {
                    let messages = [];
                    if (response) {
                        if (response === 'agent-not-authorized') {
                            window.location.href = SBF.URL();
                            return;
                        }
                        for (var i = 0; i < response.messages.length; i++) {
                            messages.push(new SBMessage(response.messages[i]));
                        }
                    }
                    if (onSuccess) {
                        onSuccess(new SBConversation(messages, response ? response.details : false));
                    }
                });
            } else {
                SBF.error('Missing conversation ID', 'SBUser.getFullConversation');
            }
        }

        getConversationByID(conversation_id, index = false) {
            for (var i = 0; i < this.conversations.length; i++) {
                if (this.conversations[i].id == conversation_id) {
                    return index ? i : this.conversations[i];
                }
            }
            return false;
        }

        // Add a new conversation
        addConversation(conversation) {
            if (conversation instanceof SBConversation) {
                let conversation_id = conversation.id;
                let is_new = true;
                for (var i = 0; i < this.conversations.length; i++) {
                    if (this.conversations[i].id == conversation_id) {
                        this.conversations[i] = conversation;
                        is_new = false;
                        break;
                    }
                }
                if (is_new) {
                    this.conversations.unshift(conversation);
                }
                return is_new;
            } else {
                SBF.error('Conversation not of type SBConversation', 'SBUser.addConversation');
            }
        }

        // Remove a conversation
        removeConversation(conversation_id) {
            let index = this.getConversationByID(conversation_id, true);
            if (index !== false) {
                this.conversations.splice(index, 1);
            }
        }

        // Get the last conversation
        getLastConversation() {
            return this.isConversationsEmpty() ? false : this.conversations[this.conversations.length - 1];
        }

        // Check if the conversation array is empty
        isConversationsEmpty() {
            return this.conversations.length == 0;
        }

        // Check if the extra array is empty
        isExtraEmpty() {
            return Object.keys(this.extra).length === 0 && this.extra.constructor === Object;
        }

        // Delete the user
        delete(onSuccess) {
            if (this.id) {
                SBF.ajax({
                    function: 'delete-user',
                    user_id: this.id
                }, () => {
                    SBF.event('SBUserDeleted', this.id);
                    onSuccess();
                    return true;
                });
            } else {
                SBF.error('Missing user ID', 'SBUser.delete');
            }
        }
    }
    window.SBUser = SBUser;

    /* 
    * ----------------------------------------------------------
    * MESSAGE
    * ----------------------------------------------------------
    */

    class SBMessage {
        constructor(details = {}) {
            this.details = Object.assign({}, details);
            let keys = ['message_status_code', 'message_id', 'message_profile_image', 'message_first_name', 'message_last_name', 'message_user_id', 'message_user_type'];
            let keys_delete = ['source', 'extra', 'title', 'tags', 'agent_id', 'department', 'last_update_time', 'conversation_creation_time', 'conversation_id', 'conversation_status_code', 'conversation_user_id'];
            for (var i = 0; i < keys.length; i++) {
                if (details[keys[i]]) {
                    this.details[keys[i].replace('message_', '')] = details[keys[i]];
                }
                delete this.details[keys[i]];
            }
            if (this.details.first_name) {
                this.details.full_name = this.details.first_name + (this.details.last_name ? ' ' + this.details.last_name : '');
            }
            if (details.last_update_time) {
                this.details.creation_time = details.last_update_time;
            }
            for (var i = 0; i < keys_delete.length; i++) {
                delete this.details[keys_delete[i]];
            }
            let payload = this.get('payload');
            if (payload) {
                try {
                    var json = JSON.parse(this.get('payload').replace("\\'", "'"));
                    if (json && typeof json === 'object') {
                        payload = json;
                    } else {
                        payload = {};
                    }
                } catch (e) {
                    payload = {};
                }
            } else {
                payload = {};
            }
            this.set('payload', payload);
        }

        get id() {
            return this.get('id');
        }

        get attachments() {
            return !SBF.null(this.details.attachments) ? JSON.parse(this.details.attachments) : [];
        }

        get message() {
            return admin ? (this.payload('translation') && this.payload('translation-language') == SB_ADMIN_SETTINGS.active_agent_language ? this.payload('translation') : (this.payload('original-message-language') == SB_ADMIN_SETTINGS.active_agent_language ? this.payload('original-message') : this.get('message'))) : this.get('message');
        }

        get(id) {
            if (id in this.details && !SBF.null(this.details[id])) {
                return this.details[id];
            }
            return '';
        }

        set(id, value) {
            this.details[id] = value;
        }

        payload(key = false, value = false) {
            let payload = this.get('payload');
            if (key !== false && value !== false) {
                payload[key] = value;
                this.set('payload', payload);
            } else if (key !== false) {
                return key in payload ? payload[key] : (payload.id && payload.id == key ? payload : false);
            }
            return ['boolean', 'string'].includes(typeof payload) ? [] : payload;
        }

        getCode() {
            let agent = SBF.isAgent(this.details.user_type);
            let message = this.message;
            let attachments = this.attachments;
            let reply = this.payload('reply');
            let admin_menu = admin ? SBAdmin.conversations.messageMenu(agent, message, !reply) : '';
            let attachments_code = '';
            let media_code = '';
            let thumb = (admin && SB_ADMIN_SETTINGS.show_profile_images) || (!admin && ((agent && !CHAT_SETTINGS.hide_agents_thumb) || (!agent && CHAT_SETTINGS.display_users_thumb))) ? `<div class="sb-thumb"><img loading="lazy" src="${this.details['profile_image']}"><div class="sb-tooltip"><div>${this.details['full_name']}</div></div></div>` : '';
            let css = ((admin && agent) || (!admin && !agent) ? 'sb-right' : '') + (thumb ? ' sb-thumb-active' : '');
            let type = '';
            let name = (!admin && agent && CHAT_SETTINGS.sender_name) || (admin && SB_ADMIN_SETTINGS.sender_name == 'chat-admin') ? `<span class="sb-agent-name">${this.get('full_name')}</span>` : '';
            let delivery_failed = admin ? this.payload().delivery_failed : false;

            if (!message && !attachments.length) {
                return '';
            }
            if (reply && SBChat.conversation && SBChat.conversation.getMessage(reply)) {
                reply = SBChat.conversation.getMessage(reply);
                let is_agent = SBF.isAgent(reply.get('user_type'));
                let text = reply.message;
                if (!text) {
                    text = '<div class="sb-message-attachments">';
                    attachments.forEach((attachment) => {
                        text += `<a>${attachment[0]}</a>`;
                    });
                    text += '</div>';
                }
                reply = `<div class="sb-reply-message${is_agent ? ' sb-reply-agent' : ''}"><span>${(is_agent && admin) || (!is_agent && !admin) ? sb_('You') : reply.get('full_name')}</span> ${text}</div>`;
            } else {
                reply = '';
            }

            // Rich Messages
            if (agent) {
                message = message.replace(/\n/g, '<br>');
                message = message.replace(/`([\s\S]*?)`/g, (match) => {
                    return match.replace(/\[/g, '&#91;');
                });
                let shortcodes = message.match(/\[([^\[\]]*(?:\[[^\[\]]*\][^\[\]]*)*)\]/g) || [];
                let is_rich_message = false;
                let count = shortcodes.length;
                for (var i = 0; i < count; i++) {
                    let settings = SBRichMessages.shortcode(shortcodes[i]);
                    if (settings[0]) {
                        if (settings[0] == 'action') {
                            message = message.replace(shortcodes[i], '');
                        } else {
                            let rich_message = SBRichMessages.generate(settings[1], settings[0]);
                            if (rich_message) {
                                message = message.replace(shortcodes[i], rich_message);
                                is_rich_message = true;
                                type = `data-type="${settings[0]}"`;
                            }
                        }
                    }
                }
                if (is_rich_message) {
                    css += ' sb-rich-cnt';
                    if (count > 1) {
                        type = 'data-type="multiple"';
                    }
                }
            } else if (message.includes('[rating ')) {
                let settings = SBRichMessages.shortcode(message);
                message = SBRichMessages.generate(settings[1], settings[0]);
            }
            let matches = message.includes('data-success') ? [...message.matchAll(/data-success="([^"]*)"/g)].map(match => match[1]) : [];
            for (var i = 0; i < matches.length; i++) {
                message = message.replace(matches[i], '{R' + i + '}');
            }
            message = this.render(message);
            for (var i = 0; i < matches.length; i++) {
                message = message.replace('{R' + i + '}', matches[i]);
            }

            // Attachments
            if (attachments.length) {
                attachments_code = '<div class="sb-message-attachments">';
                for (var i = 0; i < attachments.length; i++) {
                    let url = attachments[i][1];
                    let url_and_name = url + attachments[i][0];
                    if (SBF.getFileType(url_and_name) == 'image') {
                        let size = '';
                        if (attachments[i].length > 2) {
                            size = attachments[i][2].split('|');
                            size = `width="${size[0]}" style="aspect-ratio: ${size[0]} / ${size[1]}"`;
                        }
                        media_code += `<div class="sb-image${url_and_name.includes('.png') ? ' sb-image-png' : (url.includes('sticker_') ? ' sb-image-sticker' : '')}"><img loading="lazy" src="${url}" ${size}/></div>`;
                    } else if (SBF.getFileType(url_and_name) == 'audio' || url.includes('voice_message') || url.includes('audioclip')) {
                        if ((admin && !SB_ADMIN_SETTINGS.speech_recognition) || (!admin && !CHAT_SETTINGS.speech_recognition)) {
                            message = '';
                        }
                        attachments_code += `<div class="sb-player"><div class="sb-player-btn sb-icon-play"></div><div class="sb-player-speed"><div class="sb-player-speed-number">1</div><div class="sb-icon-close"></div></div><div class="sb-player-download sb-icon-arrow-down"></div><audio><source src="${url}" type="audio/mpeg"></audio></div>`;
                    } else {
                        attachments_code += `<a rel="noopener" target="_blank" href="${url}">${SBF.beautifyAttachmentName(attachments[i][0])}</a>`;
                    }
                }
                attachments_code += '</div>';
            }

            // Message creation
            return `<div data-id="${this.details.id}" class="${css} ${media_code && !message ? ' media-item' : ''} ${attachments.length ? ' attachment' : ''}" ${type}>${thumb}${reply}<div class="sb-cnt"><div class="sb-message${media_code && !message ? ' sb-message-media' : ''}"${delivery_failed ? ' style="opacity:.7"' : ''}>${delivery_failed ? SBAdmin.conversations.getDeliveryFailedMessage(delivery_failed) : ''}${(name + message + media_code).trim()}</div>${attachments_code}<div class="sb-time">${SBF.beautifyTime(this.details.creation_time, true)}${admin && agent && this.details.status_code == 2 ? '<i class="sb-icon-check"></i>' : ''}</div></div>${admin_menu}</div>`;
        }

        render(message = false) {
            if (message === false) {
                message = '' + this.details.message;
            }
            let len = message.length;

            // Code block
            let codes = message.match(/```([\s\S]*?)```/g) || [];
            for (var i = 0; i < codes.length; i++) {
                message = message.replace(codes[i], '[code-' + i + ']');
            }

            // Breakline
            message = message.replace(/(?:\r\n|\r|\n)/g, '<br>');

            // Bold
            message = message.replace(/\*([^\**]+)\*/g, "<b>$1</b>");

            // Italic
            message = message.replace(/__(.+?)__/g, "<i>$1</i>");

            // Strikethrough
            message = message.replace(/\~([^\~~]+)\~/g, "<del>$1</del>");

            // Code
            message = message.replace(/\`([^\``]+)\`/g, "<code>$1</code>");

            // Single emoji
            if (((len == 6 || len == 5) && message.startsWith('&#x')) || len < 3 && message.match(/(?:[\u2700-\u27bf]|(?:\ud83c[\udde6-\uddff]){2}|[\ud800-\udbff][\udc00-\udfff]|[\u0023-\u0039]\ufe0f?\u20e3|\u3299|\u3297|\u303d|\u3030|\u24c2|\ud83c[\udd70-\udd71]|\ud83c[\udd7e-\udd7f]|\ud83c\udd8e|\ud83c[\udd91-\udd9a]|\ud83c[\udde6-\uddff]|\ud83c[\ude01-\ude02]|\ud83c\ude1a|\ud83c\ude2f|\ud83c[\ude32-\ude3a]|\ud83c[\ude50-\ude51]|\u203c|\u2049|[\u25aa-\u25ab]|\u25b6|\u25c0|[\u25fb-\u25fe]|\u00a9|\u00ae|\u2122|\u2139|\ud83c\udc04|[\u2600-\u26FF]|\u2b05|\u2b06|\u2b07|\u2b1b|\u2b1c|\u2b50|\u2b55|\u231a|\u231b|\u2328|\u23cf|[\u23e9-\u23f3]|[\u23f8-\u23fa]|\ud83c\udccf|\u2934|\u2935|[\u2190-\u21ff])/)) {
                message = `<span class="emoji-large">${message}</span>`;
            }

            // Links
            if (message.includes('](http')) {
                let temp = message.split('[');
                message = '';
                for (var i = 0; i < temp.length; i++) {
                    if (temp[i].includes('](http')) {
                        temp[i] = temp[i].substring(temp[i].indexOf('](') + 2, temp[i].length - 1);
                    }
                    message += temp[i];
                }
            }
            if (message.includes('www.')) {
                message = message.replaceAll('www.', 'https://www.').replaceAll('https://https:', 'https:').replaceAll('http://https:', 'http:');
            }
            let replace = [['href="http', '[L1]'], ['src="http', '[L2]'], ['url("http', '[L3]'], ['url(\'http', '[L4]'], ['extra="http', '[L5]'], ['data-link="http', '[L6]'], ['data-value="http', '[L7]']];
            for (var i = 0; i < replace.length; i++) {
                message = message.replaceAll(replace[i][0], replace[i][1]);
            }
            if (message.includes('http')) {
                message = message.autoLink({
                    target: '_blank',
                    callback: function (url) {
                        return url.includes('#sb-') ? `<a href="${url.split('#sb-')[0]}" target="_blank">${url.split('#sb-')[1].replaceAll('--', ' ')}</a>` : null;
                    }
                });
            }
            for (var i = 0; i < replace.length; i++) {
                message = message.replaceAll(replace[i][1], replace[i][0]);
            }

            // Code block restore
            for (var i = 0; i < codes.length; i++) {
                message = message.replace('[code-' + i + ']', '<pre>' + $.trim($.trim(codes[i].replace(/```<br>/g, '```').replace(/<br>```/g, '```')).replace(/```/g, '').replace(/(?:\r\n|\r|\n)/g, '<br>')) + '</pre>');
            }

            return message.replace(/&amp;lt;/g, '&lt;');
        }

        strip(message = false) {
            return SBF.strip(message === false ? '' + this.details.message : message);
        }
    }
    window.SBMessage = SBMessage;

    /* 
    * ----------------------------------------------------------
    * CONVERSATION
    * ----------------------------------------------------------
    */

    class SBConversation {
        constructor(messages, details) {
            this.details = SBF.null(details) ? {} : details;
            if (Array.isArray(messages)) {
                this.messages = [];
                if (messages.length) {
                    if (messages[0] instanceof SBMessage) {
                        this.messages = messages;
                    } else {
                        SBF.error('Messages not of type SBMessage', 'SBConversation.constructor');
                    }
                }
            } else {
                SBF.error('Message array not of type Array', 'SBConversation.constructor');
            }
            let keys = ['conversation_id', 'conversation_user_id', 'conversation_first_name', 'conversation_last_name', 'conversation_profile_image', 'conversation_user_type', 'conversation_creation_time', 'conversation_status_code'];
            let keys_delete = ['payload'];
            for (var i = 0; i < keys.length; i++) {
                if (details[keys[i]]) {
                    this.details[keys[i].replace('conversation_', '')] = details[keys[i]];
                }
                delete this.details[keys[i]];
            }
            for (var i = 0; i < keys_delete.length; i++) {
                delete this.details[keys_delete[i]];
            }
            if (details) {
                this.details.tags = 'tags' in details ? (typeof details.tags === 'string' ? details.tags.split(',') : details.tags) : [];
            }
        }

        get id() {
            return this.get('id');
        }

        get status_code() {
            return this.get('status_code');
        }

        get(id) {
            if (id in this.details && !SBF.null(this.details[id])) {
                return this.details[id];
            }
            if (id == 'title') {
                if (this.details.title) {
                    return this.details.title;
                } else if (this.details.first_name) {
                    return this.details.first_name + ' ' + this.details.last_name;
                } else if (this.messages.length) {
                    return this.messages[0].get('full_name');
                }
            }
            return '';
        }

        set(id, value) {
            this.details[id] = value;
        }

        getMessage(id) {
            for (var i = 0; i < this.messages.length; i++) {
                if (this.messages[i].id == id) {
                    this.messages[i].set('index', i);
                    return this.messages[i];
                }
            }
            return false;
        }

        getLastMessage() {
            let index = this.messages.length - 1;
            for (var i = index; i > -1; i--) {
                if (this.messages[i].message || this.messages[i].attachments.length || this.messages[i].payload('preview')) {
                    return this.messages[i];
                }
            }
            return false;
        }

        getLastUserMessage(index = false, agent = false) {
            if (index === false) {
                index = this.messages.length - 1;
            }
            for (var i = index; i > -1; i--) {
                let message = this.messages[i];
                let user_type = message.get('user_type');
                if ((message.message || message.attachments.length) && ((!agent && !SBF.isAgent(user_type)) || (agent === true && (user_type == 'agent' || user_type == 'admin')) || (agent == 'bot' && user_type == 'bot') || (agent == 'no-bot' && user_type != 'bot') || (agent == 'all' && SBF.isAgent(user_type)))) {
                    this.messages[i].set('index', i - 1);
                    return this.messages[i];
                }
            }
            return false;
        }

        getNextMessage(message_id, user_type = false) {
            let count = this.messages.length;
            for (var i = 0; i < count; i++) {
                if (this.messages[i].id == message_id && i < (count - 1)) {
                    for (var j = i + 1; j < count; j++) {
                        let message = this.messages[j];
                        let message_user_type = message.get('user_type');
                        let next_message = this.messages[i + 1];
                        if (!user_type || (user_type == 'agent' && SBF.isAgent(message_user_type)) || (user_type == 'user' && !SBF.isAgent(message_user_type))) {
                            return next_message;
                        }
                    }
                    break;
                }
            }
            return false;
        }

        getUserMessages(user_type = 'user') {
            let results = [];
            let checks = user_type == 'user' ? ['visitor', 'lead', 'user'] : (user_type == 'agents' ? ['agent', 'admin'] : ['bot']);
            for (var i = 0; i < this.messages.length; i++) {
                if (checks.includes(this.messages[i].get('user_type'))) {
                    this.messages[i].set('index', i);
                    results.push(this.messages[i]);
                }
            }
            return results;
        }

        updateMessage(id, message) {
            if (message instanceof SBMessage) {
                for (var i = 0; i < this.messages.length; i++) {
                    if (this.messages[i].id == id) {
                        this.messages[i] = message;
                        return true;
                    }
                }
            } else {
                SBF.error('Message not of type SBMessage', 'SBConversation.updateMessage');
            }
            return false;
        }

        addMessages(messages) {
            if (Array.isArray(messages)) {
                for (var i = 0; i < messages.length; i++) {
                    if (messages[i] instanceof SBMessage) {
                        this.messages.push(messages[i]);
                    }
                }
            } else {
                if (messages instanceof SBMessage) {
                    this.messages.push(messages);
                } else {
                    SBF.error('Messages not of type SBMessage', 'SBConversation.addMessages()');
                }
            }
            return this;
        }

        getCode(text_only = false) {
            let message = this.getLastMessage();
            if (message) {
                let text = message.message;
                if (!text && message.payload('preview')) {
                    text = message.payload('preview');
                }
                if (admin) {
                    text = message.payload().preview ? message.payload().preview : text;
                }
                text = text.replace(/(\r\n|\n|\r)/gm, ' ');
                if (text.indexOf('[') !== false) {
                    let shortcodes = text.match(/\[.+?\]/g) || [];
                    if (shortcodes.length) {
                        let shortcode = SBRichMessages.shortcode(shortcodes[0]);
                        if (shortcode[0]) {
                            text = text.replace(shortcodes[0], shortcode[0] == 'action' ? '' : sb_(shortcode[1].message ? shortcode[1].message : (shortcode[1].title ? shortcode[1].title : (shortcode[1].name && shortcode[1].name != 'false' && shortcode[1].name != 'true' ? shortcode[1].name : (shortcode[1].link ? shortcode[1].link : (shortcode[1].values ? shortcode[1].values.replaceAll(',', ', ').replaceAll('  ', ' ') : (shortcode[1].options ? shortcode[1].options.replaceAll(',', ', ').replaceAll('  ', ' ') : sb_(SBF.slugToString(shortcode[0])))))))));
                        }
                    }
                }
                if (!text && message.attachments.length) {
                    for (var i = 0; i < message.attachments.length; i++) {
                        text += message.attachments[i][0] + ' ';
                    }
                }
                text = SBF.strip(text);
                if (text.length > 114) {
                    text = text.substr(0, 114) + ' ...';
                }
                if (text_only) {
                    return text;
                }
                let title = this.get('title');
                if (!title || (activeUser() && activeUser().name == title) || (tickets && CHAT_SETTINGS.tickets_conversations_title_user)) {
                    title = activeUser() && message.get('user_id') == activeUser().id ? sb_('You') : message.get('full_name');
                }
                return `<div class="sb-conversation-item" data-user-id="${this.get('user_id')}"><img loading="lazy" src="${message.get('profile_image')}"><div><span class="sb-name">${title}</span><span class="sb-time">${SBF.beautifyTime(message.get('creation_time'))}</span></div><div class="sb-message">${text}</div></div>`;
            }
            return '';
        }

        deleteMessage(id) {
            for (var i = 0; i < this.messages.length; i++) {
                if (this.messages[i].id == id) {
                    this.messages.splice(i, 1);
                    return true;
                }
            }
            return false;
        }

        searchMessages(search, exact_match = false) {
            let results = [];
            for (var i = 0; i < this.messages.length; i++) {
                let message = this.messages[i].message;
                if ((exact_match && message == search) || (!exact_match && message.includes(search))) {
                    this.messages[i].set('index', i);
                    results.push(this.messages[i]);
                }
            }
            return results;
        }

        getAttachments() {
            let list = [];
            for (var i = 0; i < this.messages.length; i++) {
                let attachments = this.messages[i].attachments;
                for (var j = 0; j < attachments.length; j++) {
                    let link = attachments[j][1];
                    list.push([attachments[j][0], link, link.substr(link.lastIndexOf('.') + 1), this.messages[i].id]);
                }
            }
            return list;
        }

        updateMessagesStatus(ids = false) {
            if (ids) {
                for (var i = 0; i < this.messages.length; i++) {
                    let id = this.messages[i].id;
                    if (ids.includes(id)) {
                        let div = chat.find(`[data-id="${id}"] .sb-time`);
                        if (!div.find('i').length) {
                            div.append('<i class="sb-icon-check"></i>');
                        }
                    }
                }
            } else if (!admin && SBF.visibility_status == 'visible') {
                ids = [];
                for (var i = 0; i < this.messages.length; i++) {
                    let message = this.messages[i];
                    if (SBF.isAgent(message.get('user_type')) && message.get('status_code') != 2) {
                        ids.push(message.id);
                        message.set('status_code', 2);
                    }
                }
                if (ids.length) {
                    SBF.ajax({ function: 'update-messages-status', message_ids: ids });
                }
            }
        }
    }
    window.SBConversation = SBConversation;

    /* 
    * ----------------------------------------------------------
    * CHAT
    * ----------------------------------------------------------
    */

    var SBChat = {
        emoji_options: { range: 0, range_limit: 47, list: [], list_now: [], touch: false },
        initialized: false,
        editor_listening: false,
        conversation: false,
        is_busy: false,
        is_busy_update: false,
        is_busy_populate: false,
        chat_open: false,
        real_time: false,
        agent_id: -1,
        agent_online: false,
        user_online: false,
        expanded: false,
        main_header: true,
        start_header: false,
        desktop_notifications: false,
        flash_notifications: false,
        id_last_message: 0,
        id_last_message_conversation: 0,
        datetime_last_message_conversation: '2000-01-01 00:00:00',
        audio: false,
        audio_interval: false,
        tab_active: true,
        notifications: storage('notifications') ? storage('notifications') : [],
        typing_settings: { typing: false, sent: false, timeout: false },
        email_sent: false,
        dashboard: false,
        articles: false,
        articles_allowed_ids: false,
        articles_category: false,
        slack_channel: [-1, -1],
        skip: false,
        queue_interval: false,
        departments: false,
        default_department: null,
        default_agent: null,
        default_tags: null,
        offline_message_set: false,
        label_date: false,
        label_date_show: false,

        // Send a message
        sendMessage: function (user_id = -1, message = '', attachments = [], onSuccess = false, payload = false, conversation_status_code = false) {
            let is_dialogflow_human_takeover = dialogflow_human_takeover && SBApps.dialogflow.active();
            let is_return = false;
            let conversation = this.conversation;
            let reply_id = chat_editor.find('> [data-reply]').attr('data-reply');

            // Check settings and contents
            if (!activeUser() && !admin) {
                this.addUserAndLogin(() => {
                    return this.sendMessage(user_id, message, attachments, onSuccess, payload);
                }, true);
                this.busy(true);
                return;
            }
            if (!conversation) {
                let last_conversation = admin ? false : activeUser().getLastConversation();
                if (last_conversation && force_action != 'new-conversation' && (!SBChat.default_department || SBChat.default_department == last_conversation.get('department')) && (!SBChat.default_agent || SBChat.default_agent == last_conversation.get('agent_id'))) {
                    this.openConversation(last_conversation.id);
                    this.setConversation(last_conversation);
                    force_action = false;
                } else {
                    this.newConversation(conversation_status_code, user_id, '', [], (admin && SB_ACTIVE_AGENT.department ? SB_ACTIVE_AGENT.department : null), null, () => {
                        return this.sendMessage(user_id, message, attachments, onSuccess, payload);
                    });
                    this.busy(true);
                    return;
                }
            }
            this.calculateLabelDateFirst();
            if (user_id == -1) {
                user_id = admin ? SB_ACTIVE_AGENT.id : activeUser().id;
            }
            let is_user = user_id != bot_id;
            if (!message && !attachments.length) {
                message = chat_textarea.val().trim();
                chat_editor.find('.sb-attachments > div').each(function () {
                    let attachment = [$(this).attr('data-name'), $(this).attr('data-value')];
                    if ($(this).attr('data-size')) {
                        attachment.push($(this).attr('data-size'));
                    }
                    attachments.push(attachment);
                });
                if (admin && SBAdmin.must_translate && message) {
                    SBApps.dialogflow.translate([message], activeUser().language, (response) => {
                        if (response.length) {
                            let language = admin ? SB_ADMIN_SETTINGS.active_agent_language : activeUser().language;
                            if (payload) {
                                payload['original-message'] = message;
                                payload['original-message-language'] = language;
                            } else {
                                payload = { 'original-message': message, 'original-message-language': language };
                            }
                            if (response[0]) {
                                message = response[0];
                            }
                        }
                        this.sendMessage(user_id, message, attachments, onSuccess, payload, conversation_status_code);
                    });
                    is_return = true;
                }
            }
            this.busy(true);
            if (is_user) {
                chat_textarea.val('').css('height', '');
                chat_editor.find('.sb-attachments').html('');
            }
            chat_editor.sbActive(false);
            if (is_return) {
                return;
            }
            if (conversation_status_code === false && user_id == bot_id) {
                conversation_status_code = 'skip';
            }
            if (!admin && is_user && !is_dialogflow_human_takeover) {
                conversation_status_code = 2;
            }
            if (reply_id) {
                if (payload) {
                    payload.reply = message;
                } else {
                    payload = { reply: reply_id };
                }
            }

            // Send message
            if (message || attachments.length || payload) {
                let message_response = { user_id: user_id, user: activeUser(), conversation_id: conversation.id, conversation: conversation, conversation_status_code: conversation_status_code, attachments: attachments };
                SBF.ajax({
                    function: 'send-message',
                    user_id: user_id,
                    conversation_id: conversation.id,
                    message: message,
                    attachments: attachments,
                    conversation_status_code: conversation_status_code,
                    queue: !admin && CHAT_SETTINGS.queue && is_user,
                    payload: payload,
                    recipient_id: admin ? activeUser().id : false
                }, (response) => {
                    let send_slack = admin || !is_dialogflow_human_takeover || response.human_takeover_active

                    // Update the dashboard conversations area
                    if (!admin && user_id == bot_id) {
                        if (this.dashboard) {
                            this.updateConversations();
                        } else if (!this.chat_open) {
                            this.updateNotifications(conversation.id, response.id);
                        }
                    }

                    // Update the chat current conversation
                    if ((admin && !this.user_online) || (!admin && !this.agent_online)) {
                        this.update();
                    }

                    // Follow up and offline messages
                    if (!admin && is_user && !dialogflow_human_takeover) {
                        this.followUp();
                        this.offlineMessage();
                    }

                    // Dialogflow
                    if (!admin && is_user && (!payload || (payload.id != 'sb-human-takeover' && SBF.null(payload['skip-dialogflow'])))) {
                        SBApps.dialogflow.message(message, attachments);
                    }

                    // Slack and visitor to lead
                    if (!admin && is_user && activeUser().type == 'visitor') {
                        SBF.ajax({ function: 'update-user-to-lead', user_id: user_id }, () => {
                            activeUser().set('user_type', 'lead');
                            if (CHAT_SETTINGS.slack_active && send_slack) {
                                this.slackMessage(user_id, activeUser().name, activeUser().image, message, attachments);
                            }
                        });
                    } else if (send_slack && !this.skip) {
                        if (admin && SB_ADMIN_SETTINGS.slack_active) {
                            this.slackMessage(activeUser().id, SB_ACTIVE_AGENT.full_name, SB_ACTIVE_AGENT.profile_image, message, attachments);
                        } else if (CHAT_SETTINGS.slack_active) {
                            this.slackMessage(activeUser().id, (is_user ? activeUser().name : CHAT_SETTINGS.bot_name), (is_user ? activeUser().image : CHAT_SETTINGS.bot_image), message, attachments);
                        }
                    }

                    // Language detection
                    if (is_user && CHAT_SETTINGS.language_detection && conversation && message.split(' ').length && message.length > 3 && !SBF.storage('language-detection-completed')) {
                        SBF.ajax({ function: 'google-language-detection-update-user', user_id: user_id, string: message, token: SBApps.dialogflow.token }, (response) => {
                            if (response) {
                                CHAT_SETTINGS.translations = response;
                            }
                        });
                        SBF.storage('language-detection-completed', true);
                    }

                    // Articles
                    if (this.articles && !admin && CHAT_SETTINGS.articles && !CHAT_SETTINGS.office_hours && !this.isInitDashboard()) {
                        setTimeout(() => {
                            if (this.conversation && conversation.id == this.conversation.id) {
                                this.sendMessage(bot_id, '[articles]');
                                this.scrollBottom();
                                this.articles = false;
                            }
                        }, 5000);
                    }

                    // Queue
                    if (response.queue) {
                        this.queue(this.conversation.id);
                    }

                    // Events
                    message_response.message = response.message;
                    message_response.message_id = response.id;
                    SBF.event('SBMessageSent', message_response);
                    if (tickets) {
                        SBTickets.onMessageSent();
                    }
                    if (onSuccess) {
                        onSuccess(message_response);
                    }
                    if (response.notifications.length) {
                        SBF.event('SBNotificationsSent', response.notifications);
                    }

                    // Miscellaneous
                    if (this.skip) {
                        this.skip = false;
                    }
                    this.busy(false);
                });

                // Display the message as sending in progress
                if (is_user) {
                    message = SBF.escape(message);
                    chat.append((new SBMessage({ id: 'sending', profile_image: (admin ? SB_ACTIVE_AGENT.profile_image : activeUser().image), full_name: admin ? SB_ACTIVE_AGENT.full_name : activeUser().name, creation_time: '0000-00-00 00:00:00', message: message.replaceAll('<', '&lt;'), user_type: (admin ? 'agent' : 'user') })).getCode().replace('<div class="sb-time"></div>', `<div class="sb-time">${sb_('Sending')}<i></i></div>`));
                }
                if (!this.dashboard && (is_user || this.isBottom())) {
                    this.scrollBottom();
                }
            } else {
                this.busy(false);
            }
        },

        // Update message
        updateMessage: function (message_id, message = '') {
            SBF.ajax({
                function: 'update-message',
                message_id: message_id,
                message: message
            });
        },

        // Email notifications
        sendEmail: function (message, attachments, send_to_active_user = false, onSuccess = false) {
            let recipient_id = send_to_active_user ? (send_to_active_user === true ? activeUser().id : send_to_active_user) : this.getRecipientUserID();
            if (!admin && !isNaN(recipient_id) && this.agent_online) {
                return false;
            }
            SBF.ajax({
                function: 'create-email',
                recipient_id: recipient_id,
                sender_name: admin ? (send_to_active_user ? SB_ACTIVE_AGENT.full_name : activeUser().name) : (send_to_active_user ? CHAT_SETTINGS.bot_name : activeUser().name),
                sender_profile_image: admin ? (send_to_active_user ? SB_ACTIVE_AGENT.profile_image : activeUser().name) : (send_to_active_user ? CHAT_SETTINGS.bot_image : activeUser().image),
                message: message,
                attachments: attachments,
                department: this.conversation ? this.conversation.get('department') : false,
                conversation_id: this.conversation ? this.conversation.id : false
            }, (response) => {
                if (onSuccess) onSuccess(response);
            });
        },

        // SMS notifications
        sendSMS: function (message) {
            let recipient_id = this.getRecipientUserID();
            if (!admin && !isNaN(recipient_id) && this.agent_online) return false;
            SBF.ajax({
                function: 'send-sms',
                to: recipient_id,
                message: message,
                conversation_id: this.conversation ? this.conversation.id : false
            }, (response) => {
                if (response.status == 'sent' || response.status == 'queued') {
                    SBF.event('SBSMSSent', { recipient_id: this.getRecipientUserID(), message: message, response: response });
                } else if (response.message) {
                    SBF.error(response.message, 'SBChat.sendSMS');
                }
            });
        },

        // Desktop notifications
        desktopNotification: function (title, message, icon, conversation_id = false, user_id = false) {
            if (Notification.permission !== 'granted') {
                Notification.requestPermission();
            } else {
                let notify = SBF.serviceWorker.sw.showNotification(title, {
                    body: SBF.strip(message),
                    icon: icon.indexOf('user.svg') > 0 ? CHAT_SETTINGS.notifications_icon : icon
                });
                notify.onclick = () => {
                    if (admin) {
                        if (conversation_id) {
                            SBAdmin.conversations.openConversation(conversation_id, user_id == false ? activeUser().id : user_id);
                            SBAdmin.conversations.update();
                        } else if (user_id) {
                            SBAdmin.profile.show(user_id);
                        }
                    } else {
                        this.start();
                    }
                    window.focus();
                }
            }
        },

        // Returns the recipient user ID 
        getRecipientUserID: function () {
            return admin ? activeUser().id : (this.lastAgent(false) ? this.lastAgent(false).user_id : (SBF.null(this.conversation.get('agent_id')) ? (SBF.null(this.conversation.get('department')) ? 'agents' : 'department-' + this.conversation.get('department')) : this.conversation.get('agent_id')));
        },

        // Editor submit message
        submit: function () {
            if (!this.is_busy) {
                if (audio_recorder_dom && audio_recorder_dom.sbActive()) {
                    let button = audio_recorder_dom.find('.sb-btn-mic');
                    audio_recorder_dom.sbActive(false);
                    if (button.hasClass('sb-icon-pause')) {
                        button.click();
                    }
                    setTimeout(() => {
                        let form = new FormData();
                        let source = this.conversation ? this.conversation.get('source') : false;
                        if (source == 'wa' || audio_recorder_chunks.length) {
                            form.append('file', new File([source == 'wa' ? SBAudioRecorder.blob() : new Blob(audio_recorder_chunks, { type: source == 'ig' ? 'audio/wav' : 'audio/mp3' })], 'voice_message.' + (source == 'ig' ? 'wav' : 'mp3')));
                            SBF.upload(form, (response) => {
                                SBChat.uploadResponse(response);
                                this.submit();
                            });
                        } else {
                            this.submit();
                        }
                        audio_recorder_dom.find('.sb-icon-close').click();
                    }, 100);
                    return;
                }
                this.sendMessage();
                if (CHAT_SETTINGS.cron_email_piping_active) {
                    setTimeout(() => {
                        SBF.ajax({ function: 'email-piping' });
                        CHAT_SETTINGS.cron_email_piping_active = true;
                    }, 60000);
                    CHAT_SETTINGS.cron_email_piping_active = false;
                }
                if (init_push_notifications) {
                    SBF.serviceWorker.initPushNotifications();
                }
                if (admin) {
                    SBAdmin.conversations.setStatus(1, false, true);
                }
                SBChat.cancelReply();
            }
        },

        // Initialize the chat
        initChat: function () {
            if (admin) return;
            SBF.getActiveUser(true, () => {
                let active = activeUser() !== false;
                let user_type = active ? activeUser().type : false;
                if (!tickets && CHAT_SETTINGS.popup && !storage('popup') && (!mobile || !CHAT_SETTINGS.popup_mobile_hidden)) {
                    this.popup();
                }
                SBChat.automations.runAll();
                if (!tickets && CHAT_SETTINGS.privacy && !CHAT_SETTINGS.registration_required && !storage('privacy-approved')) {
                    this.privacy();
                    return;
                }
                if (typeof Notification !== ND && !CHAT_SETTINGS.push_notifications_users && (['all', 'users'].includes(CHAT_SETTINGS.desktop_notifications) || (admin && CHAT_SETTINGS.desktop_notifications == 'agents'))) {
                    this.desktop_notifications = true;
                }
                if (['all', 'users'].includes(CHAT_SETTINGS.flash_notifications) || (admin && CHAT_SETTINGS.flash_notifications == 'agents')) {
                    this.flash_notifications = true;
                }
                if (this.registration(true) && !tickets) {
                    this.registration();
                    if (!active && CHAT_SETTINGS.visitors_registration) {
                        this.addUserAndLogin();
                    }
                    return;
                }
                if (!active && (typeof SB_WP_WAITING_LIST !== ND || CHAT_SETTINGS.visitors_registration || CHAT_SETTINGS.welcome || tickets || CHAT_SETTINGS.flow_on_load) && (!tickets || !CHAT_SETTINGS.tickets_registration_required)) {
                    this.addUserAndLogin(() => {
                        this.welcome();
                        SBApps.dialogflow.flowOnLoad();
                        SBApps.woocommerce.waitingList();
                        this.finalizeInit();
                    });
                } else if (!this.conversation && active) {
                    this.populateConversations();
                } else {
                    this.finalizeInit();
                }
                if (CHAT_SETTINGS.header_name && active && user_type == 'user' && !tickets) {
                    chat_header.find('.sb-title').html(`${sb_('Hello')} ${activeUser().nameBeautified}!`);
                }
                this.welcome();
                if (!SBPusher.active) {
                    setInterval(() => {
                        this.updateConversations();
                        this.updateUsersActivity();
                    }, 10200);
                }
                SBApps.dialogflow.flowOnLoad();
                SBApps.woocommerce.waitingList();
                this.scrollBottom(true);
            });
        },

        finalizeInit: function () {
            if (!this.initialized) {
                main.attr('style', '');
                if (!admin && !tickets) {
                    if (this.isInitDashboard()) {
                        this.showDashboard();
                    }
                    if (!mobile && window.innerHeight < 760) {
                        main.find(' > .sb-body').css('max-height', (window.innerHeight - 130) + 'px');
                    }
                }
                this.initialized = true;
                if (!admin) {
                    if (activeUser() && !this.registration(true)) {
                        if (storage('open-conversation')) {
                            this.openConversation(storage('open-conversation'));
                        }
                        if (SBF.getURL('conversation')) {
                            this.openConversation(SBF.getURL('conversation'));
                        }
                    }
                    if (!this.chat_open && ((!mobile && storage('chat-open')) || SBF.getURL('chat') == 'open') || SBF.getURL('conversation')) {
                        setTimeout(() => { this.start(); }, 500);
                    }
                    if (CHAT_SETTINGS.woocommerce_returning_visitor) {
                        if (storage('returning-visitor') === false) {
                            SBF.storageTime('returning-visitor');
                        } else if (SBF.storageTime('returning-visitor', 24) && !storage('returning-visitor-processed')) {
                            setTimeout(() => {
                                SBF.ajax({
                                    function: 'woocommerce-returning-visitor'
                                }, () => {
                                    storage('returning-visitor-processed', true);
                                });
                            }, 15000);
                        }
                    }
                    if (CHAT_SETTINGS.timetable_type) {
                        SBChat.offlineMessage();
                    }
                    if (CHAT_SETTINGS.queue_human_takeover && SBApps.dialogflow.humanTakeoverActive()) {
                        CHAT_SETTINGS.queue = true;
                    }
                    $(window).on('resize', function () {
                        if (!mobile && window.innerHeight < 760) {
                            main.find(' > .sb-body').css('max-height', (window.innerHeight - 130) + 'px');
                        }
                    });
                    SBApps.dialogflow.flowOnLoad();
                }
                if (tickets) {
                    SBTickets.init();
                }
                SBF.event('SBInit');
            }
        },

        // Initialize the chat settings and open the chat
        start: function () {
            if (this.initialized) {
                this.populate();
                this.headerAgent();
                this.updateUsersActivity();
                this.startRealTime();
                this.popup(true);
                if (this.conversation) {
                    this.updateNotifications(this.conversation.id);
                }
                main.sbActive(true);
                $('body').addClass('sb-chat-open');
                this.chat_open = true;
                if (CHAT_SETTINGS.welcome_trigger == 'open' && !this.registration(true)) {
                    this.welcome();
                }
                SBApps.martfury.privateChat();
                this.calculateLabelDates();
            }
        },

        // Open or close the chat
        open: function (open = true) {
            if (open && !this.chat_open) {
                this.start();
                this.chat_open = true;
                this.startRealTime();
                main.sbActive(true);
                $('body').addClass('sb-chat-open');
                storage('chat-open', true);
                if (this.conversation) {
                    storage('last-open-message', this.conversation.getLastMessage().id);
                }
                if (mobile) {
                    history.pushState({ 'chat-open': true }, '', '');
                }
                SBF.event('SBChatOpen');
            } else if (!open && this.chat_open) {
                main.sbActive(false);
                this.stopRealTime();
                this.chat_open = false;
                storage('chat-open', false);
                $('body').removeClass('sb-chat-open');
                SBF.event('SBChatClose');
            }
        },

        // Get a full conversation and display it in the chat
        openConversation: function (conversation_id) {
            activeUser().getFullConversation(conversation_id, (response) => {
                if (!response.id || !SBChat.isConversationAllowed(response.get('source'), response.status_code)) {
                    storage('open-conversation', '');
                    return false;
                }
                this.setConversation(response);
                this.hideDashboard();
                this.populate();
                this.main_header = false;
                if (storage('chat-open')) {
                    SBChat.open();
                }
                if (storage('queue') == conversation_id) {
                    this.queue(conversation_id);
                }
                if (this.chat_open || tickets) {
                    this.updateNotifications(conversation_id);
                }
                if (tickets) {
                    SBTickets.activateConversation(response);
                }
                storage('open-conversation', conversation_id);
                SBF.event('SBConversationOpen', response);
            });
        },

        // Update the active conversation with the latest messages
        update: function () {
            if (this.conversation) {
                if (this.is_busy_update) return;
                let last_message = this.conversation.getLastMessage();
                let is_update = false;
                SBF.ajax({
                    function: 'get-new-messages',
                    conversation_id: this.conversation.id,
                    datetime: this.datetime_last_message_conversation,
                    last_id: this.id_last_message_conversation
                }, (response) => {
                    let count = response.length;
                    this.is_busy_update = false;
                    if (this.conversation) {
                        if (Array.isArray(response) && count > 0 && (!last_message || last_message.id != response[count - 1].id || last_message.message != response[count - 1].message || last_message.payload != response[count - 1].payload || last_message.attachments != response[count - 1].attachments)) {
                            let code = '';
                            let messages = [];
                            let id_check = [];
                            let dialogflow_activation = false;

                            // Generate and add the new messages
                            this.calculateLabelDateFirst();
                            for (var i = 0; i < count; i++) {
                                if (!id_check.includes(response[i].id) && (!admin || this.conversation.id == response[i].conversation_id)) {
                                    let message = new SBMessage(response[i]);
                                    let payload = message.payload();
                                    this.id_last_message_conversation = message.id;
                                    this.datetime_last_message_conversation = message.get('creation_time');

                                    // Payload
                                    if (payload.event) {
                                        let event = payload.event;
                                        if ((event == 'delete-message' && this.conversation.getMessage(message.id) !== false) || (!admin && !message.message && !message.attachments.length && !payload)) {
                                            this.deleteMessage(message.id);
                                        }
                                        if (event == 'woocommerce-update-cart' && !admin) {
                                            SBApps.woocommerce.updateCart(payload.action, payload.id);
                                        }
                                        if (event == 'woocommerce-checkout' && !admin) {
                                            SBApps.wordpress.ajax('url', { url_name: 'checkout' }, (response) => {
                                                setTimeout(() => document.location = response, 500);
                                            });
                                        }
                                        if (!SBApps.dialogflow.active() && (event == 'conversation-status-update-3' || event == 'conversation-status-update-4' || event == 'activate-bot')) {
                                            SBApps.dialogflow.active('activate');
                                            dialogflow_activation = true;
                                        }
                                        if (event == 'conversation-status-update-3') {
                                            this.conversationArchived();
                                        }
                                    }
                                    if (payload['human-takeover'] && CHAT_SETTINGS.queue_human_takeover) {
                                        CHAT_SETTINGS.queue = true;
                                        SBChat.queue(SBChat.conversation.id);
                                    }
                                    if (payload['human-takeover-fallback']) {
                                        SBApps.dialogflow.typing_enabled = false;
                                    }

                                    // Message
                                    if (this.conversation.getMessage(response[i].id)) {
                                        this.conversation.updateMessage(message.id, message);
                                        chat.find(`[data-id="${message.id}"]`).replaceWith(message.getCode());
                                        is_update = true;
                                    } else {
                                        if (message.message || message.attachments.length) {
                                            chat.find(`[data-id="sending"]`).remove();
                                        }
                                        if (this.conversation.id == response[i].conversation_id) {
                                            this.conversation.addMessages(message);
                                            code += message.getCode();
                                            is_update = false;
                                        }
                                    }
                                    this.conversation.updateMessagesStatus();
                                    messages.push(message);
                                    id_check.push(message.id);
                                    if (this.chat_open) {
                                        storage('last-open-message', message.id);
                                    }
                                    if (!admin && ((this.dashboard || !this.chat_open || !this.tab_active) && (message.get('user_id') != activeUser().id) && (message.message || message.attachments.length))) {
                                        this.updateNotifications(this.conversation.id, message.id);
                                    }
                                }
                            }
                            chat.append(code);

                            // Update status code
                            let last_message = this.conversation.getLastMessage();
                            let user_type = last_message ? last_message.get('user_type') : false;
                            let is_agent = SBF.isAgent(user_type);
                            let is_agent_human = is_agent && user_type != 'bot';
                            if (!admin && is_agent_human) {
                                if (this.chat_open) {
                                    if (last_message && !last_message.message.includes('sb-rich-success') && (!response[0].payload || !response[0].payload.includes('conversation-status-update'))) {
                                        this.setConversationStatus(0);
                                    }
                                    if (CHAT_SETTINGS.follow) {
                                        clearTimeout(timeout);
                                    }
                                }
                                if (!dialogflow_activation) {
                                    SBApps.dialogflow.active(false);
                                }
                            }

                            // Queue
                            if (storage('queue') == this.conversation.id && is_agent_human) {
                                this.queue('clear');
                            }

                            // Flash notifications
                            if (messages.length && (!(SBF.null(messages[0].message) && SBF.null(messages[0].attachments)) || count != 1)) {
                                if (!admin && !this.tab_active) {
                                    this.flashNotification();
                                }

                                // Sound notifications
                                if (this.audio && ((!admin && is_agent) || (admin && !is_agent))) {
                                    this.playSound();
                                }
                            }

                            // Miscellaneous
                            this.headerAgent();
                            if (!is_update && !this.dashboard) {
                                this.scrollBottom();
                                setTimeout(() => { this.scrollBottom() }, 300);
                            }
                            if (CHAT_SETTINGS.auto_open && (this.dashboard || !this.chat_open)) {
                                this.open();
                            }
                            if (is_agent_human) {
                                this.typing(-1, 'stop');
                            }
                            this.busy(false);
                            SBF.event('SBNewMessagesReceived', { messages: messages, conversation_id: this.conversation.id });
                            if (tickets) {
                                SBTickets.onNewMessageReceived(messages[0], this.conversation.id);
                            }
                        }
                    }
                });
                this.is_busy_update = true;
                setTimeout(() => { this.is_busy_update = false }, 5000);
            } else {
                this.updateConversations();
            }
        },

        // Update the user conversations list with the latest conversations and messages
        updateConversations: function () {
            if (activeUser()) {
                SBF.ajax({
                    function: 'get-new-user-conversations',
                    datetime: this.id_last_message
                }, (response) => {
                    if (response.length) {
                        this.id_last_message = response[0].message_id;
                        if (this.chat_open) {
                            storage('last-open-message', this.id_last_message);
                        }
                        for (var i = 0; i < response.length; i++) {
                            let status_code = response[i].conversation_status_code;
                            if (!SBChat.isConversationAllowed(response[i].source, status_code)) {
                                continue;
                            }
                            let conversation_id = response[i].conversation_id;
                            let message = new SBMessage(response[i]);
                            let conversation = new SBConversation([message], response[i]);
                            let is_new = activeUser().addConversation(conversation);

                            // Red notifications
                            if (response[i].message_user_id != activeUser().id && (this.conversation.id != conversation_id || !this.chat_open) && (message.message || message.attachments.length)) {
                                this.updateNotifications(conversation_id, message.id);
                                if (CHAT_SETTINGS.auto_open) {
                                    this.open();
                                }
                            }

                            // Payload
                            let payload = message.payload();
                            if (typeof payload !== 'boolean' && payload.event) {
                                let event = payload.event;
                                if (event == 'open-chat') {
                                    if (this.conversation.id != conversation_id || this.dashboard) {
                                        this.openConversation(conversation_id);
                                    }
                                    if (!mobile) {
                                        setTimeout(() => { this.open() }, 500);
                                    }
                                }
                                if (!message.message && !message.attachments.length) {
                                    continue;
                                }
                            }

                            if (!this.tab_active) {

                                // Desktop notifications
                                if (this.desktop_notifications) {
                                    SBChat.desktopNotification(message.get('full_name'), message.message, message.get('profile_image'));
                                }

                                // Flash notifications
                                if (this.flash_notifications) {
                                    this.flashNotification();
                                }

                                // Sound notifications
                                if (!admin && this.audio && CHAT_SETTINGS.sound && (!this.chat_open || this.dashboard || this.conversation.id != conversation_id) && !(SBF.null(message.message) && SBF.null(message.attachments))) {
                                    this.playSound();
                                }
                            }
                            if (is_new) {
                                SBF.event('SBNewConversationReceived', conversation);
                            }
                            if (tickets) {
                                SBTickets.onConversationReceived(conversation);
                            }
                            if (!this.conversation && is_new) {
                                this.openConversation(conversation.id);
                            }
                        }
                        if (this.conversation) {
                            this.conversation.updateMessagesStatus();
                        }
                        main.find('.sb-user-conversations').html(activeUser().getConversationsCode());
                        main.find('.sb-dashboard-conversations').setClass('sb-conversations-hidden', main.find('.sb-user-conversations > li').length > 3);
                    }
                });
            }
        },

        // Generate the conversation code and display it
        populate: function () {
            if (this.conversation) {
                let code = '';
                let notify = chat.find(' > .sb-notify-message');
                let last_date = false;
                let conversation_id = this.conversation.id;
                for (var i = 0; i < this.conversation.messages.length; i++) {
                    let message = this.conversation.messages[i];
                    let current_date = SBF.beautifyTime(message.get('creation_time'));
                    if (current_date.includes('today')) {
                        current_date = `<span>${sb_('Today')}</span>`;
                    }
                    if (current_date != last_date && (message.message || message.attachments.length)) {
                        code += `<div class="sb-label-date">${current_date}</div>`;
                        last_date = current_date;
                    }
                    code += message.getCode();
                }
                chat.html((notify.length ? notify[0].outerHTML : '') + code);
                if (!this.dashboard) {
                    this.scrollBottom();
                    this.calculateLabelDates();
                    if ((admin && SB_ADMIN_SETTINGS.notify_email_cron) || (!admin && CHAT_SETTINGS.notify_email_cron)) {
                        let last_message = this.conversation.getLastUserMessage(false, !admin);
                        if (last_message && last_message.id != storage('email-cron-' + conversation_id)) {
                            SBF.ajax({ function: 'remove-email-cron', conversation_id: conversation_id });
                            storage('email-cron-' + conversation_id, last_message.id);
                        }
                    }
                }
            } else if (activeUser() && !activeUser().isConversationsEmpty()) {
                if (CHAT_SETTINGS.disable_dashboard) {
                    this.openConversation(activeUser().conversations[0].id);
                } else {
                    this.showDashboard();
                }
            }
        },

        // Populate the dashboard with all conversations
        populateConversations: function (onSuccess = false) {
            if (!this.is_busy_populate && activeUser()) {
                this.is_busy_populate = true;
                setTimeout(() => { this.is_busy_populate = false }, 5000);
                activeUser().getConversations((response) => {
                    let count = response.length;
                    let converstion_ids = [];
                    if (count) {
                        let now = Date.now();
                        let last_message = response[0].messages[0];
                        this.id_last_message = last_message.id;
                        for (var i = 0; i < count; i++) {
                            converstion_ids.push(response[i].id);
                            if (!tickets && (response[i].status_code == 1 && storage('last-open-message') < last_message.id) && (!this.conversation || this.conversation.id != response[i].id)) {
                                this.updateNotifications(response[i].id, last_message.id);
                            }
                            if (!mobile && (now - SBF.UTC(response[i].messages[0].get('creation_time'))) < 6000) {
                                this.open();
                            }
                        }
                        main.find('.sb-user-conversations').html(activeUser().getConversationsCode());
                        main.find('.sb-dashboard-conversations').setClass('sb-conversations-hidden', main.find('.sb-user-conversations > li').length > 3);
                    }
                    main.setClass('sb-no-conversations', !count);
                    if ((!this.initialized || force_action == 'open-conversation') && count == 1 && !this.isInitDashboard() && !storage('open-conversation')) {
                        this.openConversation(activeUser().getLastConversation().id);
                        if (force_action == 'open-conversation') {
                            force_action = '';
                        }
                    }
                    for (var i = 0; i < SBChat.notifications.length; i++) {
                        this.updateNotifications(SBChat.notifications[i][0], converstion_ids.includes(SBChat.notifications[i][0]) ? SBChat.notifications[i][1] : false);
                    }
                    if (onSuccess) {
                        onSuccess(response);
                    }
                    this.finalizeInit();
                    SBF.event('SBPopulateConversations', { conversations: response });
                    showInitials('sb-user-details', 'sb-profile');
                });
            }
        },

        // Create a new conversation and optionally send the first message
        newConversation: function (status_code, user_id = - 1, message = '', attachments = [], department = null, agent_id = null, onSuccess = false) {
            if (activeUser()) {
                SBF.ajax({
                    function: 'new-conversation',
                    status_code: status_code,
                    title: tickets ? main.find('.sb-ticket-title input').val() : null,
                    department: SBF.null(department) ? this.default_department : department,
                    agent_id: SBF.null(agent_id) ? this.default_agent : agent_id,
                    tags: this.default_tags,
                    source: tickets ? 'tk' : ''
                }, (response) => {
                    if (SBF.errorValidation(response, 'user-not-found')) {
                        this.addUserAndLogin(() => {
                            this.newConversation(status_code, user_id, message, attachments, department, agent_id, onSuccess);
                        });
                        return;
                    }
                    let conversation = new SBConversation([], response.details);
                    this.setConversation(conversation);
                    if (message || attachments.length) {
                        this.sendMessage(user_id, message, attachments);
                    }
                    if (user_id != bot_id) {
                        setTimeout(() => { this.queue(conversation.id) }, 1000);
                    }
                    activeUser().conversations.push(conversation);
                    if (onSuccess) {
                        onSuccess(conversation);
                    }
                });

            } else {
                SBF.error('activeUser() not setted', 'SBChat.newConversation');
            }
        },

        // Set an existing conversation as active conversation
        setConversation: function (conversation) {
            if (conversation instanceof SBConversation) {
                let conversations = activeUser().conversations;
                this.conversation = conversation;
                this.id_last_message_conversation = !this.conversation.getLastMessage() ? 0 : this.conversation.getLastMessage().id;
                this.datetime_last_message_conversation = this.conversation.getLastMessage() == false ? '2000-01-01 00:00:00' : this.conversation.getLastMessage().get('creation_time');
                if (conversation.id != this.conversation.id) {
                    this.queue(conversation.id);
                }
                for (var i = 0; i < conversations.length; i++) {
                    if (conversations[i].id == conversation.id) {
                        conversations[i] = conversation;
                        break;
                    }
                }
                storage('open-conversation', conversation.id);
                SBApps.dialogflow.typing_enabled = true;
                SBF.event('SBActiveConversationChanged', conversation);
            } else {
                SBF.error('Value not of type SBConversation', 'SBChat.setConversation');
            }
        },

        // Manage all the queue functionalities
        queue: function (conversation_id) {
            if (conversation_id == 'clear') {
                main.removeClass('sb-notify-active sb-queue-active');
                chat.find(' > .sb-notify-message').remove();
                clearInterval(this.queue_interval);
                this.queue_interval = false;
                storage('queue', '');
                if (CHAT_SETTINGS.queue_sound && !SBChat.tab_active) {
                    SBChat.playSound(999);
                }
                return;
            }
            if (!admin && CHAT_SETTINGS.queue) {
                SBF.ajax({
                    function: 'queue',
                    conversation_id: conversation_id,
                    department: this.conversation.get('department')
                }, (response) => {
                    chat.find(' > .sb-notify-message').remove();
                    let position = response[0];
                    if (position == 0) {
                        this.queue('clear');
                    } else {
                        let time = (!CHAT_SETTINGS.queue_response_time ? 5 : parseInt(CHAT_SETTINGS.queue_response_time)) * position;
                        let text = sb_(!CHAT_SETTINGS.queue_message ? 'Please wait for an agent. You are number {position} in the queue. Your waiting time is approximately {minutes} minutes.' : CHAT_SETTINGS.queue_message).replace('{position}', '<b>' + position + '</b>').replace('{minutes}', '<b>' + time + '</b>');
                        if (response[1]) {
                            chat.prepend(`<div class="sb-notify-message sb-rich-cnt"><div class="sb-cnt"><div class="sb-message">${text}</div></div></div>`);
                        }
                        if (this.queue_interval === false) {
                            this.queue_interval = setInterval(() => { this.queue(conversation_id) }, 10100);
                            if (response[1]) {
                                main.addClass('sb-notify-active sb-queue-active');
                            }
                            storage('queue', conversation_id);
                        }
                    }
                    SBF.event('SBQueueUpdate', position);
                });
            }
        },

        // Get the departments details and generate the department code
        getDepartmentCode(department_id, onSuccess) {
            if (this.departments) {
                if (department_id == 'all') {
                    let code = '';
                    for (var key in this.departments) {
                        this.getDepartmentCode(this.departments[key].id, (response) => { code += response; });
                    };
                    onSuccess(code);
                } else {
                    onSuccess(`<div data-color="${this.departments[department_id].color}">${this.departments[department_id].image ? `<img loading="lazy" src="${this.departments[department_id].image}" />` : ''}<div>${this.departments[department_id].name}<div></div>`);
                }
            } else {
                SBF.ajax({
                    function: 'get-departments'
                }, (response) => {
                    if (response) {
                        this.departments = response;
                        this.getDepartmentCode(department_id, onSuccess);
                    }
                });
            }
        },

        // Start and stop the real time check of new messages
        startRealTime: function () {
            if (SBPusher.active) return;
            this.stopRealTime();
            this.real_time = setInterval(() => {
                this.update();
                this.typing(admin ? (activeUser() ? activeUser().id : -1) : this.agent_id, 'check');
            }, 1000);
        },

        stopRealTime: function () {
            clearInterval(this.real_time);
        },

        // Check if the agent is online and set the online status of the active user
        updateUsersActivity: function () {
            if (activeUser()) {
                SBF.updateUsersActivity(activeUser().id, this.agent_id, (response) => {
                    if (!this.typing_settings.typing) {
                        if (response == 'online' || this.agent_id == bot_id) {
                            $(chat_status).addClass('sb-status-online').html(sb_('Online'));
                            this.agent_online = this.agent_id != bot_id;
                        } else {
                            $(chat_status).removeClass('sb-status-online').html(sb_('Away'));
                            this.agent_online = false;
                        }
                    }
                });
            }
        },

        // Show the loading icon and put the chat in busy mode
        busy: function (value) {
            if (chat_editor) {
                chat_editor.find('.sb-loader').sbActive(value);
            }
            this.is_busy = value;
            SBF.event('SBBusy', value);
        },

        // Manage the agent header
        headerAgent: function (is_default_chatbot = false) {
            if (!admin && !tickets && !this.dashboard && this.conversation && (this.agent_id == -1 || (this.conversation.getLastMessage() && SBF.isAgent(this.conversation.getLastMessage().get('user_type')) && this.conversation.getLastMessage().get('user_id') != this.agent_id))) {
                let agent = this.lastAgent(false);
                agent = agent && SBApps.dialogflow.humanTakeoverActive() && SBPusher.active && !SBPusher.presenceCheck({ info: { user_type: 'agent' }, id: agent.user_id }) ? agent : this.lastAgent();
                if (!agent && is_default_chatbot) {
                    agent = { user_id: CHAT_SETTINGS.bot_id, full_name: CHAT_SETTINGS.bot_name, profile_image: CHAT_SETTINGS.bot_image };
                }
                if (agent) {
                    this.agent_id = agent.user_id;
                    this.headerReset();
                    chat_header.addClass('sb-header-agent').attr('data-agent-id', this.agent_id).html(`<div class="sb-dashboard-btn sb-icon-arrow-left"></div><div class="sb-profile"><img loading="lazy" src="${agent['profile_image']}" data-name="${agent['full_name']}"/><div><span class="sb-name">${agent['full_name']}</span><span class="sb-status">${sb_('Away')}</span></div><i class="sb-icon sb-icon-close ${CHAT_SETTINGS.close_chat ? 'sb-close-chat' : 'sb-responsive-close-btn'}"></i></div><div class="sb-label-date-top"></div>`);
                    chat_status = chat_header.find('.sb-status');
                    this.updateUsersActivity();
                    this.label_date = chat_header.find('.sb-label-date-top');
                    if (SBF.storageTime('header-animation', 1)) {
                        this.headerAnimation();
                    }
                }
            }
        },

        headerReset: function () {
            if (this.start_header == false) {
                this.start_header = [chat_header.html(), chat_header.attr('class')];
            }
            chat_header.removeClass('sb-header-main sb-header-brand sb-header-agent sb-header-minimal');
            this.main_header = false;
        },

        headerAnimation: function () {
            chat_header.addClass('sb-header-animation');
            setTimeout(() => { chat_header.removeClass('sb-header-animation') }, 8000);
            SBF.storageTime('header-animation');
        },

        // Return the last agent of the active conversation
        lastAgent: function (bot = true) {
            let agent = false;
            if (this.conversation) {
                let message = this.conversation.getLastUserMessage(false, bot ? 'all' : true);
                if (message) {
                    agent = { user_id: message.get('user_id'), full_name: message.get('full_name'), profile_image: message.get('profile_image') };
                }
            }
            return agent;
        },

        // Scroll the chat to the bottom
        scrollBottom: function (top = false) {
            setTimeout(() => {
                chat_scroll_area.scrollTop(top ? 0 : chat_scroll_area[0].scrollHeight);
                this.scrollHeader();
            }, 20);
        },

        // Check if the chat is at bottom
        isBottom: function () {
            return chat_scroll_area[0].scrollTop === (chat_scroll_area[0].scrollHeight - chat_scroll_area[0].offsetHeight);
        },

        // Dashboard header animation
        scrollHeader: function () {
            if (this.main_header && this.dashboard) {
                let scroll = chat_scroll_area.scrollTop();
                if (scroll > -1 && scroll < 1000) {
                    chat_header.find('.sb-content').css({ 'opacity': (1 - (scroll / 500)), 'top': (scroll / 10 * -1) + 'px' });
                };
            }
        },

        // Display the dashboard area 
        showDashboard: function () {
            if (!admin && !tickets) {
                main.addClass('sb-dashboard-active');
                chat_header.removeClass('sb-header-agent');
                this.hidePanel()
                if (this.start_header) chat_header.html(this.start_header[0]).addClass(this.start_header[1]);
                chat_scroll_area.find(' > div').sbActive(false);
                main.find('.sb-dashboard').sbActive(true);
                this.populateConversations();
                this.conversation = false;
                this.agent_id = -1;
                this.stopRealTime();
                this.dashboard = true;
                this.main_header = true;
                this.scrollBottom(true);
                SBF.event('SBDashboard');
            }
        },

        // Hide the dashboard area
        hideDashboard: function () {
            if (!admin && !tickets) {
                chat.sbActive(true);
                main.removeClass('sb-dashboard-active').find('.sb-dashboard').sbActive(false);
                this.dashboard = false;
                this.headerAgent();
                this.scrollHeader(0);
                if (this.chat_open) {
                    this.startRealTime();
                }
                SBF.event('SBDashboardClosed');
            }
        },

        // Show a chat panel
        showPanel: function (name, title) {
            if (tickets) return SBTickets.showPanel(name, title);
            let panel = chat_scroll_area.find(' > .sb-panel-' + name);
            if (panel.length) {
                chat_scroll_area.find(' > div').sbActive(false);
                panel.sbActive(true);
                if (!this.start_header) this.start_header = [chat_header.html(), chat_header.attr('class')];
                chat_header.attr('class', 'sb-header sb-header-panel').html(`<svg class="sb-icon-close <?php echo $disable_dashboard ? 'sb-responsive-close-btn' : 'sb-dashboard-btn' ?> sb-dashboard-btn sb-icon-close"
                        style="right: unset; left: 10px; top: 15px; width: 26px; height: 26px;" width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg><span style="padding-left: 15px;">${sb_(title)}</span>`);
                main.addClass('sb-panel-active');
                this.dashboard = true;
            }
            SBF.event('SBPanelActive', name);
        },

        hidePanel: function () {
            main.removeClass('sb-panel-active');
            chat_header.removeClass('sb-header-panel');
        },

        // Clear the conversation area and the active conversation
        clear: function () {
            this.conversation = false;
            chat.html('');
        },

        // Update the red notification counter of the chat
        updateNotifications: function (conversation_id, message_id = false) {
            let check = false;
            if (message_id) {
                for (var i = 0; i < this.notifications.length; i++) {
                    if (this.notifications[i][0] == conversation_id && message_id == this.notifications[i][1]) {
                        check = true;
                    }
                }
                if (!check) {
                    this.notifications.push([conversation_id, message_id]);
                    if (!this.dashboard && this.conversation && this.conversation.id != conversation_id) {
                        this.headerAnimation();
                    }
                }
            } else {
                let active_notifications = [];
                for (var i = 0; i < this.notifications.length; i++) {
                    if (this.notifications[i][0] == conversation_id) {
                        check = true;
                    } else {
                        active_notifications.push(this.notifications[i]);
                    }
                }
                if (!admin && check && ['0', 0].includes(this.conversation.status_code)) {
                    this.setConversationStatus(1);
                }
                this.notifications = active_notifications;
            }
            let count = this.notifications.length;
            storage('notifications', this.notifications);
            main.find('.sb-chat-btn span').attr('data-count', count).html(count > -1 ? count : 0);
            SBF.event('SBNotificationsUpdate', { conversation_id: conversation_id, message_id: message_id });
        },

        // Set the active conversation status
        setConversationStatus: function (status_code) {
            if (this.conversation) {
                SBF.ajax({
                    function: 'update-conversation-status',
                    conversation_id: this.conversation.id,
                    status_code: status_code
                }, () => {
                    this.conversation.set('status_code', status_code);
                    SBF.event('SBActiveConversationStatusUpdated', { conversation_id: this.conversation.id, status_code: status_code });
                });
                return true;
            }
            return false;
        },

        // Typing status
        typing: function (user_id = -1, action = 'check') {
            if (this.conversation) {
                let valid = this.agent_online || (admin && this.user_online);
                if (action == 'check' && !SBPusher.active && user_id != -1 && user_id != bot_id && valid) {
                    SBF.ajax({
                        function: 'is-typing',
                        user_id: user_id,
                        conversation_id: this.conversation.id
                    }, (response) => {
                        if (response && !this.typing_settings.typing) {
                            this.typing(-1, 'start');
                        } else if (!response && this.typing_settings.typing) {
                            this.typing(-1, 'stop');
                        }
                    });
                } else if (action == 'set' && valid) {
                    let source = this.conversation.get('source');
                    clearTimeout(timeout_typing);
                    if (source) {
                        source = source == 'fb' ? [source, activeUser().getExtra('facebook-id').value, this.conversation.get('extra')] : (source == 'tw' ? [source, activeUser().getExtra('twitter-id').value] : false);
                    }
                    if (SBPusher.active) {
                        SBF.debounce(() => {
                            SBPusher.trigger('client-typing', { user_id: admin ? SB_ACTIVE_AGENT.id : activeUser().id, conversation_id: this.conversation.id });
                            if (source) {
                                SBF.ajax({ function: 'set-typing', source: source });
                            }
                        }, '#2');
                    } else {
                        if (!this.typing_settings.sent) {
                            this.typing_settings.sent = true;
                            SBF.ajax({
                                function: 'set-typing',
                                user_id: user_id,
                                conversation_id: this.conversation.id,
                                source: source
                            });
                            this.typing(user_id, 'set');
                        } else {
                            clearTimeout(this.typing_settings.timeout);
                            this.typing_settings.timeout = setTimeout(() => {
                                SBF.ajax({
                                    function: 'set-typing',
                                    user_id: user_id,
                                    conversation_id: -1
                                }, () => {
                                    this.typing_settings.sent = false;
                                });
                            }, 2000);
                        }
                    }
                } else if (action == 'start' || action == 'stop') {
                    let start = action == 'start';
                    if (!admin && chat_status) {
                        if (start) {
                            $(chat_status).addClass('sb-status-typing').html(sb_('Typing'));
                        } else {
                            let online = this.agent_online || this.agent_id == bot_id;
                            clearTimeout(timeout_typing);
                            $(chat_status).removeClass('sb-status-typing').html(sb_(online ? 'Online' : 'Away'));
                            if (online) {
                                $(chat_status).addClass('sb-status-online');
                            }
                        }
                    }
                    this.typing_settings.typing = start;
                    SBF.event('SBTyping', start);
                }
            }
        },

        // Articles
        showArticles: function (id = false, is_category = false) {
            let panel = tickets ? main.find('.sb-panel-main .sb-panel') : chat_scroll_area.find(' > .sb-panel-articles');
            panel.html('').sbLoading(true);
            this.showPanel('articles', CHAT_SETTINGS.articles_title ? CHAT_SETTINGS.articles_title : 'Help Center');
            if (!id && CHAT_SETTINGS.articles_categories) {
                this.getArticleCategories((categories) => {
                    this.showArticles_(categories, panel, { categories: categories });
                }, 'parent');
            } else {
                this.getArticles(is_category ? false : id, (articles) => {
                    if (id && !is_category) {
                        panel.html(this.getArticleCode(articles[0]));
                        panel.sbLoading(false);
                        SBF.event('SBArticles', { id: id, articles: articles });
                    } else {
                        this.showArticles_(articles, panel, { id: id, articles: articles });
                    }
                }, is_category ? id : false);
            }
        },

        showArticles_: function (items, panel, payload) {
            let code = '';
            let language = typeof SB_LANG != ND ? SB_LANG[0] : false;
            for (var i = 0; i < items.length; i++) {
                let is_article = 'content' in items[i];
                code += `<div data-id="${items[i].id}"${is_article ? '' : ' data-is-category="true"'}><div>${is_article ? items[i].title : (language && items[i].languages && items[i].languages[language] ? items[i].languages[language].title : items[i].title)}</div><span>${is_article ? items[i].content : (language && items[i].languages && items[i].languages[language] ? items[i].languages[language].description : (items[i].description ? items[i].description : ''))}</span></div>`;
            }
            panel.html(`<div class="sb-articles">${code}</div>`);
            panel.sbLoading(false);
            SBF.event('SBArticles', payload);
        },

        getArticles: function (id = false, onSuccess = false, category = false, count = false) {
            SBF.ajax({
                function: 'get-articles',
                categories: this.articles_category ? this.articles_category : category,
                id: id ? id : this.articles_allowed_ids,
                count: count,
                return_categories: this.articles_category ? true : false,
                full: id,
                skip_language: true
            }, (response) => {
                onSuccess(response);
            });
        },

        getArticleCategories: function (onSuccess = false, category_type = false) {
            SBF.ajax({
                function: 'get-articles-categories',
                category_type: category_type
            }, (response) => {
                onSuccess(response);
            });
        },

        searchArticles: function (search, button, target) {
            if (search) {
                $(button).sbLoading(true);
                SBF.ajax({
                    function: 'search-articles',
                    search: search
                }, (articles) => {
                    let code = '';
                    let count = articles.length;
                    if (count == 0) {
                        code += `<p class="sb-no-results">${sb_('No articles found.')}</p>`;
                    } else {
                        for (var i = 0; i < articles.length; i++) {
                            code += `<div data-id="${articles[i].id}"><div>${articles[i].title}</div><span>${articles[i].content}</span></div>`;
                        }
                    }
                    $(target).html(code);
                    $(button).sbLoading(false);
                });
            }
        },

        setArticleRating: function (article_id, rating, onSuccess = false) {
            SBF.ajax({
                function: 'article-ratings',
                article_id: article_id,
                rating: rating
            }, (response) => {
                if (onSuccess) onSuccess(response);
            });
        },

        articleRatingOnClick: function (button) {
            let article = $(button).closest('.sb-article');
            if (!article[0].hasAttribute('data-user-rating')) {
                $(button).parent().sbLoading();
                let rating = $(button).attr('data-rating') == 'positive' ? 1 : -1;
                let article_id = $(button).closest('.sb-article').attr('data-id');
                SBChat.setArticleRating(article_id, rating, () => {
                    SBF.storage('article-rating-' + article_id, rating);
                    article.attr('data-user-rating', rating);
                    $(button).parent().sbLoading(false);
                });
            }
        },

        getArticleCode: function (article) {
            let user_rating = SBF.storage('article-rating-' + article.id);
            let code = '';
            if (this.articles_categories && !SBF.null(article.categories)) {
                for (var i = 0; i < this.articles_categories.length; i++) {
                    let category_id = this.articles_categories[i].id;
                    if (article.categories.includes(category_id) || article.parent_category == category_id) {
                        code += `<span data-id="${category_id}">${sb_(this.articles_categories[i].title)}</span>`;
                    }
                }
            }
            return `<div data-id="${article.id}"${user_rating ? ` data-user-rating="${user_rating}"` : ''} class="sb-article"><div class="sb-title">${article.title}<div class="sb-close sb-icon-close"></div></div><div class="sb-content">${article.content.replace(/(?:\r\n|\r|\n)/g, '<br>')}</div>${article.link ? `<a href="${article.link}" target="_blank" class="sb-btn-text"><i class="sb-icon-plane"></i>${sb_('Read more')}</a>` : ''}${code ? `<div class="sb-article-category-links">${code}</div>` : ''}<div class="sb-rating"><span>${sb_('Rate and review')}</span><div><i data-rating="positive" class="sb-submit sb-icon-like"><span>${sb_('Helpful')}</span></i><i data-rating="negative" class="sb-submit sb-icon-dislike"><span>${sb_('Not helpful')}</span></i></div></div></div>`;
        },

        initArticlesPage: function () {
            let query_article_id = SBF.getURL('article_id');
            let query_category = SBF.getURL('category');
            let query_search = SBF.getURL('search');
            if (CHAT_SETTINGS.articles_url_rewrite) {
                let url_parts = location.href.replace(CHAT_SETTINGS.articles_url_rewrite, '').split('/');
                if (url_parts[url_parts.length - 2] == 'category') {
                    query_category = url_parts[url_parts.length - 1];
                }
                if ((url_parts.length == 2 && !url_parts[0] && url_parts[1]) || (url_parts.length == 1 && url_parts[0])) {
                    query_article_id = url_parts[url_parts.length - 1];
                }
                CHAT_SETTINGS.articles_page_url
            }
            articles_page = $('body').find('#sb-articles');
            if (!articles_page.length) {
                articles_page = $('body');
            }
            if (articles_page.sbLoading()) {
                let url = SB_URL + '/include/articles.php' + (query_category ? '?category=' + query_category : (query_article_id ? '?article_id=' + query_article_id : (query_search ? '?search=' + query_search : '')));
                if (cloud_data) {
                    url += (url.includes('?') ? '&' : '?') + 'cloud=' + cloud_data;
                }
                SBF.loadResource(SB_URL + '/css/articles.css');
                SBF.cors('GET', url, (html) => {
                    articles_page.html(html);
                    articles_page.sbLoading(false);
                });
            }
            articles_page.on('keydown', '.sb-panel-side input', function (e) {
                if (e.which == 13) {
                    $(this).next().click();
                }
            });

            articles_page.on('click', '.sb-articles > [data-id]', function () {
                cache = panel_main.html();
                panel_main.sbLoading(true);
                SBChat.getArticles($(this).attr('data-id'), (article) => {
                    panel_main.removeClass('sb-articles').html(SBChat.getArticleCode(article));
                    panel_main.sbLoading(false);
                });
            });

            articles_page.on('click', '.sb-article [data-rating]', function () {
                SBChat.articleRatingOnClick(this);
            });

            articles_page.on('click', '.sb-article .sb-title .sb-close', function () {
                articles_page.find('.sb-panel-main').addClass('sb-articles').html(cache);
            });

            articles_page.on('click', '.sb-submit-articles', function () {
                let search = $(this).parent().find('input').val();
                if (search) {
                    cache = panel_main.html();
                    panel_main.html('');
                    SBChat.searchArticles(search, this, panel_main);
                } else {
                    panel_main.html(cache);
                }
                panel_main.addClass('sb-articles');
            });

            articles_page.on('click', '.sb-article-categories [data-id]', function () {
                if (loading(panel_main)) return;
                let code = '';
                cache = panel_main.html();
                articles_page.find('.sb-article-categories [data-id]').sbActive(false);
                $(this).sbActive(true);
                SBChat.getArticles(-1, (articles) => {
                    for (var i = 0; i < articles.length; i++) {
                        code += `<div data-id="${articles[i].id}"><div>${articles[i].title}</div><span>${articles[i].content}</span></div>`;
                    }
                    panel_main.addClass('sb-articles').html(code ? code : `<p class="sb-no-results">${sb_('No articles found.')}</p>`);
                    panel_main.sbLoading(false);
                }, $(this).attr('data-id'));
            });
        },

        // Emoji
        categoryEmoji: function (category) {
            let list = this.emoji_options.list;
            if (category == 'all') {
                this.emoji_options.list_now = list;
            } else {
                this.emoji_options.list_now = [];
                for (var i = 0; i < list.length; i++) {
                    if (list[i].category.startsWith(category)) {
                        this.emoji_options.list_now.push(list[i]);
                    }
                }
            }
            this.emoji_options.range = 0;
            this.populateEmoji(0);
            this.populateEmojiBar();
        },

        mouseWheelEmoji: function (e) {
            let range = this.emoji_options.range;
            if (sbDelta(e) > 0 || (mobile && typeof e.originalEvent.changedTouches !== ND && this.emoji_options.touch < e.originalEvent.changedTouches[0].clientY)) {
                range -= (range < 1 ? 0 : 1);
            } else {
                range += (range > this.emoji_options.range_limit ? 0 : 1);
            }
            chat_emoji.find('.sb-emoji-bar > div').sbActive(false).eq(range).sbActive(true);
            this.emoji_options.range = range;
            this.populateEmoji(range);
            e.preventDefault();
        },

        insertEmoji: function (emoji) {
            if (emoji.indexOf('.svg') > 0) {
                emoji = $.parseHTML(emoji)[0].alt;
            }
            this.insertText(emoji);
            chat_emoji.sbTogglePopup();
        },

        showEmoji: function (button) {
            if (chat_emoji.sbTogglePopup(button)) {
                if (!admin) {
                    chat_emoji.css({ left: chat_editor.offset().left + (tickets ? 68 : 20), top: chat_editor.offset().top - window.scrollY - (tickets ? chat_editor.height() - 330 : 304) });
                }
                if (!chat_emoji.find('.sb-emoji-list > ul').html()) {
                    jQuery.ajax({
                        method: 'POST',
                        url: SB_AJAX_URL,
                        data: {
                            function: 'emoji',
                            'login-cookie': SBF.loginCookie()
                        }
                    }).done((response) => {
                        this.emoji_options.list = JSON.parse(response);
                        this.emoji_options.list_now = this.emoji_options.list;
                        this.populateEmoji(0);
                        this.populateEmojiBar();
                    });
                }
                SBF.deselectAll();
            }
        },

        populateEmoji: function (range) {
            let code = '';
            let per_page = mobile ? 42 : 48;
            let limit = range * per_page + per_page;
            let list_now = this.emoji_options.list_now;
            if (limit > list_now.length) limit = list_now.length;
            this.emoji_options.range_limit = list_now.length / per_page - 1;
            this.emoji_options.range = range;
            for (var i = (range * per_page); i < limit; i++) {
                code += `<li>${list_now[i].char}</li>`;
            }
            chat_emoji.find('.sb-emoji-list').html(`<ul>${code}</ul>`);
        },

        populateEmojiBar: function () {
            let code = '<div class="sb-active"></div>';
            let per_page = mobile ? 42 : 49;
            for (var i = 0; i < this.emoji_options.list_now.length / per_page - 1; i++) {
                code += '<div></div>';
            }
            this.emoji_options.range = 0;
            chat_emoji.find('.sb-emoji-bar').html(code);
        },

        clickEmojiBar: function (item) {
            let range = $(item).index();
            this.populateEmoji(range);
            this.emoji_options.range = range;
            chat_emoji.find('.sb-emoji-bar > div').sbActive(false).eq(range).sbActive(true);
        },

        searchEmoji: function (search) {
            SBF.search(search, () => {
                if (search.length > 1) {
                    let list = this.emoji_options.list;
                    let list_now = [];
                    for (var i = 0; i < list.length; i++) {
                        if (list[i].category.toLowerCase().includes(search) || list[i].name.toLowerCase().includes(search)) {
                            list_now.push(list[i]);
                        }
                    }
                    this.emoji_options.list_now = list_now;
                } else {
                    this.emoji_options.list_now = this.emoji_options.list;
                }
                this.emoji_options.range = 0;
                this.populateEmoji(0);
                this.populateEmojiBar();
            });
        },

        // Editor methods
        textareaChange: function (textarea) {
            let value = $(textarea).val();

            // Saved replies
            if (admin) {
                SBAdmin.conversations.savedReplies(textarea, value);
                SBAdmin.apps.openAI.rewriteButton(value);
            }

            // Typing
            if (value) {
                this.typing((admin && !SBPusher.active ? SB_ACTIVE_AGENT.id : activeUser().id), 'set');
            }
            chat_editor.sbActive(value);
        },

        insertText: function (text) {
            let textarea = $(chat_textarea.get(0));
            let index = 0;
            if (this.dashboard) return false;
            if (textarea.get(0).selectionStart) {
                index = textarea.get(0).selectionStart;
            } else if (document.selection) {
                textarea.focus();
                let selection = document.selection.createRange();
                var selection_length = document.selection.createRange().text.length;
                selection.moveStart('character', -textarea.value.length);
                index = selection.text.length - selection_length;
            }
            textarea.val(textarea.val().substr(0, index) + text + textarea.val().substr(index));
            textarea.focus();
            textarea.manualExpandTextarea();
            chat_editor.sbActive(true);
        },

        enabledAutoExpand: function () {
            if (chat_textarea.length) {
                chat_textarea.autoExpandTextarea();
            }
        },

        cancelReply: function () {
            chat_editor.find('[data-reply]').remove();
            chat.removeClass('sb-reply-active');
        },

        // Privacy message
        privacy: function () {
            SBF.ajax({
                function: 'get-block-setting',
                value: 'privacy'
            }, (response) => {
                chat_scroll_area.append(`<div class="sb-privacy sb-init-form" data-decline="${response.decline}"><div class="sb-title">${response.title}</div><div class="sb-text">${response.message.replace(/\n/g, '<br>')}</div>` + (response.link ? `<a target="_blank" href="${response.link}">${response['link-name']}</a>` : '') + `<div class="sb-buttons"><a class="sb-btn sb-approve">${response['btn-approve']}</a><a class="sb-btn sb-decline">${response['btn-decline']}</a></div></div>`);
                this.finalizeInit();
                SBF.event('SBPrivacy');
            });
            if (!this.dashboard) {
                this.showDashboard();
            }
            this.dashboard = true;
            main.addClass('sb-init-form-active');
        },

        // Popup message 
        popup: function (close = false, content = false) {
            if (close) {
                let popup = main.find('.sb-popup-message');
                let id = popup.attr('data-id');
                storage('popup' + (SBF.null(id) ? '' : id), true);
                popup.remove();
                return;
            }
            setTimeout(() => {
                if (!this.chat_open) {
                    if (content == false) {
                        content = CHAT_SETTINGS.popup;
                    }
                    main.find('.sb-popup-message').remove();
                    main.append(`<div data-id="${content.id ? content.id : ''}" class="sb-popup-message">` + (content.image ? `<img loading="lazy" src="${content.image}" />` : '') + (content.title ? `<div class="sb-top">${content.title}</div>` : '') + `<div class="sb-text">${content.message}</div><div class="sb-icon-close"></div></div>`);
                    SBF.event('SBPopup', content);
                }
            }, 1000);
        },

        // Follow up message
        followUp: function () {
            if (this.followUpCheck()) {
                timeout = setTimeout(() => {
                    if (this.followUpCheck()) {
                        SBF.ajax({
                            function: 'execute-bot-message',
                            conversation_id: this.conversation.id,
                            name: 'follow_up',
                            check: false
                        }, (response) => {
                            if (response.settings.sound && this.audio) {
                                this.audio.play();
                            }
                            this.skip = true;
                            SBF.storageTime('email');
                            SBF.event('SBFollowUp');
                        });
                    }
                }, CHAT_SETTINGS.follow === true ? (CHAT_SETTINGS.office_hours || agents_online ? 15000 : 5000) : parseInt(CHAT_SETTINGS.follow));
            }
        },

        followUpCheck: function () {
            return !admin && this.conversation && CHAT_SETTINGS.follow && activeUser() && !activeUser().email && SBF.storageTime('email', 24);
        },

        // Welcome message
        welcome: function () {
            if (!tickets && (CHAT_SETTINGS.welcome_trigger != 'open' || this.chat_open) && (CHAT_SETTINGS.office_hours || !CHAT_SETTINGS.welcome_disable_office_hours) && CHAT_SETTINGS.welcome && !storage('welcome') && activeUser()) {
                SBF.ajax({
                    function: 'get-block-setting',
                    value: 'welcome'
                }, (response) => {
                    setTimeout(() => {
                        if (CHAT_SETTINGS.dialogflow_welcome) {
                            if (this.conversation === false) {
                                this.newConversation(3, -1, '', [], null, null, function () {
                                    SBApps.dialogflow.welcome(response.open, response.sound)
                                });
                            } else {
                                SBApps.dialogflow.welcome(response.open, response.sound);
                            }
                        } else {
                            this.sendMessage(bot_id, response.message, [], false, false, 3);
                            if (response.open && !mobile) {
                                this.start();
                            }
                            if (response.sound) {
                                this.audio.play();
                            }
                        }
                        this.skip = true;
                        SBF.event('SBWelcomeMessage');
                    }, parseInt(tickets ? 0 : CHAT_SETTINGS.welcome_delay));
                    storage('welcome', true);
                });
            }
        },

        // Offline timetable message
        offlineMessage: function () {
            if (!admin && CHAT_SETTINGS.timetable && (!CHAT_SETTINGS.office_hours || (!agents_online && !CHAT_SETTINGS.timetable_disable_agents))) {
                let message = CHAT_SETTINGS.timetable_message;
                switch (CHAT_SETTINGS.timetable_type) {
                    case 'header':
                        if (!this.offline_message_set) {
                            if (message[0]) chat_header.find('.sb-title').html(message[0]);
                            chat_header.find('.sb-text').html(message[1]);
                            this.offline_message_set = true;
                        }
                        break;
                    case 'info':
                        if (!this.offline_message_set) {
                            chat.prepend(`<div class="sb-notify-message sb-rich-cnt"><div class="sb-cnt"><div class="sb-message">${message[0] ? `<b>${message[0]}</b> ` : ''}${message[1]}</div></div></div>`);
                            main.addClass('sb-notify-active');
                            this.offline_message_set = true;
                        }
                        break;
                    default:
                        setTimeout(() => {
                            if (this.conversation) {
                                let offline_message = CHAT_SETTINGS.timetable_hide ? `${message[0] ? `*${message[0]}*\n` : ''}${message[1]}` : '[timetable]';
                                let offline_message_sent = this.conversation.searchMessages(offline_message, true);
                                offline_message_sent = offline_message_sent.length ? offline_message_sent : false;
                                if (offline_message_sent) {
                                    let last_agent_message = this.conversation.getLastUserMessage(false, true);
                                    offline_message_sent = !last_agent_message || (last_agent_message.get('index') < offline_message_sent[offline_message_sent.length - 1].get('index') && Date.now() - 3600000) < SBF.unix(offline_message_sent[0].get('creation_time'));
                                }
                                if (!offline_message_sent) {
                                    this.sendMessage(bot_id, offline_message);
                                }
                            }
                        }, 5000);
                }
            }
        },

        // Send Slack message
        slackMessage: function (user_id, full_name, profile_image, message, attachments = []) {
            if (!this.conversation || (!message && !attachments.length)) return false;
            let conversation_id = this.conversation.id;
            SBF.ajax({
                function: 'send-slack-message',
                user_id: user_id,
                full_name: full_name,
                profile_image: profile_image,
                conversation_id: conversation_id,
                message: message,
                attachments: attachments,
                channel: this.slack_channel[0] == activeUser().id ? this.slack_channel[1] : false
            }, (response) => {
                this.slack_channel = [activeUser().id, response[1]];
                SBF.event('SBSlackMessageSent', { message: message, conversation_id: conversation_id, slack_channel: response[1] });
            });
        },

        // Delete message
        deleteMessage: function (message_id) {
            SBF.ajax({
                function: 'delete-message',
                message_id: message_id
            }, () => {
                if (this.conversation) this.conversation.deleteMessage(message_id);
                chat.find(`[data-id="${message_id}"]`).remove();
                SBF.event('SBMessageDeleted', message_id);
            });
        },

        // Registration form
        registration: function (check = false, type = CHAT_SETTINGS.registration_required) {
            if (check) {
                return CHAT_SETTINGS.registration_required && (!CHAT_SETTINGS.registration_offline || !agents_online) && (typeof SB_DEFAULT_USER == ND || !SB_DEFAULT_USER.email) && (!CHAT_SETTINGS.registration_timetable || !CHAT_SETTINGS.office_hours) && (activeUser() === false || ['visitor', 'lead'].includes(activeUser().type));
            }
            chat_scroll_area.append(SBRichMessages.generate({}, CHAT_SETTINGS.registration_link || (CHAT_SETTINGS.registration_required == 'registration-login') ? 'login' : type, 'sb-init-form'));
            if (!this.dashboard) {
                this.showDashboard();
            }
            this.dashboard = true;
            this.finalizeInit();
            main.addClass('sb-init-form-active');
        },

        // Shortcut for add user and login function
        addUserAndLogin: function (onSuccess = false, lead = false) {
            let settings = typeof SB_DEFAULT_USER != ND && SB_DEFAULT_USER ? SB_DEFAULT_USER : {};
            settings.user_type = lead ? 'lead' : 'visitor';
            SBF.ajax({
                function: 'add-user-and-login',
                settings: settings,
                settings_extra: settings.extra
            }, (response) => {
                if (SBF.errorValidation(response)) {
                    if (response[1] == 'duplicate-email' || response[1] == 'duplicate-phone') {
                        delete SB_DEFAULT_USER.email;
                        delete SB_DEFAULT_USER.extra.phone;
                        return this.addUserAndLogin(onSuccess, lead);
                    }
                } else {
                    SBF.loginCookie(response[1]);
                    activeUser(new SBUser(response[0]));
                    SBPusher.start();
                    if (!SBPusher.active) {
                        SBChat.automations.runAll();
                    }
                    if (onSuccess) {
                        onSuccess(response);
                    }
                }
            });
        },

        // Check if the dashboard must be showed
        isInitDashboard: function () {
            return CHAT_SETTINGS.init_dashboard || (activeUser() && activeUser().conversations.length > 1);
        },

        // Upload response
        uploadResponse: function (response) {
            response = JSON.parse(response);
            if (response[0] == 'success') {
                if (response[1] == 'extension_error') {
                    let message = 'The file you are trying to upload has an extension that is not allowed.';
                    if (admin) {
                        SBAdmin.infoPanel(message, 'info');
                    } else {
                        alert(message);
                    }
                } else if ($(upload_target).hasClass('sb-input-image')) {
                    let image = $(upload_target).find('.image');
                    let image_url = image.attr('data-value');
                    if (image_url && !image_url.includes('media/user.svg')) {
                        SBF.ajax({ function: 'delete-file', path: image_url });
                    }
                    image.attr('data-value', '').css('background-image', '');
                    setTimeout(() => {
                        image.attr('data-value', response[1]).css('background-image', `url("${response[1]}?v=${SBF.random()}")`).append('<i class="sb-icon-close"></i>');
                        upload_target = false;
                    }, 500);
                } else {
                    let name = SBF.beautifyAttachmentName(response[1].substr(response[1].lastIndexOf('/') + 1));
                    //chat_editor.find('.sb-attachments').append(`<div data-name="${name}" data-value="${response[1]}" ${response.length > 2 ? ' data-size="' + response[2][0] + '|' + response[2][1] + '"' : ''} ${response.length > 2 ? ' data-type="' + response[2]['mime'] +'"' : ''} ${response.length > 2 ? ' data-memory-size="' + response['size_bytes'] +'"' : ''}>${name}<i class="sb-icon-close"></i></div>`);
                    chat_editor.find('.sb-attachments').append(`
                        <div 
                        data-name="${name}" 
                        data-value="${response[1]}"
                        ${response[2] ? ` data-size="${response[2][0]}|${response[2][1]}"` : ''}
                        ${response[2]?.mime ? ` data-type="${response[2].mime}"` : ''}
                        ${response.size_bytes ? ` data-memory-size="${response.size_bytes}"` : ''}
                    >${name}<i class="sb-icon-close"></i>
                    </div>
                    `);
                    chat_editor.sbActive(true);
                }
            } else {
                SBF.error(response[1], 'sb-upload-files.change');
            }
            this.busy(false);
        },

        // Archive a conversation and close it
        closeChat: function (update_conversation_status = true) {
            let id = this.conversation.id;
            SBChat.clear();
            if (update_conversation_status) {
                SBF.ajax({
                    function: 'update-conversation-status',
                    conversation_id: id,
                    status_code: 3
                }, () => {
                    this.closeChat_(id);
                });
            } else {
                this.closeChat_(id);
            }

        },

        closeChat_(id) {
            main.find(`li[data-conversation-id="${id}"]`).remove();
            force_action = 'new-conversation';
            SBChat.clear();
            storage('open-conversation', '');
            storage('welcome', '');
            storage('flow_on_load', '');
            activeUser().removeConversation(id);
            if (!CHAT_SETTINGS.disable_dashboard) {
                SBChat.showDashboard();
            }
        },

        conversationArchived: function () {
            let is_close_chat = (!tickets && CHAT_SETTINGS.close_chat) || (tickets && CHAT_SETTINGS.tickets_close);
            if (is_close_chat && !CHAT_SETTINGS.rating) {
                return this.closeChat(false);
            }
            if (CHAT_SETTINGS.rating) {
                SBRichMessages.rating(is_close_chat);
            }
        },

        // Automations
        automations: {
            history: [],
            busy: [],
            scroll_position_intervals: {},
            timeout_queue: [],

            runAll: function () {
                let automations = CHAT_SETTINGS.automations;
                for (var i = 0; i < automations.length; i++) {
                    let automation = automations[i];
                    let conditions = automation.conditions;
                    let count = conditions.length;
                    let valid = count == 0;
                    let browsing_time = false;
                    let scroll_position = false;
                    let server_conditions = false;
                    for (var j = 0; j < conditions.length; j++) {
                        let criteria = conditions[j][1];
                        valid = false;
                        switch (conditions[j][0]) {
                            case 'browsing_time':
                                valid = true;
                                browsing_time = criteria;
                                break;
                            case 'scroll_position':
                                valid = true;
                                scroll_position = criteria;
                                break;
                            case 'referring':
                            case 'url':
                                let url = conditions[j][0] == 'referring' ? document.referrer : window.location.href;
                                let checks = conditions[j][2].replace(/https?:\/\/|www\./g, '').split(',');
                                url = url.replace(/https?:\/\/|www\./g, '');
                                for (var y = 0; y < checks.length; y++) {
                                    if (url.includes(checks[y])) {
                                        valid = criteria == 'contains';
                                        break;
                                    }
                                }
                                break;
                            case 'include_urls': // Deprecated whole block
                            case 'exclude_urls': // Deprecated whole block
                                let url2 = conditions[j][0] == 'referring' ? document.referrer : window.location.href;
                                let checks2 = conditions[j][2].replace(/https?:\/\/|www\./g, '').split(',');
                                let include = conditions[j][0] != 'exclude_urls';
                                if (!include) valid = true;
                                url2 = url2.replace(/https?:\/\/|www\./g, '');
                                for (var y = 0; y < checks2.length; y++) {
                                    checks2[y] = $.trim(checks2[y].replace('https://', '').replace('http://', '').replace('www.', ''));
                                    if ((criteria == 'contains' && url2.indexOf(checks2[y]) != -1) || (criteria == 'does-not-contain' && url2.indexOf(checks2[y]) == -1) || (criteria == 'is-exactly' && checks2[y] == url2) || (criteria == 'is-not' && checks2[y] != url2)) {
                                        valid = include;
                                        break;
                                    }
                                }
                                break;
                            case 'custom_variable':
                                let variable = criteria.split('=');
                                if (variable[0] in window && window[variable[0]] == variable[1]) {
                                    valid = true;
                                }
                                break;
                            case 'returning_visitor':
                            case 'user_type':
                            case 'cities':
                            case 'languages':
                            case 'countries':
                            case 'postal_code':
                            case 'website':
                            case 'company':
                            case 'creation_time':
                            case 'last_activity':
                                valid = activeUser();
                                server_conditions = true;
                                break;
                            case 'phone':
                                valid = activeUser() && activeUser().getExtra('phone');
                                break;
                            case 'email':
                                valid = activeUser() && activeUser().email;
                                break;
                            default:
                                valid = activeUser() && activeUser().getExtra(conditions[j][0]);
                        }
                        if (!valid) {
                            break;
                        }
                    }
                    if (['messages', 'emails', 'sms'].includes(automation.type) && !activeUser()) {
                        valid = false;
                    }
                    if (valid) {
                        if (server_conditions) {
                            if (!(automation.id in this.busy)) {
                                SBF.ajax({
                                    function: 'automations-validate',
                                    automation: automation
                                }, (response) => {
                                    if (response !== false) {
                                        this.runAll_final(automation, scroll_position, browsing_time);
                                    }
                                    delete this.busy[automation.id];
                                });
                                this.busy[automation.id] = true;
                            }
                        } else if (automation.type != 'messages' || !SBChat.registration(true)) {
                            this.runAll_final(automation, scroll_position, browsing_time);
                        }
                    }
                }
            },

            runAll_final: function (automation, scroll_position, browsing_time) {
                if (scroll_position) {
                    this.scroll_position_intervals[automation.id] = setInterval(() => {
                        if ($(window).scrollTop() > parseInt(scroll_position)) {
                            if (browsing_time) {
                                setTimeout(() => { this.run(automation) }, parseInt(browsing_time) * 1000);
                            } else {
                                this.run(automation);
                            }
                            clearInterval(this.scroll_position_intervals[automation.id]);
                        }
                    }, 1000);
                } else if (browsing_time) {
                    if (!this.timeout_queue.includes(automation.id)) {
                        setTimeout(() => { this.run(automation) }, parseInt(browsing_time) * 1000);
                        this.timeout_queue.push(automation.id);
                    }
                } else this.run(automation);
            },

            run: function (automation) {
                if (this.history.includes(automation.id)) return;
                switch (automation.type) {
                    case 'messages':
                    case 'emails':
                    case 'sms':
                        if ((!SBPusher.active || SBPusher.started) && !(automation.id in this.busy)) {
                            if (automation.type == 'messages' && SBChat.chat_open) {
                                let last_message = SBChat.conversation ? SBChat.conversation.getLastUserMessage(false, 'no-bot') : false;
                                if (last_message && ((Date.now() - 600000) < SBF.unix(last_message.get('creation_time')))) {
                                    return;
                                }
                            }
                            SBF.ajax({
                                function: 'automations-run',
                                automation: automation
                            }, (response) => {
                                if (response !== false) {
                                    this.history.push(automation.id);
                                    if (automation.type == 'messages' && !SBPusher.active) SBChat.updateConversations();
                                }
                                delete this.busy[automation.id];
                            });
                            this.busy[automation.id] = true;
                        }
                        break;
                    case 'popups':
                        if (!storage('popup' + automation.id)) {
                            setTimeout(() => {
                                if (!SBChat.chat_open) {
                                    SBChat.popup(false, { id: automation.id, image: automation.profile_image, title: automation.title, message: automation.message });
                                    this.history.push(automation.id);
                                } else if (automation.fallback) {
                                    let last_message = SBChat.conversation ? SBChat.conversation.getLastUserMessage(false, 'no-bot') : false;
                                    if (!last_message || ((Date.now() - 600000) > SBF.unix(last_message.get('creation_time')))) {
                                        SBChat.sendMessage(bot_id, (SBF.null(automation.title) ? '' : `*${automation.title}*\n`) + automation.message, [], false, false, 0);
                                        storage('popup' + automation.id, true);
                                        this.history.push(automation.id);
                                    }
                                }
                            }, 1000);
                        }
                        break;
                    case 'design':
                        if (automation.background) {
                            chat_header.css('background-image', `url("${automation.background}")`);
                        }
                        if (automation.brand) {
                            chat_header.find('.sb-brand img').attr('src', automation.brand);
                        }
                        if (automation.title) {
                            chat_header.find('.sb-title').html(automation.title);
                        }
                        if (automation.message) {
                            chat_header.find('.sb-text').html(automation.message);
                        }
                        if (automation.icon) {
                            main.find('.sb-chat-btn .sb-icon').attr('src', automation.icon);
                        }
                        if (automation.color_1 || automation.color_2 || automation.color_3) {
                            SBF.ajax({ function: 'chat-css', color_1: automation.color_1, color_2: automation.color_2, color_3: automation.color_3 }, (response) => {
                                global.append(`<style>${response}</style>`);
                            });
                        }
                        this.history.push(automation.id);
                        break;
                    case 'more':
                        let parameters = {};
                        if (automation.department) {
                            SBChat.default_department = automation.department;
                            parameters = { function: 'update-conversation-department', department: automation.department };
                        }
                        if (automation.agent) {
                            SBChat.default_agent = automation.agent;
                            parameters = { function: 'update-conversation-agent', agent_id: automation.agent };
                        }
                        if (automation.tags) {
                            automation.tags = automation.tags.split(',');
                            SBChat.default_tags = automation.tags;
                            parameters = { function: 'update-tags', tags: automation.tags, add: true };
                        }
                        if (SBChat.conversation.id && (automation.tags || automation.agent || automation.department)) {
                            parameters.conversation_id = SBChat.conversation.id
                            SBF.ajax(parameters);
                        }
                        if (automation.articles || automation.articles_category) {
                            let articles_dashboard = main.find('.sb-dashboard-articles > .sb-articles');
                            SBChat.articles_allowed_ids = automation.articles;
                            SBChat.articles_category = automation.articles_category;
                            if (articles_dashboard) {
                                SBChat.getArticles(automation.articles, (response) => {
                                    let code = '';
                                    for (var i = 0; i < 2; i++) {
                                        code += `<div data-id="${response[i].id}"><div>${response[i].title}</div><span>${response[i].content}</span></div>`;
                                    }
                                    articles_dashboard.html(code);
                                }, automation.articles_category, 2);
                            }
                        }
                        this.history.push(automation.id);
                        break;
                }
            }
        },

        // More
        flashNotification: function () {
            clearInterval(interval);
            interval = setInterval(function () {
                if (SBChat.notifications.length) {
                    document.title = document.title == document_title ? '(' + SBChat.notifications.length + ') ' + sb_('New message' + (SBChat.notifications.length > 1 ? 's' : '')) : document_title;
                }
            }, 2000);
        },

        calculateLabelDates: function () {
            if (admin || this.chat_open) {
                label_date_items = chat.find('.sb-label-date');
            }
        },

        calculateLabelDateFirst: function () {
            if (!this.conversation.messages.length) {
                chat.append(`<div class="sb-label-date"><span>${sb_('Today')}</span></div>`);
            }
        },

        playSound: function (repeat = false) {
            this.audio.play();
            let index = repeat ? repeat : (admin ? SB_ADMIN_SETTINGS.sound.repeat : CHAT_SETTINGS.sound.repeat);
            if (index && !this.tab_active) {
                clearInterval(this.audio_interval);
                this.audio_interval = setInterval(() => {
                    this.audio.play();
                    index--;
                    if (!index) {
                        clearInterval(this.audio_interval);
                    }
                }, this.audio.duration * 1000 + 1500);
            }
        },

        isConversationAllowed: function (source, status_code) {
            return (!CHAT_SETTINGS.tickets_hide || (tickets && source == 'tk') || (!tickets && source != 'tk')) && (![3, 4, '3', '4'].includes(status_code) || ((!tickets && !CHAT_SETTINGS.close_chat) || (tickets && !CHAT_SETTINGS.tickets_close)));
        }
    }
    window.SBChat = SBChat;

    /* 
    * ----------------------------------------------------------
    * RICH MESSAGES
    * ----------------------------------------------------------
    */

    var SBRichMessages = {
        rich_messsages: {
            email: '',
            button: '',
            video: '',
            image: '',
            woocommerce_button: '',
            rating: '',
            chips: '<div class="sb-buttons">[options]</div>',
            buttons: '<div class="sb-buttons">[options]</div>',
            select: '<div class="sb-select"><p></p><ul>[options]</ul></div>',
            list: '<div class="sb-text-list">[values]</div>',
            'list-image': '<div class="sb-image-list">[values]</div>',
            table: '<table><tbody>[header][values]</tbody></table>',
            inputs: '<div class="sb-form">[values]</div>',
            card: '<div class="sb-card">[settings]</div>',
            share: '<div class="sb-social-buttons">[settings]</div>',
            slider: '<div class="sb-slider"><div>[items]</div></div><div class="sb-slider-arrow sb-icon-arrow-left[class]"></div><div class="sb-slider-arrow sb-icon-arrow-right sb-active[class]"></div>',
            'slider-images': '<div class="sb-slider sb-slider-images"><div>[items]</div></div><div class="sb-slider-arrow sb-icon-arrow-left[class]"></div><div class="sb-slider-arrow sb-icon-arrow-right sb-active[class]"></div>'
        },
        cache: {},
        duplicated_email: false,

        // Generate a rich message
        generate: function (settings, name, css = '') {
            let content;
            let next = true;
            let id = settings.id ? settings.id : SBF.random();
            let render = new SBMessage({});

            // Check if the rich message exist
            if (name in this.rich_messsages) {
                content = this.rich_messsages[name];
            } else if (name in this.cache) {
                content = this.cache[name];
            } else if (this.isShortcode(name)) {
                if (!settings.id) {
                    id = name;
                }
                content = '<div class="sb-rich-loading sb-loading"></div>';
                SBF.ajax({
                    function: 'get-rich-message',
                    name: name,
                    settings: settings
                }, (response) => {
                    response = this.initInputs(response);
                    if (name == 'timetable') {
                        response = this.timetable(response);
                    }
                    $(admin && SBAdmin.active_admin_area == 'chatbot' ? '.sb-playground' : main).find(`.sb-rich-message[id="${id}"]`).html(`<div class="sb-content">${response}</div>`);
                    this.cache[name] = response;
                    SBChat.scrollBottom(SBChat.dashboard);
                    SBF.event('SBRichMessageShown', { name: name, settings: settings, response: response });
                });
                next = false;
            } else {
                return false;
            }

            // Generate the rich message
            let disabled = settings.disabled;
            if (next) {
                let options;
                let code = '';
                switch (name) {
                    case 'email':
                        let inputs = [];
                        let email = activeUser().email;
                        let default_name = activeUser().get('last_name').charAt(0) == '#';
                        if (settings['name'] == 'true') {
                            inputs.push(['first_name', settings['last-name'] == 'true' ? 'First name' : 'Name', default_name ? '' : (settings['last-name'] == 'true' ? activeUser().get('first_name') : activeUser().name), 'text', true]);
                        }
                        if (settings['last-name'] == 'true') {
                            inputs.push(['last_name', 'Last name', default_name ? '' : activeUser().get('last_name'), 'text', true]);
                        }
                        for (var i = 0; i < inputs.length; i++) {
                            content += `<div id="${inputs[i][0]}" data-type="text" class="sb-input sb-input-text"><span class="${inputs[i][2] ? 'sb-active sb-filled' : ''}">${sb_(inputs[i][1])}</span><input value="${inputs[i][2]}" autocomplete="false" type="${inputs[i][3]}" ${inputs[i][4] ? 'required' : ''}></div>`;
                        }
                        if (settings['phone'] == 'true') {
                            let phone = activeUser().getExtra('phone');
                            if (!this.cache.phone) {
                                this.cache.phone = true;
                                SBF.ajax({
                                    function: 'get-select-phone'
                                }, (response) => {
                                    this.cache.phone = response;
                                    chat.find('#phone .sb-select-phone').html(response);
                                });
                            }
                            content += `<div id="phone" data-type="select-input" class="sb-input sb-input-select-input"><span class="${phone ? 'sb-active sb-filled' : ''}">${sb_('Phone')}</span><div class="sb-select-phone">${this.cache.phone ? this.cache.phone : ''}</div><input autocomplete="false" type="text" data-phone="true"${settings['phone-required'] != 'false' ? ' required' : ''}></div>`;
                        }
                        content += `<div id="email" data-type="email" class="sb-input sb-input-btn"><span class="${email ? 'sb-active sb-filled' : ''}">${sb_(SBF.null(settings.placeholder) ? 'Email' : settings.placeholder)}</span><input value="${email}" autocomplete="off" type="email" required><div class="sb-submit sb-icon-arrow-right"></div></div>`;
                        break;
                    case 'image':
                        content = `<div class="sb-image"><img loading="lazy" src="${settings.url}"></div>`;
                        break;
                    case 'video':
                        content = `<iframe loading="lazy"${settings.height ? ` height="${settings.height}"` : ''} src="https://${settings.type == 'youtube' ? 'www.youtube.com/embed/' : 'player.vimeo.com/video/'}${settings.id}" allowfullscreen></iframe>`;
                        break;
                    case 'select':
                        options = settings && settings.options ? settings.options.replace(/\\,/g, '{R}').split(',') : [];
                        for (var i = 0; i < options.length; i++) {
                            let item = options[i].replace(/{R}/g, ',');
                            code += `<li data-value="${SBF.stringToSlug(item)}">${sb_(item)}</li>`;
                        }
                        content = content.replace('[options]', code);
                        break;
                    case 'chips':
                    case 'buttons':
                        options = settings && settings.options ? settings.options.replace(/\\,/g, '{R}').split(',') : [];
                        for (var i = 0; i < options.length; i++) {
                            code += `<div class="sb-btn sb-submit">${sb_(options[i].replace(/{R}/g, ','))}</div>`;
                        }
                        content = content.replace('[options]', code);
                        break;
                    case 'button':
                        if (settings && settings.link) {
                            let action_link = settings.link.includes('calendly.com');
                            content = `<a ${action_link ? 'data-action="calendly" data-extra="' + settings.link + '|' + (settings.success ? settings.success.replaceAll('"', '\'') : '') + '" ' : ''}href="${action_link ? '#' : settings.link.replace(/<i>/g, '_').replace(/<\/i>/g, '_')}"${settings.target && !action_link ? ' target="_blank"' : ''} class="sb-rich-btn sb-btn${settings.style == 'link' ? '-text' : ''}">${sb_(settings.name)}</a>`;
                        }
                        break;
                    case 'list':
                        if (settings.values) {
                            options = settings.values.replace(/\\,/g, '{R}').replace(/\\:/g, '{R2}').replace(/:\/\//g, '{R3}').split(',');
                            let list = name == 'list';
                            let list_double = list && options.length && options[0].indexOf(':') > 0;
                            if (list && !list_double) {
                                content = content.replace('sb-text-list', 'sb-text-list sb-text-list-single');
                            }
                            if (settings.numeric) {
                                content = content.replace('sb-text-list', 'sb-text-list sb-text-list-numeric');
                            }
                            for (var i = 0; i < options.length; i++) {
                                let item = options[i].replace(/{R}/g, ',');
                                let is_inner = item.substr(0, 1) === '-';
                                code += list_double && item.includes(':') ? `<div><div>${sb_(item.split(':')[0].replace(/{R2}/g, ':').replace(/{R3}/g, '://'))}</div><div>${sb_(item.split(':')[1].replace(/{R2}/g, ':').replace(/{R3}/g, '://'))}</div></div>` : `<div${is_inner ? ' data-inner="true"' : ''}>${$.trim(sb_((is_inner ? item.substr(1) : item).replace(/{R2}/g, ':').replace(/{R3}/g, '://')))}</div>`;
                            }
                            content = content.replace('[values]', code);
                        }
                        break;
                    case 'list-image':
                        if (settings.values) {
                            options = settings.values.split(',');
                            for (var i = 0; i < options.length; i++) {
                                let item = options[i].replace('://', '///').split(':');
                                code += `<div><div class="sb-thumb" style="background-image:url('${item[0].replace('///', '://')}')"></div><div class="sb-list-title">${item[1]}</div><div>${item[2]}</div></div>`;
                            }
                            content = content.replace('[values]', code);
                        }
                        break;
                    case 'table':
                        if (settings.values) {
                            options = settings.header.split(',');
                            code += '<tr>';
                            for (var i = 0; i < options.length; i++) {
                                code += `<th>${options[i]}</th>`;
                            }
                            code += '</tr>';
                            content = content.replace('[header]', code);
                            code = '';
                            options = settings.values.split(',');
                            for (var i = 0; i < options.length; i++) {
                                let tds = options[i].split(':');
                                code += '<tr>';
                                for (var j = 0; j < tds.length; j++) {
                                    code += `<td>${tds[j]}</td>`;
                                }
                                code += '</tr>';
                            }
                            content = content.replace('[values]', code);
                        }
                        break;
                    case 'inputs':
                        if (settings.values) {
                            options = settings.values.split(',');
                            for (var i = 0; i < options.length; i++) {
                                if (disabled && !options[i]) continue;
                                code += `<div id="${SBF.stringToSlug(options[i])}" data-type="text" class="sb-input sb-input-text"><span>${sb_(options[i])}</span><input autocomplete="false" type="text" required></div>`;
                            }
                            code += '<div class="sb-btn sb-submit">' + sb_(settings.button ? settings.button : 'Send now') + '</div>';
                            content = content.replace('[values]', code);
                        }
                        break;
                    case 'card':
                        code = `${settings.image ? `<div class="sb-card-img" style="background-image:url('${settings.image}')"></div>` : ''}<div class="sb-card-header">${settings.header}</div>${settings.extra ? `<div class="sb-card-extra">${settings.extra}</div>` : ''}${settings.description ? `<div class="sb-card-description">${settings.description}</div>` : ''}${settings.link ? `<a class="sb-card-btn" href="${settings.link}"${settings.target ? ' target="_blank"' : ''}>${sb_(settings['link-text'])}</a>` : ''}`;
                        content = content.replace('[settings]', code);
                        break;
                    case 'share':
                        let channels = settings.channels ? settings.channels.replace(/ /g, '').split(',') : ['fb', 'tw', 'li', 'wa', 'pi'];
                        let link = '';
                        for (var i = 0; i < channels.length; i++) {
                            switch (channels[i]) {
                                case 'fb':
                                    link = 'www.facebook.com/sharer.php?u=';
                                    break;
                                case 'tw':
                                    link = 'twitter.com/intent/tweet?url=';
                                    break;
                                case 'li':
                                    link = 'www.linkedin.com/sharing/share-offsite/?url=';
                                    break;
                                case 'wa':
                                    link = 'web.whatsapp.com/send?text=';
                                    break;
                                case 'pi':
                                    link = 'www.pinterest.com/pin/create/button/?url=';
                                    break;
                            }
                            code += `<div class="sb-${channels[i]} sb-icon-social-${channels[i]}" data-link="https://${link}${encodeURIComponent(settings[channels[i]])}"></div>`;
                        }
                        content = content.replace('[settings]', code);
                        break;
                    case 'slider':
                        let count = 0;
                        for (var i = 1; i < 16; i++) {
                            if (('header-' + i) in settings) {
                                code += `<div>${('image-' + i) in settings ? `<div class="sb-card-img" style="background-image:url('${settings['image-' + i]}')"></div>` : ''}<div class="sb-card-header">${settings['header-' + i]}</div>${('extra-' + i) in settings ? `<div class="sb-card-extra">${settings['extra-' + i]}</div>` : ''}${('description-' + i) in settings ? `<div class="sb-card-description">${settings['description-' + i]}</div>` : ''}${('link-' + i) in settings ? `<a class="sb-card-btn" href="${settings['link-' + i]}"${settings.target ? ' target="_blank"' : ''}>${sb_(settings['link-text-' + i])}</a>` : ''}</div>`;
                                count++;
                            } else {
                                break;
                            }
                        }
                        content = content.replace('[items]', code).replace(/\[class\]/g, count == 1 ? ' sb-hide' : '');
                        break;
                    case 'slider-images':
                        if (settings.images) {
                            let images = settings.images.split(',');
                            for (var i = 0; i < images.length; i++) {
                                code += `<div class="sb-card-img" data-value="${images[i]}" style="background-image:url('${images[i]}')"></div>`;
                            }
                            content = content.replace(/\[class\]/g, images.length == 1 ? ' sb-hide' : '');
                        }
                        content = content.replace('[items]', code);
                        break;
                    case 'woocommerce_button':
                        settings.settings = `checkout:${settings.checkout},coupon:${settings.coupon}`;
                        content = `<a href="#" data-ids="${settings.ids}" class="sb-rich-btn sb-btn">${settings.name}</a>`;
                        break;
                    case 'rating':
                        content = `<div class="sb-rating-message sb-rating-${settings.value == 1 ? 'positive' : 'negative'}"><div><i class="sb-icon-${settings.value == 1 ? 'like' : 'dislike'}"></i> ${sb_(settings.value == 1 ? 'Helpful' : 'Not helpful')}</div>${settings.message ? '<div>' + settings.message + '</div>' : ''}</div>`;
                        settings.message = false;
                        break;
                }
            }
            return `<div id="${id}" data-type="${name}"${disabled ? 'disabled="true"' : ''}${settings.settings ? ` data-settings="${settings.settings}"` : ''}class="sb-rich-message sb-rich-${name} ${css}">` + (settings.title ? `<div class="sb-top">${render.render(sb_(settings.title))}</div>` : '') + (settings.message ? `<div class="sb-text">${render.render(sb_(settings.message))}</div>` : '') + `<div class="sb-content">${content}</div>${name == 'email' ? `<div data-success="${settings.success ? settings.success.replace(/"/g, '') : ''}" class="sb-info"></div>` : ''}</div>`;
        },

        // Function of built-in rich messages
        submit: function (area, type, element) {
            if (!admin && !loading(element) && !this.is_busy) {
                let error = '';
                let shortcode = '';
                let parameters = {};
                let success = $(area).find('[data-success]').length ? $(area).find('[data-success]').attr('data-success') : '';
                let rich_message_id = $(area).closest('.sb-rich-message').attr('id');
                let message_id = $(area).closest('[data-id]').attr('data-id');
                let message = '';
                let payload = { 'rich-messages': {} };
                let user_settings = activeUser() == false ? { profile_image: '', first_name: '', last_name: '', email: '', password: '', user_type: '' } : { profile_image: activeUser().image, first_name: activeUser().get('first_name'), last_name: activeUser().get('last_name'), email: activeUser().email, password: '', user_type: '' };
                let settings = {};
                let input = $(element);
                let dialogflow_response = '';
                let dialogflow_parameters = false;
                let active_conversation = SBChat.conversation !== false;
                let settings_extra = {};
                let payload_settings = {};
                let otp = area.find('#otp');
                if (SBF.null(message_id)) {
                    message_id = -1;
                } else {
                    let item = SBChat.conversation.getMessage(message_id);
                    message = item.message;
                    payload = item.payload();
                    if (!payload['rich-messages']) {
                        payload['rich-messages'] = {};
                    }
                }
                if (!$(element).hasClass('sb-btn') && !$(element).hasClass('sb-select') && !$(element).hasClass('sb-submit')) {
                    input = $(element).closest('.sb-btn,.sb-select');
                }
                $(area).find('.sb-info').html('').sbActive(false);
                switch (type) {
                    case 'email':
                        settings = SBForm.getAll(area);
                        $.each(settings, function (key, value) {
                            settings[key] = value[0];
                        });
                        if (settings.first_name) {
                            user_settings.user_type = 'user';
                            if (!settings.last_name) {
                                user_settings.last_name = '';
                            }
                        }
                        if (settings.phone) {
                            settings_extra = { phone: [settings.phone, 'Phone'] };
                        }
                        $.extend(user_settings, settings);
                        error = 'Please fill in all required fields and make sure the email is valid.';
                        if (success) {
                            success = sb_(success).replace('{user_email}', user_settings.email).replace('{user_name_}', user_settings.first_name + (settings.last_name ? (' ' + user_settings.last_name) : ''));
                        }
                        if (otp.sbActive()) {
                            let otp_string = otp.attr('data-otp');
                            settings.otp = otp_string ? [otp_string, area.find('#otp input').val()] : false;
                        }
                        payload['rich-messages'][rich_message_id] = { type: type, result: settings };
                        payload['event'] = 'update-user';
                        parameters = { function: 'update-user-and-message', settings: user_settings, settings_extra: settings_extra, payload: payload, skip_otp: true };
                        dialogflow_parameters = { settings: user_settings, settings_extra: settings_extra };
                        break;
                    case 'registration':
                        settings = SBForm.getAll(area.find('.sb-form-main'));
                        settings_extra = SBForm.getAll(area.find('.sb-form-extra'));
                        $.each(settings, function (key, value) {
                            settings[key] = value[0];
                        });
                        $.extend(user_settings, settings);
                        payload_settings = $.extend({}, user_settings);
                        if (success) {
                            success = sb_(success);
                        }
                        if (CHAT_SETTINGS.registration_details) {
                            success += '[list values="';
                            for (var key in user_settings) {
                                let value = user_settings[key].replace(/:|,/g, '');
                                if (value) {
                                    if (key == 'profile_image') {
                                        value = value.substr(value.lastIndexOf('/') + 1);
                                    }
                                    if (['password', 'password-check', 'envato-purchase-code', 'otp'].includes(key)) {
                                        value = '********';
                                        payload_settings[key] = '********';
                                    } else {
                                        success += user_settings[key] ? `${sb_(SBF.slugToString(key.replace('first_name', 'name')))}:${value},` : '';
                                    }
                                }
                            }
                            for (var key in settings_extra) {
                                if (settings_extra[key][0]) {
                                    success += `${sb_(settings_extra[key][1].replace(/:|,/g, ''))}:${settings_extra[key][0].replace(/:|,/g, '')},`;
                                }
                            }
                            success = success.slice(0, -1) + '"]';
                        }
                        if (otp.sbActive()) {
                            let otp_string = otp.attr('data-otp');
                            user_settings.otp = otp_string ? [otp_string, area.find('#otp input').val()] : false;
                        }
                        user_settings.user_type = 'user';
                        payload['rich-messages'][rich_message_id] = { type: type, result: { user: payload_settings, extra: settings_extra } };
                        payload['event'] = 'update-user';
                        parameters = CHAT_SETTINGS.registration_otp && user_settings.email && !user_settings.otp ? { function: 'otp', email: user_settings.email } : { function: activeUser() ? 'update-user-and-message' : 'add-user-and-login', settings: user_settings, settings_extra: settings_extra, payload: payload };
                        error = SBForm.getRegistrationErrorMessage(area);
                        dialogflow_parameters = { settings: user_settings, settings_extra: settings_extra };
                        break;
                    case 'chips':
                    case 'select':
                    case 'buttons':
                        settings = SBF.escape($(element).html());
                        if (success) {
                            success = sb_(success) + ` *${settings}*`;
                        }
                        payload['rich-messages'][rich_message_id] = { type: type, result: settings };
                        parameters = { function: 'update-message', payload: payload };
                        dialogflow_response = settings;
                        if (type == 'chips') {
                            SBChat.sendMessage(activeUser().id, settings, [], false, { id: rich_message_id, event: 'chips-click', result: settings }, rich_message_id == 'sb-human-takeover' && input.index() == 0 ? 2 : false);
                            if (rich_message_id == 'sb-human-takeover' && $(element).index() == 0) {
                                SBApps.dialogflow.humanTakeover();
                            }
                            $(element).closest('.sb-content').remove();
                        }
                        break;
                    case 'inputs':
                        settings = SBForm.getAll(area);
                        error = 'All fields are required.';
                        if (success) {
                            success = sb_(success) + ' [list values="';
                            for (var key in settings) {
                                success += `${sb_(settings[key][1].replace(/:|,/g, ''))}:${settings[key][0].replace(/:|,/g, '')},`;
                            }
                            success = success.slice(0, -1) + '"]';
                        }
                        payload['rich-messages'][rich_message_id] = { type: type, result: settings };
                        parameters = { function: 'update-message', payload: payload };
                        dialogflow_parameters = { settings: settings };
                        break;
                }
                shortcode = message.substr(message.indexOf('[' + type))
                shortcode = shortcode.substr(0, shortcode.indexOf(']') + 1);
                if (error && SBForm.errors(area)) {
                    SBForm.showErrorMessage(area, error);
                    input.sbLoading(false);
                    if (SBChat.dashboard || (active_conversation && SBChat.conversation.getLastMessage().id == message_id)) {
                        SBChat.scrollBottom();
                    }
                    return false;
                }
                if (!success && type != 'registration') {
                    let shortcode_settings = this.shortcode(shortcode);
                    let id = shortcode_settings[1].id ? `id="${shortcode_settings[1].id}"` : '';
                    let title = shortcode_settings[1].title ? `title="${shortcode_settings[1].title}"` : '';
                    let message = shortcode_settings[1].message ? `message="${shortcode_settings[1].message}"` : '';
                    let value = '';
                    if (['inputs', 'email'].includes(type)) {
                        for (var key in settings) {
                            value += settings[key] + ',';
                        }
                        value = `values="${value.slice(0, -1)}"`
                    } else {
                        value = `options="${settings}"`;
                    }
                    success = `[${type == 'email' ? 'inputs' : type} ${id} ${title} ${message} ${value} disabled="true"]`;
                }
                if (message_id != -1) {
                    success = success.replace(/<br>/g, '\n');
                    $.extend(parameters, {
                        message_id: message_id,
                        message: message ? (type == 'chips' ? message.replace(']', ' disabled="true"]') : message.replace(shortcode, success)) : success,
                        payload: payload
                    });
                }
                SBF.ajax(parameters, (response) => {
                    if (response && !SBF.errorValidation(response)) {
                        switch (type) {
                            case 'email':
                                for (var key in user_settings) {
                                    activeUser().set(key, user_settings[key]);
                                }
                                for (var key in settings_extra) {
                                    activeUser().setExtra(key, settings_extra[key][0]);
                                }
                                SBF.loginCookie(response[1]);
                                if (rich_message_id == 'sb-follow-up') {
                                    SBF.ajax({
                                        function: 'subscribe-email',
                                        email: activeUser().email
                                    });
                                }
                                SBChat.automations.runAll();
                                SBF.event('SBNewEmailAddress', { id: rich_message_id, name: activeUser().name, email: activeUser().email });
                                break;
                            case 'registration':
                                let otp = area.find('#otp');
                                if (CHAT_SETTINGS.registration_otp && !otp.sbActive()) {
                                    otp.attr('data-otp', response).sbActive(true);
                                    otp.find('input').attr('required', true).addClass('sb-error');
                                    SBForm.showErrorMessage(area, sb_('Please check your email for the one-time code.'));
                                    SBChat.scrollBottom();
                                    input.sbLoading(false);
                                    return;
                                }
                                SBF.loginCookie(response[1]);
                                user_settings.id = response[0].id;
                                if (!activeUser()) {
                                    activeUser(new SBUser(response[0]));
                                    for (var key in settings_extra) {
                                        activeUser().setExtra(key, settings_extra[key][0]);
                                    }
                                    if (this.duplicated_email && !CHAT_SETTINGS.init_dashboard) {
                                        force_action = 'open-conversation';
                                    }
                                    SBPusher.start();
                                    SBChat.initChat();
                                    if (!this.duplicated_email && (!CHAT_SETTINGS.init_dashboard || !main.find('.sb-departments-list').length) && success) {
                                        SBChat.sendMessage(bot_id, success, [], false, false, 3);
                                    }
                                } else {
                                    for (var key in user_settings) {
                                        activeUser().set(key, user_settings[key]);
                                    }
                                    for (var key in settings_extra) {
                                        activeUser().setExtra(key, settings_extra[key][0]);
                                    }
                                    SBChat.automations.runAll();
                                    SBChat.welcome();
                                }
                                if (SBChat.dashboard) {
                                    main.removeClass('sb-init-form-active');
                                    $(area).remove();
                                    if (!SBChat.isInitDashboard() && (!CHAT_SETTINGS.init_dashboard || !this.duplicated_email)) {
                                        SBChat.hideDashboard();
                                    }
                                }
                                if (CHAT_SETTINGS.wp_registration && user_settings.email && user_settings.password) {
                                    SBApps.wordpress.ajax('wp-registration', { user_id: response[0].id, first_name: response[0].first_name, last_name: response[0].last_name, password: user_settings.password, email: user_settings.email });
                                } else if (CHAT_SETTINGS.wp_users_system == 'wp') {
                                    SBApps.wordpress.ajax('wp-login', { user: user_settings.email, password: user_settings.password });
                                }
                                delete this.cache.registration;
                                setTimeout(() => {
                                    SBF.event('SBRegistrationForm', { id: rich_message_id, conversation_id: SBChat.conversation ? SBChat.conversation.id : false, user: user_settings, extra: payload['rich-messages'][rich_message_id]['result']['extra'] });
                                }, 5000);
                                break;
                            case 'buttons':
                                SBChat.scrollBottom();
                                break;
                        }
                        if (message_id == -1) {
                            $(element).closest('.sb-rich-message').html(success);
                        } else {
                            input.sbLoading(false);
                            if ((!payload.type || payload.type != 'close-message') && !dialogflow_human_takeover) {
                                SBChat.setConversationStatus(2);
                            }
                        }
                        if (!['login', 'chips'].includes(type) && (CHAT_SETTINGS.dialogflow_send_user_details || !['email', 'registration'].includes(type))) {
                            SBApps.dialogflow.message(`${rich_message_id}${dialogflow_response ? ('|' + dialogflow_response) : ''}`, [], false, dialogflow_parameters);
                        }
                        if (CHAT_SETTINGS.slack_active && (!dialogflow_human_takeover || SBApps.dialogflow.humanTakeoverActive())) {
                            SBChat.slackMessage(activeUser().id, activeUser().name, activeUser().image, success);
                        }
                        if (SBPusher.active) {
                            SBChat.update();
                        }
                        if (type != 'registration' && type != 'email') {
                            SBF.event('SBRichMessageSubmit', { result: response, data: payload['rich-messages'][rich_message_id], id: rich_message_id });
                        }
                    } else {
                        if (type == 'registration' && SBF.errorValidation(response, 'duplicate-email')) {
                            SBF.ajax({
                                function: 'otp',
                                email: user_settings.email
                            }, (response) => {
                                let otp = area.find('#otp');
                                otp.attr('data-otp', response).sbActive(true);
                                otp.find('input').attr('required', true).addClass('sb-error');
                                SBForm.showErrorMessage(area, sb_('This email is already in use. Please check your email for the one-time code.'));
                                area.find('.sb-submit').html(sb_('Sign in'));
                                SBChat.scrollBottom();
                            });
                            this.duplicated_email = true;
                        } else {
                            this.duplicated_email = false;
                            SBForm.showErrorMessage(area, SBForm.getRegistrationErrorMessage(response, 'response'));
                        }
                        if (SBChat.dashboard) {
                            SBChat.scrollBottom();
                        }
                        input.sbLoading(false);
                    }
                });
            }
        },

        // Return the shortcode name and the shortcode settings
        shortcode: function (shortcode) {
            let result = {};
            let shortcode_name = shortcode.includes(' ') ? shortcode.substr(1, shortcode.indexOf(' ') - 1) : shortcode.slice(1, -1);
            if (/\?|"|'|`|\*/gi.test(shortcode_name)) {
                return [false, false];
            }
            shortcode = shortcode.slice(1, -1).substr(shortcode_name.length + 1);
            let settings = shortcode.split('" ');
            for (var i = 0; i < settings.length; i++) {
                if (settings[i].includes('=')) {
                    let item = [settings[i].substr(0, settings[i].indexOf('=')), settings[i].substr(settings[i].indexOf('=') + 2)];
                    result[$.trim(item[0])] = item[1].replace(/"/g, '');
                }
            }
            return [shortcode_name, result];
        },

        // Init the rich message inputs
        initInputs: function (code) {
            code = $($.parseHTML('<div>' + code + '</div>'));
            code.find('.sb-input input').each(function () {
                if ($(this).val()) {
                    $(this).siblings().addClass('sb-active sb-filled');
                }
            });
            return code.html();
        },

        // Timetable shortcode
        timetable: function (code) {
            let table = $($.parseHTML(`<div>${code}</div>`));
            let utc_offset = table.find('[data-offset]').attr('data-offset');
            utc_offset = SBF.null(utc_offset) ? 0 : parseFloat(utc_offset);
            table.find('[data-time]').each(function () {
                let times = $(this).attr('data-time').split('|');
                code = ''
                for (var i = 0; i < times.length; i++) {
                    if (times[i] == 'closed') {
                        code += sb_('Closed');
                        break;
                    } else if (times[i]) {
                        let hm = times[i].split(':');
                        let time = SBF.convertUTCDateToLocalDate(`01/01/2000 ${hm[0]}:${hm[1]}`, utc_offset);
                        code += time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) + (i == 0 || i == 2 ? `<span>${sb_('to')}</span>` : i == 1 && times[i + 1] ? `<br />` : '');
                    }
                }
                table.find(' > div > span').html(`<i class="sb-icon-clock"></i> ${sb_('Time zone')} ${Intl.DateTimeFormat().resolvedOptions().timeZone}`);
                $(this).html(code);
            });
            return table.html();
        },

        // Slider
        sliderChange: function (id, direction = 'left') {
            let slider = chat.find(`#${id}`);
            if (slider.length && !slider.hasClass('sb-moving')) {
                let items = slider.find('.sb-slider > div > div');
                let item = items.eq(0);
                let width = Math.ceil(item.closest('.sb-slider').width());
                let negative = (direction == 'right' ? -1 : 1);
                let margin = parseFloat(parseFloat(parseFloat(item.css('margin-left')) + (width * negative)));
                let check = width * (items.length - 1) * -1;
                if (margin < 1 && margin >= check) {
                    item.css('margin-left', margin + 'px');
                    slider.addClass('sb-moving');
                    setTimeout(() => { slider.removeClass('sb-moving'); }, 1200);
                }
                slider.find('.sb-icon-arrow-right').sbActive(!(check > (margin - 15) && check < (margin + 15)));
                slider.find('.sb-icon-arrow-left').sbActive(margin < -10);
            }
        },

        calendly: {
            script_loaded: false,

            load: function (url, title, message_id) {
                url = url.split('|');
                if (this.script_loaded) {
                    this.load_(url[0], title);
                } else {
                    $.getScript('https://assets.calendly.com/assets/external/widget.js', () => {
                        this.script_loaded = true;
                        window.addEventListener('message', function (e) {
                            if (e.origin === 'https://calendly.com' && e.data.event == 'calendly.event_scheduled') {
                                SBChat.updateMessage(message_id, sb_(url[1] ? url[1] : 'Booking completed.'));
                                chat_overlay_panel.sbActive(false);
                            }
                        });
                        this.load_(url[0], title);
                    }, true);
                }
            },

            load_: function (url, title) {
                Calendly.initInlineWidget({
                    url: (url.includes('http') ? '' : 'https://') + url + '?hide_landing_page_details=1&hide_event_type_details=1&hide_gdpr_banner=1',
                    parentElement: chat_overlay_panel.find('> div').eq(1),
                    prefil: activeUser().type == 'user' ? { name: activeUser().name, email: activeUser().email } : {}
                });
                chat_overlay_panel.find('> div:first-child > div').html(sb_(title));
                chat_overlay_panel.sbActive(true).attr('data-id', 'calendly');
            }
        },

        rating: function (is_close_chat = false) {
            chat_overlay_panel.find('> div:first-child > div').html(sb_('Rate your experience'));
            chat_overlay_panel.find('> div:last-child').html(`${CHAT_SETTINGS.rating_message ? `<div class="sb-input sb-input-textarea"><textarea placeholder="${sb_('Add a message here...')}"></textarea></div>` : ''}<div class="sb-rating"><div><i data-rating="positive" class="sb-submit sb-icon-like"><span>${sb_('Helpful')}</span></i><i data-rating="negative" class="sb-submit sb-icon-dislike"><span>${sb_('Not helpful')}</span></i></div></div>`);
            chat_overlay_panel.sbActive(true).attr('data-id', 'rating').attr('data-close-chat', is_close_chat ? 'true' : '').css('max-height', (CHAT_SETTINGS.rating_message ? 167 : 80) + 'px');
        },

        isShortcode: function (shortcode_name) {
            return shortcode_name in this.rich_messsages || (admin && SB_ADMIN_SETTINGS.rich_messages.includes(shortcode_name)) || (!admin && CHAT_SETTINGS.rich_messages.includes(shortcode_name));
        }
    }
    window.SBRichMessages = SBRichMessages;

    /* 
    * ----------------------------------------------------------
    * FORM METHODS
    * ----------------------------------------------------------
    */

    var SBForm = {

        // Get all settings
        getAll: function (area) {
            let settings = {};
            $(area).find('.sb-input[id]').each((i, element) => {
                settings[$(element).attr('id')] = this.get(element);
            });
            return settings;
        },

        // Get a single setting
        get: function (input) {
            input = $(input);
            let type = input.data('type');
            let name = sb_(SBF.escape(input.find(' > span').html()));
            switch (type) {
                case 'image':
                    let url = input.find('.image').attr('data-value');
                    return [SBF.null(url) ? '' : url, name];
                case 'select':
                    return [SBF.escape(input.find('select').val()), name];
                case 'select-input':
                    let select = input.find('select,input[disabled]');
                    return [SBF.escape((select.is('select') || select.is('input') ? select.val() : (input.find('.sb-select').length ? input.find('.sb-select > p').attr('data-value') : input.find('> div').html())) + input.find('> input').val()), name];
                default:
                    let target = input.find('input');
                    return [SBF.escape(target.length ? target.val() : input.find('[data-value]').attr('data-value')), name];
            }
        },

        // Set a single setting
        set: function (item, value) {
            item = $(item);
            if (item.length) {
                let type = item.data('type');
                switch (type) {
                    case 'image':
                        if (value) {
                            item.find('.image').attr('data-value', value).css('background-image', `url("${value}")`);
                        } else {
                            item.find('.image').removeAttr('data-value').removeAttr('style');
                        }
                        break;
                    case 'select':
                        item.find('select').val(value);
                        break;
                    default:
                        item.find('input,textarea').val(value);
                        break;
                }
                return true;
            }
            return false;
        },

        // Clear all the input values
        clear: function (area) {
            $(area).find('.sb-input,.sb-setting').each((i, element) => {
                this.set(element, '');
                $(element).find('input, select, textarea').removeClass('sb-error');
            });
            this.set($(area).find('#user_type'), 'user');
        },

        // Check for errors on user input
        errors: function (area) {
            let errors = false;
            let items = $(area).find('input, select, textarea').removeClass('sb-error');
            items.each(function (i) {
                let value = $.trim($(this).val());
                let type = $(this).attr('type');
                let required = $(this).prop('required');
                if ((required && !value) || ((required || value) && ((type == 'password' && (value.length < 8 || (items.length > (i + 1) && items.eq(i + 1).attr('type') == 'password' && items.eq(i + 1).val() != value))) || (type == 'email' && (value.indexOf('@') < 0 || value.indexOf('.') < 0 || /;|:|\/|\\|,|#|"|!|=|\*|{|}|[|]|£|\$|€|~|'|>|<|\^|&/.test(value))) || ($(this).attr('data-phone') && value && ((!$(this).parent().find('select').val() && !$(this).prev().find('> div > p').attr('data-value') && !$(this).parent().find('div').html().trim().startsWith('+')) || isNaN(value) || value.includes('+') || value.length < 5))))) {
                    errors = true;
                    $(this).addClass('sb-error');
                }
            });
            items = $(area).find('[data-required]').removeClass('sb-error');
            items.each(function () {
                if (SBF.null($(this).attr('data-value'))) {
                    $(this).addClass('sb-error');
                    errors = true;
                }
            });
            return errors;
        },

        // Display a error message
        showErrorMessage: function (area, message) {
            $(area).find('.sb-info').html(sb_(message)).sbActive(true);
            clearTimeout(timeout);
            timeout = setTimeout(function () {
                $(area).find('.sb-info').sbActive(false);
            }, 7000);
        },

        // Display a success message
        showSuccessMessage: function (area, message) {
            $(area).find('.sb-info').remove();
            $(area).addClass('sb-success').find('.sb-content').html(`<div class="sb-text">${message}</div>`);
        },

        // Return the registration error message
        getRegistrationErrorMessage(area_or_response, type = 'validation') {
            let error_text = '';
            if (type == 'response') {
                return SBF.errorValidation(area_or_response, 'duplicate-email') ? 'This email is already in use. Please use another email.' : (SBF.errorValidation(area_or_response, 'duplicate-phone') ? 'This phone number is already in use. Please use another number.' : (SBF.errorValidation(area_or_response, 'invalid-envato-purchase-code') ? 'Invalid Envato purchase code.' : (SBF.errorValidation(area_or_response, 'invalid-otp') ? 'Invalid one-time code.' : 'Error. Please check your information and try again.')))
            }
            $(area_or_response).find('.sb-input:not(#password-check) [required]').each(function () {
                error_text += ', ' + $(this).closest('.sb-input').find('span').html() + ($(this).attr('type') == 'password' ? ' (' + sb_('8 characters minimum') + ')' : '');
            });
            return `${error_text.substring(2)} ${sb_((error_text.includes(',') ? 'are' : 'is') + ' required.')}`;
        }
    }
    window.SBForm = SBForm;

    /* 
    * ----------------------------------------------------------
    * APPS
    * ----------------------------------------------------------
    */

    var SBApps = {

        // Get the login data 
        login: function () {
            if (typeof SB_DEFAULT_USER != ND && SB_DEFAULT_USER) {
                return [SB_DEFAULT_USER, 'default'];
            }
            if (this.is('wp') && typeof SB_WP_ACTIVE_USER != ND && CHAT_SETTINGS.wp_users_system == 'wp') {
                return [[SB_WP_ACTIVE_USER, typeof SB_WP_AVATAR != ND ? SB_WP_AVATAR : ''], 'wp'];
            }
            if (typeof SB_SHOPIFY_ACTIVE_USER != ND) {
                return [SB_SHOPIFY_ACTIVE_USER, 'shopify'];
            }
            if (typeof SB_PERFEX_ACTIVE_USER != ND) {
                return [[SB_PERFEX_ACTIVE_USER, SB_PERFEX_CONTACT_ID], 'perfex'];
            }
            if (typeof SB_WHMCS_ACTIVE_USER != ND) {
                return [SB_WHMCS_ACTIVE_USER, 'whmcs'];
            }
            if (typeof SB_AECOMMERCE_ACTIVE_USER != ND) {
                return [SB_AECOMMERCE_ACTIVE_USER, 'aecommerce'];
            }
            return false;
        },

        // Check if an app is installed and active
        is: function (name) {
            if (admin) return SBAdmin.apps.is(name);
            if (name == 'wordpress' || name == 'wp') return CHAT_SETTINGS.wp;
            return name in CHAT_SETTINGS ? CHAT_SETTINGS[name] : false;
        },

        shopify: {

            startCartSynchronization: function () {
                setInterval(() => {
                    if (activeUser()) {
                        fetch('/cart.js').then((response) => response.json()).then((cart) => {
                            cart = {
                                total: cart.total_price,
                                currency: cart.currency,
                                items: cart.items.map(item => ({
                                    id: item.product_id,
                                    price: item.price,
                                    handle: item.handle,
                                    title: item.title,
                                    quantity: item.quantity
                                }))
                            };
                            let cart_string = JSON.stringify(cart);
                            if (storage('shopify-cart') != cart_string) {
                                storage('shopify-cart', cart_string);
                                SBF.ajax({
                                    function: 'shopify-cart-sync',
                                    cart: cart
                                });
                            }
                        });
                    }
                }, 10000);
            }
        },

        wordpress: {

            ajax: function (action, data, onSuccess = false) {
                if (typeof SB_WP_AJAX_URL == ND) return;
                $.ajax({
                    method: 'POST',
                    url: SB_WP_AJAX_URL,
                    data: $.extend({ action: 'sb_wp_ajax', type: action }, data)
                }).done((response) => {
                    if (onSuccess) {
                        onSuccess(response);
                    }
                });
            }
        },

        woocommerce: {

            // Update the cart
            updateCart: function (action, product_id, onSuccess = false) {
                SBApps.wordpress.ajax(action, { product_id: product_id }, onSuccess);
            },

            // Waiting list
            waitingList: function (action = 'request', product_id = false) {
                if (typeof SB_WP_WAITING_LIST !== ND && (action != 'request' || SB_WP_WAITING_LIST && SBF.storageTime('waiting-list-' + SB_WP_PAGE_ID, 24)) && activeUser()) {
                    SBF.ajax({
                        function: 'woocommerce-waiting-list',
                        product_id: product_id === false ? SB_WP_PAGE_ID : product_id,
                        conversation_id: SBChat.conversation.id,
                        action: action,
                        token: this.token
                    }, (response) => {
                        if (response) {
                            SBF.storageTime('waiting-list-' + SB_WP_PAGE_ID);
                            if (action == 'request' && (!SBChat.chat_open || SBChat.dashboard)) {
                                SBChat.updateConversations();
                            }
                        }
                    });
                }
            }
        },

        dialogflow: {
            token: storage('dialogflow-token'),
            typing_enabled: true,
            project_id: false,
            busy: false,

            message: function (message = '', attachments = [], delay = false, parameters = false, audio = false) {
                if (message.length < 2 && !attachments.length) {
                    return;
                }
                if (!audio) {
                    for (var i = 0; i < attachments.length; i++) {
                        if (attachments[i][0].includes('voice_message')) {
                            audio = attachments[i][1];
                        }
                    }
                }
                if (this.active(true, true, false)) {
                    let human_takeover_active = SBApps.dialogflow.humanTakeoverActive();
                    if (!human_takeover_active || this.typing_enabled) {
                        this.typing();
                    }
                    if (this.chatbotLimit()) {
                        return SBChat.sendMessage(bot_id, this.chatbotLimit());
                    }
                    SBChat.headerAgent(true);
                    setTimeout(() => {
                        let conversation = SBChat.conversation;
                        SBF.ajax({
                            function: 'dialogflow-message',
                            conversation_id: conversation ? conversation.id : false,
                            message: message,
                            attachments: attachments,
                            parameters: parameters,
                            token: this.token,
                            dialogflow_language: storage('dialogflow-language') ? storage('dialogflow-language') : SB_LANG,
                            project_id: this.project_id,
                            session_id: activeUser().id + '-' + conversation.id,
                            audio: audio
                        }, (response) => {
                            SBChat.typing(-1, 'stop');
                            if (response === false) {
                                return;
                            }
                            if (response.response && response.response.error) {
                                return console.error(response.response);
                            }
                            if (response.human_takeover) {
                                SBChat.offlineMessage();
                                SBChat.followUp();
                                return this.active(false);
                            }
                            if (response.language_detection && !storage('dialogflow-language')) {
                                storage('dialogflow-language', [response.language_detection]);
                            }
                            if (response.user_language && !storage('dialogflow-language')) {
                                activeUser().setExtra('language', response.user_language);
                            }
                            if (response.translations) {
                                CHAT_SETTINGS.translations = response.translations;
                            }
                            if (!SBF.errorValidation(response)) {
                                let query_result = response.response.queryResult ? response.response.queryResult : false;
                                let is_unknow = query_result && (query_result.action == 'input.unknown' || (query_result.match && query_result.match.matchType == 'NO_MATCH'));
                                let messages = response.messages && Array.isArray(response.messages) ? response.messages : [];
                                clearTimeout(timeout);
                                if (this.token != response.token) {
                                    this.token = response.token;
                                    storage('dialogflow-token', response.token);
                                }
                                if (is_unknow) {
                                    if (human_takeover_active) {
                                        this.typing_enabled = false;
                                    }
                                } else {
                                    this.typing_enabled = true;
                                }
                                if (query_result) {

                                    // Actions
                                    if (query_result.action) {
                                        let action = query_result.action;
                                        if (action == 'end') {
                                            this.active(false);
                                        }
                                        SBF.event('SBBotAction', action);
                                    }

                                    // Payload
                                    for (var i = 0; i < messages.length; i++) {
                                        if (messages[i].payload) {
                                            let payloads = ['human-takeover', 'redirect', 'woocommerce-update-cart', 'woocommerce-checkout', 'open-article', 'transcript', 'department', 'agent', 'send-email', 'rich-message', 'tags'];
                                            let payload = messages[i].payload;
                                            if (SBF.null(payload)) {
                                                payload = [];
                                            }
                                            if (payloads[0] in payload && payload[payloads[0]] === true) {
                                                this.humanTakeover();
                                            }
                                            if (payloads[1] in payload) {
                                                setTimeout(function () {
                                                    payload['new-window'] ? window.open(payload[payloads[1]]) : document.location = payload[payloads[1]];
                                                }, 500);
                                            }
                                            if (payloads[2] in payload) {
                                                let payload_value = payload[payloads[2]];
                                                SBApps.woocommerce.updateCart(payload_value[0], payload_value[1], (response) => {
                                                    if (response) {
                                                        SBF.event('SBWoocommerceCartUpdated', { 'action': payload_value[0], 'product': payload_value[1] });
                                                    }
                                                });
                                            }
                                            if (payloads[3] in payload && payload[payloads[3]] === true) {
                                                SBApps.wordpress.ajax('url', { url_name: 'checkout' }, (response) => {
                                                    setTimeout(() => document.location = response, 500);
                                                });
                                            }
                                            if (payloads[4] in payload) {
                                                SBChat.showArticles(payload[payloads[4]]);
                                            }
                                            if (payloads[5] in payload && payload[payloads[5]]) {
                                                SBF.ajax({
                                                    function: 'transcript',
                                                    conversation_id: conversation.id,
                                                    type: 'txt'
                                                }, (response) => {
                                                    if (payload[payloads[5]] == 'email' && activeUser().email) {
                                                        SBChat.sendEmail(payload.message ? payload.message : '', [[response, response]], conversation.id);
                                                    } else window.open(response);
                                                });
                                            }
                                            if (payloads[6] in payload) {
                                                SBF.ajax({
                                                    function: 'update-conversation-department',
                                                    conversation_id: conversation.id,
                                                    department: payload[payloads[6]],
                                                    message: conversation.getLastUserMessage().message
                                                });
                                            }
                                            if (payloads[7] in payload) {
                                                SBF.ajax({
                                                    function: 'update-conversation-agent',
                                                    conversation_id: conversation.id,
                                                    agent_id: payload[payloads[7]],
                                                    message: conversation.getLastUserMessage().message
                                                });
                                            }
                                            if (payloads[8] in payload) {
                                                let email = payload[payloads[8]];
                                                SBChat.sendEmail(email.message, email.attachments, email.recipient == 'active_user');
                                            }
                                            if (payloads[9] in payload) {
                                                SBChat.sendMessage(bot_id, payload[payloads[10]]);
                                            }
                                            if (payloads[10] in payload) {
                                                SBF.ajax({
                                                    function: 'update-tags',
                                                    conversation_id: conversation.id,
                                                    tags: payload[payloads[11]]
                                                });
                                            }
                                            SBF.event('SBBotPayload', payload);
                                        }

                                        // More
                                        this.chatbotLimit(false);
                                        if (!storage('dialogflow-language') && query_result.languageCode && (!SB_LANG || query_result.languageCode != SB_LANG[0])) {
                                            storage('dialogflow-language', [query_result.languageCode]);
                                        }
                                    }

                                    // Diagnostic info
                                    if (query_result.diagnosticInfo) {
                                        let info = query_result.diagnosticInfo;

                                        // End conversation
                                        if (info.end_conversation) {
                                            this.active(false);
                                        }
                                    }
                                }

                                // Slack
                                if (CHAT_SETTINGS.slack_active && messages && (!dialogflow_human_takeover || human_takeover_active)) {
                                    for (var i = 0; i < messages.length; i++) {
                                        SBChat.slackMessage(activeUser().id, CHAT_SETTINGS.bot_name, CHAT_SETTINGS.bot_image, messages[i].message, messages[i].attachments);
                                    }
                                }

                                SBF.event('SBBotMessage', { response: response, message: message });
                            }
                        });
                        this.busy = true;
                    }, delay !== false ? delay : (CHAT_SETTINGS.bot_delay == 0 ? 2000 : parseInt(CHAT_SETTINGS.bot_delay)));
                } else if (this.active(true, false, true) && !$('.sb-emoji-list').html().includes('<li>' + message + '</li>')) {
                    this.openAI(message, false, audio, attachments);
                }
            },

            openAI: function (message, onSuccess = false, audio = false, attachments = []) {
                if (CHAT_SETTINGS.open_ai_active) {
                    SBChat.headerAgent(true);
                    if (SBChat.agent_id == bot_id && (!SBApps.dialogflow.humanTakeoverActive() || this.typing_enabled)) {
                        this.typing();
                    }
                    if (this.chatbotLimit()) {
                        return SBChat.sendMessage(bot_id, this.chatbotLimit());
                    }
                    setTimeout(() => {
                        SBF.ajax({
                            function: 'open-ai-message',
                            message: message,
                            conversation_id: SBChat.conversation ? SBChat.conversation.id : false,
                            audio: audio,
                            extra: { token: SBApps.dialogflow.token },
                            attachments: attachments,
                            context: CHAT_SETTINGS.open_ai_context_awareness ? document.title.toUpperCase() + '\n\n\n' + $('meta[name="description"]').attr('content') || '' : false
                        }, (response) => {
                            this.busy = false;
                            SBChat.typing(-1, 'stop');
                            SBF.event('SBOpenAIMessage', { response: response, message: message });
                            if (response && (response[0] || response[5])) {
                                if (CHAT_SETTINGS.chatbot_limit) {
                                    this.chatbot_limit++;
                                }
                                if (CHAT_SETTINGS.slack_active && message && (!dialogflow_human_takeover || SBApps.dialogflow.humanTakeoverActive())) {
                                    SBChat.slackMessage(activeUser().id, CHAT_SETTINGS.bot_name, CHAT_SETTINGS.bot_image, response[1]);
                                }
                                if (response[2] && SBApps.dialogflow.token != response[2]) {
                                    SBApps.dialogflow.token = response.token;
                                    storage('dialogflow-token', response.token);
                                }
                                if (response[3]) {
                                    SBChat.offlineMessage();
                                    SBChat.followUp();
                                }

                                // Payload
                                if (response[5]) {
                                    if (response[5].redirect) {
                                        setTimeout(() => {
                                            document.location = response[5].redirect;
                                        }, 500);
                                    }
                                    if (response[5].open_article) {
                                        SBChat.showArticles(response[5].open_article);
                                    }

                                    if (response[5].event == 'conversation-status-update-3') {
                                        SBChat.conversationArchived();
                                    }
                                }
                                this.chatbotLimit(false);
                            } else if (response[1] !== false) {
                                SBF.error(response[1].error ? response[1].error.message : response[1], 'SBApps.dialogflow.openAI');
                            }
                            if (onSuccess) {
                                onSuccess(response);
                            }
                        });
                        this.busy = true;
                    }, CHAT_SETTINGS.bot_delay == 0 ? 2000 : parseInt(CHAT_SETTINGS.bot_delay));
                }
            },

            flowOnLoad() {
                if (CHAT_SETTINGS.flow_on_load && !storage('flow-on-load') && activeUser()) {
                    if (SBChat.conversation) {
                        SBF.ajax({
                            function: 'run-flow-on-load',
                            message: CHAT_SETTINGS.flow_on_load,
                            conversation_id: SBChat.conversation.id
                        });
                    } else {
                        SBChat.newConversation(3, activeUser().id, '', [], null, null, () => {
                            SBF.ajax({
                                function: 'run-flow-on-load',
                                message: CHAT_SETTINGS.flow_on_load,
                                conversation_id: SBChat.conversation.id
                            });
                        });
                    }
                    storage('flow-on-load', true);
                }
            },

            typing: function () {
                clearTimeout(timeout_typing);
                timeout_typing = setTimeout(() => {
                    SBChat.typing(-1, 'start');
                }, 1000);
            },

            active: function (active = true, check_dialogflow = true, check_open_ai = true) {
                if (active === false) {
                    SBChat.conversation.set('is_human_takeover', true);
                    return false;
                }
                if (active == 'activate') {
                    SBChat.conversation.set('is_human_takeover', false);
                }
                if (!admin && SBApps.dialogflow.humanTakeoverActive() && CHAT_SETTINGS.dialogflow_human_takeover_disable_chatbot) {
                    return false;
                }
                let check = !admin && (!SBChat.conversation || !SBApps.dialogflow.humanTakeoverActive() || !SBChat.agent_online) && (!CHAT_SETTINGS.dialogflow_office_hours || !CHAT_SETTINGS.office_hours);
                if (check_dialogflow && check_open_ai) {
                    return (CHAT_SETTINGS.dialogflow_active || CHAT_SETTINGS.open_ai_active) && check;
                }
                return (!check_dialogflow || CHAT_SETTINGS.dialogflow_active) && (!check_open_ai || CHAT_SETTINGS.open_ai_active) && check;
            },

            welcome: function (open = false, sound = false) {
                SBF.ajax({
                    function: 'dialogflow-message',
                    message: '',
                    conversation_id: SBChat.conversation.id,
                    token: this.token,
                    event: 'Welcome',
                    dialogflow_language: storage('dialogflow-language') ? storage('dialogflow-language') : SB_LANG
                }, () => {
                    if (open) {
                        SBChat.start();
                    }
                    if (sound) {
                        SBChat.audio.play();
                    }
                });
            },

            humanTakeover: function () {
                SBF.ajax({
                    function: 'dialogflow-human-takeover',
                    conversation_id: SBChat.conversation.id
                }, () => {
                    SBChat.offlineMessage();
                    SBChat.followUp();
                    this.active(false);
                    if (CHAT_SETTINGS.queue_human_takeover) {
                        CHAT_SETTINGS.queue = true;
                        SBChat.queue(SBChat.conversation.id);
                    }
                });
            },

            humanTakeoverActive: function () {
                return SBChat.conversation ? SBChat.conversation.get('is_human_takeover') : false;
            },

            translate: function (strings, language_code, onSuccess, message_ids, conversation_id) {
                SBF.ajax({
                    function: 'google-translate',
                    strings: strings,
                    language_code: language_code,
                    token: this.token,
                    message_ids: message_ids,
                    conversation_id: conversation_id
                }, (response) => {
                    this.token = response[1]
                    onSuccess(response[0]);
                });
            },

            chatbotLimit: function (check = true) {
                if (CHAT_SETTINGS.chatbot_limit) {
                    let chatbot_limit = storage('chatbot_limit');
                    let now = (new Date()).getTime() / 1000;
                    if (!chatbot_limit) {
                        chatbot_limit = [];
                    }
                    if (check) {
                        let interval = now - CHAT_SETTINGS.chatbot_limit.interval;
                        let chatbot_limit_new = [];
                        for (var i = 0; i < chatbot_limit.length; i++) {
                            if (chatbot_limit[i] > interval) {
                                chatbot_limit_new.push(chatbot_limit[i]);
                            }
                        }
                        storage('chatbot_limit', chatbot_limit_new);
                        if (chatbot_limit_new.length >= CHAT_SETTINGS.chatbot_limit.quota) {
                            return CHAT_SETTINGS.chatbot_limit.message;
                        }
                    } else {
                        chatbot_limit.push(now);
                        storage('chatbot_limit', chatbot_limit);
                    }
                }
                return false;
            }
        },

        aecommerce: {

            cart: function () {
                if (SBApps.is('aecommerce') && typeof SB_AECOMMERCE_CART != ND && typeof SB_AECOMMERCE_ACTIVE_USER != ND && storage('aecommerce') != JSON.stringify(SB_AECOMMERCE_CART)) {
                    SBF.ajax({
                        function: 'aecommerce-cart',
                        cart: SB_AECOMMERCE_CART
                    }, () => {
                        storage('aecommerce', JSON.stringify(SB_AECOMMERCE_CART));
                    });
                }
            }
        },

        martfury: {

            privateChat: function () {
                let store = $('#tab-vendor > h4,.ps-product__vendor > a');
                if (store.length) {
                    store = store.html().toLowerCase();
                    for (var i = 0; i < CHAT_SETTINGS.martfury.length; i++) {
                        if (store == CHAT_SETTINGS.martfury[i]['martfury-linking-store'].toLowerCase()) {
                            let agent_id = CHAT_SETTINGS.martfury[i]['martfury-linking-agent'];
                            let conversations = SBF.activeUser() ? SBF.activeUser().conversations : [];
                            SBChat.default_agent = agent_id;
                            for (var j = 0; j < conversations.length; j++) {
                                if (conversations[j].get('agent_id') == agent_id) {
                                    SBChat.openConversation(conversations[j].id);
                                    return;
                                }
                            }
                            SBChat.clear();
                            SBChat.hideDashboard();
                        }
                    }
                }
            }
        }
    }
    window.SBApps = SBApps;

    /*
    * ----------------------------------------------------------
    * INIT
    * ----------------------------------------------------------
    */

    $(document).ready(function () {
        main = $('.sb-admin, .sb-admin-start');
        if (main.length) {
            admin = true;
            initialize();
            return;
        }
        let url_full;
        let url;
        let init = false;
        if (typeof SB_INIT_URL != ND) {
            if (SB_INIT_URL.indexOf('.js') < 0) {
                SB_INIT_URL += '/js/main.js?v=' + version;
            }
            url_full = SB_INIT_URL;
        } else {
            let scripts = document.getElementsByTagName('script');
            let checks = ['init.js', 'main.js', 'min/init.min.js', 'min/main.min.js'];
            for (var i = 0; i < scripts.length; i++) {
                let source = scripts[i].src;
                if (scripts[i].id == 'sbinit') {
                    url_full = source;
                    init = init ? init : url_full.includes('init.');
                    break;
                } else {
                    for (var j = 0; j < checks.length; j++) {
                        if (source && source.includes('/supportboard/js/' + checks[j])) {
                            url_full = source;
                            init = init ? init : url_full.includes('init.');
                            break;
                        }
                    }
                }
            }
        }
        let parameters = SBF.getURL(false, url_full);
        if (parameters.url) {
            url_full = parameters.url;
        }
        if (typeof SB_DISABLED != ND && SB_DISABLED) {
            return;
        }
        if (init) {
            initialize();
            return;
        }
        if (typeof SB_TICKETS != ND || (parameters.mode == 'tickets')) {
            tickets = true;
            parameters.mode = 'tickets';
        }
        if (parameters.cloud) {
            cloud_data = parameters.cloud;
        }
        let lang_optional = is_shopify && Shopify.locale != 'en' ? Shopify.locale : false;
        let min = url_full.lastIndexOf('main.min.js');
        url = url_full.substr(0, url_full.lastIndexOf('main.js') > 0 ? (url_full.lastIndexOf('main.js') - 4) : (min - 8));
        let url_chat = url + '/include/init.php' + (parameters.lang ? '?lang=' + parameters.lang : '') + (lang_optional ? '?lang_optional=' + lang_optional : '') + (parameters.mode ? '&mode=' + parameters.mode : '') + (cloud_data ? '&cloud=' + cloud_data : '');
        SBF.cors('GET', url_chat.replace('.php&', '.php?'), (response) => {
            let target = 'body';
            if (tickets && $('#sb-tickets').length) {
                target = '#sb-tickets';
            }
            $(target).append(response);
            SBF.loadResource(url + '/css/' + (tickets ? 'tickets' : 'main') + '.css');
            if (tickets) {
                min = 0;
                SBF.loadResource(url + '/apps/tickets/tickets' + (min > 0 ? '.min' : '') + '.js?v=' + version, true, () => {
                    initialize();
                });
            } else {
                initialize();
            }
            if (parameters.lang) {
                SB_LANG = [parameters.lang, admin ? 'admin' : 'front'];
            }
        });
    });

    function initialize() {
        main = $('.sb-admin, .sb-chat, .sb-tickets');

        // Initialize the chat and the user
        if (main.length && typeof SB_AJAX_URL != ND) {
            chat = main.find('.sb-list').eq(0);
            chat_editor = main.find('.sb-editor');
            chat_textarea = chat_editor.find('textarea');
            chat_scroll_area = main.find(admin || tickets ? '.sb-list' : '> div > .sb-scroll-area');
            chat_header = chat_scroll_area.find('.sb-header');
            chat_emoji = chat_editor.find('.sb-emoji');
            chat_overlay_panel = main.find('.sb-overlay-panel');
            chat_status = tickets ? main.find('.sb-profile-agent .sb-status') : null;
            SBChat.enabledAutoExpand();
            SBChat.audio = main.find('#sb-audio').get(0);
            SBChat.label_date = main.find('.sb-label-date-top');

            // Check if cookies works
            SBF.cookie('sb-check', 'ok', 1, 'set');
            if (SBF.cookie('sb-check') != 'ok') {
                cookies_supported = false;
                console.warn('Support Board: cookies not available.');
            } else {
                SBF.cookie('sb-check', false, false, false);
            }
            if (!admin) {
                SBF.ajax({
                    function: 'get-front-settings',
                    current_url: window.location.href,
                    tickets: tickets,
                    popup: !storage('popup') && !tickets
                }, (response) => {
                    CHAT_SETTINGS = response;
                    if (typeof SB_LOCAL_SETTINGS != ND) {
                        $.extend(CHAT_SETTINGS, SB_LOCAL_SETTINGS);
                    }
                    bot_id = CHAT_SETTINGS.bot_id;
                    dialogflow_human_takeover = CHAT_SETTINGS.dialogflow_human_takeover;
                    agents_online = CHAT_SETTINGS.agents_online;
                    SBPusher.active = CHAT_SETTINGS.pusher;
                    if (CHAT_SETTINGS.language) {
                        SB_LANG = CHAT_SETTINGS.language != 'auto' ? [CHAT_SETTINGS.language, 'front'] : (is_shopify && Shopify.locale != 'en' ? Shopify.locale : false);
                    }
                    if (typeof SB_REGISTRATION_REQUIRED != ND) {
                        CHAT_SETTINGS.registration_required = SB_REGISTRATION_REQUIRED;
                        CHAT_SETTINGS.tickets_registration_required = SB_REGISTRATION_REQUIRED;
                    }
                    if (typeof SB_ARTICLES_PAGE != ND && SB_ARTICLES_PAGE) {
                        SBChat.automations.runAll();
                        SBChat.initArticlesPage();
                    }
                    if ((!tickets || !CHAT_SETTINGS.tickets_manual_init) && ((tickets && !CHAT_SETTINGS.tickets_manual_init) || (!CHAT_SETTINGS.chat_manual_init && (!CHAT_SETTINGS.disable_offline || agents_online) && (!CHAT_SETTINGS.disable_office_hours || CHAT_SETTINGS.office_hours) && (!CHAT_SETTINGS.chat_login_init || SBApps.login())))) {
                        SBChat.initChat();
                    }
                    if (CHAT_SETTINGS.cron) {
                        setTimeout(function () {
                            SBF.ajax({ function: 'cron-jobs' });
                        }, 10000);
                    }
                    if (CHAT_SETTINGS.cron_email_piping) {
                        setTimeout(function () {
                            SBF.ajax({ function: 'email-piping' });
                        }, 8000);
                    }
                    if (CHAT_SETTINGS.push_notifications_users) {
                        SBF.serviceWorker.init();
                    }
                    if (tickets) {
                        if (CHAT_SETTINGS.tickets_default_department) {
                            SBChat.default_department = CHAT_SETTINGS.tickets_default_department;
                        }
                        if (CHAT_SETTINGS.dialogflow_disable_tickets) {
                            CHAT_SETTINGS.dialogflow_active = false;
                            CHAT_SETTINGS.open_ai_active = false;
                        }
                    }
                    if (SBApps.is('martfury')) {
                        let session = false;
                        setInterval(function () {
                            if (activeUser()) {
                                let current = SBF.cookie('XSRF-TOKEN');
                                if (current && current != session) {
                                    SBF.ajax({ function: 'martfury-session' });
                                    session = current;
                                }
                            }
                        }, 3000);
                    }
                    if (is_shopify) {
                        SBApps.shopify.startCartSynchronization();
                        main.addClass('sb-shopify');
                    }
                    setAudio();
                    SBApps.aecommerce.cart();
                    setTimeout(() => {
                        SBF.event('SBReady');
                    }, 500);
                });
            } else {
                setAudio();
                SBF.event('SBReady');
            }
            $(chat_editor).on('keydown', 'textarea', function (e) {
                if (e.which == 13 && (!tickets || CHAT_SETTINGS.tickets_enter_button) && !mobile && !e.ctrlKey && !e.shiftKey) {
                    SBChat.submit();
                    e.preventDefault;
                    return false;
                }
                if (admin && e.which == 13 && e.ctrlKey) {
                    SBChat.insertText('\n');
                }
            });
            $(main).on('keydown', '.sb-dashboard-articles input', function (e) {
                if (e.which == 13) {
                    $(this).next().click();
                }
            });
            if (typeof SB_DEFAULT_DEPARTMENT !== ND) {
                SBChat.default_department = SB_DEFAULT_DEPARTMENT;
            }
            if (typeof SB_DEFAULT_AGENT !== ND) {
                SBChat.default_agent = SB_DEFAULT_AGENT;
            }
            if (typeof SB_DIALOGFLOW_TAGS !== ND) {
                SBChat.default_tags = SB_DEFAULT_TAGS;
            }
            if (typeof SB_DIALOGFLOW_AGENT !== ND) {
                SBApps.dialogflow.project_id = SB_DIALOGFLOW_AGENT;
            }
        } else {
            SBF.event('SBReady');
        }

        // Disable real-time if browser tab not active
        document.addEventListener('visibilitychange', function () {
            SBF.visibilityChange(document.visibilityState);
        }, false);

        $(main).on('click', function () {
            if (!SBChat.tab_active) {
                SBF.visibilityChange();
            }
        });

        // Set the global container for both admin and front
        global = main;
        if (admin) {
            main = main.find('.sb-conversation');
        }

        // Scroll detection
        $(chat_scroll_area).on('scroll', function () {
            let scroll = chat_scroll_area.scrollTop();
            let count = label_date_items.length;
            SBChat.scrollHeader();
            if (!SBChat.label_date_show && count && label_date_items[count - 1].getBoundingClientRect().top > (chat[0].getBoundingClientRect().top + chat.outerHeight())) {
                SBChat.label_date_show = true;
                if (count > 1) {
                    SBChat.label_date.html($(label_date_items[count - 2]).html());
                }
            }
            if (SBChat.label_date_show) {
                SBChat.label_date.sbActive(true);
                clearTimeout(label_date_timeout[0]);
                label_date_timeout[0] = setTimeout(() => { SBChat.label_date.sbActive(false) }, 1500);
            }
            if (count) {
                if (SBChat.isBottom()) {
                    SBChat.label_date.html($(label_date_items[count - 1]).html());
                    SBChat.label_date_show = label_date_items.length && label_date_items[label_date_items.length - 1].getBoundingClientRect().top < 0;
                } else {
                    let label_date_top = SBChat.label_date[0].getBoundingClientRect().top;
                    for (var i = 0; i < count; i++) {
                        let top = label_date_items[i].getBoundingClientRect().top;
                        if ((top - 100) < label_date_top && (top + 100) > label_date_top) {
                            let label = $(label_date_items[label_date_history[0] > scroll && i > 0 ? i - 1 : i]).html();
                            if (label != label_date_history[1]) {
                                SBChat.label_date.html(label);
                                label_date_history[1] = label;
                            }
                            break;
                        }
                    }
                }
            }
            label_date_history[0] = scroll;
        });

        // Show the message menu
        $(chat).on('click', '.sb-menu-btn', function () {
            let menu = $(this).parent().find('.sb-menu');
            let active = $(menu).sbActive();
            SBF.deactivateAll();
            if (!active) {
                $(menu).sbActive(true);
                SBF.deselectAll();
                if (admin) SBAdmin.open_popup = menu;
            }
        });

        // Mobile
        if (mobile) {
            $(chat_editor).on('click', '.sb-textarea', function () {
                main.addClass('sb-header-hidden');
                $(this).find('textarea').get(0).focus();
                if (SBChat.isBottom()) {
                    SBChat.scrollBottom();
                    setTimeout(() => {
                        SBChat.scrollBottom();
                    }, 200);
                }
            });

            $(chat_editor).on('focusout', '.sb-textarea', function () {
                setTimeout(() => {
                    main.removeClass('sb-header-hidden');
                }, 300);
            });

            $(chat_editor).on('click', '.sb-submit', function () {
                chat_textarea.blur();
            });

            window.addEventListener('popstate', function () {
                if (SBChat.chat_open) {
                    SBChat.open(false);
                }
            });
        }

        // Hide the message menu
        $(chat).on('click', '.sb-menu li', function () {
            $(this).parent().sbActive(false);
        });

        // Send a message
        $(chat_editor).on('click', '.sb-submit', function () {
            SBChat.submit();
        });

        // Open the chat
        $('body').on('click', '.sb-chat-btn,.sb-responsive-close-btn, #sb-open-chat, .sb-open-chat', function () {
            SBChat.open(!SBChat.chat_open);
        });

        // Show the dashboard
        $(main).on('click', '.sb-dashboard-btn', function () {
            SBChat.showDashboard();
            if (chat_scroll_area.find(' > .sb-panel-articles > .sb-article').length) {
                SBChat.showArticles();
            }
            storage('open-conversation', 0);
            force_action = false;
        });

        // Open a conversation from the dashboard
        $(main).on('click', '.sb-user-conversations li', function () {
            SBChat.openConversation($(this).attr('data-conversation-id'));
        });

        // Start a new conversation from the dashboard
        $(main).on('click', '.sb-btn-new-conversation, .sb-departments-list > div, .sb-agents-list > div', function () {
            let id = $(this).data('id');
            let existing_conversation = false;
            if (!SBF.null(id)) {
                let is_departments = $(this).parent().hasClass('sb-departments-list');
                if (is_departments) {
                    SBChat.default_department = parseInt(id);
                } else {
                    SBChat.default_agent = parseInt(id);
                }
                if ($(this).parent().data('force-one')) {
                    let converstations = activeUser() ? activeUser().conversations : [];
                    for (var i = 0; i < converstations.length; i++) {
                        if ((is_departments && converstations[i].get('department') == id) || (!is_departments && converstations[i].get('agent_id') == id)) {
                            existing_conversation = true;
                            SBChat.openConversation(converstations[i].id);
                            break;
                        }
                    }
                }
            }
            if (!existing_conversation) {
                force_action = 'new-conversation';
                SBChat.clear();
                SBChat.hideDashboard();
            }
        });

        // Displays all conversations in the dashboard
        $(main).on('click', '.sb-btn-all-conversations', function () {
            main.find('.sb-dashboard-conversations').removeClass('sb-conversations-hidden');
        });

        // Events uploader
        $(chat_editor).on('click', '.sb-btn-attachment', function () {
            if (!SBChat.is_busy) {
                chat_editor.find('.sb-upload-files').val('').click();
            }
        });

        $(chat_editor).on('click', '.sb-attachments > div > i', function (e) {
            $(this).parent().remove();
            if (!chat_textarea.val() && chat_editor.find('.sb-attachments > div').length == 0) {
                chat_editor.sbActive(false);
            }
            e.preventDefault();
            return false;
        });

        $(chat_editor).on('change', '.sb-upload-files', function (data) {
            SBChat.busy(true);
            $(this).sbUploadFiles(function (response) {
                SBChat.uploadResponse(response);
            });
            SBF.event('SBAttachments');
        });

        $(chat_editor).on('dragover', function (e) {
            $(this).addClass('sb-drag');
            clearTimeout(timeout);
            e.preventDefault();
            e.stopPropagation();
        });

        $(chat_editor).on('dragleave', function (e) {
            timeout = setTimeout(() => {
                $(this).removeClass('sb-drag');
            }, 200);
            e.preventDefault();
            e.stopPropagation();
        });

        $(chat_editor).on('drop', function (e) {
            let files = e.originalEvent.dataTransfer.files;
            e.preventDefault();
            e.stopPropagation();
            if (files.length > 0) {
                for (var i = 0; i < files.length; ++i) {
                    let form = new FormData();
                    form.append('file', files[i]);
                    SBF.upload(form, function (response) { SBChat.uploadResponse(response) });
                }
            }
            $(this).removeClass('sb-drag');
            return false;
        });

        // Articles
        $(main).on('click', '.sb-btn-all-articles:not([onclick])', function () {
            SBChat.showArticles();
        });

        $(main).on('click', '.sb-articles > div', function () {
            SBChat.showArticles($(this).attr('data-id'), $(this).attr('data-is-category'));
        });

        $(main).on('click', '.sb-dashboard-articles .sb-input-btn .sb-submit-articles', function () {
            SBChat.searchArticles($(this).parent().find('input').val(), this, $(this).parent().next());
        });

        $(global).on('click', '.sb-article [data-rating]', function () {
            SBChat.articleRatingOnClick(this);
        });

        $(chat).on('click', '.sb-rich-button a', function (e) {
            let link = $(this).attr('href');
            if (link.indexOf('#') === 0) {
                if (link.indexOf('#article-') === 0) {
                    SBChat.showArticles(link.replace('#article-', ''));
                    e.preventDefault();
                    return false;
                }
            }
        });

        // Rating
        $(chat_overlay_panel).on('click', '[data-rating]', function () {
            let area = chat_overlay_panel.find('> div:last-child');
            let rating = $(this).attr('data-rating');
            let conversation = SBChat.conversation ? SBChat.conversation : activeUser().getLastConversation();
            let agent = conversation.getLastUserMessage(false, true);
            loading(area);
            SBF.ajax({
                function: 'set-rating',
                conversation_id: conversation.id,
                agent_id: agent ? agent.get('user_id') : false,
                user_id: activeUser().id,
                message: area.find('textarea').val(),
                rating: rating == 'positive' ? 1 : -1
            }, (response) => {
                if (chat_overlay_panel.attr('data-close-chat')) {
                    SBChat.closeChat();
                }
                SBChat.update();
                chat_overlay_panel.sbActive(false);
                area.sbLoading(false);
            });
        });

        // Lightbox
        $(global).on('click', '.sb-lightbox-media > i', function () {
            global.find('.sb-lightbox-media').sbActive(false);
            if (admin) {
                SBAdmin.open_popup = false;
            }
            return false;
        });

        $(main).on('click', '.sb-image', function () {
            SBF.lightbox($(this).html());
        });

        $(main).on('click', '.sb-slider-images .sb-card-img', function () {
            SBF.lightbox(`<img loading="lazy" src="${$(this).attr('data-value')}" />`);
        });

        // Event: on conversation loaded
        $(document).on('SBConversationLoaded', function () {
            if (storage('queue')) {
                SBChat.queue(storage('queue'));
            }
        });

        // Events emoji
        $(chat_editor).on('click', '.sb-btn-emoji', function () {
            SBChat.showEmoji(this);
        });

        $(chat_emoji).on('click', '.sb-emoji-list li', function (e) {
            SBChat.insertEmoji($(this).html());
            if (mobile) clearTimeout(timeout);
        });

        $(chat_emoji).find('.sb-emoji-list').on('touchend', function (e) {
            timeout = setTimeout(() => {
                SBChat.mouseWheelEmoji(e);
            }, 50);
        });

        $(chat_emoji).find('.sb-emoji-list').on('mousewheel DOMMouseScroll', function (e) {
            SBChat.mouseWheelEmoji(e);
        });

        $(chat_emoji).find('.sb-emoji-list').on('touchstart', function (e) {
            SBChat.emoji_options.touch = e.originalEvent.touches[0].clientY;
        });

        $(chat_emoji).on('click', '.sb-emoji-bar > div', function () {
            SBChat.clickEmojiBar(this);
        });

        $(chat_emoji).on('click', '.sb-select li', function () {
            SBChat.categoryEmoji($(this).data('value'));
        });

        $(chat_emoji).find('.sb-search-btn input').on('change keyup paste', function () {
            SBChat.searchEmoji($(this).val());
        });

        // Textarea
        $(chat_textarea).on('keyup', function () {
            SBChat.textareaChange(this);
        });

        // Privacy message
        $(main).on('click', '.sb-privacy .sb-approve', function () {
            storage('privacy-approved', true);
            $(this).closest('.sb-privacy').remove();
            main.removeClass('sb-init-form-active');
            chat_header.find(' > div').css({ opacity: 1, top: 0 });
            SBChat.initChat();
            if (tickets) {
                SBTickets.showPanel(SBF.setting('tickets_disable_first') ? '' : 'new-ticket');
            } else if (!SBChat.isInitDashboard()) {
                SBChat.hideDashboard();
            }
        });

        $(main).on('click', '.sb-privacy .sb-decline', function () {
            let privacy = $(this).closest('.sb-privacy');
            $(privacy).find('.sb-text').html($(privacy).attr('data-decline'));
            $(privacy).find('.sb-decline').remove();
            SBChat.scrollBottom(true);
        });

        // Popup message
        $(main).on('click', '.sb-popup-message .sb-icon-close', function () {
            SBChat.popup(true);
        });

        // Rich messages and inputs
        $(main).on('click', '.sb-rich-message .sb-submit,.sb-rich-message:not(.sb-rich-registration) .sb-select ul li', function () {
            let message = $(this).closest('.sb-rich-message');
            if (!message[0].hasAttribute('disabled')) {
                SBRichMessages.submit(message, message.attr('data-type'), this);
            };
        });

        $(main).on('click', '.sb-rich-message .sb-input > span', function () {
            $(this).sbActive(true);
            $(this).siblings().focus();
        });

        $(main).on('focus focusout click', '.sb-rich-message .sb-input input,.sb-rich-message .sb-input select', function (e) {
            switch (e.type) {
                case 'focusin':
                case 'focus':
                    $(this).siblings().sbActive(true);
                    break;
                case 'focusout':
                    if ($(this).val()) {
                        $(this).siblings().addClass('sb-filled sb-active');
                    } else {
                        setTimeout(() => {
                            if (!prevent_focusout) {
                                $(this).siblings().sbActive(false);
                            }
                        }, 100);
                    }
                    break;
                case 'click':
                    $(this).siblings().removeClass('sb-filled');
                    break;
            }
        });

        $(main).on('click', '.sb-input-select-input > div', function () {
            prevent_focusout = true;
            setTimeout(() => {
                prevent_focusout = false;
            }, 250);
        });

        $(main).on('click', '.sb-slider-arrow', function () {
            SBRichMessages.sliderChange($(this).closest('[id]').attr('id'), $(this).hasClass('sb-icon-arrow-right') ? 'right' : 'left');
        });

        $(main).on('change', '.sb-rich-message [data-type="select"] select', function () {
            $(this).siblings().sbActive(true);
        });

        $(main).on('click', '[data-type="select-input"] > div', function () {
            $(this).prev().sbActive(true);
            $(this).next().addClass('sb-focus');
        });

        $(main).on('focusout', '[data-type="select-input"] input,[data-type="select-input"] select', function () {
            let cnt = $(this).closest('.sb-input');
            if (cnt.find('> input').val() + cnt.find('select').val() == '') {
                cnt.find('span').sbActive(false);
            }
            cnt.find('.sb-focus').removeClass('sb-focus');
        });

        // Registration and Login
        $(main).on('click', '.sb-rich-registration .sb-login-area', function () {
            let init = main.hasClass('sb-init-form-active');
            $(this).closest('.sb-rich-registration').replaceWith(SBRichMessages.generate({}, 'login', init ? 'sb-init-form' : ''));
            SBChat.scrollBottom(init);
        });

        $(main).on('click', '.sb-rich-login .sb-registration-area', function () {
            if (CHAT_SETTINGS.registration_link) {
                document.location = CHAT_SETTINGS.registration_link;
            } else {
                let init = main.hasClass('sb-init-form-active');
                $(this).closest('.sb-rich-login').replaceWith(SBRichMessages.generate({}, 'registration', init ? 'sb-init-form' : ''));
                SBChat.scrollBottom(init);
            }
        });

        $(main).on('click', '.sb-rich-login .sb-submit-login', function () {
            SBF.loginForm(this, false, (response) => {
                let area = $(this).closest('.sb-rich-login');
                activeUser(new SBUser(response[0]));
                if (area.hasClass('sb-init-form')) {
                    force_action = 'open-conversation';
                    SBChat.initChat();
                    SBPusher.start();
                    if (!SBChat.isInitDashboard()) {
                        SBChat.hideDashboard();
                    }
                    $(document).on('SBPopulateConversations', function () {
                        main.removeClass('sb-init-form-active');
                        area.remove();
                        $(document).off('SBPopulateConversations');
                    });
                } else {
                    area = area.closest('[data-id]');
                    let message = SBChat.conversation.getMessage(area.attr('data-id'));
                    let text = `${sb_('Logged in as')} *${activeUser().name}*`;
                    message.set('message', text);
                    SBChat.updateMessage(message.id, text);
                    area.replaceWith(message.getCode());
                    SBPusher.started = false;
                    SBPusher.start();
                }
            });
        });

        // Social share buttons
        $(chat).on('click', '.sb-social-buttons div', function () {
            SBF.openWindow($(this).attr('data-link'));
        });

        // Archive chat
        $(main).on('click', '.sb-close-chat', function () {
            SBChat.closeChat();
        });

        // WooCommerce
        $(chat).on('click', '.sb-rich-woocommerce_button a, [href="#"].sb-card-btn', function (e) {
            let settings = SBF.settingsStringToArray($(this).closest('.sb-rich-message').attr('data-settings'));
            let checkout = settings['link-type'] == 'checkout' || settings.checkout;
            let product_ids = $(this)[0].hasAttribute('data-ids') ? $(this).attr('data-ids').split(',') : [settings.id.split('|')[$(this).parent().index()]];
            if (product_ids.length) {
                if (loading(this)) return;
                SBApps.wordpress.ajax('button-purchase', { product_ids: product_ids, checkout: checkout, coupon: settings.coupon }, (response) => {
                    if (checkout) {
                        document.location = response;
                    } else {
                        $(this).addClass('sb-icon-check').sbLoading(false);
                    }
                });
            }
            e.preventDefault();
            return false;
        });

        $(chat).on('click', '#sb-waiting-list .sb-submit', function () {
            if ($(this).index() == 0) {
                setTimeout(() => { SBApps.woocommerce.waitingList('submit') }, 1000);
            }
        });

        $(document).on('SBNewEmailAddress', function (e, response) {
            if (response.id == 'sb-waiting-list-email') {
                SBApps.woocommerce.waitingList('submit');
            }
        });

        // Audio player
        $(chat).on('click', '.sb-player-btn', function () {
            let audio = $(this).parent().find('audio').get(0);
            let stopped = $(this).hasClass('sb-icon-play');
            chat.find('audio').each(function () {
                $(this).get(0).pause();
                $(this).unbind('ended');
                $(this).parent().find('.sb-player-btn').removeClass('sb-icon-pause').addClass('sb-icon-play');
            });
            if (stopped) {
                audio.play();
                $(this).removeClass('sb-icon-play');
            } else {
                audio.pause();
            }
            $(audio).unbind('ended');
            $(audio).bind('ended', () => {
                $(this).removeClass('sb-icon-pause').addClass('sb-icon-play');
            });
            $(this).addClass('sb-icon-' + (stopped ? 'pause' : 'play'));
        });

        $(chat).on('click', '.sb-player-speed', function () {
            let parent = $(this).parent();
            if (parent.find('.sb-player-btn').hasClass('sb-icon-pause')) {
                let element = $(this).find('.sb-player-speed-number');
                let speed = parseFloat(element.html());
                speed += 0.5;
                if (speed > 2) {
                    speed = 1;
                }
                parent.find('audio').get(0).playbackRate = speed;
                element.html(speed);
            }
        });

        $(chat).on('click', '.sb-player-download', function () {
            window.open($(this).parent().find('audio source').attr('src'));
        });

        // Audio recording
        $(chat_editor).on('click', '.sb-btn-audio-clip', function () {
            audio_mp3 = SBChat.conversation && SBChat.conversation.get('source') == 'wa';
            if (audio_mp3 && typeof SBAudioRecorder === ND) {
                return $.getScript(SB_URL + '/vendor/lame.min.js', () => { this.click(); }, true);
            }
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                if (audio_mp3) {
                    SBAudioRecorder.init(stream);
                } else {
                    if (typeof SBAudioRecorder != ND) {
                        SBAudioRecorder.close();
                    }
                    audio_recorder_chunks = [];
                    audio_recorder = new MediaRecorder(stream);
                    audio_recorder.addEventListener('dataavailable', e => {
                        audio_recorder_chunks.push(e.data);
                    });
                }
                if (!audio_recorder_dom) {
                    audio_recorder_dom = chat_editor.find('#sb-audio-clip');
                    audio_recorder_dom_time = audio_recorder_dom.find('.sb-audio-clip-time');
                    audio_recorder_dom.on('click', '.sb-btn-mic', function () {
                        let is_pause = $(this).hasClass('sb-icon-pause');
                        if (is_pause) {
                            if (audio_mp3) {
                                SBAudioRecorder.pause();
                            } else {
                                audio_recorder.stop();
                            }
                        } else {
                            let button = audio_recorder_dom.find('.sb-btn-clip-player');
                            if (button.hasClass('sb-icon-pause')) {
                                button.click();
                            }
                            if (audio_mp3) {
                                SBAudioRecorder.resume();
                            } else {
                                audio_recorder.start();
                            }
                        }
                        audio_recorder_time[2] = !is_pause;
                        audio_recorder_dom.find('.sb-icon-play').sbActive(is_pause);
                        $(this).removeClass('sb-icon-' + (is_pause ? 'pause' : 'mic')).addClass('sb-icon-' + (is_pause ? 'mic' : 'pause'));
                    });

                    audio_recorder_dom.on('click', '.sb-btn-clip-player', function () {
                        let is_pause = $(this).hasClass('sb-icon-pause');
                        if (is_pause) {
                            audio_recorder_time_player[3].pause();
                            audio_recorder_time_player[2] = false;
                        } else {
                            if (audio_recorder_time_player[3]) {
                                audio_recorder_time_player[3].play();
                                audio_recorder_time_player[2] = true;
                            } else {
                                let audio = new Audio(URL.createObjectURL(audio_mp3 ? SBAudioRecorder.blob(false) : new Blob(audio_recorder_chunks, { type: 'audio/webm' })));
                                audio_recorder_dom_time.html('0:00');
                                audio.play();
                                audio.onended = () => {
                                    audio_recorder_time_player[0] = 0;
                                    audio_recorder_time_player[2] = false;
                                    audio_recorder_time_player[3] = false;
                                    audio_recorder_dom_time.html('0:00');
                                    $(this).removeClass('sb-icon-pause').addClass('sb-icon-play');
                                }
                                audio_recorder_time_player[0] = 0;
                                audio_recorder_time_player[2] = true;
                                audio_recorder_time_player[3] = audio;
                            }
                        }
                        $(this).removeClass('sb-icon-' + (is_pause ? 'pause' : 'play')).addClass('sb-icon-' + (is_pause ? 'play' : 'pause'));
                    });

                    audio_recorder_dom.on('click', '.sb-icon-close', function () {
                        audio_recorder_chunks = [];
                        clearInterval(audio_recorder_time[1]);
                        clearInterval(audio_recorder_time_player[1]);
                        audio_recorder_dom.sbActive(false);
                        chat_editor.sbActive(false).removeClass('sb-audio-message-active');
                        if (audio_mp3) {
                            SBAudioRecorder.pause();
                        } else {
                            audio_recorder.stop();
                        }
                        audio_recorder_stream.getTracks()[0].stop();
                    });
                }
                audio_recorder_dom_time.html('0:00');
                audio_recorder_stream = stream;
                clearInterval(audio_recorder_time[1]);
                clearInterval(audio_recorder_time_player[1]);
                audio_recorder_time = [0, setInterval(() => {
                    if (audio_recorder_time[2]) {
                        audio_recorder_time[0]++;
                        audio_recorder_dom_time.html(getMinutesSeconds(audio_recorder_time[0]));
                    }
                }, 1000), true];
                audio_recorder_time_player = [0, setInterval(() => {
                    if (audio_recorder_time_player[2]) {
                        audio_recorder_time_player[0]++;
                        audio_recorder_dom_time.html(getMinutesSeconds(audio_recorder_time_player[0]));
                    }
                }, 1000), false, false];
                if (!audio_mp3) {
                    audio_recorder.start();
                }
                audio_recorder_dom.find('.sb-btn-clip-player').removeClass('sb-icon-pause').addClass('sb-icon-play').sbActive(false);
                audio_recorder_dom.find('.sb-icon-mic').removeClass('sb-icon-mic').addClass('sb-icon-pause');
                audio_recorder_dom.sbActive(true);
                chat_textarea.val('').css('height', '');
                chat_editor.sbActive(true).addClass('sb-audio-message-active');
            }).catch(error => {
                alert(error);
            });
        });

        // Overlay panel
        $(chat).on('click', '[data-action].sb-rich-btn', function (e) {
            SBRichMessages.calendly.load($(this).attr('data-extra'), $(this).html(), $(this).closest('[data-id]').attr('data-id'));
            e.preventDefault();
            return false;
        });

        $(chat_overlay_panel).on('click', '> div:first-child i', function () {
            main.find('.sb-overlay-panel').sbActive(false);
            if (chat_overlay_panel.attr('data-close-chat')) {
                SBChat.closeChat();
            }
        });

        // Phone 
        $(main).on('change input', '#phone > input', function () {
            let value = $(this).val().trim();
            if (!/^[0-9+]+$/.test(value)) {
                value = value.replace(/[^0-9+]/g, '');
                $(this).val(value);
            }
            if (value.length > 1 && value.indexOf('+') === 0) {
                let prefix = false;
                if (value.substring(0, 2) == '+1') {
                    prefix = value.substring(0, 2);
                }
                if (value.length > 3) {
                    prefix = value.substring(0, 3);
                }
                if (prefix) {
                    $(this).parent().find(`[data-value="${prefix}"]`).click();
                    $(this).parent().find(`.sb-select`).click();
                    $(this).val(value.replace(prefix, ''));
                }
            }
        });

        /*
        * ----------------------------------------------------------
        * COMPONENTS
        * ----------------------------------------------------------
        */

        // Search
        $(global).on('click', '.sb-search-btn > i', function () {
            let parent = $(this).parent();
            let active = $(parent).sbActive();
            if (active) {
                setTimeout(() => { $(parent).find('input').val('') }, 50);
                setTimeout(() => { $(parent).find('input').trigger('change') }, 550);
            };
            $(parent).sbActive(!active);
            $(parent).find('input').get(0).focus();
            global.find('.sb-select ul').sbActive(false);
        });

        // Select
        $(global).on('click', '.sb-select', function (e) {
            if (!e.target || !$(e.target).is('input')) {
                let ul = $(this).find('ul');
                let active = ul.hasClass('sb-active');
                $(global).find('.sb-select ul').sbActive(false);
                ul.setClass('sb-active', !active);
                $(this).find('.sb-select-search').setClass('sb-active', !active);
                if (admin) {
                    SBAdmin.open_popup = active ? false : this;
                }
            }
        });

        $(global).on('click', '.sb-select li', function () {
            let select = $(this).closest('.sb-select');
            let value = $(this).data('value');
            let item = $(select).find(`[data-value="${value}"]`);
            select.find('li').sbActive(false);
            select.find('p').attr('data-value', value).html($(item).html());
            item.sbActive(true);
        });

        $(global).on('input', '.sb-select-search input', function (e) {
            let search = $(this).val();
            SBF.search(search, () => {
                let list = $(this).parent().parent().find('li');
                list.setClass('sb-hide', search.length);
                if (search.length) {
                    search = search.toLowerCase();
                    list.each(function () {
                        if ($(this).attr('data-value').includes(search) || $(this).attr('data-country').includes(search)) {
                            $(this).removeClass('sb-hide');
                        }
                    });
                }
            });
        });

        // Image uploader
        $(global).on('click', '.sb-input-image .image', function () {
            upload_target = $(this).parent();
            chat_editor.find('.sb-upload-files').click();
        });

        $(global).on('click', '.sb-input-image .image > .sb-icon-close', function (e) {
            SBF.ajax({ function: 'delete-file', path: $(this).parent().attr('data-value') });
            $(this).parent().removeAttr('data-value').css('background-image', '');
            e.preventDefault();
            return false;
        });
    }

    $('#ticketRegPass').click(function () {
        $(this).toggleClass("fa-eye fa-eye-slash");
        let input = $("#ticketRegInput");
        let currentType = input.prop('type');
        if (currentType === 'password') {
            input.prop('type', 'text');
        } else {
            input.prop('type', 'password');
        }
    });

}(jQuery));
=======
"use strict";!function(e){function t(t){return!!e(t).sbLoading()||(e(t).sbLoading(!0),!1)}function i(e,t=G){return ee.storage(e,t)}function s(e){return ee.translate(e)}function a(e=-1){if(-1===e)return window.sb_current_user;window.sb_current_user=e}function n(){let e=x?SB_ADMIN_SETTINGS.sound.volume:U.sound.volume;ne.audio&&e&&(ne.audio.volume=e)}function o(e){let t=Math.floor(e/60);return e-=60*t,(t||"0")+":"+(e<10?"0"+e:e)}function r(){(l=e(".sb-admin, .sb-chat, .sb-tickets")).length&&typeof SB_AJAX_URL!=G?(h=l.find(".sb-list").eq(0),g=l.find(".sb-editor"),p=g.find("textarea"),_=l.find(x||$?".sb-list":"> div > .sb-scroll-area"),f=_.find(".sb-header"),v=g.find(".sb-emoji"),b=l.find(".sb-overlay-panel"),m=$?l.find(".sb-profile-agent .sb-status"):null,ne.enabledAutoExpand(),ne.audio=l.find("#sb-audio").get(0),ne.label_date=l.find(".sb-label-date-top"),ee.cookie("sb-check","ok",1,"set"),"ok"!=ee.cookie("sb-check")?(F=!1,console.warn("Support Board: cookies not available.")):ee.cookie("sb-check",!1,!1,!1),x?(n(),ee.event("SBReady")):ee.ajax({function:"get-front-settings",current_url:window.location.href,tickets:$,popup:!i("popup")&&!$},t=>{if(U=t,typeof SB_LOCAL_SETTINGS!=G&&e.extend(U,SB_LOCAL_SETTINGS),y=U.bot_id,w=U.dialogflow_human_takeover,q=U.agents_online,te.active=U.pusher,U.language&&(SB_LANG="auto"!=U.language?[U.language,"front"]:!(!Z||"en"==Shopify.locale)&&Shopify.locale),typeof SB_REGISTRATION_REQUIRED!=G&&(U.registration_required=SB_REGISTRATION_REQUIRED,U.tickets_registration_required=SB_REGISTRATION_REQUIRED),typeof SB_ARTICLES_PAGE!=G&&SB_ARTICLES_PAGE&&(ne.automations.runAll(),ne.initArticlesPage()),$&&U.tickets_manual_init||(!$||U.tickets_manual_init)&&(U.chat_manual_init||U.disable_offline&&!q||U.disable_office_hours&&!U.office_hours||U.chat_login_init&&!le.login())||ne.initChat(),U.cron&&setTimeout(function(){ee.ajax({function:"cron-jobs"})},1e4),U.cron_email_piping&&setTimeout(function(){ee.ajax({function:"email-piping"})},8e3),U.push_notifications_users&&ee.serviceWorker.init(),$&&(U.tickets_default_department&&(ne.default_department=U.tickets_default_department),U.dialogflow_disable_tickets&&(U.dialogflow_active=!1,U.open_ai_active=!1)),le.is("martfury")){let e=!1;setInterval(function(){if(a()){let t=ee.cookie("XSRF-TOKEN");t&&t!=e&&(ee.ajax({function:"martfury-session"}),e=t)}},3e3)}Z&&(le.shopify.startCartSynchronization(),l.addClass("sb-shopify")),n(),le.aecommerce.cart(),setTimeout(()=>{ee.event("SBReady")},500)}),e(g).on("keydown","textarea",function(e){if(13==e.which&&(!$||U.tickets_enter_button)&&!O&&!e.ctrlKey&&!e.shiftKey)return ne.submit(),e.preventDefault,!1;x&&13==e.which&&e.ctrlKey&&ne.insertText("\n")}),e(l).on("keydown",".sb-dashboard-articles input",function(t){13==t.which&&e(this).next().click()}),typeof SB_DEFAULT_DEPARTMENT!==G&&(ne.default_department=SB_DEFAULT_DEPARTMENT),typeof SB_DEFAULT_AGENT!==G&&(ne.default_agent=SB_DEFAULT_AGENT),typeof SB_DIALOGFLOW_TAGS!==G&&(ne.default_tags=SB_DEFAULT_TAGS),typeof SB_DIALOGFLOW_AGENT!==G&&(le.dialogflow.project_id=SB_DIALOGFLOW_AGENT)):ee.event("SBReady"),document.addEventListener("visibilitychange",function(){ee.visibilityChange(document.visibilityState)},!1),e(l).on("click",function(){ne.tab_active||ee.visibilityChange()}),c=l,x&&(l=l.find(".sb-conversation")),e(_).on("scroll",function(){let t=_.scrollTop(),i=L.length;if(ne.scrollHeader(),!ne.label_date_show&&i&&L[i-1].getBoundingClientRect().top>h[0].getBoundingClientRect().top+h.outerHeight()&&(ne.label_date_show=!0,i>1&&ne.label_date.html(e(L[i-2]).html())),ne.label_date_show&&(ne.label_date.sbActive(!0),clearTimeout(N[0]),N[0]=setTimeout(()=>{ne.label_date.sbActive(!1)},1500)),i)if(ne.isBottom())ne.label_date.html(e(L[i-1]).html()),ne.label_date_show=L.length&&L[L.length-1].getBoundingClientRect().top<0;else{let a=ne.label_date[0].getBoundingClientRect().top;for(var s=0;s<i;s++){let i=L[s].getBoundingClientRect().top;if(i-100<a&&i+100>a){let i=e(L[M[0]>t&&s>0?s-1:s]).html();i!=M[1]&&(ne.label_date.html(i),M[1]=i);break}}}M[0]=t}),e(h).on("click",".sb-menu-btn",function(){let t=e(this).parent().find(".sb-menu"),i=e(t).sbActive();ee.deactivateAll(),i||(e(t).sbActive(!0),ee.deselectAll(),x&&(SBAdmin.open_popup=t))}),O&&(e(g).on("click",".sb-textarea",function(){l.addClass("sb-header-hidden"),e(this).find("textarea").get(0).focus(),ne.isBottom()&&(ne.scrollBottom(),setTimeout(()=>{ne.scrollBottom()},200))}),e(g).on("focusout",".sb-textarea",function(){setTimeout(()=>{l.removeClass("sb-header-hidden")},300)}),e(g).on("click",".sb-submit",function(){p.blur()}),window.addEventListener("popstate",function(){ne.chat_open&&ne.open(!1)})),e(h).on("click",".sb-menu li",function(){e(this).parent().sbActive(!1)}),e(g).on("click",".sb-submit",function(){ne.submit()}),e("body").on("click",".sb-chat-btn,.sb-responsive-close-btn, #sb-open-chat, .sb-open-chat",function(){ne.open(!ne.chat_open)}),e(l).on("click",".sb-dashboard-btn",function(){ne.showDashboard(),_.find(" > .sb-panel-articles > .sb-article").length&&ne.showArticles(),i("open-conversation",0),P=!1}),e(l).on("click",".sb-user-conversations li",function(){ne.openConversation(e(this).attr("data-conversation-id"))}),e(l).on("click",".sb-btn-new-conversation, .sb-departments-list > div, .sb-agents-list > div",function(){let t=e(this).data("id"),i=!1;if(!ee.null(t)){let n=e(this).parent().hasClass("sb-departments-list");if(n?ne.default_department=parseInt(t):ne.default_agent=parseInt(t),e(this).parent().data("force-one")){let e=a()?a().conversations:[];for(var s=0;s<e.length;s++)if(n&&e[s].get("department")==t||!n&&e[s].get("agent_id")==t){i=!0,ne.openConversation(e[s].id);break}}}i||(P="new-conversation",ne.clear(),ne.hideDashboard())}),e(l).on("click",".sb-btn-all-conversations",function(){l.find(".sb-dashboard-conversations").removeClass("sb-conversations-hidden")}),e(g).on("click",".sb-btn-attachment",function(){ne.is_busy||g.find(".sb-upload-files").val("").click()}),e(g).on("click",".sb-attachments > div > i",function(t){return e(this).parent().remove(),p.val()||0!=g.find(".sb-attachments > div").length||g.sbActive(!1),t.preventDefault(),!1}),e(g).on("change",".sb-upload-files",function(t){ne.busy(!0),e(this).sbUploadFiles(function(e){ne.uploadResponse(e)}),ee.event("SBAttachments")}),e(g).on("dragover",function(t){e(this).addClass("sb-drag"),clearTimeout(E),t.preventDefault(),t.stopPropagation()}),e(g).on("dragleave",function(t){E=setTimeout(()=>{e(this).removeClass("sb-drag")},200),t.preventDefault(),t.stopPropagation()}),e(g).on("drop",function(t){let i=t.originalEvent.dataTransfer.files;if(t.preventDefault(),t.stopPropagation(),i.length>0)for(var s=0;s<i.length;++s){let e=new FormData;e.append("file",i[s]),ee.upload(e,function(e){ne.uploadResponse(e)})}return e(this).removeClass("sb-drag"),!1}),e(l).on("click",".sb-btn-all-articles:not([onclick])",function(){ne.showArticles()}),e(l).on("click",".sb-articles > div",function(){ne.showArticles(e(this).attr("data-id"),e(this).attr("data-is-category"))}),e(l).on("click",".sb-dashboard-articles .sb-input-btn .sb-submit-articles",function(){ne.searchArticles(e(this).parent().find("input").val(),this,e(this).parent().next())}),e(c).on("click",".sb-article [data-rating]",function(){ne.articleRatingOnClick(this)}),e(h).on("click",".sb-rich-button a",function(t){let i=e(this).attr("href");if(0===i.indexOf("#")&&0===i.indexOf("#article-"))return ne.showArticles(i.replace("#article-","")),t.preventDefault(),!1}),e(b).on("click","[data-rating]",function(){let i=b.find("> div:last-child"),s=e(this).attr("data-rating"),n=ne.conversation?ne.conversation:a().getLastConversation(),o=n.getLastUserMessage(!1,!0);t(i),ee.ajax({function:"set-rating",conversation_id:n.id,agent_id:!!o&&o.get("user_id"),user_id:a().id,message:i.find("textarea").val(),rating:"positive"==s?1:-1},e=>{b.attr("data-close-chat")&&ne.closeChat(),ne.update(),b.sbActive(!1),i.sbLoading(!1)})}),e(c).on("click",".sb-lightbox-media > i",function(){return c.find(".sb-lightbox-media").sbActive(!1),x&&(SBAdmin.open_popup=!1),!1}),e(l).on("click",".sb-image",function(){ee.lightbox(e(this).html())}),e(l).on("click",".sb-slider-images .sb-card-img",function(){ee.lightbox(`<img loading="lazy" src="${e(this).attr("data-value")}" />`)}),e(document).on("SBConversationLoaded",function(){i("queue")&&ne.queue(i("queue"))}),e(g).on("click",".sb-btn-emoji",function(){ne.showEmoji(this)}),e(v).on("click",".sb-emoji-list li",function(t){ne.insertEmoji(e(this).html()),O&&clearTimeout(E)}),e(v).find(".sb-emoji-list").on("touchend",function(e){E=setTimeout(()=>{ne.mouseWheelEmoji(e)},50)}),e(v).find(".sb-emoji-list").on("mousewheel DOMMouseScroll",function(e){ne.mouseWheelEmoji(e)}),e(v).find(".sb-emoji-list").on("touchstart",function(e){ne.emoji_options.touch=e.originalEvent.touches[0].clientY}),e(v).on("click",".sb-emoji-bar > div",function(){ne.clickEmojiBar(this)}),e(v).on("click",".sb-select li",function(){ne.categoryEmoji(e(this).data("value"))}),e(v).find(".sb-search-btn input").on("change keyup paste",function(){ne.searchEmoji(e(this).val())}),e(p).on("keyup",function(){ne.textareaChange(this)}),e(l).on("click",".sb-privacy .sb-approve",function(){i("privacy-approved",!0),e(this).closest(".sb-privacy").remove(),l.removeClass("sb-init-form-active"),f.find(" > div").css({opacity:1,top:0}),ne.initChat(),$?SBTickets.showPanel(ee.setting("tickets_disable_first")?"":"new-ticket"):ne.isInitDashboard()||ne.hideDashboard()}),e(l).on("click",".sb-privacy .sb-decline",function(){let t=e(this).closest(".sb-privacy");e(t).find(".sb-text").html(e(t).attr("data-decline")),e(t).find(".sb-decline").remove(),ne.scrollBottom(!0)}),e(l).on("click",".sb-popup-message .sb-icon-close",function(){ne.popup(!0)}),e(l).on("click",".sb-rich-message .sb-submit,.sb-rich-message:not(.sb-rich-registration) .sb-select ul li",function(){let t=e(this).closest(".sb-rich-message");t[0].hasAttribute("disabled")||oe.submit(t,t.attr("data-type"),this)}),e(l).on("click",".sb-rich-message .sb-input > span",function(){e(this).sbActive(!0),e(this).siblings().focus()}),e(l).on("focus focusout click",".sb-rich-message .sb-input input,.sb-rich-message .sb-input select",function(t){switch(t.type){case"focusin":case"focus":e(this).siblings().sbActive(!0);break;case"focusout":e(this).val()?e(this).siblings().addClass("sb-filled sb-active"):setTimeout(()=>{X||e(this).siblings().sbActive(!1)},100);break;case"click":e(this).siblings().removeClass("sb-filled")}}),e(l).on("click",".sb-input-select-input > div",function(){X=!0,setTimeout(()=>{X=!1},250)}),e(l).on("click",".sb-slider-arrow",function(){oe.sliderChange(e(this).closest("[id]").attr("id"),e(this).hasClass("sb-icon-arrow-right")?"right":"left")}),e(l).on("change",'.sb-rich-message [data-type="select"] select',function(){e(this).siblings().sbActive(!0)}),e(l).on("click",'[data-type="select-input"] > div',function(){e(this).prev().sbActive(!0),e(this).next().addClass("sb-focus")}),e(l).on("focusout",'[data-type="select-input"] input,[data-type="select-input"] select',function(){let t=e(this).closest(".sb-input");t.find("> input").val()+t.find("select").val()==""&&t.find("span").sbActive(!1),t.find(".sb-focus").removeClass("sb-focus")}),e(l).on("click",".sb-rich-registration .sb-login-area",function(){let t=l.hasClass("sb-init-form-active");e(this).closest(".sb-rich-registration").replaceWith(oe.generate({},"login",t?"sb-init-form":"")),ne.scrollBottom(t)}),e(l).on("click",".sb-rich-login .sb-registration-area",function(){if(U.registration_link)document.location=U.registration_link;else{let t=l.hasClass("sb-init-form-active");e(this).closest(".sb-rich-login").replaceWith(oe.generate({},"registration",t?"sb-init-form":"")),ne.scrollBottom(t)}}),e(l).on("click",".sb-rich-login .sb-submit-login",function(){ee.loginForm(this,!1,t=>{let i=e(this).closest(".sb-rich-login");if(a(new ie(t[0])),i.hasClass("sb-init-form"))P="open-conversation",ne.initChat(),te.start(),ne.isInitDashboard()||ne.hideDashboard(),e(document).on("SBPopulateConversations",function(){l.removeClass("sb-init-form-active"),i.remove(),e(document).off("SBPopulateConversations")});else{i=i.closest("[data-id]");let e=ne.conversation.getMessage(i.attr("data-id")),t=`${s("Logged in as")} *${a().name}*`;e.set("message",t),ne.updateMessage(e.id,t),i.replaceWith(e.getCode()),te.started=!1,te.start()}})}),e(h).on("click",".sb-social-buttons div",function(){ee.openWindow(e(this).attr("data-link"))}),e(l).on("click",".sb-close-chat",function(){ne.closeChat()}),e(h).on("click",'.sb-rich-woocommerce_button a, [href="#"].sb-card-btn',function(i){let s=ee.settingsStringToArray(e(this).closest(".sb-rich-message").attr("data-settings")),a="checkout"==s["link-type"]||s.checkout,n=e(this)[0].hasAttribute("data-ids")?e(this).attr("data-ids").split(","):[s.id.split("|")[e(this).parent().index()]];if(n.length){if(t(this))return;le.wordpress.ajax("button-purchase",{product_ids:n,checkout:a,coupon:s.coupon},t=>{a?document.location=t:e(this).addClass("sb-icon-check").sbLoading(!1)})}return i.preventDefault(),!1}),e(h).on("click","#sb-waiting-list .sb-submit",function(){0==e(this).index()&&setTimeout(()=>{le.woocommerce.waitingList("submit")},1e3)}),e(document).on("SBNewEmailAddress",function(e,t){"sb-waiting-list-email"==t.id&&le.woocommerce.waitingList("submit")}),e(h).on("click",".sb-player-btn",function(){let t=e(this).parent().find("audio").get(0),i=e(this).hasClass("sb-icon-play");h.find("audio").each(function(){e(this).get(0).pause(),e(this).unbind("ended"),e(this).parent().find(".sb-player-btn").removeClass("sb-icon-pause").addClass("sb-icon-play")}),i?(t.play(),e(this).removeClass("sb-icon-play")):t.pause(),e(t).unbind("ended"),e(t).bind("ended",()=>{e(this).removeClass("sb-icon-pause").addClass("sb-icon-play")}),e(this).addClass("sb-icon-"+(i?"pause":"play"))}),e(h).on("click",".sb-player-speed",function(){let t=e(this).parent();if(t.find(".sb-player-btn").hasClass("sb-icon-pause")){let i=e(this).find(".sb-player-speed-number"),s=parseFloat(i.html());(s+=.5)>2&&(s=1),t.find("audio").get(0).playbackRate=s,i.html(s)}}),e(h).on("click",".sb-player-download",function(){window.open(e(this).parent().find("audio source").attr("src"))}),e(g).on("click",".sb-btn-audio-clip",function(){if((A=ne.conversation&&"wa"==ne.conversation.get("source"))&&typeof SBAudioRecorder===G)return e.getScript(SB_URL+"/vendor/lame.min.js",()=>{this.click()},!0);navigator.mediaDevices.getUserMedia({audio:!0}).then(t=>{A?SBAudioRecorder.init(t):(typeof SBAudioRecorder!=G&&SBAudioRecorder.close(),H=[],(T=new MediaRecorder(t)).addEventListener("dataavailable",e=>{H.push(e.data)})),k||(k=g.find("#sb-audio-clip"),C=k.find(".sb-audio-clip-time"),k.on("click",".sb-btn-mic",function(){let t=e(this).hasClass("sb-icon-pause");if(t)A?SBAudioRecorder.pause():T.stop();else{let e=k.find(".sb-btn-clip-player");e.hasClass("sb-icon-pause")&&e.click(),A?SBAudioRecorder.resume():T.start()}J[2]=!t,k.find(".sb-icon-play").sbActive(t),e(this).removeClass("sb-icon-"+(t?"pause":"mic")).addClass("sb-icon-"+(t?"mic":"pause"))}),k.on("click",".sb-btn-clip-player",function(){let t=e(this).hasClass("sb-icon-pause");if(t)Y[3].pause(),Y[2]=!1;else if(Y[3])Y[3].play(),Y[2]=!0;else{let t=new Audio(URL.createObjectURL(A?SBAudioRecorder.blob(!1):new Blob(H,{type:"audio/webm"})));C.html("0:00"),t.play(),t.onended=(()=>{Y[0]=0,Y[2]=!1,Y[3]=!1,C.html("0:00"),e(this).removeClass("sb-icon-pause").addClass("sb-icon-play")}),Y[0]=0,Y[2]=!0,Y[3]=t}e(this).removeClass("sb-icon-"+(t?"pause":"play")).addClass("sb-icon-"+(t?"play":"pause"))}),k.on("click",".sb-icon-close",function(){H=[],clearInterval(J[1]),clearInterval(Y[1]),k.sbActive(!1),g.sbActive(!1).removeClass("sb-audio-message-active"),A?SBAudioRecorder.pause():T.stop(),B.getTracks()[0].stop()})),C.html("0:00"),B=t,clearInterval(J[1]),clearInterval(Y[1]),J=[0,setInterval(()=>{J[2]&&(J[0]++,C.html(o(J[0])))},1e3),!0],Y=[0,setInterval(()=>{Y[2]&&(Y[0]++,C.html(o(Y[0])))},1e3),!1,!1],A||T.start(),k.find(".sb-btn-clip-player").removeClass("sb-icon-pause").addClass("sb-icon-play").sbActive(!1),k.find(".sb-icon-mic").removeClass("sb-icon-mic").addClass("sb-icon-pause"),k.sbActive(!0),p.val("").css("height",""),g.sbActive(!0).addClass("sb-audio-message-active")}).catch(e=>{alert(e)})}),e(h).on("click","[data-action].sb-rich-btn",function(t){return oe.calendly.load(e(this).attr("data-extra"),e(this).html(),e(this).closest("[data-id]").attr("data-id")),t.preventDefault(),!1}),e(b).on("click","> div:first-child i",function(){l.find(".sb-overlay-panel").sbActive(!1),b.attr("data-close-chat")&&ne.closeChat()}),e(l).on("change input","#phone > input",function(){let t=e(this).val().trim();if(/^[0-9+]+$/.test(t)||(t=t.replace(/[^0-9+]/g,""),e(this).val(t)),t.length>1&&0===t.indexOf("+")){let i=!1;"+1"==t.substring(0,2)&&(i=t.substring(0,2)),t.length>3&&(i=t.substring(0,3)),i&&(e(this).parent().find(`[data-value="${i}"]`).click(),e(this).parent().find(".sb-select").click(),e(this).val(t.replace(i,"")))}}),e(c).on("click",".sb-search-btn > i",function(){let t=e(this).parent(),i=e(t).sbActive();i&&(setTimeout(()=>{e(t).find("input").val("")},50),setTimeout(()=>{e(t).find("input").trigger("change")},550)),e(t).sbActive(!i),e(t).find("input").get(0).focus(),c.find(".sb-select ul").sbActive(!1)}),e(c).on("click",".sb-select",function(t){if(!t.target||!e(t.target).is("input")){let t=e(this).find("ul"),i=t.hasClass("sb-active");e(c).find(".sb-select ul").sbActive(!1),t.setClass("sb-active",!i),e(this).find(".sb-select-search").setClass("sb-active",!i),x&&(SBAdmin.open_popup=!i&&this)}}),e(c).on("click",".sb-select li",function(){let t=e(this).closest(".sb-select"),i=e(this).data("value"),s=e(t).find(`[data-value="${i}"]`);t.find("li").sbActive(!1),t.find("p").attr("data-value",i).html(e(s).html()),s.sbActive(!0)}),e(c).on("input",".sb-select-search input",function(t){let i=e(this).val();ee.search(i,()=>{let t=e(this).parent().parent().find("li");t.setClass("sb-hide",i.length),i.length&&(i=i.toLowerCase(),t.each(function(){(e(this).attr("data-value").includes(i)||e(this).attr("data-country").includes(i))&&e(this).removeClass("sb-hide")}))})}),e(c).on("click",".sb-input-image .image",function(){d=e(this).parent(),g.find(".sb-upload-files").click()}),e(c).on("click",".sb-input-image .image > .sb-icon-close",function(t){return ee.ajax({function:"delete-file",path:e(this).parent().attr("data-value")}),e(this).parent().removeAttr("data-value").css("background-image",""),t.preventDefault(),!1})}var l,c,d,u,h,g,p,f,m,v,_,b,y,w,S,A,k,C,T,B,x=!1,$=!1,E=!1,I=!1,R=!1,j=[],L=!1,M=[9999999,""],N=[!1,!1],D=document.title,U={},O=e(window).width()<465,P="",q=!1,G="undefined",F=!0,z=6e4*(new Date).getTimezoneOffset(),W=!1,V=!1,H=[],J=[0,!1],Y=[0,!1],X=!1,Q=!1,K=0,Z=typeof Shopify!==G;e.fn.extend({manualExpandTextarea:function(){var t=this[0];t.style.height="auto",t.style.maxHeight="25px",window.getComputedStyle(t),t.style.height=(t.scrollHeight>350?350:t.scrollHeight)+"px",t.style.maxHeight="",e(t).trigger("textareaChanged")},autoExpandTextarea:function(){var t=this[0];t.addEventListener("input",function(i){e(t).manualExpandTextarea()},!1)}}),function(){var e=[].slice;String.prototype.autoLink=function(){var t,i,s,a,n,o,r;return o=/(^||[\s\n]|<[A-Za-z]*\/?>)((?:https?|ftp):\/\/[\-A-Z0-9+\u0026\u2019@#\/%?=()~_|!:,.;]*[\-A-Z0-9+\u0026@#\/%=~_|])/gi,0<(n=1<=arguments.length?e.call(arguments,0):[]).length?(a=n[0],t=a.callback,s=function(){var e;for(i in e=[],a)r=a[i],"callback"!==i&&e.push(" "+i+"='"+r+"'");return e}().join(""),this.replace(o,function(e,i,a){return""+i+(("function"==typeof t?t(a):void 0)||"<a href='"+a+"'"+s+">"+a+"</a>")})):this.replace(o,"$1<a href='$2'>$2</a>")}}.call(this);var ee={visibility_status:"visible",loop_prevention:!1,ajax:function(t,i=!1){S?(S[0].push(t),S[1].push(i)):(S=[[t],[i]],setTimeout(()=>{let s=S[1],n={"login-cookie":ee.loginCookie()};a()&&(n.user_id=a().id),typeof SB_LANG!=G&&(n.language=SB_LANG),W&&(n.cloud=W),location.search.includes("debug")&&(n.debug=!0),e.ajax({method:"POST",url:SB_AJAX_URL,data:e.extend({function:"ajax_calls",calls:S[0]},n)}).done(e=>{let a;if(Array.isArray(e))a=e;else if("invalid-session"===e)setTimeout(()=>{ee.reset()},1e3);else{if(x&&SB_ADMIN_SETTINGS.cloud&&e.includes("no-credits")&&!e.includes('"value":"no-credits'))return SBCloud.creditsAlertQuota();try{a="string"==typeof e||e instanceof String?JSON.parse(e):e}catch(i){return void this.ajax_error(e,t)}}for(var n=0;n<a.length;n++){let e=a[n];if(Array.isArray(e)||(e=a),"success"==e[0])(i=s[n])&&i(e[1]);else if(ee.errorValidation(e))i&&i(e);else{if(x&&("security-error"==e[1]&&setTimeout(()=>{ee.reset()},1e3),SBAdmin.conversations.busy=!1),ne.is_busy_update=!1,ne.busy(!1),"login-data-error"==e[1]&&!this.loop_prevention)return;let i=JSON.parse(e);Array.isArray(i)&&"error"==i[0]&&i[2]&&i[3]?ee.error(i[3],i[2]):ee.error(JSON.stringify(e).replace(/\\/g,"").replace(/\"/g,"").replace(/\[/g,"").replace(/\]/g,"").replace("error,",""),t.function)}}}).fail((e,t,i)=>{i&&(this.ajax_error("HTTP CURL ERROR"),console.log(i))}),S=!1},100))},ajax_error:function(e,t=!1){x&&(SBAdmin.conversations.busy=!1,le.dialogflow.smart_reply_busy=!1),le.dialogflow.busy&&(le.dialogflow.busy=!1,!x&&ne.conversation&&(ee.ajax({function:"open-ai-send-fallback-message",conversation_id:ne.conversation.id}),ne.typing(-1,"stop"))),ne.is_busy_update=!1,ne.busy(!1),console.log(e),ee.error(e.length>500?e.substr(0,500)+"... Check the console for more details.":e,`SBF.ajax.${t?t.function:""}`)},cors:function(e="GET",t,i){let s=new XMLHttpRequest;if("withCredentials"in s)s.open(e,t,!0);else{if(typeof XDomainRequest==G)return!1;(s=new XDomainRequest).open(e,t)}s.onload=function(){i(s.responseText)},s.onerror=function(){return!1},s.send()},upload:function(e,t){W&&e.append("cloud",W),jQuery.ajax({url:SB_URL+"/include/upload.php",cache:!1,contentType:!1,processData:!1,data:e,type:"POST",success:function(e){t(e)}})},getFileType:function(e){return/.jpg|.jpeg|.png|.gif|.webp/.test(e)?"image":/.mp3|.ogg|.wav|.aac/.test(e)?"audio":/.mp4|.mkv|.vob|.3gp|.webm/.test(e)?"video":"file"},UTC:function(e){return new Date(e).getTime()-z},null:function(e){return typeof e===G||null===e||"null"===e||!1===e||!(e.length>0||"number"==typeof e||typeof e.length==G)||e===G},deactivateAll:function(){c.find(".sb-popup, .sb-tooltip, .sb-list .sb-menu, .sb-select ul").sbActive(!1)},deselectAll:function(){window.getSelection?window.getSelection().removeAllRanges():document.selection&&document.selection.empty()},getURL:function(e=!1,t=!1){if(t||(t=location.search),0==e){for(var i=t.split("?").pop().split("&"),s={},a=0;a<i.length;a++){var n=i[a].split("=");s[n[0]]=ee.escape(n[1])}return s}return t.indexOf("?")>0&&(t=t.substr(0,t.indexOf("?"))),ee.escape(decodeURIComponent((new RegExp("[?|&]"+e+"=([^&;]+?)(&|#|;|$)").exec(t)||[,""])[1].replace(/\+/g,"%20")||""))},URL:function(){return window.location.href.substr(0,window.location.href.indexOf("?"))},stringToSlug:function(e){let t={"ก":"k","ข":"kh","ฃ":"kh","ค":"kh","ฅ":"kh","ฆ":"kh","ง":"ng","จ":"ch","ฉ":"ch","ช":"ch","ซ":"s","ฌ":"ch","ญ":"y","ฎ":"d","ฏ":"t","ฐ":"th","ฑ":"th","ฒ":"th","ณ":"n","ด":"d","ต":"t","ถ":"th","ท":"th","ธ":"th","น":"n","บ":"b","ป":"p","ผ":"ph","ฝ":"f","พ":"ph","ฟ":"f","ภ":"ph","ม":"m","ย":"y","ร":"r","ล":"l","ว":"w","ศ":"s","ษ":"s","ส":"s","ห":"h","ฬ":"l","อ":"o","ฮ":"h","ะ":"a","ั":"a","า":"a","ำ":"am","ิ":"i","ี":"i","ึ":"ue","ื":"ue","ุ":"u","ู":"u","เ":"e","แ":"ae","โ":"o","ใ":"ai","ไ":"ai","ا":"a","ب":"b","ت":"t","ث":"th","ج":"j","ح":"h","خ":"kh","د":"d","ذ":"dh","ر":"r","ز":"z","س":"s","ش":"sh","ص":"s","ض":"d","ط":"t","ظ":"z","ع":"a","غ":"gh","ف":"f","ق":"q","ك":"k","ل":"l","م":"m","ن":"n","ه":"h","و":"w","ي":"y","你":"ni","好":"hao","世":"shi","界":"jie","我":"wo","是":"shi","中":"zhong","国":"guo","人":"ren","谢":"xie","再":"zai","见":"jian"},i="åàáãäâèéëêìíïîòóöôùúüûñç·/_,:;";e=e.trim().toLowerCase().split("").map(e=>t[e]||e).join("");for(var s=0,a=i.length;s<a;s++)e=e.replace(new RegExp(i.charAt(s),"g"),"aaaaaaeeeeiiiioooouuuunc------".charAt(s));return e.replace(/[^a-z0-9 -]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^-+/,"").replace(/-+$/,"").replace(/ /g,"")},slugToString:function(e){return(e=e.replace(/_/g," ").replace(/-/g," ")).charAt(0).toUpperCase()+e.slice(1)},random:function(){let e="";for(var t=5;t>0;--t)e+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return e},isAgent:function(e){return"agent"==e||"admin"==e||"bot"==e},beautifyTime:function(e,t=!1,i=!1){let a;if("0000-00-00 00:00:00"==e)return"";if(e.indexOf("-")>0){let t=e.split(/[- :]/);a=new Date(t[0],t[1]-1,t[2],t[3],t[4],t[5])}else{let t=e.split(/[. :]/);a=new Date(t[2],t[1]-1,t[0],t[3],t[4],t[5])}let n=new Date,o=new Date(Date.UTC(a.getFullYear(),a.getMonth(),a.getDate(),a.getHours(),a.getMinutes(),a.getSeconds())),r=(n-o)/864e5*(i?-1:1),l=[s("Sunday"),s("Monday"),s("Tuesday"),s("Wednesday"),s("Thursday"),s("Friday"),s("Saturday")],c=o.toLocaleTimeString(navigator.language,{hour:"2-digit",minute:"2-digit"});return"0"===c.charAt(0)&&(c.includes("PM")||c.includes("AM"))&&(c=c.substring(1)),r<1&&n.getDate()==o.getDate()?t?`<span>${s("Today")}</span> <span>${c}</span>`:`<span data-today>${c}</span>`:r<6?`<span>${l[o.getDay()]}</span>${t?` <span>${c}</span>`:""}`:`<span>${o.toLocaleDateString(void 0,{year:"2-digit",month:"2-digit",day:"2-digit"})}</span>${t?` <span>${c}</span>`:""}`},unix:function(e){let t=e.split(/[- :]/);return Date.UTC(t[0],t[1]-1,t[2],t[3],t[4],t[5])},getLocationTimeString:function(e,t){if(e.timezone){let i={};i.timezone=e.timezone.value,i.country=e.country?e.country.value:i.timezone.split("/")[0].replace(/_/g," "),i.city=e.city?e.city.value:i.timezone.split("/")[1].replace(/_/g," "),t(`${new Intl.DateTimeFormat(void 0,{timeZone:i.timezone,hour:"2-digit",minute:"2-digit"}).format(new Date)} ${s("in")} ${i.city?i.city:""}${i.country?", "+i.country:""}`)}},dateDB:function(e){return"now"==e?((e=(new Date).toISOString().replace("T"," ")).indexOf(".")>0&&(e=e.substr(0,e.indexOf("."))),e):`${e.getFullYear()}-${e.getMonth()+1}-${e.getDate()} ${e.getHours()}:${e.getMinutes()}:${e.getSeconds()}`},updateUsersActivity:function(e,t,i){te.active?i(x&&SB_ADMIN_SETTINGS.bot_id==t||!x&&U.bot_id==t?"online":te.online_ids.includes(t)?"online":"offline"):ee.ajax({function:"update-users-last-activity",user_id:e,return_user_id:t,check_slack:!x&&U.slack_active},e=>{i("online"===e?"online":"offline")})},search:function(e,t){(e=e.toLowerCase())!=u?(clearTimeout(E),E=setTimeout(function(){u=e,t()},1e3)):c.find(".sb-search-btn i").sbLoading(!1)},searchClear:function(t,i){e(t).next().val()&&(e(t).next().val(""),i())},error:function(e,t){let i=e.includes(t);if(!x||!SBAdmin.is_logout)throw e instanceof Error&&(e=e.message),"."==e[e.length-1]&&(e=e.slice(0,-1)),x&&(!e||t.includes("update-users-last-activity")||t.startsWith("security-error")||SBAdmin.infoPanel(`<pre>${i?"":`[Error] [${t}] `}${e}. Check the console for more details.</pre>`,"info",!1,"error"),le.dialogflow.smart_reply_busy=!1),c.find(".sb-loading").sbLoading(!1),ne.busy(!1),ee.event("SBError",{message:e,function_name:t}),new Error(i?e:`Support Board Error [${t}]: ${e}.`)},errorValidation:function(e,t=!0){return Array.isArray(e)&&"validation-error"===e[0]&&(!0===t||e[1]==t)},loginForm:function(t,i=!1,a=!1,n=!0){if(!(t=e(t)).sbLoading()){i=!1===i?t.closest(".sb-rich-login"):e(i);let o=e.trim(i.find("#email input").val()),r=e.trim(i.find("#password input").val());o&&r?(ee.ajax({function:"login",email:o,password:r},e=>{if(e&&Array.isArray(e)){if(!x&&this.isAgent(e[0].user_type))re.showErrorMessage(i,"You cannot sign in as an agent."),ne.scrollBottom();else{let t=new ie(e[0]);t.set("conversation_id",!!ne.conversation&&ne.conversation.id),this.loginCookie(e[1]),this.event("SBLoginForm",t),a&&a(e)}"wp"==ee.setting("wp-users-system")&&le.wordpress.ajax("wp-login",{user:o,password:r})}else{if(x&&le.is("wordpress"))return le.wordpress.ajax("wp-login-admin",{user:o,password:r},()=>{t.sbLoading(!1),n?this.loginForm(t,i,a,!1):i.find(".sb-info").html(s("ip-ban"===e?"Too many login attempts. Please retry again in a few hours.":"Invalid email or password.")).sbActive(!0)});i.find(".sb-info").html(s("ip-ban"===e?"Too many login attempts. Please retry again in a few hours.":"Invalid email or password.")).sbActive(!0),x||ne.scrollBottom()}t.sbLoading(!1)}),i.find(".sb-info").html("").sbActive(!1),t.sbLoading(!0)):(i.find(".sb-info").html(s("Please insert email and password.")).sbActive(!0),ne.scrollBottom())}},loginCookie:function(e=!1){if(!1===e)return this.cookie("sb-login")?this.cookie("sb-login"):i("login");U.cloud?i("login",e):this.cookie("sb-login",e,3650,"set")},login:function(e="",t="",i="",s="",a=!1){ee.ajax({function:"login",email:e,password:t,user_id:i,token:s},e=>!(0==e||!Array.isArray(e))&&(this.loginCookie(e[1]),a&&a(e),!0))},logout:function(e=!0){ne.stopRealTime(),this.cookie("sb-login","","",!1),this.cookie("sb-cloud","","",!1),i("open-conversation",""),i("login",""),ne.conversations=!1,a(!1),typeof sb_beams_client!==G&&sb_beams_client.stop(),typeof SB_AJAX_URL!==G&&ee.ajax({function:"logout"},()=>{ee.event("SBLogout"),e&&setTimeout(()=>{location.reload()},500)})},activeUser:function(){return a()},getActiveUser:function(e=!1,t){let s=le.login();!s&&(i("wp-login")||i("whmcs-login")||i("perfex-login")||i("aecommerce-login"))&&(this.cookie("sb-login","","","delete"),a(!1),i("login",""),i("wp-login",""),i("whmcs-login",""),i("perfex-login",""),i("aecommerce-login","")),ee.ajax({function:"get-active-user",db:e,login_app:JSON.stringify(s),user_token:ee.getURL("token")},e=>{if(!e)return t(),!1;if(e.cookie&&ee.loginCookie(e.cookie),e.user_type)if(!x&&ee.isAgent(e.user_type)){let e="You are logged in as both agent and user. Logout or use another browser, Incognito or Private mode, to login as user. Force a logout by running the function SBF.reset() in the console.";i("double-login-alert")||(i("double-login-alert",!0),alert(e)),console.warn("Support Board: "+e),ee.event("SBDoubleLoginError")}else a(new ie(e,e.phone?{phone:e.phone}:{})),te.start(),s&&i(s[1]+"-login",!0),t(),ee.event("SBActiveUserLoaded",e)})},reset:function(){let e=["sb-login","sb-cloud","sb-dialogflow-disabled"];for(var t=0;t<e.length;t++)this.cookie(e[t],"",0,!1);try{localStorage.removeItem("support-board")}catch(e){}this.logout()},lightbox:function(t){let i=e(x?c:l).find(".sb-lightbox-media");i.sbActive(!0).find(" > div").html(t),x&&(SBAdmin.open_popup=i)},storage:function(e,t=G){try{if(typeof localStorage==G)return!1}catch(e){return!1}let i=localStorage.getItem("support-board");if(i=null===i?{}:JSON.parse(i),t===G)return e in i&&i[e];t?i[e]=t:delete i[e],localStorage.setItem("support-board",JSON.stringify(i))},storageTime:function(e,t=!1){let s=new Date;if(!1!==t)return 0==i(e)||s.getTime()-i(e)>36e5*t&&(i(e,!1),!0);i(e,s.getTime())},cookie:function(e,t=!1,i=!1,s="get",a=!1){let n="https:"==location.protocol?"SameSite=None;Secure;":"",o=window[x?"SB_ADMIN_SETTINGS":"CHAT_SETTINGS"],r=o&&o.cookie_domain?"domain="+o.cookie_domain+";":"";if("get"==s){if(!F)return this.storage(e);let t=document.cookie.split(";");for(var l=0;l<t.length;l++){for(var c=t[l];" "==c.charAt(0);)c=c.substring(1);if(0==c.indexOf(e)){let t=c.substring(e.length+1,c.length);return!this.null(t)&&t}}return!1}if("set"==s)if(F){let s=new Date;s.setTime(s.getTime()+i*(a?1:86400)*1e3),document.cookie=e+"="+t+";expires="+s.toUTCString()+";path=/;"+n+r}else this.storage(e,t);else this.cookie(e)&&(F?document.cookie=e+"="+t+";expires=Thu, 01 Jan 1970 00:00:01 GMT;path=/;"+n+r:this.storage(e,""))},setting:function(e,t=-1){if(-1===t)return typeof U!==G&&e in U&&U[e];typeof U!==G&&(U[e]=t)},shortcode:function(e){return oe.shortcode(e)},event:function(t,i){e(document).trigger(t,i);let s=x?typeof SB_ADMIN_SETTINGS!==G&&SB_ADMIN_SETTINGS.webhooks:U.webhooks,a={SBGetUser:"get-user",SBSMSSent:"sms-sent",SBLoginForm:"login",SBRegistrationForm:"registration",SBUserDeleted:"user-deleted",SBNewMessagesReceived:"new-messages",SBNewConversationReceived:"new-conversation",SBSlackMessageSent:"slack-message-sent",SBMessageDeleted:"message-deleted",SBRichMessageSubmit:"rich-message",SBNewEmailAddress:"new-email-address"};if(s&&t in a){if(!0!==s&&(Array.isArray(s)||(s=s.replace(/ /g,"").split(",")),!s.includes(a[t])))return;ee.ajax({function:"webhooks",function_name:t,parameters:i})}},translate:function(e){if(!x&&ee.null(U)||x&&typeof SB_TRANSLATIONS===G)return e;let t=x?SB_TRANSLATIONS:U.translations;return t&&t[e]&&t[e]?t[e]:e},escape:function(e){return e?e.replace(/</gi,"&lt;").replace(/javascript:|onclick|onerror|ontoggle|onmouseover|onload|oncontextmenu|ondblclick|onmousedown|onmouseenter|onmouseleave|onmousemove|onmouseout|onmouseup/gi,""):""},strip:function(e){e=e.replace("```","");let t=[/\*([^\**]+)\*/,/\__([^\____]+)\__/,/\~([^\~~]+)\~/,/\`([^\``]+)\`/];for(var i=0;i<2;i++)t.forEach(t=>{e=e.replace(t,e=>e.replace(/[\*\_\~\`]/g,""))});return e.replace(/\\,/g,",").replace(/\\:/g,":")},visibilityChange:function(e=""){this.visibility_status=e;let t=x&&typeof SBAdmin!==G;"hidden"==e?(x||ne.stopRealTime(),ne.tab_active=!1,this.visibility_was_hidden=!0):(a()&&!x&&ne.startRealTime(),ne.tab_active=!0,clearInterval(R),clearInterval(ne.audio_interval),ne.conversation&&(ne.conversation.updateMessagesStatus(),(ne.chat_open||x)&&ne.updateNotifications(ne.conversation.id),t&&setTimeout(()=>{SBAdmin.conversations.notificationsCounterReset(ne.conversation.id)},2e3)),t&&(Date.now()-(O?6e4:18e4)>K&&(SBAdmin.conversations.update(),K=Date.now()),O&&ne.update()),document.title=D,this.serviceWorker.closeNotifications())},settingsStringToArray:function(e){if(this.null(e))return[];let t=[];e=e.split(",");for(var i=0;i<e.length;i++){let s=e[i].split(":");t[s[0]]="false"!=s[1]&&("true"==s[1]||s[1])}return t},openWindow:function(e,t=550,i=350){let s=screen.width/2-t/2,a=screen.height/2-i/2;return window.open(e,"targetWindow","toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width="+t+",height="+i+", top="+a+", left="+s),!1},convertUTCDateToLocalDate:function(e,t=0){return e=new Date(e),e=new Date(e.getTime()+36e5*t),new Date(e.getTime()+-1*z)},loadResource:function(e,t=!1,i=!1,s=!1){let a=document.createElement(t?"script":"link");e?(t?a.src=e:a.href=e,a.type=t?"text/javascript":"text/css"):a.innerHTML=s,i&&(a.onload=function(){i()}),t||(a.rel="stylesheet"),document.head.appendChild(a)},debounce:function(e,t,i=500){t in j||(j[t]=!0,e(),setTimeout(()=>{delete j[t]},i))},serviceWorker:{sw:!1,timeout:!1,init:function(){navigator.serviceWorker&&navigator.serviceWorker.register(x||"undefined"!=typeof SB_CLOUD_SW?SB_URL.replace("/script","")+"/sw.js?v=3.8.3":U.push_notifications_url+"?v=3.8.3").then(e=>{e.update(),this.sw=e}).catch(function(e){console.warn(e)})},initPushNotifications:function(){x&&("pusher"==SB_ADMIN_SETTINGS.push_notifications_provider||"onesignal"!=SB_ADMIN_SETTINGS.push_notifications_provider)||!x&&("pusher"==U.push_notifications_provider||"pushalert"!=U.push_notifications_provider)?te.initPushNotifications():e.getScript("https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js",()=>{window.OneSignalDeferred=window.OneSignalDeferred||[],OneSignalDeferred.push(e=>{e.init({appId:SB_ADMIN_SETTINGS.push_notifications_id})}),OneSignalDeferred.push(e=>{e.User.PushSubscription.addEventListener("change",t=>{if(t.current.optedIn){let t=(x&&SB_ADMIN_SETTINGS.cloud?SB_ADMIN_SETTINGS.cloud.cloud_user_id+"-":!x&&U.cloud?U.cloud.cloud_user_id+"-":"")+(x?SB_ACTIVE_AGENT.id:a().id);1==t&&(t="SB-1"),e.User.addTag("user_type",x?"agents":"users"),e.login(t)}ee.event("SBPushNotificationSubscription",t.current)})}),Q=!1})},closeNotifications:function(e=0){this.sw&&this.sw.getNotifications().then(t=>{if(t.length)for(let e=0;e<t.length;e+=1)t[e].close();else e<300&&"visible"==ee.visibility_status&&setTimeout(()=>{this.closeNotifications(e+1)},10)})},pushNotification:function(e,t=!1){let i=x?SB_ACTIVE_AGENT.profile_image:a().image;ee.ajax({function:"push-notification",title:x?SB_ACTIVE_AGENT.full_name:a().name,message:ee.strip(e),icon:i.indexOf("user.svg")>0?U.notifications_icon:i,interests:t||ne.getRecipientUserID(),conversation_id:!!ne.conversation&&ne.conversation.id},e=>e)}},beautifyAttachmentName:function(e){let t=e.indexOf("_");return-1!==t?e.substring(t+1):e}},te={channels:{},channels_presence:[],active:!1,pusher:!1,started:!1,pusher_beams:!1,initialized:!1,online_ids:[],beams_loaded:!1,init:function(t=!1){if(te.active){if(this.pusher)return!t||t();if(!t)return;e(window).one("SBPusherInit",()=>{t()}),this.initialized=!0,typeof Pusher===G?e.getScript("https://js.pusher.com/8.2.0/pusher.min.js",()=>{window.Pusher=Pusher,this.init_2()},!0):this.init_2()}},init_2:function(){this.pusher=new Pusher(x?SB_ADMIN_SETTINGS.pusher_key:U.pusher_key,{cluster:x?SB_ADMIN_SETTINGS.pusher_cluster:U.pusher_cluster,channelAuthorization:{endpoint:SB_URL+"/include/pusher.php",params:{login:ee.loginCookie(),cloud_user_id:!!U.cloud&&U.cloud.cloud_user_id}}}),ee.event("SBPusherInit")},initPushNotifications:function(){(a()||x)&&(this.beams_loaded?this.initPushNotifications_2():e.getScript("https://js.pusher.com/beams/2.0.0-beta.0/push-notifications-cdn.js",()=>{this.initPushNotifications_2()},!0))},initPushNotifications_2:function(){window.navigator.serviceWorker.ready.then(e=>{this.pusher_beams=new PusherPushNotifications.Client({instanceId:x?SB_ADMIN_SETTINGS.push_notifications_id:U.push_notifications_id,serviceWorkerRegistration:e}),ee.serviceWorker.closeNotifications(),this.pusher_beams.start().then(()=>this.pusher_beams.setDeviceInterests(x?[SB_ACTIVE_AGENT.id,"agents"]:[a().id,"users"])).catch(console.error),Q=!1})},start:function(){x||this.started||!a()||(this.active&&this.init(()=>{this.event("client-typing",e=>{e.user_id==ne.agent_id&&ne.conversation&&e.conversation_id==ne.conversation.id&&(ne.typing(-1,"start"),clearTimeout(I),I=setTimeout(()=>{ne.typing(-1,"stop")},1e3))}),this.event("new-message",e=>{!(e&&a()&&e.conversation_id)||a().getConversationByID(e.conversation_id)&&ne.conversation&&ne.conversation.id==e.conversation_id?ne.update():ne.updateConversations()}),this.presence(1,()=>{this.started=!0,ne.automations.runAll()})}),U.push_notifications_users&&("pusher"!=U.push_notifications_provider&&"onesignal"==U.push_notifications_provider||(typeof Notification!=G&&"granted"==Notification.permission?this.initPushNotifications():Q=!0)))},subscribe:function(e,t=!1){if(!this.pusher)return this.init(()=>{this.subscribe(e,t)});e=this.cloudChannelRename(e);let i=this.pusher.subscribe(e);i.bind("pusher:subscription_error",e=>console.log(e)),i.bind("pusher:subscription_succeeded",()=>{this.channels[e]=i,t&&t()})},event:function(e,t,i="private-user-"+a().id){if(!this.pusher)return this.init(()=>{this.event(e,t,i)});let s=i;(i=this.cloudChannelRename(i))in this.channels?(this.channels[i].unbind(e),this.channels[i].bind(e,e=>{t(e)})):this.subscribe(s,()=>{this.event(e,t,s)})},trigger:function(e,t={},i="private-user-"+a().id){if(0==e.indexOf("client-"))return this.channels[this.cloudChannelRename(i)].trigger(e,t);ee.ajax({function:"pusher-trigger",channel:i,event:e,data:t},e=>e)},presence:function(e=1,t){if(!this.pusher)return this.init(()=>{this.presence()});let i=this.pusher.subscribe(this.cloudChannelRename("presence-"+e));i.bind("pusher:subscription_succeeded",i=>{if(i.count>98)return this.subscribe(e+1);i.each(e=>{this.presenceCheck(e)&&this.online_ids.push(e.id)}),ne.updateUsersActivity(),t&&t()}),i.bind("pusher:subscription_error",e=>console.log(e)),i.bind("pusher:member_added",e=>{this.presenceCheck(e)&&this.presenceAdd(e.id),x&&ee.storageTime("online-user-notification-"+e.id,24)&&(SBAdmin.users.onlineUserNotification(e),ee.storageTime("online-user-notification-"+e.id))}),i.bind("pusher:member_removed",e=>{this.presenceRemove(e.id)}),this.channels_presence.push(i),!x&&U.slack_active&&(this.event("add-user-presence",e=>{this.presenceAdd(e.agent_id)}),ee.ajax({function:"slack-presence",list:!0},e=>{for(var t=0;t<e.length;t++)this.presenceAdd(e[t]);ne.updateUsersActivity()}))},presenceCheck:function(e){let t=ee.isAgent(e.info.user_type);return(x&&!t||!x&&t)&&!this.online_ids.includes(e.id)},presenceAdd:function(e){typeof e==G||this.online_ids.includes(e)||(this.online_ids.push(e),this.presenceUpdateAdmin(e),ne.updateUsersActivity())},presenceRemove:function(e){if(typeof e==G)return;let t=this.online_ids.indexOf(e);-1!==t?(this.online_ids.splice(t,1),this.presenceUpdateAdmin(e),ne.updateUsersActivity()):x&&c.find(`.sb-conversation-busy[data-agent="${e}"]`).remove()},presenceUnsubscribe:function(){for(var e=0;e<this.channels_presence.length;e++)this.channels_presence[e].unsubscribe(this.cloudChannelRename("presence-"+(e+1)))},presenceUpdateAdmin:function(e){x&&(c.find(".sb-area-users.sb-active").length&&SBAdmin.users.update(),a()&&a().id==e&&SBAdmin.users.updateUsersActivity())},cloudChannelRename:function(e){return U.cloud||x&&SB_ADMIN_SETTINGS.cloud?e+"-"+(x?SB_ADMIN_SETTINGS.cloud.cloud_user_id:U.cloud.cloud_user_id):e}};window.SBF=ee,window.SBPusher=te,window.sb_current_user=!1,e.fn.sbActive=function(t=-1){return-1===t?e(this).hasClass("sb-active"):(e(this).setClass("sb-active",t),this)},e.fn.sbLoading=function(t="check"){return"check"==t?e(this).hasClass("sb-loading"):(e(this).setClass("sb-loading",t),this)},e.fn.sbTogglePopup=function(t=!1){let i=!0;return x&&(SBAdmin.open_popup=!1),e(this).sbActive()?(e(this).sbActive(!1),c.removeClass("sb-popup-active"),i=!1):(c.addClass("sb-popup-active"),c.find(".sb-popup").sbActive(!1),t&&e(this).css("left",e(t).offset().left+15).sbActive(!0),x&&setTimeout(()=>{SBAdmin.open_popup=this},500),ee.deselectAll()),i},e.fn.sbUploadFiles=function(t,i=!1){let a=e(this).prop("files");for(var n=!1===i?0:i;n<(!1===i?a.length:i+1);n++){let e=a[n],i=e.size/1048576,o=x?SB_ADMIN_SETTINGS.max_file_size:U.max_file_size;if(i>o){let e=s("Maximum upload size is {R}MB. File size: {R2}MB.").replace("{R}",o).replace("{R2}",i.toFixed(2));x?SBAdmin.infoPanel(e,"info"):alert(e)}let r=new FormData;r.append("file",e),ee.upload(r,t)}e(this).value=""},e.fn.setProfile=function(t=!1,i=!1){return ee.null(t)&&(t=a()?a().name:""),ee.null(i)&&(i=a()?a().image:SB_URL+"/media/user.svg"),t&&e(this).removeClass("sb-profile-empty"),e(this).find("img").attr("src",i),e(this).find(".sb-name").html(t),this},e.fn.setClass=function(t,i=!0){return i?e(this).addClass(t):e(this).removeClass(t),this};class ie{constructor(e={},t={}){this.details=e,this.extra=t,this.conversations=[],this.processArray(e)}get id(){return this.get("id")?this.get("id"):this.get("user_id")}get type(){return this.get("user_type")}get email(){return this.get("email")}get name(){return this.details.first_name?this.details.first_name+(this.details.last_name?" "+this.details.last_name:""):""}get nameBeautified(){let e=x?SB_ADMIN_SETTINGS.visitor_default_name:U.visitor_default_name;return!e||this.details.last_name&&"#"!=this.details.last_name.charAt(0)?this.name:e}get image(){return this.get("profile_image")}get language(){let e=this.getExtra("language");return e||(e=this.getExtra("browser_language")),e?e.value.toLowerCase():""}get(e){return e in this.details&&!ee.null(this.details[e])?this.details[e]:""}getExtra(e){return e in this.extra&&!ee.null(this.extra[e])?this.extra[e]:""}set(e,t){this.details[e]=t}setExtra(e,t){this.extra[e]=t}processArray(e){if(e&&e.details){for(var t=0;t<e.details.length;t++)this.setExtra(e.details[t].slug,e.details[t]);delete e.details,this.details=e}}update(e){this.id?ee.ajax({function:"get-user",user_id:this.id,extra:!0},t=>{this.processArray(t),e(t),ee.event("SBGetUser",this)}):ee.error("Missing user ID","SBUser.update")}getConversations(e=!1,t){this.id?ee.ajax({function:"get-user-conversations",user_id:this.id,exclude_id:t,agent:ee.isAgent(this.type)},t=>{if(!ee.errorValidation(t)){let s=[];for(var i=0;i<t.length;i++)ne.isConversationAllowed(t[i].source,t[i].conversation_status_code)&&s.push(new ae([new se(t[i])],t[i]));this.conversations=s,e&&e(s)}}):ee.error("Missing user ID","SBUser.getConversations")}getConversationsCode(e=!1){let t="",i=ne.conversation?ne.conversation.id:-1;e||(e=this.conversations);for(var s=0;s<e.length;s++)if(e[s]instanceof ae){if(!x&&!ne.isConversationAllowed(e[s].get("source"),e[s].status_code))continue;let n=0,o=i==e[s].id;if(!x&&!o)for(var a=0;a<ne.notifications.length;a++)ne.notifications[a][0]==e[s].id&&n++;t+=`<li ${o?'class="sb-active" ':""}data-conversation-status="${o?0:e[s].status_code}" data-conversation-id="${e[s].id}" data-department="${e[s].get("department")}">${e[s].getCode()}${n?'<span data-count="'+n+'">'+n+"</span>":""}</li>`}else ee.error("Conversation not of type SBConversation","SBUser.getConversationsCode");return t}getFullConversation(e=!1,t=!1){!1!==e?ee.ajax({function:"get-conversation",conversation_id:e},e=>{let i=[];if(e){if("agent-not-authorized"===e)return void(window.location.href=ee.URL());for(var s=0;s<e.messages.length;s++)i.push(new se(e.messages[s]))}t&&t(new ae(i,!!e&&e.details))}):ee.error("Missing conversation ID","SBUser.getFullConversation")}getConversationByID(e,t=!1){for(var i=0;i<this.conversations.length;i++)if(this.conversations[i].id==e)return t?i:this.conversations[i];return!1}addConversation(e){if(e instanceof ae){let i=e.id,s=!0;for(var t=0;t<this.conversations.length;t++)if(this.conversations[t].id==i){this.conversations[t]=e,s=!1;break}return s&&this.conversations.unshift(e),s}ee.error("Conversation not of type SBConversation","SBUser.addConversation")}removeConversation(e){let t=this.getConversationByID(e,!0);!1!==t&&this.conversations.splice(t,1)}getLastConversation(){return!this.isConversationsEmpty()&&this.conversations[this.conversations.length-1]}isConversationsEmpty(){return 0==this.conversations.length}isExtraEmpty(){return 0===Object.keys(this.extra).length&&this.extra.constructor===Object}delete(e){this.id?ee.ajax({function:"delete-user",user_id:this.id},()=>(ee.event("SBUserDeleted",this.id),e(),!0)):ee.error("Missing user ID","SBUser.delete")}}window.SBUser=ie;class se{constructor(e={}){this.details=Object.assign({},e);let t=["message_status_code","message_id","message_profile_image","message_first_name","message_last_name","message_user_id","message_user_type"],i=["source","extra","title","tags","agent_id","department","last_update_time","conversation_creation_time","conversation_id","conversation_status_code","conversation_user_id"];for(s=0;s<t.length;s++)e[t[s]]&&(this.details[t[s].replace("message_","")]=e[t[s]]),delete this.details[t[s]];this.details.first_name&&(this.details.full_name=this.details.first_name+(this.details.last_name?" "+this.details.last_name:"")),e.last_update_time&&(this.details.creation_time=e.last_update_time);for(var s=0;s<i.length;s++)delete this.details[i[s]];let a=this.get("payload");if(a)try{var n=JSON.parse(this.get("payload").replace("\\'","'"));a=n&&"object"==typeof n?n:{}}catch(e){a={}}else a={};this.set("payload",a)}get id(){return this.get("id")}get attachments(){return ee.null(this.details.attachments)?[]:JSON.parse(this.details.attachments)}get message(){return x?this.payload("translation")&&this.payload("translation-language")==SB_ADMIN_SETTINGS.active_agent_language?this.payload("translation"):this.payload("original-message-language")==SB_ADMIN_SETTINGS.active_agent_language?this.payload("original-message"):this.get("message"):this.get("message")}get(e){return e in this.details&&!ee.null(this.details[e])?this.details[e]:""}set(e,t){this.details[e]=t}payload(e=!1,t=!1){let i=this.get("payload");if(!1!==e&&!1!==t)i[e]=t,this.set("payload",i);else if(!1!==e)return e in i?i[e]:!(!i.id||i.id!=e)&&i;return["boolean","string"].includes(typeof i)?[]:i}getCode(){let e=ee.isAgent(this.details.user_type),t=this.message,i=this.attachments,a=this.payload("reply"),n=x?SBAdmin.conversations.messageMenu(e,t,!a&&!e):"",o="",r="",l=x&&SB_ADMIN_SETTINGS.show_profile_images||!x&&(e&&!U.hide_agents_thumb||!e&&U.display_users_thumb)?`<div class="sb-thumb"><img loading="lazy" src="${this.details.profile_image}"><div class="sb-tooltip"><div>${this.details.full_name}</div></div></div>`:"",c=(x&&e||!x&&!e?"sb-right":"")+(l?" sb-thumb-active":""),d="",u=!x&&e&&U.sender_name||x&&"chat-admin"==SB_ADMIN_SETTINGS.sender_name?`<span class="sb-agent-name">${this.get("full_name")}</span>`:"",h=!!x&&this.payload().delivery_failed;if(!t&&!i.length)return"";if(a&&ne.conversation&&ne.conversation.getMessage(a)){a=ne.conversation.getMessage(a);let e=ee.isAgent(a.get("user_type")),t=a.message;t||(t='<div class="sb-message-attachments">',i.forEach(e=>{t+=`<a>${e[0]}</a>`}),t+="</div>"),a=`<div class="sb-reply-message${e?" sb-reply-agent":""}"><span>${e&&x||!e&&!x?s("You"):a.get("full_name")}</span> ${t}</div>`}else a="";if(e){let e=(t=(t=t.replace(/\n/g,"<br>")).replace(/`([\s\S]*?)`/g,e=>e.replace(/\[/g,"&#91;"))).match(/\[([^\[\]]*(?:\[[^\[\]]*\][^\[\]]*)*)\]/g)||[],i=!1,s=e.length;for(p=0;p<s;p++){let s=oe.shortcode(e[p]);if(s[0])if("action"==s[0])t=t.replace(e[p],"");else{let a=oe.generate(s[1],s[0]);a&&(t=t.replace(e[p],a),i=!0,d=`data-type="${s[0]}"`)}}i&&(c+=" sb-rich-cnt",s>1&&(d='data-type="multiple"'))}else if(t.includes("[rating ")){let e=oe.shortcode(t);t=oe.generate(e[1],e[0])}let g=t.includes("data-success")?[...t.matchAll(/data-success="([^"]*)"/g)].map(e=>e[1]):[];for(p=0;p<g.length;p++)t=t.replace(g[p],"{R"+p+"}");t=this.render(t);for(p=0;p<g.length;p++)t=t.replace("{R"+p+"}",g[p]);if(i.length){o='<div class="sb-message-attachments">';for(var p=0;p<i.length;p++){let e=i[p][1],s=e+i[p][0];if("image"==ee.getFileType(s)){let t="";i[p].length>2&&(t=`width="${(t=i[p][2].split("|"))[0]}" style="aspect-ratio: ${t[0]} / ${t[1]}"`),r+=`<div class="sb-image${s.includes(".png")?" sb-image-png":e.includes("sticker_")?" sb-image-sticker":""}"><img loading="lazy" src="${e}" ${t}/></div>`}else"audio"==ee.getFileType(s)||e.includes("voice_message")||e.includes("audioclip")?((x&&!SB_ADMIN_SETTINGS.speech_recognition||!x&&!U.speech_recognition)&&(t=""),o+=`<div class="sb-player"><div class="sb-player-btn sb-icon-play"></div><div class="sb-player-speed"><div class="sb-player-speed-number">1</div><div class="sb-icon-close"></div></div><div class="sb-player-download sb-icon-arrow-down"></div><audio><source src="${e}" type="audio/mpeg"></audio></div>`):o+=`<a rel="noopener" target="_blank" href="${e}">${ee.beautifyAttachmentName(i[p][0])}</a>`}o+="</div>"}return`<div data-id="${this.details.id}" class="${c}" ${d}>${l}${a}<div class="sb-cnt"><div class="sb-message${r&&!t?" sb-message-media":""}"${h?' style="opacity:.7"':""}>${h?SBAdmin.conversations.getDeliveryFailedMessage(h):""}${(u+t+r).trim()}</div>${o}<div class="sb-time">${ee.beautifyTime(this.details.creation_time,!0)}${x&&e&&2==this.details.status_code?'<i class="sb-icon-check"></i>':""}</div></div>${n}</div>`}render(t=!1){!1===t&&(t=""+this.details.message);let i=t.length,s=t.match(/```([\s\S]*?)```/g)||[];for(n=0;n<s.length;n++)t=t.replace(s[n],"[code-"+n+"]");if(t=t.replace(/(?:\r\n|\r|\n)/g,"<br>"),t=t.replace(/\*([^\**]+)\*/g,"<b>$1</b>"),t=t.replace(/__(.+?)__/g,"<i>$1</i>"),t=t.replace(/\~([^\~~]+)\~/g,"<del>$1</del>"),t=t.replace(/\`([^\``]+)\`/g,"<code>$1</code>"),((6==i||5==i)&&t.startsWith("&#x")||i<3&&t.match(/(?:[\u2700-\u27bf]|(?:\ud83c[\udde6-\uddff]){2}|[\ud800-\udbff][\udc00-\udfff]|[\u0023-\u0039]\ufe0f?\u20e3|\u3299|\u3297|\u303d|\u3030|\u24c2|\ud83c[\udd70-\udd71]|\ud83c[\udd7e-\udd7f]|\ud83c\udd8e|\ud83c[\udd91-\udd9a]|\ud83c[\udde6-\uddff]|\ud83c[\ude01-\ude02]|\ud83c\ude1a|\ud83c\ude2f|\ud83c[\ude32-\ude3a]|\ud83c[\ude50-\ude51]|\u203c|\u2049|[\u25aa-\u25ab]|\u25b6|\u25c0|[\u25fb-\u25fe]|\u00a9|\u00ae|\u2122|\u2139|\ud83c\udc04|[\u2600-\u26FF]|\u2b05|\u2b06|\u2b07|\u2b1b|\u2b1c|\u2b50|\u2b55|\u231a|\u231b|\u2328|\u23cf|[\u23e9-\u23f3]|[\u23f8-\u23fa]|\ud83c\udccf|\u2934|\u2935|[\u2190-\u21ff])/))&&(t=`<span class="emoji-large">${t}</span>`),t.includes("](http")){let e=t.split("[");t="";for(n=0;n<e.length;n++)e[n].includes("](http")&&(e[n]=e[n].substring(e[n].indexOf("](")+2,e[n].length-1)),t+=e[n]}t.includes("www.")&&(t=t.replaceAll("www.","https://www.").replaceAll("https://https:","https:").replaceAll("http://https:","http:"));let a=[['href="http',"[L1]"],['src="http',"[L2]"],['url("http',"[L3]"],["url('http","[L4]"],['extra="http',"[L5]"],['data-link="http',"[L6]"],['data-value="http',"[L7]"]];for(n=0;n<a.length;n++)t=t.replaceAll(a[n][0],a[n][1]);t.includes("http")&&(t=t.autoLink({target:"_blank",callback:function(e){return e.includes("#sb-")?`<a href="${e.split("#sb-")[0]}" target="_blank">${e.split("#sb-")[1].replaceAll("--"," ")}</a>`:null}}));for(n=0;n<a.length;n++)t=t.replaceAll(a[n][1],a[n][0]);for(var n=0;n<s.length;n++)t=t.replace("[code-"+n+"]","<pre>"+e.trim(e.trim(s[n].replace(/```<br>/g,"```").replace(/<br>```/g,"```")).replace(/```/g,"").replace(/(?:\r\n|\r|\n)/g,"<br>"))+"</pre>");return t.replace(/&amp;lt;/g,"&lt;")}strip(e=!1){return ee.strip(!1===e?""+this.details.message:e)}}window.SBMessage=se;class ae{constructor(e,t){this.details=ee.null(t)?{}:t,Array.isArray(e)?(this.messages=[],e.length&&(e[0]instanceof se?this.messages=e:ee.error("Messages not of type SBMessage","SBConversation.constructor"))):ee.error("Message array not of type Array","SBConversation.constructor");let i=["conversation_id","conversation_user_id","conversation_first_name","conversation_last_name","conversation_profile_image","conversation_user_type","conversation_creation_time","conversation_status_code"],s=["payload"];for(a=0;a<i.length;a++)t[i[a]]&&(this.details[i[a].replace("conversation_","")]=t[i[a]]),delete this.details[i[a]];for(var a=0;a<s.length;a++)delete this.details[s[a]];t&&(this.details.tags="tags"in t?"string"==typeof t.tags?t.tags.split(","):t.tags:[])}get id(){return this.get("id")}get status_code(){return this.get("status_code")}get(e){if(e in this.details&&!ee.null(this.details[e]))return this.details[e];if("title"==e){if(this.details.title)return this.details.title;if(this.details.first_name)return this.details.first_name+" "+this.details.last_name;if(this.messages.length)return this.messages[0].get("full_name")}return""}set(e,t){this.details[e]=t}getMessage(e){for(var t=0;t<this.messages.length;t++)if(this.messages[t].id==e)return this.messages[t].set("index",t),this.messages[t];return!1}getLastMessage(){for(var e=this.messages.length-1;e>-1;e--)if(this.messages[e].message||this.messages[e].attachments.length||this.messages[e].payload("preview"))return this.messages[e];return!1}getLastUserMessage(e=!1,t=!1){!1===e&&(e=this.messages.length-1);for(var i=e;i>-1;i--){let e=this.messages[i],s=e.get("user_type");if((e.message||e.attachments.length)&&(!t&&!ee.isAgent(s)||!0===t&&("agent"==s||"admin"==s)||"bot"==t&&"bot"==s||"no-bot"==t&&"bot"!=s||"all"==t&&ee.isAgent(s)))return this.messages[i].set("index",i-1),this.messages[i]}return!1}getNextMessage(e,t=!1){let i=this.messages.length;for(var s=0;s<i;s++)if(this.messages[s].id==e&&s<i-1){for(var a=s+1;a<i;a++){let e=this.messages[a].get("user_type"),i=this.messages[s+1];if(!t||"agent"==t&&ee.isAgent(e)||"user"==t&&!ee.isAgent(e))return i}break}return!1}getUserMessages(e="user"){let t=[],i="user"==e?["visitor","lead","user"]:"agents"==e?["agent","admin"]:["bot"];for(var s=0;s<this.messages.length;s++)i.includes(this.messages[s].get("user_type"))&&(this.messages[s].set("index",s),t.push(this.messages[s]));return t}updateMessage(e,t){if(t instanceof se){for(var i=0;i<this.messages.length;i++)if(this.messages[i].id==e)return this.messages[i]=t,!0}else ee.error("Message not of type SBMessage","SBConversation.updateMessage");return!1}addMessages(e){if(Array.isArray(e))for(var t=0;t<e.length;t++)e[t]instanceof se&&this.messages.push(e[t]);else e instanceof se?this.messages.push(e):ee.error("Messages not of type SBMessage","SBConversation.addMessages()");return this}getCode(e=!1){let t=this.getLastMessage();if(t){let n=t.message;if(!n&&t.payload("preview")&&(n=t.payload("preview")),x&&(n=t.payload().preview?t.payload().preview:n),!1!==(n=n.replace(/(\r\n|\n|\r)/gm," ")).indexOf("[")){let e=n.match(/\[.+?\]/g)||[];if(e.length){let t=oe.shortcode(e[0]);t[0]&&(n=n.replace(e[0],"action"==t[0]?"":s(t[1].message?t[1].message:t[1].title?t[1].title:t[1].name&&"false"!=t[1].name&&"true"!=t[1].name?t[1].name:t[1].link?t[1].link:t[1].values?t[1].values.replaceAll(",",", ").replaceAll("  "," "):t[1].options?t[1].options.replaceAll(",",", ").replaceAll("  "," "):s(ee.slugToString(t[0])))))}}if(!n&&t.attachments.length)for(var i=0;i<t.attachments.length;i++)n+=t.attachments[i][0]+" ";if((n=ee.strip(n)).length>114&&(n=n.substr(0,114)+" ..."),e)return n;let o=this.get("title");return(!o||a()&&a().name==o||$&&U.tickets_conversations_title_user)&&(o=a()&&t.get("user_id")==a().id?s("You"):t.get("full_name")),`<div class="sb-conversation-item" data-user-id="${this.get("user_id")}"><img loading="lazy" src="${t.get("profile_image")}"><div><span class="sb-name">${o}</span><span class="sb-time">${ee.beautifyTime(t.get("creation_time"))}</span></div><div class="sb-message">${n}</div></div>`}return""}deleteMessage(e){for(var t=0;t<this.messages.length;t++)if(this.messages[t].id==e)return this.messages.splice(t,1),!0;return!1}searchMessages(e,t=!1){let i=[];for(var s=0;s<this.messages.length;s++){let a=this.messages[s].message;(t&&a==e||!t&&a.includes(e))&&(this.messages[s].set("index",s),i.push(this.messages[s]))}return i}getAttachments(){let e=[];for(var t=0;t<this.messages.length;t++){let s=this.messages[t].attachments;for(var i=0;i<s.length;i++){let a=s[i][1];e.push([s[i][0],a,a.substr(a.lastIndexOf(".")+1),this.messages[t].id])}}return e}updateMessagesStatus(e=!1){if(e)for(t=0;t<this.messages.length;t++){let i=this.messages[t].id;if(e.includes(i)){let e=h.find(`[data-id="${i}"] .sb-time`);e.find("i").length||e.append('<i class="sb-icon-check"></i>')}}else if(!x&&"visible"==ee.visibility_status){e=[];for(var t=0;t<this.messages.length;t++){let i=this.messages[t];ee.isAgent(i.get("user_type"))&&2!=i.get("status_code")&&(e.push(i.id),i.set("status_code",2))}e.length&&ee.ajax({function:"update-messages-status",message_ids:e})}}}window.SBConversation=ae;var ne={emoji_options:{range:0,range_limit:47,list:[],list_now:[],touch:!1},initialized:!1,editor_listening:!1,conversation:!1,is_busy:!1,is_busy_update:!1,is_busy_populate:!1,chat_open:!1,real_time:!1,agent_id:-1,agent_online:!1,user_online:!1,expanded:!1,main_header:!0,start_header:!1,desktop_notifications:!1,flash_notifications:!1,id_last_message:0,id_last_message_conversation:0,datetime_last_message_conversation:"2000-01-01 00:00:00",audio:!1,audio_interval:!1,tab_active:!0,notifications:i("notifications")?i("notifications"):[],typing_settings:{typing:!1,sent:!1,timeout:!1},email_sent:!1,dashboard:!1,articles:!1,articles_allowed_ids:!1,articles_category:!1,slack_channel:[-1,-1],skip:!1,queue_interval:!1,departments:!1,default_department:null,default_agent:null,default_tags:null,offline_message_set:!1,label_date:!1,label_date_show:!1,sendMessage:function(t=-1,i="",n=[],o=!1,r=!1,l=!1){let c=w&&le.dialogflow.active(),d=!1,u=this.conversation,f=g.find("> [data-reply]").attr("data-reply");if(!a()&&!x)return this.addUserAndLogin(()=>this.sendMessage(t,i,n,o,r),!0),void this.busy(!0);if(!u){let e=!x&&a().getLastConversation();if(!e||"new-conversation"==P||ne.default_department&&ne.default_department!=e.get("department")||ne.default_agent&&ne.default_agent!=e.get("agent_id"))return this.newConversation(l,t,"",[],x&&SB_ACTIVE_AGENT.department?SB_ACTIVE_AGENT.department:null,null,()=>this.sendMessage(t,i,n,o,r)),void this.busy(!0);this.openConversation(e.id),this.setConversation(e),P=!1}this.calculateLabelDateFirst(),-1==t&&(t=x?SB_ACTIVE_AGENT.id:a().id);let m=t!=y;if(i||n.length||(i=p.val().trim(),g.find(".sb-attachments > div").each(function(){let t=[e(this).attr("data-name"),e(this).attr("data-value")];e(this).attr("data-size")&&t.push(e(this).attr("data-size")),n.push(t)}),x&&SBAdmin.must_translate&&i&&(le.dialogflow.translate([i],a().language,e=>{if(e.length){let t=x?SB_ADMIN_SETTINGS.active_agent_language:a().language;r?(r["original-message"]=i,r["original-message-language"]=t):r={"original-message":i,"original-message-language":t},e[0]&&(i=e[0])}this.sendMessage(t,i,n,o,r,l)}),d=!0)),this.busy(!0),m&&(p.val("").css("height",""),g.find(".sb-attachments").html("")),g.sbActive(!1),!d)if(!1===l&&t==y&&(l="skip"),x||!m||c||(l=2),f&&(r?r.reply=i:r={reply:f}),i||n.length||r){let e={user_id:t,user:a(),conversation_id:u.id,conversation:u,conversation_status_code:l,attachments:n,payload:r};ee.ajax({function:"send-message",user_id:t,conversation_id:u.id,message:i,attachments:n,conversation_status_code:l,queue:!x&&U.queue&&m,payload:r,recipient_id:!!x&&a().id},s=>{let l=x||!c||s.human_takeover_active;x||t!=y||(this.dashboard?this.updateConversations():this.chat_open||this.updateNotifications(u.id,s.id)),(x&&!this.user_online||!x&&!this.agent_online)&&this.update(),x||!m||w||(this.followUp(),this.offlineMessage()),!x&&m&&(!r||"sb-human-takeover"!=r.id&&ee.null(r["skip-dialogflow"]))&&le.dialogflow.message(i,n),!x&&m&&"visitor"==a().type?ee.ajax({function:"update-user-to-lead",user_id:t},()=>{a().set("user_type","lead"),U.slack_active&&l&&this.slackMessage(t,a().name,a().image,i,n)}):l&&!this.skip&&(x&&SB_ADMIN_SETTINGS.slack_active?this.slackMessage(a().id,SB_ACTIVE_AGENT.full_name,SB_ACTIVE_AGENT.profile_image,i,n):U.slack_active&&this.slackMessage(a().id,m?a().name:U.bot_name,m?a().image:U.bot_image,i,n)),m&&U.language_detection&&u&&i.split(" ").length&&i.length>3&&!ee.storage("language-detection-completed")&&(ee.ajax({function:"google-language-detection-update-user",user_id:t,string:i,token:le.dialogflow.token},e=>{e&&(U.translations=e)}),ee.storage("language-detection-completed",!0)),!this.articles||x||!U.articles||U.office_hours||this.isInitDashboard()||setTimeout(()=>{this.conversation&&u.id==this.conversation.id&&(this.sendMessage(y,"[articles]"),this.scrollBottom(),this.articles=!1)},5e3),s.queue&&this.queue(this.conversation.id),e.message=s.message,e.message_id=s.id,ee.event("SBMessageSent",e),$&&SBTickets.onMessageSent(),o&&o(e),s.notifications.length&&ee.event("SBNotificationsSent",s.notifications),this.skip&&(this.skip=!1),x&&(SBAdmin.conversations.previous_editor_text=!1),this.busy(!1)}),m&&(i=ee.escape(i),h.append(new se({id:"sending",profile_image:x?SB_ACTIVE_AGENT.profile_image:a().image,full_name:x?SB_ACTIVE_AGENT.full_name:a().name,creation_time:"0000-00-00 00:00:00",message:i.replaceAll("<","&lt;"),user_type:x?"agent":"user"}).getCode().replace('<div class="sb-time"></div>',`<div class="sb-time">${s("Sending")}<i></i></div>`))),this.dashboard||!m&&!this.isBottom()||this.scrollBottom()}else this.busy(!1)},updateMessage:function(e,t=""){ee.ajax({function:"update-message",message_id:e,message:t})},sendEmail:function(e,t,i=!1,s=!1){let n=i?!0===i?a().id:i:this.getRecipientUserID();if(!x&&!isNaN(n)&&this.agent_online)return!1;ee.ajax({function:"create-email",recipient_id:n,sender_name:x?i?SB_ACTIVE_AGENT.full_name:a().name:i?U.bot_name:a().name,sender_profile_image:x?i?SB_ACTIVE_AGENT.profile_image:a().name:i?U.bot_image:a().image,message:e,attachments:t,department:!!this.conversation&&this.conversation.get("department"),conversation_id:!!this.conversation&&this.conversation.id},e=>{s&&s(e)})},sendSMS:function(e){let t=this.getRecipientUserID();if(!x&&!isNaN(t)&&this.agent_online)return!1;ee.ajax({function:"send-sms",to:t,message:e,conversation_id:!!this.conversation&&this.conversation.id},t=>{"sent"==t.status||"queued"==t.status?ee.event("SBSMSSent",{recipient_id:this.getRecipientUserID(),message:e,response:t}):t.message&&ee.error(t.message,"SBChat.sendSMS")})},desktopNotification:function(e,t,i,s=!1,n=!1){if("granted"!==Notification.permission)Notification.requestPermission();else{ee.serviceWorker.sw.showNotification(e,{body:ee.strip(t),icon:i.indexOf("user.svg")>0?U.notifications_icon:i}).onclick=(()=>{x?s?(SBAdmin.conversations.openConversation(s,0==n?a().id:n),SBAdmin.conversations.update()):n&&SBAdmin.profile.show(n):this.start(),window.focus()})}},getRecipientUserID:function(){return x?a().id:this.lastAgent(!1)?this.lastAgent(!1).user_id:ee.null(this.conversation.get("agent_id"))?ee.null(this.conversation.get("department"))?"agents":"department-"+this.conversation.get("department"):this.conversation.get("agent_id")},submit:function(){if(!this.is_busy){if(k&&k.sbActive()){let e=k.find(".sb-btn-mic");return k.sbActive(!1),e.hasClass("sb-icon-pause")&&e.click(),void setTimeout(()=>{let e=new FormData,t=!!this.conversation&&this.conversation.get("source");"wa"==t||H.length?(e.append("file",new File(["wa"==t?SBAudioRecorder.blob():new Blob(H,{type:"ig"==t?"audio/wav":"audio/mp3"})],"voice_message."+("ig"==t?"wav":"mp3"))),ee.upload(e,e=>{ne.uploadResponse(e),this.submit()})):this.submit(),k.find(".sb-icon-close").click()},100)}this.sendMessage(),U.cron_email_piping_active&&(setTimeout(()=>{ee.ajax({function:"email-piping"}),U.cron_email_piping_active=!0},6e4),U.cron_email_piping_active=!1),Q&&ee.serviceWorker.initPushNotifications(),x&&SBAdmin.conversations.setStatus(1,!1,!0),ne.cancelReply()}},initChat:function(){x||ee.getActiveUser(!0,()=>{let e=!1!==a(),t=!!e&&a().type;if($||!U.popup||i("popup")||O&&U.popup_mobile_hidden||this.popup(),ne.automations.runAll(),$||!U.privacy||U.registration_required||i("privacy-approved")){if(typeof Notification!==G&&!U.push_notifications_users&&(["all","users"].includes(U.desktop_notifications)||x&&"agents"==U.desktop_notifications)&&(this.desktop_notifications=!0),(["all","users"].includes(U.flash_notifications)||x&&"agents"==U.flash_notifications)&&(this.flash_notifications=!0),this.registration(!0)&&!$)return this.registration(),void(!e&&U.visitors_registration&&this.addUserAndLogin());e||!(typeof SB_WP_WAITING_LIST!==G||U.visitors_registration||U.welcome||$||U.flow_on_load)||$&&U.tickets_registration_required?!this.conversation&&e?this.populateConversations():this.finalizeInit():this.addUserAndLogin(()=>{this.welcome(),le.dialogflow.flowOnLoad(),le.woocommerce.waitingList(),this.finalizeInit()}),U.header_name&&e&&"user"==t&&!$&&f.find(".sb-title").html(`${s("Hello")} ${a().nameBeautified}!`),this.welcome(),te.active||setInterval(()=>{this.updateConversations(),this.updateUsersActivity()},10200),le.dialogflow.flowOnLoad(),le.woocommerce.waitingList(),this.scrollBottom(!0)}else this.privacy()})},finalizeInit:function(){this.initialized||(l.attr("style",""),x||$||(this.isInitDashboard()&&this.showDashboard(),!O&&window.innerHeight<760&&l.find(" > .sb-body").css("max-height",window.innerHeight-130+"px")),this.initialized=!0,x||(a()&&!this.registration(!0)&&(i("open-conversation")&&this.openConversation(i("open-conversation")),ee.getURL("conversation")&&this.openConversation(ee.getURL("conversation"))),(!this.chat_open&&(!O&&i("chat-open")||"open"==ee.getURL("chat"))||ee.getURL("conversation"))&&setTimeout(()=>{this.start()},500),U.woocommerce_returning_visitor&&(!1===i("returning-visitor")?ee.storageTime("returning-visitor"):ee.storageTime("returning-visitor",24)&&!i("returning-visitor-processed")&&setTimeout(()=>{ee.ajax({function:"woocommerce-returning-visitor"},()=>{i("returning-visitor-processed",!0)})},15e3)),U.timetable_type&&ne.offlineMessage(),U.queue_human_takeover&&le.dialogflow.humanTakeoverActive()&&(U.queue=!0),e(window).on("resize",function(){!O&&window.innerHeight<760&&l.find(" > .sb-body").css("max-height",window.innerHeight-130+"px")}),le.dialogflow.flowOnLoad()),$&&SBTickets.init(),ee.event("SBInit"))},start:function(){this.initialized&&(this.populate(),this.headerAgent(),this.updateUsersActivity(),this.startRealTime(),this.popup(!0),this.conversation&&this.updateNotifications(this.conversation.id),l.sbActive(!0),e("body").addClass("sb-chat-open"),this.chat_open=!0,"open"!=U.welcome_trigger||this.registration(!0)||this.welcome(),le.martfury.privateChat(),this.calculateLabelDates())},open:function(t=!0){t&&!this.chat_open?(this.start(),this.chat_open=!0,this.startRealTime(),l.sbActive(!0),e("body").addClass("sb-chat-open"),i("chat-open",!0),this.conversation&&i("last-open-message",this.conversation.getLastMessage().id),O&&history.pushState({"chat-open":!0},"",""),ee.event("SBChatOpen")):!t&&this.chat_open&&(l.sbActive(!1),this.stopRealTime(),this.chat_open=!1,i("chat-open",!1),e("body").removeClass("sb-chat-open"),ee.event("SBChatClose"))},openConversation:function(e){a().getFullConversation(e,t=>{if(!t.id||!ne.isConversationAllowed(t.get("source"),t.status_code))return i("open-conversation",""),!1;this.setConversation(t),this.hideDashboard(),this.populate(),this.main_header=!1,i("chat-open")&&!O&&ne.open(),i("queue")==e&&this.queue(e),(this.chat_open||$)&&this.updateNotifications(e),$&&SBTickets.activateConversation(t),i("open-conversation",e),ee.event("SBConversationOpen",t)})},update:function(){if(this.conversation){if(this.is_busy_update)return;let e=this.conversation.getLastMessage(),t=!1;ee.ajax({function:"get-new-messages",conversation_id:this.conversation.id,datetime:this.datetime_last_message_conversation,last_id:this.id_last_message_conversation},s=>{let n=s.length;if(this.is_busy_update=!1,this.conversation&&Array.isArray(s)&&n>0&&(!e||e.id!=s[n-1].id||e.message!=s[n-1].message||e.payload!=s[n-1].payload||e.attachments!=s[n-1].attachments)){let e="",r=[],l=[],c=!1;this.calculateLabelDateFirst();for(var o=0;o<n;o++)if(!(l.includes(s[o].id)||x&&this.conversation.id!=s[o].conversation_id)){let n=new se(s[o]),d=n.payload();if(this.id_last_message_conversation=n.id,this.datetime_last_message_conversation=n.get("creation_time"),d.event){let e=d.event;("delete-message"!=e||!1===this.conversation.getMessage(n.id))&&(x||n.message||n.attachments.length||d)||this.deleteMessage(n.id),"woocommerce-update-cart"!=e||x||le.woocommerce.updateCart(d.action,d.id),"woocommerce-checkout"!=e||x||le.wordpress.ajax("url",{url_name:"checkout"},e=>{setTimeout(()=>document.location=e,500)}),le.dialogflow.active()||"conversation-status-update-3"!=e&&"conversation-status-update-4"!=e&&"activate-bot"!=e||(le.dialogflow.active("activate"),c=!0),"conversation-status-update-3"==e&&this.conversationArchived()}d["human-takeover"]&&U.queue_human_takeover&&(U.queue=!0,ne.queue(ne.conversation.id)),d["human-takeover-fallback"]&&(le.dialogflow.typing_enabled=!1),this.conversation.getMessage(s[o].id)?(this.conversation.updateMessage(n.id,n),h.find(`[data-id="${n.id}"]`).replaceWith(n.getCode()),t=!0):((n.message||n.attachments.length)&&h.find('[data-id="sending"]').remove(),this.conversation.id==s[o].conversation_id&&(this.conversation.addMessages(n),e+=n.getCode(),t=!1)),this.conversation.updateMessagesStatus(),r.push(n),l.push(n.id),this.chat_open&&i("last-open-message",n.id),x||!this.dashboard&&this.chat_open&&this.tab_active||n.get("user_id")==a().id||!n.message&&!n.attachments.length||this.updateNotifications(this.conversation.id,n.id)}h.append(e);let d=this.conversation.getLastMessage(),u=!!d&&d.get("user_type"),g=ee.isAgent(u),p=g&&"bot"!=u;!x&&p&&(this.chat_open&&(!d||d.message.includes("sb-rich-success")||s[0].payload&&s[0].payload.includes("conversation-status-update")||this.setConversationStatus(0),U.follow&&clearTimeout(E)),c||le.dialogflow.active(!1)),i("queue")==this.conversation.id&&p&&this.queue("clear"),!r.length||ee.null(r[0].message)&&ee.null(r[0].attachments)&&1==n||(x||this.tab_active||this.flashNotification(),this.audio&&(!x&&g||x&&!g)&&this.playSound()),this.headerAgent(),t||this.dashboard||(this.scrollBottom(),setTimeout(()=>{this.scrollBottom()},300)),!U.auto_open||!this.dashboard&&this.chat_open||this.open(),p&&this.typing(-1,"stop"),this.busy(!1),ee.event("SBNewMessagesReceived",{messages:r,conversation_id:this.conversation.id}),$&&SBTickets.onNewMessageReceived(r[0],this.conversation.id)}}),this.is_busy_update=!0,setTimeout(()=>{this.is_busy_update=!1},5e3)}else this.updateConversations()},updateConversations:function(){a()&&ee.ajax({function:"get-new-user-conversations",datetime:this.id_last_message},e=>{if(e.length){this.id_last_message=e[0].message_id,this.chat_open&&i("last-open-message",this.id_last_message);for(var t=0;t<e.length;t++){let i=e[t].conversation_status_code;if(!ne.isConversationAllowed(e[t].source,i))continue;let s=e[t].conversation_id,n=new se(e[t]),o=new ae([n],e[t]),r=a().addConversation(o);e[t].message_user_id==a().id||this.conversation.id==s&&this.chat_open||!n.message&&!n.attachments.length||(this.updateNotifications(s,n.id),U.auto_open&&this.open());let l=n.payload();if("boolean"!=typeof l&&l.event){if("open-chat"==l.event&&((this.conversation.id!=s||this.dashboard)&&this.openConversation(s),O||setTimeout(()=>{this.open()},500)),!n.message&&!n.attachments.length)continue}this.tab_active||(this.desktop_notifications&&ne.desktopNotification(n.get("full_name"),n.message,n.get("profile_image")),this.flash_notifications&&this.flashNotification(),x||!this.audio||!U.sound||this.chat_open&&!this.dashboard&&this.conversation.id==s||ee.null(n.message)&&ee.null(n.attachments)||this.playSound()),r&&ee.event("SBNewConversationReceived",o),$&&SBTickets.onConversationReceived(o),!this.conversation&&r&&this.openConversation(o.id)}this.conversation&&this.conversation.updateMessagesStatus(),l.find(".sb-user-conversations").html(a().getConversationsCode()),l.find(".sb-dashboard-conversations").setClass("sb-conversations-hidden",l.find(".sb-user-conversations > li").length>3)}})},populate:function(){if(this.conversation){let t="",a=h.find(" > .sb-notify-message"),n=!1,o=this.conversation.id;for(var e=0;e<this.conversation.messages.length;e++){let i=this.conversation.messages[e],a=ee.beautifyTime(i.get("creation_time"));a.includes("today")&&(a=`<span>${s("Today")}</span>`),a!=n&&(i.message||i.attachments.length)&&(t+=`<div class="sb-label-date">${a}</div>`,n=a),t+=i.getCode()}if(h.html((a.length?a[0].outerHTML:"")+t),!this.dashboard&&(this.scrollBottom(),this.calculateLabelDates(),x&&SB_ADMIN_SETTINGS.notify_email_cron||!x&&U.notify_email_cron)){let e=this.conversation.getLastUserMessage(!1,!x);e&&e.id!=i("email-cron-"+o)&&(ee.ajax({function:"remove-email-cron",conversation_id:o}),i("email-cron-"+o,e.id))}}else a()&&!a().isConversationsEmpty()&&(U.disable_dashboard?this.openConversation(a().conversations[0].id):this.showDashboard())},populateConversations:function(e=!1){!this.is_busy_populate&&a()&&(this.is_busy_populate=!0,setTimeout(()=>{this.is_busy_populate=!1},5e3),a().getConversations(t=>{let s=t.length,n=[];if(s){let e=Date.now(),r=t[0].messages[0];this.id_last_message=r.id;for(o=0;o<s;o++)n.push(t[o].id),$||1!=t[o].status_code||!(i("last-open-message")<r.id)||this.conversation&&this.conversation.id==t[o].id||this.updateNotifications(t[o].id,r.id),!O&&e-ee.UTC(t[o].messages[0].get("creation_time"))<6e3&&this.open();l.find(".sb-user-conversations").html(a().getConversationsCode()),l.find(".sb-dashboard-conversations").setClass("sb-conversations-hidden",l.find(".sb-user-conversations > li").length>3)}l.setClass("sb-no-conversations",!s),this.initialized&&"open-conversation"!=P||1!=s||this.isInitDashboard()||i("open-conversation")||(this.openConversation(a().getLastConversation().id),"open-conversation"==P&&(P=""));for(var o=0;o<ne.notifications.length;o++)this.updateNotifications(ne.notifications[o][0],!!n.includes(ne.notifications[o][0])&&ne.notifications[o][1]);e&&e(t),this.finalizeInit(),ee.event("SBPopulateConversations",{conversations:t})}))},newConversation:function(e,t=-1,i="",s=[],n=null,o=null,r=!1){a()?ee.ajax({function:"new-conversation",status_code:e,title:$?l.find(".sb-ticket-title input").val():null,department:ee.null(n)?this.default_department:n,agent_id:ee.null(o)?this.default_agent:o,tags:this.default_tags,source:$?"tk":""},a=>{if(ee.errorValidation(a,"user-not-found"))return void this.addUserAndLogin(()=>{this.newConversation(e,t,i,s,n,o,r)});let l=new ae([],a.details);this.setConversation(l),(i||s.length)&&this.sendMessage(t,i,s),t!=y&&setTimeout(()=>{this.queue(l.id)},1e3),r&&r(l)}):ee.error("activeUser() not setted","SBChat.newConversation")},setConversation:function(e){if(e instanceof ae){let s=a().conversations,n=!0;this.conversation=e,this.id_last_message_conversation=this.conversation.getLastMessage()?this.conversation.getLastMessage().id:0,this.datetime_last_message_conversation=0==this.conversation.getLastMessage()?"2000-01-01 00:00:00":this.conversation.getLastMessage().get("creation_time"),e.id!=this.conversation.id&&this.queue(e.id);for(var t=0;t<s.length;t++)if(s[t].id==e.id){s[t]=e,n=!1;break}n&&s.push(e),i("open-conversation",e.id),le.dialogflow.typing_enabled=!0,this.headerAgent(),ee.event("SBActiveConversationChanged",e)}else ee.error("Value not of type SBConversation","SBChat.setConversation")},queue:function(e){if("clear"==e)return l.removeClass("sb-notify-active sb-queue-active"),h.find(" > .sb-notify-message").remove(),clearInterval(this.queue_interval),this.queue_interval=!1,i("queue",""),void(U.queue_sound&&!ne.tab_active&&ne.playSound(999));!x&&U.queue&&ee.ajax({function:"queue",conversation_id:e,department:this.conversation.get("department")},t=>{h.find(" > .sb-notify-message").remove();let a=t[0];if(0==a)this.queue("clear");else{let n=(U.queue_response_time?parseInt(U.queue_response_time):5)*a,o=s(U.queue_message?U.queue_message:"Please wait for an agent. You are number {position} in the queue. Your waiting time is approximately {minutes} minutes.").replace("{position}","<b>"+a+"</b>").replace("{minutes}","<b>"+n+"</b>");t[1]&&h.prepend(`<div class="sb-notify-message sb-rich-cnt"><div class="sb-cnt"><div class="sb-message">${o}</div></div></div>`),!1===this.queue_interval&&(this.queue_interval=setInterval(()=>{this.queue(e)},10100),t[1]&&l.addClass("sb-notify-active sb-queue-active"),i("queue",e))}ee.event("SBQueueUpdate",a)})},getDepartmentCode(e,t){if(this.departments)if("all"==e){let e="";for(var i in this.departments)this.getDepartmentCode(this.departments[i].id,t=>{e+=t});t(e)}else t(`<div data-color="${this.departments[e].color}">${this.departments[e].image?`<img loading="lazy" src="${this.departments[e].image}" />`:""}<div>${this.departments[e].name}<div></div>`);else ee.ajax({function:"get-departments"},i=>{i&&(this.departments=i,this.getDepartmentCode(e,t))})},startRealTime:function(){te.active||(this.stopRealTime(),this.real_time=setInterval(()=>{this.update(),this.typing(x?a()?a().id:-1:this.agent_id,"check")},1e3))},stopRealTime:function(){clearInterval(this.real_time)},updateUsersActivity:function(){a()&&ee.updateUsersActivity(a().id,this.agent_id,t=>{this.typing_settings.typing||("online"==t||this.agent_id==y?(e(m).addClass("sb-status-online").html(s("Online")),this.agent_online=this.agent_id!=y):(e(m).removeClass("sb-status-online").html(s("Away")),this.agent_online=!1))})},busy:function(e){g&&g.find(".sb-loader").sbActive(e),this.is_busy=e,ee.event("SBBusy",e)},headerAgent:function(e=!1){if(!x&&!$&&!this.dashboard&&this.conversation&&(-1==this.agent_id||this.conversation.getLastMessage()&&ee.isAgent(this.conversation.getLastMessage().get("user_type"))&&this.conversation.getLastMessage().get("user_id")!=this.agent_id)){let t=this.lastAgent(!1);!(t=t&&le.dialogflow.humanTakeoverActive()&&te.active&&!te.presenceCheck({info:{user_type:"agent"},id:t.user_id})?t:this.lastAgent())&&e&&(t={user_id:U.bot_id,full_name:U.bot_name,profile_image:U.bot_image}),this.headerReset(),t?(this.agent_id=t.user_id,f.addClass("sb-header-agent").attr("data-agent-id",this.agent_id).html(`<div class="sb-dashboard-btn sb-icon-arrow-left"></div><div class="sb-profile"><img loading="lazy" src="${t.profile_image}" /><div><span class="sb-name">${t.full_name}</span><span class="sb-status">${s("Away")}</span></div><i class="sb-icon sb-icon-close ${U.close_chat?"sb-close-chat":"sb-responsive-close-btn"}"></i></div><div class="sb-label-date-top"></div>`),m=f.find(".sb-status"),this.updateUsersActivity(),this.label_date=f.find(".sb-label-date-top"),ee.storageTime("header-animation",1)&&this.headerAnimation()):f.html(this.start_header[0]).addClass(this.start_header[1])}},headerReset:function(){0==this.start_header&&(this.start_header=[f.html(),f.attr("class")]),f.removeClass("sb-header-main sb-header-brand sb-header-agent sb-header-minimal"),this.main_header=!1},headerAnimation:function(){f.addClass("sb-header-animation"),setTimeout(()=>{f.removeClass("sb-header-animation")},8e3),ee.storageTime("header-animation")},lastAgent:function(e=!0){let t=!1;if(this.conversation){let i=this.conversation.getLastUserMessage(!1,!e||"all");i&&(t={user_id:i.get("user_id"),full_name:i.get("full_name"),profile_image:i.get("profile_image")})}return t},scrollBottom:function(e=!1){setTimeout(()=>{_.scrollTop(e?0:_[0].scrollHeight),this.scrollHeader()},20)},isBottom:function(){return _[0].scrollTop===_[0].scrollHeight-_[0].offsetHeight},scrollHeader:function(){if(this.main_header&&this.dashboard){let e=_.scrollTop();e>-1&&e<1e3&&f.find(".sb-content").css({opacity:1-e/500,top:e/10*-1+"px"})}},showDashboard:function(){x||$||(l.addClass("sb-dashboard-active"),f.removeClass("sb-header-agent"),this.hidePanel(),this.start_header&&f.html(this.start_header[0]).addClass(this.start_header[1]),_.find(" > div").sbActive(!1),l.find(".sb-dashboard").sbActive(!0),this.populateConversations(),this.conversation=!1,this.agent_id=-1,this.stopRealTime(),this.dashboard=!0,this.main_header=!0,this.scrollBottom(!0),ee.event("SBDashboard"))},hideDashboard:function(){x||$||(h.sbActive(!0),l.removeClass("sb-dashboard-active").find(".sb-dashboard").sbActive(!1),this.dashboard=!1,this.headerAgent(),this.scrollHeader(0),this.chat_open&&this.startRealTime(),ee.event("SBDashboardClosed"))},showPanel:function(e,t){if($)return SBTickets.showPanel(e,t);let i=_.find(" > .sb-panel-"+e);i.length&&(_.find(" > div").sbActive(!1),i.sbActive(!0),this.start_header||(this.start_header=[f.html(),f.attr("class")]),f.attr("class","sb-header sb-header-panel").html(`<span>${s(t)}</span><div class="sb-dashboard-btn sb-icon-close"></div>`),l.addClass("sb-panel-active"),this.dashboard=!0),ee.event("SBPanelActive",e)},hidePanel:function(){l.removeClass("sb-panel-active"),f.removeClass("sb-header-panel")},clear:function(){this.conversation=!1,h.html("")},updateNotifications:function(e,t=!1){let s=!1;if(t){for(a=0;a<this.notifications.length;a++)this.notifications[a][0]==e&&t==this.notifications[a][1]&&(s=!0);s||(this.notifications.push([e,t]),!this.dashboard&&this.conversation&&this.conversation.id!=e&&this.headerAnimation())}else{let t=[];for(var a=0;a<this.notifications.length;a++)this.notifications[a][0]==e?s=!0:t.push(this.notifications[a]);!x&&s&&["0",0].includes(this.conversation.status_code)&&this.setConversationStatus(1),this.notifications=t}let n=this.notifications.length;i("notifications",this.notifications),l.find(".sb-chat-btn span").attr("data-count",n).html(n>-1?n:0),ee.event("SBNotificationsUpdate",{conversation_id:e,message_id:t})},setConversationStatus:function(e){return!!this.conversation&&(ee.ajax({function:"update-conversation-status",conversation_id:this.conversation.id,status_code:e},()=>{this.conversation.set("status_code",e),ee.event("SBActiveConversationStatusUpdated",{conversation_id:this.conversation.id,status_code:e})}),!0)},typing:function(t=-1,i="check"){if(this.conversation){let n=this.agent_online||x&&this.user_online;if("check"==i&&!te.active&&-1!=t&&t!=y&&n)ee.ajax({function:"is-typing",user_id:t,conversation_id:this.conversation.id},e=>{e&&!this.typing_settings.typing?this.typing(-1,"start"):!e&&this.typing_settings.typing&&this.typing(-1,"stop")});else if("set"==i&&n){let e=this.conversation.get("source");clearTimeout(I),e&&(e="fb"==e?[e,a().getExtra("facebook-id").value,this.conversation.get("extra")]:"tw"==e&&[e,a().getExtra("twitter-id").value]),te.active?ee.debounce(()=>{te.trigger("client-typing",{user_id:x?SB_ACTIVE_AGENT.id:a().id,conversation_id:this.conversation.id}),e&&ee.ajax({function:"set-typing",source:e})},"#2"):this.typing_settings.sent?(clearTimeout(this.typing_settings.timeout),this.typing_settings.timeout=setTimeout(()=>{ee.ajax({function:"set-typing",user_id:t,conversation_id:-1},()=>{this.typing_settings.sent=!1})},2e3)):(this.typing_settings.sent=!0,ee.ajax({function:"set-typing",user_id:t,conversation_id:this.conversation.id,source:e}),this.typing(t,"set"))}else if("start"==i||"stop"==i){let t="start"==i;if(!x&&m)if(t)e(m).addClass("sb-status-typing").html(s("Typing"));else{let t=this.agent_online||this.agent_id==y;clearTimeout(I),e(m).removeClass("sb-status-typing").html(s(t?"Online":"Away")),t&&e(m).addClass("sb-status-online")}this.typing_settings.typing=t,ee.event("SBTyping",t)}}},showArticles:function(e=!1,t=!1){let i=$?l.find(".sb-panel-main .sb-panel"):_.find(" > .sb-panel-articles");i.html("").sbLoading(!0),this.showPanel("articles",U.articles_title?U.articles_title:"Help Center"),!e&&U.articles_categories?this.getArticleCategories(e=>{this.showArticles_(e,i,{categories:e})},"parent"):this.getArticles(!t&&e,s=>{e&&!t?(i.html(this.getArticleCode(s[0])),i.sbLoading(!1),ee.event("SBArticles",{id:e,articles:s})):this.showArticles_(s,i,{id:e,articles:s})},!!t&&e)},showArticles_:function(e,t,i){let s="",a=typeof SB_LANG!=G&&SB_LANG[0];for(var n=0;n<e.length;n++){let t="content"in e[n];s+=`<div data-id="${e[n].id}"${t?"":' data-is-category="true"'}><div>${t?e[n].title:a&&e[n].languages&&e[n].languages[a]?e[n].languages[a].title:e[n].title}</div><span>${t?e[n].content:a&&e[n].languages&&e[n].languages[a]?e[n].languages[a].description:e[n].description?e[n].description:""}</span></div>`}t.html(`<div class="sb-articles">${s}</div>`),t.sbLoading(!1),ee.event("SBArticles",i)},getArticles:function(e=!1,t=!1,i=!1,s=!1){ee.ajax({function:"get-articles",categories:this.articles_category?this.articles_category:i,id:e||this.articles_allowed_ids,count:s,return_categories:!!this.articles_category,full:e,skip_language:!0},e=>{t(e)})},getArticleCategories:function(e=!1,t=!1){ee.ajax({function:"get-articles-categories",category_type:t},t=>{e(t)})},searchArticles:function(t,i,a){t&&(e(i).sbLoading(!0),ee.ajax({function:"search-articles",search:t},t=>{let n="";if(0==t.length)n+=`<p class="sb-no-results">${s("No articles found.")}</p>`;else for(var o=0;o<t.length;o++)n+=`<div data-id="${t[o].id}"><div>${t[o].title}</div><span>${t[o].content}</span></div>`;e(a).html(n),e(i).sbLoading(!1)}))},setArticleRating:function(e,t,i=!1){ee.ajax({function:"article-ratings",article_id:e,rating:t},e=>{i&&i(e)})},articleRatingOnClick:function(t){let i=e(t).closest(".sb-article");if(!i[0].hasAttribute("data-user-rating")){e(t).parent().sbLoading();let s="positive"==e(t).attr("data-rating")?1:-1,a=e(t).closest(".sb-article").attr("data-id");ne.setArticleRating(a,s,()=>{ee.storage("article-rating-"+a,s),i.attr("data-user-rating",s),e(t).parent().sbLoading(!1)})}},getArticleCode:function(e){let t=ee.storage("article-rating-"+e.id),i="";if(this.articles_categories&&!ee.null(e.categories))for(var a=0;a<this.articles_categories.length;a++){let t=this.articles_categories[a].id;(e.categories.includes(t)||e.parent_category==t)&&(i+=`<span data-id="${t}">${s(this.articles_categories[a].title)}</span>`)}return`<div data-id="${e.id}"${t?` data-user-rating="${t}"`:""} class="sb-article"><div class="sb-title">${e.title}<div class="sb-close sb-icon-close"></div></div><div class="sb-content">${e.content.replace(/(?:\r\n|\r|\n)/g,"<br>")}</div>${e.link?`<a href="${e.link}" target="_blank" class="sb-btn-text"><i class="sb-icon-plane"></i>${s("Read more")}</a>`:""}${i?`<div class="sb-article-category-links">${i}</div>`:""}<div class="sb-rating"><span>${s("Rate and review")}</span><div><i data-rating="positive" class="sb-submit sb-icon-like"><span>${s("Helpful")}</span></i><i data-rating="negative" class="sb-submit sb-icon-dislike"><span>${s("Not helpful")}</span></i></div></div></div>`},initArticlesPage:function(){let i=ee.getURL("article_id"),a=ee.getURL("category"),n=ee.getURL("search");if(U.articles_url_rewrite){let e=location.href.replace(U.articles_url_rewrite,"").split("/");"category"==e[e.length-2]&&(a=e[e.length-1]),(2==e.length&&!e[0]&&e[1]||1==e.length&&e[0])&&(i=e[e.length-1]),U.articles_page_url}if((V=e("body").find("#sb-articles")).length||(V=e("body")),V.sbLoading()){let e=SB_URL+"/include/articles.php"+(a?"?category="+a:i?"?article_id="+i:n?"?search="+n:"");W&&(e+=(e.includes("?")?"&":"?")+"cloud="+W),ee.loadResource(SB_URL+"/css/articles.css"),ee.cors("GET",e,e=>{V.html(e),V.sbLoading(!1)})}V.on("keydown",".sb-panel-side input",function(t){13==t.which&&e(this).next().click()}),V.on("click",".sb-articles > [data-id]",function(){cache=panel_main.html(),panel_main.sbLoading(!0),ne.getArticles(e(this).attr("data-id"),e=>{panel_main.removeClass("sb-articles").html(ne.getArticleCode(e)),panel_main.sbLoading(!1)})}),V.on("click",".sb-article [data-rating]",function(){ne.articleRatingOnClick(this)}),V.on("click",".sb-article .sb-title .sb-close",function(){V.find(".sb-panel-main").addClass("sb-articles").html(cache)}),V.on("click",".sb-submit-articles",function(){let t=e(this).parent().find("input").val();t?(cache=panel_main.html(),panel_main.html(""),ne.searchArticles(t,this,panel_main)):panel_main.html(cache),panel_main.addClass("sb-articles")}),V.on("click",".sb-article-categories [data-id]",function(){if(t(panel_main))return;let i="";cache=panel_main.html(),V.find(".sb-article-categories [data-id]").sbActive(!1),e(this).sbActive(!0),ne.getArticles(-1,e=>{for(var t=0;t<e.length;t++)i+=`<div data-id="${e[t].id}"><div>${e[t].title}</div><span>${e[t].content}</span></div>`;panel_main.addClass("sb-articles").html(i||`<p class="sb-no-results">${s("No articles found.")}</p>`),panel_main.sbLoading(!1)},e(this).attr("data-id"))})},categoryEmoji:function(e){let t=this.emoji_options.list;if("all"==e)this.emoji_options.list_now=t;else{this.emoji_options.list_now=[];for(var i=0;i<t.length;i++)t[i].category.startsWith(e)&&this.emoji_options.list_now.push(t[i])}this.emoji_options.range=0,this.populateEmoji(0),this.populateEmojiBar()},mouseWheelEmoji:function(e){let t=this.emoji_options.range;(function(e){let t=e.originalEvent.wheelDelta;return typeof t==G&&(t=e.originalEvent.deltaY),typeof t==G&&(t=-1*e.originalEvent.detail),t})(e)>0||O&&typeof e.originalEvent.changedTouches!==G&&this.emoji_options.touch<e.originalEvent.changedTouches[0].clientY?t-=t<1?0:1:t+=t>this.emoji_options.range_limit?0:1,v.find(".sb-emoji-bar > div").sbActive(!1).eq(t).sbActive(!0),this.emoji_options.range=t,this.populateEmoji(t),e.preventDefault()},insertEmoji:function(t){t.indexOf(".svg")>0&&(t=e.parseHTML(t)[0].alt),this.insertText(t),v.sbTogglePopup()},showEmoji:function(e){v.sbTogglePopup(e)&&(x||v.css({left:g.offset().left+($?68:20),top:g.offset().top-window.scrollY-($?g.height()-330:304)}),v.find(".sb-emoji-list > ul").html()||jQuery.ajax({method:"POST",url:SB_AJAX_URL,data:{function:"emoji","login-cookie":ee.loginCookie()}}).done(e=>{this.emoji_options.list=JSON.parse(e),this.emoji_options.list_now=this.emoji_options.list,this.populateEmoji(0),this.populateEmojiBar()}),ee.deselectAll())},populateEmoji:function(e){let t="",i=O?42:48,s=e*i+i,a=this.emoji_options.list_now;s>a.length&&(s=a.length),this.emoji_options.range_limit=a.length/i-1,this.emoji_options.range=e;for(var n=e*i;n<s;n++)t+=`<li>${a[n].char}</li>`;v.find(".sb-emoji-list").html(`<ul>${t}</ul>`)},populateEmojiBar:function(){let e='<div class="sb-active"></div>',t=O?42:49;for(var i=0;i<this.emoji_options.list_now.length/t-1;i++)e+="<div></div>";this.emoji_options.range=0,v.find(".sb-emoji-bar").html(e)},clickEmojiBar:function(t){let i=e(t).index();this.populateEmoji(i),this.emoji_options.range=i,v.find(".sb-emoji-bar > div").sbActive(!1).eq(i).sbActive(!0)},searchEmoji:function(e){ee.search(e,()=>{if(e.length>1){let i=this.emoji_options.list,s=[];for(var t=0;t<i.length;t++)(i[t].category.toLowerCase().includes(e)||i[t].name.toLowerCase().includes(e))&&s.push(i[t]);this.emoji_options.list_now=s}else this.emoji_options.list_now=this.emoji_options.list;this.emoji_options.range=0,this.populateEmoji(0),this.populateEmojiBar()})},textareaChange:function(t){let i=e(t).val();x&&(SBAdmin.conversations.savedReplies(t,i),SBAdmin.apps.openAI.rewriteButton(i)),i&&this.typing(x&&!te.active?SB_ACTIVE_AGENT.id:a().id,"set"),g.sbActive(i)},insertText:function(t){let i=e(p.get(0)),s=0;if(this.dashboard)return!1;if(i.get(0).selectionStart)s=i.get(0).selectionStart;else if(document.selection){i.focus();let e=document.selection.createRange();var a=document.selection.createRange().text.length;e.moveStart("character",-i.value.length),s=e.text.length-a}i.val(i.val().substr(0,s)+t+i.val().substr(s)),i.focus(),i.manualExpandTextarea(),g.sbActive(!0)},enabledAutoExpand:function(){p.length&&p.autoExpandTextarea()},cancelReply:function(){g.find("[data-reply]").remove(),h.removeClass("sb-reply-active")},privacy:function(){ee.ajax({function:"get-block-setting",value:"privacy"},e=>{_.append(`<div class="sb-privacy sb-init-form" data-decline="${e.decline}"><div class="sb-title">${e.title}</div><div class="sb-text">${e.message.replace(/\n/g,"<br>")}</div>`+(e.link?`<a target="_blank" href="${e.link}">${e["link-name"]}</a>`:"")+`<div class="sb-buttons"><a class="sb-btn sb-approve">${e["btn-approve"]}</a><a class="sb-btn sb-decline">${e["btn-decline"]}</a></div></div>`),this.finalizeInit(),ee.event("SBPrivacy")}),this.dashboard||this.showDashboard(),this.dashboard=!0,l.addClass("sb-init-form-active")},popup:function(e=!1,t=!1){if(e){let e=l.find(".sb-popup-message"),t=e.attr("data-id");return i("popup"+(ee.null(t)?"":t),!0),void e.remove()}setTimeout(()=>{this.chat_open||(0==t&&(t=U.popup),l.find(".sb-popup-message").remove(),l.append(`<div data-id="${t.id?t.id:""}" class="sb-popup-message">`+(t.image?`<img loading="lazy" src="${t.image}" />`:"")+(t.title?`<div class="sb-top">${t.title}</div>`:"")+`<div class="sb-text">${t.message}</div><div class="sb-icon-close"></div></div>`),ee.event("SBPopup",t))},1e3)},followUp:function(){this.followUpCheck()&&(E=setTimeout(()=>{this.followUpCheck()&&ee.ajax({function:"execute-bot-message",conversation_id:this.conversation.id,name:"follow_up",check:!1},e=>{e.settings.sound&&this.audio&&this.audio.play(),this.skip=!0,ee.storageTime("email"),ee.event("SBFollowUp")})},!0===U.follow?U.office_hours||q?15e3:5e3:parseInt(U.follow)))},followUpCheck:function(){return!x&&this.conversation&&U.follow&&a()&&!a().email&&ee.storageTime("email",24)},welcome:function(){$||"open"==U.welcome_trigger&&!this.chat_open||!U.office_hours&&U.welcome_disable_office_hours||!U.welcome||i("welcome")||!a()||ee.ajax({function:"get-block-setting",value:"welcome"},e=>{setTimeout(()=>{U.dialogflow_welcome?!1===this.conversation?this.newConversation(3,-1,"",[],null,null,function(){le.dialogflow.welcome(e.open,e.sound)}):le.dialogflow.welcome(e.open,e.sound):(this.sendMessage(y,e.message,[],!1,!1,3),e.open&&!O&&this.start(),e.sound&&this.audio.play()),this.skip=!0,ee.event("SBWelcomeMessage")},parseInt($?0:U.welcome_delay)),i("welcome",!0)})},offlineMessage:function(){if(!x&&U.timetable&&(!U.office_hours||!q&&!U.timetable_disable_agents)){let e=U.timetable_message;switch(U.timetable_type){case"header":this.offline_message_set||(e[0]&&f.find(".sb-title").html(e[0]),f.find(".sb-text").html(e[1]),this.offline_message_set=!0);break;case"info":this.offline_message_set||(h.prepend(`<div class="sb-notify-message sb-rich-cnt"><div class="sb-cnt"><div class="sb-message">${e[0]?`<b>${e[0]}</b> `:""}${e[1]}</div></div></div>`),l.addClass("sb-notify-active"),this.offline_message_set=!0);break;default:setTimeout(()=>{if(this.conversation){let t=U.timetable_hide?`${e[0]?`*${e[0]}*\n`:""}${e[1]}`:"[timetable]",i=this.conversation.searchMessages(t,!0);if(i=!!i.length&&i){let e=this.conversation.getLastUserMessage(!1,!0);i=!e||(e.get("index")<i[i.length-1].get("index")&&Date.now()-36e5)<ee.unix(i[0].get("creation_time"))}i||this.sendMessage(y,t)}},5e3)}}},slackMessage:function(e,t,i,s,n=[]){if(!this.conversation||!s&&!n.length)return!1;let o=this.conversation.id;ee.ajax({function:"send-slack-message",user_id:e,full_name:t,profile_image:i,conversation_id:o,message:s,attachments:n,channel:this.slack_channel[0]==a().id&&this.slack_channel[1]},e=>{this.slack_channel=[a().id,e[1]],ee.event("SBSlackMessageSent",{message:s,conversation_id:o,slack_channel:e[1]})})},deleteMessage:function(e){ee.ajax({function:"delete-message",message_id:e},()=>{this.conversation&&this.conversation.deleteMessage(e),h.find(`[data-id="${e}"]`).remove(),ee.event("SBMessageDeleted",e)})},registration:function(e=!1,t=U.registration_required){if(e)return U.registration_required&&(!U.registration_offline||!q)&&(typeof SB_DEFAULT_USER==G||!SB_DEFAULT_USER.email)&&(!U.registration_timetable||!U.office_hours)&&(!1===a()||["visitor","lead"].includes(a().type));_.append(oe.generate({},U.registration_link||"registration-login"==U.registration_required?"login":t,"sb-init-form")),this.dashboard||this.showDashboard(),this.dashboard=!0,this.finalizeInit(),l.addClass("sb-init-form-active")},addUserAndLogin:function(e=!1,t=!1){let i=typeof SB_DEFAULT_USER!=G&&SB_DEFAULT_USER?SB_DEFAULT_USER:{};i.user_type=t?"lead":"visitor",ee.ajax({function:"add-user-and-login",settings:i,settings_extra:i.extra},i=>{if(ee.errorValidation(i)){if("duplicate-email"==i[1]||"duplicate-phone"==i[1])return delete SB_DEFAULT_USER.email,delete SB_DEFAULT_USER.extra.phone,this.addUserAndLogin(e,t)}else ee.loginCookie(i[1]),a(new ie(i[0])),te.start(),te.active||ne.automations.runAll(),e&&e(i)})},isInitDashboard:function(){return U.init_dashboard||a()&&a().conversations.length>1},uploadResponse:function(t){if("success"==(t=JSON.parse(t))[0])if("extension_error"==t[1]){let e="The file you are trying to upload has an extension that is not allowed.";x?SBAdmin.infoPanel(e,"info"):alert(e)}else if(e(d).hasClass("sb-input-image")){let i=e(d).find(".image"),s=i.attr("data-value");s&&!s.includes("media/user.svg")&&ee.ajax({function:"delete-file",path:s}),i.attr("data-value","").css("background-image",""),setTimeout(()=>{i.attr("data-value",t[1]).css("background-image",`url("${t[1]}?v=${ee.random()}")`).append('<i class="sb-icon-close"></i>'),d=!1},500)}else{let e=ee.beautifyAttachmentName(t[1].substr(t[1].lastIndexOf("/")+1));g.find(".sb-attachments").append(`<div data-name="${e}" data-value="${t[1]}"${t.length>2?' data-size="'+t[2][0]+"|"+t[2][1]+'"':""}>${e}<i class="sb-icon-close"></i></div>`),g.sbActive(!0)}else ee.error(t[1],"sb-upload-files.change");this.busy(!1)},closeChat:function(e=!0){let t=this.conversation.id;ne.clear(),e?ee.ajax({function:"update-conversation-status",conversation_id:t,status_code:3},()=>{this.closeChat_(t)}):this.closeChat_(t)},closeChat_(e){l.find(`li[data-conversation-id="${e}"]`).remove(),P="new-conversation",ne.clear(),i("open-conversation",""),i("welcome",""),i("flow_on_load",""),a().removeConversation(e),U.disable_dashboard||ne.showDashboard()},conversationArchived:function(){let e=!$&&U.close_chat||$&&U.tickets_close;if(e&&!U.rating)return this.closeChat(!1);U.rating&&oe.rating(e)},automations:{history:[],busy:[],scroll_position_intervals:{},timeout_queue:[],runAll:function(){let t=U.automations;for(var i=0;i<t.length;i++){let o=t[i],r=o.conditions,l=0==r.length,c=!1,d=!1,u=!1;for(var s=0;s<r.length;s++){let t=r[s][1];switch(l=!1,r[s][0]){case"browsing_time":l=!0,c=t;break;case"scroll_position":l=!0,d=t;break;case"referring":case"url":let i="referring"==r[s][0]?document.referrer:window.location.href,o=r[s][2].replace(/https?:\/\/|www\./g,"").split(",");i=i.replace(/https?:\/\/|www\./g,"");for(n=0;n<o.length;n++)if(i.includes(o[n])){l="contains"==t;break}break;case"include_urls":case"exclude_urls":let h="referring"==r[s][0]?document.referrer:window.location.href,g=r[s][2].replace(/https?:\/\/|www\./g,"").split(","),p="exclude_urls"!=r[s][0];p||(l=!0),h=h.replace(/https?:\/\/|www\./g,"");for(var n=0;n<g.length;n++)if(g[n]=e.trim(g[n].replace("https://","").replace("http://","").replace("www.","")),"contains"==t&&-1!=h.indexOf(g[n])||"does-not-contain"==t&&-1==h.indexOf(g[n])||"is-exactly"==t&&g[n]==h||"is-not"==t&&g[n]!=h){l=p;break}break;case"custom_variable":let f=t.split("=");f[0]in window&&window[f[0]]==f[1]&&(l=!0);break;case"returning_visitor":case"user_type":case"cities":case"languages":case"countries":case"postal_code":case"website":case"company":case"creation_time":case"last_activity":l=a(),u=!0;break;case"phone":l=a()&&a().getExtra("phone");break;case"email":l=a()&&a().email;break;default:l=a()&&a().getExtra(r[s][0])}if(!l)break}["messages","emails","sms"].includes(o.type)&&!a()&&(l=!1),l&&(u?o.id in this.busy||(ee.ajax({function:"automations-validate",automation:o},e=>{!1!==e&&this.runAll_final(o,d,c),delete this.busy[o.id]}),this.busy[o.id]=!0):"messages"==o.type&&ne.registration(!0)||this.runAll_final(o,d,c))}},runAll_final:function(t,i,s){i?this.scroll_position_intervals[t.id]=setInterval(()=>{e(window).scrollTop()>parseInt(i)&&(s?setTimeout(()=>{this.run(t)},1e3*parseInt(s)):this.run(t),clearInterval(this.scroll_position_intervals[t.id]))},1e3):s?this.timeout_queue.includes(t.id)||(setTimeout(()=>{this.run(t)},1e3*parseInt(s)),this.timeout_queue.push(t.id)):this.run(t)},run:function(e){if(!this.history.includes(e.id))switch(e.type){case"messages":case"emails":case"sms":if((!te.active||te.started)&&!(e.id in this.busy)){if("messages"==e.type&&ne.chat_open){let e=!!ne.conversation&&ne.conversation.getLastUserMessage(!1,"no-bot");if(e&&Date.now()-6e5<ee.unix(e.get("creation_time")))return}ee.ajax({function:"automations-run",automation:e},t=>{!1!==t&&(this.history.push(e.id),"messages"!=e.type||te.active||ne.updateConversations()),delete this.busy[e.id]}),this.busy[e.id]=!0}break;case"popups":if(!i("popup"+e.id))if(ne.chat_open){if(e.fallback){let t=!!ne.conversation&&ne.conversation.getLastUserMessage(!1,"no-bot");(!t||Date.now()-6e5>ee.unix(t.get("creation_time")))&&(ne.sendMessage(y,(ee.null(e.title)?"":`*${e.title}*\n`)+e.message,[],!1,!1,0),i("popup"+e.id,!0),this.history.push(e.id))}}else setTimeout(()=>{ne.popup(!1,{id:e.id,image:e.profile_image,title:e.title,message:e.message})},1e3),this.history.push(e.id);break;case"design":e.background&&f.css("background-image",`url("${e.background}")`),e.brand&&f.find(".sb-brand img").attr("src",e.brand),e.title&&f.find(".sb-title").html(e.title),e.message&&f.find(".sb-text").html(e.message),e.icon&&l.find(".sb-chat-btn .sb-icon").attr("src",e.icon),(e.color_1||e.color_2||e.color_3)&&ee.ajax({function:"chat-css",color_1:e.color_1,color_2:e.color_2,color_3:e.color_3},e=>{c.append(`<style>${e}</style>`)}),this.history.push(e.id);break;case"more":let t={};if(e.department&&(ne.default_department=e.department,t={function:"update-conversation-department",department:e.department}),e.agent&&(ne.default_agent=e.agent,t={function:"update-conversation-agent",agent_id:e.agent}),e.tags&&(e.tags=e.tags.split(","),ne.default_tags=e.tags,t={function:"update-tags",tags:e.tags,add:!0}),ne.conversation.id&&(e.tags||e.agent||e.department)&&(t.conversation_id=ne.conversation.id,ee.ajax(t)),e.articles||e.articles_category){let t=l.find(".sb-dashboard-articles > .sb-articles");ne.articles_allowed_ids=e.articles,ne.articles_category=e.articles_category,t&&ne.getArticles(e.articles,e=>{let i="";for(var s=0;s<2;s++)i+=`<div data-id="${e[s].id}"><div>${e[s].title}</div><span>${e[s].content}</span></div>`;t.html(i)},e.articles_category,2)}this.history.push(e.id)}}},flashNotification:function(){clearInterval(R),R=setInterval(function(){ne.notifications.length&&(document.title=document.title==D?"("+ne.notifications.length+") "+s("New message"+(ne.notifications.length>1?"s":"")):D)},2e3)},calculateLabelDates:function(){(x||this.chat_open)&&(L=h.find(".sb-label-date"))},calculateLabelDateFirst:function(){this.conversation.messages.length||h.append(`<div class="sb-label-date"><span>${s("Today")}</span></div>`)},playSound:function(e=!1){this.audio.play();let t=e||(x?SB_ADMIN_SETTINGS.sound.repeat:U.sound.repeat);t&&!this.tab_active&&(clearInterval(this.audio_interval),this.audio_interval=setInterval(()=>{this.audio.play(),--t||clearInterval(this.audio_interval)},1e3*this.audio.duration+1500))},isConversationAllowed:function(e,t){return(!U.tickets_hide||$&&"tk"==e||!$&&"tk"!=e)&&(![3,4,"3","4"].includes(t)||!$&&!U.close_chat||$&&!U.tickets_close)}};window.SBChat=ne;var oe={rich_messsages:{email:"",button:"",video:"",image:"",woocommerce_button:"",rating:"",chips:'<div class="sb-buttons">[options]</div>',buttons:'<div class="sb-buttons">[options]</div>',select:'<div class="sb-select"><p></p><ul>[options]</ul></div>',list:'<div class="sb-text-list">[values]</div>',"list-image":'<div class="sb-image-list">[values]</div>',table:"<table><tbody>[header][values]</tbody></table>",inputs:'<div class="sb-form">[values]</div>',card:'<div class="sb-card">[settings]</div>',share:'<div class="sb-social-buttons">[settings]</div>',slider:'<div class="sb-slider"><div>[items]</div></div><div class="sb-slider-arrow sb-icon-arrow-left[class]"></div><div class="sb-slider-arrow sb-icon-arrow-right sb-active[class]"></div>',"slider-images":'<div class="sb-slider sb-slider-images"><div>[items]</div></div><div class="sb-slider-arrow sb-icon-arrow-left[class]"></div><div class="sb-slider-arrow sb-icon-arrow-right sb-active[class]"></div>'},cache:{},duplicated_email:!1,generate:function(t,i,n=""){let o,r=!0,c=t.id?t.id:ee.random(),d=new se({});if(i in this.rich_messsages)o=this.rich_messsages[i];else if(i in this.cache)o=this.cache[i];else{if(!this.isShortcode(i))return!1;t.id||(c=i),o='<div class="sb-rich-loading sb-loading"></div>',ee.ajax({function:"get-rich-message",name:i,settings:t},s=>{s=this.initInputs(s),"timetable"==i&&(s=this.timetable(s)),e(x&&"chatbot"==SBAdmin.active_admin_area?".sb-playground":l).find(`.sb-rich-message[id="${c}"]`).html(`<div class="sb-content">${s}</div>`),this.cache[i]=s,ne.scrollBottom(ne.dashboard),ee.event("SBRichMessageShown",{name:i,settings:t,response:s})}),r=!1}let u=t.disabled;if(r){let n,r="";switch(i){case"email":let l=[],c=a().email,d="#"==a().get("last_name").charAt(0);"true"==t.name&&l.push(["first_name","true"==t["last-name"]?"First name":"Name",d?"":"true"==t["last-name"]?a().get("first_name"):a().name,"text",!0]),"true"==t["last-name"]&&l.push(["last_name","Last name",d?"":a().get("last_name"),"text",!0]);for(p=0;p<l.length;p++)o+=`<div id="${l[p][0]}" data-type="text" class="sb-input sb-input-text"><span class="${l[p][2]?"sb-active sb-filled":""}">${s(l[p][1])}</span><input value="${l[p][2]}" autocomplete="false" type="${l[p][3]}" ${l[p][4]?"required":""}></div>`;if("true"==t.phone){let e=a().getExtra("phone");this.cache.phone||(this.cache.phone=!0,ee.ajax({function:"get-select-phone"},e=>{this.cache.phone=e,h.find("#phone .sb-select-phone").html(e)})),o+=`<div id="phone" data-type="select-input" class="sb-input sb-input-select-input"><span class="${e?"sb-active sb-filled":""}">${s("Phone")}</span><div class="sb-select-phone">${this.cache.phone?this.cache.phone:""}</div><input autocomplete="false" type="text" data-phone="true"${"false"!=t["phone-required"]?" required":""}></div>`}o+=`<div id="email" data-type="email" class="sb-input sb-input-btn"><span class="${c?"sb-active sb-filled":""}">${s(ee.null(t.placeholder)?"Email":t.placeholder)}</span><input value="${c}" autocomplete="off" type="email" required><div class="sb-submit sb-icon-arrow-right"></div></div>`;break;case"image":o=`<div class="sb-image"><img loading="lazy" src="${t.url}"></div>`;break;case"video":o=`<iframe loading="lazy"${t.height?` height="${t.height}"`:""} src="https://${"youtube"==t.type?"www.youtube.com/embed/":"player.vimeo.com/video/"}${t.id}" allowfullscreen></iframe>`;break;case"select":n=t&&t.options?t.options.replace(/\\,/g,"{R}").split(","):[];for(p=0;p<n.length;p++){let e=n[p].replace(/{R}/g,",");r+=`<li data-value="${ee.stringToSlug(e)}">${s(e)}</li>`}o=o.replace("[options]",r);break;case"chips":case"buttons":n=t&&t.options?t.options.replace(/\\,/g,"{R}").split(","):[];for(p=0;p<n.length;p++)r+=`<div class="sb-btn sb-submit">${s(n[p].replace(/{R}/g,","))}</div>`;o=o.replace("[options]",r);break;case"button":if(t&&t.link){let e=t.link.includes("calendly.com");o=`<a ${e?'data-action="calendly" data-extra="'+t.link+"|"+(t.success?t.success.replaceAll('"',"'"):"")+'" ':""}href="${e?"#":t.link.replace(/<i>/g,"_").replace(/<\/i>/g,"_")}"${t.target&&!e?' target="_blank"':""} class="sb-rich-btn sb-btn${"link"==t.style?"-text":""}">${s(t.name)}</a>`}break;case"list":if(t.values){n=t.values.replace(/\\,/g,"{R}").replace(/\\:/g,"{R2}").replace(/:\/\//g,"{R3}").split(",");let a="list"==i,l=a&&n.length&&n[0].indexOf(":")>0;a&&!l&&(o=o.replace("sb-text-list","sb-text-list sb-text-list-single")),t.numeric&&(o=o.replace("sb-text-list","sb-text-list sb-text-list-numeric"));for(p=0;p<n.length;p++){let t=n[p].replace(/{R}/g,","),i="-"===t.substr(0,1);r+=l&&t.includes(":")?`<div><div>${s(t.split(":")[0].replace(/{R2}/g,":").replace(/{R3}/g,"://"))}</div><div>${s(t.split(":")[1].replace(/{R2}/g,":").replace(/{R3}/g,"://"))}</div></div>`:`<div${i?' data-inner="true"':""}>${e.trim(s((i?t.substr(1):t).replace(/{R2}/g,":").replace(/{R3}/g,"://")))}</div>`}o=o.replace("[values]",r)}break;case"list-image":if(t.values){n=t.values.split(",");for(p=0;p<n.length;p++){let e=n[p].replace("://","///").split(":");r+=`<div><div class="sb-thumb" style="background-image:url('${e[0].replace("///","://")}')"></div><div class="sb-list-title">${e[1]}</div><div>${e[2]}</div></div>`}o=o.replace("[values]",r)}break;case"table":if(t.values){n=t.header.split(","),r+="<tr>";for(p=0;p<n.length;p++)r+=`<th>${n[p]}</th>`;r+="</tr>",o=o.replace("[header]",r),r="",n=t.values.split(",");for(p=0;p<n.length;p++){let e=n[p].split(":");r+="<tr>";for(var g=0;g<e.length;g++)r+=`<td>${e[g]}</td>`;r+="</tr>"}o=o.replace("[values]",r)}break;case"inputs":if(t.values){n=t.values.split(",");for(p=0;p<n.length;p++)u&&!n[p]||(r+=`<div id="${ee.stringToSlug(n[p])}" data-type="text" class="sb-input sb-input-text"><span>${s(n[p])}</span><input autocomplete="false" type="text" required></div>`);r+='<div class="sb-btn sb-submit">'+s(t.button?t.button:"Send now")+"</div>",o=o.replace("[values]",r)}break;case"card":r=`${t.image?`<div class="sb-card-img" style="background-image:url('${t.image}')"></div>`:""}<div class="sb-card-header">${t.header}</div>${t.extra?`<div class="sb-card-extra">${t.extra}</div>`:""}${t.description?`<div class="sb-card-description">${t.description}</div>`:""}${t.link?`<a class="sb-card-btn" href="${t.link}"${t.target?' target="_blank"':""}>${s(t["link-text"])}</a>`:""}`,o=o.replace("[settings]",r);break;case"share":let f=t.channels?t.channels.replace(/ /g,"").split(","):["fb","tw","li","wa","pi"],m="";for(p=0;p<f.length;p++){switch(f[p]){case"fb":m="www.facebook.com/sharer.php?u=";break;case"tw":m="twitter.com/intent/tweet?url=";break;case"li":m="www.linkedin.com/sharing/share-offsite/?url=";break;case"wa":m="web.whatsapp.com/send?text=";break;case"pi":m="www.pinterest.com/pin/create/button/?url="}r+=`<div class="sb-${f[p]} sb-icon-social-${f[p]}" data-link="https://${m}${encodeURIComponent(t[f[p]])}"></div>`}o=o.replace("[settings]",r);break;case"slider":let v=0;for(p=1;p<16&&"header-"+p in t;p++)r+=`<div>${"image-"+p in t?`<div class="sb-card-img" style="background-image:url('${t["image-"+p]}')"></div>`:""}<div class="sb-card-header">${t["header-"+p]}</div>${"extra-"+p in t?`<div class="sb-card-extra">${t["extra-"+p]}</div>`:""}${"description-"+p in t?`<div class="sb-card-description">${t["description-"+p]}</div>`:""}${"link-"+p in t?`<a class="sb-card-btn" href="${t["link-"+p]}"${t.target?' target="_blank"':""}>${s(t["link-text-"+p])}</a>`:""}</div>`,v++;o=o.replace("[items]",r).replace(/\[class\]/g,1==v?" sb-hide":"");break;case"slider-images":if(t.images){let e=t.images.split(",");for(var p=0;p<e.length;p++)r+=`<div class="sb-card-img" data-value="${e[p]}" style="background-image:url('${e[p]}')"></div>`;o=o.replace(/\[class\]/g,1==e.length?" sb-hide":"")}o=o.replace("[items]",r);break;case"woocommerce_button":t.settings=`checkout:${t.checkout},coupon:${t.coupon}`,o=`<a href="#" data-ids="${t.ids}" class="sb-rich-btn sb-btn">${t.name}</a>`;break;case"rating":o=`<div class="sb-rating-message sb-rating-${1==t.value?"positive":"negative"}"><div><i class="sb-icon-${1==t.value?"like":"dislike"}"></i> ${s(1==t.value?"Helpful":"Not helpful")}</div>${t.message?"<div>"+t.message+"</div>":""}</div>`,t.message=!1}}return`<div id="${c}" data-type="${i}"${u?'disabled="true"':""}${t.settings?` data-settings="${t.settings}"`:""}class="sb-rich-message sb-rich-${i} ${n}">`+(t.title?`<div class="sb-top">${d.render(s(t.title))}</div>`:"")+(t.message?`<div class="sb-text">${d.render(s(t.message))}</div>`:"")+`<div class="sb-content">${o}</div>${"email"==i?`<div data-success="${t.success?t.success.replace(/"/g,""):""}" class="sb-info"></div>`:""}</div>`},submit:function(i,n,o){if(!x&&!t(o)&&!this.is_busy){let t="",c="",d={},u=e(i).find("[data-success]").length?e(i).find("[data-success]").attr("data-success"):"",h=e(i).closest(".sb-rich-message").attr("id"),g=e(i).closest("[data-id]").attr("data-id"),p="",f={"rich-messages":{}},m=0==a()?{profile_image:"",first_name:"",last_name:"",email:"",password:"",user_type:""}:{profile_image:a().image,first_name:a().get("first_name"),last_name:a().get("last_name"),email:a().email,password:"",user_type:""},v={},_=e(o),b="",S=!1,A=!1!==ne.conversation,k={},C={},T=i.find("#otp");if(ee.null(g))g=-1;else{let e=ne.conversation.getMessage(g);p=e.message,(f=e.payload())["rich-messages"]||(f["rich-messages"]={})}switch(e(o).hasClass("sb-btn")||e(o).hasClass("sb-select")||e(o).hasClass("sb-submit")||(_=e(o).closest(".sb-btn,.sb-select")),e(i).find(".sb-info").html("").sbActive(!1),n){case"email":if(v=re.getAll(i),e.each(v,function(e,t){v[e]=t[0]}),v.first_name&&(m.user_type="user",v.last_name||(m.last_name="")),v.phone&&(k={phone:[v.phone,"Phone"]}),e.extend(m,v),t="Please fill in all required fields and make sure the email is valid.",u&&(u=s(u).replace("{user_email}",m.email).replace("{user_name_}",m.first_name+(v.last_name?" "+m.last_name:""))),T.sbActive()){let e=T.attr("data-otp");v.otp=!!e&&[e,i.find("#otp input").val()]}f["rich-messages"][h]={type:n,result:v},f.event="update-user",d={function:"update-user-and-message",settings:m,settings_extra:k,payload:f,skip_otp:!0},S={settings:m,settings_extra:k};break;case"registration":if(v=re.getAll(i.find(".sb-form-main")),k=re.getAll(i.find(".sb-form-extra")),e.each(v,function(e,t){v[e]=t[0]}),e.extend(m,v),C=e.extend({},m),u&&(u=s(u)),U.registration_details){u+='[list values="';for(var r in m){let e=m[r].replace(/:|,/g,"");e&&("profile_image"==r&&(e=e.substr(e.lastIndexOf("/")+1)),["password","password-check","envato-purchase-code","otp"].includes(r)?(e="********",C[r]="********"):u+=m[r]?`${s(ee.slugToString(r.replace("first_name","name")))}:${e},`:"")}for(var r in k)k[r][0]&&(u+=`${s(k[r][1].replace(/:|,/g,""))}:${k[r][0].replace(/:|,/g,"")},`);u=u.slice(0,-1)+'"]'}if(T.sbActive()){let e=T.attr("data-otp");m.otp=!!e&&[e,i.find("#otp input").val()]}m.user_type="user",f["rich-messages"][h]={type:n,result:{user:C,extra:k}},f.event="update-user",d=U.registration_otp&&m.email&&!m.otp?{function:"otp",email:m.email}:{function:a()?"update-user-and-message":"add-user-and-login",settings:m,settings_extra:k,payload:f},t=re.getRegistrationErrorMessage(i),S={settings:m,settings_extra:k};break;case"chips":case"select":case"buttons":v=ee.escape(e(o).html()),u&&(u=s(u)+` *${v}*`),f["rich-messages"][h]={type:n,result:v},d={function:"update-message",payload:f},b=v,"chips"==n&&(ne.sendMessage(a().id,v,[],!1,{id:h,event:"chips-click",result:v},"sb-human-takeover"==h&&0==_.index()&&2),"sb-human-takeover"==h&&0==e(o).index()&&le.dialogflow.humanTakeover(),e(o).closest(".sb-content").remove());break;case"inputs":if(v=re.getAll(i),t="All fields are required.",u){u=s(u)+' [list values="';for(var r in v)u+=`${s(v[r][1].replace(/:|,/g,""))}:${v[r][0].replace(/:|,/g,"")},`;u=u.slice(0,-1)+'"]'}f["rich-messages"][h]={type:n,result:v},d={function:"update-message",payload:f},S={settings:v}}if(c=p.substr(p.indexOf("["+n)),c=c.substr(0,c.indexOf("]")+1),t&&re.errors(i))return re.showErrorMessage(i,t),_.sbLoading(!1),(ne.dashboard||A&&ne.conversation.getLastMessage().id==g)&&ne.scrollBottom(),!1;if(!u&&"registration"!=n){let e=this.shortcode(c),t=e[1].id?`id="${e[1].id}"`:"",i=e[1].title?`title="${e[1].title}"`:"",s=e[1].message?`message="${e[1].message}"`:"",a="";if(["inputs","email"].includes(n)){for(var r in v)a+=v[r]+",";a=`values="${a.slice(0,-1)}"`}else a=`options="${v}"`;u=`[${"email"==n?"inputs":n} ${t} ${i} ${s} ${a} disabled="true"]`}-1!=g&&(u=u.replace(/<br>/g,"\n"),e.extend(d,{message_id:g,message:p?"chips"==n?p.replace("]",' disabled="true"]'):p.replace(c,u):u,payload:f})),ee.ajax(d,t=>{if(t&&!ee.errorValidation(t)){switch(n){case"email":for(var r in m)a().set(r,m[r]);for(var r in k)a().setExtra(r,k[r][0]);ee.loginCookie(t[1]),"sb-follow-up"==h&&ee.ajax({function:"subscribe-email",email:a().email}),ne.automations.runAll(),ee.event("SBNewEmailAddress",{id:h,name:a().name,email:a().email});break;case"registration":let o=i.find("#otp");if(U.registration_otp&&!o.sbActive())return o.attr("data-otp",t).sbActive(!0),o.find("input").attr("required",!0).addClass("sb-error"),re.showErrorMessage(i,s("Please check your email for the one-time code.")),ne.scrollBottom(),void _.sbLoading(!1);if(ee.loginCookie(t[1]),m.id=t[0].id,a()){for(var r in m)a().set(r,m[r]);for(var r in k)a().setExtra(r,k[r][0]);ne.automations.runAll(),ne.welcome()}else{a(new ie(t[0]));for(var r in k)a().setExtra(r,k[r][0]);this.duplicated_email&&!U.init_dashboard&&(P="open-conversation"),te.start(),ne.initChat(),this.duplicated_email||U.init_dashboard&&l.find(".sb-departments-list").length||!u||ne.sendMessage(y,u,[],!1,!1,3)}ne.dashboard&&(l.removeClass("sb-init-form-active"),e(i).remove(),ne.isInitDashboard()||U.init_dashboard&&this.duplicated_email||ne.hideDashboard()),U.wp_registration&&m.email&&m.password?le.wordpress.ajax("wp-registration",{user_id:t[0].id,first_name:t[0].first_name,last_name:t[0].last_name,password:m.password,email:m.email}):"wp"==U.wp_users_system&&le.wordpress.ajax("wp-login",{user:m.email,password:m.password}),delete this.cache.registration,setTimeout(()=>{ee.event("SBRegistrationForm",{id:h,conversation_id:!!ne.conversation&&ne.conversation.id,user:m,extra:f["rich-messages"][h].result.extra})},5e3);break;case"buttons":ne.scrollBottom()}-1==g?e(o).closest(".sb-rich-message").html(u):(_.sbLoading(!1),f.type&&"close-message"==f.type||w||ne.setConversationStatus(2)),["login","chips"].includes(n)||!U.dialogflow_send_user_details&&["email","registration"].includes(n)||le.dialogflow.message(`${h}${b?"|"+b:""}`,[],!1,S),!U.slack_active||w&&!le.dialogflow.humanTakeoverActive()||ne.slackMessage(a().id,a().name,a().image,u),te.active&&ne.update(),"registration"!=n&&"email"!=n&&ee.event("SBRichMessageSubmit",{result:t,data:f["rich-messages"][h],id:h})}else"registration"==n&&ee.errorValidation(t,"duplicate-email")?(ee.ajax({function:"otp",email:m.email},e=>{let t=i.find("#otp");t.attr("data-otp",e).sbActive(!0),t.find("input").attr("required",!0).addClass("sb-error"),re.showErrorMessage(i,s("This email is already in use. Please check your email for the one-time code.")),i.find(".sb-submit").html(s("Sign in")),ne.scrollBottom()}),this.duplicated_email=!0):(this.duplicated_email=!1,re.showErrorMessage(i,re.getRegistrationErrorMessage(t,"response"))),ne.dashboard&&ne.scrollBottom(),_.sbLoading(!1)})}},shortcode:function(t){let i={},s=t.includes(" ")?t.substr(1,t.indexOf(" ")-1):t.slice(1,-1);if(/\?|"|'|`|\*/gi.test(s))return[!1,!1];let a=(t=t.slice(1,-1).substr(s.length+1)).split('" ');for(var n=0;n<a.length;n++)if(a[n].includes("=")){let t=[a[n].substr(0,a[n].indexOf("=")),a[n].substr(a[n].indexOf("=")+2)];i[e.trim(t[0])]=t[1].replace(/"/g,"")}return[s,i]},initInputs:function(t){return(t=e(e.parseHTML("<div>"+t+"</div>"))).find(".sb-input input").each(function(){e(this).val()&&e(this).siblings().addClass("sb-active sb-filled")}),t.html()},timetable:function(t){let i=e(e.parseHTML(`<div>${t}</div>`)),a=i.find("[data-offset]").attr("data-offset");return a=ee.null(a)?0:parseFloat(a),i.find("[data-time]").each(function(){let n=e(this).attr("data-time").split("|");t="";for(var o=0;o<n.length;o++){if("closed"==n[o]){t+=s("Closed");break}if(n[o]){let e=n[o].split(":"),i=ee.convertUTCDateToLocalDate(`01/01/2000 ${e[0]}:${e[1]}`,a);t+=i.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})+(0==o||2==o?`<span>${s("to")}</span>`:1==o&&n[o+1]?"<br />":"")}}i.find(" > div > span").html(`<i class="sb-icon-clock"></i> ${s("Time zone")} ${Intl.DateTimeFormat().resolvedOptions().timeZone}`),e(this).html(t)}),i.html()},sliderChange:function(e,t="left"){let i=h.find(`#${e}`);if(i.length&&!i.hasClass("sb-moving")){let e=i.find(".sb-slider > div > div"),s=e.eq(0),a=Math.ceil(s.closest(".sb-slider").width()),n="right"==t?-1:1,o=parseFloat(parseFloat(parseFloat(s.css("margin-left"))+a*n)),r=a*(e.length-1)*-1;o<1&&o>=r&&(s.css("margin-left",o+"px"),i.addClass("sb-moving"),setTimeout(()=>{i.removeClass("sb-moving")},1200)),i.find(".sb-icon-arrow-right").sbActive(!(r>o-15&&r<o+15)),i.find(".sb-icon-arrow-left").sbActive(o<-10)}},calendly:{script_loaded:!1,load:function(t,i,a){t=t.split("|"),this.script_loaded?this.load_(t[0],i):e.getScript("https://assets.calendly.com/assets/external/widget.js",()=>{this.script_loaded=!0,window.addEventListener("message",function(e){"https://calendly.com"===e.origin&&"calendly.event_scheduled"==e.data.event&&(ne.updateMessage(a,s(t[1]?t[1]:"Booking completed.")),b.sbActive(!1))}),this.load_(t[0],i)},!0)},load_:function(e,t){Calendly.initInlineWidget({url:(e.includes("http")?"":"https://")+e+"?hide_landing_page_details=1&hide_event_type_details=1&hide_gdpr_banner=1",parentElement:b.find("> div").eq(1),prefil:"user"==a().type?{name:a().name,email:a().email}:{}}),b.find("> div:first-child > div").html(s(t)),b.sbActive(!0).attr("data-id","calendly")}},rating:function(e=!1){b.find("> div:first-child > div").html(s("Rate your experience")),b.find("> div:last-child").html(`${U.rating_message?`<div class="sb-input sb-input-textarea"><textarea placeholder="${s("Add a message here...")}"></textarea></div>`:""}<div class="sb-rating"><div><i data-rating="positive" class="sb-submit sb-icon-like"><span>${s("Helpful")}</span></i><i data-rating="negative" class="sb-submit sb-icon-dislike"><span>${s("Not helpful")}</span></i></div></div>`),b.sbActive(!0).attr("data-id","rating").attr("data-close-chat",e?"true":"").css("max-height",(U.rating_message?167:80)+"px")},isShortcode:function(e){return e in this.rich_messsages||x&&SB_ADMIN_SETTINGS.rich_messages.includes(e)||!x&&U.rich_messages.includes(e)}};window.SBRichMessages=oe;var re={getAll:function(t){let i={};return e(t).find(".sb-input[id]").each((t,s)=>{i[e(s).attr("id")]=this.get(s)}),i},get:function(t){let i=(t=e(t)).data("type"),a=s(ee.escape(t.find(" > span").html()));switch(i){case"image":let e=t.find(".image").attr("data-value");return[ee.null(e)?"":e,a];case"select":return[ee.escape(t.find("select").val()),a];case"select-input":let s=t.find("select,input[disabled]");return[ee.escape((s.is("select")||s.is("input")?s.val():t.find(".sb-select").length?t.find(".sb-select > p").attr("data-value"):t.find("> div").html())+t.find("> input").val()),a];default:let n=t.find("input");return[ee.escape(n.length?n.val():t.find("[data-value]").attr("data-value")),a]}},set:function(t,i){if((t=e(t)).length){switch(t.data("type")){case"image":i?t.find(".image").attr("data-value",i).css("background-image",`url("${i}")`):t.find(".image").removeAttr("data-value").removeAttr("style");break;case"select":t.find("select").val(i);break;default:t.find("input,textarea").val(i)}return!0}return!1},clear:function(t){e(t).find(".sb-input,.sb-setting").each((t,i)=>{this.set(i,""),e(i).find("input, select, textarea").removeClass("sb-error")}),this.set(e(t).find("#user_type"),"user")},errors:function(t){let i=!1,s=e(t).find("input, select, textarea").removeClass("sb-error");return s.each(function(t){let a=e.trim(e(this).val()),n=e(this).attr("type"),o=e(this).prop("required");(o&&!a||(o||a)&&("password"==n&&(a.length<8||s.length>t+1&&"password"==s.eq(t+1).attr("type")&&s.eq(t+1).val()!=a)||"email"==n&&(a.indexOf("@")<0||a.indexOf(".")<0||/;|:|\/|\\|,|#|"|!|=|\*|{|}|[|]|£|\$|€|~|'|>|<|\^|&/.test(a))||e(this).attr("data-phone")&&a&&(!e(this).parent().find("select").val()&&!e(this).prev().find("> div > p").attr("data-value")&&!e(this).parent().find("div").html().trim().startsWith("+")||isNaN(a)||a.includes("+")||a.length<5)))&&(i=!0,e(this).addClass("sb-error"))}),(s=e(t).find("[data-required]").removeClass("sb-error")).each(function(){ee.null(e(this).attr("data-value"))&&(e(this).addClass("sb-error"),i=!0)}),i},showErrorMessage:function(t,i){e(t).find(".sb-info").html(s(i)).sbActive(!0),clearTimeout(E),E=setTimeout(function(){e(t).find(".sb-info").sbActive(!1)},7e3)},showSuccessMessage:function(t,i){e(t).find(".sb-info").remove(),e(t).addClass("sb-success").find(".sb-content").html(`<div class="sb-text">${i}</div>`)},getRegistrationErrorMessage(t,i="validation"){let a="";return"response"==i?ee.errorValidation(t,"duplicate-email")?"This email is already in use. Please use another email.":ee.errorValidation(t,"duplicate-phone")?"This phone number is already in use. Please use another number.":ee.errorValidation(t,"invalid-envato-purchase-code")?"Invalid Envato purchase code.":ee.errorValidation(t,"invalid-otp")?"Invalid one-time code.":"Error. Please check your information and try again.":(e(t).find(".sb-input:not(#password-check) [required]").each(function(){a+=", "+e(this).closest(".sb-input").find("span").html()+("password"==e(this).attr("type")?" ("+s("8 characters minimum")+")":"")}),`${a.substring(2)} ${s((a.includes(",")?"are":"is")+" required.")}`)}};window.SBForm=re;var le={login:function(){return typeof SB_DEFAULT_USER!=G&&SB_DEFAULT_USER?[SB_DEFAULT_USER,"default"]:this.is("wp")&&typeof SB_WP_ACTIVE_USER!=G&&"wp"==U.wp_users_system?[[SB_WP_ACTIVE_USER,typeof SB_WP_AVATAR!=G?SB_WP_AVATAR:""],"wp"]:typeof SB_SHOPIFY_ACTIVE_USER!=G?[SB_SHOPIFY_ACTIVE_USER,"shopify"]:typeof SB_PERFEX_ACTIVE_USER!=G?[[SB_PERFEX_ACTIVE_USER,SB_PERFEX_CONTACT_ID],"perfex"]:typeof SB_WHMCS_ACTIVE_USER!=G?[SB_WHMCS_ACTIVE_USER,"whmcs"]:typeof SB_AECOMMERCE_ACTIVE_USER!=G&&[SB_AECOMMERCE_ACTIVE_USER,"aecommerce"]},is:function(e){return x?SBAdmin.apps.is(e):"wordpress"==e||"wp"==e?U.wp:e in U&&U[e]},shopify:{startCartSynchronization:function(){setInterval(()=>{a()&&fetch("/cart.js").then(e=>e.json()).then(e=>{e={total:e.total_price,currency:e.currency,items:e.items.map(e=>({id:e.product_id,price:e.price,handle:e.handle,title:e.title,quantity:e.quantity}))};let t=JSON.stringify(e);i("shopify-cart")!=t&&(i("shopify-cart",t),ee.ajax({function:"shopify-cart-sync",cart:e}))})},1e4)}},wordpress:{ajax:function(t,i,s=!1){if(typeof SB_WP_AJAX_URL==G)return!!s&&s(!1);e.ajax({method:"POST",url:SB_WP_AJAX_URL,data:e.extend({action:"sb_wp_ajax",type:t},i)}).done(e=>{s&&s(e)})}},woocommerce:{updateCart:function(e,t,i=!1){le.wordpress.ajax(e,{product_id:t},i)},waitingList:function(e="request",t=!1){typeof SB_WP_WAITING_LIST!==G&&("request"!=e||SB_WP_WAITING_LIST&&ee.storageTime("waiting-list-"+SB_WP_PAGE_ID,24))&&a()&&ee.ajax({function:"woocommerce-waiting-list",product_id:!1===t?SB_WP_PAGE_ID:t,conversation_id:ne.conversation.id,action:e,token:this.token},t=>{t&&(ee.storageTime("waiting-list-"+SB_WP_PAGE_ID),"request"!=e||ne.chat_open&&!ne.dashboard||ne.updateConversations())})}},dialogflow:{token:i("dialogflow-token"),typing_enabled:!0,project_id:!1,busy:!1,message:function(t="",s=[],n=!1,o=!1,r=!1){if(!(t.length<2)||s.length){if(!r)for(var l=0;l<s.length;l++)s[l][0].includes("voice_message")&&(r=s[l][1]);if(this.active(!0,!0,!1)){let e=le.dialogflow.humanTakeoverActive();if(e&&!this.typing_enabled||this.typing(),this.chatbotLimit())return ne.sendMessage(y,this.chatbotLimit());ne.headerAgent(!0),setTimeout(()=>{let n=ne.conversation;ee.ajax({function:"dialogflow-message",conversation_id:!!n&&n.id,message:t,attachments:s,parameters:o,token:this.token,dialogflow_language:i("dialogflow-language")?i("dialogflow-language"):SB_LANG,project_id:this.project_id,session_id:a().id+"-"+n.id,audio:r},s=>{if(ne.typing(-1,"stop"),!1!==s){if(s.response&&s.response.error)return console.error(s.response);if(s.human_takeover)return ne.offlineMessage(),ne.followUp(),this.active(!1);if(s.language_detection&&!i("dialogflow-language")&&i("dialogflow-language",[s.language_detection]),s.user_language&&!i("dialogflow-language")&&a().setExtra("language",s.user_language),s.translations&&(U.translations=s.translations),!ee.errorValidation(s)){let r=!!s.response.queryResult&&s.response.queryResult,l=r&&("input.unknown"==r.action||r.match&&"NO_MATCH"==r.match.matchType),c=s.messages&&Array.isArray(s.messages)?s.messages:[];if(clearTimeout(E),this.token!=s.token&&(this.token=s.token,i("dialogflow-token",s.token)),l?e&&(this.typing_enabled=!1):this.typing_enabled=!0,r){if(r.action){let e=r.action;"end"==e&&this.active(!1),ee.event("SBBotAction",e)}for(o=0;o<c.length;o++){if(c[o].payload){let e=["human-takeover","redirect","woocommerce-update-cart","woocommerce-checkout","open-article","transcript","department","agent","send-email","rich-message","tags"],t=c[o].payload;if(ee.null(t)&&(t=[]),e[0]in t&&!0===t[e[0]]&&this.humanTakeover(),e[1]in t&&setTimeout(function(){t["new-window"]?window.open(t[e[1]]):document.location=t[e[1]]},500),e[2]in t){let i=t[e[2]];le.woocommerce.updateCart(i[0],i[1],e=>{e&&ee.event("SBWoocommerceCartUpdated",{action:i[0],product:i[1]})})}if(e[3]in t&&!0===t[e[3]]&&le.wordpress.ajax("url",{url_name:"checkout"},e=>{setTimeout(()=>document.location=e,500)}),e[4]in t&&ne.showArticles(t[e[4]]),e[5]in t&&t[e[5]]&&ee.ajax({function:"transcript",conversation_id:n.id,type:"txt"},i=>{"email"==t[e[5]]&&a().email?ne.sendEmail(t.message?t.message:"",[[i,i]],n.id):window.open(i)}),e[6]in t&&ee.ajax({function:"update-conversation-department",conversation_id:n.id,department:t[e[6]],message:n.getLastUserMessage().message}),e[7]in t&&ee.ajax({function:"update-conversation-agent",conversation_id:n.id,agent_id:t[e[7]],message:n.getLastUserMessage().message}),e[8]in t){let i=t[e[8]];ne.sendEmail(i.message,i.attachments,"active_user"==i.recipient)}e[9]in t&&ne.sendMessage(y,t[e[10]]),e[10]in t&&ee.ajax({function:"update-tags",conversation_id:n.id,tags:t[e[11]]}),ee.event("SBBotPayload",t)}this.chatbotLimit(!1),i("dialogflow-language")||!r.languageCode||SB_LANG&&r.languageCode==SB_LANG[0]||i("dialogflow-language",[r.languageCode])}if(r.diagnosticInfo){r.diagnosticInfo.end_conversation&&this.active(!1)}}if(U.slack_active&&c&&(!w||e))for(var o=0;o<c.length;o++)ne.slackMessage(a().id,U.bot_name,U.bot_image,c[o].message,c[o].attachments);ee.event("SBBotMessage",{response:s,message:t})}}}),this.busy=!0},!1!==n?n:0==U.bot_delay?2e3:parseInt(U.bot_delay))}else this.active(!0,!1,!0)&&!e(".sb-emoji-list").html().includes("<li>"+t+"</li>")&&this.openAI(t,!1,r,s)}},openAI:function(t,s=!1,n=!1,o=[]){if(U.open_ai_active){if(ne.headerAgent(!0),ne.agent_id!=y||le.dialogflow.humanTakeoverActive()&&!this.typing_enabled||this.typing(),this.chatbotLimit())return ne.sendMessage(y,this.chatbotLimit());setTimeout(()=>{ee.ajax({function:"open-ai-message",message:t,conversation_id:!!ne.conversation&&ne.conversation.id,audio:n,extra:{token:le.dialogflow.token},attachments:o,context:!!U.open_ai_context_awareness&&(document.title.toUpperCase()+"\n\n\n"+e('meta[name="description"]').attr("content")||"")},e=>{this.busy=!1,ne.typing(-1,"stop"),ee.event("SBOpenAIMessage",{response:e,message:t}),e&&(e[0]||e[5])?(U.chatbot_limit&&this.chatbot_limit++,U.slack_active&&t&&(!w||le.dialogflow.humanTakeoverActive())&&ne.slackMessage(a().id,U.bot_name,U.bot_image,e[1]),e[2]&&le.dialogflow.token!=e[2]&&(le.dialogflow.token=e.token,i("dialogflow-token",e.token)),e[3]&&(ne.offlineMessage(),ne.followUp()),e[5]&&(e[5].redirect&&setTimeout(()=>{document.location=e[5].redirect},500),e[5].open_article&&ne.showArticles(e[5].open_article),"conversation-status-update-3"==e[5].event&&ne.conversationArchived()),this.chatbotLimit(!1)):!1!==e[1]&&ee.error(e[1].error?e[1].error.message:e[1],"SBApps.dialogflow.openAI"),s&&s(e)}),this.busy=!0},0==U.bot_delay?2e3:parseInt(U.bot_delay))}},flowOnLoad(){U.flow_on_load&&!i("flow-on-load")&&a()&&(ne.conversation?ee.ajax({function:"run-flow-on-load",message:U.flow_on_load,conversation_id:ne.conversation.id}):ne.newConversation(3,a().id,"",[],null,null,()=>{ee.ajax({function:"run-flow-on-load",message:U.flow_on_load,conversation_id:ne.conversation.id})}),i("flow-on-load",!0))},typing:function(){clearTimeout(I),I=setTimeout(()=>{ne.typing(-1,"start")},1e3)},active:function(e=!0,t=!0,i=!0){if(!1===e)return ne.conversation.set("is_human_takeover",!0),!1;if("activate"==e&&ne.conversation.set("is_human_takeover",!1),!x&&le.dialogflow.humanTakeoverActive()&&U.dialogflow_human_takeover_disable_chatbot)return!1;let s=!(x||ne.conversation&&le.dialogflow.humanTakeoverActive()&&ne.agent_online||U.dialogflow_office_hours&&U.office_hours);return t&&i?(U.dialogflow_active||U.open_ai_active)&&s:(!t||U.dialogflow_active)&&(!i||U.open_ai_active)&&s},welcome:function(e=!1,t=!1){ee.ajax({function:"dialogflow-message",message:"",conversation_id:ne.conversation.id,token:this.token,event:"Welcome",dialogflow_language:i("dialogflow-language")?i("dialogflow-language"):SB_LANG},()=>{e&&ne.start(),t&&ne.audio.play()})},humanTakeover:function(){ee.ajax({function:"dialogflow-human-takeover",conversation_id:ne.conversation.id},()=>{ne.offlineMessage(),ne.followUp(),this.active(!1),U.queue_human_takeover&&(U.queue=!0,ne.queue(ne.conversation.id))})},humanTakeoverActive:function(){return!!ne.conversation&&ne.conversation.get("is_human_takeover")},translate:function(e,t,i,s,a){ee.ajax({function:"google-translate",strings:e,language_code:t,token:this.token,message_ids:s,conversation_id:a},e=>{this.token=e[1],i(e[0])})},chatbotLimit:function(e=!0){if(U.chatbot_limit){let s=i("chatbot_limit"),a=(new Date).getTime()/1e3;if(s||(s=[]),e){let e=a-U.chatbot_limit.interval,n=[];for(var t=0;t<s.length;t++)s[t]>e&&n.push(s[t]);if(i("chatbot_limit",n),n.length>=U.chatbot_limit.quota)return U.chatbot_limit.message}else s.push(a),i("chatbot_limit",s)}return!1}},aecommerce:{cart:function(){le.is("aecommerce")&&typeof SB_AECOMMERCE_CART!=G&&typeof SB_AECOMMERCE_ACTIVE_USER!=G&&i("aecommerce")!=JSON.stringify(SB_AECOMMERCE_CART)&&ee.ajax({function:"aecommerce-cart",cart:SB_AECOMMERCE_CART},()=>{i("aecommerce",JSON.stringify(SB_AECOMMERCE_CART))})}},martfury:{privateChat:function(){let t=e("#tab-vendor > h4,.ps-product__vendor > a");if(t.length){t=t.html().toLowerCase();for(var i=0;i<U.martfury.length;i++)if(t==U.martfury[i]["martfury-linking-store"].toLowerCase()){let e=U.martfury[i]["martfury-linking-agent"],t=ee.activeUser()?ee.activeUser().conversations:[];ne.default_agent=e;for(var s=0;s<t.length;s++)if(t[s].get("agent_id")==e)return void ne.openConversation(t[s].id);ne.clear(),ne.hideDashboard()}}}}};window.SBApps=le,e(document).ready(function(){if((l=e(".sb-admin, .sb-admin-start")).length)return x=!0,void r();let t,i,s=!1;if(typeof SB_INIT_URL!=G)SB_INIT_URL.indexOf(".js")<0&&(SB_INIT_URL+="/js/main.js?v=3.8.3"),t=SB_INIT_URL;else{let e=document.getElementsByTagName("script"),i=["init.js","main.js","min/init.min.js","min/main.min.js"];for(var a=0;a<e.length;a++){let o=e[a].src;if("sbinit"==e[a].id){t=o,s=s||t.includes("init.");break}for(var n=0;n<i.length;n++)if(o&&o.includes("/supportboard/js/"+i[n])){t=o,s=s||t.includes("init.");break}}}let o=ee.getURL(!1,t);if(o.url&&(t=o.url),typeof SB_DISABLED!=G&&SB_DISABLED)return;if(s)return void r();typeof SB_TICKETS==G&&"tickets"!=o.mode||($=!0,o.mode="tickets"),o.cloud&&(W=o.cloud);let c=!(!Z||"en"==Shopify.locale)&&Shopify.locale,d=t.lastIndexOf("main.min.js"),u=(i=t.substr(0,t.lastIndexOf("main.js")>0?t.lastIndexOf("main.js")-4:d-8))+"/include/init.php"+(o.lang?"?lang="+o.lang:"")+(c?"?lang_optional="+c:"")+(o.mode?"&mode="+o.mode:"")+(W?"&cloud="+W:"");ee.cors("GET",u.replace(".php&",".php?"),t=>{let s="body";$&&e("#sb-tickets").length&&(s="#sb-tickets"),e(s).append(t),ee.loadResource(i+"/css/"+($?"tickets":"main")+".css"),$?ee.loadResource(i+"/apps/tickets/tickets"+(d>0?".min":"")+".js?v=3.8.3",!0,()=>{r()}):r(),o.lang&&(SB_LANG=[o.lang,x?"admin":"front"])})})}(jQuery);
>>>>>>> vendor-update
