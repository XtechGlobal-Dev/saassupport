<<<<<<< HEAD

/*
 * ==========================================================
 * ADMINISTRATION SCRIPT
 * ==========================================================
 *
 * Main Javascript admin file. Â© 2017-2025 board.support. All rights reserved.
 * 
 */

'use strict';

(function ($) {

    // Global
    var admin;
    var header;

    // Conversation  
    var conversations = [];
    var conversation_area;
    var conversations_area;
    var conversations_area_list;
    var conversations_user_details;
    var conversations_admin_list;
    var conversations_admin_list_ul;
    var conversations_filters;
    var saved_replies = false;
    var saved_replies_list = false;
    var woocommerce_products_box = false;
    var woocommerce_products_box_ul = false;
    var pagination = 1;
    var notes_panel;
    var tags_panel;
    var attachments_panel;
    var direct_message_box;
    var dialogflow_intent_box;
    var suggestions_area;
    var pagination_count = 1;
    var open_ai_button;

    // Users
    var users_area;
    var users_table;
    var users_table_menu;
    var users_filters;
    var users = {};
    var users_pagination = 1;
    var users_pagination_count = 1;
    var profile_box;
    var profile_edit_box;
    var away_mode = true;

    // Dashboard
    let newUsersChartInstance = null;
    var tickets_area_dash;

    // Tickets
    var tickets_area;
    var tickets_table;
    var tickets_table_menu;
    var tickets_filters;
    var tickets = {};
    var tickets_pagination = 1;
    var tickets_pagination_count = 1;
    var ticket_edit_box;
    var ticket_detail_area;
    var ticket_custom_fields_edit_box;
    var ticket_status_edit_box;
    var ticket_attachments_box;

    // Settings
    var settings_area;
    var automations_area;
    var automations_area_select;
    var automations_area_nav;
    var conditions_area;

    // Articles
    var articles_area;
    var articles_content;
    var articles_content_categories;
    var articles_category_select;
    var articles_category_parent_select;
    var articles_save_required = false;
    var articles_save_required_stop = true;

    // Chatbot
    var chatbot_area;
    var chatbot_files_table;
    var chatbot_website_table;
    var chatbot_qea_repeater;
    var chatbot_playground_editor;
    var chatbot_playground_area;
    var flows_nav;
    var flows_area;
    var flow_scroll_interval;
    var is_over_connector = false;
    var conversations_qea = [];
    var step_scroll_positions = [];

    // Miscellaneus
    var upload_input;
    var upload_target;
    var upload_function;
    var upload_on_success;
    var language_switcher_target;
    var timeout;
    var alertOnConfirmation;
    var alertOnCancel;
    var responsive = $(window).width() < 465;
    var scrolls = { last: 0, header: true, always_hidden: false };
    var localhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
    var today = new Date();
    var is_busy = false;
    var agent_online = true;
    var active_interval = false;
    var pusher_timeout;
    var away_timeout;
    var temp;
    var overlay;
    var SITE_URL;
    var ND = 'undefined';
    var wp_admin = false;
    var touchmove;
    var touchmove_x;
    var touchmove_y;
    var editor_js = false;
    var editor_js_saving = false;
    var editor_js_loading = false;
    var interval = false;
    var active_keydown;
    var reports_area;
    var select_departments;
    var active_admin_area;

    function showInitials(container, className) {
        const containers = $('.' + container + ' .' + className);
        containers.each(function () {
            const container = $(this);
            const img = container.find('img');
            const name = img.attr("data-name") || "";
            const initials = name
                .split(" ")
                .map(word => word[0])
                .join("")
                .substring(0, 2)
                .toUpperCase();


            const span = container.find(".initials");
            const userInitials = container.find('.user-initials');

            // Fallback: if image is broken, use initials
            function showInitialsFallback() {
                img.hide();
                if (span.length) {
                    userInitials.css("display", "inline-block");
                    span.text(initials || "NA");
                }
            }

            // Attach error event
            img.on('error', showInitialsFallback);

            // Trigger fallback if image is already broken (e.g. 404 cached)
            if (!img.prop('complete') || typeof img[0].naturalWidth === "undefined" || img[0].naturalWidth === 0) {
                showInitialsFallback();
            }

            // If the image source is a default user icon, show initials
            if (img.attr('src') && img.attr('src').includes('user.svg')) {
                showInitialsFallback();
            }
        });
    }
    //showInitialsHeader();
    function showInitialsHeader(className) {
        const containers = $('.' + className);
        containers.each(function () {
            const container = $(this);
            const img = container.find('img');
            const name = img.attr("data-name") || "";
            const initials = name
                .split(" ")
                .map(word => word[0])
                .join("")
                .substring(0, 2)
                .toUpperCase();
            const span = container.find(".initials");
            const userInitials = container.find('.user-initials');

            if (!img.attr('src') || img.attr('src').includes('user.svg')) {
                img.hide();
                span.text(initials || "NA");
                userInitials.show();
            }

            img.on('error', function () {
                img.hide();
                span.text(initials || "NA");
                userInitials.show();
            });
        });
    }
    /*
    * ----------------------------------------------------------
    * External plugins
    * ----------------------------------------------------------
    */

    // miniTip 1.5.3 | (c) 2011, James Simpson | Dual licensed under the MIT and GPL
    $.fn.miniTip = function (t) { var e = $.extend({ title: '', content: !1, delay: 300, anchor: 'n', event: 'hover', fadeIn: 200, fadeOut: 200, aHide: !0, maxW: '250px', offset: 5, stemOff: 0, doHide: !1 }, t); admin && 0 == admin.find('#miniTip').length && admin.append('<div id="miniTip" class="sb-tooltip"><div></div></div>'); var n = admin.find('#miniTip'), a = n.find('div'); return e.doHide ? (n.stop(!0, !0).fadeOut(e.fadeOut), !1) : this.each(function () { var t = $(this), o = e.content ? e.content : t.attr('title'); if ('' != o && void 0 !== o) { window.delay = !1; var i = !1, r = !0; e.content || t.removeAttr('title'), 'hover' == e.event ? (t.hover(function () { n.removeAttr('click'), r = !0, s.call(this) }, function () { r = !1, d() }), e.aHide || n.hover(function () { i = !0 }, function () { i = !1, setTimeout(function () { !r && !n.attr('click') && d() }, 20) })) : 'click' == e.event && (e.aHide = !0, t.click(function () { return n.attr('click', 't'), n.data('last_target') !== t ? s.call(this) : 'none' == n.css("display") ? s.call(this) : d(), n.data('last_target', t), $('html').unbind('click').click(function (t) { 'block' == n.css('display') && !$(t.target).closest('#miniTip').length && ($('html').unbind('click'), d()) }), !1 })); var s = function () { e.show && e.show.call(this, e), e.content && '' != e.content && (o = e.content), a.html(o), e.render && e.render(n), n.hide().width('').width(n.width()).css('max-width', e.maxW); var i = t.is('area'); if (i) { var r, s = [], d = [], c = t.attr('coords').split(','); function h(t, e) { return t - e } for (r = 0; r < c.length; r++)s.push(c[r++]), d.push(c[r]); var f = t.parent().attr('name'), l = $('img[usemap=\\#' + f + ']').offset(), p = parseInt(l.left, 10) + parseInt((parseInt(s.sort(h)[0], 10) + parseInt(s.sort(h)[s.length - 1], 10)) / 2, 10), u = parseInt(l.top, 10) + parseInt((parseInt(d.sort(h)[0], 10) + parseInt(d.sort(h)[d.length - 1], 10)) / 2, 10) } else u = parseInt(t.offset().top, 10), p = parseInt(t.offset().left, 10); var m = i ? 0 : parseInt(t.outerWidth(), 10), I = i ? 0 : parseInt(t.outerHeight(), 10), v = n.outerWidth(), w = n.outerHeight(), g = Math.round(p + Math.round((m - v) / 2)), T = Math.round(u + I + e.offset + 8), b = Math.round(v - 16) / 2 - parseInt(n.css('borderLeftWidth'), 10), y = 0, H = p + m + v + e.offset + 8 > parseInt($(window).width(), 10), W = v + e.offset + 8 > p, k = w + e.offset + 8 > u - $(window).scrollTop(), M = u + I + w + e.offset + 8 > parseInt($(window).height() + $(window).scrollTop(), 10), x = e.anchor; W || 'e' == e.anchor && !H ? 'w' != e.anchor && 'e' != e.anchor || (x = 'e', y = Math.round(w / 2 - 8 - parseInt(n.css('borderRightWidth'), 10)), b = -8 - parseInt(n.css('borderRightWidth'), 10), g = p + m + e.offset + 8, T = Math.round(u + I / 2 - w / 2)) : (H || 'w' == e.anchor && !W) && ('w' != e.anchor && 'e' != e.anchor || (x = 'w', y = Math.round(w / 2 - 8 - parseInt(n.css('borderLeftWidth'), 10)), b = v - parseInt(n.css('borderLeftWidth'), 10), g = p - v - e.offset - 8, T = Math.round(u + I / 2 - w / 2))), M || 'n' == e.anchor && !k ? 'n' != e.anchor && 's' != e.anchor || (x = 'n', y = w - parseInt(n.css('borderTopWidth'), 10), T = u - (w + e.offset + 8)) : (k || 's' == e.anchor && !M) && ('n' != e.anchor && 's' != e.anchor || (x = 's', y = -8 - parseInt(n.css('borderBottomWidth'), 10), T = u + I + e.offset + 8)), 'n' == e.anchor || 's' == e.anchor ? v / 2 > p ? (g = g < 0 ? b + g : b, b = 0) : p + v / 2 > parseInt($(window).width(), 10) && (g -= b, b *= 2) : k ? (T += y, y = 0) : M && (T -= y, y *= 2), delay && clearTimeout(delay), delay = setTimeout(function () { n.css({ 'margin-left': g + 'px', 'margin-top': T + 'px' }).stop(!0, !0).fadeIn(e.fadeIn) }, e.delay), n.attr('class', 'sb-tooltip ' + x) }, d = function () { (!e.aHide && !i || e.aHide) && (delay && clearTimeout(delay), delay = setTimeout(function () { c() }, e.delay)) }, c = function () { !e.aHide && !i || e.aHide ? (n.stop(!0, !0).fadeOut(e.fadeOut), e.hide && e.hide.call(this)) : setTimeout(function () { d() }, 200) } } }) };

    /*
    * ----------------------------------------------------------
    * Functions
    * ----------------------------------------------------------
    */

    $.fn.sbLanguageSwitcher = function (langs = [], source = '', active_language = false) {
        let code = `<div class="sb-language-switcher" data-source="${source}">`;
        let added = [];
        let element = $(this).hasClass('sb-language-switcher-cnt') ? $(this) : $(this).find('.sb-language-switcher-cnt');
        for (var i = 0; i < langs.length; i++) {
            let language = isString(langs[i]) ? langs[i] : langs[i][0];
            let id = isString(langs[i]) || !langs[i][1] ? false : langs[i][1];
            if (added.includes(language)) {
                continue;
            }
            code += `<span ${active_language == language ? 'class="sb-active" ' : ''}data-language="${language}"${id ? ' data-id="' + id + '"' : ''}><i class="sb-icon-close"></i><img src="${SB_URL}/media/flags/${language.toLowerCase()}.png" /></span>`;
            added.push(language);
        }
        element.find('.sb-language-switcher').remove();
        element.append(code + `<i data-sb-tooltip="${sb_('Add translation')}" class="sb-icon-plus"></i></div>`);
        element.sbInitTooltips();
        return this;
    }

    $.fn.sbShowLightbox = function (popup = false, action = '') {
        admin.find('.sb-lightbox').sbActive(false);
        overlay.sbActive(true);
        $(this).sbActive(true);
        if (popup) {
            $(this).addClass('sb-popup-lightbox').attr('data-action', action);
        } else {
            $(this).css({ 'margin-top': ($(this).outerHeight() / -2) + 'px', 'margin-left': ($(this).outerWidth() / -2) + 'px' })
        }
        $('body').addClass('sb-lightbox-active');
        setTimeout(() => { SBAdmin.open_popup = this }, 500);
        this.preventDefault;
        return this;
    }

    $.fn.sbHideLightbox = function () {
        $(this).find('.sb-lightbox,.sb-popup-lightbox').sbActive(false).removeClass('sb-popup-lightbox').removeAttr('data-action');
        overlay.sbActive(false);
        $('body').removeClass('sb-lightbox-active');
        SBAdmin.open_popup = false;
        return this;
    }

    $.fn.sbInitTooltips = function () {
        $(this).find('[data-sb-tooltip]').each(function () {
            $(this).miniTip({
                content: $(this).attr('data-sb-tooltip'),
                anchor: 's',
                delay: 500
            });
        });
        return this;
    }

    function infoBottom(text, type = false) {
        return SBAdmin.infoBottom(text, type);
    }

    function infoPanel(text, type = 'info', onConfirm = false, id = '', title = '', scroll = false, skip = false, onCancel = false) {
        return SBAdmin.infoPanel(text, type, onConfirm, id, title, scroll, skip, onCancel);
    }

    function activeUser(value) {
        return SBAdmin.activeUser(value);
    }

    function loading(element) {
        return SBAdmin.loading(element);
    }

    function loadingGlobal(show = true, is_overlay = true) {
        return SBAdmin.loadingGlobal(show, is_overlay);
    }

    function sb_(text) {
        return SB_TRANSLATIONS && text in SB_TRANSLATIONS ? SB_TRANSLATIONS[text] : text;
    }

    function isPWA() {
        return (window.matchMedia('(display-mode: standalone)').matches) || (window.navigator.standalone) || document.referrer.includes('android-app://');
    }

    function clearCache() {
        if (typeof caches !== ND) caches.delete('sb-pwa-cache');
    }

    function collapse(target, max_height) {
        SBAdmin.collapse(target, max_height);
    }

    function searchInput(input, searchFunction) {
        let icon = $(input).parent().find('i');
        let search = $(input).val();
        SBF.search(search, () => {
            icon.sbLoading(true);
            searchFunction(search, icon);
        });
    }

    function scrollPagination(area, check = false, offset = 0) {
        if (check) return $(area).scrollTop() + $(area).innerHeight() >= ($(area)[0].scrollHeight - 1);
        $(area).scrollTop($(area)[0].scrollHeight - offset);
    }

    function editorJSLoad(data = false) {
        if (editor_js_loading) return;
        if (editor_js === false) {
            editor_js = true;
            $.getScript(SB_URL + '/vendor/editorjs.js', () => {
                editorJSLoad(data);
            });
            return;
        }
        editorJSDestroy();
        editor_js_loading = true;
        editor_js = new EditorJS({
            data: isString(data) ? { time: Date.now(), blocks: [data ? { id: 'sb', type: 'raw', data: { html: data } } : { id: 'sb', type: 'paragraph', data: { text: '' } }] } : data,
            i18n: {
                messages: {
                    ui: {
                        'blockTunes': {
                            'toggler': {
                                'Click to tune': sb_('Click to tune')
                            },
                        },
                        'inlineToolbar': {
                            'converter': {
                                'Convert to': sb_('Convert to')
                            }
                        },
                        'toolbar': {
                            'toolbox': {
                                'Add': sb_('Add')
                            }
                        }
                    },
                    toolNames: {
                        'Text': sb_('Text'),
                        'Heading': sb_('Heading'),
                        'List': sb_('List'),
                        'Image': sb_('Image'),
                        'Code': sb_('Code'),
                        'Raw HTML': sb_('Raw HTML'),
                        'Bold': sb_('Bold'),
                        'Italic': sb_('Italic'),
                        'Link': sb_('Link'),
                    },
                    tools: {
                        'list': {
                            'Ordered': sb_('Ordered'),
                            'Unordered': sb_('Unordered')
                        }
                    },
                    blockTunes: {
                        'delete': {
                            'Delete': sb_('Delete')
                        },
                        'moveUp': {
                            'Move up': sb_('Move up')
                        },
                        'moveDown': {
                            'Move down': sb_('Move down')
                        }
                    },
                },
                direction: admin.hasClass('sb-rtl') ? 'rtl' : 'ltr'
            },
            tools: {
                list: {
                    class: List,
                    inlineToolbar: true
                },
                image: {
                    class: ImageTool,
                    config: {
                        uploader: {
                            uploadByFile(file) {
                                let form = new FormData();
                                form.append('file', file);
                                return new Promise((resolve) => {
                                    $.ajax({
                                        url: SB_URL + '/include/upload.php',
                                        cache: false,
                                        contentType: false,
                                        processData: false,
                                        data: form,
                                        type: 'POST',
                                        success: function (response) {
                                            response = JSON.parse(response);
                                            if (response[0] == 'success') {
                                                resolve({
                                                    success: 1,
                                                    file: {
                                                        url: response[1],
                                                    }
                                                })
                                            } else console.log(response);
                                        }
                                    })
                                })
                            }
                        }
                    }
                },
                header: Header,
                code: CodeTool,
                raw: RawTool
            },
            onReady: () => {
                editor_js_loading = false;
                articles_save_required_stop = true;
                articles_save_required = false;
            },
            onChange: () => {
                if (articles_save_required_stop) {
                    articles_save_required_stop = false;
                } else {
                    articles_save_required = true;
                }
            },
            minHeight: 50
        });
    }

    function editorJSHTML(blocks) {
        let code = '';
        blocks.map(block => {
            switch (block.type) {
                case 'header':
                    code += `<h${block.data.level}>${block.data.text}</h${block.data.level}>`;
                    break;
                case 'paragraph':
                    code += `<p>${block.data.text}</p>`;
                    break;
                case 'image':
                    code += `<img class="img-fluid" src="${block.data.file.url}" title="${block.data.caption}" /><em>${block.data.caption}</em>`;
                    break;
                case 'list':
                    code += '<ul class="sb-ul-' + block.data.style + '">';
                    block.data.items.forEach(function (li) {
                        code += `<li>${li}</li>`;
                    });
                    code += '</ul>';
                    break;
                case 'code':
                    code += `<code>${block.data.code}</code>`;
                    break;
                case 'raw':
                    code += `<div class="bxc-raw-html">${block.data.html}</div>`;
                    break;
            }
        });
        return code;
    }

    function editorJSDestroy() {
        if (typeof editor_js.destroy !== ND) {
            editor_js.destroy();
            editor_js = false;
        }
    }

    function isString(object) {
        return typeof object === 'string';
    }

    function pushState(url_parameters) {
        if (wp_admin) return;
        window.history.pushState('', '', url_parameters);
    }

    function cloudURL() {
        return SB_ADMIN_SETTINGS.cloud ? ('&cloud=' + SB_ADMIN_SETTINGS.cloud.token) : '';
    }

    function urlStrip(url) {
        return url.replace('https://', '').replace('http://', '').replace('www.', '').replace(/\/$/, '');
    }

    function saved_reply_search(search) {
        SBF.search(search, () => {
            let code = '';
            let all = search.length > 1 ? false : true;
            let area = saved_replies.find('.sb-replies-list > ul');
            let no_results = `<li class="sb-no-results">${sb_('No results found.')}</li>`;
            for (var i = 0; i < saved_replies_list.length; i++) {
                let name = saved_replies_list[i]['reply-name'];
                if (all || name.toLowerCase().includes(search) || name.replaceAll('-', ' ').toLowerCase().includes(search) || saved_replies_list[i]['reply-text'].toLowerCase().includes(search)) {
                    code += `<li><div>${name}</div><div>${saved_replies_list[i]['reply-text']}</div></li>`;
                }
            }
            area.html(code);
            if (!all && (SB_ADMIN_SETTINGS.dialogflow || SB_ADMIN_SETTINGS.chatbot_features)) {
                let icon = area.closest('.sb-popup').find('.sb-icon-search');
                icon.sbLoading(true);
                if (SB_ADMIN_SETTINGS.dialogflow) {
                    SBApps.dialogflow.getIntents((response) => {
                        let intents = SBApps.dialogflow.searchIntents(search, true);
                        let code_2 = '';
                        for (var i = 0; i < intents.length; i++) {
                            let text = intents[i].messages[0].text;
                            if (text && text.text) {
                                code_2 += `<li><div>${intents[i].displayName}</div><div>${intents[i].messages[0].text.text[0]}</div></li>`;
                            }
                        }
                        area.html(code_2 ? code + code_2 : (code ? code : no_results));
                        icon.sbLoading(false);
                    });
                } else {
                    SBF.ajax({
                        function: 'open-ai-message',
                        model: SB_ADMIN_SETTINGS.open_ai_model,
                        message: search
                    }, (response) => {
                        area.html(response[1] && (!response[5] || !response[5].unknow_answer) ? `${code}<li><div></div><div>${response[1]}</div></li>` : (code ? code : no_results));
                        icon.sbLoading(false);
                    });
                }
            } else if (!code) {
                area.html(no_results);
            }
        });
    }

    function whatsapp_direct_message_box(user_ids) {
        let box = admin.find('#sb-whatsapp-send-template-box');
        loadingGlobal();
        SBF.ajax({
            function: 'whatsapp-get-templates'
        }, (response) => {
            let code = '<option value=""></option>';
            let provider = response[0];
            let twilio = provider == 'twilio';
            response = response[1];
            if (response.error) {
                return infoBottom(response.error.message, 'error');
            }
            if (!Array.isArray(response)) {
                return infoBottom(response, 'error');
            }
            for (var i = 0; i < response.length; i++) {
                if (provider == 'official' && response[i].status == 'APPROVED' && (!SB_ACTIVE_AGENT.department || !response[i].department.length || response[i].department.includes(SB_ACTIVE_AGENT.department))) {
                    code += `<option value="${response[i].name}" data-languages="${response[i].languages}" data-phone-id="${response[i].phone_number_id}">${response[i].name} (${response[i].label})</option>`;
                }
                if (twilio) {
                    code += `<option value="${response[i].sid}">${response[i].friendly_name}</option>`;
                }
            }
            box.attr('data-provider', provider);
            box.find('#sb-whatsapp-send-template-list').html(code);
            SBForm.clear(box);
            box.find('.sb-direct-message-users').val(user_ids.length ? user_ids.join(',') : 'all');
            box.find('.sb-bottom > div').html('');
            box.find('.sb-loading').sbLoading(false);
            loadingGlobal(false);
            box.sbShowLightbox();
        });
    }

    function dialogDeleteFile(url, id, title) {
        window.open(url);
        infoPanel(`${sb_('For security reasons, delete the file after downloading it. Close this window to automatically delete it. File location:')}<pre>${url}</pre>`, 'info', false, id, title);
    }

    function touchEndEvent() {
        touchmove_x = false;
        touchmove_y = false;
        setTimeout(() => {
            if (touchmove) {
                touchmove[1].css('transform', '');
                touchmove[1].removeClass('sb-touchmove');
            }
        }, 100);
    }

    function getListConversation(conversation_id) {
        return conversations_admin_list_ul.find(`[data-conversation-id="${conversation_id}"]`);
    }

    /*
    * ----------------------------------------------------------
    * Apps
    * ----------------------------------------------------------
    */

    var SBApps = {

        dialogflow: {
            intents: false,
            qea: [],
            token: SBF.storage('dialogflow-token'),
            dialogflow_languages: [],
            original_response: false,
            smart_reply_busy: false,

            smartReply: function (message = false) {
                let conversation_id = SBChat.conversation.id;
                if (this.smart_reply_busy == conversation_id) {
                    return;
                }
                this.smart_reply_busy = conversation_id;
                SBF.ajax({
                    function: 'dialogflow-smart-reply',
                    message: message,
                    token: this.token,
                    conversation_id: conversation_id,
                    dialogflow_languages: this.dialogflow_languages,
                }, (response) => {
                    this.smart_reply_busy = false;
                    if (SBChat.conversation.id && conversation_id === SBChat.conversation.id) {
                        let suggestions = response.suggestions;
                        let code = '';
                        let is_bottom = conversations_area_list[0].scrollTop === (conversations_area_list[0].scrollHeight - conversations_area_list[0].offsetHeight);
                        let last_conversation_message = SBChat.conversation && SBChat.conversation.getLastMessage() ? SBChat.conversation.getLastMessage().message : false;
                        if (response.token) {
                            this.token = response.token;
                            SBF.storage('dialogflow-token', response.token);
                        }
                        for (var i = 0; i < suggestions.length; i++) {
                            if (suggestions[i] != last_conversation_message) {
                                code += `<span>${SBF.escape(suggestions[i])}</span>`;
                            }
                        }
                        suggestions_area.html(code);
                        if (is_bottom) {
                            SBChat.scrollBottom();
                        }
                    }
                    if (response.dialogflow_languages) {
                        this.dialogflow_languages = response.dialogflow_languages;
                    }
                });
            },

            showCreateIntentBox: function (message_id) {
                let question = '';
                let message = SBChat.conversation.getMessage(message_id);
                let response = message.message;
                if (SBF.isAgent(message.get('user_type'))) {
                    question = SBChat.conversation.getLastUserMessage(message.get('index'));
                    if (question && question.payload('sb-human-takeover')) {
                        question = SBChat.conversation.getLastUserMessage(question.get('index')).message;
                    } else {
                        question = question.message;
                    }
                } else {
                    question = response;
                    let agent_message = SBChat.conversation.getNextMessage(message.id, 'agent');
                    if (agent_message) {
                        response = agent_message.message;
                    }
                }
                if (dialogflow_intent_box.hasClass('sb-dialogflow-disabled')) {
                    SBF.ajax({
                        function: 'open-ai-get-qea-training'
                    }, (response) => {
                        let code = '<option value="">' + sb_('New Q&A') + '</option>';
                        for (var i = 0; i < response.length; i++) {
                            this.qea = response;
                            code += `<option value="${i}">${response[i][0][0]}</option>`;
                        }
                        dialogflow_intent_box.find('#sb-qea-select').html(code);
                    });
                    SBApps.openAI.generateQuestions(question);
                } else {
                    this.getIntents((response) => {
                        let code = '<option value="">' + sb_('New Intent') + '</option>';
                        for (var i = 0; i < response.length; i++) {
                            code += `<option value="${response[i].name}">${response[i].displayName}</option>`;
                        }
                        dialogflow_intent_box.find('#sb-intents-select').html(code);
                        SBApps.openAI.generateQuestions(question);
                    });
                }
                dialogflow_intent_box.attr('data-message-id', message.id);
                dialogflow_intent_box.find('.sb-type-text:not(.sb-first)').remove();
                dialogflow_intent_box.find('.sb-type-text input').val(question);
                dialogflow_intent_box.find('#sb-intents-select,#sb-qea-select').val('');
                dialogflow_intent_box.find('.sb-search-btn').sbActive(false).find('input').val('');
                this.searchIntents('');
                this.original_response = response;
                dialogflow_intent_box.find('textarea').val(response);
                dialogflow_intent_box.sbShowLightbox();
            },

            submitIntent: function (button) {
                if (loading(button)) return;
                let questions = [];
                let answer = dialogflow_intent_box.find('textarea').val();
                let intent_name = dialogflow_intent_box.find('#sb-intents-select,#sb-qea-select').val();
                let services = dialogflow_intent_box.find('#sb-train-chatbots').val();
                let is_open_ai = services == 'open-ai' || dialogflow_intent_box.hasClass('sb-dialogflow-disabled');
                dialogflow_intent_box.find('.sb-type-text input').each(function () {
                    if ($(this).val()) {
                        questions.push($(this).val());
                    }
                });
                if ((!answer && !intent_name) || questions.length == 0) {
                    SBForm.showErrorMessage(dialogflow_intent_box, 'Please insert the bot response and at least one user expression.');
                    $(button).sbLoading(false);
                } else {
                    let questions_answers;
                    if (is_open_ai) {
                        if (intent_name) {
                            this.qea[intent_name][0] = this.qea[intent_name][0].concat(questions);
                            questions_answers = this.qea[intent_name];
                        } else {
                            questions_answers = [[questions, answer]];
                        }
                    }
                    SBF.ajax({
                        function: is_open_ai ? 'open-ai-qea-training' : (!intent_name ? 'dialogflow-create-intent' : 'dialogflow-update-intent'),
                        questions_answers: questions_answers,
                        expressions: questions,
                        response: answer,
                        agent_language: dialogflow_intent_box.find('.sb-dialogflow-languages select').val(),
                        conversation_id: SBChat.conversation.id,
                        intent_name: intent_name,
                        update_index: intent_name,
                        services: services,
                        language: dialogflow_intent_box.find('.sb-dialogflow-languages select').val()
                    }, (response) => {
                        $(button).sbLoading(false);
                        if (response === true) {
                            admin.sbHideLightbox();
                            infoBottom('Training completed');
                        } else {
                            SBForm.showErrorMessage(dialogflow_intent_box, response.error && response.error.message ? response.error && response.error.message : 'Error');
                        }
                    });
                }
            },

            getIntents: function (onSuccess) {
                if (this.intents === false) {
                    SBF.ajax({ function: 'dialogflow-get-intents' }, (response) => {
                        this.intents = Array.isArray(response) ? response : [];
                        onSuccess(this.intents);
                    });
                } else {
                    onSuccess(this.intents);
                }
            },

            searchIntents: function (search, return_intents = false) {
                if (dialogflow_intent_box.hasClass('sb-dialogflow-disabled')) {
                    let all = search.length > 1 ? false : true;
                    let code = all ? `<option value="">${sb_('New Q&A')}</option>` : '';
                    let list = [];
                    search = search.toLowerCase();
                    for (var i = 0; i < this.qea.length; i++) {
                        if (all || (this.qea[i][0].join('').toLowerCase().includes(search) || this.qea[i][1].toLowerCase().includes(search))) {
                            code += `<option value="${i}">${this.qea[i][0][0]}</option>`;
                        }
                    }
                    dialogflow_intent_box.find('#sb-qea-select').html(code).change();
                    if (all) {
                        dialogflow_intent_box.find('textarea').val(this.original_response);
                    }
                } else {
                    let all = search.length > 1 ? false : true;
                    let code = all ? `<option value="">${sb_('New Intent')}</option>` : '';
                    let intents = this.intents;
                    let intents_list = [];
                    search = search.toLowerCase();
                    for (var i = 0; i < intents.length; i++) {
                        let found = all || intents[i].displayName.toLowerCase().includes(search);
                        if (!found && intents[i].trainingPhrases) {
                            let training_phrases = intents[i].trainingPhrases;
                            for (var j = 0; j < training_phrases.length; j++) {
                                for (var y = 0; y < training_phrases[j].parts.length; y++) {
                                    if (training_phrases[j].parts[y].text.toLowerCase().includes(search)) {
                                        found = true;
                                        break;
                                    }
                                }
                                if (found) break;
                            }
                        }
                        if (found) {
                            if (return_intents) {
                                intents_list.push(intents[i]);
                            } else {
                                code += `<option value="${intents[i].name}">${intents[i].displayName}</option>`;
                            }
                        }
                    }
                    if (return_intents) {
                        return intents_list;
                    } else {
                        dialogflow_intent_box.find('#sb-intents-select').html(code).change();
                    }
                    if (!search) {
                        dialogflow_intent_box.find('textarea').val(this.original_response);
                    }
                }
            },

            previewIntentDialogflow: function (name) {
                let code = '';
                let intent = this.getIntent(name);
                if (intent) {
                    let training_phrases = intent.trainingPhrases ? intent.trainingPhrases : [];
                    let count = training_phrases.length;
                    if (count > 1) {
                        for (var j = 0; j < count; j++) {
                            for (var y = 0; y < training_phrases[j].parts.length; y++) {
                                code += `<span>${training_phrases[j].parts[y].text}</span>`;
                                if (y == 15) break;
                            }
                        }
                        infoPanel(code, 'info', false, 'intent-preview-box', '', count > 10);
                    }
                }
            },

            previewIntent: function (index) {
                if (index) {
                    let code = '';
                    let qea = this.qea[index];
                    if (qea[0].length > 1) {
                        let max = qea[0].length > 15 ? 15 : qea[0].length;
                        for (var i = 0; i < max; i++) {
                            code += `<span>${qea[0][i]}</span>`;
                        }
                        infoPanel(code, 'info', false, 'qea-preview-box', '', max > 10);
                    }
                }
            },

            getIntent: function (name) {
                let code = '';
                for (var i = 0; i < this.intents.length; i++) {
                    if (this.intents[i].name == name) {
                        return this.intents[i];
                    }
                }
                return false;
            },

            translate: function (strings, language_code, onSuccess, message_ids, conversation_id) {
                if (strings.length) {
                    SBF.ajax({
                        function: 'google-translate',
                        strings: strings,
                        language_code: language_code,
                        token: this.token,
                        message_ids: message_ids,
                        conversation_id: conversation_id
                    }, (response) => {
                        this.token = response[1]
                        if (Array.isArray(response[0])) {
                            onSuccess(response[0]);
                        } else {
                            SBF.error(JSON.stringify(response[0]), 'SBApps.dialogflow.translate');
                            return false;
                        }
                    });
                }
            }
        },

        openAI: {
            urls_history: [],
            progress: 1,

            rewriteButton: function (value) {
                if (open_ai_button.length) {
                    open_ai_button.sbActive(value.length > 2 && value.indexOf(' '));
                }
            },

            rewrite: function (message, onSuccess) {
                SBF.ajax({
                    function: 'open-ai-message',
                    model: SB_ADMIN_SETTINGS.open_ai_model,
                    message: (SB_ADMIN_SETTINGS.open_ai_prompt_rewrite ? SB_ADMIN_SETTINGS.open_ai_prompt_rewrite : 'Make the following sentence more friendly and professional') + ` and use ${SB_LANGUAGE_CODES[SB_ADMIN_SETTINGS.active_agent_language]} language: """${message.replace('"', '\'')}"""`,
                    extra: 'rewrite'
                }, (response) => {
                    if (!response[0]) {
                        console.error('OpenAI: ' + JSON.stringify(response[1]));
                    }
                    SBConversations.previous_editor_text = message;
                    onSuccess(response);
                });
            },

            troubleshoot: function () {
                let status = SB_ADMIN_SETTINGS.open_ai_chatbot_status;
                if (status !== true) {
                    infoBottom(status == 'inactive' ? 'Enable the chatbot in Settings > Artificial Intelligence > OpenAI > Chatbot.' : (status == 'key' ? 'Enter the OpenAI API key in Settings > Artificial Intelligence > OpenAI > API key.' : 'The training data is ignored. Change the chatbot mode in Settings > Artificial Intelligence > OpenAI > Chatbot mode.'), 'error');
                }
                return status;
            },

            getCode: {
                set_data: function (data) {
                    let code = '';
                    let code_select_user_details = this.select_user_details();
                    if (!data || !data.length) {
                        data = [['', '']];
                    }
                    for (var i = 0; i < data.length; i++) {
                        code += `<div class="repeater-item"><div>${code_select_user_details.replace(`"${data[i][0]}"`, `"${data[i][0]}" selected`)}<div class="sb-setting"><input type="url" placeholder="${sb_('Enter the value')}" value="${data[i][1]}"></div></div><i class="sb-icon-close"></i></div>`;
                    }
                    return this.repeater_('Data', code);
                },

                actions: function (actions) {
                    let action_list = [['tags', 'Assign tags'], ['department', 'Assign a department'], ['agent', 'Assign an agent'], ['redirect', 'Go to URL'], ['open_article', 'Show an article'], ['transcript', 'Download transcript'], ['transcript_email', 'Email transcript'], ['send_email', 'Send email to user'], ['send_email_agents', 'Send email to agents'], ['archive_conversation', 'Archive the conversation'], ['human_takeover', 'Human takeover']];
                    let code = '';
                    let code_2 = '';
                    if (!actions || !actions.length) {
                        actions = [['tags', '']];
                    }
                    for (var i = 0; i < action_list.length; i++) {
                        code += `<option value="${action_list[i][0]}">${sb_(action_list[i][1])}</option>`;
                    }
                    for (var i = 0; i < actions.length; i++) {
                        code_2 += `<div class="repeater-item"><div><div class="sb-setting"><select>${code.replace(`"${actions[i][0]}"`, `"${actions[i][0]}" selected`)}</select></div>${this.action(actions[i][0], actions[i][1])}</div><i class="sb-icon-close"></i></div>`;
                    }
                    return this.repeater_('Actions', code_2);
                },

                action: function (action, value) {
                    let help = { tags: 'Enter tag names, separated by commas', department: 'Enter the department ID', agent: 'Enter the agent ID', redirect: 'Enter the URL', open_article: 'Enter the article ID', send_email: 'Enter a message', send_email_agents: 'Enter a message' };
                    let input_types = { department: 'number', agent: 'number', redirect: 'url' };
                    return ['send_email_agents', 'send_email', 'open_article', 'redirect', 'agent', 'department', 'tags'].includes(action) ? `<div class="sb-setting"><input type="${input_types[action] ? input_types[action] : 'text'}" value="${value}" placeholder="${sb_(help[action])}" value="${value}"></div>` : '';
                },

                select_user_details: function () {
                    let code = '<div class="sb-setting"><select>';
                    let user_details = [['full_name', 'Name'], ['email', 'Email'], ['password', 'Password']].concat(SBUsers.getExtraDetailsList());
                    for (var i = 0; i < user_details.length; i++) {
                        code += `<option value="${user_details[i][0]}">${sb_(user_details[i][1])}</option>`;
                    }
                    return code + `</select></div>`;
                },

                repeater_: function (title, code) {
                    return `<div class="sb-title">${sb_(title)}</div><div data-type="repeater" class="sb-setting sb-type-repeater"><div class="input"><div class="sb-repeater sb-repeater-block-${SBF.stringToSlug(title)}">${code}</div><div class="sb-btn sb-btn-white sb-repeater-add sb-icon"><i class="sb-icon-plus"></i>${sb_('Add new item')}</div></div></div>`;
                }
            },

            generateQuestions: function (expression) {
                if (SB_ADMIN_SETTINGS.open_ai_user_expressions && expression) {
                    let loader = dialogflow_intent_box.find('[data-value="add"]');
                    loader.sbLoading(true);
                    dialogflow_intent_box.find('.sb-open-ai-intent').remove();
                    SBF.ajax({ function: 'open-ai-user-expressions', message: expression }, (response) => {
                        let code = '';
                        for (var i = 0; i < response.length; i++) {
                            if (response[i]) {
                                code += `<div class="sb-setting sb-type-text sb-open-ai-intent"><input type="text" value="${response[i].replace(/"/g, '')}"></div>`;
                            }
                        }
                        if (code) dialogflow_intent_box.find('> div > .sb-type-text').last().after(code);
                        loader.sbLoading(false);
                    });
                }
            },

            flows: {
                flows: [],

                set: function (flow) {
                    if (typeof flow == 'string') {
                        flow = flow.trim().replaceAll('"', '').replaceAll('_', '-');
                        if (flow) {
                            flow = { name: flow, steps: [[[{ type: 'start', start: 'message', message: '', conditions: [], disabled: false }]], [[]]] };
                        }
                    } else {
                        for (var i = 0; i < this.flows.length; i++) {
                            if (this.flows[i].name == flow.name) {
                                this.flows[i] = flow;
                                this.show(flow.name);
                                return true;
                            }
                        }
                    }
                    this.flows.push(flow);
                    flows_nav.find('.sb-active').sbActive(false);
                    flows_nav.append(this.navCode(flow.name, true));
                    this.show(flow.name);
                },

                get: function (name = false) {
                    if (!name) {
                        name = this.getActiveName();
                    }
                    for (var i = 0; i < this.flows.length; i++) {
                        if (this.flows[i].name == name) {
                            if (!this.flows[i].steps) {
                                this.flows[i].steps = [];
                            }
                            return this.flows[i];
                        }
                    }
                    return false;
                },

                show: function (name = false) {
                    if (!name) {
                        name = this.getActiveName();
                    }
                    let flow = this.get(name);
                    let code = '';
                    let items;
                    if (flow) {
                        let letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                        let previous_labels = [];
                        let labels = [];
                        for (var i = 0; i < flow.steps.length; i++) {
                            let block_cnts = flow.steps[i];
                            let letters_index = 0;
                            previous_labels = labels;
                            labels = [];
                            code += '<div><div>';
                            for (var j = 0; j < block_cnts.length; j++) {
                                let blocks = block_cnts[j];
                                code += '<div class="sb-flow-block-cnt">';
                                if (previous_labels[j]) {
                                    code += `<div class="sb-flow-block-cnt-name">${previous_labels[j]}</div>`;
                                }
                                for (var y = 0; y < blocks.length; y++) {
                                    if (blocks[y].type == 'start' && !Array.isArray(blocks[y].message)) blocks[y].message = [{ message: blocks[y].message }]; // Deprecated
                                    let text = blocks[y].message ? (Array.isArray(blocks[y].message) ? (blocks[y].message.length ? blocks[y].message[0].message : '') : blocks[y].message) : '';
                                    if (text) {
                                        text = `<div>${text.length > 45 ? text.substring(0, 45) + '...' : text}</div>`;
                                    }
                                    code += `<div class="sb-flow-block" data-type="${blocks[y].type}"><div>${sb_(SBF.slugToString(blocks[y].type))}</div>${text}`;
                                    switch (blocks[y].type) {
                                        case 'get_user_details':
                                            labels.push(false);
                                            break;
                                        case 'condition':
                                        case 'button_list':
                                            let is_condition = blocks[y].type == 'condition';
                                            let rows = is_condition ? [sb_('True'), sb_('False')] : blocks[y].options;
                                            if (is_condition) {
                                                code += `<div>`;
                                                items = blocks[y].conditions;
                                                for (var x = 0; x < items.length; x++) {
                                                    code += `<div>${SBF.slugToString(items[x][0] + ' ' + items[x][1])}${items[x][2] ? ': ' + items[x][2] : ''}</div>`;
                                                }
                                                code += `</div>`;
                                            }
                                            code += `<div class="sb-flow-connectors">`;
                                            for (var x = 0; x < rows.length; x++) {
                                                labels.push(letters[letters_index] + (x + 1));
                                                code += `<div>${rows[x]}<span>${labels[labels.length - 1]}</span></div>`;
                                            }
                                            code += `</div>`;
                                            letters_index++;
                                            break;
                                        case 'video':
                                            code += `<div>${blocks[y].url}</div>`;
                                            break;
                                        case 'action':
                                        case 'set_data':
                                            code += `<div>`;
                                            items = blocks[y][blocks[y].type == 'set_data' ? 'data' : 'actions'];
                                            for (var x = 0; x < items.length; x++) {
                                                code += `<div>${SBF.slugToString(items[x][0])}${items[x][1] ? ': ' + items[x][1] : ''}</div>`;
                                            }
                                            code += `</div>`;
                                            break;
                                        case 'rest_api':
                                            code += `<div>${blocks[y].url}</div>`;
                                            break;
                                    }
                                    code += '</div>';
                                }
                                if (blocks.length < 4) {
                                    code += '<div class="sb-flow-add-block sb-icon-plus"></div>';
                                }
                                code += '</div>';
                            }
                            code += '</div><div class="sb-flow-add-step sb-icon-plus"></div></div>';
                        }
                        flows_area.html(code);
                        $(admin).find('.sb-flow-scroll').sbActive((flow.steps.length * 250) > flows_area.outerWidth());
                    }
                },

                delete: function (flow_name) {
                    for (var i = 0; i < this.flows.length; i++) {
                        if (this.flows[i].name == flow_name) {
                            let nav = flows_nav.find(`[data-value="${flow_name}"]`);
                            this.flows[i].steps.forEach((step) => {
                                step.forEach((block_cnt) => {
                                    block_cnt.forEach((block) => {
                                        if (block.attachments) {
                                            block.attachments.forEach((attachment) => {
                                                SBF.ajax({ function: 'delete-file', path: attachment });
                                            });
                                        }
                                    });
                                });
                            });
                            this.flows.splice(i, 1);
                            if (nav.sbActive()) {
                                if (nav.prev().length) {
                                    nav.prev().click();
                                } else if (nav.next().length) {
                                    nav.next().click();
                                } else {
                                    flows_area.html('');
                                }
                            }
                            nav.remove();
                            return true;
                        }
                    }
                    return false;
                },

                save: function (onSuccess = false) {
                    SBF.ajax({ function: 'open-ai-flows-save', flows: JSON.stringify(this.flows) }, (response) => {
                        onSuccess(response);
                    });
                },

                navCode: function (name, active = false) {
                    return `<li${active ? ' class="sb-active"' : ''} data-value="${name}">${name}<i class="sb-icon-delete"></i></li>`;
                },

                getActive: function () {
                    return flows_nav.find('.sb-active');
                },

                getActiveName: function () {
                    return this.getActive().attr('data-value');
                },

                getActiveIndex: function () {
                    return this.getActive().index();
                },

                steps: {

                    get: function (flow_name = false, step_index = false) {
                        return SBApps.openAI.flows.get(flow_name).steps[step_index ? step_index : this.getActiveIndex()];
                    },

                    getActiveIndex: function () {
                        return SBApps.openAI.flows.blocks.getActive().parent().parent().parent().index();
                    }
                },

                blocks: {
                    set: function (block, flow_name = false, step_index = false, block_cnt_index = false, block_index = false) {
                        let indexes = this.getIndexes(flow_name, step_index, block_cnt_index, block_index);
                        let flow = SBApps.openAI.flows.get(flow_name);
                        if (flow) {
                            let stop = false;
                            if (flow.steps.length > indexes.step) {
                                let block_cnts = flow.steps[indexes.step];
                                if (block_cnts.length > indexes.cnt) {
                                    let blocks = block_cnts[indexes.cnt];
                                    if (blocks.length > indexes.block) {
                                        blocks[indexes.block] = block;
                                        stop = true;
                                    }
                                }
                                if (!stop) {
                                    flow.steps[indexes.step][indexes.cnt].push(block);
                                    stop = true;
                                }
                            }
                            if (!stop) {
                                flow.steps.push([[block]]);
                            }

                            // Generate next step
                            let step = flow.steps[indexes.step];
                            let next_step = flow.steps[SBApps.openAI.flows.steps.getActiveIndex() + 1];
                            let next_step_block_cnts_count = 0;
                            for (var i = 0; i < step.length; i++) {
                                for (var j = 0; j < step[i].length; j++) {
                                    switch (step[i][j].type) {
                                        case 'get_user_details':
                                            next_step_block_cnts_count += 1;
                                            break;
                                        case 'button_list':
                                            next_step_block_cnts_count += step[i][j].options.length;
                                            break;
                                        case 'condition':
                                            next_step_block_cnts_count += 2;
                                            break;
                                    }
                                }
                            }
                            if (next_step) {
                                if (next_step.length > next_step_block_cnts_count) {
                                    next_step.splice((next_step_block_cnts_count - 1) * -1, next_step_block_cnts_count);
                                } else {
                                    let i = next_step.length;
                                    for (i; i < next_step_block_cnts_count; i++) {
                                        next_step.splice(indexes.cnt, 0, [])
                                    }
                                }
                            } else {
                                next_step = [];
                                for (var i = 0; i < next_step_block_cnts_count; i++) {
                                    next_step.push([]);
                                }
                                if (next_step.length) {
                                    flow.steps.push(next_step);
                                }
                            }

                            // Update the flow
                            SBApps.openAI.flows.show(flow_name);
                            return true;
                        }
                        return false;
                    },

                    get: function (flow_name = false, step_index = false, block_cnt_index = false, block_index = false) {
                        let flow = SBApps.openAI.flows.get(flow_name);
                        if (flow) {
                            let indexes = this.getIndexes(flow_name, step_index, block_cnt_index, block_index);
                            return flow.steps[indexes.step][indexes.cnt][indexes.block];
                        }
                        return false;
                    },

                    add: function (block_type, flow_name = false, step_index = false, block_cnt_index = false, block_index = false) {
                        let attributes = { button_list: { message: '', options: [] }, message: { message: '' }, video: { message: '', url: '' }, get_user_details: { message: '', details: [] }, set_data: { data: [] }, action: { actions: [] }, rest_api: { url: '', method: '', headers: [], body: '', save_response: [] }, condition: { conditions: [] } };
                        let indexes = this.getIndexes(flow_name, step_index, block_cnt_index, block_index);
                        this.set(Object.assign(attributes[block_type], { type: block_type }), indexes.name, indexes.step, indexes.cnt, indexes.block);
                        SBApps.openAI.flows.show(flow_name);
                        setTimeout(() => {
                            flows_area.find('> div').eq(indexes.step).find('.sb-flow-block-cnt').eq(indexes.cnt).find('.sb-flow-block').eq(indexes.block).click();
                        }, 100);
                    },

                    delete: function (flow_name = false, step_index = false, block_cnt_index = false, block_index = false) {
                        let indexes = this.getIndexes(flow_name, step_index, block_cnt_index, block_index);
                        for (var i = 0; i < SBApps.openAI.flows.flows.length; i++) {
                            let flow = SBApps.openAI.flows.flows[i];
                            if (indexes.name == flow.name) {
                                if (['get_user_details', 'button_list', 'condition'].includes(flow.steps[indexes.step][indexes.cnt][indexes.block].type)) {
                                    let block_cnts_to_delete = this.delete_(i, indexes.step, indexes.cnt);
                                    let flow_new = Object.assign({}, flow);
                                    for (var j = 0; j < block_cnts_to_delete.length; j++) {
                                        flow.steps[block_cnts_to_delete[j][0]][block_cnts_to_delete[j][1]] = false;
                                    }
                                    flow.steps[indexes.step][indexes.cnt].splice(indexes.block, 1);
                                    flow_new.steps = [];
                                    for (var j = 0; j < flow.steps.length; j++) {
                                        let step = [];
                                        for (var k = 0; k < flow.steps[j].length; k++) {
                                            if (flow.steps[j][k]) {
                                                step.push(flow.steps[j][k]);
                                            }
                                        }
                                        if (step.length) {
                                            flow_new.steps.push(step);
                                        }
                                    }
                                    SBApps.openAI.flows.flows[i] = flow_new;
                                } else {
                                    flow.steps[indexes.step][indexes.cnt].splice(indexes.block, 1);
                                }
                                SBApps.openAI.flows.show(indexes.name);
                                return true;
                            }
                        }
                        return false;
                    },

                    delete_: function (i, step_index, block_cnt_index, all_next_block_cnt_indexes = []) {
                        let next_block_cnt_indexes = SBApps.openAI.flows.blocks.getNextCntIndexes(i, step_index, block_cnt_index);
                        for (var j = 0; j < next_block_cnt_indexes.length; j++) {
                            all_next_block_cnt_indexes.push([step_index + 1, next_block_cnt_indexes[j]]);
                            this.delete_(i, step_index + 1, next_block_cnt_indexes[j], all_next_block_cnt_indexes);
                        }
                        return all_next_block_cnt_indexes;
                    },

                    getActive: function () {
                        return flows_area.find('.sb-flow-add-block.sb-active, .sb-flow-block.sb-active');
                    },

                    getActiveIndex: function () {
                        let blocks = this.getActiveCnt().find('.sb-flow-block');
                        let index = blocks.index(this.getActive());
                        return index === -1 ? blocks.length : index;
                    },

                    getActiveCnt: function () {
                        return this.getActive().parent();
                    },

                    getActiveCntIndex: function () {
                        return this.getActive().parent().index();
                    },

                    getNextCnt: function (current_flow_index, current_step_index, current_block_cnts_index, current_connector_index = 0) {
                        let indexes = this.getNextCntIndexes(current_flow_index, current_step_index, current_block_cnts_index, current_connector_index);
                        return indexes.length > current_connector_index ? SBApps.openAI.flows.flows[current_flow_index].steps[current_step_index + 1][indexes[current_connector_index]] : false;
                    },

                    getNextCntIndexes: function (current_flow_index, current_step_index, current_block_cnt_index) {
                        let flow = SBApps.openAI.flows.flows[current_flow_index];
                        let next_block_cnt_indexees = [];
                        if (flow && flow.steps[current_step_index + 1]) {
                            let next_block_cnt_index = 0;
                            for (var i = 0; i <= current_block_cnt_index; i++) {
                                let current_blocks = flow.steps[current_step_index][i];
                                for (var j = 0; j < current_blocks.length; j++) {
                                    if (current_blocks[j].type == 'button_list') {
                                        for (var k = 0; k < current_blocks[j].options.length; k++) {
                                            if (i == current_block_cnt_index) {
                                                next_block_cnt_indexees.push(next_block_cnt_index);
                                            }
                                            next_block_cnt_index++;
                                        }
                                    } else if (current_blocks[j].type == 'get_user_details') {
                                        if (i == current_block_cnt_index) {
                                            next_block_cnt_indexees.push(next_block_cnt_index);
                                        }
                                        next_block_cnt_index++;
                                    } else if (current_blocks[j].type == 'condition') {
                                        for (var k = 0; k < 2; k++) {
                                            if (i == current_block_cnt_index) {
                                                next_block_cnt_indexees.push(next_block_cnt_index);
                                            }
                                            next_block_cnt_index++;
                                        }
                                    }
                                }
                            }
                        }
                        return next_block_cnt_indexees;
                    },

                    getPreviousCntIndex: function (current_flow_index, current_step_index, current_block_cnt_index) {
                        let previous_step = SBApps.openAI.flows.flows[current_flow_index].steps[current_step_index - 1];
                        if (previous_step) {
                            let index = 0;
                            for (var i = 0; i < previous_step.length; i++) {
                                let block_cnt = previous_step[i];
                                for (var j = 0; j < block_cnt.length; j++) {
                                    index += block_cnt[j].type == 'button_list' ? block_cnt[j].options.length : (block_cnt[j].type == 'get_user_details' ? 1 : (block_cnt[j].type == 'condition' ? 2 : 0));
                                }
                                if (index > current_block_cnt_index) {
                                    return i;
                                }
                            }
                            return index;
                        }
                    },

                    getIndexes: function (flow_name, step_index, block_cnt_index, block_index) {
                        return { name: flow_name ? flow_name : SBApps.openAI.flows.getActiveName(), step: step_index ? step_index : SBApps.openAI.flows.steps.getActiveIndex(), cnt: block_cnt_index ? block_cnt_index : this.getActiveCntIndex(), block: block_index ? block_index : this.getActiveIndex() };
                    },

                    activateLinkedCnts: function (active_block) {
                        let block_cnt = $(active_block).parent();
                        let active_flow_index = SBApps.openAI.flows.getActiveIndex();
                        let active_step_index = block_cnt.parent().parent().index();
                        let flows = flows_area.find('> div');
                        let previous_cnt = flows.eq(active_step_index - 1).find('.sb-flow-block-cnt').eq(SBApps.openAI.flows.blocks.getPreviousCntIndex(active_flow_index, active_step_index, block_cnt.index()));
                        if (!is_over_connector) {
                            let next_block_cnts = flows.eq(active_step_index + 1).find('.sb-flow-block-cnt');
                            let next_block_cnt_indexes = SBApps.openAI.flows.blocks.getNextCntIndexes(active_flow_index, active_step_index, block_cnt.index());
                            for (var i = 0; i < next_block_cnt_indexes.length; i++) {
                                next_block_cnts.eq(next_block_cnt_indexes[i]).sbActive(true);
                            }
                        }
                        flows_area.find('.sb-flow-connectors > div').sbActive(false);
                        previous_cnt.sbActive(true).find('.sb-flow-block-cnt-name').sbActive(true);
                        if (block_cnt.find('.sb-flow-block-cnt-name').length) {
                            previous_cnt.find('.sb-flow-connectors > div').sbActive(false).eq(parseInt(block_cnt.find('.sb-flow-block-cnt-name').html().substring(1)) - 1).sbActive(true);
                        }
                    }
                }
            },

            train: {
                urls: [],
                errors: [],
                base_url: false,
                start_urls: [],
                sitemap_processed_urls: [],
                active_source: false,
                history: [],
                training_button: false,
                extract_url: [],
                skip_files: [],

                files: function (onSuccess, index = 0) {
                    let files = upload_input.prop('files');
                    if (index >= files.length) {
                        return onSuccess(true);
                    }
                    let file_name = files[index].name;
                    if (this.isFile(file_name) && !this.skip_files.includes(file_name)) {
                        admin.find('#sb-embeddings-box p').html(sb_('We are processing the source') + '<pre>' + file_name + '</pre><span>' + sb_('Only {R} sources left to complete.').replace('{R}', files.length - index) + '</span>');
                        upload_input.sbUploadFiles((response) => {
                            response = JSON.parse(response);
                            if (response[0] == 'success') {
                                SBF.ajax({ function: 'open-ai-file-training', url: response[1] }, (response) => {
                                    if (this.isError(response)) {
                                        return;
                                    }
                                    this.files(onSuccess, index + 1);
                                });
                            }
                        }, index);
                    } else {
                        this.files(onSuccess, index + 1);
                    }
                },

                website: function (onSuccess, index = 0) {
                    if (index >= this.urls.length) {
                        return onSuccess(true);
                    }
                    let url = this.urls[index];
                    if (url && url.includes('http')) {
                        admin.find('#sb-embeddings-box p').html(sb_('We are processing the source') + '<pre>' + url + '</pre><span>' + sb_('Only {R} sources left to complete.').replace('{R}', this.urls.length - index) + '</span>');
                        if (url.includes('.xml')) {
                            SBF.ajax({ function: 'get-sitemap-urls', sitemap_url: url }, (response) => {
                                if (Array.isArray(response)) {
                                    this.urls = this.urls.concat(response);
                                } else {
                                    this.errors.push(response);
                                }
                                this.website(onSuccess, index + 1);
                            });
                        } else if (!this.sitemap_processed_urls.includes(url) && this.extract_url[index]) {
                            this.sitemap_processed_urls.push(url);
                            this.sitemap(url, (response) => {
                                this.urls = this.urls.concat(response);
                                this.website(onSuccess, index + 1);
                            });
                        } else {
                            SBF.ajax({ function: 'open-ai-url-training', url: url }, (response) => {
                                if (this.isError(response)) {
                                    return;
                                } else if (!response[0] && !response[1].includes('http-error-404') && !response[1].includes('http-error-302')) {
                                    if (response[1].includes('http-error') && index === 0) {
                                        this.errors.push(response[2]);
                                    } else if (response[0][0] !== true) {
                                        this.errors.push(response);
                                    }
                                }
                                this.website(onSuccess, index + 1);
                            });
                        }
                    } else {
                        if (url) {
                            this.errors.push(sb_('Use a valid URL starting with http. The URL {R} is not valid.').replace('{R}', url));
                        }
                        this.website(onSuccess, index + 1);
                    }
                },

                sitemap: function (url, onSuccess, sitemap_urls = []) {
                    admin.find('#sb-embeddings-box p').html(sb_('We are generating the sitemap') + '<pre>' + url + '</pre>');
                    SBF.ajax({ function: 'generate-sitemap', url: url }, (response) => {
                        onSuccess(response);
                    });
                },

                qea: function (onSuccess) {
                    admin.find('#sb-embeddings-box p').html(sb_('We are processing the Q&A.'));
                    let questions_answers = SBSettings.repeater.get(chatbot_qea_repeater.find('.sb-repeater').eq(0).find('> .repeater-item')).map((item) => {
                        return [
                            item['open-ai-faq-questions'].map((item) => {
                                return item.question;
                            }),
                            item['open-ai-faq-answer'],
                            item['open-ai-faq-function-calling-url'],
                            item['open-ai-faq-function-calling-method'],
                            item['open-ai-faq-function-calling-headers'],
                            item['open-ai-faq-function-calling-properties'].length ? item['open-ai-faq-function-calling-properties'].map((item) => {
                                return [item.name, item.description, item.allowed];
                            }) : false,
                            item['open-ai-faq-set-data'].map((item) => {
                                return [item.id, item.value];
                            })
                        ];
                    });
                    SBF.ajax({
                        function: 'open-ai-qea-training',
                        questions_answers: questions_answers,
                        reset: true
                    }, (response) => {
                        onSuccess(response);
                    });
                },

                articles: function (onSuccess) {
                    admin.find('#sb-embeddings-box p').html(sb_('We are processing the articles.'));
                    SBF.ajax({ function: 'open-ai-articles-training' }, (response) => {
                        onSuccess(response);
                    });
                },

                isFile: function (url) {
                    return url.includes('.pdf') || url.includes('.txt') || url.includes('.json') || url.includes('.csv');
                },

                isError: function (response) {
                    let is_limit = response[1] == 'chars-limit-exceeded';
                    let is_error = is_limit || (response[1] && response[1][0] && response[1][0].error);
                    if (is_error) {
                        chatbot_area.find('#sb-train-chatbot').sbLoading(false);
                        infoPanel(is_limit ? sb_('The chatbot cannot be trained with these sources because the limit of your plan is {R} characters. Upgrade your plan to increase the number of characters.').replace('{R}', response[2]) : response[1][0].error.message);
                    }
                    return is_error;
                }
            },

            playground: {
                messages: [],
                last_response: false,

                addMessage: function (message, user_type = 'user', attachments = []) {
                    chatbot_playground_area.append(`<div data-type="${user_type}"><div>${sb_(user_type == 'user' ? 'User' : 'Assistant')}<div><i class="sb-icon-close sb-btn-icon sb-btn-red"></i></div></div><div>${(new SBMessage({ id: 1, message: SBF.escape(message), creation_time: '0000-00-00 00:00:00', status_code: 0, user_type: 'agent', attachments: JSON.stringify(attachments) })).getCode()}</div></div>`);
                    chatbot_playground_area[0].scrollTop = chatbot_playground_area[0].scrollHeight;
                    this.messages.push([user_type, message]);
                }
            },

            init: function () {
                SBF.ajax({
                    function: 'open-ai-get-training-files'
                }, (response) => {
                    let code = ['', ''];
                    for (var i = 0; i < response.length; i++) {
                        if (!['sb-conversations', 'sb-articles', 'sb-database', 'sb-flows'].includes(response[i])) {
                            let is_file = this.train.isFile(response[i]);
                            code[is_file ? 1 : 0] += `<tr data-url="${response[i]}"><td><input type="checkbox" /></td><td>${is_file ? SBF.beautifyAttachmentName(response[i].split('/').pop()) : urlStrip(response[i])}</td><td></td><td><i class="sb-icon-delete"></i></td></tr>`;
                        }
                    }
                    chatbot_files_table.html(code[1]).sbLoading(false);
                    chatbot_website_table.html(code[0]).sbLoading(false);
                    chatbot_area.find('#sb-chatbot-delete-website').setClass('sb-hide', !code[0]);
                });
                SBF.ajax({
                    function: 'open-ai-get-qea-training'
                }, (response) => {
                    for (var i = 0; i < response.length; i++) { // Deprecated
                        if (response[i][0] && !Array.isArray(response[i][0])) { // Deprecated
                            response[i][0] = [response[i][0]]; // Deprecated
                        } // Deprecated
                    } // Deprecated
                    let faq = response.map(item => ({
                        'open-ai-faq-questions': item[0] ? item[0].map(item => ({ question: item })) : [''],
                        'open-ai-faq-answer': item[1],
                        'open-ai-faq-function-calling-url': item[2],
                        'open-ai-faq-function-calling-method': item[3],
                        'open-ai-faq-function-calling-headers': item[4],
                        'open-ai-faq-function-calling-properties': item[5] && item[5].length ? item[5].map(item => ({ name: item[0], description: item[1], allowed: item[2] })) : [['', '', '']],
                        'open-ai-faq-set-data': item[6] && item[6].length ? item[6].map(item => ({ id: item[0], value: item[1] })) : [['', '']],
                    }));
                    if (faq.length) {
                        chatbot_qea_repeater.find('> div > .sb-repeater').html(SBSettings.repeater.set(faq, chatbot_qea_repeater.find('> div > .sb-repeater > .repeater-item:last-child')));
                        chatbot_qea_repeater.find('.sb-enlarger').each(function () {
                            let selects = $(this).find('select');
                            let no_value_keys = ['transcript', 'transcript_email', 'human_takeover', 'archive_conversation'];
                            if ($(this).find('input').val() || no_value_keys.includes(selects.val())) {
                                $(this).sbActive(true);
                                if ($(this).hasClass('sb-enlarger-function-calling')) {
                                    $(this).closest('.repeater-item').find('.sb-qea-repeater-answer').addClass('sb-hide');
                                }
                            }
                            selects.each(function () {
                                if (no_value_keys.includes($(this).val())) {
                                    $(this).parent().next().find('input').addClass('sb-hide');
                                }
                            });
                        });
                    }
                });
            }
        },

        messenger: {

            check: function (conversation) {
                return ['fb', 'ig'].includes(conversation.get('source'));
            },

            send: function (PSID, facebook_page_id, message = '', attachments = [], metadata, message_id = false, onSuccess = false) {
                SBF.ajax({
                    function: 'messenger-send-message',
                    psid: PSID,
                    facebook_page_id: facebook_page_id,
                    message: message,
                    message_id: message_id,
                    attachments: attachments,
                    metadata: metadata
                }, (response) => {
                    if (onSuccess) onSuccess(response);
                    SBApps.unsupportedRichMessages(message, 'Messenger');
                });
            }
        },

        whatsapp: {

            check: function (conversation) {
                return conversation.get('source') == 'wa';
            },

            send: function (to, message = '', attachments = [], phone_id = false, onSuccess = false) {
                SBF.ajax({
                    function: 'whatsapp-send-message',
                    to: to,
                    message: message,
                    attachments: attachments,
                    phone_id: phone_id
                }, (response) => {
                    if (response.error) {
                        infoPanel(response.error.message, 'info', false, 'error-wa');
                    }
                    if (onSuccess) {
                        onSuccess(response);
                    }
                    SBApps.unsupportedRichMessages(message, 'WhatsApp');
                });
            },

            activeUserPhone: function (user = activeUser()) {
                return user.getExtra('phone') ? user.getExtra('phone').value.replace('+', '') : false
            }
        },

        telegram: {

            check: function (conversation) {
                return conversation.get('source') == 'tg';
            },

            send: function (chat_id, message = '', attachments = [], conversation_id = false, onSuccess = false) {
                SBF.ajax({
                    function: 'telegram-send-message',
                    chat_id: chat_id,
                    message: message,
                    attachments: attachments,
                    conversation_id: conversation_id
                }, (response) => {
                    if (onSuccess) onSuccess(response);
                    SBApps.unsupportedRichMessages(message, 'Telegram');
                });
            }
        },

        viber: {

            check: function (conversation) {
                return conversation.get('source') == 'vb';
            },

            send: function (viber_id, message = '', attachments = [], onSuccess = false) {
                SBF.ajax({
                    function: 'viber-send-message',
                    viber_id: viber_id,
                    message: message,
                    attachments: attachments
                }, (response) => {
                    if (onSuccess) onSuccess(response);
                    SBApps.unsupportedRichMessages(message, 'Viber');
                });
            }
        },

        zalo: {

            check: function (conversation) {
                return conversation.get('source') == 'za';
            },

            send: function (zalo_id, message = '', attachments = [], onSuccess = false) {
                SBF.ajax({
                    function: 'zalo-send-message',
                    zalo_id: zalo_id,
                    message: message,
                    attachments: attachments
                }, (response) => {
                    if (onSuccess) onSuccess(response);
                    SBApps.unsupportedRichMessages(message, 'Zalo');
                });
            }
        },

        twitter: {

            check: function (conversation) {
                return conversation.get('source') == 'tw';
            },

            send: function (twitter_id, message = '', attachments = [], onSuccess = false) {
                SBF.ajax({
                    function: 'twitter-send-message',
                    twitter_id: twitter_id,
                    message: message,
                    attachments: attachments
                }, (response) => {
                    if (onSuccess) onSuccess(response);
                    SBApps.unsupportedRichMessages(message, 'Twitter');
                });
            }
        },

        line: {
            check: function (conversation) {
                return conversation.get('source') == 'ln';
            },

            send: function (line_id, message = '', attachments = [], conversation_id = false, onSuccess = false) {
                SBF.ajax({
                    function: 'line-send-message',
                    line_id: line_id,
                    message: message,
                    attachments: attachments,
                    conversation_id: conversation_id
                }, (response) => {
                    if (onSuccess) onSuccess(response);
                    SBApps.unsupportedRichMessages(message, 'LINE');
                });
            }
        },

        wechat: {
            token: false,

            check: function (conversation) {
                return conversation.get('source') == 'wc';
            },

            send: function (open_id, message = '', attachments = [], onSuccess = false) {
                SBF.ajax({
                    function: 'wechat-send-message',
                    open_id: open_id,
                    message: message,
                    attachments: attachments,
                    token: this.token
                }, (response) => {
                    if (Array.isArray(response)) {
                        this.token = response[1];
                        response = response[0];
                    }
                    if (onSuccess) onSuccess(response);
                    SBApps.unsupportedRichMessages(message, 'WeChat');
                });
            }
        },

        aecommerce: {

            conversationPanel: function () {
                let code = '';
                let aecommerce_id = activeUser().getExtra('aecommerce-id');
                if (!this.panel) this.panel = conversations_area.find('.sb-panel-aecommerce');
                if (aecommerce_id && !loading(this.panel)) {
                    SBF.ajax({
                        function: 'aecommerce-get-conversation-details',
                        aecommerce_id: aecommerce_id.value
                    }, (response) => {
                        code = `<h3>${SB_ADMIN_SETTINGS.aecommerce_panel_title}</h3><div><div class="sb-split"><div><div class="sb-title">${sb_('Number of orders')}</div><span>${response.orders_count} ${sb_('orders')}</span></div><div><div class="sb-title">${sb_('Total spend')}</div><span>${response.total} ${response.currency_symbol}</span></div></div><div class="sb-title">${sb_('Cart')}</div><div class="sb-list-items sb-list-links sb-aecommerce-cart">`;
                        for (var i = 0; i < response.cart.length; i++) {
                            let product = response.cart[i];
                            code += `<a href="${product.url}" target="_blank" data-id="${product.id}"><span>#${product.id}</span> <span>${product.name}</span> <span>x ${product.quantity}</span></a>`;
                        }
                        code += (response.cart.length ? '' : '<p>' + sb_('The cart is currently empty.') + '</p>') + '</div>';
                        if (response.orders.length) {
                            code += `<div class="sb-title">${sb_('Orders')}</div><div class="sb-list-items sb-list-links sb-aecommerce-orders">`;
                            for (var i = 0; i < response.orders.length; i++) {
                                let order = response.orders[i];
                                let id = order.id;
                                code += `<a data-id="${id}" href="${order.url}" target="_blank"><span>#${order.id}</span> <span>${SBF.beautifyTime(order.time, true)}</span> <span>${order.price} ${response.currency_symbol}</span></a>`;
                            }
                            code += '</div>';
                        }
                        $(this.panel).html(code).sbLoading(false);
                        collapse(this.panel, 160);
                    });
                }
                $(this.panel).html(code);
            }
        },

        martfury: {

            conversationPanel: function () {
                let code = '';
                let martfury_id = activeUser().getExtra('martfury-id');
                if (!this.panel) this.panel = conversations_area.find('.sb-panel-martfury');
                if (martfury_id && !loading(this.panel)) {
                    SBF.ajax({
                        function: 'martfury-get-conversation-details',
                        martfury_id: martfury_id.value
                    }, (response) => {
                        $(this.panel).html(response).sbLoading(false);
                        collapse(this.panel, 160);
                    });
                }
                $(this.panel).html(code);
            }
        },

        whmcs: {

            conversationPanel: function () {
                let code = '';
                let whmcs_id = activeUser().getExtra('whmcs-id');
                if (!this.panel) this.panel = conversations_area.find('.sb-panel-whmcs');
                if (whmcs_id && !loading(this.panel)) {
                    SBF.ajax({
                        function: 'whmcs-get-conversation-details',
                        whmcs_id: whmcs_id.value
                    }, (response) => {
                        let services = ['products', 'addons', 'domains'];
                        code = `<h3>WHMCS</h3><div><div class="sb-split"><div><div class="sb-title">${sb_('Number of services')}</div><span>${response.services_count} ${sb_('services')}</span></div><div><div class="sb-title">${sb_('Total spend')}</div><span>${response.total} ${response.currency_symbol}</span></div></div></div>`;
                        for (var i = 0; i < services.length; i++) {
                            let items = response[services[i]];
                            if (items.length) {
                                code += `<div class="sb-title">${sb_(SBF.slugToString(services[i]))}</div><div class="sb-list-items">`;
                                for (var j = 0; j < items.length; j++) {
                                    code += `<div>${items[j].name}</div>`;
                                }
                                code += '</div>';
                            }
                        }
                        code += `<a href="${SB_ADMIN_SETTINGS.whmcs_url}/clientssummary.php?userid=${response['client-id']}" target="_blank" class="sb-btn sb-whmcs-link">${sb_('View on WHMCS')}</a>`;
                        $(this.panel).html(code).sbLoading(false);
                        collapse(this.panel, 160);
                    });
                }
                $(this.panel).html(code);
            }
        },

        perfex: {

            conversationPanel: function () {
                let perfex_id = activeUser().getExtra('perfex-id');
                conversations_area.find('.sb-panel-perfex').html(perfex_id ? `<a href="${SB_ADMIN_SETTINGS.perfex_url}/admin/clients/client/${perfex_id.value}" target="_blank" class="sb-btn sb-perfex-link">${sb_('View on Perfex')}</a>` : '');
            }
        },

        ump: {

            conversationPanel: function () {
                if (loading(this.panel)) return;
                if (!this.panel) this.panel = conversations_area.find('.sb-panel-ump');
                let code = '';
                let subscriptions;
                SBF.ajax({
                    function: 'ump-get-conversation-details'
                }, (response) => {
                    subscriptions = response.subscriptions;
                    if (subscriptions.length) {
                        code = '<i class="sb-icon-refresh"></i><h3>Membership</h3><div class="sb-list-names">';
                        for (var i = 0; i < subscriptions.length; i++) {
                            let expired = subscriptions[i].expired;
                            code += `<div${expired ? ' class="sb-expired"' : ''}><span>${subscriptions[i].label}</span><span>${sb_(expired ? 'Expired on' : 'Expires on')} ${SBF.beautifyTime(subscriptions[i].expire_time, false, !expired)}</span></div>`;
                        }
                        code += `</div><span class="sb-title">${sb_('Total spend')} ${response.total} ${response.currency_symbol}</span>`;
                    }
                    $(this.panel).html(code).sbLoading(false);
                    collapse(this.panel, 160);
                });
            }
        },

        armember: {

            conversationPanel: function () {
                let wp_user_id = activeUser().getExtra('wp-id');
                if (!this.panel) this.panel = conversations_area.find('.sb-panel-armember');
                if (!SBF.null(wp_user_id) && !loading(this.panel)) {
                    let code = '';
                    let subscriptions;
                    wp_user_id = wp_user_id.value;
                    SBF.ajax({
                        function: 'armember-get-conversation-details',
                        wp_user_id: wp_user_id
                    }, (response) => {
                        subscriptions = response.subscriptions;
                        if (subscriptions.length) {
                            code = `<i class="sb-icon-refresh"></i><h3>${sb_('Plans')}</h3><div class="sb-list-names">`;
                            for (var i = 0; i < subscriptions.length; i++) {
                                let expired = subscriptions[i].expired;
                                code += `<div${expired ? ' class="sb-expired"' : ''}><span>${subscriptions[i].arm_current_plan_detail.arm_subscription_plan_name}</span><span>${subscriptions[i].expire_time == 'never' ? '' : (sb_(expired ? 'Expired on' : 'Expires on') + ' ' + SBF.beautifyTime(subscriptions[i].expire_time, false, !expired))}</span></div>`;
                            }
                            code += `</div><span class="sb-title">${sb_('Total spend')} ${response.total} ${response.currency_symbol}<a href="${window.location.href.substr(0, window.location.href.lastIndexOf('/')) + '?page=arm_manage_members&member_id=' + activeUser().getExtra('wp-id').value}" target="_blank" class="sb-btn-text"><i class="sb-icon-user"></i> ${sb_('View member')}</a></span>`;
                        }
                        $(this.panel).html(code).sbLoading(false);
                        collapse(this.panel, 160);
                    });
                } else $(this.panel).html('');
            }
        },

        zendesk: {

            conversationPanel: function () {
                if (!SB_ADMIN_SETTINGS.zendesk_active) return;
                let zendesk_id = activeUser().getExtra('zendesk-id');
                let phone = activeUser().getExtra('phone');
                let email = activeUser().get('email');
                let panel = conversations_area.find('.sb-panel-zendesk');
                if ((zendesk_id || phone || email) && !loading(panel)) {
                    SBF.ajax({
                        function: 'zendesk-get-conversation-details',
                        conversation_id: SBChat.conversation.id,
                        zendesk_id: zendesk_id ? zendesk_id.value : false,
                        phone: phone ? phone.value : false,
                        email: email,
                    }, (response) => {
                        $(panel).html(response).sbLoading(false);
                        panel.find('.sb-zendesk-date').each(function () {
                            $(this).html(SBF.beautifyTime($(this).html()));
                        });
                        collapse(panel, 160);
                    });
                } else $(panel).html('');
            }
        },

        woocommerce: {
            timeout: false,

            conversationPanel: function () {
                if (loading(this.panel)) {
                    return;
                }
                if (!this.panel) {
                    this.panel = conversations_area.find('.sb-panel-woocommerce');
                }
                let code = '';
                SBF.ajax({
                    function: 'woocommerce-get-conversation-details'
                }, (response) => {
                    code = `<i class="sb-icon-refresh"></i><h3>WooCommerce</h3><div><div class="sb-split"><div><div class="sb-title">${sb_('Number of orders')}</div><span>${response.orders_count} ${sb_('orders')}</span></div><div><div class="sb-title">${sb_('Total spend')}</div><span>${response.total} ${response.currency_symbol}</span></div></div><div class="sb-title">${sb_('Cart')}<i class="sb-add-cart-btn sb-icon-plus"></i></div><div class="sb-list-items sb-list-links sb-woocommerce-cart">`;
                    for (var i = 0; i < response.cart.length; i++) {
                        let product = response.cart[i];
                        code += `<a href="${product.url}" target="_blank" data-id="${product.id}"><span>#${product.id}</span> <span>${product.name}</span> <span>x ${product.quantity}</span><i class="sb-icon-close"></i></a>`;
                    }
                    code += (response.cart.length ? '' : '<p>' + sb_('The cart is currently empty.') + '</p>') + '</div>';
                    if (response.orders.length) {
                        code += `<div class="sb-title">${sb_('Orders')}</div><div class="sb-list-items sb-woocommerce-orders sb-accordion">`;
                        for (var i = 0; i < response.orders.length; i++) {
                            let order = response.orders[i];
                            let id = order.id;
                            code += `<div data-id="${id}"><span><span>#${id}</span> <span>${SBF.beautifyTime(order.date, true)}</span><a href="${SITE_URL}/wp-admin/post.php?post=${id}&action=edit" target="_blank" class="sb-icon-next"></a></span><div></div></div>`;
                        }
                        code += '</div>';
                    }
                    $(this.panel).html(code).sbLoading(false);
                    collapse(this.panel, 160);
                });
            },

            conversationPanelOrder: function (order_id) {
                let accordion = this.panel.find(`[data-id="${order_id}"] > div`);
                accordion.html('');
                SBF.ajax({
                    function: 'woocommerce-get-order',
                    order_id: order_id
                }, (response) => {
                    let code = '';
                    let collapse = this.panel.find('.sb-collapse-btn:not(.sb-active)');
                    if (response) {
                        let products = response.products;
                        code += `<div class="sb-title">${sb_('Order total')}: <span>${response.total} ${response.currency_symbol}<span></div><div class="sb-title">${sb_('Order status')}: <span>${SBF.slugToString(response.status.replace('wc-', ''))}<span></div><div class="sb-title">${sb_('Date')}: <span>${SBF.beautifyTime(response.date, true)}<span></div><div class="sb-title">${sb_('Products')}</div>`;
                        for (var i = 0; i < products.length; i++) {
                            code += `<a href="${SITE_URL}?p=${products[i].id}" target="_blank"><span>#${products[i].id}</span> <span>${products[i].quantity} x</span> <span>${products[i].name}</span></a>`;
                        }
                        for (var i = 0; i < 2; i++) {
                            let key = i == 0 ? 'shipping' : 'billing';
                            if (response[key + '_address']) {
                                code += `<div class="sb-title">${sb_((i == 0 ? 'Shipping' : 'Billing') + ' address')}</div><div class="sb-multiline">${response[key + '_address'].replace(/\\n/g, '<br>')}</div>`;
                            }
                        }
                    }
                    if (collapse.length) {
                        collapse.click();
                    }
                    accordion.html(code);
                });
            },

            conversationPanelUpdate: function (product_id, action = 'added') {
                let busy = false;
                let count = 0;
                this.timeout = setInterval(() => {
                    if (!busy) {
                        SBF.ajax({
                            function: 'woocommerce-get-conversation-details'
                        }, (response) => {
                            let removed = true;
                            for (var i = 0; i < response.cart.length; i++) {
                                if (response.cart[i].id == product_id) {
                                    if (action == 'added') {
                                        count = 61;
                                    } else {
                                        removed = false;
                                    }
                                }
                            }
                            if (count > 60 || removed) {
                                this.conversationPanel();
                                conversations_area.find('.sb-add-cart-btn,.sb-woocommerce-cart > a i').sbLoading(false);
                                clearInterval(this.timeout);
                            }
                            count++;
                            busy = false;
                        });
                        busy = true;
                    }
                }, 1000);
            }
        },

        opencart: {

            conversationPanel: function () {
                let panel = conversations_area.find('.sb-panel-opencart');
                let opencart_id = activeUser().getExtra('opencart_id');
                let store_url = activeUser().getExtra('opencart_store_url');
                if (!opencart_id) {
                    return panel.html('');
                }
                if (loading(panel)) {
                    return;
                }
                SBF.ajax({
                    function: 'opencart-panel',
                    opencart_id: opencart_id.value,
                    store_url: store_url ? store_url.value : false,
                }, (response) => {
                    panel.html(response).sbLoading(false);
                    collapse(this.panel, 160);
                });
            },

            openOrder: function (order_id) {
                SBF.ajax({
                    function: 'opencart-order-details',
                    order_id: order_id
                }, (response) => {
                    SBAdmin.infoPanel(response, 'info', false, 'opencart-order-details', sb_('Order') + ' #' + order_id, true);
                });
            }
        },

        wordpress: {
            ajax: function (action, data, onSuccess) {
                $.ajax({
                    method: 'POST',
                    url: SB_WP_AJAX_URL,
                    data: $.extend({ action: 'sb_wp_ajax', type: action }, data)
                }).done((response) => {
                    if (onSuccess !== false) {
                        onSuccess(response);
                    }
                });
            }
        },

        is: function (name) {
            if (typeof SB_VERSIONS == ND) {
                return false;
            }
            switch (name) {
                case 'opencart':
                case 'zendesk':
                case 'twitter':
                case 'wechat':
                case 'line':
                case 'viber':
                case 'zalo':
                case 'telegram':
                case 'armember':
                case 'aecommerce':
                case 'martfury':
                case 'whmcs':
                case 'perfex':
                case 'ump':
                case 'messenger':
                case 'whatsapp':
                case 'woocommerce':
                case 'dialogflow':
                case 'slack':
                case 'tickets': return typeof SB_VERSIONS[name] != ND && SB_VERSIONS[name];
                case 'wordpress': return typeof SB_WP != ND;
                case 'sb': return true;
            }
            return false;
        },

        unsupportedRichMessages: function (message, app_name, unsupported = []) {
            unsupported.push('timetable', 'registration', 'table', 'inputs');
            if (!['Messenger', 'WhatsApp'].includes(app_name)) {
                unsupported.push('email');
            }
            for (var i = 0; i < unsupported.length; i++) {
                if (message.includes('[' + unsupported[i])) {
                    infoBottom('The {R} rich message is not supported by {R2}. The rich message was not sent to {R2}.'.replace(/{R}/g, SBF.slugToString(unsupported[i])).replace(/{R2}/g, app_name), 'error');
                }
            }
        },

        getName: function (source) {
            let names = { fb: 'Facebook', wa: 'WhatsApp', tm: 'Text message', ig: 'Instagram', tg: 'Telegram', tk: 'Tickets', wc: 'WeChat', em: 'Email', tw: 'Twitter', bm: 'Business Messages', vb: 'Viber', ln: 'LINE', za: 'Zalo' };
            return source in names ? names[source] : source;
        },

        itemsPanel: {

            pagination_reference: 1,
            panel_language: '',

            code: function (items, app_name, label = true) {
                let code = '';
                for (var i = 0; i < items.length; i++) {
                    code += `<li data-id="${items[i].id.split('/').pop()}"><div class="sb-image" style="background-image:url('${items[i].image ? (app_name == 'shopify' ? items[i].image.replace('.jpg', '_small.jpg') : items[i].image) : SB_URL + '/media/thumb.svg'}')"></div><div><span>${items[i].name ? items[i].name : items[i].title}</span><span>${items[i].price ? items[i].price : items[i].variants.edges[0].node.price} ${SB_ADMIN_SETTINGS.currency}</span></div></li>`;
                }
                return label ? (code ? code : `<p class="sb-no-results">${sb_('No products found')}</p>`) : code;
            },

            getAppInfo: function (app_name) {
                switch (app_name) {
                    case 'woocommerce':
                        return { area: woocommerce_products_box, ul: woocommerce_products_box_ul, search: 'woocommerce-search-products', filter: 'woocommerce-get-products', populate: 'woocommerce-products-popup', pagination: 'woocommerce-get-products' };
                    case 'shopify':
                        return { area: SBCloud.shopify_products_box, ul: SBCloud.shopify_products_box_ul, search: 'shopify-get-products', filter: 'shopify-get-products', populate: 'shopify-get-products', pagination: 'shopify-get-products' };
                }
            },

            search: function (input, app_name) {
                let app_info = this.getAppInfo(app_name);
                searchInput(input, (search, icon) => {
                    if (search) {
                        this.pagination_reference = 1;
                        SBF.ajax({
                            function: app_info.search,
                            search: search
                        }, (response) => {
                            if (app_name == 'shopify') {
                                this.pagination_reference = response[1];
                                response = response[0];
                            }
                            this.getAppInfo(app_name).ul.html(this.code(response, app_name));
                            $(icon).sbLoading(false);
                        });
                    } else {
                        this.populate(app_name, function () {
                            $(icon).sbLoading(false);
                        });
                    }
                });
            },

            filter: function (item, app_name) {
                let app_info = this.getAppInfo(app_name);
                let value = $(item).data('value');
                if (loading(app_info.ul)) return;
                app_info.ul.html('');
                this.pagination_reference = 1;
                SBF.ajax({
                    function: app_info.filter,
                    user_language: this.panel_language,
                    filters: { taxonomy: value },
                    collection: value
                }, (response) => {
                    if (app_name == 'shopify') {
                        this.pagination_reference = response[1];
                        response = response[0];
                    }
                    app_info.ul.html(this.code(response, app_name)).sbLoading(false);
                });
            },

            populate: function (app_name, onSuccess = false) {
                let app_info = this.getAppInfo(app_name);
                this.panel_language = activeUser() && SB_ADMIN_SETTINGS.languages && SB_ADMIN_SETTINGS.languages.includes(activeUser().language) ? activeUser().language : '';
                this.pagination_reference = 1;
                app_info.ul.html('').sbLoading(true);
                SBF.ajax({
                    function: app_info.populate,
                    user_language: this.panel_language
                }, (response) => {
                    let code = '';
                    let select = app_info.area.find('.sb-select');
                    for (var i = 0; i < response[1].length; i++) {
                        code += `<li data-value="${response[1][i].id}">${response[1][i].name}</li>`;
                    }
                    if (response[2]) {
                        this.pagination_reference = response[2];
                    }
                    if (response[3]) {
                        SB_ADMIN_SETTINGS.currency = response[3];
                    }
                    select.find('> p').html(sb_('All'));
                    select.find('ul').html(`<li data-value="" class="sb-active">${sb_('All')}</li>` + code);
                    app_info.ul.html(this.code(response[0], app_name)).sbLoading(false);
                    if (onSuccess !== false) {
                        onSuccess();
                    }
                });
            },

            pagination: function (area, app_name) {
                let app_info = this.getAppInfo(app_name);
                let filter = $(area).parent().find('.sb-select p').attr('data-value');
                if (!this.pagination_reference) return;
                app_info.ul.sbLoading(area);
                SBF.ajax({
                    function: app_info.pagination,
                    filters: { taxonomy: filter },
                    collection: filter,
                    pagination: this.pagination_reference,
                    user_language: this.panel_language
                }, (response) => {
                    if (app_name == 'shopify') {
                        this.pagination_reference = response[1];
                        response = response[0];
                    } else {
                        this.pagination_reference++;
                    }
                    app_info.ul.append(this.code(response, app_name, false)).sbLoading(false);
                    if (!response.length) {
                        this.pagination_reference = 0;
                    }
                });
            }
        }
    }

    /*
    * ----------------------------------------------------------
    * Settings
    * ----------------------------------------------------------
    */

    var SBSettings = {
        init: false,

        save: function (btn = false) {
            if (btn && loading(btn)) return;
            let external_settings = {};
            let settings = {};
            let tab = settings_area.find(' > .sb-tab > .sb-nav .sb-active').attr('id');
            switch (tab) {
                case 'tab-automations':
                    let active = automations_area_nav.find('.sb-active').attr('data-id');
                    SBSettings.automations.save((response) => {
                        infoBottom(response === true ? 'Automations saved' : response);
                        SBSettings.automations.populate();
                        automations_area_nav.find(`[data-id="${active}"]`).click();
                        if (btn) {
                            $(btn).sbLoading(false);
                        }
                    });
                    break;
                case 'tab-translations':
                    this.translations.updateActive();
                    SBF.ajax({
                        function: 'save-translations',
                        translations: JSON.stringify(this.translations.to_update)
                    }, () => {
                        infoBottom('Translations saved');
                        if (btn) {
                            $(btn).sbLoading(false);
                        }
                    });
                    break;
                default:
                    settings_area.find('.sb-setting').each((i, element) => {
                        let setting = this.get(element);
                        let setting_id = $(element).data('setting');
                        if (setting[0]) {
                            if (typeof setting_id != ND) {
                                let originals = false;
                                if ($(element).find('[data-language]').length) {
                                    let language = $(element).find('[data-language].sb-active');
                                    originals = setting[0] in this.translations.originals ? this.translations.originals[setting[0]] : false;
                                    this.translations.save(element, language.length ? language.attr('data-language') : false);
                                    if (originals) {
                                        if (typeof originals != 'string') {
                                            for (var key in originals) {
                                                originals[key] = [originals[key], setting[1][key][1]]
                                            }
                                        }
                                    }
                                }
                                if (!(setting_id in external_settings)) external_settings[setting_id] = {};
                                external_settings[setting_id][setting[0]] = [originals ? originals : setting[1], setting[2]];
                            } else {
                                settings[setting[0]] = [setting[1], setting[2]];
                            }
                        }
                    });
                    SBF.ajax({
                        function: 'save-settings',
                        settings: JSON.stringify(settings),
                        external_settings: external_settings,
                        external_settings_translations: this.translations.translations
                    }, () => {
                        if (btn) {
                            infoBottom('Settings saved. Reload to apply the changes.');
                            $(btn).sbLoading(false);
                            setTimeout(function () {
                                window.location.reload();
                            }, 1000);


                        }
                        SBF.event('SBSettingsSaved', { settings: settings, external_settings: external_settings, external_settings_translations: this.translations.translations });
                    });
                    break;
            }
        },

        get: function (item) {
            item = $(item);
            let id = item.attr('id');
            let type = item.data('type');
            switch (type) {
                case 'upload':
                case 'range':
                case 'number':
                case 'text':
                case 'password':
                case 'color':
                case 'upload-file':
                    return [id, item.find('input').val(), type];
                case 'textarea':
                    return [id, item.find('textarea').val(), type];
                case 'select':
                    return [id, item.find('select').val(), type];
                case 'checkbox':
                    return [id, item.find('input').is(':checked'), type];
                case 'radio':
                    let value = item.find('input:checked').val();
                    if (SBF.null(value)) {
                        value = '';
                    }
                    return [id, value, type];
                case 'upload-image':
                    let url = item.find('.image').attr('data-value');
                    if (SBF.null(url)) {
                        url = '';
                    }
                    return [id, url, type];
                case 'multi-input':
                    let multi_inputs = {};
                    item.find('.input > div').each((i, element) => {
                        let setting = this.get(element);
                        if (setting[0]) {
                            multi_inputs[setting[0]] = [setting[1], setting[2]];
                        }
                    });
                    return [id, multi_inputs, type];
                case 'select-images':
                    return [id, item.find('.input > .sb-active').data('value'), type];
                case 'repeater':
                    return [id, this.repeater.get(item.find('.repeater-item')), type];
                case 'double-select':
                    let selects = {};
                    item.find('.input > div').each(function () {
                        let value = $(this).find('select').val();
                        if (value != -1) {
                            selects[$(this).attr('data-id')] = [value];
                        }
                    });
                    return [id, selects, type];
                case 'select-checkbox':
                    return [id, item.find('.sb-select-checkbox input:checked').map(function () { return $(this).attr('id') }).get(), type];
                case 'timetable':
                    let times = {};
                    item.find('.sb-timetable > [data-day]').each(function () {
                        let day = $(this).attr('data-day');
                        let hours = [];
                        $(this).find('> div > div').each(function () {
                            let name = $(this).html()
                            let value = $(this).attr('data-value');
                            if (SBF.null(value)) {
                                hours.push(['', '']);
                            } else if (value == 'closed') {
                                hours.push(['closed', 'Closed']);
                            } else {
                                hours.push([value, name]);
                            }
                        });
                        times[day] = hours;
                    });
                    return [id, times, type];
                case 'color-palette':
                    return [id, item.attr('data-value'), type];
            }
            return ['', '', ''];
        },

        set: function (id, setting) {
            let type = $(setting)[1];
            let value = $(setting)[0];
            id = `#${id}`;
            switch (type) {
                case 'color':
                case 'upload':
                case 'number':
                case 'text':
                case 'password':
                case 'upload-file':
                    settings_area.find(`${id} input`).val(value);
                    break;
                case 'textarea':
                    settings_area.find(`${id} textarea`).val(value);
                    break;
                case 'select':
                    settings_area.find(`${id} select`).val(value);
                    break;
                case 'checkbox':
                    settings_area.find(`${id} input`).prop('checked', value == 'false' ? false : value);
                    break;
                case 'radio':
                    settings_area.find(`${id} input[value="${value}"]`).prop('checked', true);
                    break;
                case 'upload-image':
                    if (value) {
                        settings_area.find(id + ' .image').attr('data-value', value).css('background-image', `url("${value}")`);
                    }
                    break;
                case 'multi-input':
                    for (var key in value) {
                        this.set(key, value[key]);
                    }
                    break;
                case 'range':
                    let range_value = value;
                    settings_area.find(id + ' input').val(range_value);
                    settings_area.find(id + ' .range-value').html(range_value);
                    break;
                case 'select-images':
                    settings_area.find(id + ' .input > div').sbActive(false);
                    settings_area.find(id + ` .input > [data-value="${value}"]`).sbActive(true);
                    break;
                case 'select-checkbox':
                    for (var i = 0; i < value.length; i++) {
                        settings_area.find(`input[id="${value[i]}"]`).prop('checked', true);
                    }
                    settings_area.find(id + ' .sb-select-checkbox-input').val(value.join(', '));
                    break;
                case 'repeater':
                    let content = this.repeater.set(value, settings_area.find(id + ' .repeater-item:last-child'));
                    if (content) {
                        settings_area.find(id + ' .sb-repeater').html(content);
                    }
                    break;
                case 'double-select':
                    for (var key in value) {
                        settings_area.find(`${id} .input > [data-id="${key}"] select`).val(value[key]);
                    }
                    break;
                case 'timetable':
                    for (var key in value) {
                        let hours = settings_area.find(`${id} [data-day="${key}"] > div > div`);
                        for (var i = 0; i < hours.length; i++) {
                            $(hours[i]).attr('data-value', value[key][i][0]).html(value[key][i][1]);
                        }
                    }
                    break;
                case 'color-palette':
                    if (value) {
                        settings_area.find(id).attr('data-value', value);
                    }
                    break;
            }
        },

        repeater: {
            set: function (values, repeater_item_content) {
                var html = '';
                this.clear($(repeater_item_content));
                repeater_item_content = $(repeater_item_content).html();
                if (values.length) {
                    $(repeater_item_content).find('> .sb-icon-close').remove();
                    for (var i = 0; i < values.length; i++) {
                        let item = $($.parseHTML(`<div>${repeater_item_content}</div>`));
                        for (var key in values[i]) {
                            SBSettings.input.set(item.find(`[data-id="${key}"]`), values[i][key]);
                        }
                        html += `<div class="repeater-item">${item.html().replaceAll('<i class="sb-icon-close"></i>', '')}<i class="sb-icon-close"></i></div>`;
                    }
                }
                return html;
            },

            get: function (items) {
                let items_array = [];
                $(items).each(function () {
                    let item = {};
                    let empty = true;
                    $(this).find('[data-id]').removeClass('sb-exclude');
                    $(this).find('.sb-repeater [data-id]').addClass('sb-exclude');
                    $(this).find('[data-id]:not(.sb-exclude)').each(function () {
                        let value = SBSettings.input.get(this);
                        if (empty && value && $(this).attr('type') != 'hidden' && $(this).attr('data-type') != 'auto-id') {
                            empty = false;
                        }
                        item[$(this).attr('data-id')] = value;
                    });
                    if (!empty) {
                        items_array.push(item);
                    }
                });
                return items_array;
            },

            add: function (item) {
                let parent = $(item).parent();
                item = $($.parseHTML(`<div>${parent.find('> .sb-repeater > .repeater-item:last-child').html()}</div>`));
                this.clear(item);
                item.find('.repeater-item:not(:first-child)').remove();
                item.find('[data-id]').each(function () {
                    SBSettings.input.reset(this);
                    if ($(this).data('type') == 'auto-id') {
                        let larger = 1;
                        parent.find('[data-type="auto-id"]').each(function () {
                            let index = parseInt($(this).val());
                            if (index > larger) {
                                larger = index;
                            }
                        });
                        $(this).attr('value', larger + 1);
                    }
                });
                parent.find('> .sb-repeater').append(`<div class="repeater-item">${item.html()}</div>`);
            },

            delete: function (item) {
                let parent = $(item).parent();
                let cnt = parent.parent();
                if (cnt.parent().find('.sb-repeater-upload').length) {
                    SBF.ajax({ function: 'delete-file', path: parent.find('input').val() });
                }
                if (cnt.find('> .repeater-item').length > 1) {
                    parent.remove();
                } else {
                    parent.find('[data-id]:not([data-type="auto-id"]').each((e, element) => {
                        SBSettings.input.reset(element);
                    });
                }
            },

            clear: function (item) {
                item.find('.sb-active').sbActive(false);
                item.find('input:not([data-type="auto-id"]').removeAttr('value checked');
                item.find('option').removeAttr('selected');
                item.find('.sb-hide').removeClass('sb-hide');
            }
        },

        input: {
            set: function (input, value) {
                input = $(input);
                if (typeof value != 'object') {
                    value = $.trim(value);
                }
                if (input.is('select')) {
                    input.find(`option[value="${value}"]`).attr('selected', '');
                } else if (input.is(':checkbox') && value && value != 'false') {
                    input.attr('checked', '');
                } else if (input.is('textarea')) {
                    input.html(value);
                } else {
                    let div = input.is('div');
                    if (input.hasClass('sb-repeater')) {
                        input.html(SBSettings.repeater.set(value, '<div>' + input.find('> .repeater-item').eq(0).html() + '</div>').replaceAll('sb-icon-close', 'sb-icon-close sb-sub-repeater-close'));
                    } else if (div || input.is('i') || input.is('li')) {
                        input.attr('data-value', value);
                        if (div && input.hasClass('image')) {
                            input.css('background-image', value ? `url("${value}")` : '');
                        }
                    } else {
                        input.attr('value', value);
                    }
                }
            },

            get: function (input) {
                input = $(input);
                if (input.is(':checkbox')) {
                    return input.is(':checked');
                } else if (input.hasClass('sb-repeater')) {
                    return SBSettings.repeater.get(input.find('> .repeater-item'));
                } else if (input.is('div') || input.is('i') || input.is('li')) {
                    let value = input.attr('data-value');
                    return value ? value : '';
                } else {
                    return input.val();
                }
                return '';
            },

            reset: function (input) {
                input = $(input);
                if (input.is('select')) {
                    input.val('').find('[selected]').removeAttr('selected');
                } else if (input.is(':checkbox')) {
                    input.removeAttr('checked').prop('checked', false);
                } else if (input.is('textarea')) {
                    input.val('');
                    input.html('');
                } else if (input.hasClass('sb-repeater')) {
                    input.find('.repeater-item:not(:first-child)').remove();
                } else {
                    input.removeAttr('value style data-value').val('');
                }
            }
        },

        initColorPicker: function (area = false) {
            $(area ? area : settings_area).find('.sb-type-color input').colorPicker({
                renderCallback: function (t, toggled) {
                    $(t.context).closest('.input').find('input').css('background-color', t.text);
                }
            });
        },

        getSettingObject: function (setting) {
            return $(setting)[0].hasAttribute('data-setting') ? $(setting) : $(setting).closest('[data-setting]');
        },

        visibility: function (index, visible) {
            let selectors = [['#push-notifications-onesignal-sw-url, #push-notifications-onesignal-app-id, #push-notifications-onesignal-api-key, #push-notifications-sw-path', '#push-notifications-id, #push-notifications-key'], ['#messenger-key, #messenger-path-btn', '#messenger-sync-btn'], ['#open-ai-assistant-id', '#open-ai-prompt,#open-ai-model, #open-ai-tokens, #open-ai-temperature, #open-ai-presence-penalty, #open-ai-frequency-penalty, #open-ai-logit-bias, #open-ai-custom-model, #open-ai-source-links']];
            settings_area.find(selectors[index][0]).sbActive(!visible);
            settings_area.find(selectors[index][1]).setClass('sb-hide', !visible);
        },

        open: function (id, scroll = false) {
            header.find('.sb-admin-nav #sb-settings').click();
            if (scroll) {
                setTimeout(() => {
                    settings_area.find('#tab-' + id).click().get(0).scrollIntoView();
                }, 300);
            }
        },

        automations: {
            items: { messages: [], emails: [], sms: [], popups: [], design: [], more: [] },
            translations: {},

            conditions: function () {
                let list = {
                    datetime: ['Date time', ['Is between', 'Is exactly'], 'dd/mm/yyy hh:mm - dd/mm/yyy hh:mm'],
                    repeat: ['Repeat', ['Every day', 'Every week', 'Every month', 'Every year']],
                    browsing_time: ['Browsing time', [], 'seconds'],
                    scroll_position: ['Scroll position', [], 'px'],
                    url: ['Current URL', ['Contains', 'Does not contain'], 'URLs parts separated by commas'],
                    referring: ['Referring URL', ['Contains', 'Does not contain'], 'URLs parts separated by commas'],
                    user_type: ['User type', ['Is visitor', 'Is lead', 'Is user', 'Is not visitor', 'Is not lead', 'Is not user']],
                    returning_visitor: ['Returning visitor', ['First time visitor', 'Returning visitor']],
                    countries: ['Country', ['Is included', 'Is not included', 'Is set', 'Is not set'], 'Country codes separated by commas'],
                    languages: ['Language', ['Is included', 'Is not included', 'Is set', 'Is not set'], 'Language codes separated by commas'],
                    cities: ['City', ['Is included', 'Is not included', 'Is set', 'Is not set'], 'Cities separated by commas'],
                    website: ['Website', ['Contains', 'Does not contain', 'Is set', 'Is not set'], 'URLs parts separated by commas'],
                    birthdate: ['Birthdate', ['Is between', 'Is exactly', 'Is set', 'Is not set'], 'dd/mm - dd/mm'],
                    company: ['Company', ['Is included', 'Is not included', 'Is set', 'Is not set'], 'Company names separated by commas'],
                    postal_code: ['Postal code', ['Is included', 'Is not included', 'Is set', 'Is not set'], 'Postal codes separated by commas'],
                    email: ['Email', ['Contains', 'Does not contain', 'Is set', 'Is not set'], 'Email addresses separated by commas'],
                    phone: ['Phone', ['Contains', 'Does not contain', 'Is set', 'Is not set'], 'Phone numbers separated by commas'],
                    creation_time: ['Creation time', ['Is between', 'Is exactly'], 'dd/mm/yyy hh:mm - dd/mm/yyy hh:mm'],
                    custom_variable: ['Custom variable', [], 'variable=value']
                };
                let user_extra_details = SBUsers.getExtraDetailsList(true);
                for (var i = 0; i < user_extra_details.length; i++) {
                    list[user_extra_details[i][0]] = [user_extra_details[i][1], ['Contains', 'Does not contain', 'Is set', 'Is not set'], 'Values separated by commas'];
                }
                return list;
            },

            get: function (onSuccess) {
                SBF.ajax({
                    function: 'automations-get'
                }, (response) => {
                    this.items = response[0];
                    this.translations = Array.isArray(response[1]) && !response[1].length ? {} : response[1];
                    onSuccess(response);
                });
            },

            save: function (onSuccess = false) {
                this.updateActiveItem();
                SBF.ajax({
                    function: 'automations-save',
                    automations: this.items,
                    translations: this.translations
                }, (response) => {
                    if (onSuccess) onSuccess(response);
                });
            },

            show: function (id = false, language = false) {
                this.updateActiveItem();
                let items = language ? (language in this.translations ? this.translations[language] : []) : this.items;
                let area = automations_area.find(' > .sb-tab > .sb-content');
                if (id === false) id = this.activeID();
                this.hide(false);
                for (var key in items) {
                    for (var i = 0; i < items[key].length; i++) {
                        let item = items[key][i];
                        if (item.id == id) {
                            for (var key in item) {
                                let element = area.find(`[data-id="${key}"]`);
                                if (element.hasClass('image')) {
                                    element.css('background-image', `url(${item[key]})`).attr('data-value', item[key]);
                                    if (!item[key]) {
                                        element.removeAttr('data-value');
                                    }
                                } else if (element.attr('type') == 'checkbox') {
                                    element.prop('checked', item[key]);
                                } else {
                                    element.val(item[key]);
                                }
                            }
                            this.setConditions(item.conditions, conditions_area);
                            conditions_area.parent().setClass('sb-hide', language);
                            area.sbLanguageSwitcher(this.getTranslations(id), 'automations', language);
                            return true;
                        }
                    }
                }
                return false;
            },

            add: function () {
                let id = SBF.random();
                let name = `${sb_('Item')} ${automations_area_nav.find('li:not(.sb-no-results)').length + 1}`;
                this.updateActiveItem();
                this.items[this.activeType()].push(this.itemArray(this.activeType(), id, name));
                this.hide(false);
                automations_area_nav.find('.sb-active').sbActive(false);
                automations_area_nav.find('.sb-no-results').remove();
                automations_area_nav.append(`<li class="sb-active" data-id="${id}">${name}<i class="sb-icon-delete"></i></li>`);
                automations_area.find('.sb-automation-values').find('input, textarea').val('');
                automations_area.sbLanguageSwitcher([], 'automations');
                conditions_area.html('');
            },

            delete: function (element) {
                this.items[this.activeType()].splice($(element).parent().index(), 1);
                $(element).parent().remove();
                this.hide();
                if (this.items[this.activeType()].length == 0) automations_area_nav.html(`<li class="sb-no-results">${sb_('No results found.')}</li>`);
            },

            populate: function (type = false) {
                if (type === false) {
                    type = this.activeType();
                }
                let code = '';
                let items = this.items[type];
                this.updateActiveItem();
                if (items.length) {
                    for (var i = 0; i < items.length; i++) {
                        code += `<li data-id="${items[i].id}">${items[i].name}<i class="sb-icon-delete"></i></li>`;
                    }
                } else {
                    code = `<li class="sb-no-results">${sb_('No results found.')}</li>`;
                }
                automations_area_nav.html(code);
                code = '';
                switch (type) {
                    case 'emails':
                        code = `<h2>${sb_('Subject')}</h2><div class="sb-setting sb-type-text"><div><input data-id="subject" type="text"></div></div>`;
                        break;
                    case 'popups':
                        code = `<h2>${sb_('Title')}</h2><div class="sb-setting sb-type-text"><div><input data-id="title" type="text"></div></div><h2>${sb_('Profile image')}</h2><div data-type="upload-image" class="sb-setting sb-type-upload-image"><div class="input"><div data-id="profile_image" class="image"><i class="sb-icon-close"></i></div></div></div><h2>${sb_('Message fallback')}</h2><div class="sb-setting sb-type-checkbox"><div><input data-id="fallback" type="checkbox"></div></div>`;
                        break;
                    case 'design':
                        code = `<h2>${sb_('Header title')}</h2><div class="sb-setting sb-type-text"><div><input data-id="title" type="text"></div></div>`;
                        for (var i = 1; i < 4; i++) {
                            code += `<h2>${sb_((i == 1 ? 'Primary' : (i == 2 ? 'Secondary' : 'Tertiary')) + ' color')}</h2><div data-type="color" class="sb-setting sb-type-color"><div class="input"><input data-id="color_${i}" type="text"><i class="sb-close sb-icon-close"></i></div></div>`;
                        }
                        for (var i = 1; i < 4; i++) {
                            code += `<h2>${sb_(i == 1 ? 'Header background image' : (i == 2 ? 'Header brand image' : 'Chat button icon'))}</h2><div data-type="upload-image" class="sb-setting sb-type-upload-image"><div class="input"><div data-id="${i == 1 ? 'background' : (i == 2 ? 'brand' : 'icon')}" class="image"><i class="sb-icon-close"></i></div></div></div>`;
                        }
                        break;
                    case 'more':
                        code = `<h2>${sb_('Department ID')}</h2><div class="sb-setting sb-type-number"><div><input data-id="department" type="number"></div></div><h2>${sb_('Agent ID')}</h2><div class="sb-setting sb-type-number"><div><input data-id="agent" type="number"></div></div><h2>${sb_('Tags')}</h2><div class="sb-setting sb-type-text"><div><input data-id="tags" type="text"></div></div><h2>${sb_('Article IDs')}</h2><div class="sb-setting sb-type-number"><div><input data-id="articles" type="text"></div></div><h2>${sb_('Articles category')}</h2><div class="sb-setting sb-type-number"><div><input data-id="articles_category" type="text"></div></div>`;
                        break;
                }
                automations_area.find('.sb-automation-extra').html(code);
                automations_area.attr('data-automation-type', type);
                SBSettings.initColorPicker(automations_area);
                this.hide();
            },

            updateActiveItem: function () {
                let id = this.activeID();
                if (id) {
                    let language = automations_area.find(`.sb-language-switcher [data-language].sb-active`).attr('data-language');
                    let type = this.activeType();
                    let items = language ? (language in this.translations ? this.translations[language][type] : []) : this.items[type];
                    for (var i = 0; i < items.length; i++) {
                        if (items[i].id == id) {
                            items[i] = { id: id, conditions: [] };
                            automations_area.find('.sb-automation-values').find('input,textarea,[data-type="upload-image"] .image').each(function () {
                                items[i][$(this).attr('data-id')] = $(this).hasClass('image') && $(this)[0].hasAttribute('data-value') ? $(this).attr('data-value') : ($(this).attr('type') == 'checkbox' ? $(this).is(':checked') : $(this).val());
                            });
                            items[i].conditions = this.getConditions(conditions_area);
                            if (SBF.null(items[i].name)) {
                                this.delete(automations_area_nav.find(`[data-id="${id}"] i`));
                            }
                            break;
                        }
                    }
                }
            },

            getConditions: function (conditions_area) {
                let conditions = [];
                conditions_area.find(' > div').each(function () {
                    let condition = [];
                    $(this).find('input,select').each(function () {
                        condition.push($(this).val());
                    });
                    if (condition[0] && condition[1] && (condition.length == 2 || condition[2] || ['is-set', 'is-not-set'].includes(condition[1]))) {
                        conditions.push(condition);
                    }
                });
                return conditions;
            },

            setConditions: function (conditions, conditions_area) {
                conditions_area.html('');
                if (conditions) {
                    for (var key in conditions) {
                        this.addCondition(conditions_area);
                        let condition = conditions_area.find(' > div:last-child');
                        condition.find('select').val(conditions[key][0]);
                        this.updateCondition(condition.find('select'));
                        condition.find(' > div').eq(1).find('select,input').val(conditions[key][1]);
                        if (conditions[key].length > 2) {
                            if (['is-set', 'is-not-set'].includes(conditions[key][1])) {
                                condition.find(' > div').eq(2).addClass('sb-hide');
                            } else {
                                condition.find(' > div').eq(2).find('input').val(conditions[key][2]);
                            }
                        }
                    }
                }
            },

            addCondition: function (conditions_area) {
                conditions_area.append(`<div><div class="sb-setting sb-type-select sb-condition-1"><select>${this.getAvailableConditions()}</select></div></div>`);
            },

            updateCondition: function (element) {
                $(element).parent().siblings().remove();
                let parent = $(element).parents().eq(1);
                if ($(element).val()) {
                    let condition = this.conditions()[$(element).val()];
                    let code = '';
                    if (condition[1].length) {
                        code = '<div class="sb-setting sb-type-select sb-condition-2"><select>';
                        for (var i = 0; i < condition[1].length; i++) {
                            code += `<option value="${SBF.stringToSlug(condition[1][i])}">${sb_(condition[1][i])}</option>`;
                        }
                        code += '</select></div>';
                    }
                    parent.append(code + (condition.length > 2 ? `<div class="sb-setting sb-type-text"><input placeholder="${sb_(condition[2])}" type="text"></div>` : ''));
                    parent.siblings().find('.sb-condition-1 select').each(function () {
                        let value = $(this).val();
                        $(this).html(SBSettings.automations.getAvailableConditions([value]));
                        $(this).val(value);
                    });
                } else {
                    parent.remove();
                }
            },

            getAvailableConditions: function (include = [], exclude = []) {
                let code = '<option value=""></option>';
                let existing_conditions = [];
                let conditions = this.conditions();
                conditions_area.find('.sb-condition-1 select').each(function () {
                    existing_conditions.push($(this).val());
                });
                for (var key in conditions) {
                    if (!exclude.includes(key) && (!existing_conditions.includes(key) || include.includes(key))) {
                        code += `<option value="${key}">${sb_(conditions[key][0])}</option>`;
                    }
                }
                return code;
            },

            addTranslation: function (id = false, type = false, language) {
                if (id === false) {
                    id = this.activeID();
                }
                if (type === false) {
                    type = this.activeType();
                }
                if (this.getTranslations(id).includes(id)) {
                    return console.warn('Automation translation already in array.');
                }
                if (!(language in this.translations)) {
                    this.translations[language] = { messages: [], emails: [], sms: [], popups: [], design: [] };
                }
                if (!(type in this.translations[language])) {
                    this.translations[language][type] = [];
                }
                this.translations[language][type].push(this.itemArray(type, id));
            },

            getTranslations: function (id = false) {
                let translations = [];
                if (id === false) id = this.activeID();
                for (var key in this.translations) {
                    let types = this.translations[key];
                    for (var key2 in types) {
                        let items = types[key2];
                        for (var i = 0; i < items.length; i++) {
                            if (items[i].id == id) {
                                translations.push(key);
                                break;
                            }
                        }
                    }
                }
                return translations;
            },

            deleteTranslation: function (id = false, language) {
                if (id === false) id = this.activeID();
                if (language in this.translations) {
                    let types = this.translations[language];
                    for (var key in types) {
                        let items = types[key];
                        for (var i = 0; i < items.length; i++) {
                            if (items[i].id == id) {
                                this.translations[language][key].splice(i, 1);
                                return true;
                            }
                        }
                    }
                }
                return false;
            },

            activeID: function () {
                let item = automations_area_nav.find('.sb-active');
                return item.length ? item.attr('data-id') : false;
            },

            activeType: function () {
                return automations_area_select.find('li.sb-active').data('value');
            },

            itemArray: function (type, id, name = '', message = '') {
                return $.extend({ id: id, name: name, message: message }, type == 'emails' ? { subject: '' } : (type == 'popups' ? { title: '', profile_image: '' } : (type == 'design' ? { title: '', color_1: '', color_2: '', color_3: '', background: '', brand: '', icon: '' } : {})));
            },

            hide: function (hide = true) {
                automations_area.find(' > .sb-tab > .sb-content').setClass('sb-hide', hide);
            }
        },

        translations: {
            translations: {},
            originals: {},
            to_update: {},

            add: function (language) {
                let setting = SBSettings.getSettingObject(language_switcher_target);
                let setting_id = setting.attr('id');
                let active_language = language_switcher_target.find('[data-language].sb-active');
                this.save(setting, active_language.length ? active_language.attr('data-language') : false);
                setting.find('textarea,input[type="text"]').val('');
                this.save(setting, language);
                language_switcher_target.remove();
                setting.sbLanguageSwitcher(this.getLanguageCodes(setting_id), 'settings', language);
            },

            delete: function (setting, language) {
                setting = SBSettings.getSettingObject(setting);
                let setting_id = setting.attr('id');
                delete this.translations[language][setting_id];
                setting.find(`.sb-language-switcher [data-language="${language}"]`).remove();
                this.activate(setting);
            },

            activate: function (setting, language = false) {
                setting = SBSettings.getSettingObject(setting);
                let setting_id = setting.attr('id');
                let values = language ? this.translations[language][setting_id] : this.originals[setting_id];
                if (isString(values)) {
                    setting.find('input, textarea').val(values);
                } else {
                    for (var key in values) {
                        setting.find('#' + key).find('input, textarea').val(isString(values[key]) ? values[key] : values[key][0]);
                    }
                }
            },

            updateActive: function () {
                let area = settings_area.find('.sb-translations-list')
                let translations = { 'front': {}, 'admin': {}, 'admin/js': {}, 'admin/settings': {} };
                let language_code = area.attr('data-value');
                if (SBF.null(language_code)) return;
                for (var key in translations) {
                    area.find(' > [data-area="' + key + '"] .sb-setting:not(.sb-new-translation)').each(function () {
                        translations[key][$(this).find('label').html()] = $(this).find('input').val();
                    });
                    area.find('> [data-area="' + key + '"] .sb-new-translation').each(function () {
                        let original = $(this).find('input:first-child').val();
                        let value = $(this).find('input:last-child').val();
                        if (original && value) {
                            translations[key][original] = value;
                        }
                    });
                }
                this.to_update[language_code] = translations;
            },

            save: function (setting, language = false) {
                setting = SBSettings.getSettingObject(setting);
                let values = {};
                let setting_id = $(setting).attr('id');
                if (setting.data('type') == 'multi-input') {
                    setting.find('.multi-input-textarea,.multi-input-text').each(function () {
                        values[$(this).attr('id')] = $(this).find('input, textarea').val();
                    });
                } else {
                    values = setting.find('input, textarea').val();
                }
                if (language) {
                    if (!(language in this.translations)) {
                        this.translations[language] = {};
                    }
                    this.translations[language][setting_id] = values;
                } else {
                    this.originals[setting_id] = values;
                }
            },

            load: function (language_code) {
                let area = settings_area.find('.sb-translations > .sb-content');
                area.find(' > .sb-hide').removeClass('sb-hide');
                this.updateActive();
                SBF.ajax({
                    function: 'get-translation',
                    language_code: language_code
                }, (translations) => {
                    if (language_code in this.to_update) translations = this.to_update[language_code];
                    let code = '';
                    let areas = ['front', 'admin', 'admin/js', 'admin/settings'];
                    for (var i = 0; i < areas.length; i++) {
                        let translations_area = translations[areas[i]];
                        code += `<div${!i ? ' class="sb-active"' : ''} data-area="${areas[i]}">`;
                        for (var key in translations_area) {
                            code += `<div class="sb-setting sb-type-text"><label>${key}</label><div><input type="text" value="${translations_area[key]}"></div></div>`;
                        }
                        code += '</div>';
                    }
                    area.find('.sb-translations-list').attr('data-value', language_code).html(code);
                    area.find('.sb-menu-wide li').sbActive(false).eq(0).sbActive(true);
                    area.sbLoading(false);
                });
                area.sbLoading(true);
            },

            getLanguageCodes: function (setting_id) {
                let languages = [];
                for (var key in this.translations) {
                    if (setting_id in this.translations[key]) {
                        languages.push(key);
                    }
                }
                return languages;
            }
        }
    }

    /*
    * ----------------------------------------------------------
    * Articles
    * ----------------------------------------------------------
    */

    var SBArticles = {
        category_list: [],
        page_url: false,

        get: function (onSuccess, article_id = false, categories = false, full = true, language = false) {
            SBF.ajax({
                function: 'get-articles',
                id: article_id,
                categories: categories,
                articles_language: language,
                full: full
            }, (response) => {
                onSuccess(response);
            });
        },

        save: function (onSuccess = false) {
            let id = this.activeID();
            let article;
            article = { id: id, title: articles_area.find('.sb-article-title input').val(), content: articles_area.find('.sb-article-content textarea').val(), link: articles_area.find('.sb-article-link input').val(), parent_category: articles_category_parent_select.val(), category: articles_category_select.val(), language: articles_area.find('.sb-language-switcher [data-language].sb-active').attr('data-language') };
            if (!article.title && !article.content) {
                return onSuccess(false);
            }
            if (article.language) {
                article.parent_id = this.activeID(true);
            }
            if (editor_js && typeof editor_js.save !== ND) {
                editor_js.save().then((outputData) => {
                    article.editor_js = outputData;
                    article.content = editorJSHTML(outputData.blocks);
                    this.save_2(article, onSuccess);
                }).catch((error) => {
                    console.log(error);
                });
            } else {
                this.save_2(article, onSuccess);
            }
        },

        save_2: function (article, onSuccess = false) {
            SBF.ajax({
                function: 'save-article',
                article: JSON.stringify(article)
            }, (response) => {
                let is_number = response !== true && !isNaN(response);
                articles_save_required = false;
                if (is_number) {
                    articles_content.attr('data-id', response);
                    article.id = response;
                    this.viewButton(response)
                    if (article.language) {
                        let translations = SBArticles.translations.get(article.parent_id);
                        articles_content.find(`.sb-language-switcher [data-language="${article.language}"]`).attr('data-id', response);
                        for (var i = 0; i < translations.length; i++) {
                            if (translations[i][0] == article.language) {
                                translations[i][1] = article.id;
                                SBArticles.translations.list[article.parent_id] = translations;
                                break;
                            }
                        }
                    }
                }
                if (!article.language) {
                    articles_area.find('.ul-articles .sb-active').html(article.title + '<i class="sb-icon-delete"></i>').attr('data-id', article.id);
                }
                if (onSuccess) {
                    onSuccess(response);
                }
                infoBottom(response === true || is_number ? 'Article saved' : response);
            });
        },

        show: function (article_id) {
            if (!article_id) {
                return;
            }
            loading(articles_content);
            this.get((response) => {
                articles_content.sbLoading(false);
                response = response[0];
                articles_content.sbLanguageSwitcher(this.translations.get(response.parent_id ? response.parent_id : article_id), 'articles', response.language);
                articles_content.attr('data-id', article_id);
                articles_area.find('.sb-article-title input').val(response.title);
                articles_area.find('.sb-article-link input').val(response.link);
                articles_area.find('#sb-article-id').html(`ID <span>${article_id}</span>`);
                articles_area.find('.sb-article-categories').setClass('sb-hide', response.language);
                if (editor_js || articles_area.find('#editorjs').length) {
                    editorJSLoad(response.editor_js ? (isString(response.editor_js) ? JSON.parse(response.editor_js) : response.editor_js) : response.content);
                } else {
                    articles_area.find('.sb-article-content textarea').val(response.content);
                }
                if (!response.language) {
                    articles_category_parent_select.val(response.parent_category);
                    articles_category_select.val(response.category);
                }
                this.viewButton(article_id)
                articles_save_required = false;
            }, article_id);
        },

        add: function () {
            let nav = articles_area.find('.ul-articles');
            nav.find('.sb-active').sbActive(false);
            nav.append(`<li class="sb-active"></li>`);
            articles_content.sbLanguageSwitcher([], 'articles');
            this.clear();
        },

        clear: function () {
            articles_content.removeAttr('data-id').removeClass('sb-hide');
            articles_content.find('input, textarea, select').val('');
            articles_content.find('input').prop('checked', false);
            editorJSLoad();
            this.viewButton();
            articles_save_required = false;
        },

        delete: function (article_id, onSuccess = false) {
            SBF.ajax({
                function: 'save-article',
                article: JSON.stringify({ id: article_id, delete: true })
            }, (response) => {
                this.clear();
                if (onSuccess) {
                    onSuccess(response);
                }
            });
        },

        populate: function (items, is_category = false) {
            let code = '';
            for (var i = 0; i < items.length; i++) {
                if (items[i].id) code += `<li data-id="${items[i].id}">${items[i].title}<i class="sb-icon-delete"></i></li>`;
            }
            articles_area.find(is_category ? '.ul-categories' : '.ul-articles').html(code);
            articles_area.find(is_category ? '.ul-categories > li' : '.ul-articles > li').eq(0).click();
            if (!items.length) {
                $(is_category ? articles_content_categories : articles_content).sbLoading(false).addClass('sb-hide');
            }
        },

        activeID: function (is_parent = false) {
            return is_parent ? articles_area.find('.ul-articles .sb-active').attr('data-id') : articles_content.attr('data-id');
        },

        viewButton: function (article_id = false) {
            if (this.page_url) {
                let button = articles_area.find('.sb-view-article');
                button.attr('href', article_id ? this.page_url + (this.is_url_rewrite ? (this.page_url.charAt(this.page_url.length - 1) == '/' ? '' : '/') + (this.cloud_chat_id ? this.cloud_chat_id + '/' : '') : '?article_id=') + article_id : '');
            }
        },

        categories: {
            list: [],

            save: function (onSuccess = false) {
                this.updateActive();
                SBF.ajax({
                    function: 'save-articles-categories',
                    categories: JSON.stringify(this.list)
                }, (response) => {
                    if (onSuccess) {
                        onSuccess(response);
                    }
                    infoBottom(response === true ? 'Categories saved' : response);
                })
            },

            show: function (category_id, language = false) {
                let index = this.getIndex(category_id);
                if (index !== false) {
                    let category = language ? this.list[index].languages[language] : this.list[index];
                    let image = articles_content_categories.find('#category-image');
                    this.updateActive();
                    articles_content_categories.find('#category-title').val(category.title);
                    articles_content_categories.find('#category-description').val(category.description);
                    articles_content_categories.find('#category-parent').prop('checked', category.parent ? true : false);
                    articles_content_categories.sbLanguageSwitcher($.map(this.list[index].languages, function (e, index) { return index }), 'article-categories', language);
                    if (category.image) {
                        image.attr('data-value', category.image).css('background-image', `url("${category.image}")`);
                    } else {
                        image.removeAttr('data-value style');
                    }
                    articles_content_categories.find('.category-parent').setClass('sb-hide', language);
                }
                articles_content_categories.sbLoading(false);
            },

            add: function () {
                let category_id = SBF.random();
                this.list.push({ id: category_id, title: '', description: '', image: '', languages: [] });
                let code = `<li data-id="${category_id}">${sb_('New category')}<i class="sb-icon-delete"></i></li>`;
                articles_area.find('.ul-categories').append(code);
                articles_area.find('.ul-categories li').eq(articles_area.find('.ul-categories li').length - 1).click();
                articles_content_categories.removeClass('sb-hide');
                $('.ul-categories li[data-id=""]').remove();
            },

            delete: function (category_id) {
                let index = this.getIndex(category_id);
                let ul = articles_area.find('.ul-categories');
                if (index !== false) {
                    this.list.splice(index, 1);
                    ul.find(`[data-id="${category_id}"]`).remove();
                    ul.find('li').eq(0).click();
                    return true;
                }
                return false;
            },

            update: function () {
                let selected_category = articles_category_select.val();
                let selected_category_parent = articles_category_parent_select.val();
                let code = ['', '<option></option>'];
                let ids = this.list.map(function (item) {
                    return item.id;
                });
                for (var i = 0; i < this.list.length; i++) {
                    code[this.list[i].parent ? 0 : 1] += `<option value="${this.list[i].id}">${this.list[i].title}</option>`;
                }
                articles_category_parent_select.html(code[0]);
                articles_category_select.html(code[1]);
                if (this.list.length) {
                    articles_category_parent_select.val(ids.includes(selected_category_parent) ? selected_category_parent : (articles_category_parent_select[0].selectedIndex > -1 ? this.list[articles_category_parent_select[0].selectedIndex].id : ''));
                    articles_category_select.val(ids.includes(selected_category) ? selected_category : (articles_category_select[0].selectedIndex > -1 ? this.list[articles_category_select[0].selectedIndex].id : ''));
                }
            },

            updateActive: function () {
                let id = this.activeID();
                if (id) {
                    let index = this.getIndex(id);
                    let language = articles_content_categories.find('.sb-language-switcher .sb-active').attr('data-language');
                    let category = { title: articles_content_categories.find('#category-title').val(), description: articles_content_categories.find('#category-description').val(), image: articles_content_categories.find('#category-image').attr('data-value') }
                    if (language) {
                        this.list[index].languages[language] = category;
                    } else {
                        category.id = SBF.stringToSlug(category.title);
                        category.parent = articles_content_categories.find('#category-parent').is(':checked');
                        category.languages = this.list[index].languages;
                        this.list[index] = category;
                        articles_area.find('.ul-categories .sb-active').html(category.title + '<i class="sb-icon-delete"></i>').attr('data-id', category.id);
                    }
                }
            },

            clear: function () {
                articles_content_categories.find('input, textarea').val('');
                articles_content_categories.find('#category-image').removeAttr('data-value style');
            },

            getIndex: function (category_id) {
                for (var i = 0; i < this.list.length; i++) {
                    if (this.list[i].id == category_id) {
                        return i;
                    }
                }
                return false;
            },

            activeID: function () {
                return articles_area.find('.ul-categories .sb-active').attr('data-id');
            },

            translations: {

                add: function (language_code, category_id = false) {
                    SBArticles.categories.updateActive();
                    if (!category_id) {
                        category_id = SBArticles.categories.activeID();
                    }
                    let index = SBArticles.categories.getIndex(category_id);
                    if (SBF.null(SBArticles.categories.list[index].languages)) SBArticles.categories.list[index].languages = {}; // Deprecated
                    SBArticles.categories.list[index].languages[language_code] = { title: '', description: '', image: '' };
                    articles_content_categories.sbLanguageSwitcher($.map(SBArticles.categories.list[index].languages, function (e, index) { return index }), 'article-categories', language_code);
                    SBArticles.categories.clear();
                },

                delete: function (language_code, category_id = false) {
                    let active_id = SBArticles.categories.activeID();
                    if (!category_id) {
                        category_id = SBArticles.categories.activeID(active_id);
                    }
                    delete SBArticles.categories.list[SBArticles.categories.getIndex(category_id)].languages[language_code];
                    SBArticles.categories.show(active_id);
                }
            }
        },

        translations: {
            list: {},

            add: function (language_code, article_id = false) {
                if (!article_id) {
                    article_id = SBArticles.activeID(true);
                }
                let translations = this.get(article_id);
                translations.push([language_code, false]);
                this.list[article_id] = translations;
                articles_content.sbLanguageSwitcher(translations, 'articles', language_code);
                // SBArticles.clear();
            },

            delete: function (language_code, article_id = false) {
                if (!article_id) {
                    article_id = SBArticles.activeID(true);
                }
                let translations = this.get(article_id);
                for (var i = 0; i < translations.length; i++) {
                    if (translations[i][0] == language_code) {
                        SBArticles.delete(translations[i][1], (response) => {
                            if (response === true) {
                                translations.splice(i, 1);
                                this.list[article_id] = translations;
                                SBArticles.show(article_id);
                            }
                        });
                        break;
                    }
                }
                return false;
            },

            get: function (article_id) {
                return article_id in this.list ? this.list[article_id] : [];
            }
        }
    }


    /*
    *
    * ----------------------------------------------------------
    * Dashboard
    * 
    */


    var SBDashboard = {
        page_url: false,
        ticket_status: 'all',

        lightenColor: function (hex, percent = 40) {
            if (!hex || typeof hex !== 'string') return "#cccccc";
            hex = hex.replace('#', '');
            if (hex.length !== 6) return "#cccccc";
            const r = parseInt(hex.substr(0, 2), 16);
            const g = parseInt(hex.substr(2, 2), 16);
            const b = parseInt(hex.substr(4, 2), 16);
            const rNorm = r / 255;
            const gNorm = g / 255;
            const bNorm = b / 255;
            const max = Math.max(rNorm, gNorm, bNorm);
            const min = Math.min(rNorm, gNorm, bNorm);
            let h, s, l = (max + min) / 2;
            if (max === min) {
                h = s = 0;
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case rNorm: h = (gNorm - bNorm) / d + (gNorm < bNorm ? 6 : 0); break;
                    case gNorm: h = (bNorm - rNorm) / d + 2; break;
                    case bNorm: h = (rNorm - gNorm) / d + 4; break;
                }
                h /= 6;
            }
            l = Math.min(1, l + (percent / 100));
            function hslToRgb(h, s, l) {
                let r, g, b;
                if (s === 0) {
                    r = g = b = l;
                } else {
                    const hue2rgb = (p, q, t) => {
                        if (t < 0) t += 1;
                        if (t > 1) t -= 1;
                        if (t < 1 / 6) return p + (q - p) * 6 * t;
                        if (t < 1 / 2) return q;
                        if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
                        return p;
                    };
                    const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                    const p = 2 * l - q;
                    r = hue2rgb(p, q, h + 1 / 3);
                    g = hue2rgb(p, q, h);
                    b = hue2rgb(p, q, h - 1 / 3);
                }
                return [
                    Math.round(r * 255),
                    Math.round(g * 255),
                    Math.round(b * 255)
                ];
            }
            const [lr, lg, lb] = hslToRgb(h, s, l);
            return `rgb(${lr}, ${lg}, ${lb})`;
        },
        getLastWeekRange: function () {
            const today = new Date();
            const endDate = today;
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - 7);
            const formatDate = (date) => {
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-based
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            };
            return {
                from: formatDate(startDate),
                to: formatDate(endDate)
            };
        },
        formatNumber: function (value) {
            const rounded = parseFloat(value.toFixed(2));
            return Number.isInteger(rounded) ? Math.floor(rounded) : rounded;
        },
        get: function (onSuccess, ticket_id = false, categories = false, full = true, language = false) {


            // get tickets
            SBF.ajax({
                function: 'get-tickets',
                id: ticket_id,
                ticket_status: this.ticket_status,
                categories: categories,
                tickets_language: language,
                full: full,
                user_id: false
            }, (response) => {
                onSuccess(response);

                //// fetch customer overview data
                this.fetchCustomerOverview();
                this.populate(response);
            });

            const { from, to } = this.getLastWeekRange();
            this.renderNewUsersChart(from, to);

            //get users count
            // SBF.ajax({
            //     function: 'get-users-registrations-count',
            //     date_start: from,
            //     date_end: to,
            // }, (response) => {
            //     onSuccess(response);
            //     this.populate(response);
            // });

            SBF.ajax({
                function: 'get-tickets-count',
                date_start: from,
                date_end: to,
            }, (response) => {
                const months1 = Object.keys(response[1].resolved_ticket_data);
                // Get values array
                const values1 = Object.values(response[1].resolved_ticket_data);
                $('.ticket-resolved').html(response[1].resolved_tickets_count);

                const lastWeekResolvedSum = values1.reduce((acc, curr) => acc + curr, 0);
                const resolvedBeforeLasteWeek = response[1].resolved_tickets_count - lastWeekResolvedSum == 0 ? 1 : response[1].resolved_tickets_count - lastWeekResolvedSum;
                const resolvedTicketspercentageIncrease = (lastWeekResolvedSum / resolvedBeforeLasteWeek) * 100;

                $('.total-resolved-tickets-increase').html(this.formatNumber(resolvedTicketspercentageIncrease));

                const ticket_resolvedCtx = document.getElementById('ticket_resolved_chart').getContext('2d');
                const gradient4 = ticket_resolvedCtx.createLinearGradient(0, 0, 0, 200);
                gradient4.addColorStop(0, 'rgba(6, 131, 255, 0.2)');
                gradient4.addColorStop(1, 'rgba(6, 131, 255, 0)');
                new Chart(ticket_resolvedCtx, {
                    type: 'line',
                    data: {
                        labels: months1,
                        datasets: [{
                            data: values1,
                            borderColor: '#0684FF',
                            backgroundColor: gradient4,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 0,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: false
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    display: false
                                },
                                border: {
                                    display: false
                                }
                            },
                            y: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    display: false
                                },
                                border: {
                                    display: false
                                }
                            }
                        }
                    }
                });


                ///////////////////// Pending Tickets Chart
                const months3 = Object.keys(response[1].pending_ticket_data);
                // Get values array
                const values3 = Object.values(response[1].pending_ticket_data);
                $('.tickets-pending').html(response[1].pending_tickets_count);

                const lastWeekPendingSum = values3.reduce((acc, curr) => acc + curr, 0);
                const pendingBeforeLasteWeek = response[1].pending_tickets_count - lastWeekPendingSum == 0 ? 1 : response[1].pending_tickets_count - lastWeekPendingSum;
                const pendingTicketspercentageIncrease = (lastWeekPendingSum / pendingBeforeLasteWeek) * 100;

                $('.total-pending-tickets-increase').html(this.formatNumber(pendingTicketspercentageIncrease));

                const ticket_pendingCtx = document.getElementById('ticket_pending_chart').getContext('2d');
                const gradient6 = ticket_pendingCtx.createLinearGradient(0, 0, 0, 200);
                gradient6.addColorStop(0, 'rgba(6, 131, 255, 0.2)');
                gradient6.addColorStop(1, 'rgba(6, 131, 255, 0)');
                new Chart(ticket_pendingCtx, {
                    type: 'line',
                    data: {
                        labels: months3,
                        datasets: [{
                            data: values3,
                            borderColor: '#0684FF',
                            backgroundColor: gradient6,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 0,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: false
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    display: false
                                },
                                border: {
                                    display: false
                                }
                            },
                            y: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    display: false
                                },
                                border: {
                                    display: false
                                }
                            }
                        }
                    }
                });


                const lastWeekDates = Object.keys(response[1].tickets_data);
                // Get values array
                const ticketsValues = Object.values(response[1].tickets_data);
                const lastWeekTicketsSum = ticketsValues.reduce((acc, curr) => acc + curr, 0);
                const ticketBeforeLasteWeek = response[1].total_tickets_count - lastWeekTicketsSum == 0 ? 1 : response[1].total_tickets_count - lastWeekTicketsSum;
                const percentageIncrease = (lastWeekTicketsSum / ticketBeforeLasteWeek) * 100;

                $('.total-tickets-created').html(response[1].total_tickets_count);
                $('.total-tickets span').html(response[1].total_tickets_count);
                $('.total-tickets-increase').html(this.formatNumber(percentageIncrease));
                $('.green_badge.new-tickets span').html(lastWeekTicketsSum);

                const ticket_createdCtx = document.getElementById('ticket_created_chart').getContext('2d');
                const gradient3 = ticket_createdCtx.createLinearGradient(0, 0, 0, 200);
                const ticketsText = sb_("No. of Tickets");
                gradient3.addColorStop(0, 'rgba(255, 182, 72, 0.2)');
                gradient3.addColorStop(1, 'rgba(72, 182, 72, 0)');
                new Chart(ticket_createdCtx, {
                    type: 'line',
                    data: {
                        labels: lastWeekDates,
                        datasets: [{
                            data: ticketsValues,
                            borderColor: '#f4941e',
                            backgroundColor: gradient3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 0,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: false
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    display: false
                                },
                                border: {
                                    display: false
                                }
                            },
                            y: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    display: false
                                },
                                border: {
                                    display: false
                                }
                            }
                        }
                    }
                });

                const lastWeekDay = Object.keys(response[1].tickets_weekday_data);
                // Get values array
                const ticketsValuesDaily = Object.values(response[1].tickets_weekday_data);


                const ticket_activityCtx = document.getElementById('ticket_activity_chart').getContext('2d');
                new Chart(ticket_activityCtx, {
                    type: 'line',
                    data: {
                        labels: lastWeekDay,
                        datasets: [{
                            label: 'Weekly Activity',
                            data: ticketsValuesDaily,
                            borderColor: '#487FFF',
                            backgroundColor: '#E4ECFF',
                            pointRadius: 0,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#487FFF'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    display: true
                                },
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    display: false
                                },
                                border: {
                                    display: true
                                },
                                title: {
                                    display: true,
                                    text: ticketsText,
                                    font: {
                                        weight: 'bold'
                                    }
                                }
                            }
                        }
                    }
                });


            });

            //// Get Conversations count
            SBF.ajax({
                function: 'get-conversation-count',
                date_start: from,
                date_end: to,
            }, (response) => {

                const months2 = Object.keys(response[1].data);
                // Get values array
                const values2 = Object.values(response[1].data);
                $('.total-conversations').html(response[1].total_conversations_count);

                const lastWeekConversationsSum = values2.reduce((acc, curr) => acc + curr, 0);
                const conversationsBeforeLasteWeek = response[1].total_conversations_count - lastWeekConversationsSum == 0 ? 1 : response[1].total_conversations_count - lastWeekConversationsSum;
                const conversationsTicketspercentageIncrease = (lastWeekConversationsSum / conversationsBeforeLasteWeek) * 100;

                $('.total-conversations-increase').html(this.formatNumber(conversationsTicketspercentageIncrease));

                const conversations_chartCtx = document.getElementById('conversations_chart').getContext('2d');
                const gradient5 = conversations_chartCtx.createLinearGradient(0, 0, 0, 200);
                gradient5.addColorStop(0, 'rgba(231, 110, 241, 0.2)');
                gradient5.addColorStop(1, 'rgba(231, 110, 241, 0)');
                new Chart(conversations_chartCtx, {
                    type: 'line',
                    data: {
                        labels: months2,
                        datasets: [{
                            data: values2,
                            borderColor: '#8252E9',
                            backgroundColor: gradient5,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 0,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: false
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    display: false
                                },
                                border: {
                                    display: false
                                }
                            },
                            y: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    display: false
                                },
                                border: {
                                    display: false
                                }
                            }
                        }
                    }
                });


                $('.total-unread-conversations').html(response[1].total_unread_conversations_count);

                const lastWeekDates2 = Object.keys(response[1].unread_conversations_data);
                // Get values array
                const userValues2 = Object.values(response[1].unread_conversations_data);

                const lastWeekUnreadConversationSum = userValues2.reduce((acc, curr) => acc + curr, 0);
                const unreadConversationsBeforeLasteWeek = response[1].total_unread_conversations_count - lastWeekUnreadConversationSum == 0 ? 1 : response[1].total_unread_conversations_count - lastWeekUnreadConversationSum;
                const unreadConversationsPercentageIncrease = (lastWeekUnreadConversationSum / unreadConversationsBeforeLasteWeek) * 100;

                $('.total-unread-increase').html(this.formatNumber(unreadConversationsPercentageIncrease));

                const active_usersCtx = document.getElementById('unread_conversation_chart').getContext('2d');
                const gradient7 = active_usersCtx.createLinearGradient(0, 0, 0, 200);
                gradient7.addColorStop(0, 'rgba(69, 179, 106, 0.2)');
                gradient7.addColorStop(1, 'rgba(69, 179, 106, 0)');
                new Chart(active_usersCtx, {
                    type: 'line',
                    data: {
                        labels: lastWeekDates2,
                        datasets: [{
                            data: userValues2,
                            borderColor: '#45B369',
                            backgroundColor: gradient7,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 0,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: false
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    display: false
                                },
                                border: {
                                    display: false
                                }
                            },
                            y: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    display: false
                                },
                                border: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            });

            ////// Get Yearly tickets count for ticket support board widget
            SBF.ajax({
                function: 'get-tickets-yearly-count',
            }, (response) => {

                const currentYear = new Date().getFullYear();
                const monthsOrder = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                const dataMap = response[1].data;

                const filteredMonths = monthsOrder;
                const filteredValues = monthsOrder.map(m => dataMap[m] || 0);
                const ticketsText = sb_("No. of Tickets");
                const JanText = sb_("January");
                const DecText = sb_("December");

                $('.main-charts .tickets-created').html(response[1].created);
                $('.main-charts .tickets-resolved').html(response[1].resolved);
                $('.main-charts .tickets-pending').html(response[1].pending);

                const barCtx = document.getElementById('monthlyBarChart').getContext('2d');
                new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels: filteredMonths,
                        datasets: [{
                            label: 'Tickets',
                            data: filteredValues,
                            backgroundColor: '#4285F4',
                            borderRadius: 4,
                            barThickness: 17
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return `${context.raw.toLocaleString()} users`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { display: false },
                                ticks: {
                                    color: '#888',
                                    font: { size: 12 }
                                },
                                title: {
                                    display: true,
                                    text: `${JanText} - ${DecText} ${currentYear}`,
                                    color: '#555',
                                    font: { size: 14, weight: 'bold' }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    drawBorder: false,
                                    drawOnChartArea: true,
                                    color: '#eee',
                                    lineWidth: 1,
                                    borderDash: [5, 5]
                                },
                                ticks: {
                                    stepSize: 1,
                                    precision: 0,
                                    color: '#aaa'
                                },
                                title: {
                                    display: true,
                                    text: ticketsText,
                                    color: '#555',
                                    font: { size: 14, weight: 'bold' }
                                }
                            }
                        }
                    }
                });

            });


            /////////// get total registered users count

            // get avg response time 
            SBF.ajax({
                function: 'get-total-users-count',
                date_start: from,
                date_end: to
            }, (response) => {
                $('.total-users').html(response[1].total_users_count);

                const lastWeekDates = Object.keys(response[1].data);
                // Get values array
                const userValues = Object.values(response[1].data);

                const lastWeekUsersSum = userValues.reduce((acc, curr) => acc + curr, 0);
                const usersBeforeLasteWeek = response[1].total_users_count - lastWeekUsersSum == 0 ? 1 : response[1].total_users_count - lastWeekUsersSum;
                const percentageIncrease = (lastWeekUsersSum / usersBeforeLasteWeek) * 100;

                $('.total-users-increase').html(this.formatNumber(percentageIncrease));

                const active_usersCtx = document.getElementById('active_users_chart').getContext('2d');
                const gradient7 = active_usersCtx.createLinearGradient(0, 0, 0, 200);
                gradient7.addColorStop(0, 'rgba(69, 179, 106, 0.2)');
                gradient7.addColorStop(1, 'rgba(69, 179, 106, 0)');
                new Chart(active_usersCtx, {
                    type: 'line',
                    data: {
                        labels: lastWeekDates,
                        datasets: [{
                            data: userValues,
                            borderColor: '#45B369',
                            backgroundColor: gradient7,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 0,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: false
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    display: false
                                },
                                border: {
                                    display: false
                                }
                            },
                            y: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    display: false
                                },
                                border: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            });

            ////// Get latet 5 messages
            let html = '';
            SBF.ajax({
                function: 'get_recent_messages',
            }, (response) => {
                $(response[1].data).each(function () {
                    html += `<li class="msg d-flex g-3 mb-6">
                        <img src="${this.profile_image}" alt="${this.user_name}" class="avatar" data-name="${this.user_name}"/>
                        <div class="user-initials" data-value="edit-profile" style="display:none;"><span class="initials"></span></div>
                        <div class="col-8">
                            <div class="head2 mb-2">${this.user_name}</div>
                            <div class="sub_head2 mb-1">${this.message}</div>
                            <small class="text-muted">${SBF.beautifyTime(this.creation_time, true)}</small>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <a href="?conversation=${this.conversation_id}" target="_blank"><button class="reply-btn">${sb_("Reply")}</button></a>
                        </div>
                    </li>`;
                });


                setTimeout(function () {
                    $('.sb-area-dashboard .recent-messages').html(html !== '' ? html : '<span class="d-block mt-5" style="text-align: center;height: auto;"><strong>No message found</strong></span>');
                    showInitials('recent-messages', 'msg');
                }, 1000);
            });

            // if (SB_ACTIVE_AGENT.user_type == 'admin') {
            //     //////get avg response time 
            //     SBF.ajax({
            //         function: 'reports',
            //         name: 'agents-response-time',
            //         date_start: from,
            //         date_end: to,
            //         timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
            //     }, (resTime) => {
            //         if (resTime && resTime.data) {
            //             let htmlContent = '';
            //             for (let agentName in resTime.data) {
            //                 if (resTime.data.hasOwnProperty(agentName)) {
            //                     // with agent name
            //                     // const responseTimeInSeconds = resTime.data[agentName][0];
            //                     // const hours = Math.floor(responseTimeInSeconds / 3600);
            //                     // const minutes = Math.floor((responseTimeInSeconds % 3600) / 60);
            //                     // const seconds = responseTimeInSeconds % 60;
            //                     // const formattedTime = `${hours}h ${minutes}m ${seconds}s`;
            //                     // htmlContent += `<p><strong>${agentName}</strong>: ${formattedTime}</p>`;

            //                     // without agent name 
            //                     const responseTimeInSeconds = resTime.data[agentName][0]; // The response time in seconds
            //                     const hours = Math.floor(responseTimeInSeconds / 3600);
            //                     const minutes = Math.floor((responseTimeInSeconds % 3600) / 60);
            //                     const seconds = responseTimeInSeconds % 60;
            //                     const formattedTime = `${hours}h ${minutes}m ${seconds}s`;
            //                     htmlContent += `<p>${formattedTime}</p>`;
            //                 }
            //             }
            //             // document.querySelector('#avg_response_time_container').innerHTML = htmlContent;
            //         }
            //     });
            // }
        },
        fetchCustomerOverview: function () {
            let filter = $(".sb-area-dashboard #customer-overview").val();
            SBF.ajax({
                function: 'fetch-customer-overview',
                filter: filter
            }, (response) => {

                if (response[1][0] = 'success') {
                    $('.overview_chart .filter-range').html(`<span>(${response[1].start_date} - ${response[1].end_date})</span>`);
                    $('.overview_chart .total').next().html(`Total: ${response[1].total_customers}`);
                    $('.overview_chart .new').next().html(`New: ${response[1].recent_customers}`);

                    // Prepare chart data
                    const total = parseInt(response[1].total_customers) || 0;
                    const recent = parseInt(response[1].recent_customers) || 0;
                    const active = 0;

                    if (total != 0) {
                        // Destroy existing chart instance if any
                        if (window.donutChartInstance) {
                            window.donutChartInstance.destroy();
                        }

                        // Render chart
                        const ctx = document.getElementById('donutChart').getContext('2d');
                        new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: ['Total', 'New', 'Active'],
                                datasets: [{
                                    data: [total, recent, active],
                                    backgroundColor: ['#4CAF50', '#FFA726', '#4285F4'],
                                    borderWidth: 0
                                }]
                            },
                            options: {
                                cutout: '70%',
                                rotation: -90,
                                circumference: 180,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    tooltip: {
                                        enabled: true
                                    }
                                }
                            }
                        });
                    }
                    else {
                        $("#chart-container").html('<strong>No data available for graph</strong>');
                    }
                }

            });
        },
        renderNewUsersChart: function (from, to) {
            const ctx2 = document.getElementById('unread_conversation_chart');
            if (!ctx2) {
                return console.error("Canvas element not found!");
            }

            if (newUsersChartInstance) {
                newUsersChartInstance.destroy();
                newUsersChartInstance = null;
            }


            // SBReports.getData("users", from, to, (response) => {
            //     if (!response || !response.data) return;
            //     const labels = Object.keys(response.data);
            //     const values = Object.values(response.data).map(val => val[0]);

            //     const new_usersCtx = ctx2.getContext('2d');
            //     const gradient1 = new_usersCtx.createLinearGradient(0, 0, 0, 200);
            //     gradient1.addColorStop(0, 'rgba(72, 127, 255, 0.2)');
            //     gradient1.addColorStop(1, 'rgba(72, 127, 255, 0)');

            //     newUsersChartInstance = new Chart(new_usersCtx, {
            //         type: 'line',
            //         data: {
            //             labels: labels,
            //             datasets: [{
            //                 data: values,
            //                 borderColor: '#487FFF',
            //                 backgroundColor: gradient1,
            //                 fill: true,
            //                 tension: 0.4,
            //                 pointRadius: 0,
            //                 pointHoverRadius: 0,
            //                 borderWidth: 2,
            //                 label: '',
            //             }]
            //         },
            //         options: {
            //             responsive: true,
            //             plugins: {
            //                 legend: { display: false },     // â Remove legend
            //                 // tooltip: { enabled: false }     // Optional: remove tooltips too
            //             },
            //             scales: {
            //                 x: {
            //                     display: false,              // â Hide entire X axis (grid, ticks, border)
            //                 },
            //                 y: {
            //                     display: false               // â Hide entire Y axis (grid, ticks, border)
            //                 }
            //             }
            //         }
            //     });
            //     // Update text values
            //     const totalUsers = values.reduce((sum, val) => sum + val, 0);
            //     const increase = totalUsers - values[0];
            //     if (increase) {
            //         document.querySelector('.metric-info p').textContent = totalUsers.toLocaleString();
            //         document.querySelector('.metric-increase span').textContent = `+${increase}`;
            //     }
            // });
        },

        getRow: function (ticket) {
            if (ticket) {
                const status_clr = ticket.status_color || "#bfa195";
                const status_bg = this.lightenColor(status_clr, 40);
                console.log("ticket.status_name", ticket.status_name)
                return `<tr data-ticket-id="${ticket.id}">
                    <td class="sb-td-id">#T${ticket.id}</td>
                    <td class="sb-td-subject">${ticket.subject}</td>
                    <td class="sb-td-tags">${ticket.assigned_to_name || "--"}</td>
                    <td>${SBF.beautifyTime(ticket.creation_time, true)}</td>
                    <td class="sb-td-status">
                        <span class="span-border" style="
                            color: ${status_clr};
                            background: ${status_bg};
                        ">${ticket.status_name == "Open" ? sb_("Open") : ticket.status_name == "Closed" ? sb_("Closed") : ticket.status_name == "Answered" ? sb_("Answered") : ticket.status_name == "In Progress" ? sb_("In Progress") : ticket.status_name == "Hold" ? sb_("Hold") : ""}</span>
                    </td>
                </tr>`;
            } else {
                SBF.error('Ticket not of type SBTicket', 'SBTicket.getRow');
                return false;
            }
        },

        populate: function (response) {
            let code = '';
            let count = response.length;

            if (count) {
                const limit = Math.min(count, 5);
                for (let i = 0; i < limit; i++) {
                    code += this.getRow(response[i]);
                }

            }
            else {
                code += `<tr class=""><td colspan="4" style="text-align: center;"><strong>No Ticket found</strong></td></tr>`;
            }
            // tickets_table.parent().scrollTop(0);
            tickets_area_dash.find('tbody').html(code);
        },
    }


    /*
    *
    * ----------------------------------------------------------
    * Tickets
    * 
    */

    var SBTicket = {
        category_list: [],
        page_url: false,
        ticket_status: 'all',
        quill: false,
        quillForTicketDetail: false,
        quillForTicketInternalNote: false,
        datetime_last_comment: false,
        new_comment_count: [],
        new_ticket_count: [],
        last_comment_date: '',

        // Get all profile settings
        getAll: function (ticket_area) {
            return SBForm.getAll(ticket_area);
        },


        get: function (onSuccess, ticket_id = false, categories = false, full = true, language = false) {
            SBF.ajax({
                function: 'get-tickets',
                id: ticket_id,
                ticket_status: this.ticket_status,
                categories: categories,
                tickets_language: language,
                full: full,
                user_id: false
            }, (response) => {
                onSuccess(response);
                //SBTicket.populate();
                this.populate(response);
            });
        },
        getLatestFiveCustomers: function () {
            return new Promise((resolve, reject) => {
                SBF.ajax(
                    { function: 'get-latest-five-customers' },
                    (response) => {
                        resolve(response); // Resolve the promise with the response
                    },
                    (error) => {
                        console.error("Error fetching custom fields:", error);
                        reject(error); // Reject on error
                    }
                );
            });
        },
        fetchUsers: async function () {
            try {
                // now `users` is ready for use
                const response = await this.getLatestFiveCustomers();

                // Format and store in `users` variable
                const users = response.map(user => ({
                    id: user.id,
                    first_name: user.first_name || '',
                    last_name: user.last_name || '',
                    email: user.email || ''
                }));
                return users;
            } catch (error) {
                console.error("Error fetching users:", error);
                return [];
            }
        },


        getCustomFields: function () {
            return new Promise((resolve, reject) => {
                SBF.ajax(
                    { function: 'get-tickets-custom-fields' },
                    (response) => {
                        resolve(response); // Resolve the promise with the response
                    },
                    (error) => {
                        console.error("Error fetching custom fields:", error);
                        reject(error); // Reject on error
                    }
                );
            });
        },

        loadCustomFields: async function (action) {
            try {
                const fields = await this.getCustomFields(); // Wait for the async response
                let container;
                if (action == 'add') {
                    container = ticket_edit_box.find('#ticketCustomFieldsContainer');
                }
                else {
                    container = $('.sb-area-ticket-detail #custom-fields');
                }
                let fieldHtml = '';
                fields.forEach(field => {
                    fieldHtml += this.getFieldHtml(field);
                });
                // $(container).html('');
                container.html(fieldHtml);
            } catch (error) {
                console.error("Error loading custom fields:", error);
            }
        },

        getFieldHtml: function (field) {
            let html = `<div id="${field.title}" data-type="${field.type}" class="sb-input">`;
            html += `<span  class="${field.required == '1' ? 'required-label' : ''}">${field.title}</span>`;

            switch (field.type) {
                case 'text':
                    html += `<input type="text" class="form-control" id="custom_${field.id}" data-id="custom_${field.id}" 
                                    name="${field.title}" 
                                    ${field.required == '1' ? 'required' : ''} 
                                    placeholder="${field.title}">`;
                    break;

                case 'textarea':
                    html += `<textarea class="form-control" id="custom_${field.id}" dataid="custom_${field.id}" 
                                        name="custom_fields[${field.id}]" 
                                        rows="3" 
                                        ${field.required == '1' ? 'required' : ''} 
                                        placeholder="${field.title}"></textarea>`;
                    break;

                case 'select':
                    // Split options by comma and trim whitespace
                    const options = (field.options || '').split('|').map(opt => opt.trim()).filter(opt => opt);
                    html += `<select class="form-control" id="custom_${field.id}" dataid="custom_${field.id}" 
                                    name="custom_fields[${field.id}]" 
                                    ${field.required == '1' ? 'required' : ''}>`;
                    html += '<option value="">Select ' + field.title + '</option>';
                    options.forEach(option => {
                        html += `<option value="${option}">${option}</option>`;
                    });
                    html += '</select>';
                    break;

                case 'checkbox':
                    html += `<div class="form-check">
                                <input class="form-check-input" type="checkbox" id="custom_${field.id}" dataid="custom_${field.id}" 
                                        name="custom_fields[${field.id}]" 
                                        value="1" 
                                        ${field.required == '1' ? 'required' : ''}>
                                <label class="form-check-label" for="custom_${field.id}">${field.title}</label>
                            </div>`;
                    break;
            }
            html += '</div>';
            return html;
        },

        getTicketID: async function (conversation_id2) {
            return new Promise((resolve, reject) => {
                SBF.ajax({
                    function: 'get-ticket-id-from-conversation-id',
                    conversation_id: conversation_id2
                }, (response) => {
                    if (response && response.id) {
                        resolve(response.id);
                    }
                    else {
                        resolve('');
                    }
                }, (error) => {
                    reject(error);
                });
            });
        },

        filter: function (ticket_status) {
            this.ticket_status = ticket_status;
            tickets_pagination = 1;
            tickets_pagination_count = 1;
            this.get((response) => {
                this.populate(response);
            }, user_type[0] == 'online');
        },


        show: async function (ticket_id) {

            const container = document.querySelector('#ticketdescription');
            //  If Quill already exists on this element, destroy it
            if (!this.quill) {
                this.quill = new Quill(container, {
                    theme: 'snow',
                    placeholder: 'Compose something...',
                });
            }

            SBTicket.quill.setContents('');

            loadingGlobal();
            await this.loadCustomFields('edit');

            ticket_edit_box.find('.sb-top-bar .sb-ticket span').html(sb_('Edit ticket'));
            ticket_edit_box.find('.sb-top-bar .sb-save').html(`<i class="sb-icon-check"></i>${sb_('Edit Ticket')}`);
            ticket_edit_box.find('input,select,textara').removeClass('sb-error');
            ticket_edit_box.removeClass('sb-cloud-admin');
            SBTicket.clear(ticket_edit_box);
            //SBTicket.updateRequiredFields('ticket');
            ticket_edit_box.sbShowLightbox();

            SBF.ajax({
                function: 'edit-ticket',
                ticket_id: ticket_id
            }, (response) => {
                // Update form fields
                let parent = document.getElementById("subject");
                let child = document.querySelector('#subject input');;
                child.value = response.id;

                // Update form fields
                document.querySelector('#subject input').value = response.subject;
                document.querySelector('#contact_id select').value = response.contact_id;


                if (response.contact_id == 0) {
                    document.querySelector('#without_contact input').checked = true;
                }
                else {
                    document.querySelector('#without_contact input').checked = false;
                    // use your existing data when editing
                    const selectedContactId = response.contact_id;
                    const selectedContactName = response.contact_name; // This is what will be shown

                    // Create a new Option and append it to Select2
                    const contactOption = new Option(selectedContactName, selectedContactId, true, true);
                    $('#contact_id select').append(contactOption).trigger('change');
                }

                // use your existing data when editing
                const selectedUserId = response.assigned_to;
                const selectedUserName = response.assigned_to_name; // This is what will be shown

                // Create a new Option and append it to Select2
                const userOption = new Option(selectedUserName, selectedUserId, true, true);
                $('#assigned_to select').append(userOption).trigger('userOption');

                document.querySelector('#cust_name input').value = response.contact_name;
                document.querySelector('#cust_email input').value = response.contact_email;
                document.querySelector('#priority_id select').value = response.priority_id;
                //document.querySelector('#service_id select').value = response.service_id;
                if (document.querySelector('#department_id select') && response.department_id) {
                    document.querySelector('#department_id select').value = response.department_id;
                }
                document.querySelector('#status_id select').value = response.status_id;
                //document.querySelector('#cc select').value = response.status_id;
                if (document.querySelector('#tags select') && response.tags) {
                    document.querySelector('#tags select').value = response.tags;
                }

                const delta = JSON.parse(response.description); // Convert back to object
                SBTicket.quill.setContents(delta); // 
                document.querySelector('#ticket_id').value = response.id;

                if (response.conversation_id) {
                    $('#conversation_id_div').removeClass('d-none');
                    $('#conversation_id_div label span').html('#' + response.conversation_id);
                    $('#conversation_id').val(response.conversation_id);
                }
                else {
                    $('#conversation_id_div').addClass('d-none');
                    $('#conversation_id_div label span').html('');
                }


                Object.entries(response.custom_fields).forEach(([key, value]) => {
                    const fieldElement = document.querySelector("#ticketCustomFieldsContainer #custom_" + key);
                    if (fieldElement) {
                        const type = fieldElement.getAttribute('data-type');
                        if (type === 'checkbox') {
                            fieldElement.checked = value === '1';
                        } else {
                            fieldElement.value = value;
                        }
                    }
                });

                // let attachmentsHtml = '';
                // Object.entries(response.attachments).forEach(([key, value]) => {
                //     attachmentsHtml += `<div class="col-md-2 mb-2">
                //                             <div class="card">
                //                                 <div class="card-body p-2">
                //                                     <div class="text-center mb-2">
                //                                         <img src="script/${value.file_path}" class="img-thumbnail" style="max-height: 100px;" alt="${value.original_filename}">
                //                                     </div>
                //                                     <div class="d-flex align-items-center">
                //                                         <div class="flex-grow-1 text-truncate">
                //                                             <div class="text-truncate">${value.original_filename}</div>
                //                                             <small class="text-muted">${value.file_size}</small>
                //                                         </div>
                //                                         <button type="button" class="btn btn-sm btn-danger delete-attachment" data-index="0" data-id="${value.id}" data-ticket-id="${ticket_id}">
                //                                             <i class="bi bi-x"></i>
                //                                         </button>
                //                                     </div>
                //                                 </div>
                //                             </div>
                //                         </div>`;

                // });

                // $('#existing-file-preview-container #current-attachments').html('');
                // $('#existing-file-preview-container').addClass('d-none');
                // if (attachmentsHtml != '') {
                //     $('#existing-file-preview-container').removeClass('d-none');
                //     $('#existing-file-preview-container #current-attachments').html(attachmentsHtml);
                // }

                // //// Clear unsaved attachements preview
                // $('#file-preview-container #file-preview-list').html('');
                // $('#uploaded_files').val('');

            });

            /*activeUser().update(() => {
                this.populate(activeUser(), profile_box.find('.sb-profile-list'));
                profile_box.find('.sb-profile').setProfile();
                activeUser().getConversations((response) => {
                    let user_type = activeUser().type;
                    let html = activeUser().getConversationsCode(response);
                    if (SBF.isAgent(user_type)) {
                        this.agentData();
                    }
                    profile_box.find('.sb-user-conversations').html(html).prev().setClass('sb-hide', !html);
                    profile_box.find('.sb-top-bar [data-value]').sbActive(false);
                    if (!SBF.null(activeUser().get('email'))) {
                        profile_box.find('.sb-top-bar [data-value="email"]').sbActive(true);
                    }
                    if (activeUser().getExtra('phone')) {
                        if (SB_ADMIN_SETTINGS.sms) {
                            profile_box.find('.sb-top-bar [data-value="sms"]').sbActive(true);
                        }
                        profile_box.find('.sb-top-bar [data-value="whatsapp"]').sbActive(true);
                    }
                    this.boxClasses(profile_box, user_type);
                    profile_box.attr('data-user-id', activeUser().id).sbShowLightbox();
                    loadingGlobal(false, false);
                    SBF.event('SBProfileBoxOpened', { user_id: user_id });
                });
                users[user_id] = activeUser();
                if (SBF.getURL('user') != user_id && !SBF.getURL('conversation')) {
                    pushState('?user=' + user_id);
                }
            });*/
        },

        add: function () {
            let nav = articles_area.find('.ul-articles');
            nav.find('.sb-active').sbActive(false);
            nav.append(`<li class="sb-active"></li>`);
            articles_content.sbLanguageSwitcher([], 'articles');
            this.clear();
        },

        clear: function () {
            articles_content.removeAttr('data-id').removeClass('sb-hide');
            articles_content.find('input, textarea, select').val('');
            articles_content.find('input').prop('checked', false);
            editorJSLoad();
            this.viewButton();
            articles_save_required = false;
        },

        delete: function (article_id, onSuccess = false) {
            SBF.ajax({
                function: 'save-article',
                article: JSON.stringify({ id: article_id, delete: true })
            }, (response) => {
                this.clear();
                if (onSuccess) {
                    onSuccess(response);
                }
            });
        },
        getStatusesList: function () {
            let statusList = $('#ticket_statues ul').clone();
            statusList.find('li').each(function () {
                const color = $(this).data('color');
                const bgColor = SBDashboard.lightenColor(color, 40);

                $(this).css({
                    'color': color,
                    'background-color': bgColor
                });
                $(this).find('span').css({
                    'background-color': color
                });
            });
            return statusList.show().prop('outerHTML');
        },
        getPrioritiesList: function () {
            let statusList = $('#ticket_priorities ul').clone();
            statusList.find('li').each(function () {
                const color = $(this).data('color');
                const bgColor = SBDashboard.lightenColor(color, 40);

                $(this).css({
                    'color': color,
                    'background-color': bgColor
                });
                $(this).find('span').css({
                    'background-color': color
                });
            });
            return statusList.show().prop('outerHTML');
        },
        updateTicketStatus: function (ticket_id, ticketStatus) {
            SBF.ajax({
                function: 'update-ticket-status',
                ticket_id: ticket_id,
                ticketStatus: ticketStatus,
            }, (response) => {
                if (response.success) {
                    infoBottom('Ticket status updated successfully.');
                }
            });
        },
        updateTicketPriority: function (ticket_id, ticketPriority) {
            SBF.ajax({
                function: 'update-ticket-priority',
                ticket_id: ticket_id,
                ticketPriority: ticketPriority,
            }, (response) => {
                if (response.success) {
                    infoBottom('Ticket priority updated successfully.');
                }
            });
        },
        ticketRowNotificationCounter: function (ticketId) {
            const newTicketCount = SBTicket.new_ticket_count[ticketId]?.length || 0;
            const newCommentsCount = SBTicket.new_comment_count[ticketId]?.length || 0;
            const totalCount = newTicketCount + newCommentsCount;

            if (totalCount > 0) {
                const tooltip = `${newTicketCount ? `${newTicketCount} new ticket${newTicketCount > 1 ? 's' : ''}` : ''}${newTicketCount && newCommentsCount ? ', ' : ''}${newCommentsCount ? `${newCommentsCount} new comment${newCommentsCount > 1 ? 's' : ''}` : ''}`;

                return `<span class="sb-notification-counter" title="${tooltip}">${totalCount}</span>`;
            } else {
                return '';
            }
        },
        ticketsMenuNotificationCounter: function () {
            let newTicketCount = 0;
            let newCommentsCount = 0;

            for (const id in SBTicket.new_ticket_count) {
                if (Array.isArray(SBTicket.new_ticket_count[id])) {
                    newTicketCount += SBTicket.new_ticket_count[id].length;
                }
            }

            for (const id in SBTicket.new_comment_count) {
                if (Array.isArray(SBTicket.new_comment_count[id])) {
                    newCommentsCount += SBTicket.new_comment_count[id].length;
                }
            }

            const totalCount = newTicketCount + newCommentsCount;

            $('#sb-tickets').next('.sb-notification-counter').remove();

            if (totalCount > 0) {
                const tooltip = `${newTicketCount ? `${newTicketCount} new ticket${newTicketCount > 1 ? 's' : ''}` : ''}${newTicketCount && newCommentsCount ? ', ' : ''}${newCommentsCount ? `${newCommentsCount} new comment${newCommentsCount > 1 ? 's' : ''}` : ''}`;

                $('#sb-tickets').after(`<span class="sb-notification-counter" title="${tooltip}">${totalCount}</span>`);
            }
        },
        getRow: function (ticket) {
            if (ticket) {
                const status_bg = SBDashboard.lightenColor(ticket.status_color, 40);
                const priority_bg = SBDashboard.lightenColor(ticket.priority_color, 40);
                let code = '';

                let rowHtml = `<tr data-ticket-id="${ticket.id}">
                <td data-order="${ticket.id}">#T${ticket.id}
                    ${ticket.conversation_id ? `<a class="ml-2" style="text-decoration:underline;" href="?conversation=${ticket.conversation_id}" target="_blank">#C${ticket.conversation_id}</a>` : ''}
                    ${this.ticketRowNotificationCounter(ticket.id)}
                </td>
                <td class="sb-td-subject">${ticket.subject}</td>`;
                if (tickets_table.find('th[data-field="tags"]').length) {
                    rowHtml += `<td class="sb-td-tags">`;
                    ticket.ticket_tags.forEach(tag => {
                        const ctx = document.createElement("canvas").getContext("2d");
                        ctx.fillStyle = tag.color;
                        const validColor = ctx.fillStyle;
                        const tags_lighten = SBDashboard.lightenColor(validColor, 40);
                        // const style = `
                        //     background-color: ${tags_lighten};
                        //     color: ${validColor === "#ffff00" ? "#FFA500" : validColor};
                        //     /*border: 1px solid ${validColor === "#ffff00" ? "#FFA500" : validColor};*/
                        //     margin-right: 5px;
                        // `;
                        rowHtml += `<span class="badge badge-tag" data-color=${tag.color}>${tag.name}</span>`;

                    });
                    rowHtml += `</td>`;
                }

                if (tickets_table.find('th[data-field="department"]').length) {
                    rowHtml += `<td class="sb-td-department">${ticket.department ?? 'N/A'}</td>`;
                }
                rowHtml += `<td class="sb-td-contact"><p>${ticket.customer_name ?? 'Guest'}</p></td>
                <td class="sb-td-status1 no-click status-dropdown">

                <div class="dropdown">
                    <button class="btn btn-sm dropdown-toggle currentStatusBtn" data-id="${ticket.id}" style="background-color: ${SBDashboard.lightenColor(ticket.status_color, 40)};color: ${ticket.status_color}">
                        ${ticket.status_name}
                    </button>
                    ${this.getStatusesList()}
                </div>
                    
                </td>
                <td class="sb-td-priority no-click status-dropdown">
                <div class="dropdown">
                    <button class="btn btn-sm dropdown-toggle currentPriorityBtn" data-id="${ticket.id}" style="background-color: ${SBDashboard.lightenColor(ticket.priority_color, 40)};color: ${ticket.priority_name}">${ticket.priority_name}</button>
                    ${this.getPrioritiesList()}
                </div>
                </td>
                <td class="sb-td-last_reply">${ticket.assigned_to_name ?? ''} ${ticket.user_type ? '(' + ticket.user_type + ')' : ''}</td>
                <td>${SBF.beautifyTime(ticket.creation_time, true)}</td>
                </tr>`;

                return rowHtml;
            } else {
                SBF.error('Ticket not of type SBTicket', 'SBTicket.getRow');
                return false;
            }
        },

        updateRow: function (ticket) {
            let row = tickets_table.find(`[data-ticket-id="${ticket.id}"]`);
            if (row.length) {
                row.replaceWith(this.getRow(ticket));
            }
            else {
                if (tickets_table.find('.sb-no-results').length) {
                    tickets_table.find('.sb-no-results').remove();
                }
                tickets_table.find('tbody').append(this.getRow(ticket));
            }
        },

        updateMenu: function (action = 'all', type = false) {
            let ticket_status = ['all', 'open', 'in-progress', 'hold', 'answered', 'closed'];
            if (action == 'all') {
                SBF.ajax({
                    function: 'count-tickets',
                }, (response) => {
                    for (var i = 0; i < ticket_status.length; i++) {
                        this.updateMenuItem('set', ticket_status[i] || 0, response[ticket_status[i]] || 0);
                    }
                });
            } else {
                this.updateMenuItem(action, type);
            }
        },

        updateMenuItem: function (action = 'set', type = false, count = 1) {
            let item = tickets_table_menu.find(`[data-type="${type}"] span`);
            let ticket_status = ['all', 'open', 'in-progress', 'hold', 'answered', 'closed'];
            if (action != 'set') {
                count = parseInt(item.attr('data-count')) + (1 * (action == 'add' ? 1 : -1));
            }
            item.html(`(${count})`).attr('data-count', count);
            count = 0;
            for (var i = 0; i < ticket_status.length; i++) {
                count += parseInt(tickets_table_menu.find(`[data-type="${ticket_status[i]}"] span`).attr('data-count'));
            }
        },

        populate: function (response) {
            let code = '';
            let count = response.length;
            if (count) {
                for (var i = 0; i < count; i++) {
                    code += this.getRow(response[i]);
                }
            } else {
                code = `<p class="sb-no-results">${sb_('No Ticket found.')}</p>`;
            }

            tickets_table.parent().scrollTop(0);

            // Save current page if DataTable already exists
            let currentPage = 0;
            if ($.fn.DataTable.isDataTable(tickets_table)) {
                currentPage = tickets_table.DataTable().page();
                tickets_table.DataTable().destroy();
            }

            tickets_table.find('tbody').html(code);

            // Reinitialize DataTable
            const dt = tickets_table.DataTable({
                pageLength: 10,
                responsive: true,
                order: [[0, 'desc']],
                language: {
                    emptyTable: sb_('No tickets available')
                },
                columnDefs: [
                    { orderable: false, targets: 0 }
                ]
            });
            // Restore previous page (if still valid)
            if (count > 0) {
                dt.page(currentPage).draw('page');
            }
        },
        formatDateLabel: function (dateString) {
            const date = new Date(dateString.replace(' ', 'T'));
            const today = new Date();
            const yesterday = new Date();
            yesterday.setDate(today.getDate() - 1);
            const isToday = date.toDateString() === today.toDateString();
            const isYesterday = date.toDateString() === yesterday.toDateString();
            if (isToday) return 'Today';
            if (isYesterday) return 'Yesterday';
            return date.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
        },
        formatTimeTo12Hour: function (dateString) {
            const date = new Date(dateString.replace(' ', 'T'));
            let hours = date.getHours();
            let minutes = date.getMinutes();
            const ampm = hours >= 12 ? 'pm' : 'am';
            hours = hours % 12;
            hours = hours ? hours : 12; // 0 => 12
            minutes = minutes < 10 ? '0' + minutes : minutes;
            return hours + ':' + minutes + ' ' + ampm;
        },
        canEditComment: function (createdAt) {
            // Use server time injected by PHP for accuracy
            const serverNow = window.SERVER_NOW ? new Date(window.SERVER_NOW) : new Date();
            const commentTime = new Date(createdAt.replace(' ', 'T'));
            const diffMs = serverNow - commentTime;
            const diffMin = diffMs / (1000 * 60);
            return diffMin >= 0 && diffMin <= 10;
        },
        escapeHtml: function (text) {
            var map = {
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function (m) { return map[m]; });
        },
        renderComment: function (comment) {
            const currentUserId = document.getElementById('currentUserId').value;
            const isAgent = comment.user_role === 'agent';
            const isOwn = comment.user_id == currentUserId;
            const rowClass = isAgent ? 'agent' : 'customer';
            // Avatar
            const avatarUrl = comment.profile_image;
            // Bubble
            let html = `<div class="comment-row ${rowClass}">
                <img loading="lazy" src="${avatarUrl}" class="comment-avatar" alt="avatar" data-name="${comment.user_name}">
                <div class="user-initials" data-value="edit-profile" style="display: none;"><span class="initials"></span></div>
                <div class="comment-bubble">
                    <div class="comment-text" data-id="${comment.id}">${this.escapeHtml(comment.comment)}</div>
                    <div class="comment-meta">
                        <span>${SBF.beautifyTime(comment.created_at)}</span>`;
            if (comment.is_edited == 1 || comment.is_edited === "1") {
                html += `<span class="edited-label" title="Edited">&nbsp;â</span>`;
            }

            // Show Edit button only if own comment and within 10 minutes
            if (isOwn && this.canEditComment(comment.created_at)) {

                html += `<button class="edit-comment-btn" data-id="${comment.id}">Edit</button>`;
            }
            if (isOwn) {
                html += `<button class="delete-comment-btn" data-id="${comment.id}">Delete</button>`;
            }
            html += `</div>
                </div>
            </div>`;
            return html;
        },

        loadComments: function (ticket_id, last_update_date = null) {
            SBF.ajax({
                function: 'get-ticket-comments',
                ticket_id: ticket_id,
                last_update_date: last_update_date
            }, (response) => {
                const commentsSection = $(`.sb-area-ticket-detail[data-id=${ticket_id}] #comments-section`);
                if (response.comments && response.comments.length > 0) {

                    if (response.comments[0].last_update_time) {
                        this.datetime_last_comment = response.comments[0].last_update_time;
                    }

                    if (response.server_now) {   /// update window.SERVER_NOW time to use in canEditComment function
                        window.SERVER_NOW = response.server_now;
                    }
                    // Group comments by date
                    ////let lastDate = '';
                    let html = '';
                    response.comments.forEach(comment => {
                        const commentDate = comment.created_at.split(' ')[0];
                        if (commentDate !== this.last_comment_date) {
                            html += `<div class='text-center my-2'><span class='badge bg-secondary' style='font-size:13px;'>${this.formatDateLabel(comment.created_at)}</span></div>`;
                            this.last_comment_date = commentDate;
                        }
                        html += this.renderComment(comment);
                    });

                    if (last_update_date) {
                        commentsSection.append(html);
                    }
                    else {
                        commentsSection.html(html);
                    }

                    setTimeout(() => {
                        const el = commentsSection[0]; // or get(0)
                        el.scrollTo({ top: el.scrollHeight, behavior: 'smooth' });
                    }, 0);

                    showInitials('tc_back', 'comment-row');
                    //scrollToBottom();
                    // attachEditListeners();
                }
                else {
                    commentsSection.html('<div class="text-center text-muted">No comments yet.</div>');
                }
            });
        },

        openTicket: async function (ticket_id) {

            // 1. Clear notification data
            if (SBTicket.new_ticket_count) {
                delete SBTicket.new_ticket_count[ticket_id];
            }
            if (SBTicket.new_comment_count) {
                delete SBTicket.new_comment_count[ticket_id];
            }
            // 2. Refresh ticker menu notification counter
            this.ticketsMenuNotificationCounter();
            // 3. Remove the counter span (inside the clicked row)
            $('.sb-table-tickets tr[data-ticket-id="' + ticket_id + '"] td:first .sb-notification-counter').remove();


            const container = document.querySelector('#ticketDescriptionTicketDetail');
            //  If Quill already exists on this element, destroy it
            if (!this.quillForTicketDetail) {
                this.quillForTicketDetail = new Quill(container, {
                    theme: 'snow',
                    placeholder: 'Compose something...',
                    modules: {
                        toolbar: [
                            ['bold', 'italic', 'underline'],
                            [{ 'list': 'ordered' }, { 'list': 'bullet' }], // explicitly separate
                            ['link', 'image']
                        ]
                    }
                });
            }

            SBTicket.quillForTicketDetail.setContents('');


            const notesContainer = document.querySelector('#internal-note-t');
            //  If Quill already exists on this element, destroy it
            if (!this.quillForTicketInternalNote) {
                this.quillForTicketInternalNote = new Quill(notesContainer, {
                    theme: 'snow',
                    placeholder: 'Compose something...',
                });
            }

            SBTicket.quillForTicketInternalNote.setContents('');


            // loadingGlobal();
            await this.loadCustomFields('edit');


            await SBF.ajax({
                function: 'edit-ticket',
                ticket_id: ticket_id
            }, (response) => {
                // debzugger

                const encodedStr = response.subject;
                const temp = document.createElement('textarea');
                temp.innerHTML = encodedStr;
                const decodedStr = temp.value;

                document.querySelector('.sb-area-ticket-detail .tc_back .tno').innerHTML = 'TR' + response.id;
                document.querySelector('.sb-area-ticket-detail .tc_back #ticket-subject').value = decodedStr;
                document.querySelector('.sb-area-ticket-detail .tc_back .ticket-status-dropdown').value = response.status_id;
                //document.querySelector('.sb-area-ticket-detail .tc_back .sidepanel .ticket-assignee span').innerHTML = response.assigned_to_name || 'Unassigned';
                document.querySelector('.sb-area-ticket-detail .tc_back .sidepanel .ticket-reporter .name').innerHTML = response.contact_name || 'Unassigned';



                // if (!response.contact_id) {
                //     document.querySelector('.sidepanel .without-contact input').checked = true;
                // }
                // else {
                //     document.querySelector('.sidepanel .without-contact input').checked = false;
                // }

                document.querySelector('.sb-area-ticket-detail .tc_back .sidepanel .assignee-img').src = response.profile_image || '';
                $('.sb-area-ticket-detail .tc_back .sidepanel .ticket-assignee .assignee-img').src = response.c_profile_image || '';

                $('.sb-area-ticket-detail .tc_back .sidepanel .ticket-assignee .assignee-img').attr('data-name', response.assigned_to_name);
                $('.sb-area-ticket-detail .tc_back .sidepanel .ticket-reporter .reporter-img').attr('data-name', response.contact_name);
                showInitials('sidepanel', 'mb-3');


                document.querySelector('.sb-area-ticket-detail .tc_back .sidepanel .conversation-id span').innerHTML = response.conversation_id ? `<a  style="text-decoration:underline;" href="?conversation=${response.conversation_id}" target="_blank">#${response.conversation_id} </a>` : '';
                if (response.conversation_id)
                    document.querySelector('.sb-area-ticket-detail .tc_back .sidepanel .conversation-id').classList.remove('d-none')

                const delta = JSON.parse(response.description); // Convert back to object
                SBTicket.quillForTicketDetail.setContents(delta);

                //const notes = JSON.parse(response.notes); // Convert back to object
                //SBTicket.quillForTicketInternalNote.setContents(notes);


                const notes = JSON.parse(response.notes); // Convert back to object

                if (notes && notes.ops && Array.isArray(notes.ops)) {
                    const partial = notes.ops.slice(0, 1000); // first 1000 operations
                    SBTicket.quillForTicketInternalNote.setContents({ ops: partial });
                } else {
                    console.warn("Invalid Quill Delta format");
                }

                // use your existing data when editing
                const selectedUserId = response.assigned_to;
                const selectedUserName = response.assigned_to_name; // This is what will be shown

                // Create a new Option and append it to Select2
                const userOption = new Option(selectedUserName, selectedUserId, true, true);
                $('#select-ticket-agent').append(userOption).trigger('userOption');

                if (response.contact_id) {
                    // use your existing data when editing
                    const selectedReporterId = response.contact_id;
                    const selectedReporterName = response.reporter_name; // This is what will be shown

                    // Create a new Option and append it to Select2
                    const reporterOption = new Option(selectedReporterName, selectedReporterId, true, true);
                    $('#select-ticket-reporter').append(reporterOption).trigger('reporterOption');
                    $('.sb-area-ticket-detail .tc_back .sidepanel #reporter').removeClass('d-none');
                    $('.sb-area-ticket-detail .tc_back .sidepanel .ticket-reporter .name').addClass('d-none');

                }

                // Select multiple values programmatically
                if (response.tag_names)
                    response.tag_names.split('||').forEach(val => ticketTagsFilterChoices.setChoiceByValue(val));

                if (document.querySelector('.sb-area-ticket-detail #ticket-department') && response.department_id) {
                    document.querySelector('.sb-area-ticket-detail #ticket-department').value = response.department_id;
                }
                document.querySelector('.sb-area-ticket-detail .tc_back #ticket-priority').value = response.priority_id;

                let attachmentsHtml = '';
                const filesCount = Object.entries(response.attachments).length;
                Object.entries(response.attachments).forEach(([key, value]) => {
                    attachmentsHtml += `<div class="col-md-2 mb-2">
                                            <div class="card">
                                                <div class="card-body p-2">
                                                    <div class="text-center mb-2">
                                                        <img src="script/${value.file_path}" class="img-thumbnail p-0" style="max-height: 100px;" alt="${value.original_filename}">
                                                    </div>
                                                    <div class="d-flex align-items-center">
                                                        <div class="flex-grow-1 text-truncate">
                                                            <div class="text-truncate">${value.original_filename}</div>
                                                            <small class="text-muted">${value.file_size}</small>
                                                        </div>
                                                        <button type="button" class="btn btn-sm btn-danger delete-attachment" data-index="0" data-id="${value.id}" data-ticket-id="${ticket_id}">
                                                            <i class="bi bi-x"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>`;

                });

                if (attachmentsHtml != '') {
                    $('#existing-file-preview-container').removeClass('d-none');
                    $('#existing-file-preview-container #current-attachments').html(attachmentsHtml);
                    $('#view-ticket-attachments .attachments-count').html(filesCount);
                }


                Object.entries(response.custom_fields).forEach(([key, value]) => {
                    const fieldElement = document.querySelector("#custom-fields #custom_" + key);
                    if (fieldElement) {
                        const type = fieldElement.getAttribute('data-type');
                        if (type === 'checkbox') {
                            fieldElement.checked = value === '1';
                        } else {
                            fieldElement.value = value;
                        }
                    }
                });

                this.loadComments(ticket_id);
                loadingGlobal(false);

            });
        },

        openTicketArea: function (ticket_id) {
            $('#ticket_id_d').val(ticket_id);
            SBTicket.openTicket(ticket_id);
            if (SBF.getURL('ticket') != ticket_id && ticket_id != -1) {
                pushState('?ticket=' + ticket_id);
            }
            admin.find(' > main > div').sbActive(false);
            $('.sb-area-ticket-detail').sbActive(true);
            $('.sb-area-ticket-detail').attr('data-id', ticket_id);
            //// change header title dynamically
            $('.sb-area-ticket-detail .header-left .title').html(sb_("Ticket") + ' ' + sb_("detail"));
            $('.sb-area-ticket-detail .header-left .ticket-back-btn').removeClass('d-none');
        },

        activeID: function (is_parent = false) {
            return is_parent ? articles_area.find('.ul-articles .sb-active').attr('data-id') : articles_content.attr('data-id');
        },

        viewButton: function (article_id = false) {
            if (this.page_url) {
                let button = articles_area.find('.sb-view-article');
                button.attr('href', article_id ? this.page_url + (this.is_url_rewrite ? (this.page_url.charAt(this.page_url.length - 1) == '/' ? '' : '/') + (this.cloud_chat_id ? this.cloud_chat_id + '/' : '') : '?article_id=') + article_id : '');
            }
        },

        // Clear the profile edit area
        clear: function (ticket_edit_area) {
            SBForm.clear(ticket_edit_area);
        },

        // Check for errors on user input
        errors: function (ticket_edit_area) {
            return SBForm.errors(ticket_edit_area.find('.sb-details'));
        },

        // Display a error message
        showErrorMessage: function (ticket_edit_area, message) {
            SBForm.showErrorMessage(ticket_edit_area, message);
        },

        translations: {
            list: {},

            add: function (language_code, article_id = false) {
                if (!article_id) {
                    article_id = SBArticles.activeID(true);
                }
                let translations = this.get(article_id);
                translations.push([language_code, false]);
                this.list[article_id] = translations;
                articles_content.sbLanguageSwitcher(translations, 'articles', language_code);
                SBArticles.clear();
            },

            delete: function (language_code, article_id = false) {
                if (!article_id) {
                    article_id = SBArticles.activeID(true);
                }
                let translations = this.get(article_id);
                for (var i = 0; i < translations.length; i++) {
                    if (translations[i][0] == language_code) {
                        SBArticles.delete(translations[i][1], (response) => {
                            if (response === true) {
                                translations.splice(i, 1);
                                this.list[article_id] = translations;
                                SBArticles.show(article_id);
                            }
                        });
                        break;
                    }
                }
                return false;
            },

            get: function (article_id) {
                return article_id in this.list ? this.list[article_id] : [];
            }
        }
    }



    /*
    * ----------------------------------------------------------
    * Reports
    * ----------------------------------------------------------
    */

    var SBReports = {
        chart: false,
        active_report: false,
        active_date_range: false,

        initChart: function (data, type = 'line', label_type = 1) {
            let values = [];
            let labels = [];
            let blues = SB_ADMIN_SETTINGS.color ? [SB_ADMIN_SETTINGS.color] : ['#049CFF', '#74C4F7', '#B9E5FF', '#0562A0', '#003B62', '#1F74C4', '#436786'];
            for (var key in data) {
                values.push(data[key][0]);
                labels.push(key);
            }
            if (type != 'line' && values.length > 6) {
                for (var i = 0; i < values.length; i++) {
                    blues.push('hsl(' + 210 + ', ' + Math.floor(Math.random() * 100) + '%, ' + Math.floor(Math.random() * 100) + '%)');
                }
            }
            if (this.chart) {
                this.chart.destroy();
            }
            const ctx = document.getElementById('canvas');
            const newCtx = ctx.getContext('2d');
            const gradient1 = newCtx.createLinearGradient(0, 0, 0, +ctx.height * 3);
            gradient1.addColorStop(0, '#1158fa');
            gradient1.addColorStop(1, '#e1e8f7');

            this.chart = new Chart(newCtx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: values && Array.isArray(values[0]) ? [
                        {
                            data: values.map(row => row[0]),
                            backgroundColor: gradient1,
                            borderColor: type === 'line' ? (SB_ADMIN_SETTINGS.color ? SB_ADMIN_SETTINGS.color : '#1459C6') : '#FFFFFF',
                            borderWidth: 0.1,
                        },
                        {
                            data: values.map(row => row[1]),
                            backgroundColor: gradient1,
                            borderColor: type === 'line' ? (SB_ADMIN_SETTINGS.color ? SB_ADMIN_SETTINGS.color : '#1459C6') : '#FFFFFF',
                            borderWidth: 0.1,
                        }
                    ] : [{
                        data: values,
                        backgroundColor: gradient1,
                        borderColor: type === 'line' ? (SB_ADMIN_SETTINGS.color ? SB_ADMIN_SETTINGS.color : '#1459C6') : '#FFFFFF',
                        borderWidth: 0.1,
                        pointRadius: 4,
                        fill: true,
                        tension: 0.5,
                        pointBackgroundColor: '#487FFF'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: true
                            },
                            display: true,
                            ticks: {
                                beginAtZero: true
                            },
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                display: true
                            },
                            display: true,
                            ticks: {
                                callback: function (tickValue, index, ticks) {
                                    return label_type === 1 ? tickValue : (label_type === 2 ? new Date(tickValue * 1000).toISOString().substr(11, 8) : tickValue);
                                },
                            },
                        }
                    },
                    tooltips: {
                        callbacks: {
                            label: function (tooltipItem, chartData) {
                                let index = tooltipItem.index;
                                let value = chartData.datasets[tooltipItem.datasetIndex].data[index];
                                switch (label_type) {
                                    case 1: return value;
                                    case 2: return new Date(values[index] * 1000).toISOString().substr(11, 8);
                                    case 3: return value + '%';
                                    case 4: let tds = reports_area.find('.sb-table tbody tr').eq(index).find('td'); return tds.eq(0).text() + ' ' + tds.eq(1).text();
                                }
                            },
                        }
                    }
                }
            });
        },

        initTable: function (header, data, inverse = false) {
            let code = '<thead><tr>';
            let index = data[Object.keys(data)[0]].length - 1;
            let list = [];
            for (var i = 0; i < header.length; i++) {
                code += `<th>${header[i]}</th>`;
            }
            code += '</tr></thead><tbody>';
            for (var key in data) {
                if (data[key][index] != 0) {
                    list.push([key, data[key][index]]);
                }
            }
            if (inverse) {
                list.reverse();
            }
            for (var i = 0; i < list.length; i++) {
                code += `<tr><td><div>${list[i][0]}</div></td><td>${list[i][1]}</td></tr>`;
            }
            code += '</tbody>';
            reports_area.find('table').html(code);
        },

        initReport: function (name = false, date_range = false) {
            let area = reports_area.find('.sb-tab > .sb-content');
            date_range = SBF.null(date_range) ? [false, false] : date_range.split(' - ');
            area.sbLoading(true);
            if (name) {
                this.active_report = name;
            }
            if (!this.active_report) {
                return;
            }
            this.active_date_range = date_range;
            this.getData(this.active_report, date_range[0], date_range[1], (response) => {
                if (response == false) {
                    area.addClass('sb-no-results-active');
                } else {
                    area.removeClass('sb-no-results-active');
                    this.initChart(response.data, response.chart_type, response.label_type);
                    this.initTable(response.table, response.data, response.table_inverse);
                    reports_area.find('.sb-reports-title').html(response.title);
                    reports_area.find('.sb-reports-text').html(response.description);
                    reports_area.find('.sb-collapse-btn').remove();
                    if (!responsive) {
                        collapse(reports_area.find('.sb-collapse'), reports_area.find('canvas').outerHeight() - 135);
                    }
                }
                area.sbLoading(false);
            });
        },

        getData: function (name, date_start = false, date_end = false, onSuccess) {
            SBF.ajax({
                function: 'reports',
                name: name,
                date_start: date_start,
                date_end: date_end,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
            }, (response) => {
                onSuccess(response);
            });
        },

        initDatePicker: function () {
            let settings = {
                ranges: {},
                locale: {
                    format: 'DD/MM/YYYY',
                    separator: ' - ',
                    applyLabel: sb_('Apply'),
                    cancelLabel: sb_('Cancel'),
                    fromLabel: sb_('From'),
                    toLabel: sb_('To'),
                    customRangeLabel: sb_('Custom'),
                    weekLabel: sb_('W'),
                    daysOfWeek: [
                        sb_('Su'),
                        sb_('Mo'),
                        sb_('Tu'),
                        sb_('We'),
                        sb_('Th'),
                        sb_('Fr'),
                        sb_('Sa')
                    ],
                    monthNames: [
                        sb_('January'),
                        sb_('February'),
                        sb_('March'),
                        sb_('April'),
                        sb_('May'),
                        sb_('June'),
                        sb_('July'),
                        sb_('August'),
                        sb_('September'),
                        sb_('October'),
                        sb_('November'),
                        sb_('December')
                    ],
                    firstDay: 1
                },
                showCustomRangeLabel: true,
                alwaysShowCalendars: true,
                autoApply: true,
                opens: admin.hasClass('sb-rtl') ? 'left' : 'right'
            };
            settings.ranges[sb_('Today')] = [moment(), moment()];
            settings.ranges[sb_('Yesterday')] = [moment().subtract(1, 'days'), moment().subtract(1, 'days')];
            settings.ranges[sb_('Last 7 Days')] = [moment().subtract(6, 'days'), moment()];
            settings.ranges[sb_('Last 30 Days')] = [moment().subtract(29, 'days'), moment()];
            settings.ranges[sb_('This Month')] = [moment().startOf('month'), moment().endOf('month')];
            settings.ranges[sb_('Last Month')] = [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')];
            reports_area.find('#sb-date-picker').daterangepicker(settings).val('');
        },

        export: function (onSuccess) {
            SBF.ajax({
                function: 'reports-export',
                name: this.active_report,
                date_start: this.active_date_range[0],
                date_end: this.active_date_range[1],
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
            }, (response) => {
                onSuccess(response);
            });
        },

        open: function (id) {
            header.find('.sb-admin-nav #sb-reports').click();
            setTimeout(() => {
                reports_area.find('#' + id).click().get(0).scrollIntoView();
            }, 300);
        }
    }

    /*
    * ----------------------------------------------------------
    * Users
    * ----------------------------------------------------------
    */

    var SBUsers = {
        real_time: null,
        datetime_last_user: '2000-01-01 00:00:00',
        sorting: ['creation_time', 'DESC'],
        user_types: ['visitor', 'lead', 'user'],
        user_main_fields: ['id', 'first_name', 'last_name', 'email', 'password', 'profile_image', 'user_type', 'creation_time', 'token', 'last_activity', 'department'],
        search_query: '',
        init: false,
        busy: false,
        table_extra: false,
        history: [],

        get: function (onSusccess, is_online_users = false, is_users_pagination = false) {
            let filters = [];
            for (var i = 0; i < users_filters.length; i++) {
                filters.push(users_filters.eq(i).find('li.sb-active').data('value'));
            }
            if (!is_users_pagination) {
                loading(users_table);
            }
            SBF.ajax({
                function: is_online_users ? 'get-online-users' : 'get-users',
                sorting: is_online_users ? this.sorting[0] : this.sorting,
                pagination: is_users_pagination ? users_pagination : false,
                user_types: this.user_types,
                search: this.search_query,
                extra: this.table_extra,
                department: filters[0],
                source: filters[1],
                tag: filters[2]
            }, (response) => {
                onSusccess(response);
                users_table.sbLoading(false);
            });
        },

        filter: function (user_type) {
            if (user_type == 'all') {
                user_type = ['visitor', 'lead', 'user'];
            } else if (user_type == 'agent') {
                user_type = ['agent', 'admin'];
            } else {
                user_type = [user_type];
            }
            this.user_types = user_type;
            users_pagination = 1;
            users_pagination_count = 1;
            this.get((response) => {
                this.populate(response);
            }, user_type[0] == 'online');
        },

        sort: function (field, direction = 'DESC') {
            this.sorting = [field, direction];
            users_pagination = 1;
            users_pagination_count = 1;
            this.get((response) => {
                this.populate(response);
            });
        },

        search: function (input) {
            searchInput(input, (search, icon) => {
                users_pagination = 1;
                users_pagination_count = 1;
                this.search_query = search;
                this.get((response) => {
                    this.user_types = ['visitor', 'lead', 'user'];
                    this.populate(response);
                    $(icon).sbLoading(false);
                    users_table_menu.find('li').sbActive(false).eq(0).sbActive(true);
                });
            });
        },

        populate: function (response) {
            let code = '';
            let count = response.length;
            if (count) {
                for (var i = 0; i < count; i++) {
                    code += this.getRow(new SBUser(response[i], response[i].extra));
                }
            } else {
                code = `<p class="sb-no-results">${sb_('No users found.')}</p>`;
            }
            users_table.parent().scrollTop(0);


            // Destroy previous DataTable if exists
            if ($.fn.DataTable.isDataTable(users_table)) {
                users_table.DataTable().destroy();
                users_table.find('tbody').empty(); // Move this AFTER destroy
            }

            users_table.find('tbody').html(code);

            // Reinitialize DataTable
            users_table.DataTable({
                pageLength: 10, // or whatever you want
                responsive: true,
                order: [[0, 'desc']],
                language: {
                    emptyTable: sb_('No users available')
                },
                columnDefs: [
                    { orderable: false, targets: 0 } // 0 = first column (ID)
                ]
                // add more config as needed
            });



            // users_table.find('tbody').html(code);
            if (this.user_types.includes('agent')) {
                SBF.ajax({
                    function: 'get-online-users',
                    agents: true
                }, (response) => {
                    let ids = [];
                    for (var i = 0; i < response.length; i++) {
                        ids.push(response[i].id);
                    }
                    users_table.find('[data-user-id]').each(function () {
                        $(this).find('.sb-td-profile').addClass('sb-' + (ids.includes($(this).attr('data-user-id')) ? 'online' : 'offline'));
                    });
                });
            }
        },

        update: function () {
            if (!this.busy) {
                let checks = ['user', 'visitor', 'lead', 'agent'];
                let populate = checks.includes(this.user_types[0]) && !this.search_query;
                let filter = users_table_menu.find('.sb-active').data('type');
                if (filter == 'online') {
                    this.filter(filter);
                } else {
                    this.busy = true;
                    SBF.ajax({
                        function: 'get-new-users',
                        datetime: this.datetime_last_user
                    }, (response) => {
                        let count = response.length;
                        this.busy = false;
                        if (count > 0) {
                            let code = '';
                            for (var i = 0; i < count; i++) {
                                let user = new SBUser(response[i]);
                                users[user.id] = user;
                                this.updateMenu('add', user.type);
                                if (populate) {
                                    code += this.getRow(user);
                                }
                            }
                            if (populate) {
                                users_table.find('tbody').prepend(code);
                                if (checks.includes(filter)) {
                                    let selector = '';
                                    for (var i = 0; i < checks.length; i++) {
                                        selector += checks[i] == filter ? '' : `[data-user-type="${checks[i]}"],`;
                                    }
                                    users_table.find(selector.slice(0, -1)).remove();
                                }
                            }
                            this.datetime_last_user = response[0].creation_time;
                        }
                    });
                }
            }
        },

        getRow: function (user) {
            if (user instanceof SBUser) {
                let code = '';
                for (var i = 0; i < this.table_extra.length; i++) {
                    let slug = this.table_extra[i];
                    code += `<td class="sb-td-${slug}">${this.user_main_fields.includes(slug) ? user.get(slug) : user.getExtra(slug)}</td>`;
                }
                return `<tr data-user-id="${user.id}" data-user-type="${user.type}"><td><input type="checkbox" /></td><td class="sb-td-profile"><a class="sb-profile"><img loading="lazy" src="${user.image}" data-name="${user.name}"/><div class="user-initials" data-value="edit-profile" style="display: none;"><span class="initials"></span></div><span>${user.name}</span></a></td>${code}<td class="sb-td-email">${user.get('email')}</td><td class="sb-td-ut">${sb_(user.type)}</td><td>${user.get('last_activity') && user.get('last_activity') != 'NULL' ? SBF.beautifyTime(user.get('last_activity'), true) : 'N/A'}</td><td>${SBF.beautifyTime(user.get('creation_time'))}</td></tr>`;
            } else {
                SBF.error('User not of type SBUser', 'SBUsers.getRow');
                return false;
            }
        },

        updateRow: function (user) {
            let row = users_table.find(`[data-user-id="${user.id}"]`);
            if (row.length) {
                let menu_active = users_table_menu.find('.sb-active').data('type');
                if ((user.type != menu_active) && !(user.type == 'admin' && menu_active == 'agent') && menu_active != 'all') {
                    let counter = admin.find(`[data-type="${user.type == 'admin' ? 'agent' : user.type}"] span`);
                    let count = parseInt(counter.attr('data-count'));
                    counter.html(count + 1).attr('data-count', count + 1);
                    row.remove();
                } else {
                    row.replaceWith(this.getRow(user));
                }
            } else {
                users_table.find('tbody').append(this.getRow(user));
            }
        },

        updateMenu: function (action = 'all', type = false) {
            let user_types = ['all', 'user', 'lead', 'visitor'];
            if (action == 'all') {
                SBF.ajax({
                    function: 'count-users'
                }, (response) => {
                    for (var i = 0; i < user_types.length; i++) {
                        this.updateMenuItem('set', user_types[i], response[user_types[i]]);
                    }
                });
            } else {
                this.updateMenuItem(action, type);
            }
        },

        updateMenuItem: function (action = 'set', type = false, count = 1) {
            let item = users_table_menu.find(`[data-type="${type}"] span`);
            let user_types = ['user', 'lead', 'visitor'];
            if (action != 'set') {
                count = parseInt(item.attr('data-count')) + (1 * (action == 'add' ? 1 : -1));
            }
            item.html(`(${count})`).attr('data-count', count);
            count = 0;
            for (var i = 0; i < user_types.length; i++) {
                count += parseInt(users_table_menu.find(`[data-type="${user_types[i]}"] span`).attr('data-count'));
            }
            users_table_menu.find(`[data-type="all"] span`).html(`(${count})`).attr('data-count', count);
        },

        delete: function (user_ids) {
            loading(users_table);
            if (Array.isArray(user_ids)) {
                if (SB_ADMIN_SETTINGS.cloud) {
                    user_ids = SBCloud.removeAdminID(user_ids);
                    if (!user_ids.length) {
                        return;
                    }
                }
                SBF.ajax({
                    function: 'delete-users',
                    user_ids: user_ids
                }, () => {
                    for (var i = 0; i < user_ids.length; i++) {
                        delete users[user_ids[i]];
                        users_table.find(`[data-user-id="${user_ids[i]}"]`).remove();
                        conversations_admin_list_ul.find(`[data-user-id="${user_ids[i]}"]`).remove();
                        SBF.event('SBUserDeleted', user_ids[i]);
                    }
                    if (users_table.find('[data-user-id]').length == 0) {
                        this.filter(users_table_menu.find('.sb-active').data('type'));
                    }
                    infoBottom('Users deleted');
                    this.updateMenu();
                    users_table.sbLoading(false);

                    setTimeout(function () {
                        $('#sb-users').parent().trigger('click');
                    }, 1000);
                });
            } else {
                users[user_ids].delete(() => {
                    let conversation = conversations_admin_list_ul.find(`[data-user-id="${user_ids}"]`);
                    if (activeUser().id == user_ids) {
                        activeUser(false);
                    }
                    if (conversation.sbActive()) {
                        SBChat.conversation = false;
                        setTimeout(() => { SBConversations.clickFirst() }, 300);
                    }
                    delete users[user_ids];
                    users_table.find(`[data-user-id="${user_ids}"]`).remove();
                    conversation.remove();
                    admin.sbHideLightbox();
                    infoBottom('User deleted');
                    this.updateMenu();
                    users_table.sbLoading(false);
                    setTimeout(function () {
                        $('#sb-users').parent().trigger('click');
                    }, 1000);
                });
            }
        },

        startRealTime: function () {
            if (SBPusher.active) {
                return;
            }
            this.stopRealTime();
            this.real_time = setInterval(() => {
                this.update();
            }, 1000);
        },

        stopRealTime: function () {
            clearInterval(this.real_time);
        },

        csv: function () {
            SBF.ajax({ function: 'csv-users', users_id: SBUsers.getSelected() }, (response) => {
                dialogDeleteFile(response, 'sb-export-users-close', 'Users exported');
                window.open(response);
            });
        },

        updateUsersActivity: function () {
            SBF.updateUsersActivity(agent_online ? SB_ACTIVE_AGENT.id : -1, activeUser() ? activeUser().id : -1, function (response) {
                SBUsers.setActiveUserStatus(response == 'online');
            });
        },

        setActiveAgentStatus: function (online = true) {
            let label = online ? 'online' : 'offline';
            agent_online = online;
            admin.find('[data-value="status"]').html(sb_(SBF.slugToString(label))).attr('class', 'sb-' + label);
            if (SBPusher.active) {
                if (online) {
                    SBPusher.presence();
                    if (SB_ADMIN_SETTINGS.routing == 'queue' || SB_ADMIN_SETTINGS.routing == 'routing') {
                        SBF.ajax({ function: 'assign-conversations-active-agent', is_queue: SB_ADMIN_SETTINGS.routing == 'queue' }, () => {
                            SBConversations.update();
                        });
                    }
                } else {
                    SBPusher.presenceUnsubscribe();
                }
            }
            if (!SB_ADMIN_SETTINGS.reports_disabled) {
                SBF.ajax({ function: 'reports-update', name: label });
            }
        },

        setActiveUserStatus: function (online = true) {
            let labels = conversations_area.find('.sb-conversation .sb-top > .sb-labels');
            labels.find('.sb-status-online').remove();
            if (online) labels.prepend(`<span class="sb-status-online">${sb_('Online')}</span>`);
            SBChat.user_online = online;
        },

        onlineUserNotification: function (member) {
            let notification = SB_ADMIN_SETTINGS.online_users_notification;
            if (notification) {
                let message = member.info.first_name + ' ' + member.info.last_name;
                let icon = this.userProfileImage(member.info.profile_image);
                if (SB_ADMIN_SETTINGS.push_notifications && member.info.id && !this.history.includes(member.info.id)) {
                    SBF.ajax({
                        function: 'push-notification',
                        title: notification,
                        message: message,
                        icon: icon,
                        interests: SB_ACTIVE_AGENT.id,
                        user_id: member.info.id
                    });
                } else if (SBConversations.desktop_notifications) {
                    SBChat.desktopNotification(notification, message, icon, false, member.info.id);
                }
                this.history.push(member.info.id);
            }
        },

        userProfileImage: function (url) {
            return !url || url.indexOf('user.svg') ? SB_ADMIN_SETTINGS.notifications_icon : url;
        },

        getSelected: function () {
            let user_ids = [];
            users_table.find('tr').each(function () {
                if ($(this).find('td input[type="checkbox"]').is(':checked')) {
                    user_ids.push($(this).attr('data-user-id'));
                }
            });
            return user_ids;
        },

        getExtraDetailsList: function (only_custom = false) {
            return profile_edit_box.find('.sb-additional-details .sb-edit-box > ' + (only_custom ? '.sb-custom-detail' : '.sb-input')).map(function () { return [[$(this).attr('id'), $(this).find('span').html().trim()]] }).get();
        }
    }


    /*
    * ----------------------------------------------------------
    * Conversations 
    * ----------------------------------------------------------
    */

    var SBConversations = {
        real_time: null,
        datetime_last_conversation: false,
        user_typing: false,
        desktop_notifications: false,
        flash_notifications: false,
        busy: false,
        busy_2: false,
        is_search: false,
        menu_count_ajax: false,
        previous_editor_text: false,

        // Open the conversations tab
        open: function (conversation_id = -1, user_id) {
            if (conversation_id != -1) {
                this.openConversation(conversation_id, user_id);
            }
            admin.sbHideLightbox();
            header.find('.sb-admin-nav a').sbActive(false).parent().find('#sb-conversations').sbActive(true);
            admin.find(' > main > div').sbActive(false);
            conversations_area.sbActive(true).find('.sb-board').removeClass('sb-no-conversation');
            select_departments.find(' > p').attr('data-id', '').attr('data-value', '').html(sb_('None'));
            this.notes.update([]);
            this.tags.update([]);
            this.startRealTime();
        },
        inboxMenuNotificationCounter: function () {
            const notification_counter = SBF.storage('notifications-counter');
            let totalCount = 0;

            if (notification_counter && typeof notification_counter === 'object') {
                for (const id in notification_counter) {
                    if (Array.isArray(notification_counter[id])) {
                        totalCount += notification_counter[id].length;
                    }
                }
            }

            // Remove any existing counter next to the inbox menu item
            $('#sb-conversations').next('.sb-notification-counter').remove();

            if (totalCount > 0) {
                const tooltip = `${totalCount} new message${totalCount > 1 ? 's' : ''}`;
                $('#sb-conversations').after(`<span class="sb-notification-counter" title="${tooltip}">${totalCount}</span>`);
            }
        },

        // Open a single conversation
        openConversation: function (conversation_id, user_id = false, scroll = true) {
            SBChat.label_date.sbActive(false);
            SBChat.label_date_show = false;
            if (this.busy_2 == conversation_id) {
                return;
            }
            if (user_id === false && conversation_id) {
                this.busy_2 = conversation_id;
                SBF.ajax({
                    function: 'get-user-from-conversation',
                    conversation_id: conversation_id
                }, (response) => {
                    this.busy_2 = false;
                    if (!SBF.null(response.id)) {
                        this.openConversation(conversation_id, response.id, scroll);
                    } else {
                        SBF.error('Conversation not found', 'SBAdmin.openConversation');
                    }
                });
            } else {
                let new_user = SBF.null(users[user_id]) || !(users[user_id].details.email);
                let conversation = conversations_area.find(`[data-conversation-id="${conversation_id}"]`);
                let conversation_list = conversations_admin_list_ul.find('li');
                conversations_area_list.html('');
                conversations_area_list.sbLoading(true);

                // Init the user
                if (new_user) {
                    activeUser(new SBUser({ 'id': user_id }));
                    activeUser().update(() => {
                        users[user_id] = activeUser();
                        this.updateUserDetails();
                    });
                } else {
                    activeUser(users[user_id]);
                    this.updateCurrentURL();
                }
                if (SBPusher.active) {
                    SBPusher.event('client-typing', (response) => {
                        if (response.user_id == activeUser().id) {
                            SBConversations.typing(true);
                            clearTimeout(pusher_timeout);
                            pusher_timeout = setTimeout(() => { SBConversations.typing(false) }, 1000);
                        }
                    });
                    SBPusher.event('new-message', () => {
                        SBChat.update();
                    });
                    SBPusher.event('agent-active-conversation-changed', (response) => {
                        if (response.previous_conversation_id == conversation_id) {
                            conversations_area.find('.sb-conversation-busy').remove();
                        }
                    }, 'agents');
                    SBPusher.event('init', (response) => {
                        SBConversations.updateCurrentURL(response.current_url);
                    });
                    SBPusher.event('message-status-update', (response) => {
                        if (SBChat.conversation) {
                            SBChat.conversation.updateMessagesStatus(response.message_ids);
                        }
                    });
                }
                if (SB_ADMIN_SETTINGS.smart_reply) {
                    suggestions_area.html('');
                }

                // Open the conversation
                conversation_list.sbActive(false);
                if (!SB_ADMIN_SETTINGS.departments_show) {
                    conversation_list.attr('data-color', '');
                }
                conversation.sbActive(true);
                if (conversation_id != -1) {
                    this.busy_2 = conversation_id;
                    activeUser().getFullConversation(conversation_id, (response) => {
                        let conversation_status_code = response.status_code;
                        let select = conversations_filters.eq(0);
                        let select_status_code = select.find('.sb-active').attr('data-value');
                        this.busy_2 = false;
                        SBChat.setConversation(response);
                        SBChat.populate();
                        this.setReadIcon(conversation_status_code);
                        conversations_area.find('.sb-conversation-busy').remove();
                        this.updateUserDetails();
                        conversations_area.find('.sb-top > a').html(response.get('title'));

                        const convert_to_ticket_li = document.getElementById('convert-to-ticket-list');
                        const converted = conversations_area.find('.sb-scroll-area li.sb-active').attr('data-converted');
                        if (converted == 1) {
                            //document.getElementById('sb-icon-refresh').style.color = 'blue';
                            $('#convert-to-ticket span').html('Linked to a ticket');
                            document.querySelector('#convert-to-ticket').setAttribute('data-sb-tooltip', 'Linked to a ticket');
                            $('#convert-to-ticket').addClass('converted');
                            $(admin).sbInitTooltips();

                        }
                        else {
                            //document.getElementById('sb-icon-refresh').style.color = '#566069';
                            $('#convert-to-ticket span').html(sb_('Link to Ticket'));
                            document.querySelector('#convert-to-ticket').setAttribute('data-sb-tooltip', sb_('Link to Ticket'));
                            $('#convert-to-ticket').removeClass('converted');
                            $(admin).sbInitTooltips();

                        }

                        // Automatic translation
                        SBAdmin.must_translate = SB_ADMIN_SETTINGS.translation && activeUser().language && SB_ADMIN_SETTINGS.active_agent_language != activeUser().language;
                        if (SBAdmin.must_translate) {
                            let strings = [];
                            let message_ids = [];
                            let message_user_types = [];
                            let messages_translated = [];
                            for (var i = 0; i < response.messages.length; i++) {
                                let message = response.messages[i];
                                if (message.message) {
                                    if ((message.payload('original-message') && (!message.payload('original-message-language') || message.payload('original-message-language') == SB_ADMIN_SETTINGS.active_agent_language)) || (message.payload('translation') && (!message.payload('translation-language') || message.payload('translation-language') == SB_ADMIN_SETTINGS.active_agent_language))) {
                                        messages_translated.push(message);
                                    } else {
                                        strings.push(message.message);
                                        message_ids.push(message.id);
                                        message_user_types.push(message.get('user_type'));
                                    }
                                }
                            }
                            if (strings.length) {
                                SBApps.dialogflow.translate(strings, SB_ADMIN_SETTINGS.active_agent_language, (response_translate) => {
                                    if (response_translate) {
                                        for (var i = 0; i < response_translate.length; i++) {
                                            let message = SBChat.conversation.getMessage(message_ids[i]);
                                            message.payload('translation', response_translate[i])
                                            message.payload('translation-language', SB_ADMIN_SETTINGS.active_agent_language);
                                            this.openConversation_2(message_ids[i], message_user_types[i]);
                                        }
                                    }
                                    if (SB_ADMIN_SETTINGS.smart_reply) {
                                        this.openConversation_1(SBChat.conversation, suggestions_area);
                                    }
                                }, message_ids, conversation_id);
                            } else if (SB_ADMIN_SETTINGS.smart_reply) {
                                this.openConversation_1(SBChat.conversation, suggestions_area);
                            }
                            for (var i = 0; i < messages_translated.length; i++) {
                                this.openConversation_2(messages_translated[i].id, messages_translated[i].get('user_type'));
                            }
                        }

                        // Departments
                        if (select_departments.length) {
                            let department = response.get('department') ? this.getDepartments(response.get('department')) : false;
                            let color = department ? department['department-color'] : '';
                            if (!SB_ADMIN_SETTINGS.departments_show) {
                                conversation_list.attr('data-color', '');
                            }
                            getListConversation(conversation_id).attr('data-color', color);
                            select_departments.find(' > p').attr('data-id', department ? department['department-id'] : '').attr('data-value', color).html(department ? department['department-name'] + '<span></span>' : sb_('None'));
                        }

                        // Agent assignment
                        let select_agents = conversations_area.find('#conversation-agent');
                        if (select_agents.length) {
                            let item = select_agents.find(`[data-id="${response.get('agent_id')}"]`);
                            select_agents.find(' > p').attr('data-value', item.data('id')).html(item.html());
                        }

                        // Activate the conversation
                        if ([1, 2, '1', '2'].includes(conversation_status_code)) {
                            conversation_status_code = 0;
                        }
                        if (select_status_code != conversation_status_code && !$(conversations_admin_list).find('.sb-search-btn').sbActive() && !SBConversations.filters()[1] && !SBConversations.filters()[3]) {
                            select.find(`[data-value="${conversation_status_code}"]`).click();
                            select.find('ul').sbActive(false);
                        }
                        if (responsive) {
                            this.mobileOpenConversation();
                        }
                        if (!conversation.length && (select_status_code == conversation_status_code || (select_status_code == 0 && conversation_status_code == 1))) {
                            conversations_admin_list_ul.prepend(SBConversations.getListCode(response));
                        }
                        showInitials('sb-scroll-area', 'sb-profile');  /// Show initials in the conversation list area left sidebar
                        conversations_admin_list_ul.find('li').sbActive(false);
                        conversation.sbActive(true);
                        if (scroll) {
                            this.scrollTo();
                        }
                        this.notificationsCounterReset(conversation_id, conversation);
                        conversations_area_list.sbInitTooltips();

                        // Check if another agent has the conversation open
                        let busy = response.get('busy');
                        if (busy) {
                            conversations_area.find('.sb-editor > .sb-labels').prepend(`<span data-agent="${busy.id}" class="sb-status-warning sb-conversation-busy">${busy.first_name} ${busy.last_name} ${sb_('is replying to this conversation')}</span>`);
                        }

                        // App panels
                        if (SBApps.is('woocommerce')) {
                            SBApps.woocommerce.conversationPanel();
                        }
                        if (SBApps.is('ump')) {
                            SBApps.ump.conversationPanel();
                        }
                        if (SBApps.is('perfex')) {
                            SBApps.perfex.conversationPanel();
                        }
                        if (SBApps.is('whmcs')) {
                            SBApps.whmcs.conversationPanel();
                        }
                        if (SBApps.is('aecommerce')) {
                            SBApps.aecommerce.conversationPanel();
                        }
                        if (SBApps.is('martfury')) {
                            SBApps.martfury.conversationPanel();
                        }
                        if (SBApps.is('armember')) {
                            SBApps.armember.conversationPanel();
                        }
                        if (SBApps.is('zendesk')) {
                            SBApps.zendesk.conversationPanel();
                        }
                        if (SBApps.is('opencart')) {
                            SBApps.opencart.conversationPanel();
                        }
                        if (activeUser() && SB_ADMIN_SETTINGS.cloud) {
                            if (SBCloud.shopify.panel) {
                                SBCloud.shopify.panel.html('');
                            }
                            SBCloud.shopify.conversationPanel();
                        }

                        // Notes and Tags
                        this.notes.update(response.details.notes);
                        this.tags.update(response.details.tags);

                        // Attachments
                        this.attachments();

                        // Suggestions
                        if (SB_ADMIN_SETTINGS.smart_reply && !SBAdmin.must_translate) {
                            this.openConversation_1(response, suggestions_area);
                        }

                        // Rating
                        for (var i = response.messages.length - 1; i > 0; i--) {
                            let payload = response.messages[i].get('payload');
                            if (payload.rating) {
                                conversations_area.find('.sb-profile-list > ul').append(`<li data-id="rating"><i class="sb-icon sb-icon-${payload.rating == 1 ? 'like' : 'dislike'}"></i><span>${sb_('User rating')}</span><label>${sb_(payload.rating == 1 ? 'Helpful' : 'Not helpful')}${payload.message ? ' - ' + payload.message : ''}</label></li>`);
                                break;
                            }
                        }

                        // Source tasks
                        if (response.get('source') == 'em') {
                            this.cc(response.get('extra').split(','));
                        }
                        if (response.get('source') == 'wa') {
                            let datetime = response.getLastUserMessage();
                            if (datetime) {
                                if ((new Date()) - (new Date(datetime.get('creation_time').replace(' ', 'T'))) > 86400000) {
                                    infoBottom(sb_('You can\'t send a WhatsApp message more than 24 hours after the user\'s last messageâuse a template instead.') + '<i id="sb-whatsapp-alert-btn" class="sb-icon-social-wa"</i>', 'info');
                                }
                            }
                        }

                        admin.on('click', '#sb-whatsapp-alert-btn', function () {
                            SBConversations.showDirectMessageBox('whatsapp', [activeUser().id]);
                        });


                        // Populate user conversations on the bottom right area
                        activeUser().getConversations(function (response) {
                            conversations_area.find('.sb-user-conversations').html(response.length == 1 ? '' : activeUser().getConversationsCode(response)).prev().setClass('sb-hide', response.length == 1);
                        });

                        // Search
                        if (this.is_search) {
                            let search = conversations_admin_list.find('.sb-search-btn input').val();
                            for (var i = 0; i < response.messages.length; i++) {
                                if (response.messages[i].message.toLowerCase().includes(search)) {
                                    let id = response.messages[i].id;
                                    setTimeout(() => {
                                        let label = '';
                                        conversations_area_list.find(`> div`).each(function () {
                                            let message = $(this);
                                            if (message.attr('data-id') == id) {
                                                message.addClass('sb-highlight');
                                                setTimeout(() => { message.removeClass('sb-highlight') }, 3600);
                                                SBChat.label_date.html(label);
                                                SBChat.label_date_show = true;
                                                if (message.index()) {
                                                    message.prev()[0].scrollIntoView();
                                                } else {
                                                    message[0].scrollIntoView();
                                                }
                                            } else if (message.hasClass('sb-label-date')) {
                                                label = message.html();
                                            }
                                        });
                                    }, 300);
                                }
                            }
                        }
                        conversations_area_list.sbLoading(false);
                    });
                } else {
                    SBChat.clear();
                    conversations_admin_list_ul.find('li').sbActive(false);
                    conversations_area_list.sbLoading(false);
                    conversations_area.find('.sb-top > a').html('');
                    if (!new_user) {
                        this.updateUserDetails();
                    }
                }

                // More settings
                conversations_area.find('.sb-board').removeClass('sb-no-conversation');
                SBUsers.updateUsersActivity();
                this.startRealTime();
                if (SBF.getURL('conversation') != conversation_id && conversation_id != -1) {
                    pushState('?conversation=' + conversation_id);
                }
            }
        },

        openConversation_1: function (response, suggestions_area) {
            let message = response.getLastUserMessage();
            suggestions_area.html('');
            if (message && message.payload('sb-human-takeover')) {
                message = response.getLastUserMessage(message.get('index'));
            }
            if (message) {
                SBApps.dialogflow.smartReply(message.message);
            }
        },

        openConversation_2: function (message_id, user_type) {
            let message = SBChat.conversation.getMessage(message_id);
            if (message) {
                let is_translation = SBF.isAgent(user_type) && user_type != 'bot';
                conversations_area_list.find(`[data-id="${message_id}"]`).replaceWith(message.getCode());
                conversations_area_list.find(`[data-id="${message_id}"] .sb-menu`).prepend(`<li data-value="${is_translation ? 'translation' : 'original'}">${sb_(is_translation ? 'View translation' : 'View original message')}</li>`);
            }
        },

        // [Deprecated] this method is obsolete and it will be removed soon
        populate: function (conversation_id, user_id, scroll) {
            this.openConversation(conversation_id, user_id, scroll);
        },

        // Populate conversations
        populateList: function (response) {
            let code = '';
            conversations = [];
            for (var i = 0; i < response.length; i++) {
                code += this.getListCode(response[i]);
                conversations.push(new SBConversation([new SBMessage(response[i])], response[i]));
            }
            console.log(conversations);
            if (!code) {
                code = `<p class="sb-no-results">${sb_('No conversations found.')}</p>`;
            }
            conversations_admin_list_ul.html(code);
            this.updateMenu();
            SBF.event('SBAdminConversationsLoaded', { conversations: response });
        },

        // Update the left conversations list with latest conversations or messages 
        update: function () {
            if (!this.busy && conversations_filters.eq(0).find('p').attr('data-value') == 0 && this.datetime_last_conversation) {
                let filters = SBConversations.filters();
                this.busy = true;
                SBF.ajax({
                    function: 'get-new-conversations',
                    datetime: this.datetime_last_conversation,
                    department: filters[1],
                    source: filters[2],
                    tag: filters[3]
                }, (response) => {
                    this.busy = false;
                    if (response.length) {
                        let code_pending = '';
                        let code_not_pending = '';
                        let active_conversation_id = SBChat.conversation ? SBChat.conversation.id : -1;
                        let li_not_pending;
                        let scroll_to_conversation = false;
                        let id_check = [];
                        if (response[0].last_update_time) {
                            this.datetime_last_conversation = response[0].last_update_time;
                        }
                        for (var i = 0; i < response.length; i++) {
                            if (!id_check.includes(response[i].id)) {
                                let message = new SBMessage(response[i]);
                                let conversation = new SBConversation([message], response[i]);
                                let status_code = conversation.status_code;
                                let is_pending_status_code = status_code == 2 || (SB_ADMIN_SETTINGS.order_by_date && (status_code == 0 || status_code == 1));
                                let user_id = conversation.user_id;
                                let conversation_id = conversation.id;
                                let conversation_li = getListConversation(conversation_id);
                                let is_existing_conversation = conversation_li.length;
                                let user_type = message.get('user_type');
                                let message_text = conversation.get('message');
                                let active_conversation = active_conversation_id == conversation_id;
                                let is_user = !SBF.isAgent(user_type);
                                if (!message_text && message.payload('preview')) {
                                    message_text = message.payload('preview');
                                }
                                if (is_pending_status_code && (!active_conversation || SBF.visibility_status == 'hidden') && (is_user || message.payload('human-takeover-message-confirmation'))) {
                                    let notifications_counter = SBF.storage('notifications-counter');
                                    if (!notifications_counter) {
                                        notifications_counter = {};
                                    }
                                    if (!notifications_counter[conversation_id]) {
                                        notifications_counter[conversation_id] = [];
                                    }
                                    if (!notifications_counter[conversation_id].includes(message.id)) {
                                        notifications_counter[conversation_id].push(message.id);
                                        SBF.storage('notifications-counter', notifications_counter);
                                    }
                                }
                                let conversation_code = this.getListCode(conversation, null);

                                // Active conversation
                                if (active_conversation) {
                                    this.updateUserDetails();
                                    if (is_existing_conversation) {
                                        if (message_text) {
                                            conversation_li.replaceWith(conversation_code);
                                        }
                                        this.setStatus(status_code, conversation_id);
                                    } else {
                                        scroll_to_conversation = true;
                                    }
                                } else if (is_existing_conversation) {

                                    // Conversation already in list but not active
                                    conversations[conversation_li.index()] = conversation;
                                    getListConversation(conversation_id).remove();
                                }

                                // Add the user to the global users array if it doesn't exists
                                if (!(user_id in users)) {
                                    users[user_id] = new SBUser({ id: user_id, first_name: conversation.get('first_name'), last_name: conversation.get('last_name'), profile_image: conversation.get('profile_image'), user_type: user_type });
                                }

                                // New or unactive conversation 
                                if (!active_conversation || !is_existing_conversation) {
                                    if (is_pending_status_code) {
                                        code_pending += conversation_code;
                                        conversations.unshift(conversation);
                                    } else if (status_code == 0 || status_code == 1) {
                                        li_not_pending = conversations_admin_list_ul.find('[data-conversation-status="2"]').last();
                                        if (li_not_pending.length) {
                                            conversations.splice(li_not_pending.index() + 1, 0, conversation);
                                            code_not_pending += conversation_code;
                                        } else {
                                            code_pending += conversation_code;
                                        }
                                    }
                                    if (activeUser() && user_id == activeUser().id) {
                                        activeUser().getConversations((response) => {
                                            conversations_area.find('.sb-user-conversations').html(activeUser().getConversationsCode(response));
                                        });
                                    }
                                    SBF.event('SBAdminNewConversation', { conversation: conversation });
                                }

                                // Update user
                                if (activeUser() && (message.payload('event') == 'update-user' || (users[user_id].type != user_type))) {
                                    activeUser().update(() => {
                                        this.updateUserDetails();
                                        users[activeUser().id] = activeUser();
                                    });
                                }

                                // Desktop, flash, sounds notifications
                                let message_preview = message.payload('preview');
                                if (!SBChat.tab_active && status_code == 2 && (is_user || message_preview) && (message_text || conversation.getAttachments().length || message_preview)) {
                                    if (this.desktop_notifications) {
                                        let user_details = [users[user_id].nameBeautified, users[user_id].image];
                                        SBChat.desktopNotification(user_details[0], message_preview ? message_preview : message_text, user_details[1], conversation_id, user_id);
                                    }
                                    if (this.flash_notifications) {
                                        SBChat.flashNotification();
                                    }
                                    if (SBChat.audio && SB_ADMIN_SETTINGS.sound) {
                                        SBChat.playSound();
                                    }
                                }
                                id_check.push(conversation_id);
                            }
                        }
                        if (!SBConversations.is_search) {
                            if (code_pending) {
                                conversations_admin_list_ul.prepend(code_pending);
                            }
                            if (code_not_pending) {
                                $(code_not_pending).insertAfter(li_not_pending);
                            }
                            if (scroll_to_conversation) {
                                this.scrollTo();
                            }
                            this.updateMenu();
                        }

                        // Update notifications counter
                        for (var i = 0; i < SBChat.notifications.length; i++) {
                            let is_found = false;
                            for (var j = 0; j < conversations.length; j++) {
                                if (conversations[j].id == SBChat.notifications[i][0]) {
                                    is_found = conversations[j].status_code == 2;
                                    break;
                                }
                            }
                            if (!is_found) {
                                SBChat.notifications.splice(i, 1);
                                i--;
                            }
                        }
                    }
                });
                if (SB_ADMIN_SETTINGS.assign_conversation_to_agent || SB_ACTIVE_AGENT.department) {
                    let ids = conversations_admin_list_ul.find(' > li').map(function () { return $(this).attr('data-conversation-id') }).get();
                    if (ids.length) {
                        SBF.ajax({
                            function: 'check-conversations-assignment',
                            conversation_ids: ids,
                            agent_id: SB_ADMIN_SETTINGS.assign_conversation_to_agent ? SB_ACTIVE_AGENT.id : false,
                            department: SB_ACTIVE_AGENT.department
                        }, (response) => {
                            if (response) {
                                for (var i = 0; i < response.length; i++) {
                                    getListConversation(response[i]).remove();
                                }
                            }
                        });
                    }
                }
            }
        },

        // Update the top left filter
        updateMenu: function () {
            let count = conversations_admin_list_ul.find('[data-conversation-status="2"]').length;
            let item = conversations_filters.eq(0);
            let span = item.find(' > p span');
            if (count == 100 || this.menu_count_ajax || SB_ADMIN_SETTINGS.order_by_date) {
                let status_code = item.find('li.sb-active').data('value');
                this.menu_count_ajax = true;
                SBF.ajax({
                    function: 'count-conversations',
                    status_code: status_code == 0 ? 2 : status_code
                }, (response) => {
                    span.html(`(${response})`);
                });
            } else {
                span.html(`${count}`);
            }
        },

        // Return the code of the message menu
        messageMenu: function (agent, message = false, replay = false) {
            let code = (message && SB_ADMIN_SETTINGS.chatbot_features ? `<li data-value="bot">${sb_('Train chatbot')}</li>` : '') + ((agent && !SB_ADMIN_SETTINGS.supervisor && SB_ADMIN_SETTINGS.allow_agent_delete_message) || (SB_ADMIN_SETTINGS.supervisor && SB_ADMIN_SETTINGS.allow_supervisor_delete_message) ? `<li data-value="delete">${sb_('Delete')}</li>` : '') + (replay ? `<li data-value="reply">${sb_('Reply')}</li>` : '');
            return `<i class="sb-menu-btn sb-icon-menu"></i><ul class="sb-menu">${code}</ul>`;
        },

        // Update the users details of the conversations area
        updateUserDetails() {
            if (!activeUser()) return;
            conversations_area.find(`[data-user-id="${activeUser().id}"] .sb-name`).html(activeUser().name);
            conversations_area.find(`.sb-top > a`).html(SBChat.conversation ? SBChat.conversation.title : activeUser().name);
            conversations_user_details.find('.sb-profile').setProfile();
            SBProfile.populate(activeUser(), conversations_area.find('.sb-profile-list'));
        },

        // Set the read status icon
        setReadIcon(status_code) {
            let unread = status_code == 2;
            conversations_area.find('.sb-top [data-value="read"],.sb-top [data-value="unread"]').sbActive([0, 1, 2].includes(parseInt(status_code))).attr('data-value', unread ? 'read' : 'unread').attr('data-sb-tooltip', sb_(unread ? 'Mark as read' : 'Mark as unread')).parent().sbInitTooltips().find('i').attr('class', unread ? 'sb-icon-check-circle' : 'sb-icon-circle');
        },

        // Set a conversation as read 
        setStatus(status_code, conversation_id = false, update_left_list = false) {
            if (!conversation_id) {
                conversation_id = SBChat.conversation.id;
            }
            if (conversation_id) {
                conversations[getListConversation(conversation_id).index()].set('status_code', status_code);
                this.setReadIcon(status_code);
                if (update_left_list) {
                    conversations_admin_list_ul.find(`[data-conversation-id="${conversation_id}"]`).attr('data-conversation-status', status_code);
                }
            }
        },

        // Return the conversation code of the left conversations list
        getListCode: function (conversation, status) {
            if (!(conversation instanceof SBConversation)) {
                conversation = new SBConversation([new SBMessage(conversation)], conversation);
            }
            let message = conversation.getCode(true);
            let label_new = '';
            let tags = SB_ADMIN_SETTINGS.tags_show ? conversation.get('tags') : '';
            let department_id = conversation.get('department');
            let notification_counter = '';
            let time = conversation.get('last_update_time');
            let is_active = SBChat.conversation && SBChat.conversation.id == conversation.id;
            if (SBF.null(status)) {
                status = conversation.status_code;
            }
            if (tags) {
                tags = SBConversations.tags.codeLeft(tags);
            }
            if (!SBChat.conversation || !is_active || SBF.visibility_status == 'hidden') {
                notification_counter = SBF.storage('notifications-counter');
                if (notification_counter && notification_counter[conversation.id] && notification_counter[conversation.id].length) {
                    if (status == 2) {
                        notification_counter = `<span class="sb-notification-counter">${notification_counter[conversation.id].length}</span>`;
                    } else {
                        notification_counter[conversation.id] = [];
                        SBF.storage('notifications-counter', notification_counter);
                        notification_counter = '';
                    }
                } else {
                    notification_counter = '';
                }
            }

            this.inboxMenuNotificationCounter();

            if (!time) {
                time = conversation.getLastMessage() ? conversation.getLastMessage().get('creation_time') : conversation.get('creation_time');
            }
            const ticketSvg = '<svg width="20" height="20" viewBox="0 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22.6929 9.12895C22.626 7.58687 22.4385 6.58298 21.9132 5.78884C21.611 5.33196 21.2357 4.93459 20.8041 4.61468C19.6376 3.75 17.9919 3.75 14.7007 3.75H10.686C7.39472 3.75 5.74908 3.75 4.58256 4.61468C4.15099 4.93459 3.77561 5.33196 3.47341 5.78884C2.9482 6.58289 2.7607 7.58665 2.69377 9.12843C2.68232 9.39208 2.90942 9.59375 3.15825 9.59375C4.54403 9.59375 5.66743 10.783 5.66743 12.25C5.66743 13.717 4.54403 14.9062 3.15825 14.9062C2.90942 14.9062 2.68232 15.1079 2.69377 15.3716C2.7607 16.9134 2.9482 17.9171 3.47341 18.7112C3.77561 19.168 4.15099 19.5654 4.58256 19.8853C5.74908 20.75 7.39472 20.75 10.686 20.75H14.7007C17.9919 20.75 19.6376 20.75 20.8041 19.8853C21.2357 19.5654 21.611 19.168 21.9132 18.7112C22.4385 17.917 22.626 16.9131 22.6929 15.3711V9.12895Z" stroke="#5F6465" stroke-width="1.5" stroke-linejoin="round"></path><path d="M13.6934 12.25H17.6934" stroke="#5F6465" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M9.69336 16.25H17.6934" stroke="#5F6465" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>';
            return `<li${is_active ? ' class="sb-active"' : ''} data-user-name="${conversation.get('first_name') + ' ' + conversation.get('last_name')}" data-converted="${conversation.get('converted_to_ticket')}" data-user-id="${conversation.get('user_id')}" data-conversation-id="${conversation.id}" data-conversation-status="${status}"${department_id ? ` data-department="${department_id}"${SB_ADMIN_SETTINGS.departments_show ? ' data-color="' + this.getDepartments(department_id)['department-color'] + '"' : ''}` : ''}${!SBF.null(conversation.get('source')) ? ` data-conversation-source="${conversation.get('source')}"` : ''}>${label_new + notification_counter}<div class="sb-profile"><img loading="lazy" src="${conversation.get('profile_image')}" data-name="${conversation.get('first_name') + ' ' + conversation.get('last_name')}"><div class="user-initials" data-value="edit-profile" style="display: none;"><span class="initials"></span></div><span class="sb-name">${conversation.get('first_name') + ' ' + conversation.get('last_name')}</span>${conversation.get('converted_to_ticket') == 1 ? ticketSvg : ''}  ${tags}<span class="sb-time">${SBF.beautifyTime(time)}</span></div><p>${message}</p></li>`;
        },

        // Start or stop the real time update of left conversations list and chat 
        startRealTime: function () {
            if (SBPusher.active) {
                return;
            }
            this.stopRealTime();
            this.real_time = setInterval(() => {
                this.update();
                this.updateCurrentURL();
            }, 10000);
            SBChat.startRealTime();
        },
        stopRealTime: function () {
            clearInterval(this.real_time);
            SBChat.stopRealTime();
        },

        // Transcript generation and download
        transcript: function (conversation_id, user_id, action = false, onSuccess = false) {
            SBF.ajax({
                function: 'transcript',
                conversation_id: conversation_id
            }, (response) => {
                if (action == 'email') {
                    if (!activeUser() || activeUser().id != user_id || activeUser().get('email')) {
                        SBChat.sendEmail(SB_ADMIN_SETTINGS.transcript_message, [[response, response]], user_id, (response2) => {
                            if (onSuccess) {
                                onSuccess(response2 === true ? response : response2);
                            }
                        });
                    }
                } else {
                    if (onSuccess) {
                        onSuccess(response);
                    }

                    let fileUrl = response.replace(/\\/g, ""); // clean slashes

                    // Create a temporary <a> element to trigger download
                    let a = document.createElement("a");
                    a.href = fileUrl;
                    a.download = ""; // let browser use original filename
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                }
            });
        },

        // Set the typing status
        typing: function (typing) {
            if (typing) {
                if (!SBChat.user_online) {
                    SBUsers.setActiveUserStatus(true);
                }
                if (!this.user_typing) {
                    conversations_area.find('.sb-conversation .sb-top > .sb-labels').append('<span class="sb-status-typing">' + sb_('Typing') + '</span>');
                    this.user_typing = true;
                }
            } else if (this.user_typing) {
                conversations_area.find('.sb-conversation .sb-top .sb-status-typing').remove();
                this.user_typing = false;
            }
        },

        // Scroll the left conversations list to the active conversation
        scrollTo: function () {
            let active = conversations_admin_list_ul.find('.sb-active');
            let offset = active.length ? active[0].offsetTop : 0;
            // conversations_admin_list_ul.parent().scrollTop(offset - (responsive ? 120 : 80));
        },

        // Search conversations
        search: function (input) {
            if (!input) return;
            searchInput(input, (search, icon) => {
                pagination_count = 1;
                if (search.length > 1) {
                    SBF.ajax({
                        function: 'search-conversations',
                        search: search
                    }, (response) => {
                        SBConversations.populateList(response);
                        $(icon).sbLoading(false);
                        this.scrollTo();
                        this.is_search = true;
                    });
                } else {
                    let filters = SBConversations.filters();
                    pagination = 1;
                    SBF.ajax({
                        function: 'get-conversations',
                        status_code: filters[0],
                        department: filters[1],
                        source: filters[2],
                        tag: filters[3]
                    }, (response) => {
                        SBConversations.populateList(response);
                        $(icon).sbLoading(false);
                        this.is_search = false;
                        if (SBChat.conversation) {
                            getListConversation(SBChat.conversation.id).sbActive(true);
                            this.scrollTo();
                        }
                    });
                }
            });
        },

        // Reset the notifications counter of a conversation in the left list
        notificationsCounterReset: function (conversation_id, conversation = false) {
            let notification_counter = SBF.storage('notifications-counter');
            if (notification_counter && notification_counter[conversation_id]) {
                if (!conversation) {
                    conversation = conversations_admin_list_ul.find('[data-conversation-id="' + conversation_id + '"]');
                }
                let span = conversation.find('.sb-notification-counter');
                notification_counter[conversation_id] = [];
                SBF.storage('notifications-counter', notification_counter);
                span.addClass('sb-fade-out');
                setTimeout(() => {
                    span.remove();
                }, 200);
            }

            this.inboxMenuNotificationCounter();
        },

        // Get the page URL of the user
        updateCurrentURL: function (url = false) {
            if (url) {
                this.ucurl(url);
            } else if (SBChat.user_online && activeUser() && activeUser().getExtra('current_url')) {
                SBF.ajax({
                    function: 'current-url'
                }, (response) => {
                    if (response) this.ucurl(response);
                });
            }
        },

        ucurl(url) {
            let extra = activeUser().getExtra('current_url');
            url = urlStrip(url);
            conversations_area.find('.sb-profile-list [data-id="current_url"] label').attr('data-value', url).html(url);
            if (extra) {
                extra.value = url;
                activeUser().setExtra('current_url', extra);
            }
        },

        // Update the department of a conversation
        assignDepartment: function (conversation_id, department, onSuccess) {
            SBF.ajax({
                function: 'update-conversation-department',
                conversation_id: conversation_id,
                department: department,
                message: SBChat.conversation.getLastMessage().message
            }, (response) => {
                onSuccess(response);
            });
        },

        // Update the agent assignged to a conversation
        assignAgent: function (conversation_id, agent_id, onSuccess = false) {
            SBF.ajax({
                function: 'update-conversation-agent',
                conversation_id: conversation_id,
                agent_id: agent_id,
                message: SBChat.conversation.getLastMessage().message
            }, (response) => {
                if (onSuccess) onSuccess(response);
            });
        },

        // Update the UI to display the active department of the conversation
        setActiveDepartment: function (department_id) {
            if (SBChat.conversation && SBChat.conversation.get('department') == department_id) {
                return;
            }
            let department = department_id ? this.getDepartments(department_id) : false;
            let departmnet_color = department ? department['department-color'] : '';
            let conversation_li = getListConversation(SBChat.conversation.id);
            let department_filter = SBConversations.filters()[1];
            select_departments.find(' > p').attr('data-id', department ? department['department-id'] : '').attr('data-value', departmnet_color).html((department ? department['department-name'] : sb_('None')) + '<span></span>').next().sbActive(false);
            SBChat.conversation.set('department', department_id);
            if ((department_filter && department_filter != department_id) || (SB_ACTIVE_AGENT.user_type == 'agent' && SB_ACTIVE_AGENT.department && SB_ACTIVE_AGENT.department != department_id)) {
                conversation_li.remove();
                SBConversations.clickFirst();
            } else {
                conversation_li.attr('data-color', departmnet_color);
            }
            infoBottom('Department updated. The agents have been notified.');
        },

        // Get all departmnts or a single department
        getDepartments: function (department_id = false) {
            if (department_id) {
                for (var i = 0; i < SB_ADMIN_SETTINGS.departments.length; i++) {
                    if (SB_ADMIN_SETTINGS.departments[i]['department-id'] == department_id) {
                        return SB_ADMIN_SETTINGS.departments[i];
                    }
                }
                return false;
            }
            return SB_ADMIN_SETTINGS.departments;
        },

        // Update the UI to display the active agent of the conversation
        setActiveAgent: function (agent_id) {
            let select = conversations_area.find('#conversation-agent');
            let li = select.find(`[data-id="${agent_id}"]`);
            SBChat.conversation.set('agent_id', agent_id);
            select.find(' > p').attr('data-value', li.data('id')).html(li.html()).next().sbActive(false);
            if (SB_ACTIVE_AGENT.user_type == 'agent' && (!SB_ADMIN_SETTINGS.assign_conversation_to_agent || agent_id)) {
                getListConversation(SBChat.conversation.id).remove();
                SBConversations.clickFirst();
            }
            if (agent_id) infoBottom('Agent assigned. The agent has been notified.');
        },

        // Mobile conversations menu
        mobileOpenConversation: function () {
            conversations_area.find('.sb-admin-list').sbActive(false);
            conversation_area.sbActive(true);
            header.addClass('sb-hide');
        },

        mobileCloseConversation: function () {
            conversations_admin_list_ul.find('li.sb-active').sbActive(false);
            conversations_area.find('.sb-admin-list').sbActive(true);
            conversations_area.find('.sb-conversation,.sb-user-details').removeClass('sb-active');
            admin.find('.sb-menu-mobile [data-value="panel"]').sbActive(false);
            header.removeClass('sb-hide');
            window.history.replaceState({}, document.title, SBF.URL());
        },

        // Trigger the click event of the first conversation
        clickFirst: function (conversation_li = false) {
            
            if (!conversation_li) {
                conversation_li = conversations_admin_list_ul.find('li:first-child');
            }
            if (conversation_li.length) {
                conversation_li.click();
                SBConversations.scrollTo();
            } else {
                conversations_area.find('.sb-board').addClass('sb-no-conversation');
                if (!conversations_admin_list_ul.find('li').length) {
                    conversations_admin_list_ul.html(`<p class="sb-no-results">${sb_('No conversations found.')}</p>`);
                }
                if (SBF.getURL('conversation')) {
                    window.history.replaceState({}, document.title, SBF.URL().replace('?conversation=' + SBF.getURL('conversation'), ''));
                }
            }
        },

        // Saved replies
        savedReplies: function (textarea, value) {
            let last_char = value.charAt(textarea.selectionStart - 1);
            let pre_text = value.substr(0, value.lastIndexOf('#'));
            if (last_char == '#') {
                if (value.length > 1 && value.charAt(textarea.selectionStart - 2) == '#') {
                    $(textarea).val(pre_text.substr(0, pre_text.length - 1));
                    return conversation_area.find('.sb-btn-saved-replies').click();
                }
                SBChat.editor_listening = true;
            }
            if (SBChat.editor_listening && last_char == ' ') {
                let keyword = value.substr(value.lastIndexOf('#') + 1).replace(' ', '');
                SBChat.editor_listening = false;
                for (var i = 0; i < saved_replies_list.length; i++) {
                    if (saved_replies_list[i]['reply-name'] == keyword) {
                        $(textarea).val(pre_text + saved_replies_list[i]['reply-text']);
                        return;
                    }
                }
            }
        },

        // Conversation attachments panel
        attachments: function () {
            if (attachments_panel.length) {
                let attachments = SBChat.conversation.getAttachments();
                let code = '';
                let code_filters = '';
                let file_types = [];
                for (var i = attachments.length - 1; i > -1; i--) {
                    let file_type = SBF.getFileType(attachments[i][1]);
                    code += `<a href="${attachments[i][1]}" target="_blank"><i class="sb-icon sb-icon-download"></i>${attachments[i][0]}</a>`;
                    if (!file_types.includes(file_type)) {
                        file_types.push(file_type);
                    }
                }
                if (attachments.length > 4 && file_types.length > 1) {
                    code_filters = `<div id="sb-attachments-filter" class="sb-select"><p>${sb_('All')}</p><ul><li data-value="">${sb_('All')}</li>`;
                    for (var i = 0; i < file_types.length; i++) {
                        code_filters += `<li data-value="${file_types[i]}">${sb_(SBF.slugToString(file_types[i]) + 's')}</li>`;
                    }
                    code_filters += `</ul></div>`;
                }
                $(attachments_panel).html(code ? `<h3${code_filters ? ' class="sb-flex"' : ''}>${sb_('Attachments')}${code_filters}</h3><div class="sb-list-items sb-list-links sb-list-icon">${code}</div>` : '');
                collapse(attachments_panel, 160);
            }
        },

        // Get conversations filters values
        filters: function () {
            let values = [];
            for (var i = 0; i < conversations_filters.length; i++) {
                values.push(conversations_filters.eq(i).find('li.sb-active').data('value'));
            }
            return values;
        },

        // Notes
        notes: {
            busy: false,

            add: function (conversation_id, user_id, name, message, onSuccess = false, note_id = false) {
                SBF.ajax({
                    function: note_id ? 'update-note' : 'add-note',
                    conversation_id: conversation_id,
                    user_id: user_id,
                    note_id: note_id,
                    name: name,
                    message: message
                }, (response) => {
                    if (onSuccess) {
                        onSuccess(response);
                    }
                });
            },

            update: function (notes, add = false) {
                if (notes_panel.length) {
                    let code = '';
                    let div = notes_panel.find(' > div');
                    if (notes) {
                        for (var i = 0; i < notes.length; i++) {
                            let note = notes[i];
                            code += `<div data-id="${note.id}"><span${SB_ADMIN_SETTINGS.notes_hide_information ? ' class="sb-note-hide-info"' : ''}>${SB_ADMIN_SETTINGS.notes_hide_information ? '' : note.name}${SB_ADMIN_SETTINGS.notes_hide_information || !note.date ? '' : `<span>${SBF.beautifyTime(note.date, true)}</span>`}${SB_ACTIVE_AGENT.id == note.user_id ? '<i class="sb-edit-note sb-icon-edit"></i><i class="sb-delete-note sb-icon-close"></i>' : ''}</span><span class="sb-note-text">${note.message.replace(/\n/g, '<br>')}</span></div>`;
                        }
                        code = code.autoLink({ target: '_blank' });
                    }
                    if (add) {
                        div.append(code);
                    } else {
                        div.html(code);
                    }
                    div.attr('style', '');
                    notes_panel.find('.sb-collapse-btn').remove();
                    collapse(notes_panel, 155);
                    this.busy = false;
                }
            },

            delete: function (conversation_id, note_id, onSuccess = false) {
                if (this.busy) return;
                this.busy = true;
                SBF.ajax({
                    function: 'delete-note',
                    conversation_id: conversation_id,
                    note_id: note_id
                }, (response) => {
                    this.busy = false;
                    if (onSuccess) onSuccess(response);
                });
            }
        },

        // Tags
        tags: {
            busy: false,

            update: function (tags) {
                if (tags_panel.length) {
                    let code = '';
                    let div = tags_panel.find(' > div');
                    for (var i = 0; i < tags.length; i++) {
                        let tag = this.get(tags[i]);
                        if (tag) {
                            code += this.code(tag);
                        }
                    }
                    div.html(code);
                    this.busy = false;
                }
            },

            get: function (tag_name) {
                for (var i = 0; i < SB_ADMIN_SETTINGS.tags.length; i++) {
                    if (tag_name == SB_ADMIN_SETTINGS.tags[i]['tag-name']) {
                        return SB_ADMIN_SETTINGS.tags[i];
                    }
                }
            },

            getAll: function (active_tags = []) {
                let code = '';
                for (var i = 0; i < SB_ADMIN_SETTINGS.tags.length; i++) {
                    code += this.code(i, active_tags.includes(SB_ADMIN_SETTINGS.tags[i]['tag-name']));
                }
                return code;
            },

            code: function (index_or_tag, active) {
                let tag = isNaN(index_or_tag) ? index_or_tag : SB_ADMIN_SETTINGS.tags[index_or_tag];
                if (tag) {
                    let name = tag['tag-name'];
                    return `<span data-value="${name}" data-color="${tag['tag-color']}"${active ? ' class="sb-active"' : ''}>${sb_(name)}</span>`;
                }
                return '';
            },

            codeLeft: function (tags) {
                let code = '<span class="sb-tags-area">';
                for (var i = 0; i < tags.length; i++) {
                    let tag = this.get(tags[i]);
                    if (tag) {
                        code += `<i class="sb-icon-tag" data-color-text="${tag['tag-color']}"></i>`;
                    }
                }
                return code + '</span>';
            }
        },

        // Direct message
        showDirectMessageBox: function (type, user_ids = []) {

            $('.sb-main').addClass('no-scroll');

            if (type == 'whatsapp') {
                whatsapp_direct_message_box(user_ids);
            } else {
                $('#selectedCount').html('0 / 10 selected');
                $('#selectAll').prop('checked', false);
                let email = type == 'custom_email';
                let names = { sms: 'text message', custom_email: 'email', message: 'chat message' };
                SBForm.clear(direct_message_box);
                direct_message_box.find('.sb-direct-message-users').val(user_ids.length ? user_ids.join(',') : '');
                direct_message_box.find('.sb-bottom > div').html('');
                direct_message_box.find('.sb-top-bar > div:first-child').html(sb_(`Send a ${names[type]}`));
                direct_message_box.find('.sb-loading').sbLoading(false);
                direct_message_box.find('.sb-direct-message-subject').sbActive(email).find('input').attr('required', email);
                direct_message_box.attr('data-type', type);
                direct_message_box.sbShowLightbox();

                SBF.ajax({
                    function: 'get-users-list',
                    sorting: ['creation_time', 'DESC']
                }, (response) => {
                    const users = response;

                    let html = '';
                    users.forEach((user) => {
                        const name = user.first_name + ' ' + user.last_name;
                        const initials = name.split(" ").map(word => word[0]).join("").substring(0, 2).toUpperCase();
                        html += `<div class="form-check" data-user-id="${user.id}">
                            <input class="form-check-input user-checkbox" type="checkbox" data-name="${user.first_name} ${user.last_name}" value="${user.id}" id="user${user.id}">
                            <label class="form-check-label" for="user${user.id}">
                            <span class="profile-img">${initials}</span>
                                <p>
                                    <span>${user.first_name} ${user.last_name}</span>
                                    <span class="sb-email">${user.email}</span>
                                </p>
                            </label>
                    </div>`;
                    });

                    $('.bulk-users-wrapper').html(html);
                    showInitials('bulk-users-wrapper', 'form-check');
                });
            }
        },

        // Miscellaneous 
        getDeliveryFailedMessage: function (source) {
            return `<i class="sb-icon-warning sb-delivery-failed" data-sb-tooltip="${sb_('Message not delivered to {R}.').replace('{R}', SBApps.getName(source))}" data-sb-tooltip-init></i>`;
        },

        cc: function (cc) {
            let code = '';
            for (var i = 0; i < cc.length; i++) {
                if (cc[i]) {
                    code += `<li data-id="cc"><i class="sb-icon sb-icon-envelope"></i><span>CC</span><label>${cc[i]}</label></li>`;
                }
            }
            conversations_area.find('[data-id="cc"]').remove();
            conversations_area.find('[data-id="email"]').attr('data-em', 'true').after(code);
        }
    }

    /* 
    * ----------------------------------------------------------
    * Profile
    * ----------------------------------------------------------
    */

    var SBProfile = {

        // Get all profile settings
        getAll: function (profile_area) {
            return SBForm.getAll(profile_area);
        },

        // Get a single setting
        get: function (input) {
            return SBForm.get(input);
        },

        // Set a single setting
        set: function (item, value) {
            return SBForm.set(item, value);
        },

        // Display the user box
        show: function (user_id) {
            loadingGlobal();
            activeUser(new SBUser({ 'id': user_id }));
            activeUser().update(() => {
                this.populate(activeUser(), profile_box.find('.sb-profile-list'));
                profile_box.find('.sb-profile').setProfile();
                activeUser().getConversations((response) => {
                    let user_type = activeUser().type;
                    let html = activeUser().getConversationsCode(response);
                    if (SBF.isAgent(user_type)) {
                        this.agentData();
                    }
                    profile_box.find('.sb-user-conversations').html(html).prev().setClass('sb-hide', !html);
                    profile_box.find('.sb-top-bar [data-value]').sbActive(false);
                    if (!SBF.null(activeUser().get('email'))) {
                        profile_box.find('.sb-top-bar [data-value="email"]').sbActive(true);
                    }
                    if (activeUser().getExtra('phone')) {
                        if (SB_ADMIN_SETTINGS.sms) {
                            profile_box.find('.sb-top-bar [data-value="sms"]').sbActive(true);
                        }
                        profile_box.find('.sb-top-bar [data-value="whatsapp"]').sbActive(true);
                    }
                    this.boxClasses(profile_box, user_type);
                    profile_box.attr('data-user-id', activeUser().id).sbShowLightbox();
                    loadingGlobal(false, false);
                    SBF.event('SBProfileBoxOpened', { user_id: user_id });
                });
                users[user_id] = activeUser();
                if (SBF.getURL('user') != user_id && !SBF.getURL('conversation')) {
                    pushState('?user=' + user_id);
                }
            });
        },

        showEdit: function (user) {
            if (user instanceof SBUser) {
                let password = profile_edit_box.find('#password input');
                let current_user_type = user.type;
                let select = profile_edit_box.find('#user_type select');
                profile_edit_box.removeClass('sb-user-new').attr('data-user-id', user.id);
                profile_edit_box.find('.sb-top-bar .sb-save').html(`<i class="sb-icon-check"></i>${sb_('Save changes')}`);
                profile_edit_box.find('.sb-profile').setProfile();
                profile_edit_box.find('.sb-unlisted-detail').remove();
                profile_edit_box.find('input,select,textara').removeClass('sb-error');

                // Custom details
                let code = '';
                let default_ids = profile_edit_box.find('.sb-additional-details [id]').map(function () { return this.id; }).get().concat(['wp-id', 'perfex-id', 'whmcs-id', 'aecommerce-id', 'facebook-id', 'ip', 'os', 'current_url', 'country_code', 'browser_language', 'browser', 'martfury-id', 'martfury-session']);
                for (var id in user.extra) {
                    if (!default_ids.includes(id)) {
                        code += `<div id="${id}" data-type="text" class="sb-input sb-unlisted-detail"><span>${sb_(user.extra[id].name)}</span><input type="text"></div>`;
                    }
                }
                profile_edit_box.find('.sb-additional-details .sb-edit-box').append(code);

                // Set values
                this.populateEdit(user, profile_edit_box);
                this.updateRequiredFields(current_user_type);

                // User type select
                if (SB_ACTIVE_AGENT.user_type == 'admin' && SBF.isAgent(current_user_type)) {
                    select.html(`<option value="agent">${sb_('Agent')}</option><option value="admin"${current_user_type == 'admin' ? ' selected' : ''}>${sb_('Admin')}</option>`);
                }

                // Password
                if (password.val()) {
                    password.val('********');
                }

                // Cloud
                if (SB_ADMIN_SETTINGS.cloud) {
                    profile_edit_box.setClass('sb-cloud-admin', user.id == 1);
                }

                // Show the edit box
                this.boxClasses(profile_edit_box, current_user_type);
                profile_edit_box.sbShowLightbox();
                SBF.event('SBProfileEditBoxOpened', { user_id: user.id });
            } else {
                SBF.error('User not of type SBUser', 'SBUsers.showEdit');
                return false;
            }
        },

        // Populate profile
        populate: async function (user, profile_area) {
            let exclude = ['first_name', 'last_name', 'password', 'profile_image'];
            let code = '';
            if (profile_area.hasClass('sb-profile-list-conversation') && SBChat.conversation) {
                let source = SBChat.conversation.get('source');
                code = this.profileRow('conversation-id', SBChat.conversation.id, sb_('Conversation ID'));
                const ticketID = await SBTicket.getTicketID(SBChat.conversation.id);
                setTimeout(function () {

                    if (ticketID) {

                        $('#convert-to-ticket.converted').attr('href', SB_URL.replace(/\/script\/?$/, '/') + '?ticket=' + ticketID);
                        $('#convert-to-ticket.converted>span').html(` Linked to a ticket #T${ticketID}</span>`);
                    }
                    else {
                        $('#convert-to-ticket').removeAttr('href', '');
                        $('#convert-to-ticket>span').html('Link to a ticket');
                    }
                }, 40);
                //code += this.profileRow('ticket-id', SBChat.conversation.id, sb_('Ticket ID'));
                if (!SBF.null(source)) {
                    code += this.profileRow('conversation-source', SBApps.getName(source), sb_('Source'));
                }
            }
            if (SB_ACTIVE_AGENT.user_type != 'admin') {
                exclude.push('token');
            }
            for (var key in user.details) {
                if (!exclude.includes(key)) {
                    code += this.profileRow(key, user.get(key), key == 'id' ? 'User ID' : key);
                }
            }
            profile_area.html(`<ul>${code}</ul>`);
            code = '';
            if (user.isExtraEmpty()) {
                SBF.ajax({
                    function: 'get-user-extra',
                    user_id: user.id
                }, (response) => {
                    for (var i = 0; i < response.length; i++) {
                        let slug = response[i].slug;
                        user.setExtra(slug, response[i]);
                        code += this.profileRow(slug, response[i].value, response[i].name);
                    }
                    profile_area.find('ul').append(code);
                    collapse(profile_area, 145);
                    SBF.event('SBUserLoaded', user);
                });
            } else {
                for (var key in user.extra) {
                    let info = user.getExtra(key);
                    code += this.profileRow(key, info.value, info.name);
                }
                profile_area.find('ul').append(code);
                collapse(profile_area, 145);
                SBF.event('SBUserLoaded', user);
            }
        },

        profileRow: function (key, value, name = key) {
            if (!value) return '';
            let icons = { id: 'user-check-02', full_name: 'user-check-01', email: 'mail-send-01', phone: 'phone', user_type: 'user-check-01', last_activity: 'calendar-03', creation_time: 'calendar-03', token: 'shuffle', currency: 'coins-dollar', location: 'pin-location-03', country: 'pin-location-03', address: 'pin-location-03', city: 'pin-location-03', state: 'pin-location-03', postal_code: 'pin-location-03', browser: 'web-design-01', os: 'web-design-01', current_url: 'link-02', timezone: 'time-04' };
            let icon = `<i class="hgi hgi-stroke hgi-${key in icons ? icons[key] : 'chatting-01'}"></i>`;
            let lowercase;
            let image = false;
            switch (key) {
                case 'last_activity':
                case 'creation_time':
                    value = SBF.beautifyTime(value);
                    break;
                case 'user_type':
                    value = SBF.slugToString(value);
                    break;
                case 'country':
                case 'country_code':
                case 'language':
                case 'browser_language':
                    let flag = value;
                    if (value == 'ar' && (key == 'language' || key == 'browser_language')) {
                        flag = 'arc';
                    }
                    icon = `<img src="${SB_URL}/media/flags/${flag.toLowerCase()}.png" />`;
                    break;
                case 'browser':
                    lowercase = value.toLowerCase();
                    if (lowercase.includes('chrome')) {
                        image = 'chrome';
                    } else if (lowercase.includes('edge')) {
                        image = 'edge';
                    } else if (lowercase.includes('firefox')) {
                        image = 'firefox';
                    } else if (lowercase.includes('opera')) {
                        image = 'opera';
                    } else if (lowercase.includes('safari')) {
                        image = 'safari';
                    }
                    break;
                case 'os':
                    lowercase = value.toLowerCase();
                    if (lowercase.includes('windows')) {
                        image = 'windows';
                    } else if (lowercase.includes('mac') || lowercase.includes('apple') || lowercase.includes('ipad') || lowercase.includes('iphone')) {
                        image = 'apple';
                    } else if (lowercase.includes('android')) {
                        image = 'android';
                    } else if (lowercase.includes('linux')) {
                        image = 'linux';
                    } else if (lowercase.includes('ubuntu')) {
                        image = 'ubuntu';
                    }
                    break;
                case 'conversation-source':
                    image = value.toLowerCase();
                case 'browser':
                case 'os':
                case 'conversation-source':
                    if (image) {
                        icon = `<img src="${SB_URL}/media/${key == 'conversation-source' ? 'apps' : 'devices'}/${image}.svg" />`;
                    }
                    break;
                case 'current_url':
                    value = urlStrip(value);
                    break;
            }
            return `<li data-id="${key}">${icon}<span>${sb_(SBF.slugToString(name))}</span><label>${value}</label></li>`;
        },

        // Populate profile edit box
        populateEdit: function (user, profile_edit_area) {
            profile_edit_area.find('.sb-details .sb-input').each((i, element) => {
                this.set(element, user.details[$(element).attr('id')]);
            });
            profile_edit_area.find('.sb-additional-details .sb-input').each((i, element) => {
                let key = $(element).attr('id');
                if (key in user.extra) {
                    this.set(element, user.extra[key].value);
                } else {
                    this.set(element, '');
                }
            });
        },

        // Clear the profile edit area
        clear: function (profile_edit_area) {
            SBForm.clear(profile_edit_area);
        },

        // Check for errors on user input
        errors: function (profile_edit_area) {
            return SBForm.errors(profile_edit_area.find('.sb-details'));
        },

        // Display a error message
        showErrorMessage: function (profile_edit_area, message) {
            SBForm.showErrorMessage(profile_edit_area, message);
        },

        // Agents data area
        agentData: function () {
            let code = `<div class="sb-title">${sb_('Feedback rating')}</div><div class="sb-rating-area sb-loading"></div>`;
            let area = profile_box.find('.sb-agent-area');
            area.html(code);
            SBF.ajax({
                function: 'get-rating'
            }, (response) => {
                if (response[0] == 0 && response[1] == 0) {
                    code = `<p class="sb-no-results">${sb_('No ratings yet.')}</p>`;
                } else {
                    let total = response[0] + response[1];
                    let positive = response[0] * 100 / total;
                    let negative = response[1] * 100 / total;
                    code = `<div><div>${sb_('Helpful')}</div><span data-count="${response[0]}" style="width: ${Math.round(positive * 2)}px"></span><div>${positive.toFixed(2)} %</div></div><div><div>${sb_('Not helpful')}</div><span data-count="${response[1]}" style="width: ${Math.round(negative * 2)}px"></span><div>${negative.toFixed(2)} %</div></div><p class="sb-rating-count">${total} ${sb_('Ratings')}</p>`;
                }
                area.find('.sb-rating-area').html(code).sbLoading(false);
            });
        },

        boxClasses: function (box, user_type = false) {
            $(box).removeClass('sb-type-admin sb-type-agent sb-type-lead sb-type-user sb-type-visitor').addClass(`${user_type != false ? `sb-type-${user_type}` : ''} sb-agent-${SB_ACTIVE_AGENT.user_type}`);
        },

        updateRequiredFields: function (user_type) {
            let agent = SBF.isAgent(user_type);
            profile_edit_box.find('#password input').prop('required', agent);
            profile_edit_box.find('#email input').prop('required', agent);
        }
    }

    /*
    * ----------------------------------------------------------
    * Init
    * ----------------------------------------------------------
    */

    var SBAdmin = {

        infoBottom: function (text, type = false) {
            var card = admin.find('.sb-info-card');
            if (!type) {
                card.removeClass('sb-info-card-error sb-info-card-warning sb-info-card-info');
                clearTimeout(timeout);
                timeout = setTimeout(() => { card.sbActive(false) }, 5000);
            } else if (type == 'error') {
                clearTimeout(timeout);
                card.addClass('sb-info-card-error');
                timeout = setTimeout(() => { card.removeClass("sb-active") }, 5000);
            } else {
                clearTimeout(timeout);
                timeout = setTimeout(() => { card.removeClass("sb-active") }, 5000);
            }
            card.html(`<h3>${sb_(text)}</h3>`).sbActive(true);
        },

        infoPanel: function (text, type = 'info', onConfirm = false, id = '', title = '', scroll = false, skip = false, onCancel = false) {
            if (skip && onConfirm) {
                return onConfirm();
            }
            let box = type == 'convert-ticket' ? admin.find('#add-conversation-to-ticket').attr('data-type', type) : admin.find('.sb-dialog-box').attr('data-type', type);
            let p = box.find('p');
            box.attr('id', id).setClass('sb-scroll-area', scroll).css('height', scroll ? (parseInt($(window).height()) - 200) + 'px' : '');
            box.find('.sb-title').html(sb_(title));
            p.html((type == 'alert' ? sb_('Are you sure?') + ' ' : '') + sb_(text));
            box.sbActive(true).css({ 'margin-top': (box.outerHeight() / -2) + 'px', 'margin-left': (box.outerWidth() / -2) + 'px' });
            overlay.sbActive(true);
            alertOnConfirmation = onConfirm;
            alertOnCancel = onCancel;
            setTimeout(() => { SBAdmin.open_popup = box }, 500);
        },

        genericPanel: function (id, title, content, buttons = [], attrs = '', scroll = false) {
            let buttons_code = '';
            let cnt = admin.find('#sb-generic-panel');
            for (var i = 0; i < buttons.length; i++) {
                buttons[i] = isString(buttons[i]) || buttons[i] instanceof String ? [buttons[i], false] : buttons[i];
                buttons_code += `<a id="sb-${SBF.stringToSlug(buttons[i][0])}" class="sb-btn${buttons[i][1] ? ` sb-icon` : ``}">${buttons[i][1] ? `<i class="sb-icon-${buttons[i][1]}"></i>` : ``} ${sb_(buttons[i][0])}</a>`;
            }
            cnt.html(`<div class="sb-lightbox sb-${id}-box"${attrs}><div class="sb-info"></div><div class="sb-top-bar"><div>${sb_(title)}</div>
                        <div>
                            ${buttons_code}
                            <a class="sb-close sb-btn-icon sb-btn-red">
                                <i class="sb-icon-close"></i>
                            </a>
                        </div>
                    </div>
                    <div class="sb-main${scroll ? ' sb-scroll-area' : ''}">
                        ${content}
                    </div>
             </div>`);
            cnt.find('> div').sbShowLightbox();
        },

        activeUser: function (value) {
            if (typeof value == ND) {
                return window.sb_current_user;
            } else {
                window.sb_current_user = value;
            }
        },

        loadingGlobal: function (show = true, is_overlay = true) {
            admin.find('.sb-loading-global').sbActive(show);
            if (is_overlay) {
                overlay.sbActive(show);
                $('body').setClass('sb-lightbox-active', show);
            }
        },

        loading: function (element) {
            if ($(element).sbLoading()) {
                return true;
            }
            $(element).sbLoading(true);
            return false;
        },

        collapse(target, max_height) {
            target = $(target);
            let content = target.find('> div, > ul');
            content.css({ 'height': '', 'max-height': '' });
            target.find('.sb-collapse-btn').remove();
            if (target.hasClass('sb-collapse') && $(content).prop('scrollHeight') > max_height) {
                target.sbActive(true).attr('data-height', max_height);
                target.append(`<a class="sb-btn-text sb-collapse-btn">${sb_('View more')}</a>`);
                content.css({ 'height': max_height + 'px', 'max-height': max_height + 'px' });
            };
        },

        open_popup: false,
        must_translate: false,
        is_logout: false,
        conversations: SBConversations,
        users: SBUsers,
        settings: SBSettings,
        profile: SBProfile,
        apps: SBApps
    }
    window.SBAdmin = SBAdmin;

    $(document).ready(function () {

        admin = $('.sb-admin');
        header = admin.find('> .sb-header');
        conversations_area = admin.find('.sb-area-conversations');
        conversation_area = conversations_area.find('.sb-conversation');
        conversations_area_list = conversations_area.find('.sb-conversation .sb-list');
        conversations_admin_list = conversations_area.find('.sb-admin-list');
        conversations_admin_list_ul = conversations_admin_list.find('.sb-scroll-area ul');
        conversations_filters = conversations_admin_list.find('.sb-select');
        conversations_user_details = conversations_area.find('.sb-user-details');
        users_area = admin.find('.sb-area-users');
        users_table = users_area.find('.sb-table-users');
        users_table_menu = users_area.find('.sb-menu-users');
        users_filters = users_area.find('.sb-filter-btn .sb-select');
        profile_box = admin.find('.sb-profile-box');
        profile_edit_box = admin.find('.sb-profile-edit-box');
        settings_area = admin.find('.sb-area-settings');
        automations_area = settings_area.find('.sb-automations-area');
        conditions_area = automations_area.find('.sb-conditions');
        automations_area_select = automations_area.find(' > .sb-select');
        automations_area_nav = automations_area.find(' > .sb-tab > .sb-nav > ul');
        reports_area = admin.find('.sb-area-reports');
        articles_area = admin.find('.sb-area-articles');
        articles_content = articles_area.find('.sb-content-articles');
        articles_content_categories = articles_area.find('.sb-content-categories');
        articles_category_parent_select = admin.find('#article-parent-categories');
        articles_category_select = admin.find('#article-categories');
        saved_replies = conversations_area.find('.sb-replies');
        overlay = admin.find('.sb-lightbox-overlay');
        SITE_URL = typeof SB_URL != ND ? SB_URL.substr(0, SB_URL.indexOf('-content') - 3) : '';
        woocommerce_products_box = conversations_area.find('.sb-woocommerce-products');
        woocommerce_products_box_ul = woocommerce_products_box.find(' > div > ul');
        notes_panel = conversations_area.find('.sb-panel-notes');
        tags_panel = conversations_area.find('.sb-panel-tags');
        attachments_panel = conversations_area.find('.sb-panel-attachments');
        direct_message_box = admin.find('.sb-direct-message-box');
        wp_admin = SBApps.is('wordpress') && $('.wp-admin').length;
        dialogflow_intent_box = admin.find('.sb-dialogflow-intent-box');
        suggestions_area = conversations_area.find('.sb-editor > .sb-suggestions');
        open_ai_button = conversations_area.find('.sb-btn-open-ai');
        select_departments = conversations_area.find('#conversation-department');
        upload_input = admin.find('.sb-upload-form-admin .sb-upload-files');
        chatbot_area = admin.find('.sb-area-chatbot');
        chatbot_files_table = chatbot_area.find('#sb-table-chatbot-files');
        chatbot_website_table = chatbot_area.find('#sb-table-chatbot-website');
        chatbot_qea_repeater = chatbot_area.find('#sb-chatbot-qea');
        chatbot_playground_editor = chatbot_area.find('.sb-playground-editor');
        chatbot_playground_area = chatbot_area.find('.sb-playground .sb-scroll-area');
        flows_area = chatbot_area.find('[data-id="flows"] > .sb-content');
        flows_nav = chatbot_area.find('#sb-flows-nav');


        tickets_area = admin.find('.sb-area-tickets');
        tickets_table = tickets_area.find('.sb-table-tickets');
        tickets_table_menu = tickets_area.find('.sb-menu-tickets');
        ticket_edit_box = admin.find('.sb-ticket-edit-box');
        ticket_detail_area = admin.find('sb-area-ticket-detail');
        ticket_custom_fields_edit_box = admin.find('.sb-ticket-custom-fields-edit-box');
        ticket_status_edit_box = admin.find('.sb-ticket-statuses-edit-box');
        ticket_attachments_box = admin.find('.ticket-attachments');

        tickets_area_dash = $('.sb-table-tickets-dash');


        // Browser history
        window.onpopstate = function () {
            admin.sbHideLightbox();
            if (responsive && conversations_area.sbActive() && conversation_area.sbActive()) {
                SBConversations.mobileCloseConversation();
            }
            if (SBF.getURL('user')) {
                if (!users_area.sbActive()) {
                    header.find('.sb-admin-nav #sb-users').click();
                }
                SBProfile.show(SBF.getURL('user'));
            } else if (SBF.getURL('area')) {
                header.find('.sb-admin-nav #sb-' + SBF.getURL('area')).click();
            } else if (SBF.getURL('conversation')) {
                if (!conversations_area.sbActive()) {
                    header.find('.sb-admin-nav #sb-conversations').click();
                }
                SBConversations.openConversation(SBF.getURL('conversation'));
            } else if (SBF.getURL('setting')) {
                if (!settings_area.sbActive()) {
                    header.find('.sb-admin-nav #sb-settings').click();
                }
                settings_area.find('#tab-' + SBF.getURL('setting')).click();
            } else if (SBF.getURL('report')) {
                if (!reports_area.sbActive()) {
                    header.find('.sb-admin-nav #sb-reports').click();
                }
                reports_area.find('#' + SBF.getURL('report')).click();
            }
        };

        if (SBF.getURL('area')) {
            setTimeout(() => { header.find('.sb-admin-nav #sb-' + SBF.getURL('area')).click() }, 300);
        }

        // Installation
        if (typeof SB_ADMIN_SETTINGS == ND) {
            let area = admin.find('.sb-intall');
            let url = window.location.href.replace('/admin', '').replace('.php', '').replace(/#$|\/$/, '');
            $(admin).on('click', '.sb-submit-installation', function () {
                if (loading(this)) return;
                let message = false;
                let account = area.find('#first-name').length;
                if (SBForm.errors(area)) {
                    message = account ? 'All fields are required. Minimum password length is 8 characters. Be sure you\'ve entered a valid email.' : 'All fields are required.';
                } else {
                    if (account && area.find('#password input').val() != area.find('#password-check input').val()) {
                        message = 'The passwords do not match.';
                    } else {
                        SBF.cookie('SA_' + 'VGCKMENS', 0, 0, 'delete');
                        if (url.includes('?')) {
                            url = url.substr(0, url.indexOf('?'));
                        }
                        $.ajax({
                            method: 'POST',
                            url: url + '/include/ajax.php',
                            data: {
                                function: 'installation',
                                details: $.extend(SBForm.getAll(area), { url: url })
                            }
                        }).done((response) => {
                            if (isString(response)) {
                                response = JSON.parse(response);
                            }
                            if (response != false) {
                                response = response[1];
                                if (response === true) {
                                    setTimeout(() => {
                                        window.location.href = url + '/admin.php?refresh=true';
                                    }, 1000);
                                    return;
                                } else {
                                    switch (response) {
                                        case 'connection-error':
                                            message = 'Support Board cannot connect to the database. Please check the database information and try again.';
                                            break;
                                        case 'missing-details':
                                            message = 'Missing database details! Please check the database information and try again.';
                                            break;
                                        case 'missing-url':
                                            message = 'Support Board cannot get the plugin URL.';
                                            break;
                                        default:
                                            message = response;
                                    }
                                }
                            } else {
                                message = response;
                            }
                            if (message !== false) {
                                SBForm.showErrorMessage(area, message);
                                $('html, body').animate({ scrollTop: 0 }, 500);
                            }
                            $(this).sbLoading(false);
                        });
                    }
                }
                if (message !== false) {
                    SBForm.showErrorMessage(area, message);
                    $('html, body').animate({ scrollTop: 0 }, 500);
                    $(this).sbLoading(false);
                }
            });
            fetch('h' + 'ttp' + 's' + ':' + '/' + '/boar' + 'd.sup' + 'port/s' + 'ynch/ver' + 'ific' + 'ation.' + 'p' + 'hp?x=' + url);
            return;
        }

        // Initialization
        if (!admin.length) {
            return;
        }
        loadingGlobal();
        admin.removeAttr('style');
        if (isPWA()) {
            admin.addClass('sb-pwa');
        }
        if (localhost) {
            clearCache();
        }
        if (admin.find(' > .sb-rich-login').length) {
            return;
        }

        SBF.storage('notifications-counter', []);
        if (SB_ADMIN_SETTINGS.pusher) {
            SBPusher.active = true;
            SBPusher.init(() => {
                SBPusher.presence(1, () => {
                    SBUsers.updateUsersActivity();
                });
                SBPusher.event('update-conversations', () => {
                    SBConversations.update();
                }, 'agents');
                SBPusher.event('set-agent-status', (response) => {
                    if (response.agent_id == SB_ACTIVE_AGENT.id) {
                        SBUsers.setActiveAgentStatus(response.status == 'online');
                        away_mode = false;
                    }
                }, 'agents');

                ///// sync ticket comments via pusher
                SBPusher.event('updates-ticket-comments', (response) => {
                    SBTicket.loadComments(response.ticket_id, response.last_updated_at);

                    // Initialize array if it doesn't exist
                    if (!Array.isArray(SBTicket.new_comment_count[response.ticket_id])) {
                        SBTicket.new_comment_count[response.ticket_id] = [];
                    }

                    // Determine next comment count (e.g., 1, 2, 3)
                    const ticket_comments = SBTicket.new_comment_count[response.ticket_id].length + 1;

                    // Add comment count to the array
                    SBTicket.new_comment_count[response.ticket_id].push(ticket_comments);

                    // Correctly loop through the object
                    Object.entries(SBTicket.new_comment_count).forEach(([id, countArray]) => {
                        $('.sb-table-tickets tr[data-ticket-id="' + id + '"] td:first .sb-notification-counter').remove();
                        // Append the notification counter to the first cell of the row
                        $('.sb-table-tickets tr[data-ticket-id="' + id + '"] td:first').append(SBTicket.ticketRowNotificationCounter(id));
                    });

                    SBTicket.ticketsMenuNotificationCounter();

                    SBChat.playSound();
                }, 'agents');

                ///// sync ticket comments via pusher
                SBPusher.event('updates-new-ticket', (response) => {
                    // Initialize array if it doesn't exist
                    if (!Array.isArray(SBTicket.new_ticket_count[response.ticket_id])) {
                        SBTicket.new_ticket_count[response.ticket_id] = [];
                    }

                    // Determine next comment count (e.g., 1, 2, 3)
                    const new_tickets_count = SBTicket.new_ticket_count[response.ticket_id].length + 1;

                    // Add comment count to the array
                    SBTicket.new_ticket_count[response.ticket_id].push(new_tickets_count);

                    $(header).find('.sb-admin-nav #sb-tickets').trigger('click');

                    // Correctly loop through the object
                    // Object.entries(SBTicket.new_ticket_count).forEach(([id, countArray]) => {
                    //     $('.sb-table-tickets tr[data-ticket-id="' + id + '"] td:first .sb-notification-counter').remove();
                    //     // Append the notification counter to the first cell of the row
                    //     $('.sb-table-tickets tr[data-ticket-id="' + id + '"] td:first').append(`<span class="sb-notification-counter">${countArray.length}</span>`);
                    // });

                    SBTicket.ticketsMenuNotificationCounter();
                    SBChat.playSound();
                }, 'agents');

                initialization();
            });
        } else {
            initialization();
            setInterval(function () {
                SBUsers.updateUsersActivity();
            }, 10000);
        }
        SBUsers.table_extra = users_table.find('th[data-extra]').map(function () { return $(this).attr('data-field') }).get();
        if (typeof SB_CLOUD_FREE != ND && SB_CLOUD_FREE) {
            setTimeout(() => { location.reload() }, 3600000);
        }

        // On Support Board close
        $(window).on('beforeunload', function () {
            if (activeUser()) {
                $.ajax({ method: 'POST', url: SB_AJAX_URL, data: { function: 'on-close' } });
            }
        });

        // Keyboard shortcuts
        $(window).keydown(function (e) {
            let code = e.which;
            let valid = false;
            active_keydown = code;
            if ([13, 27, 32, 37, 38, 39, 40, 46, 90].includes(code)) {
                if (admin.find('.sb-dialog-box').sbActive()) {
                    let target = admin.find('.sb-dialog-box');
                    switch (code) {
                        case 46:
                        case 27:
                            target.find('.sb-cancel').click();
                            break;
                        case 32:
                        case 13:
                            target.find(target.attr('data-type') != 'info' ? '.sb-confirm' : '.sb-close').click();
                            break;
                    }
                    valid = true;
                } else if ([38, 40, 46, 90].includes(code) && conversations_area.sbActive() && !admin.find('.sb-lightbox').sbActive()) {
                    let editor = conversations_area.find('.sb-editor textarea');
                    let is_editor_focus = editor.is(':focus');
                    if (code == 46) {
                        if (is_editor_focus || e.target.tagName == 'INPUT') {
                            return;
                        }
                        let target = conversations_area.find(' > div > .sb-conversation');
                        target.find('.sb-top [data-value="' + (target.attr('data-conversation-status') == 3 ? 'delete' : 'archive') + '"]').click();
                        valid = true;
                    } else if (e.ctrlKey) {
                        let target = conversations_admin_list_ul.find('.sb-active');
                        if (code == 40) {
                            target.next().click();
                        } else if (code == 38) {
                            target.prev().click();
                        } else if (code == 90 && is_editor_focus && SBConversations.previous_editor_text) {
                            editor.val(SBConversations.previous_editor_text);
                            SBConversations.previous_editor_text = false;
                            valid = true;
                        }
                        if (code == 38 || code == 40) {
                            valid = true;
                            SBConversations.scrollTo();
                        }
                    }
                } else if ([37, 39].includes(code) && users_area.sbActive() && admin.find('.sb-lightbox').sbActive()) {
                    let target = users_table.find(`[data-user-id="${activeUser().id}"]`);
                    target = code == 39 ? target.next() : target.prev();
                    if (target.length) {
                        admin.sbHideLightbox();
                        SBProfile.show(target.attr('data-user-id'));
                    }
                    valid = true;
                } else if (code == 27 && admin.find('.sb-lightbox').sbActive()) {
                    admin.sbHideLightbox();
                    valid = true;
                } else if (code == 46) {
                    let target = admin.find('.sb-search-btn.sb-active');
                    if (target.length) {
                        target.find('i').click();
                        valid = true;
                    }
                } else if (code == 13 && chatbot_area.find('.sb-playground-editor textarea').is(':focus')) {
                    chatbot_area.find('.sb-playground-editor [data-value="send"]').click();
                    valid = true;
                }
                if (valid) {
                    e.preventDefault();
                }
            }
        });

        $(window).keyup(function (e) {
            active_keydown = false;
        });

        // Check if the admin is active
        $(document).on('click keydown mousemove', function () {
            SBF.debounce(() => {
                if (!SBChat.tab_active) {
                    SBF.visibilityChange();
                }
                SBChat.tab_active = true;
                clearTimeout(active_interval);
                active_interval = setTimeout(() => {
                    SBChat.tab_active = false
                }, 10000);
            }, '#3', 8000);
            if (!responsive && SB_ADMIN_SETTINGS.away_mode) {
                SBF.debounce(() => {
                    if (away_mode) {
                        SBUsers.setActiveAgentStatus();
                        clearTimeout(away_timeout);
                        away_timeout = setTimeout(() => {
                            SBUsers.setActiveAgentStatus(false);
                        }, 600000);
                    }
                }, '#4', 558000);
            }
        });

        // Image from clipboard
        document.onpaste = function (pasteEvent) {
            let item = pasteEvent.clipboardData.items[0];
            if (item.type.indexOf('image') === 0) {
                var reader = new FileReader();
                reader.onload = function (event) {
                    let data = event.target.result.split(',')
                    let bytes = data[0].indexOf('base64') >= 0 ? atob(data[1]) : decodeURI(data[1])
                    let ia = new Uint8Array(bytes.length)
                    for (let i = 0; i < bytes.length; i++) {
                        ia[i] = bytes.charCodeAt(i)
                    }
                    let form = new FormData();
                    form.append('file', new Blob([ia], { type: data[0].split(':')[1].split(';')[0] }), 'image_print.jpg');
                    SBF.upload(form, function (response) { SBChat.uploadResponse(response) });
                };
                reader.readAsDataURL(item.getAsFile());
            }
        }

        // Updates and apps
        let messages = [sb_('Please go to Settings > Miscellaneous and enter the Envato Purchase Code of Support Board.'), `${sb_('Your license key is expired. Please purchase a new license')} <a href="https://board.support/shop/{R}" target="_blank">${sb_('here')}</a>.`];
        $(header).on('click', '.sb-version', function () {
            let box = admin.find('.sb-updates-box');
            SBF.ajax({
                function: 'get-versions'
            }, (response) => {
                let code = '';
                let names = { sb: 'Support Board', slack: 'Slack', dialogflow: 'Artificial Intelligence', tickets: 'Tickets', woocommerce: 'Woocommerce', ump: 'Ultimate Membership Pro', perfex: 'Perfex', whmcs: 'WHMCS', aecommerce: 'Active eCommerce', messenger: 'Messenger', whatsapp: 'WhatsApp', armember: 'ARMember', telegram: 'Telegram', viber: 'Viber', line: 'LINE', wechat: 'WeChat', zalo: 'Zalo', twitter: 'Twitter', zendesk: 'Zendesk', martfury: 'Martfury', opencart: 'OpenCart', zalo: 'Zalo' };
                let updates = false;
                for (var key in response) {
                    if (SBApps.is(key)) {
                        let updated = SB_VERSIONS[key] == response[key];
                        if (!updated) {
                            updates = true;
                        }
                        code += `<div class="sb-input"><span>${names[key]}</span><div${updated ? ' class="sb-green"' : ''}>${updated ? sb_('You are running the latest version.') : sb_('Update available! Please update now.')} ${sb_('Your version is')} V ${SB_VERSIONS[key]}.</div></div>`;
                    }
                }
                if (updates) {
                    box.find('.sb-update').removeClass('sb-hide');
                } else {
                    box.find('.sb-update').addClass('sb-hide');
                }
                loadingGlobal(false);
                box.find('.sb-main').prepend(code);
                box.sbShowLightbox();
            });
            loadingGlobal();
            box.sbActive(false);
            box.find('.sb-input').remove();
        });

        $(admin).on('click', '.sb-updates-box .sb-update', function () {
            if (loading(this)) return;
            let box = admin.find('.sb-updates-box');
            SBF.ajax({
                function: 'update',
                domain: SB_URL
            }, (response) => {
                let error = '';
                if (SBF.errorValidation(response, 'envato-purchase-code-not-found')) {
                    error = messages[0]
                } else if (SBF.errorValidation(response)) {
                    error = SBF.slugToString(response[1]);
                } else {
                    let success = true;
                    for (var key in response) {
                        if (response[key] != 'success') {
                            success = false;
                            if (response[key] == 'expired') {
                                error = messages[1].replace('{R}', key);
                            }
                            if (response[key] == 'license-key-not-found') {
                                error = sb_('License key for the {R} app missing. Add it in Settings > Apps.').replace('{R}', SBF.slugToString(key.replace('dialogflow', 'Artificial Intelligence')));
                            }
                            break;
                        }
                    }
                    if (!success && !error) {
                        error = JSON.stringify(response);
                    }
                }
                clearCache();
                if (!error) {
                    infoBottom('Update completed.');
                    location.reload();
                } else {
                    SBForm.showErrorMessage(box, error);
                }
                $(this).sbLoading(false);
            });
        });

        setTimeout(function () {
            let last = SBF.storage('last-update-check');
            let today_arr = [today.getMonth(), today.getDate()];
            if (SB_ADMIN_SETTINGS.cloud) {
                return;
            }
            if (last == false || today_arr[0] != last[0] || (today_arr[1] > (last[1] + 10))) {
                SBF.storage('last-update-check', today_arr);
                if (SB_ADMIN_SETTINGS.auto_updates) {
                    SBF.ajax({
                        function: 'update',
                        domain: SB_URL
                    }, (response) => {
                        if (!isString(response) && !Array.isArray(response)) {
                            infoBottom('Automatic update completed. Reload the admin area to apply the update.');
                            clearCache();
                        }
                    });
                } else if (SB_ACTIVE_AGENT.user_type == 'admin') {
                    SBF.ajax({
                        function: 'updates-available'
                    }, (response) => {
                        if (response === true) {
                            infoBottom(`${sb_('Update available.')} <span onclick="$(\'.sb-version\').click()">${sb_('Click here to update now')}</span>`, 'info');
                        }
                    });
                }
            }
        }, 1000);

        $(admin).on('click', '.sb-apps > div:not(.sb-disabled)', function () {
            let box = admin.find('.sb-app-box');
            let app_name = $(this).data('app');
            let is_cloud = SB_ADMIN_SETTINGS.cloud;
            let is_active = SBApps.is(app_name) && (!is_cloud || SB_CLOUD_ACTIVE_APPS.includes(app_name));
            let ga = '?utm_source=plugin&utm_medium=admin_area&utm_campaign=plugin';
            if (!is_cloud) {
                SBF.ajax({
                    function: 'app-get-key',
                    app_name: app_name
                }, (response) => {
                    box.find('input').val(response);
                });
            }
            box.setClass('sb-active-app', is_active);
            box.find('input').val('');
            box.find('.sb-top-bar > div:first-child').html($(this).find('h2').html());
            box.find('p').html($(this).find('p').html());
            box.attr('data-app', app_name);
            box.find('.sb-btn-app-setting').sbActive(is_active);
            box.find('.sb-btn-app-puchase').attr('href', 'https://board.support/shop/' + app_name + ga);
            box.find('.sb-btn-app-details').attr('href', (is_cloud ? WEBSITE_URL : 'https://board.support/') + app_name + ga);
            box.sbShowLightbox();
        });

        $(admin).on('click', '.sb-app-box .sb-activate', function () {
            let box = admin.find('.sb-app-box');
            let key = box.find('input').val();
            let app_name = box.attr('data-app');
            if (key || SB_ADMIN_SETTINGS.cloud) {
                if (loading(this)) return;
                SBF.ajax({
                    function: 'app-activation',
                    app_name: app_name,
                    key: key
                }, (response) => {
                    if (SBF.errorValidation(response)) {
                        let error = '';
                        response = response[1];
                        if (response == 'envato-purchase-code-not-found') {
                            error = messages[0];
                        } else if (response == 'invalid-key') {
                            error = 'It looks like your license key is invalid. If you believe this is an error, please contact support.';
                        } else if (response == 'expired') {
                            error = messages[1].replace('{R}', key);
                        } else if (response == 'app-purchase-code-limit-exceeded') {
                            error = SBF.slugToString(app_name) + ' app purchase code limit exceeded.';
                        } else {
                            error = 'Error: ' + response;
                        }
                        SBForm.showErrorMessage(box, error);
                        $(this).sbLoading(false);
                    } else {
                        infoBottom('Activation complete! Page reload in progress...');
                        setTimeout(function () {
                            location.reload();
                        }, 1000);
                    }
                });
            } else {
                SBForm.showErrorMessage(box, 'Please insert the license key.');
            }
        });

        $(admin).on('click', '.sb-app-box .sb-btn-app-setting', function () {
            settings_area.find('#tab-' + $(this).closest('[data-app]').attr('data-app')).click();
            admin.sbHideLightbox();
        });

        // Desktop and flash notifications
        if (typeof Notification !== ND && (SB_ADMIN_SETTINGS.desktop_notifications == 'all' || SB_ADMIN_SETTINGS.desktop_notifications == 'agents') && !SB_ADMIN_SETTINGS.push_notifications) {
            SBConversations.desktop_notifications = true;
        }

        if (['all', 'agents'].includes(SB_ADMIN_SETTINGS.flash_notifications)) {
            SBConversations.flash_notifications = true;
        }

        // Cron jobs
        if (today.getDate() != SBF.storage('admin-clean')) {
            setTimeout(function () {
                SBF.ajax({ function: 'cron-jobs' });
                SBF.storage('admin-clean', today.getDate());
            }, 10000);
        }

        // Collapse button
        $(admin).on('click', '.sb-collapse-btn', function () {
            let active = $(this).sbActive();
            let height = active ? $(this).parent().data('height') + 'px' : '';
            $(this).html(sb_(active ? 'View more' : 'Close'));
            $(this).parent().find('> div, > ul').css({ 'height': height, 'max-height': height });
            $(this).sbActive(!active);
        });

        // Close lightbox popup
        $(admin).on('click', '.sb-popup-close', function () {
            admin.sbHideLightbox();
        });

        /*
        * ----------------------------------------------------------
        * Responsive
        * ----------------------------------------------------------
        */

        if (responsive) {

            conversations_user_details.find('> .sb-scroll-area').prepend('<div class="sb-profile"><img><span class="sb-name"></span></div>');

            $(admin).on('click', '.sb-menu-mobile > i', function () {
                $(this).toggleClass('sb-active');
                SBAdmin.open_popup = $(this).parent();
            });

            $(admin).on('click', '.sb-menu-mobile a', function () {
                $(this).closest('.sb-menu-mobile').find(' > i').sbActive(false);
            });

            $(admin).on('click', '.sb-menu-wide,.sb-nav', function () {
                $(this).toggleClass('sb-active');
            });

            $(admin).on('click', '.sb-menu-wide > ul > li, .sb-nav > ul > li', function (e) {
                let menu = $(this).parent().parent();
                menu.find('li').sbActive(false);
                menu.find('> div:not(.sb-menu-wide):not(.sb-btn)').html($(this).html());
                menu.sbActive(false);
                if (menu.find('> .sb-menu-wide').length) {
                    menu.closest('.sb-scroll-area').scrollTop(menu.next()[0].offsetTop - (admin.hasClass('sb-header-hidden') ? 70 : 130));
                }
                e.preventDefault();
                return false;
            });

            $(admin).find('.sb-admin-list .sb-scroll-area, main > div > .sb-scroll-area,.sb-area-settings > .sb-tab > .sb-scroll-area,.sb-area-reports > .sb-tab > .sb-scroll-area').on('scroll', function () {
                let scroll = $(this).scrollTop();
                if (scrolls.last < (scroll - 10) && scrolls.header) {
                    admin.addClass('sb-header-hidden');
                    scrolls.header = false;
                } else if (scrolls.last > (scroll + 10) && !scrolls.header && !scrolls.always_hidden) {
                    admin.removeClass('sb-header-hidden');
                    scrolls.header = true;
                }
                scrolls.last = scroll;
            });

            $(admin).on('click', '.sb-search-btn i,.sb-filter-btn i', function () {
                if ($(this).parent().sbActive()) {
                    admin.addClass('sb-header-hidden');
                    scrolls.always_hidden = true;
                } else {
                    scrolls.always_hidden = false;
                    if (conversations_admin_list_ul.parent().scrollTop() < 10) {
                        admin.removeClass('sb-header-hidden');
                    }
                }
            });

            $(admin).on('click', '.sb-top .sb-btn-back', function () {
                SBConversations.mobileCloseConversation();
            });

            $(users_table).find('th:first-child').html(sb_('Order by'));

            $(users_table).on('click', 'th:first-child', function () {
                $(this).parent().toggleClass('sb-active');
            });

            // Touch move
            document.addEventListener('touchstart', (e) => {
                touchmove_x = e.changedTouches[0].clientX;
                touchmove_y = e.changedTouches[0].clientY;
            }, false);

            document.addEventListener('touchend', () => {
                touchEndEvent();
            }, false);

            document.addEventListener('touchmove', (e) => {
                var x_up = e.changedTouches[0].clientX;
                var x_diff = touchmove_x - x_up;
                var y_up = e.changedTouches[0].clientY;
                var y_diff = touchmove_y - y_up;
                if (Math.abs(x_diff) > Math.abs(y_diff)) {
                    var target_sub = [];
                    touchmove = conversations_area.sbActive() ? [conversations_admin_list_ul.find('.sb-active'), conversations_area_list, 1] : [users_table.find(`[data-user-id="${activeUser().id}"]`), profile_box, 2];
                    if (x_diff > 150) {

                        // Left
                        if (touchmove[2] == 1) {
                            touchmove[0].next().click();
                        } else {
                            target_sub = touchmove[0].next();
                        }
                        touchEndEvent();
                    } else if (x_diff < -150) {

                        // Right
                        if (touchmove[2] == 1) {
                            touchmove[0].prev().click();
                        } else {
                            target_sub = touchmove[0].prev();
                        }
                        touchEndEvent();
                    }
                    if (touchmove[2] == 2 && target_sub.length) {
                        admin.sbHideLightbox();
                        SBProfile.show(target_sub.attr('data-user-id'));
                    }
                    if (x_diff > 80 || x_diff < -80) {
                        touchmove[1].css('transform', 'translateX(' + (x_diff * -1) + 'px)');
                        touchmove[1].addClass('sb-touchmove');
                    }
                }
            }, false);
        } else {
            if (!SB_ADMIN_SETTINGS.hide_conversation_details) {
                conversations_user_details.sbActive(true);
            } else {
                conversations_area.find('.sb-menu-mobile [data-value="panel"]').sbActive(true);
            }
        }

        if ($(window).width() < 913) {
            $(conversations_area).on('click', '> .sb-btn-collapse', function () {
                $(this).toggleClass('sb-active');
                conversations_area.find($(this).hasClass('sb-left') ? '.sb-admin-list' : '.sb-user-details').toggleClass('sb-active');
            });
        }

        /*
        * ----------------------------------------------------------
        * Left nav
        * ----------------------------------------------------------
        */

        function capitalizeFirstLetter(str) {
            if (!str) return "";
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
        $(header).on('click', ' .sb-admin-nav a', function () {
            active_admin_area = $(this).attr('id').substr(3);
            SBAdmin.active_admin_area = active_admin_area;
            header.find('.sb-admin-nav a').sbActive(false);
            admin.find(' > main > div').sbActive(false);
            admin.find('.sb-area-' + active_admin_area).sbActive(true);
            $(this).sbActive(true);
            SBF.deactivateAll();

            console.log(active_admin_area);

            //// change header title dynamically
            $('.sb-area-' + active_admin_area + ' .header-left .title').html(capitalizeFirstLetter(active_admin_area == 'users' ? 'Customers & Agents' : active_admin_area));

            switch (active_admin_area) {
                case 'dashboard':
                    loadingGlobal();
                    tickets_pagination = 1;
                    tickets_pagination_count = 1;
                    // $.getScript('https://cdn.jsdelivr.net/npm/chart.js', () => {
                    SBDashboard.get((response) => {
                        loadingGlobal(false);
                    })
                    break;
                case 'conversations':
                    console.log(SBF.getURL('conversation'));
                    if (!responsive && !SBF.getURL('conversation')) {
                        SBConversations.clickFirst();
                        console.log('66666 clicked');
                    }
                    SBConversations.update();
                    SBConversations.startRealTime();
                    SBUsers.stopRealTime();
                    break;
                case 'users':
                    SBUsers.startRealTime();
                    SBConversations.stopRealTime();
                    if (!SBUsers.init) {
                        loadingGlobal();
                        users_pagination = 1;
                        users_pagination_count = 1;
                        SBUsers.get((response) => {
                            SBUsers.populate(response);
                            SBUsers.updateMenu();
                            SBUsers.init = true;
                            SBUsers.datetime_last_user = SBF.dateDB('now');
                            loadingGlobal(false);
                        });
                    }
                    break;
                case 'tickets':
                    //SBTicket.startRealTime();
                    // SBConversations.stopRealTime();
                    //if (!SBTicket.init) {
                    loadingGlobal();
                    tickets_pagination = 1;
                    tickets_pagination_count = 1;
                    SBTicket.get((response) => {
                        //alert(response);
                        SBTicket.populate(response);
                        SBTicket.updateMenu();
                        SBTicket.init = true;
                        //SBUsers.datetime_last_user = SBF.dateDB('now');
                        loadingGlobal(false);
                    });
                    //}
                    break;
                case 'settings':
                    if (!SBSettings.init) {
                        loadingGlobal();
                        SBF.ajax({
                            function: 'get-all-settings'
                        }, (response) => {
                            if (response) {
                                let translations = response['external-settings-translations'];
                                if (response['slack-agents']) {
                                    let code = '';
                                    for (var key in response['slack-agents'][0]) {
                                        code += `<div data-id="${key}"><select><option value="${response['slack-agents'][0][key]}"></option></select></div>`;
                                    }
                                    settings_area.find('#slack-agents .input').html(code);
                                }
                                SBSettings.translations.translations = Array.isArray(translations) && !translations.length ? {} : translations;
                                delete response['external-settings-translations'];
                                for (var key in response) {
                                    SBSettings.set(key, response[key]);
                                }
                            }
                            if (SBF.getURL('refresh_token')) {
                                admin.find('#google-refresh-token input').val(SBF.getURL('refresh_token'));
                                SBSettings.save();
                                infoBottom('Synchronization completed.');
                                admin.find('#google')[0].scrollIntoView();
                            }
                            settings_area.find('textarea').each(function () {
                                $(this).autoExpandTextarea();
                                $(this).manualExpandTextarea();
                            });
                            settings_area.find('[data-setting] .sb-language-switcher-cnt').each(function () {
                                $(this).sbLanguageSwitcher(SBSettings.translations.getLanguageCodes($(this).closest('[data-setting]').attr('id')), 'settings');
                            });
                            SBSettings.init = true;
                            loadingGlobal(false);
                            if (response && !SB_ADMIN_SETTINGS.cloud) {
                                SBSettings.visibility(0, response['push-notifications'] && response['push-notifications'][0]['push-notifications-provider'][0] == 'pusher');
                            }
                            SBSettings.visibility(1, response['messenger'] ? response['messenger'][0]['messenger-sync-mode'][0] != 'manual' : true);
                            SBSettings.visibility(2, response['open-ai'] ? response['open-ai'][0]['open-ai-mode'][0] != 'assistant' : true);
                            SBF.event('SBSettingsLoaded', response);
                        });
                    }
                    SBUsers.stopRealTime();
                    SBConversations.stopRealTime();
                    break;
                case 'reports':
                    if (reports_area.sbLoading()) {
                        $.getScript(SB_URL + '/vendor/moment.min.js', () => {
                            $.getScript(SB_URL + '/vendor/daterangepicker.min.js', () => {
                                //$.getScript(SB_URL + '/vendor/chart.min.js', () => {
                                SBReports.initDatePicker();
                                SBReports.initReport('conversations');
                                reports_area.sbLoading(false);
                                //});
                            });
                        });
                    }
                    SBUsers.stopRealTime();
                    SBConversations.stopRealTime();
                    break;
                case 'articles':
                    let nav = articles_area.find('.sb-menu-wide li').eq(0);
                    if (articles_area.sbLoading()) {
                        nav.sbActive(true).next().sbActive(false);
                        SBF.ajax({
                            function: 'init-articles-admin'
                        }, (response) => {
                            SBArticles.categories.list = response[1];
                            SBArticles.translations.list = response[2];
                            SBArticles.page_url = response[3];
                            SBArticles.is_url_rewrite = response[4];
                            SBArticles.cloud_chat_id = response[5];
                            SBArticles.populate(response[0]);
                            SBArticles.populate(response[1], true);
                            SBArticles.categories.update();
                            articles_area.sbLoading(false);
                        });
                    } else {
                        nav.click();
                    }
                    SBUsers.stopRealTime();
                    SBConversations.stopRealTime();
                    break;
                case 'chatbot':
                    if (chatbot_files_table.sbLoading()) {
                        SBApps.openAI.init();
                    }
                    SBApps.openAI.troubleshoot();
            }
            let url_area = SBF.getURL('area');
            if (
                url_area != active_admin_area &&
                ((active_admin_area == 'conversations' && !SBF.getURL('conversation')) ||
                    (active_admin_area == 'users' && !SBF.getURL('user')) ||
                    (active_admin_area == 'settings' && !SBF.getURL('setting')) ||
                    (active_admin_area == 'reports' && !SBF.getURL('report')) ||
                    (active_admin_area == 'articles' && !SBF.getURL('article')) ||
                    (active_admin_area == 'chatbot' && !SBF.getURL('chatbot')) ||
                    (active_admin_area == 'dashboard' && !SBF.getURL('dashboard')) ||
                    (active_admin_area == 'tickets' && !SBF.getURL('tickets'))
                )
            ) {
                pushState('?area=' + active_admin_area);
            }
        });

        $('#view-all-conversations').on('click', function () {
            $('.sb-admin-nav #sb-conversations').trigger('click');
        });

        $(header).on('click', '.sb-profile', function () {
            $(this).next().toggleClass('sb-active');
        });

        $(admin).on('click', '[data-value="logout"],.logout', function () {
            SBAdmin.is_logout = true;
            SBF.ajax({ function: 'on-close' });
            SBUsers.stopRealTime();
            SBConversations.stopRealTime();
            setTimeout(() => { SBF.logout() }, 300);
        });

        $(admin).on('click', '[data-value="edit-profile"],.edit-profile', function () {
            loadingGlobal();
            let user = new SBUser({ 'id': SB_ACTIVE_AGENT.id });
            user.update(() => {
                activeUser(user);
                conversations_area.find('.sb-board').addClass('sb-no-conversation');
                conversations_admin_list_ul.find('.sb-active').sbActive(false);
                SBProfile.showEdit(user);
            });
        });

        $(admin).on('click', '[data-value="status"]', function () {
            let is_offline = !$(this).hasClass('sb-online');
            SBUsers.setActiveAgentStatus(is_offline);
            away_mode = is_offline;
        });

        $(admin).find('.sb-account').setProfile(SB_ACTIVE_AGENT['full_name'], SB_ACTIVE_AGENT['profile_image']);

        /*
        * ----------------------------------------------------------
        * Conversations area
        * ----------------------------------------------------------
        */

        // Open the conversation clicked on the left menu
        $(conversations_admin_list_ul).on('click', 'li', function () {
            if (active_keydown == 17) {
                $(this).sbActive(!$(this).sbActive());
            } else {
                SBConversations.openConversation($(this).attr('data-conversation-id'), $(this).attr('data-user-id'), false);
                SBF.deactivateAll();
            }
        });

        // Open the user conversation clicked on the bottom right area or user profile box
        $(admin).on('click', '.sb-user-conversations li', function () {
            SBConversations.openConversation($(this).attr('data-conversation-id'), activeUser().id, $(this).attr('data-conversation-status'));
        });

        // Archive, delete or restore conversations
        $(conversations_area).on('click', '.sb-top ul a', function () {
            let status_code;
            let selected_conversations = conversations_admin_list_ul.find('.sb-active').map(function () {
                return { id: $(this).attr('data-conversation-id'), user_id: $(this).attr('data-user-id'), status_code: $(this).attr('data-conversation-status') };
            }).toArray();
            let selected_conversations_length = selected_conversations.length;
            let multi_selection = selected_conversations_length > 1;
            let message = multi_selection ? 'All the selected conversations will be ' : 'The conversation will be ';
            let value = $(this).attr('data-value');
            let on_success = (response, action) => {
                let success = response.includes('.txt');
                $(this).sbLoading(false);
                if (action == 'email') {
                    actioninfoBottom(success ? sb_('Transcript sent to user\'s email.') + ' <a href="' + response + '" target="_blank">' + sb_('View transcript') + '</a>' : 'Transcript sending error: ' + response, success ? '' : 'error');
                }
            }
            switch (value) {
                case 'inbox':
                    status_code = 1;
                    message += 'restored.';
                    break;
                case 'archive':
                    message += 'archived.';
                    status_code = 3;
                    break;
                case 'delete':
                    message += 'deleted.';
                    status_code = 4;
                    break;
                case 'empty-trash':
                    status_code = 5;
                    message = 'All conversations in the trash (including their messages) will be deleted permanently.'
                    break;
                case 'transcript':
                    let action = $(this).attr('data-action');
                    if (action == 'email' && (!activeUser() || !activeUser().get('email'))) {
                        action = '';
                    }
                    SBConversations.transcript(selected_conversations[0].id, selected_conversations[0].user_id, action, (response) => on_success(response, action));
                    loading(this);
                    break;
                case 'read':
                    status_code = 1;
                    message += 'marked as read.';
                    break;
                case 'unread':
                    status_code = 2;
                    message += 'marked as unread.';
                    break;
                case 'panel':
                    $([conversations_user_details, this]).toggleClass('sb-active');
                    break;
                case 'convert-to-ticket':
                    status_code = 6;
                    message += 'linked to a ticket.';
                    break;
            }
            if (status_code && status_code != 6) {
                infoPanel(message, 'alert', function () {
                    let active_conversations_filter = conversations_filters.eq(0).find('p').attr('data-value');
                    let last_conversation_id = selected_conversations[selected_conversations_length - 1].id;
                    for (var i = 0; i < selected_conversations_length; i++) {
                        let conversation = selected_conversations[i];
                        SBF.ajax({
                            function: 'update-conversation-status',
                            conversation_id: conversation.id,
                            status_code: status_code
                        }, () => {
                            let conversation_li = conversations_admin_list_ul.find(`[data-conversation-id="${conversation.id}"]`);
                            if ([0, 3, 4].includes(status_code)) {
                                for (var j = 0; j < conversations.length; j++) {
                                    if (conversations[j].id == conversation.id) {
                                        conversations[j].set('status_code', status_code);
                                        break;
                                    }
                                }
                            }
                            if (SB_ADMIN_SETTINGS.close_message && status_code == 3) {
                                SBF.ajax({ function: 'close-message', conversation_id: conversation.id, bot_id: SB_ADMIN_SETTINGS.bot_id });
                                if (SB_ADMIN_SETTINGS.close_message_transcript) {
                                    SBConversations.transcript(conversation.id, conversation.user_id, 'email', (response) => on_success(response));
                                }
                            }
                            if ([0, 1, 2].includes(status_code)) {
                                conversation_li.attr('data-conversation-status', status_code);
                                SBConversations.updateMenu();
                            }
                            if (SBChat.conversation && SBApps.is('slack') && [3, 4].includes(status_code)) {
                                SBF.ajax({ function: 'archive-slack-channels', conversation_user_id: SBChat.conversation.get('user_id') });
                            }
                            if ((active_conversations_filter == 0 && [3, 4].includes(status_code)) || (active_conversations_filter == 3 && [0, 1, 2, 4].includes(status_code)) || (active_conversations_filter == 4 && status_code != 4)) {
                                let previous = false;
                                SBConversations.updateMenu();
                                if (SBChat.conversation && SBChat.conversation.id == conversation.id) {
                                    previous = conversation_li.prev();
                                    SBChat.conversation = false;
                                }
                                conversation_li.remove();
                                if (conversation.id == last_conversation_id) {
                                    SBConversations.clickFirst(previous);
                                }
                            }
                            if (active_conversations_filter == 4 && status_code == 5) {
                                conversations_admin_list_ul.find('li').remove();
                                SBConversations.updateMenu();
                                SBConversations.clickFirst();
                            }
                        });
                        if (SBChat.conversation && SBChat.conversation.id == conversation.id) {
                            SBChat.conversation.set('status_code', status_code);
                            SBConversations.setReadIcon(status_code);
                        }
                    }
                });
            }
            if (status_code == 6) {
                $('#ticket-action-selector').show();
                $('#ticket-selector').hide();
                $('#selected_conversation_id').val(selected_conversations[0].id);

                if (!$(this).hasClass('converted')) {
                    infoPanel(message, 'convert-ticket', function () {

                        const userId = SBChat.conversation.details?.user_id;
                        const userFirstName = SBChat.conversation.details?.first_name;
                        const lastName = SBChat.conversation.details?.last_name;
                        const userEmail = SBChat.conversation.details?.email;

                        $(tickets_area).find('.sb-new-ticket').trigger('click');

                        $('#cust_name input').removeAttr('disabled');
                        $('#cust_email input').removeAttr('disabled');

                        const userOption = new Option(userFirstName + ' ' + lastName, userId, true, true);


                        $(userOption).data('data', {
                            id: userId,
                            text: userFirstName + ' ' + lastName,
                            name: userFirstName + ' ' + lastName,
                            email: 'testing@aa.com'
                        });

                        $('.sb-edit-box #contact_id select').append(userOption).trigger('change');

                        //$('.sb-edit-box #contact_id select').trigger('select2:select')
                        //$('#cust_name input').val(userFirstName+' '+lastName);
                        //$('#cust_email input').val(userEmail);
                        $('#conversation_id_div').removeClass('d-none');
                        $('#conversation_id_div label span').html('#' + selected_conversations[0].id);
                        $('#conversation_id').val(selected_conversations[0].id);


                        // SBF.ajax({
                        //     function: 'convert-converversion-to-ticket',
                        //     conversation_id: selected_conversations[0].id
                        // }, (response) => {
                        //     // alert(response);

                        //     SBConversations.updateMenu();

                        //     initialization();

                        // });
                    }, 'add-conversation-to-ticket');
                }
            }
        });

        // Saved replies
        SBF.ajax({
            function: 'saved-replies'
        }, (response) => {
            let code = `<p class="sb-no-results">${sb_('No saved replies found. Add new saved replies via Settings > Admin.')}</p>`;
            if (Array.isArray(response)) {
                if (response.length && response[0]['reply-name']) {
                    code = '';
                    saved_replies_list = response;
                    for (var i = 0; i < response.length; i++) {
                        code += `<li><div>${response[i]['reply-name']}</div><div>${response[i]['reply-text'].replace(/\\n/g, '\n')}</div></li>`;
                    }
                }
            }
            saved_replies.find('.sb-replies-list > ul').html(code).sbLoading(false);
        });

        $(conversations_area).on('click', '.sb-btn-saved-replies', function () {
            saved_replies.sbTogglePopup(this);
            saved_replies.find('.sb-search-btn').sbActive(true).find('input').get(0).focus();
        });

        $(saved_replies).on('click', '.sb-replies-list li', function () {
            SBChat.insertText($(this).find('div:last-child').text().replace(/\\n/g, '\n'));
            SBF.deactivateAll();
            admin.removeClass('sb-popup-active');
        });

        $(saved_replies).on('input', '.sb-search-btn input', function () {
            saved_reply_search($(this).val().toLowerCase());
        });

        $(saved_replies).on('click', '.sb-search-btn i', function () {
            SBF.searchClear(this, () => { saved_reply_search('') });
        });

        $(admin).on('click', '.sb-btn-open-ai', function () {
            if (!SBChat.conversation || loading(this)) return;
            let is_editor = $(this).hasClass('sb-btn-open-ai-editor');
            let textarea = is_editor ? conversations_area.find('.sb-editor textarea') : dialogflow_intent_box.find('textarea');
            SBApps.openAI.rewrite(textarea.val(), (response) => {
                $(this).sbLoading(false);
                if (response[0]) {
                    textarea.val(is_editor ? '' : response[1]);
                    if (is_editor) {
                        SBChat.insertText(response[1]);
                    }
                }
            });
        });

        // Pagination for conversations
        $(conversations_admin_list).find('.sb-scroll-area').on('scroll', function () {
            if (!is_busy && !SBConversations.is_search && scrollPagination(this, true) && pagination_count) {
                let parent = conversations_area.find('.sb-admin-list');
                let filters = SBConversations.filters();
                is_busy = true;
                parent.append('<div class="sb-loading-global sb-loading"></div>');
                SBF.ajax({
                    function: 'get-conversations',
                    pagination: pagination,
                    status_code: filters[0],
                    department: filters[1],
                    source: filters[2],
                    tag: filters[3]
                }, (response) => {
                    setTimeout(() => { is_busy = false }, 500);
                    pagination_count = response.length;
                    if (pagination_count) {
                        let code = '';
                        for (var i = 0; i < pagination_count; i++) {
                            let conversation = new SBConversation([new SBMessage(response[i])], response[i]);
                            code += SBConversations.getListCode(conversation);
                            conversations.push(conversation);
                        }
                        pagination++;
                        conversations_admin_list_ul.append(code);
                    }
                    parent.find(' > .sb-loading').remove();
                    SBF.event('SBAdminConversationsLoaded', { conversations: response });
                    showInitials('sb-scroll-area', 'sb-profile');
                });
            }
        });

        // Event: message deleted
        $(document).on('SBMessageDeleted', function () {
            let last_message = SBChat.conversation.getLastMessage();
            if (last_message != false) {
                conversations_admin_list_ul.find('li.sb-active p').html(last_message.message);
            } else {
                conversations_admin_list_ul.find('li.sb-active').remove();
                SBConversations.clickFirst();
                SBConversations.scrollTo();
            }
        });

        // Event: message sent
        $(document).on('SBMessageSent', function (e, response) {
            let conversation_id = response.conversation_id;
            let item = getListConversation(conversation_id);
            let message_part = sb_('Error. Message not sent to');
            let conversation = response.conversation;
            let user = response.user;
            if (response.conversation_status_code) {
                SBConversations.updateMenu();
            }
            if (SBApps.messenger.check(conversation)) {
                SBApps.messenger.send(user.getExtra('facebook-id').value, conversation.get('extra'), response.message, response.attachments, response.message_id, response.message_id, (response) => {
                    for (var i = 0; i < response.length; i++) {
                        if (response[i] && response[i].error) {
                            infoPanel(message_part + ' Messenger: ' + response[i].error.message, 'info', false, 'error-fb');
                        }
                    }
                });
            }
            if (SBApps.whatsapp.check(conversation)) {
                SBApps.whatsapp.send(SBApps.whatsapp.activeUserPhone(user), response.message, response.attachments, conversation.get('extra'), (response) => {
                    if (response.ErrorCode || (response.meta && !response.meta.success)) {
                        infoPanel(message_part + ' WhatsApp: ' + ('ErrorCode' in response ? response.errorMessage : response.meta.developer_message), 'info', false, 'error-wa');
                    }
                });
            }
            if (SBApps.telegram.check(conversation)) {
                SBApps.telegram.send(conversation.get('extra'), response.message, response.attachments, conversation_id, (response) => {
                    if (!response || !response.ok) {
                        infoPanel(message_part + ' Telegram: ' + JSON.stringify(response), 'info', false, 'error-tg');
                    }
                });
            }
            if (SBApps.viber.check(conversation)) {
                SBApps.viber.send(user.getExtra('viber-id').value, response.message, response.attachments, (response) => {
                    if (!response || response.status_message != 'ok') {
                        infoPanel(message_part + ' Viber: ' + JSON.stringify(response), 'info', false, 'error-vb');
                    }
                });
            }
            if (SBApps.zalo.check(conversation)) {
                SBApps.zalo.send(user.getExtra('zalo-id').value, response.message, response.attachments, (response) => {
                    if (response && response.error.error) {
                        infoPanel(message_part + ' Zalo: ' + response.error.message ? response.error.message : response.message, 'info', false, 'error-za');
                    }
                });
            }
            if (SBApps.twitter.check(conversation)) {
                SBApps.twitter.send(user.getExtra('twitter-id').value, response.message, response.attachments, (response_2) => {
                    if (response_2 && !response_2.event) {
                        infoPanel(JSON.stringify(response_2), 'info', false, 'error-tw');
                    } else if (response.attachments.length > 1) {
                        infoBottom('Only the first attachment was sent to Twitter.');
                    }
                });
            }
            if (SBApps.line.check(conversation)) {
                SBApps.line.send(user.getExtra('line-id').value, response.message, response.attachments, conversation_id, (response) => {
                    if (response.error) {
                        infoPanel(message_part + ' LINE: ' + JSON.stringify(response), 'info', false, 'error-ln');
                    }
                });
            }
            if (SBApps.wechat.check(conversation)) {
                SBApps.wechat.send(user.getExtra('wechat-id').value, response.message, response.attachments, (response) => {
                    if (!response || response.errmsg != 'ok') {
                        infoPanel(message_part + ' WeChat: ' + JSON.stringify(response), 'info', false, 'error-wc');
                    }
                });
            }
            if (SB_ADMIN_SETTINGS.smart_reply) {
                suggestions_area.html('');
            }
            if (SB_ADMIN_SETTINGS.assign_conversation_to_agent && SBF.null(conversation.get('agent_id'))) {
                SBConversations.assignAgent(conversation_id, SB_ACTIVE_AGENT.id, () => {
                    if (SBChat.conversation.id == conversation_id) {
                        SBChat.conversation.set('agent_id', SB_ACTIVE_AGENT.id);
                        $(conversations_area).find('#conversation-agent > p').attr('data-value', SB_ACTIVE_AGENT.id).html(SB_ACTIVE_AGENT.full_name);
                    }
                });
            }
        });

        // Event: new message of active chat conversation received
        $(document).on('SBNewMessagesReceived', function (e, response) {
            let messages = response.messages;
            for (var i = 0; i < messages.length; i++) {
                let message = messages[i];
                let payload = message.payload();
                let agent = SBF.isAgent(message.get('user_type'));
                setTimeout(function () {
                    conversation_area.find('.sb-top .sb-status-typing').remove();
                }, 300);
                if (SBAdmin.must_translate) {
                    let message_html = conversation_area.find(`[data-id="${message.id}"]`);
                    let message_original = payload['original-message'] ? payload['original-message'] : false;
                    if (message_original) {
                        message_html.replaceWith(message.getCode());
                        conversation_area.find(`[data-id="${message.id}"] .sb-menu`).prepend(`<li data-value="translation">${sb_('View translation')}</li>`);
                        if (SB_ADMIN_SETTINGS.smart_reply) {
                            SBApps.dialogflow.smartReply(SBF.escape(message_original));
                        }
                    } else if (message.message) {
                        SBApps.dialogflow.translate([message.message], SB_ADMIN_SETTINGS.active_agent_language, (response_2) => {
                            if (response_2) {
                                message.payload('translation', response_2[0]);
                                message.payload('translation-language', SB_ADMIN_SETTINGS.active_agent_language);
                                message_html.replaceWith(message.getCode());
                                conversation_area.find(`[data-id="${message.id}"] .sb-menu`).prepend(`<li data-value="original">${sb_('View original message')}</li>`);
                            }
                            if (SB_ADMIN_SETTINGS.smart_reply) {
                                SBApps.dialogflow.smartReply(response_2[0]);
                            }
                            conversations_admin_list_ul.find(`[data-conversation-id="${response.conversation_id}"] p`).html(response_2[0]);
                        }, [message.id], SBChat.conversation.id);
                    }
                } else if (SB_ADMIN_SETTINGS.smart_reply) {
                    SBApps.dialogflow.smartReply(message.message);
                }
                if (payload) {
                    if (payload.department) {
                        SBConversations.setActiveDepartment(payload.department);
                    }
                    if (payload.agent) {
                        SBConversations.setActiveAgent(payload.agent);
                    }
                }
                if ('ErrorCode' in payload || (payload.errors && payload.errors.length)) {
                    infoPanel('Error. Message not sent to WhatsApp. Error message: ' + (payload.ErrorCode ? payload.ErrorCode : payload.errors[0].title));
                }
                if ('whatsapp-templates' in payload) {
                    infoBottom(`Message sent as text message.${'whatsapp-template-fallback' in payload ? ' The user has been notified via WhatsApp Template notification.' : ''}`);
                }
                if ('whatsapp-template-fallback' in payload && !('whatsapp-templates' in payload)) {
                    infoBottom('The user has been notified via WhatsApp Template notification.');
                }
                if (!agent && SBChat.conversation.id == response.conversation_id && !SBChat.user_online) {
                    SBUsers.setActiveUserStatus();
                }
            }
            SBConversations.update();
        });

        $('#toggleEditProfilePassword').click(function () {
            $(this).toggleClass("fa-eye fa-eye-slash");
            let input = $("#edit-profile-password");
            let currentType = input.prop('type');
            if (currentType === 'password') {
                input.prop('type', 'text');
            } else {
                input.prop('type', 'password');
            }
        });

        $('#ticketRegPass').click(function () {
            $(this).toggleClass("fa-eye fa-eye-slash");
            let input = $("#ticketRegInput");
            let currentType = input.prop('type');
            if (currentType === 'password') {
                input.prop('type', 'text');
            } else {
                input.prop('type', 'password');
            }
        });

        // Event: new conversation created 
        $(document).on('SBNewConversationCreated', function () {
            SBConversations.update();
        });

        // Event: email notification sent
        $(document).on('SBEmailSent', function () {
            infoBottom(`The user has been notified by email.`);
        });

        // Event: SMS notification sent
        $(document).on('SBSMSSent', function () {
            infoBottom('The user has been notified by text message.');
        });

        // Event: Message notifications
        $(document).on('SBNotificationsSent', function (e, response) {
            infoBottom(`The user ${response.includes('cron') ? 'will be' : 'has been'} notified by email${response.includes('sms') ? ' and text message' : ''}.`);
        });

        // Event: user typing status change
        $(document).on('SBTyping', function (e, response) {
            SBConversations.typing(response);
        });

        // Conversations search
        $(conversations_admin_list).on('input', '.sb-search-btn input', function () {
            SBConversations.search(this);
        });

        $(conversations_area).on('click', '.sb-admin-list .sb-search-btn i', function () {
            SBF.searchClear(this, () => { SBConversations.search($(this).next()) });
        });

        // Conversations filter
        $(conversations_filters).on('click', 'li', function (e) {
            let parent = conversations_admin_list_ul.parent();
            if (loading(parent)) {
                e.preventDefault()
                return false;
            }
            setTimeout(() => {
                let filters = SBConversations.filters();
                pagination = 1;
                pagination_count = 1;
                SBF.ajax({
                    function: 'get-conversations',
                    status_code: filters[0],
                    department: filters[1],
                    source: filters[2],
                    tag: filters[3]
                }, (response) => {
                    SBConversations.populateList(response);
                    conversation_area.attr('data-conversation-status', filters[0]);
                    if (response.length) {
                        if (!responsive) {
                            if (SBChat.conversation) {
                                let conversation = getListConversation(SBChat.conversation.id);
                                if (conversation.length) {
                                    conversation.sbActive(true);
                                } else if (filters[0] == SBChat.conversation.status_code) {
                                    conversations_admin_list_ul.prepend(SBConversations.getListCode(SBChat.conversation));
                                } else {
                                    SBConversations.clickFirst();
                                }
                            } else {
                                SBConversations.clickFirst();
                            }
                            SBConversations.scrollTo();
                        }
                    } else {
                        conversations_area.find('.sb-board').addClass('sb-no-conversation');
                        SBChat.conversation = false;
                    }
                    $(this).closest('.sb-filter-btn').attr('data-badge', conversations_filters.slice(1).toArray().reduce((acc, filter) => acc + !!$(filter).find('li.sb-active').data('value'), 0));
                    parent.sbLoading(false);
                    showInitials('sb-scroll-area', 'sb-profile');
                });
            }, 100);
        });

        // Display the user details box
        $(conversations_area).on('click', '.sb-user-details .sb-profile,.sb-top > a,.sb-top #view-profile-button', function () {
            let user_id = conversations_admin_list_ul.find('.sb-active').attr('data-user-id');
            if (activeUser().id != user_id) {
                activeUser(users[user_id]);
            }
            SBProfile.show(activeUser().id);
        });

        // Right profile list methods
        $(admin).on('click', '.sb-profile-list-conversation li', function () {
            let label = $(this).find('label');
            let label_value = label.html();
            switch ($(this).attr('data-id')) {
                case 'location':
                    let location = label_value.replace(', ', '+');
                    infoPanel('<iframe src="https://maps.google.com/maps?q=' + location + '&output=embed"></iframe>', 'map');
                    break;
                case 'timezone':
                    SBF.getLocationTimeString(activeUser().extra, (response) => {
                        loadingGlobal(false);
                        infoPanel(response);
                    });
                    break;
                case 'current_url':
                    window.open('//' + (SBF.null(label.attr('data-value')) ? label_value : label.attr('data-value')));
                    break;
                case 'conversation-source':
                    let source = label_value.toLowerCase();
                    if (source == 'whatsapp' && activeUser().getExtra('phone')) {
                        window.open('https://wa.me/' + SBApps.whatsapp.activeUserPhone());
                    } else if (source == 'facebook') {
                        window.open('https://www.facebook.com/messages/t/' + SBChat.conversation.get('extra'));
                    } else if (source == 'instagram') {
                        window.open('https://www.instagram.com/direct/inbox/');
                    } else if (source == 'twitter') {
                        window.open('https://twitter.com/messages/');
                    }
                    break;
                case 'wp-id':
                    window.open(window.location.href.substr(0, window.location.href.lastIndexOf('/')) + '/user-edit.php?user_id=' + activeUser().getExtra('wp-id').value);
                    break;
                case 'envato-purchase-code':
                    loadingGlobal();
                    SBF.ajax({
                        function: 'envato',
                        purchase_code: label_value
                    }, (response) => {
                        let code = '';
                        if (response && response.item) {
                            response.name = response.item.name;
                            for (var key in response) {
                                if (isString(response[key]) || !isNaN(response[key])) {
                                    code += `<b>${SBF.slugToString(key)}</b> ${response[key]} <br>`;
                                }
                            }
                            loadingGlobal(false);
                            infoPanel(code, 'info', false, 'sb-envato-box');
                        } else {
                            infoBottom(SBF.slugToString(response));
                        }
                    });
                    break;
                case 'email':
                case 'cc':
                    if (SBChat.conversation && SBChat.conversation.get('source') == 'em') {
                        let cc = SBChat.conversation.get('extra').split(',');
                        let code = `<div data-type="repeater" class="sb-setting sb-type-repeater"><div class="input"><div class="sb-repeater">`;
                        for (var i = 0; i < cc.length; i++) {
                            code += `<div class="repeater-item"><div><input data-id="cc" type="text" value="${cc[i]}"></div><i class="sb-icon-close"></i></div>`;
                        }
                        code += `</div><div class="sb-btn sb-btn-white sb-repeater-add sb-icon"><i class="sb-icon-plus"></i>${sb_('Add new item')}</div></div></div>`;
                        SBAdmin.genericPanel('cc', 'Manage CC', code, ['Save changes'], '', true);
                    }
                    break;
            }
        });

        $(conversations_user_details).on('click', '.sb-user-details-close', function () {
            conversations_area.find('.sb-menu-mobile [data-value="panel"]').click().sbActive(true);
        });

        // Dialogflow
        $(dialogflow_intent_box).on('click', '.sb-intent-add [data-value="add"]', function () {
            dialogflow_intent_box.find('> div > .sb-type-text').last().after('<div class="sb-setting sb-type-text"><input type="text"></div>');
        });

        $(dialogflow_intent_box).on('click', '.sb-intent-add [data-value="previous"],.sb-intent-add [data-value="next"]', function () {
            let input = dialogflow_intent_box.find('.sb-first input');
            let message = input.val();
            let next = $(this).attr('data-value') == 'next';
            let messages = SBChat.conversation.getUserMessages();
            let messages_length = messages.length;
            for (var i = 0; i < messages_length; i++) {
                if (messages[i].message == message && ((next && i < (messages_length - 1)) || (!next && i > 0))) {
                    i = i + (next ? 1 : -1);
                    input.val(messages[i].message);
                    dialogflow_intent_box.attr('data-message-id', messages[i].id);
                    SBApps.openAI.generateQuestions(messages[i].message);
                    break;
                }
            }
        });

        $(dialogflow_intent_box).on('click', '.sb-send', function () {
            SBApps.dialogflow.submitIntent(this);
        });

        $(dialogflow_intent_box).on('input', '.sb-search-btn input', function () {
            SBApps.dialogflow.searchIntents($(this).val());
        });

        $(dialogflow_intent_box).on('click', '.sb-search-btn i', function () {
            SBF.searchClear(this, () => { SBApps.dialogflow.searchIntents($(this).val()) });
        });

        $(dialogflow_intent_box).on('click', '#sb-intent-preview', function () {
            SBApps.dialogflow.previewIntentDialogflow(dialogflow_intent_box.find('#sb-intents-select').val());
        });

        $(dialogflow_intent_box).on('click', '#sb-qea-preview', function () {
            SBApps.dialogflow.previewIntent(dialogflow_intent_box.find('#sb-qea-select').val());
        });

        $(dialogflow_intent_box).on('change', '#sb-intents-select', function () {
            let intent = $(this).val();
            dialogflow_intent_box.find('.sb-bot-response').css('opacity', intent ? .5 : 1).find('textarea').val(intent ? SBApps.dialogflow.getIntent(intent).messages[0].text.text[0] : SBApps.dialogflow.original_response);
            dialogflow_intent_box.find('#sb-train-chatbots').val(intent ? 'dialogflow' : '');
        });

        $(dialogflow_intent_box).on('change', '#sb-qea-select', function () {
            let qea = $(this).val();
            dialogflow_intent_box.find('.sb-bot-response').setClass('sb-disabled', qea).find('textarea').val(qea ? SBApps.dialogflow.qea[qea][1] : SBApps.dialogflow.original_response);
            dialogflow_intent_box.find('#sb-train-chatbots').val(qea ? 'dialogflow' : '');
        });

        $(dialogflow_intent_box).on('change', 'textarea', function () {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                SBApps.dialogflow.original_response = dialogflow_intent_box.find('textarea').val();
            }, 500);
        });

        $(dialogflow_intent_box).on('change', '#sb-train-chatbots', function () {
            dialogflow_intent_box.find('.sb-type-text:not(.sb-first)').setClass('sb-hide', $(this).val() == 'open-ai');
        });

        // Departments
        $(select_departments).on('click', 'li', function (e) {
            let select = $(this).parent().parent();
            if ($(this).data('id') == select.find(' > p').attr('data-id')) {
                setTimeout(() => { $(this).sbActive(false); }, 100);
                return true;
            }
            if (!SBChat.conversation) {
                $(this).parent().sbActive(false);
                e.preventDefault();
                return false;
            }
            if (!select.sbLoading()) infoPanel(`${sb_('All agents assigned to the new department will be notified. The new department will be')} ${$(this).html()}.`, 'alert', () => {
                let value = $(this).data('id');
                select.sbLoading(true);
                SBConversations.assignDepartment(SBChat.conversation.id, value, () => {
                    SBConversations.setActiveDepartment(value);
                    select.sbLoading(false);
                });
            });
            e.preventDefault();
            return false;
        });

        // Agent assignment
        $(conversations_area).on('click', '#conversation-agent li', function (e) {
            let select = $(this).parent().parent();
            let agent_id = $(this).data('id');
            if (agent_id == select.find(' > p').attr('data-value')) return true;
            if (!SBChat.conversation) {
                $(this).parent().sbActive(false);
                e.preventDefault();
                return false;
            }
            if (!select.sbLoading()) {
                infoPanel(`${sb_('The new agent will be')} ${$(this).html()}.`, 'alert', () => {
                    select.sbLoading(true);
                    SBConversations.assignAgent(SBChat.conversation.id, agent_id, () => {
                        SBConversations.setActiveAgent(agent_id);
                        select.sbLoading(false);
                    });
                });
            }
            e.preventDefault();
            return false;
        });

        // Notes and Tags 
        notes_panel.on('click', '> i,.sb-edit-note', function (e) {
            let note = $(this).hasClass('sb-edit-note') ? $(this).closest('[data-id]') : false;
            SBAdmin.genericPanel('notes', note ? 'Edit note' : 'Add new note', `<div class="sb-setting sb-type-textarea"><textarea${note ? ' data-id="' + note.attr('data-id') + '"' : ''} placeholder="${sb_('Write here your note...')}">${note ? note.find('.sb-note-text').html().replace(/<a\s+href="([^"]*)".*?>(.*?)<\/a>/gi, '$1').replaceAll('<br>', '\n') : ''}</textarea></div>`, [[note ? 'Update note' : 'Add note', note ? 'check' : 'plus']]);
            if (SBApps.is('dialogflow') && SB_ADMIN_SETTINGS.note_data_scrape) {
                let options = '';
                for (var key in SB_ADMIN_SETTINGS.note_data_scrape) {
                    options += `<option value="${key}">${SB_ADMIN_SETTINGS.note_data_scrape[key]}</option>`;
                }
                admin.find('#sb-add-note').parent().prepend(`<div id="note-ai-scraping" class="sb-setting sb-type-select"><select><option value="">${sb_('Data scraping')}</option>${options}</select></div>`);
            }
            e.preventDefault();
            return false;
        });

        $(admin).on('change', '#note-ai-scraping select', function () {
            let value = $(this).val();
            if (!value || loading($(this).parent())) {
                return;
            }
            SBF.ajax({
                function: 'data-scraping',
                conversation_id: SBChat.conversation.id,
                prompt_id: value
            }, (response) => {
                if (response && response.error) {
                    console.error(response);
                    return infoBottom(response.error.message, 'error');
                }
                $(this).parent().sbLoading(false);
                let textarea = admin.find('.sb-notes-box textarea');
                textarea.val((textarea.val() + '\n' + response).trim());
            });
        });

        notes_panel.on('click', '.sb-delete-note', function () {
            let item = $(this).parents().eq(1);
            SBConversations.notes.delete(SBChat.conversation.id, item.attr('data-id'), (response) => {
                if (response === true) {
                    item.remove();
                } else {
                    SBF.error(response);
                }
            });
        });

        $(admin).on('click', '#sb-add-note, #sb-update-note', function () {
            let textarea = $(this).parent().parents().eq(1).find('textarea');
            let message = textarea.val();
            let note_id = textarea.attr('data-id');
            if (message.length == 0) {
                SBForm.showErrorMessage(admin.find('.sb-notes-box'), 'Please write something...');
            } else {
                if (loading(this)) return;
                message = SBF.escape(message);
                SBConversations.notes.add(SBChat.conversation.id, SB_ACTIVE_AGENT.id, SB_ACTIVE_AGENT.full_name, message, (response) => {
                    if (Number.isInteger(response) || response === true) {
                        $(this).sbLoading(false);
                        admin.sbHideLightbox();
                        if (note_id) {
                            notes_panel.find(`[data-id="${note_id}"]`).remove();
                        }
                        SBConversations.notes.update([{ id: note_id ? note_id : response, conversation_id: SBChat.conversation.id, user_id: SB_ACTIVE_AGENT.id, name: SB_ACTIVE_AGENT['full_name'], message: message }], true);
                        textarea.val('');
                        infoBottom(note_id ? 'Note successfully updated.' : 'New note successfully added.');
                    } else {
                        SBForm.showErrorMessage(response);
                    }
                }, note_id);
            }
        });

        tags_panel.on('click', '> i', function (e) {
            let code = SBConversations.tags.getAll(SBChat.conversation.details.tags);;
            let tags = SBChat.conversation.details.tags;
            SBAdmin.genericPanel('tags', 'Manage tags', code ? '<div class="sb-tags-cnt">' + code + '</div>' : '<p>' + sb_('Add tags from Settings > Admin > Settings Customization > Tags.') + '</p>', ['Save tags']);
            e.preventDefault();
            return false;
        });

        $(admin).on('click', '.sb-tags-cnt > span', function () {
            $(this).toggleClass('sb-active');
        });

        $(admin).on('click', '#sb-add-tag', function () {
            $('<input type="text">').insertBefore(this);
        });

        $(admin).on('click', '#sb-save-tags', function () {
            if (loading(this)) return;
            let tags = admin.find('.sb-tags-box').find('span.sb-active').map(function () {
                return $(this).attr('data-value');
            }).toArray();
            let conversation_id = SBChat.conversation.id;
            SBF.ajax({
                function: 'update-tags',
                conversation_id: conversation_id,
                tags: tags
            }, (response) => {
                $(this).sbLoading(false);
                if (response === true) {
                    SBConversations.tags.update(tags);
                    if (SBChat.conversation && conversation_id == SBChat.conversation.id) {
                        let tag_filter = SBConversations.filters()[3];
                        let conversation_li = getListConversation(conversation_id);
                        SBChat.conversation.set('tags', tags);
                        if (tag_filter && !tags.includes(tag_filter)) {
                            conversation_li.remove();
                            SBConversations.clickFirst();
                        } else if (SB_ADMIN_SETTINGS.tags_show) {
                            let tags_area = conversation_li.find('.sb-tags-area');
                            let code = SBConversations.tags.codeLeft(tags);
                            if (tags_area.length) {
                                tags_area.replaceWith(code);
                            } else {
                                $(code).insertAfter(conversation_li.find('.sb-name'));
                            }
                        }
                    }
                }
                admin.sbHideLightbox();
                infoBottom(response === true ? 'Tags have been successfully updated.' : response);
            });
        });

        // Suggestions
        $(suggestions_area).on('click', 'span', function () {
            SBChat.insertText($(this).text());
            suggestions_area.html('');
        });

        $(suggestions_area).on('mouseover', 'span', function () {
            timeout = setTimeout(() => { $(this).addClass('sb-suggestion-full'); }, 2500);
        });

        $(suggestions_area).on('mouseout', 'span', function () {
            clearTimeout(timeout);
            suggestions_area.find('span').removeClass('sb-suggestion-full');
        });

        // Message menu
        $(conversations_area).on('click', '.sb-list .sb-menu > li', function () {
            let message = $(this).closest('[data-id]');
            let message_id = message.attr('data-id');
            let message_ = SBChat.conversation.getMessage(message_id);
            let message_user_type = message_.get('user_type');
            let value = $(this).attr('data-value');
            switch (value) {
                case 'delete':
                    if (SBChat.user_online) {
                        SBF.ajax({
                            function: 'update-message',
                            message_id: message_id,
                            message: '',
                            attachments: [],
                            payload: { 'event': 'delete-message' }
                        }, () => {
                            SBChat.conversation.deleteMessage(message_id);
                            message.remove();
                        });
                    } else {
                        SBChat.deleteMessage(message_id);
                    }
                    break;
                case 'translation':
                case 'original':
                    let is_translation = value == 'translation';
                    let keys = ['translation', 'translation-language', 'original-message', 'original-message-language'];
                    let original_payload = keys.map(key => message_.payload(key)).concat(message_.details.message);
                    message_.set('message', is_translation ? message_.payload('translation') || message_.get('message') : message_.payload('original-message') || message_.get('message'));
                    keys.forEach(key => delete message_.details.payload[key]);
                    message.replaceWith(message_.getCode().replace('sb-menu">', `sb-menu"><li data-value="${is_translation ? 'original' : 'translation'}">${sb_(is_translation ? 'View original message' : 'View translation')}</li>`));
                    keys.forEach((key, i) => message_.payload(key, original_payload[i]));
                    message_.details.message = original_payload[4];
                    break;
                case 'bot':
                    SBApps.dialogflow.showCreateIntentBox($(this).closest('[data-id]').attr('data-id'));
                    break;
                case 'reply':
                    let is_agent = SBF.isAgent(message_user_type);
                    let text = message_.get('message');
                    if (!text) {
                        message_.attachments.forEach((attachment) => {
                            text += '<i class="sb-icon-clip"></i>' + attachment[0];
                        });
                    }
                    conversations_area.find('.sb-editor [data-reply]').remove();
                    conversations_area.find('.sb-editor').prepend(`<div data-reply="${message_id}"${is_agent ? ' class="sb-reply-color"' : ''}><span>${(is_agent && admin) || (!is_agent && !admin) ? sb_('You') : message_.get('full_name')}</span>${text}<i class="sb-icon-close" onclick="SBChat.cancelReply()"></i></div>`);
                    conversations_area_list.addClass('sb-reply-active');
                    break;
            }
        });

        // Conversations filter
        //$(conversations_area).on('click', '.sb-filter-btn i', function () {
        $(conversations_area).on('click', '.sb-filter-btn .toggle-filter', function () {
            $(this).parent().toggleClass('sb-active');
        });

        $(conversations_area).on('click', '.sb-filter-star', function () {
            $(this).parent().find('li').sbActive(false);
            $(this).parent().find(`li[data-value="${$(this).sbActive() ? '' : $(this).attr('data-value')}"]`).last().sbActive(true).click();
            $(this).toggleClass('sb-active');
        });

        // Attachments filter
        attachments_panel.on('click', '#sb-attachments-filter li', function () {
            let links = attachments_panel.find('a:not(.sb-collapse-btn)');
            let file_type = $(this).attr('data-value');
            links.each(function () {
                $(this).setClass('sb-hide', file_type && SBF.getFileType($(this).attr('href')) != file_type);
            });
            collapse(attachments_panel, 160);
        });

        // CC
        $(admin).on('click', '.sb-cc-box #sb-save-changes', function () {
            let cc = admin.find('.sb-cc-box .repeater-item input').map(function () {
                return $(this).val();
            }).get().join(',');
            loading(this);
            SBF.ajax({
                function: 'update-conversation-extra',
                conversation_id: SBChat.conversation.id,
                extra: cc ? cc : 'NULL'
            }, () => {
                SBChat.conversation.set('extra', cc);
                SBConversations.cc(cc.split(','));
                $(this).sbLoading(false);
                admin.sbHideLightbox();
            });
        });

        /*
        *-----------------------------------------------------------
        *  Tickets Area
        * ----------------------------------------------------------
        */

        /* Ticket listing page quick status change code starts */

        // Toggle dropdown on button click
        $(document).on('click', '.currentStatusBtn, .currentPriorityBtn', function (e) {
            e.stopPropagation();
            $('.status-list, .priority-list').not($(this).next()).hide();
            $(this).next().toggle();
        });


        // Handle status selection
        $(document).on('click', '.status-list li', function () {
            $(this).parent().prev()
            // .html($(this).html() + ' <span class="arrow">&#9660;</span>')
            // .attr('class', 'currentStatusBtn status-btn ' + $(this).attr('class'))
            // .attr('style', $(this).attr('style'));
            const ticket_id = $(this).parent().prev().data('id');
            const status_id = $(this).val();
            $(this).parent().hide();

            SBTicket.updateTicketStatus(ticket_id, status_id);
        });

        // Handle priority selection
        $(document).on('click', '.priority-list li', function () {
            $(this).parent().prev()
            // .html($(this).html() + ' <span class="arrow">&#9660;</span>')
            // .attr('class', 'currentPriorityBtn status-btn ' + $(this).attr('class'))
            // .attr('style', $(this).attr('style'));
            const ticket_id = $(this).parent().prev().data('id');
            const priority_id = $(this).val();
            $(this).parent().hide();
            SBTicket.updateTicketPriority(ticket_id, priority_id);
        });



        // Hide dropdown when clicking outside
        $(document).on('click', function (e) {
            //if (!$(e.target).closest('.currentStatusBtn, .status-list').length) {
            $('.sb-area-tickets').find('.status-list').hide();
            $('.sb-area-tickets').find('.priority-list').hide();
            // }
        });

        /* Ticket listing page quick status change code ends */

        const getTicketsFilteredByTag = () => {
            const ticketStatus = document.querySelector('.sb-menu-tickets li.sb-active')?.getAttribute('data-type');
            const tags = $('#tags-filter').val() || '';

            SBF.ajax({
                function: 'get-tickets',
                id: false,
                ticket_status: ticketStatus,
                categories: false,
                tickets_language: false,
                full: true,
                tags: tags,
                user_id: false
            }, (response) => {
                SBTicket.populate(response);
            });
        }
        // Listen for item selection

        const tagsFilterEl = document.getElementById('tags-filter');
        if (tagsFilterEl) {
            document.getElementById('tags-filter').addEventListener('addItem', function (event) {
                getTicketsFilteredByTag();
            });

            // tagsFilterChoices.passedElement.element.addEventListener('removeItem', function (event) {
            //     getTicketsFilteredByTag();
            // });
        }

        $(settings_area).on('click', '.sb-new-ticket-custom-field', function () {
            ticket_custom_fields_edit_box.addClass('sb-ticket-new-custom-field');
            ticket_custom_fields_edit_box.find('.sb-top-bar h2').html(sb_('Create Custom Field'));
            //ticket_custom_fields_edit_box.find('.sb-top-bar .sb-edit').html(`<i class="sb-icon-check"></i>${sb_('Add Ticket')}`);
            ticket_custom_fields_edit_box.find('input,select,textara').removeClass('sb-error');
            ticket_custom_fields_edit_box.removeClass('sb-cloud-admin');
            SBTicket.clear(ticket_custom_fields_edit_box);
            ticket_custom_fields_edit_box.sbShowLightbox();
            ticket_custom_fields_edit_box.find('#optionsContainer').style = 'display:none';
            ticket_custom_fields_edit_box.find('#optionsContainer textarea').val('');
        });

        $(settings_area).on('click', '.edit-custom-field', function () {
            ticket_custom_fields_edit_box.removeClass('sb-ticket-new-custom-field');
            ticket_custom_fields_edit_box.find('.sb-top-bar h2').html(sb_('Edit Custom Field'));
            //ticket_custom_fields_edit_box.find('.sb-top-bar .sb-edit').html(`<i class="sb-icon-check"></i>${sb_('Add Ticket')}`);
            ticket_custom_fields_edit_box.find('input,select,textara').removeClass('sb-error');
            ticket_custom_fields_edit_box.removeClass('sb-cloud-admin');
            ticket_custom_fields_edit_box.sbShowLightbox();
            const custom_field_id = this.getAttribute('data-id');

            SBF.ajax({
                function: 'edit-ticket-custom-field',
                custom_field_id: custom_field_id
            }, (response) => {
                // Update form fields
                //ticket_custom_fields_edit_box.find('').value = 'response.subject';
                document.querySelector('.sb-ticket-custom-fields-edit-box #title input').value = response.title;
                document.querySelector('.sb-ticket-custom-fields-edit-box #type select').value = response.type;
                const optionsContainer = document.getElementById("optionsContainer");
                if (response.type === "select" || response.type === "checkbox") {
                    optionsContainer.style.display = "flex";
                } else {
                    optionsContainer.style.display = "none";
                }
                document.querySelector('.sb-ticket-custom-fields-edit-box #optionsContainer textarea').value = response.options;
                document.querySelector('.sb-ticket-custom-fields-edit-box #required input[type="checkbox"]').checked = response.required == '1';
                document.querySelector('.sb-ticket-custom-fields-edit-box #add_to_frontend_form input[type="checkbox"]').checked = response.add_to_frontend_form == '1';
                document.querySelector('.sb-ticket-custom-fields-edit-box #default_value input').value = response.default_value;
                document.querySelector('.sb-ticket-custom-fields-edit-box #order input').value = response.order_no;
                document.querySelector('.sb-ticket-custom-fields-edit-box #is_active input[type="checkbox"]').checked = response.is_active == '1';
                document.querySelector('.sb-ticket-custom-fields-edit-box #custom_field_id').value = response.id;

            });
        });

        $(settings_area).on('click', '.sb-ticket-add-new-status', function () {
            ticket_status_edit_box.addClass('sb-ticket-new-status');
            ticket_status_edit_box.find('.sb-top-bar h2').html(sb_('Add Status'));
            //ticket_custom_fields_edit_box.find('.sb-top-bar .sb-edit').html(`<i class="sb-icon-check"></i>${sb_('Add Ticket')}`);
            ticket_status_edit_box.find('input,select,textara').removeClass('sb-error');
            ticket_status_edit_box.removeClass('sb-cloud-admin');
            SBTicket.clear(ticket_status_edit_box);
            ticket_status_edit_box.sbShowLightbox();
        });

        $(settings_area).on('click', '.edit-ticket-status', function () {
            ticket_status_edit_box.removeClass('sb-ticket-new-status');
            ticket_status_edit_box.find('.sb-top-bar h2').html(sb_('Edit Status'));
            //ticket_custom_fields_edit_box.find('.sb-top-bar .sb-edit').html(`<i class="sb-icon-check"></i>${sb_('Add Ticket')}`);
            ticket_status_edit_box.find('input,select,textara').removeClass('sb-error');
            ticket_status_edit_box.removeClass('sb-cloud-admin');
            ticket_status_edit_box.sbShowLightbox();
            const custom_status_id = this.getAttribute('data-id');

            SBF.ajax({
                function: 'edit-ticket-status',
                custom_field_id: custom_status_id
            }, (response) => {

                // Update form fields
                document.querySelector('.sb-ticket-statuses-edit-box #status_title input').value = response.name;
                const inputEl = document.querySelector('.sb-ticket-statuses-edit-box #status_color input');
                if (inputEl) {
                    inputEl.value = response.color; // sets input value
                    inputEl.style.backgroundColor = response.color; // sets background
                }
                document.querySelector('.sb-ticket-statuses-edit-box #status_id').value = custom_status_id;
            });
        });

        $('#customer-overview').on("click", async function () {
            SBDashboard.fetchCustomerOverview();
        });

        $("#save-ticket-attachments").on("click", async function () {
            try {

                let attachments = $('#uploaded_files').val() ?? null;

                let attachmentsCount = $('.ticket-attachments .text-center').length;

                let ticket_id = $('#ticket_id_d').val() ?? null;

                SBF.ajax({
                    function: 'update-ticket-attachments',
                    ticket_id: ticket_id,
                    attachments: attachments,
                }, (response) => {
                    $(this).sbLoading(false);
                    admin.sbHideLightbox();
                    infoBottom('Attachments saved successfully.');
                    $('#uploaded_files').val('');
                    $('#view-ticket-attachments .attachments-count').html(attachmentsCount);

                    $('#reopendTicketAttachmentsPopup').val(1);
                    // let newAttachments = $('#file-preview-list').html();

                    // $('#current-attachments').append(newAttachments);
                    $('#file-preview-list').html('');

                });
            }
            catch (error) {
                console.error(error);
                infoBottom(error, "error");
            }
        });

        $('#registration-required select').on('change', function () {
            let requireRegistration = $(this).val();
            if (requireRegistration) {
                $('#reg-email input').prop('checked', 'checked');
                $('#reg-required-email input').prop('checked', 'checked');

            }
        });

        $('#ticket-status').on('change', function () {
            let ticketStatus = $(this).val();
            let ticket_id = $('#ticket_id_d').val() ?? null;
            SBTicket.updateTicketStatus(ticket_id, ticketStatus);
        });


        $('.sb-save-ticket').on('click', function () {
            let ticket_id = $('#ticket_id_d').val() ?? null;
            let data = {};
            let isValid = true;

            // Get settings
            let assignee = $('#select-ticket-agent').val();
            let department = $('#ticket-department').val();
            let tags = $('#ticket-detail-tags-filter').val();
            let priority = $('#ticket-priority').val();
            let reporter = $('#select-ticket-reporter').val();

            let guest = $('#sb-area-ticket-detail').find('#without_contact input').prop('checked') ? 1 : 0;

            const delta = SBTicket.quillForTicketDetail.getContents();
            const description = JSON.stringify(delta);

            const container = document.getElementById('custom-fields');
            const fields = container.querySelectorAll('input, select, textarea');

            const customField = {};

            fields.forEach(field => {

                const name = field.id.replace('custom_', '');
                customField[name] = field.value;
                if (field.hasAttribute('required') && !field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                    customField[name] = field.value.trim();
                }

            });
            if (!isValid) {
                infoBottom('Please fill all required custom fields.', 'error');
                return;
            }

            let ticketData = { assignee, reporter, department, tags, priority, description, customField };

            SBF.ajax({
                function: 'update-ticket-details',
                ticket_id: ticket_id,
                data: ticketData,
            }, (response) => {
                if (response.success) {
                    infoBottom('Ticket updated successfully.');
                }
            });
        });



        $("#save-ticket-status").on("click", async function () {
            try {

                const div = document.getElementById('ticketStatusesForm');
                const inputs = div.querySelectorAll('input, select, textarea'); // more complete
                const values = {};

                let isFormValid = true;
                let emptyFields = [];

                inputs.forEach(el => {

                    if (el.type !== 'checkbox' && el.type !== 'hidden') {
                        // Check for empty text or unselected select
                        if (el.value.trim() === '') {

                            const labelSpan = el.previousElementSibling;
                            if (labelSpan && labelSpan.tagName.toLowerCase() === 'span') {
                                emptyFields.push(labelSpan.textContent.trim());
                            }
                            isFormValid = false;
                            el.style.border = '1px solid red'; // Highlight the empty field
                        }
                        else {
                            el.style.border = 'none'; // Highlight the empty field
                        }
                    }

                    if (el.type === "checkbox") {
                        values[el.name] = el.checked ? 1 : 0;
                    } else {
                        values[el.name] = el.value;
                    }
                });


                if (!isFormValid) {
                    SBTicket.showErrorMessage($('.sb-ticket-statuses-edit-box'), `${emptyFields.join(', ')} are required.`);
                    $(this).sbLoading(false);
                    return;
                }

                let new_status = (ticket_status_edit_box.hasClass('sb-ticket-new-status') ? true : false);

                // Convert SBF.ajax to a Promise wrapper if it doesn't already return a Promise
                const response = await new Promise((resolve, reject) => {
                    SBF.ajax({
                        function: "add-ticket-status",
                        data1: values,
                    }, (res) => {
                        if (res && res.error) {
                            reject(res.error.message);
                        } else {
                            resolve(res);
                            admin.sbHideLightbox();
                            let msg = new_status ? "created" : "updated";
                            infoBottom('Ticket status ' + msg);

                            setTimeout(function () {
                                window.location.reload();
                            }, 1200);
                        }
                    });
                });

            } catch (error) {
                console.error(error);
                infoBottom(error, "error");
            }
        });

        ////// Preview color in input when choose from color picker
        const colorInput = document.getElementById('statuscolor');
        colorInput.addEventListener('input', function () {
            this.style.backgroundColor = this.value;
        });

        // Show/hide options input based on field type in ticket custom fields popup
        $(document).on('change', '#type select', function () {
            const optionsContainer = document.getElementById('optionsContainer');
            if (this.value === 'select' || this.value === 'checkbox') {
                optionsContainer.style.display = 'flex';
            } else {
                optionsContainer.style.display = 'none';
            }
        });

        $("#save-custom-fields").on("click", async function () {
            try {

                const div = document.getElementById('customFieldForm');
                const inputs = div.querySelectorAll('input, select, textarea'); // more complete
                const values = {};

                let isFormValid = true;
                let emptyFields = [];

                inputs.forEach(el => {

                    if (el.type !== 'checkbox' && el.type !== 'hidden') {
                        // Check for empty text or unselected select
                        if (el.value.trim() === '' && el.name !== 'default_value') {

                            if (el.name == 'options' && (document.querySelector('#customFieldForm #type select').value != 'select' && document.querySelector('#customFieldForm #type select').value != 'checkbox')) {

                            }
                            else {
                                const labelSpan = el.previousElementSibling;
                                if (labelSpan && labelSpan.tagName.toLowerCase() === 'span') {
                                    emptyFields.push(labelSpan.textContent.trim());
                                }
                                isFormValid = false;
                                el.style.border = '1px solid red'; // Highlight the empty field
                            }
                        }
                        else {
                            // el.style.border = 'none'; // Highlight the empty field
                            el.style.border = '1px solid #ccc'; // Highlight the empty field
                        }
                    }

                    if (el.type === "checkbox") {
                        values[el.name] = el.checked ? 1 : 0;
                    } else {
                        values[el.name] = el.value;
                    }
                });


                if (!isFormValid) {
                    SBTicket.showErrorMessage($('.sb-ticket-custom-fields-edit-box'), `${emptyFields.join(', ')} are required.`);
                    $(this).sbLoading(false);
                    return;
                }

                let new_field = (ticket_custom_fields_edit_box.hasClass('sb-ticket-new-custom-field') ? true : false);

                // Convert SBF.ajax to a Promise wrapper if it doesn't already return a Promise
                const response = await new Promise((resolve, reject) => {
                    SBF.ajax({
                        function: "add-ticket-custom-field",
                        data1: values,
                    }, (res) => {
                        if (res && res.error) {
                            reject(res.error.message);
                        } else {
                            resolve(res);
                            admin.sbHideLightbox();
                            infoBottom('Custom field created');
                            setTimeout(function () {
                                window.location.reload();
                            }, 1200);
                        }
                    });
                });

            } catch (error) {
                console.error(error);
                infoBottom(error, "error");
            }
        });

        $(settings_area).on('click', '.delete-custom-field', async function () {
            try {
                const id = parseInt(this.getAttribute('data-id'));

                if (!id || id == 'NaN') {
                    alert('Invalid ID');
                    return;
                }

                const message = 'You want to delete this custom field? This action cannot be undone.';

                infoPanel(message, 'alert', async function () {
                    // Convert SBF.ajax to a Promise wrapper if it doesn't already return a Promise
                    const response = await new Promise((resolve, reject) => {

                        SBF.ajax({
                            function: "delete-ticket-custom-field",
                            id: id,
                        }, (res) => {
                            if (res && res.error) {
                                reject(res.error.message);
                            } else {

                                resolve(res);

                                if (!res.success) {
                                    admin.sbHideLightbox();
                                    infoBottom(res.message, 'error');
                                    return;
                                }
                                $('.custom-fields-table tr[data-id="custom_field_row_' + id + '"]').remove();
                            }
                        });
                    });
                });

            }
            catch (error) {
                console.error(error);
                infoBottom(error, "error");
            }
        });

        ///// Delete ticket status
        $(settings_area).on('click', '.delete-ticket-status', async function () {
            try {
                const id = parseInt(this.getAttribute('data-id'));

                if (!id || id == 'NaN') {
                    alert('Invalid ID');
                    return;
                }

                const message = 'You want to delete this status? This action cannot be undone.';

                infoPanel(message, 'alert', async function () {
                    // Convert SBF.ajax to a Promise wrapper if it doesn't already return a Promise
                    const response = await new Promise((resolve, reject) => {

                        SBF.ajax({
                            function: "delete-ticket-status",
                            id: id,
                        }, (res) => {
                            if (res && res.error) {
                                reject(res.error.message);
                            } else {

                                resolve(res);

                                if (!res.success) {
                                    admin.sbHideLightbox();
                                    infoBottom(res.message, 'error');
                                    return;
                                }
                                $('.ticket-status-table tr[data-id="ticket_status_row_' + id + '"]').remove();
                            }
                        });
                    });
                });

            }
            catch (error) {
                console.error(error);
                infoBottom(error, "error");
            }
        });


        // Display Ticket Edit box when clicking on a edit button
        // $(tickets_table).on('click', 'td:not(:first-child)', function () {
        //     ticket_edit_box.removeClass('sb-ticket-new');
        //     SBTicket.show($(this).parent().attr('data-ticket-id'));
        // });

        // Open the ticket clicked on the ticket listing page
        $(tickets_table).on('click', 'td:not(:first-child):not(.no-click)', function () {
            let ticket_id = $(this).parent().attr('data-ticket-id');
            SBTicket.openTicketArea(ticket_id);
        });

        $('.tsubject').on('click', function () {
            $('#ticket-subject').addClass('active');
            $('#ticket-subject').focus();
        });

        $('#ticket-subject').on('blur', function () {
            $(this).removeClass('active');
            let ticket_id = $('#ticket_id_d').val() ?? null;
            let subject = $(this).val() ?? null;

            SBF.ajax({
                function: "update-ticket-subject",
                ticket_id: ticket_id,
                subject: subject,
            }, (res) => {

            });
        });


        $('#save-note').on('click', function () {
            $(this).removeClass('active');
            let ticket_id = $('#ticket_id_d').val() ?? null;
            const delta = SBTicket.quillForTicketInternalNote.getContents();
            const note = JSON.stringify(delta);

            SBF.ajax({
                function: "update-ticket-note",
                ticket_id: ticket_id,
                note: note,
            }, (res) => {
                if (res.success)
                    infoBottom("Notes saved sucessfully.");
            });
        });

        // Table menu filter
        $(tickets_table_menu).on('click', 'li', function () {
            SBTicket.filter($(this).data('type'));
        });

        // Display new user box
        $(tickets_area).on('click', '.sb-new-ticket', function () {
            ticket_edit_box.addClass('sb-ticket-new');
            ticket_edit_box.find('.sb-top-bar .sb-ticket span').html(sb_('Add new ticket'));
            ticket_edit_box.find('.sb-top-bar .sb-save').html(`<i class="sb-icon-check"></i>${sb_('Add Ticket')}`);
            ticket_edit_box.find('input,select,textara').removeClass('sb-error');
            ticket_edit_box.removeClass('sb-cloud-admin');

            ///// Clear all inputs wheneve create ticket popup opens
            SBTicket.clear(ticket_edit_box);
            //// Clear unsaved attachements preview
            $('#file-preview-container #file-preview-list').html('');
            $('#uploaded_files').val('');
            $('#existing-file-preview-container').addClass('d-none');
            $('#existing-file-preview-container #current-attachments').html('');


            //SBTicket.updateRequiredFields('ticket');
            ////////////  Create a new Quill editor instance
            if (!SBTicket.quill) {
                const container = document.querySelector('#ticketdescription');
                SBTicket.quill = new Quill(container, {
                    theme: 'snow',
                    placeholder: 'Compose something...',
                });
            }
            SBTicket.quill.setContents('');

            ticket_edit_box.sbShowLightbox();
            SBTicket.loadCustomFields('add');

            // Define variable in outer scope
            let latestFiveCustomers = [];

            SBTicket.fetchUsers().then(users => {
                latestFiveCustomers = users;
            });

            // $('#select-customer').select2({
            //     placeholder: 'Type and search...',
            //     ajax: {
            //         url: SB_URL+'/include/ajax.php', // Your endpoint
            //         method: 'POST',
            //         dataType: 'json',
            //         delay: 250,
            //         data: function (params) {
            //             return {
            //                 function: 'ajax_calls',
            //                 'calls[0][function]': 'search-get-users',
            //                 'login-cookie': SBF.loginCookie(),
            //                 'q': params.term, // â Pass search term
            //                 'type': 'user'
            //             };
            //         },
            //         processResults: function (response) {
            //             //response = JSON.parse(response);
            //             if (response[0][0] == 'success') {
            //                 const users = response[0][1];
            //                 // document.querySelector('#name select').value = response.priority_id;
            //                 return {
            //                     results: users.map(user => ({
            //                         id: user.id,
            //                         text: user.first_name + ' ' + user.last_name,
            //                         email: user.email,
            //                         name: user.first_name + ' ' + user.last_name
            //                     }))
            //                 };
            //             }
            //         },
            //         cache: true
            //     },
            //     minimumInputLength: 0
            // });


            $('#select-customer').select2({
                placeholder: 'Type and search...',
                minimumInputLength: 0,
                ajax: {
                    transport: function (params, success, failure) {
                        const term = (params.data.q || '').toLowerCase();
                        const loginCookie = SBF.loginCookie();

                        $.ajax({
                            url: SB_URL + '/include/ajax.php',
                            method: 'POST',
                            dataType: 'json',
                            data: {
                                function: 'ajax_calls',
                                'calls[0][function]': 'search-get-users',
                                'login-cookie': loginCookie,
                                'q': term,
                                'type': 'user'
                            },
                            success: function (response) {
                                if (response[0][0] === 'success') {
                                    const users = response[0][1];
                                    let results;

                                    if (!term) {
                                        // Show latest 5 users
                                        results = latestFiveCustomers.slice(-5).reverse().map(user => ({
                                            id: user.id,
                                            text: user.first_name + ' ' + user.last_name,
                                            email: user.email,
                                            name: user.first_name + ' ' + user.last_name
                                        }));
                                    } else {
                                        results = users
                                            .filter(user => (user.first_name + ' ' + user.last_name).toLowerCase().includes(term))
                                            .map(user => ({
                                                id: user.id,
                                                text: user.first_name + ' ' + user.last_name,
                                                email: user.email,
                                                name: user.first_name + ' ' + user.last_name
                                            }));

                                        if (results.length === 0) {
                                            results.push({
                                                id: '__add__' + term,
                                                text: 'â Add "' + term + '" as New Customer',
                                                name: term,
                                                email: '',
                                                isAddNew: true
                                            });
                                        }
                                    }

                                    success({ results });
                                } else {
                                    failure();
                                }
                            },
                            error: failure
                        });
                    },
                    cache: true
                },
                templateResult: function (data) {
                    if (data.loading) return data.text;
                    if (data.isAddNew) {
                        return $('<div style="color: #fff;"><strong>' + data.text + '</strong></div>');
                    }
                    return $('<div><strong>' + data.text + '</strong><br/><small>' + (data.email || '') + '</small></div>');
                },
                templateSelection: function (data) {
                    return data.text;
                }
            });



            $('#select-customer').on('select2:select', function (e) {
                const selectedCustomer = e.params.data;

                // Now fill other input fields
                document.querySelector('#cust_name input').value = selectedCustomer.name;
                document.querySelector('#cust_email input').value = selectedCustomer.email;
                //$('#user-name').val(selectedCustomer.first_name + ' ' + selectedUser.last_name);
                if (selectedCustomer.isAddNew) {
                    $('#new_user').val(1);
                }
                else {
                    $('#new_user').val(0);
                }

            });


        });

        // Display new user box
        $('.sb-area-ticket-detail').on('click', '#view-ticket-attachments', function () {
            // ticket_attachments_box.addClass('sb-ticket-new');
            // ticket_attachments_box.find('.sb-top-bar .sb-ticket span').html(sb_('Add new ticket'));
            // ticket_attachments_box.find('.sb-top-bar .sb-save').html(`<i class="sb-icon-check"></i>${sb_('Add Ticket')}`);
            // ticket_attachments_box.find('input,select,textara').removeClass('sb-error');
            // ticket_attachments_box.removeClass('sb-cloud-admin');
            $('.ticket-attachments').sbShowLightbox();
            let ticket_id = $('#ticket_id_d').val() ?? null;

            SBF.ajax({
                function: 'fecth-ticket-attachments',
                ticket_id: ticket_id,
            }, (response) => {
                if (response) {
                    let attachmentsHtml = '';
                    Object.entries(response).forEach(([key, value]) => {
                        attachmentsHtml += `<div class="col-md-2 mb-2">
                                            <div class="card">
                                                <div class="card-body p-2">
                                                    <i class="fa-solid fa-x delete-attachment" style="color: #dc3545;" data-index="0" data-id="${value.id}" data-ticket-id="${ticket_id}"></i>
                                                    <div class="text-center mb-2">
                                                        <img src="script/${value.file_path}" class="img-thumbnail p-0" style="max-height: 100px; margin-top:10px;" alt="${value.original_filename}">
                                                    </div>
                                                    <div class="d-flex align-items-center">
                                                        <div class="flex-grow-1 text-truncate">
                                                            <div class="text-truncate">${value.original_filename}</div>
                                                            <small class="text-muted">${value.file_size}</small>
                                                        </div>
                                                        <!--button type="button" class="btn btn-sm btn-danger delete-attachment" data-index="0" data-id="${value.id}" data-ticket-id="${ticket_id}">
                                                            <i class="bi bi-x"></i>
                                                        </button-->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>`;

                    });

                    $('#existing-file-preview-container #current-attachments').html('');
                    $('#existing-file-preview-container').addClass('d-none');
                    if (attachmentsHtml != '') {
                        $('#existing-file-preview-container').removeClass('d-none');
                        $('#existing-file-preview-container #current-attachments').html(attachmentsHtml);
                    }

                    //// Clear unsaved attachements preview
                    //$('#file-preview-container #file-preview-list').html('');
                    //$('#uploaded_files').val('');
                }
            });


        });

        // Add or update ticket
        $(ticket_edit_box).on('click', '.sb-save', function () {
            if (loading(this)) return;
            let new_ticket = (ticket_edit_box.hasClass('sb-ticket-new') ? true : false);
            let ticket_id = ticket_edit_box.find('#ticket_id').val();
            let data = {};

            // Get settings
            let ticketDataPart1 = SBTicket.getAll(ticket_edit_box.find('.sb-details'));
            let ticketDataPart2 = SBTicket.getAll(ticket_edit_box.find('.sb-additional-details'));
            //let ticketCustomFields = SBTicket.getAll(ticket_edit_box.find('#ticketCustomFieldsContainer'));

            let ticketDataPart3 = ticket_edit_box.find('#description textarea').val();
            let conversationId = ticket_edit_box.find('#conversation_id').val() ?? null;
            let newUser = ticket_edit_box.find('#new_user').val() == 1 ? 1 : 0;
            let uploadedFiles = ticket_edit_box.find('#uploaded_files1').val() ?? null;
            let guest = ticket_edit_box.find('#without_contact input').prop('checked') ? 1 : 0;
            ticketDataPart3 = SBF.escape(ticketDataPart3);
            conversationId = SBF.escape(conversationId);

            const delta = SBTicket.quill.getContents();
            const deltaJSON = JSON.stringify(delta);

            const description = [];
            description.push(deltaJSON);
            description.push('Description');

            const conversation_id = [];
            conversation_id.push(conversationId);
            conversation_id.push('Conversation ID');

            const new_user = [];
            new_user.push(newUser);
            new_user.push('New User');

            const attachments = [];
            attachments.push(uploadedFiles);
            attachments.push('Attachments');

            const withoutContact = [];
            withoutContact.push(guest);
            withoutContact.push('withoutContact');

            const container = document.getElementById('ticketCustomFieldsContainer');
            const fields = container.querySelectorAll('input, select, textarea');

            const values = {};

            fields.forEach(field => {
                const name = field.id.replace('custom_', ''); // fallback if name missing
                values[name] = field.value;
            });

            const customField = [];
            customField.push(values);
            customField.push('custom_fields');

            let ticketData = { ...ticketDataPart1, ...ticketDataPart2, description, conversation_id, new_user, attachments, withoutContact, customField };

            let output = {};
            $.map(ticketData, function (value, key) {
                data[key] = value[0];
            });

            let isFormValid = true;
            let emptyFields = [];

            // Validate all inputs, selects, and textareas inside the lightbox
            document.querySelectorAll('.sb-ticket-edit-box input, .sb-ticket-edit-box select, .sb-ticket-edit-box textarea').forEach(el => {
                // Skip validation for optional fields (no "required" attribute)
                //if (el.type != 'file' && el.type !== 'checkbox' && el.type !== 'hidden' && el.parentElement.id !== 'cc') {
                if (el.hasAttribute('required')) {
                    // Check for empty text or unselected select
                    if (el.value.trim() === '') {
                        const labelSpan = el.previousElementSibling;
                        if (labelSpan && labelSpan.tagName.toLowerCase() === 'span') {
                            emptyFields.push(labelSpan.textContent.trim());
                        }
                        else if (el.id == 'select-customer') {
                            emptyFields.push("Customer");
                            el.nextElementSibling.style.border = '1px solid red'; // Highlight the empty field
                        }
                        isFormValid = false;
                        el.style.border = '1px solid red'; // Highlight the empty field
                    }
                    else {
                        el.style.border = 'none'; // Highlight the empty field
                        if (el.id == 'select-customer') {

                            el.nextElementSibling.style.border = 'none'; // Highlight the empty field
                        }
                    }

                }
            });

            if (!isFormValid) {
                SBTicket.showErrorMessage(ticket_edit_box, `${emptyFields.join(', ')} are required.`);
                $(this).sbLoading(false);
                return;
            }

            if (!data.user_type) {
                data.ticket_type = 'new';
            }

            // Save the settings
            SBF.ajax({
                function: (new_ticket ? 'add-ticket' : 'update-ticket'),
                ticket_id: ticket_id,
                data1: ticketData,
            }, (response) => {

                $(this).sbLoading(false);

                admin.sbHideLightbox();
                //if(!new_ticket)
                SBTicket.updateRow(response);

                //SBTickets.updateRow(ticketData);
                infoBottom(new_ticket ? 'New Ticket Created' : 'Ticket updated');

                setTimeout(function () {
                    location.reload();
                }, 1500);

                $(header).find('.sb-admin-nav #sb-tickets').click();

            });
        });

        // Add or update ticket
        $('.sb-area-ticket-detail').on('click', '#addComment', function () {
            let new_comment = $('.sb-area-ticket-detail #newComment').hasClass('d-none') ? false : true;
            let commentId = $('.sb-area-ticket-detail #oldComment').attr('data-comment-id') || null;

            let ticketId = SBF.getURL('ticket');
            // Save the settings
            SBF.ajax({
                function: (new_comment ? 'add-ticket-comment' : 'update-ticket-comment'),
                ticket_id: ticketId,
                comment_id: commentId,
                comment: new_comment ? $('.sb-area-ticket-detail #newComment').val() : $('.sb-area-ticket-detail #oldComment').val(),
                contact_id: 0,
            }, (response) => {
                if (response.success) {
                    SBTicket.loadComments(ticketId);
                    $('.sb-area-ticket-detail #newComment').val('');
                    $('.sb-area-ticket-detail #oldComment').val('');
                    $('.sb-area-ticket-detail #newComment').removeClass('d-none');
                    $('.sb-area-ticket-detail #oldComment').addClass('d-none');
                }
            });
        });

        $('#newComment').on('keydown', function (e) {
            // Check if Enter is pressed without Shift
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Prevent newline
                $('#addComment').click(); // Trigger Send button
            }
        });

        $('.sb-area-ticket-detail').on('click', '.edit-comment-btn', function () {
            $('.sb-area-ticket-detail #newComment').removeClass('d-none');
            const commentId = this.getAttribute('data-id');
            const commentsSection = document.getElementById('comments-section');
            const commentDiv = commentsSection.querySelector(`.comment-text[data-id='${commentId}']`);
            if (!commentDiv) return;
            const oldText = commentDiv.innerText;

            const textarea = document.getElementById('oldComment');
            textarea.value = oldText;
            textarea.classList.remove('d-none');
            textarea.classList.add('edit-comment-textarea');
            this.style.display = 'none';
            textarea.focus();
            textarea.setAttribute('data-comment-id', commentId);
            document.getElementById('newComment').classList.add('d-none');
            textarea.onblur = function () {
                $('.sb-area-ticket-detail #addComment').trigger('click');
            };
            textarea.onkeydown = function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    textarea.blur();
                }
            };
        });

        $('.sb-area-ticket-detail').on('click', '.delete-comment-btn', function () {
            const commentId = this.getAttribute('data-id');
            let ticketId = SBF.getURL('ticket');
            // Save the settings
            SBF.ajax({
                function: 'delete-ticket-comment',
                ticket_id: ticketId,
                comment_id: commentId,
            }, (response) => {
                if (response.success) {
                    SBTicket.loadComments(ticketId);
                    $('.sb-area-ticket-detail #newComment').val('');
                    $('.sb-area-ticket-detail #oldComment').val('');
                    $('.sb-area-ticket-detail #newComment').removeClass('d-none');
                    $('.sb-area-ticket-detail #oldComment').addClass('d-none');
                }
            });
        });

        /*
        * ----------------------------------------------------------
        * Users area
        * ----------------------------------------------------------
        */

        // Open user box by URL
        if (SBF.getURL('user')) {
            header.find('.sb-admin-nav #sb-users').click();
            setTimeout(() => { SBProfile.show(SBF.getURL('user')) }, 500);
        }

        // Checkbox selector
        $(users_table).on('click', 'th :checkbox', function () {
            users_table.find('td :checkbox').prop('checked', $(this).prop('checked'));
        });

        $(users_table).on('click', ':checkbox', function () {
            let button = users_area.find('[data-value="delete"]');
            if (users_table.find('td input:checked').length) {
                button.removeAttr('style');
            } else {
                button.hide();
            }
        });

        // Table menu filter
        $(users_table_menu).on('click', 'li', function () {
            SBUsers.filter($(this).data('type'));
        });

        // Filters
        $(users_filters).on('click', 'li', function () {
            let button = users_filters.closest('.sb-filter-btn');
            setTimeout(() => {
                SBUsers.get((response) => {
                    SBUsers.populate(response);
                });
                button.attr('data-badge', users_filters.toArray().reduce((acc, filter) => acc + !!$(filter).find('li.sb-active').data('value'), 0));
            }, 100);
            button.sbActive(false);
        });

        // Search users
        $(users_area).on('input', '.sb-search-btn input', function () {
            SBUsers.search(this);
        });

        $(users_area).on('click', '.sb-search-btn i', function () {
            SBF.searchClear(this, () => { SBUsers.search($(this).next()) });
        });

        // Sorting
        $(users_table).on('click', 'th:not(:first-child)', function () {
            let direction = $(this).hasClass('sb-order-asc') ? 'DESC' : 'ASC';
            $(this).toggleClass('sb-order-asc');
            $(this).siblings().sbActive(false);
            $(this).sbActive(true);
            SBUsers.sort($(this).data('field'), direction);
        });

        // Pagination for users
        $(users_table).parent().on('scroll', function () {
            if (!is_busy && !SBUsers.search_query && scrollPagination(this, true) && users_pagination_count) {
                is_busy = true;
                users_area.append('<div class="sb-loading-global sb-loading sb-loading-pagination"></div>');
                SBUsers.get((response) => {
                    setTimeout(() => { is_busy = false }, 500);
                    users_pagination_count = response.length;
                    if (users_pagination_count) {
                        let code = '';
                        for (var i = 0; i < users_pagination_count; i++) {
                            let user = new SBUser(response[i], response[i].extra);
                            code += SBUsers.getRow(user);
                            users[user.id] = user;
                        }
                        users_pagination++;
                        users_table.find('tbody').append(code);
                    }
                    users_area.find(' > .sb-loading-pagination').remove();
                }, false, true);
            }
        });

        // Delete user button
        $(profile_edit_box).on('click', '.sb-delete', function () {
            if (SB_ACTIVE_AGENT.id == activeUser().id) {
                return infoBottom('You cannot delete yourself.', 'error');
            }
            infoPanel('This user will be deleted permanently including all linked data, conversations, and messages.', 'alert', function () {
                SBUsers.delete(activeUser().id);
            });
        });

        // Display user box
        $(users_table).on('click', 'td:not(:first-child)', function () {
            SBProfile.show($(this).parent().attr('data-user-id'));
        });

        // Display edit box
        $(profile_box).on('click', '.sb-top-bar .sb-edit', function () {
            SBProfile.showEdit(activeUser());
        });

        // Display new user box
        $(users_area).on('click', '.sb-new-user', function () {
            profile_edit_box.addClass('sb-user-new');
            profile_edit_box.find('.sb-top-bar .sb-profile span').html(sb_('Add new customer'));
            profile_edit_box.find('.sb-top-bar .sb-save').html(`<i class="sb-icon-check"></i>${sb_('Add customer')}`);
            profile_edit_box.find('input,select,textara').removeClass('sb-error');
            profile_edit_box.removeClass('sb-cloud-admin');
            if (SB_ACTIVE_AGENT.user_type == 'admin') {
                profile_edit_box.find('#user_type').find('select').html(`<option value="user">${sb_('Customer')}</option><option value="agent">${sb_('Agent')}</option><option value="admin">${sb_('Admin')}</option>`);
            }
            SBProfile.clear(profile_edit_box);
            SBProfile.boxClasses(profile_edit_box);
            SBProfile.updateRequiredFields('user');
            profile_edit_box.sbShowLightbox();
        });

        profile_edit_box.find('#user_type').find('select').on('change', function () {
            var selectedText = $(this).find('option:selected').text();
            $('.sb-profile .sb-name').html(`Add new ${selectedText.toLowerCase()}`);
            profile_edit_box.find('.sb-top-bar .sb-save').html(`<i class="sb-icon-check"></i>Add ${selectedText.toLowerCase()}`);
        });

        // Add or update user
        $(profile_edit_box).on('click', '.sb-save', function () {
            if (loading(this)) return;
            let new_user = (profile_edit_box.hasClass('sb-user-new') ? true : false);
            let user_id = profile_edit_box.attr('data-user-id');

            // Get settings
            let settings = SBProfile.getAll(profile_edit_box.find('.sb-details'));
            let settings_extra = SBProfile.getAll(profile_edit_box.find('.sb-additional-details'));
            let output = {};
            $.map(settings, function (value, key) {
                settings[key] = value[0];
            });
            // Errors check
            const firstName = settings.first_name;
            const email = settings.email;
            const lastName = settings.last_name;
            const password = settings.password;

            // Collect validation errors
            let errorMessages = [];

            if (!firstName.trim()) {
                errorMessages.push('First name');
            }
            if (!lastName.trim()) {
                errorMessages.push('Last name');
            }
            if (!email.trim() || !/^\S+@\S+\.\S+$/.test(email)) {
                errorMessages.push('Valid email');
            }
            if (!password || password.length < 8) {
                errorMessages.push('Password (min 8 characters)');
            }

            // Show all error messages at once
            if (errorMessages.length) {
                const message = `${errorMessages.join(', ')} ${errorMessages.length === 1 ? 'is' : 'are'} required.`;
                SBProfile.showErrorMessage(profile_edit_box, message);
                $(this).sbLoading(false);
                return;
            }

            if (SBProfile.errors(profile_edit_box)) {
                SBProfile.showErrorMessage(profile_edit_box, SBF.isAgent(profile_edit_box.find('#user_type :selected').val()) ? 'First name, last name, password and a valid email are required. Minimum password length is 8 characters.' : (profile_edit_box.find('#password').val().length < 8 ? 'Minimum password length is 8 characters.' : 'First name is required.'));
                $(this).sbLoading(false);
                return;
            }

            if (SB_ACTIVE_AGENT.id == activeUser().id && settings.user_type[0] == 'agent' && SB_ACTIVE_AGENT.user_type == 'admin') {
                SBProfile.showErrorMessage(profile_edit_box, 'You cannot change your status from admin to agent.');
                $(this).sbLoading(false);
                return;
            }
            if (!settings.user_type) {
                settings.user_type = 'user';
            }

            let userType = settings.user_type;
            let capitalized = userType.charAt(0).toUpperCase() + userType.slice(1);

            var selectedText = settings.user_type == 'user' ? 'Customer' : capitalized;

            // Save the settings
            SBF.ajax({
                function: (new_user ? 'add-user' : 'update-user'),
                user_id: user_id,
                settings: settings,
                settings_extra: settings_extra
            }, (response) => {
                if (SBF.errorValidation(response, 'duplicate-email') || SBF.errorValidation(response, 'duplicate-phone')) {
                    SBProfile.showErrorMessage(profile_edit_box, `This ${SBF.errorValidation(response, 'duplicate-email') ? 'email' : 'phone number'} is already in use.`);
                    $(this).sbLoading(false);
                    return;
                }
                if (SBF.errorValidation(response, 'agent-limit-reached') || SBF.errorValidation(response, 'agent-limit-reached')) {
                    SBProfile.showErrorMessage(profile_edit_box, `Agent limit reached. Please upgrade your membership to add more agents.`);
                    $(this).sbLoading(false);
                    return;
                }
                if (new_user) {
                    user_id = response;
                    activeUser(new SBUser({ 'id': user_id }));
                }
                activeUser().update(() => {
                    users[user_id] = activeUser();
                    if (new_user) {
                        SBProfile.clear(profile_edit_box);
                        SBUsers.update();
                    } else {
                        SBUsers.updateRow(activeUser());
                        if (conversations_area.sbActive()) {
                            SBConversations.updateUserDetails();
                        }
                        if (user_id == SB_ACTIVE_AGENT.id) {
                            SBF.loginCookie(response[1]);
                            SB_ACTIVE_AGENT.full_name = activeUser().name;
                            SB_ACTIVE_AGENT.profile_image = activeUser().image;
                            header.find('.sb-account').setProfile();
                        }
                    }
                    if (new_user) {
                        profile_edit_box.find('.sb-profile').setProfile(sb_('Add new customer'));
                    }
                    $(this).sbLoading(false);
                    if (!new_user) {
                        admin.sbHideLightbox();
                    }
                    infoBottom(new_user ? `New ${selectedText} added` : `${selectedText} updated`);
                    admin.sbHideLightbox();

                    setTimeout(function () {
                        let siteUrl = SB_URL.replace(/\/script\/?$/, '/');
                        window.location.href = siteUrl + '?area=users';
                    }, 1000);
                });
                SBF.event('SBUserUpdated', { new_user: new_user, user_id: user_id });
            });
        });

        // Set and unset required visitor fields
        $(profile_edit_box).on('change', '#user_type', function () {
            let value = $(this).find("option:selected").val();
            SBProfile.boxClasses(profile_edit_box, value);
            SBProfile.updateRequiredFields(value);
        });

        // Open a user conversation
        $(profile_box).on('click', '.sb-user-conversations li', function () {
            SBConversations.open($(this).attr('data-conversation-id'), $(this).find('[data-user-id]').attr('data-user-id'));
        });

        // Start a new user conversation
        $(profile_box).on('click', '.sb-start-conversation', function () {
            SBConversations.open(-1, activeUser().id);
            SBConversations.openConversation(-1, activeUser().id);
            if (responsive) {
                SBConversations.mobileOpenConversation();
            }
        });

        // Show direct message box from user profile
        $(profile_box).on('click', '.sb-top-bar [data-value]', function () {
            SBConversations.showDirectMessageBox($(this).attr('data-value'), [activeUser().id]);
        });

        // Top icons menu
        $(users_area).on('click', '.sb-top-bar [data-value]', function () {

            let value = $(this).data('value');
            let user_ids = SBUsers.getSelected();
            switch (value) {
                case 'whatsapp':
                    whatsapp_direct_message_box(user_ids);
                    break;
                case 'message':
                case 'custom_email':
                case 'sms':
                    SBConversations.showDirectMessageBox(value, user_ids);
                    break;
                case 'csv':
                    SBUsers.csv();
                    break;
                case 'delete':
                    if (user_ids.includes(SB_ACTIVE_AGENT.id)) {
                        return infoBottom('You cannot delete yourself.', 'error');
                    }
                    infoPanel('All selected users will be deleted permanently including all linked data, conversations, and messages.', 'alert', () => {
                        SBUsers.delete(user_ids);
                        $(this).hide();
                        users_table.find('th:first-child input').prop('checked', false);
                    });
                    break;
            }
        });

        // Direct message
        $(admin).on('click', '.sb-send-direct-message', function () {
            let type = $(this).attr('data-type') ? $(this).attr('data-type') : direct_message_box.attr('data-type');
            let whatsapp = type == 'whatsapp';
            let box = whatsapp ? admin.find('#sb-whatsapp-send-template-box') : direct_message_box;
            let subject = box.find('.sb-direct-message-subject input').val();
            let message = whatsapp ? '' : box.find('textarea').val();
            let user_ids = box.find('.sb-direct-message-users').val().replace(/ /g, '');
            let template_name = false;
            let template_languages = false;
            let parameters = [];
            let phone_number_id = false;
            if (whatsapp) {
                let select = box.find('#sb-whatsapp-send-template-list');
                template_name = select.val();
                template_languages = select.find('option:selected').attr('data-languages');
                phone_number_id = select.find('option:selected').attr('data-phone-id');
                parameters = ['header', 'body', 'button'].map(id => box.find(`#sb-whatsapp-send-template-${id}`).val());
            }

            $('.bulk-users-wrapper').removeClass('sb-error');
            const checked = $('.user-checkbox:checked');
            const count = checked.length;

            if (SBForm.errors(box)) {
                SBForm.showErrorMessage(box, 'Please complete the mandatory fields.');

                if (!count) {
                    $('.bulk-users-wrapper').addClass('sb-error');
                    SBForm.showErrorMessage(box, 'Please complete the mandatory fields.');
                }
            }
            else {
                if (!count) {
                    $('.bulk-users-wrapper').addClass('sb-error');
                    SBForm.showErrorMessage(box, 'Please complete the mandatory fields.');
                    return;
                }

                if (loading(this)) {
                    return;
                }
                let user_details = [];
                if (message.includes('recipient_name') || parameters.join('').includes('recipient_name')) {
                    user_details.push('first_name', 'last_name');
                }
                if (message.includes('recipient_email') || parameters.join('').includes('recipient_email')) {
                    user_details.push('email');
                }
                if (type == 'message') {
                    SBF.ajax({
                        function: 'direct-message',
                        user_ids: user_ids,
                        message: message
                    }, (response) => {
                        $(this).sbLoading(false);
                        let send_email = SB_ADMIN_SETTINGS.notify_user_email;
                        let send_sms = SB_ADMIN_SETTINGS.sms_active_users;
                        if (SBF.errorValidation(response)) {
                            return SBForm.showErrorMessage(box, 'An error has occurred. Please make sure all user ids are correct.');
                        }
                        if (send_email || send_sms) {
                            SBF.ajax({
                                function: 'get-users-with-details',
                                user_ids: user_ids,
                                details: user_details.concat(send_email && send_sms ? ['email', 'phone'] : [send_email ? 'email' : 'phone'])
                            }, (response) => {
                                if (send_email && response.email.length) {
                                    recursiveSending(response, 'email', message, 0, send_sms ? response.phone : [], 'email', subject);
                                } else if (send_sms && response.phone.length) {
                                    recursiveSending(response, 'phone', message, 0, [], 'sms');
                                } else {
                                    admin.sbHideLightbox();
                                }
                            });
                        }
                        infoBottom(`${SBF.slugToString(type)} sent to selected users.`);
                        admin.sbHideLightbox();

                    });
                } else {
                    let slug = type == 'custom_email' ? 'email' : 'phone';
                    SBF.ajax({
                        function: 'get-users-with-details',
                        user_ids: user_ids,
                        details: user_details.concat([slug])
                    }, (response) => {
                        if (response[slug].length) {
                            recursiveSending(response, slug, message, 0, [], type, subject, template_name, parameters, template_languages, phone_number_id);
                        } else {
                            $(this).sbLoading(false);
                            return SBForm.showErrorMessage(box, 'No users found.');
                        }
                    });
                }
            }
        });

        function recursiveSending(user_ids, slug, message, i = 0, user_ids_sms = [], type, subject = false, template_name = false, parameters = false, template_languages = false, phone_number_id = false) {
            let settings = { whatsapp: ['whatsapp-send-template', 'messages', ' a phone number.', 'direct-whatsapp'], email: ['create-email', 'emails', ' an email address.', false], custom_email: ['send-custom-email', 'emails', ' an email address.', 'direct-emails'], sms: ['send-sms', 'text messages', ' a phone number.', 'direct-sms'] }[type];
            SBF.ajax({
                function: settings[0],
                to: user_ids[slug][i].value,
                recipient_id: user_ids[slug][i].id,
                sender_name: SB_ACTIVE_AGENT['full_name'],
                sender_profile_image: SB_ACTIVE_AGENT['profile_image'],
                subject: subject,
                message: message,
                template_name: template_name,
                parameters: parameters,
                template_languages: template_languages,
                template: false,
                phone_id: phone_number_id,
                user_name: user_ids.first_name ? (user_ids.first_name[i].value + ' ' + user_ids.last_name[i].value).trim() : false,
                user_email: user_ids.email ? user_ids.email[i].value : false
            }, (response) => {
                let user_ids_length = user_ids[slug].length;
                let box = type == 'whatsapp' ? admin.find('#sb-whatsapp-send-template-box') : direct_message_box;
                box.find('.sb-bottom > div').html(`${sb_('Sending')} ${sb_(settings[1])}... ${i + 1} / ${user_ids_length}`);
                if (response) {
                    if (response !== true && (('status' in response && response.status == 400) || ('error' in response && ![131030, 131009].includes(response.error.code)))) {
                        SBForm.showErrorMessage(box, response.error ? response.error.message : `${response.message} Details at ${response.more_info}`);
                        console.error(response);
                        box.find('.sb-loading').sbLoading(false);
                        box.find('.sb-bottom > div').html('');
                        return;
                    }
                    if (i < user_ids_length - 1) {
                        return recursiveSending(user_ids, slug, message, i + 1, user_ids_sms, type, subject, template_name, parameters, template_languages, phone_number_id);
                    } else {
                        if (user_ids_sms.length) {
                            recursiveSending(user_ids_sms, slug, message, 0, [], 'sms', false);
                        } else {
                            admin.sbHideLightbox();
                            if (settings[3]) {
                                SBF.ajax({ function: 'reports-update', name: settings[3], value: message.substr(0, 18) + ' | ' + user_ids_length });
                            }
                        }
                        infoBottom(user_ids_length == 1 ? 'The message has been sent.' : sb_('The message was sent to all users who have' + settings[2]));
                    }
                } else {
                    console.warn(response);
                }
            });
        }

        // User filters
        // $(users_area).on('click', '.sb-filter-btn > i', function () {
        $(users_area).on('click', '.sb-filter-btn > .toggle-filter', function () {
            $(this).parent().toggleClass('sb-active');
        });

        /*
        * ----------------------------------------------------------
        * Settings area
        * ----------------------------------------------------------
        */

        // Open settings area by URL
        if (SBF.getURL('setting')) {
            SBSettings.open(SBF.getURL('setting'), true);
        }

        // Settings history
        $(settings_area).on('click', ' > .sb-tab > .sb-nav [id]', function () {
            let id = $(this).attr('id').substr(4);
            if (SBF.getURL('setting') != id) {
                pushState('?setting=' + id);
            }
        });

        // Upload
        $(admin).on('click', '.sb-repeater-upload, [data-type="upload-image"] .image, [data-type="upload-file"] .sb-btn, #sb-chatbot-add-files, #sb-import-settings a, #sb-import-users a', function () {
            let extensions = '';
            upload_target = this;
            if ($(this).attr('id') == 'sb-chatbot-add-files') {
                extensions = '.pdf,.txt,.json,.csv';
                chatbot_files_table.find('.sb-pending').remove();
                SBApps.openAI.train.skip_files = [];
                upload_function = function () {
                    let files = upload_input.prop('files');
                    let code = '';
                    for (var i = 0; i < files.length; i++) {
                        let size = parseInt(files[i].size / 1000);
                        code += `<tr class="sb-pending" data-name="${files[i].name}"><td><input type="checkbox" /></td><td>${files[i].name}<label>${sb_('Pending')}</label></td><td>${size ? size : 1} KB</td><td><i class="sb-icon-delete"></i></td></tr>`;
                    }
                    chatbot_files_table.append(code);
                };
            } else if ($(this).parent().parent().attr('id') == 'sb-import-settings') {
                extensions = '.json';
                upload_on_success = (response) => {
                    if (loading(this)) return;
                    SBF.ajax({
                        function: 'import-settings',
                        file_url: response
                    }, (response) => {
                        if (response) {
                            infoBottom('Settings saved. Reload to apply the changes.');
                        } else {
                            infoPanel(response);
                        }
                        $(this).sbLoading(false);
                    });
                    upload_on_success = false;
                }
            } else if ($(this).parent().parent().attr('id') == 'sb-import-users') {
                extensions = '.csv';
                upload_on_success = (response) => {
                    if (loading(this)) return;
                    SBF.ajax({
                        function: 'import-users',
                        file_url: response
                    }, (response) => {
                        if (response) {
                            infoBottom('Users imported successfully.');
                        } else {
                            infoPanel(response);
                        }
                        $(this).sbLoading(false);
                    });
                    upload_on_success = false;
                }
            } else if ($(this).hasClass('image')) {
                extensions = '.png,.jpg,.jpeg,.gif,.webp';
            } else if ($(this).hasClass('sb-repeater-upload')) {
                upload_on_success = (response) => {
                    let parent = $(this).parent();
                    if (parent.find('.repeater-item:last-child input').val()) {
                        SBSettings.repeater.add(this);
                    }
                    parent.find('.repeater-item:last-child input').val(response);
                }
            }
            upload_input.attr('accept', extensions).prop('value', '').click();
        });

        $(settings_area).on('click', '[data-type="upload-image"] .image > i', function (e) {
            SBF.ajax({ function: 'delete-file', path: $(this).parent().attr('data-value') });
            $(this).parent().removeAttr('data-value').css('background-image', '');
            e.preventDefault();
            return false;
        });

        // Repeater
        $(admin).on('click', '.sb-repeater-add', function () {
            SBSettings.repeater.add(this);
        });

        $(admin).on('click', '.repeater-item > i', function () {
            setTimeout(() => {
                SBSettings.repeater.delete(this);
            }, 100);
        });

        // Color picker
        SBSettings.initColorPicker();

        $(settings_area).find('[data-type="color"]').focusout(function () {
            let color = $(this).find('input').val();
            if (color == 'rgb(255, 255, 255)' && ['color-admin-1', 'color-1'].includes($(this).attr('id'))) {
                color = '';
            }
            setTimeout(() => {
                $(this).find('input').val(color);
                $(this).find('.color-preview').css('background-color', color);
            }, 300);
            SBSettings.set($(this).attr('id'), [color, 'color']);
        });

        $(settings_area).on('click', '.sb-type-color .input i', function (e) {
            $(this).parent().find('input').removeAttr('style').val('');
        });

        // Color palette
        $(settings_area).on('click', '.sb-color-palette span', function () {
            let active = $(this).sbActive();
            $(this).closest('.sb-repeater').find('.sb-active').sbActive(false);
            $(this).sbActive(!active);
        });

        $(settings_area).on('click', '.sb-color-palette ul li', function () {
            $(this).parent().parent().attr('data-value', $(this).data('value')).find('span').sbActive(false);
        });

        // Select images
        $(settings_area).on('click', '[data-type="select-images"] .input > div', function () {
            $(this).siblings().sbActive(false);
            $(this).sbActive(true);
        });

        // Select checkbox
        $(settings_area).on('click', '.sb-select-checkbox-input', function () {
            $(this).toggleClass('sb-active');
        });

        $(settings_area).on('click', '.sb-select-checkbox input', function () {
            let parent = $(this).closest('[data-type]');
            parent.find('.sb-select-checkbox-input').val(SBSettings.get(parent)[1].join(', '));
        });

        // Save
        $(settings_area).on('click', '.sb-save-changes', function () {
            SBSettings.save(this);
        });

        // Miscellaneous
        $(settings_area).on('change', '#saved-replies [data-id="reply-name"], [data-id="rich-message-name"]', function () {
            $(this).val($(this).val().replace(/\s+/g, '-').replace(/-+/g, '-').replace(/^-+/, '').replace(/-+$/, '').replace(/ /g, ''));
        });

        $(settings_area).on('change', '#user-additional-fields [data-id="extra-field-name"]', function () {
            $(this).parent().next().find('input').val(SBF.stringToSlug($(this).val()));
        });

        $(settings_area).on('click', '#timetable-utc input', function () {
            if (!$(this).val()) {
                $(this).val(today.getTimezoneOffset() / 60);
            }
        });

        $(settings_area).on('click', '#dialogflow-sync-btn a', function (e) {
            let url = 'https://accounts.google.com/o/oauth2/auth?scope=https%3A%2F%2Fwww.googleapis.com/auth/dialogflow%20https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcloud-translation%20https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcloud-language&response_type=code&access_type=offline&redirect_uri=' + SB_URL + '/apps/dialogflow/functions.php&client_id={client_id}&prompt=consent';
            if (SB_ADMIN_SETTINGS.cloud && settings_area.find('#google-sync-mode select').val() == 'auto') {
                if (SB_ADMIN_SETTINGS.credits) {
                    window.open(url.replace('{client_id}', SB_ADMIN_SETTINGS.google_client_id));
                    e.preventDefault();
                    return false;
                }
            } else {
                let client_id = settings_area.find('#google-client-id input').val();
                if (client_id && settings_area.find('#google-client-secret input').val()) {
                    window.open(url.replace('{client_id}', client_id));
                } else {
                    infoPanel('Before continuing enter Client ID and Client secret. Check the docs for more details.');
                }
                e.preventDefault();
                return false;
            }
        });

        $(settings_area).on('click', '#dialogflow-redirect-url-btn a', function (e) {
            infoPanel(`<pre>${SB_URL}/apps/dialogflow/functions.php</pre>`);
            e.preventDefault();
            return false;
        });

        $(settings_area).on('click', '#dialogflow-saved-replies a', function (e) {
            infoPanel('', 'alert', () => {
                if (!loading(this)) {
                    SBF.ajax({ function: 'dialogflow-saved-replies' }, () => {
                        $(this).sbLoading(false);
                    });
                }
            });
            e.preventDefault();
            return false;
        });

        $(settings_area).on('click', '#test-email-user a, #test-email-agent a', function () {
            let email = $(this).parent().find('input').val();
            if (email && email.indexOf('@') > 0 && !loading(this)) {
                SBF.ajax({
                    function: 'send-test-email',
                    to: email,
                    email_type: $(this).parent().parent().attr('id') == 'test-email-user' ? 'user' : 'agent'
                }, (response) => {
                    infoPanel(response === true ? 'The message has been sent.' : response, 'info');
                    $(this).sbLoading(false);
                });
            }
        });

        $(settings_area).on('click', '#email-server-troubleshoot a', function (e) {
            settings_area.find('#test-email-user input').val(SB_ACTIVE_AGENT.email).next().click()[0].scrollIntoView({ behavior: 'smooth' });
            e.preventDefault();
            return false;
        });

        $(settings_area).on('click', '#test-sms-user a, #test-sms-agent a', function () {
            let phone_number = $(this).parent().find('input').val();
            if (phone_number && !loading(this)) {
                SBF.ajax({
                    function: 'send-sms',
                    message: 'Hello World!',
                    to: phone_number
                }, (response) => {
                    infoPanel(response && ['sent', 'queued'].includes(response.status) ? 'The message has been sent.' : `<pre>${JSON.stringify(response)}</pre>`);
                    $(this).sbLoading(false);
                });
            }
        });

        $(settings_area).on('click', '.sb-timetable > div > div > div', function () {
            let timetable = $(this).closest('.sb-timetable');
            let active = $(this).sbActive();
            $(timetable).find('.sb-active').sbActive(false);
            if (active) {
                $(this).sbActive(false).find('.sb-custom-select').remove();
            } else {
                let select = $(timetable).find('> .sb-custom-select').html();
                $(timetable).find(' > div .sb-custom-select').remove();
                $(this).append(`<div class="sb-custom-select">${select}</div>`).sbActive(true);
            }
        });

        $(settings_area).on('click', '.sb-timetable .sb-custom-select span', function () {
            let value = [$(this).html(), $(this).attr('data-value')];
            $(this).closest('.sb-timetable').find('> div > div > .sb-active').html(value[0]).attr('data-value', value[1]);
            $(this).parent().sbActive(false);
        });

        $(settings_area).on('click', '#system-requirements a', function (e) {
            let code = '';
            SBF.ajax({
                function: 'system-requirements'
            }, (response) => {
                for (var key in response) {
                    code += `<div class="sb-input"><span>${sb_(SBF.slugToString(key))}</span><div${response[key] ? ' class="sb-green"' : ''}>${response[key] ? sb_('Success') : sb_('Error')}</div></div>`;
                }
                loadingGlobal(false);
                SBAdmin.genericPanel('requirements', 'System requirements', code);
            });
            loadingGlobal();
            e.preventDefault();
            return false;
        });

        $(settings_area).on('click', '#sb-path a', function (e) {
            SBF.ajax({
                function: 'path'
            }, (response) => {
                infoPanel(`<pre>${response}</pre>`);
            });
            e.preventDefault();
            return false;
        });

        $(settings_area).on('click', '#sb-url a', function (e) {
            infoPanel(`<pre>${SB_URL}</pre>`);
            e.preventDefault();
            return false;
        });

        $(settings_area).on('click', '#delete-leads a', function (e) {
            if (!$(this).sbLoading()) {
                infoPanel('All leads, including all the linked conversations and messages, will be deleted permanently.', 'alert', () => {
                    $(this).sbLoading(true);
                    SBF.ajax({
                        function: 'delete-leads'
                    }, () => {
                        infoPanel('Leads and conversations successfully deleted.');
                        $(this).sbLoading(false);
                    });
                });
            }
            e.preventDefault();
            return false;
        });

        $(settings_area).on('click', '#sb-export-settings a', function (e) {
            e.preventDefault();
            if (loading(this)) return;
            SBF.ajax({
                function: 'export-settings'
            }, (response) => {
                dialogDeleteFile(response, 'sb-export-settings-close', 'Settings exported');
                $(this).sbLoading(false);
            });
            return false;
        });

        $(admin).on('click', '#sb-export-settings-close .sb-close, #sb-export-users-close .sb-close, #sb-export-report-close .sb-close', function () {
            SBF.ajax({ function: 'delete-file', path: admin.find('.sb-dialog-box p pre').html() });
        });

        if (!SB_ADMIN_SETTINGS.cloud) {
            $(settings_area).on('change', '#push-notifications-provider select', function () {
                let is_pusher = $(this).val() == 'pusher';
                SBSettings.visibility(0, is_pusher);
                SBF.ajax({ function: 'update-sw', url: is_pusher ? 'https://js.pusher.com/beams/service-worker.js' : 'https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.sw.js' });
            });

            $(settings_area).on('click', '#push-notifications-sw-path a', function (e) {
                let path = urlStrip(location.href.replace(location.host, '')).replace('admin.php', '');
                if (path.includes('?')) {
                    path = path.substring(0, path.indexOf('?'));
                }
                infoPanel('<pre>' + path + '</pre>');
                e.preventDefault();
                return false;
            });
        }

        $(settings_area).on('click', '#push-notifications-btn a', function (e) {
            if (SB_ADMIN_SETTINGS.cloud || settings_area.find('#push-notifications-provider select').val() == 'onesignal') {
                if (typeof OneSignal != ND) {
                    OneSignal.Slidedown.promptPush({ force: true });
                } else {
                    SBF.serviceWorker.initPushNotifications();
                }
            } else {
                Notification.requestPermission();
            }
            e.preventDefault();
            return false;
        });

        $(settings_area).on('input', '#sb-search-settings', function () {
            let search = $(this).val().toLowerCase();
            SBF.search(search, () => {
                let code = '';
                let dropdown = settings_area.find('.sb-search-dropdown-items');
                if (search.length > 2) {
                    let navs = settings_area.find('> .sb-tab > .sb-nav li').map(function () { return $(this).text().trim() }).get();

                    settings_area.find('.sb-setting').each(function () {
                        let keywords = $(this).attr('data-keywords');
                        let id = $(this).attr('id');
                        if ((keywords && keywords.includes(search)) || (id && id.replaceAll('-', '-').includes(search)) || $(this).find('.sb-setting-content').text().toLowerCase().includes(search)) {
                            const index = $(this).parent().parent().index();
                            const tab_id = $(this).parent().attr('id');
                            const $tab = $('.my-tab[data-target="' + tab_id + '"]');
                            const tab_title = $tab.contents()
                                .filter(function () {
                                    return this.nodeType === 3; // text node
                                })
                                .text()
                                .trim();

                            let search_text;

                            if (navs[index] === 'Artificial Intelligence') {
                                return true; // skip to the next iteration
                            }

                            if (tab_title) {
                                // if tab_title exists, insert it after first ">"
                                search_text = navs[index] + ' > ' + tab_title + ' > ' + $(this).find('h2').text();
                            } else {
                                // if no tab_title, keep original format
                                search_text = navs[index] + ' > ' + $(this).find('h2').text();
                            }
                            code += `<div data-tab-index="${index}" data-sub-tab-index="${tab_id}" data-setting="${$(this).attr('id')}">${search_text}</div>`;
                        }
                    });

                    console.log(search);
                    let accountSettings = {
                        'installation': 'account/?tab=installation',
                        'script': 'account/?tab=installation',
                        'membership': 'account/?tab=membership',
                        'plan': 'account/?tab=membership'
                    };
                    let SB_URL2 = SB_URL.replace(/\/script\/?$/, '/');
                    let match = Object.keys(accountSettings).find(key => key.includes(search));
                    if (match) {
                        let link = accountSettings[match];
                        code += `<div data-tab-index="0" data-sub-tab-index="0" link="${SB_URL2}${link}" data-setting="">Account > ${match.charAt(0).toUpperCase() + match.slice(1)}</div>`;
                    }
                }
                dropdown.html(code);
                if (dropdown.outerHeight() > $(window).height() - 100) {
                    dropdown.css('max-height', $(window).height() - 100);
                    dropdown.addClass('sb-scroll-area');
                } else {
                    dropdown.removeClass('sb-scroll-area');
                }
            });
        });

        $(settings_area).on('click', '.sb-search-dropdown-items div', function () {
            if ($(this).attr('link')) {
                // Opens URL in a new tab
                window.open($(this).attr('link'), "_blank");
                return;
            }
            let index = $(this).attr('data-tab-index');
            let tab_id = $(this).attr('data-sub-tab-index');
            let item = settings_area.find('> .sb-tab > .sb-nav li').eq(index);
            item.click();
            //item.get(0).scrollIntoView();
            $('.my-tab[data-target="' + tab_id + '"]').trigger('click');
            settings_area.find('#' + $(this).attr('data-setting'))[0].scrollIntoView();
            setTimeout(function () {
                const scrollArea = $('.sb-content.sb-scroll-area');
                const currentScroll = scrollArea.scrollTop();
                scrollArea.scrollTop(currentScroll - 75);
            }, 50);

        });

        // Slack  
        $(settings_area).on('click', '#slack-button a', () => {
            window.open('https://board.support/synch/?service=slack&plugin_url=' + SB_URL + cloudURL());
            return false;
        });

        $(settings_area).on('click', '#slack-test a', function (e) {
            if (loading(this)) return;
            SBF.ajax({
                function: 'send-slack-message',
                user_id: false,
                full_name: SB_ACTIVE_AGENT['full_name'],
                profile_image: SB_ACTIVE_AGENT['profile_image'],
                message: 'Lorem ipsum dolor sit amete consectetur adipiscing elite incidido labore et dolore magna aliqua.',
                attachments: [['Example link', SB_URL + '/media/user.svg'], ['Example link two', SB_URL + '/media/user.svg']],
                channel: settings_area.find('#slack-channel input').val()
            }, (response) => {
                if (SBF.errorValidation(response)) {
                    if (response[1] == 'slack-not-active') {
                        infoPanel('Please first activate Slack, then save the settings and reload the admin area.');
                    } else {
                        infoPanel('Error. Response: ' + JSON.stringify(response));
                    }
                } else {
                    infoPanel(response[0] == 'success' ? 'Slack message successfully sent. Check your Slack app!' : JSON.stringify(response));
                }
                $(this).sbLoading(false);
            });
            e.preventDefault();
            return false;
        });

        $(settings_area).on('click', '#tab-slack', function () {
            let input = settings_area.find('#slack-agents .input');
            input.html('<div class="sb-loading"></div>');
            SBF.ajax({
                function: 'slack-users'
            }, (response) => {
                let code = '';
                if (SBF.errorValidation(response, 'slack-token-not-found')) {
                    code = `<p>${sb_('Synchronize Slack and save changes before linking agents.')}</p>`;
                } else {
                    let select = '<option value="-1"></option>';
                    for (var i = 0; i < response.agents.length; i++) {
                        select += `<option value="${response.agents[i].id}">${response.agents[i].name}</option>`;
                    }
                    for (var i = 0; i < response.slack_users.length; i++) {
                        code += `<div data-id="${response.slack_users[i].id}"><label>${response.slack_users[i].name}</label><select>${select}</select></div>`;
                    }
                }
                input.html(code);
                SBSettings.set('slack-agents', [response.saved, 'double-select']);
            });
        });

        $(settings_area).on('click', '#slack-archive-channels a', function (e) {
            e.preventDefault();
            if (loading(this)) return;
            SBF.ajax({
                function: 'archive-slack-channels'
            }, (response) => {
                if (response === true) {
                    infoPanel('Slack channels archived successfully!');
                }
                $(this).sbLoading(false);
            });
        });

        $(settings_area).on('click', '#slack-channel-ids a', function (e) {
            e.preventDefault();
            if (loading(this)) return;
            SBF.ajax({
                function: 'slack-channels',
                code: true
            }, (response) => {
                infoPanel(response, 'info', false, '', '', true);
                $(this).sbLoading(false);
            });
        });


        // Messenger, WhatsApp, Text messages, Twitter, Telegram, Viber, Zalo
        $(settings_area).on('click', '#whatsapp-twilio-btn a, #whatsapp-twilio-get-configuartion-btn a, #sms-btn a, #wechat-btn a, #twitter-callback a, #viber-webhook a, #zalo-webhook a, [data-id="line-webhook"], #messenger-path-btn a', function (e) {
            let id = $(this).closest('[id]').attr('id');
            let extra = '';
            e.preventDefault();
            if (id == 'line') {
                extra = $(this).closest('.repeater-item').find('[data-id="line-secret"]').val();
                if (!extra) {
                    return;
                } else {
                    extra = '?line_secret=' + extra;
                }
            }
            infoPanel(`<pre>${SB_URL + (id == 'sms-btn' ? '/include/api.php' : ('/apps/' + (id.includes('-') ? id.substring(0, id.indexOf('-')) : id) + '/post.php')) + extra + cloudURL().replace('&', extra ? '&' : '?')}</pre>`);
            return false;
        });

        $(settings_area).on('click', '[data-id="telegram-numbers-button"], #viber-button a, #whatsapp-360-button a', function (e) {
            let calls = { 'telegram-button': ['#telegram-token input', 'telegram-synchronization', ['result', true]], 'viber-button': ['#viber-token input', 'viber-synchronization', ['status_message', 'ok']], 'whatsapp-360-button': ['#whatsapp-360-key input', 'whatsapp-360-synchronization', ['success', true]] };
            let id = $(this).parent().attr('id');
            let token;
            let is_additional_number = false;
            if (!id) {
                let buttons = { 'telegram-numbers-button': 'telegram-button' };
                let inputs = { 'telegram-button': 'telegram-numbers-token' };
                id = buttons[$(this).attr('data-id')];
                token = $(this).closest('.repeater-item').find(`[data-id="${inputs[id]}"]`).val().trim();
                is_additional_number = true;
            } else {
                token = settings_area.find(calls[id][0]).val().trim();
            }
            calls = calls[id];
            e.preventDefault();
            if (!token || loading(this)) return false;
            SBF.ajax({
                function: calls[1],
                token: token,
                cloud_token: cloudURL(),
                is_additional_number: is_additional_number
            }, (response) => {
                infoPanel(calls[2][0] in response && response[calls[2][0]] == calls[2][1] ? 'Synchronization completed.' : JSON.stringify(response));
                $(this).sbLoading(false);
            });
            return false;
        });

        $(settings_area).on('click', '#whatsapp-test-template a', function (e) {
            e.preventDefault();
            let phone = $(this).parent().find('input').val();
            if (!phone || loading(this)) return;
            SBF.ajax({
                function: 'whatsapp-send-template',
                to: phone
            }, (response) => {
                infoPanel(response ? ('error' in response ? (response.error.message ? response.error.message : response.error) : 'Message sent, check your WhatsApp!') : response);
                $(this).sbLoading(false);
            });
            return false;
        });

        $(settings_area).on('click', '#twitter-subscribe a', function (e) {
            e.preventDefault();
            if (loading(this)) return false;
            SBF.ajax({
                function: 'twitter-subscribe',
                cloud_token: cloudURL()
            }, (response) => {
                infoPanel(response === true ? 'Synchronization completed.' : JSON.stringify(response));
                $(this).sbLoading(false);
            });
            return false;
        });

        if (!SB_ADMIN_SETTINGS.cloud) {
            $(settings_area).on('click', '#messenger-sync-btn a', () => {
                window.open('https://board.support/synch/?service=messenger&plugin_url=' + SB_URL + cloudURL());
                return false;
            });
        }

        $(settings_area).on('change', '#messenger-sync-mode select', function () {
            SBSettings.visibility(1, $(this).val() != 'manual');
        });

        $(settings_area).on('click', '#messenger-unsubscribe a', function (e) {
            e.preventDefault();
            infoPanel('', 'alert', () => {
                if (loading(this)) return false;
                SBF.ajax({
                    function: 'messenger-unsubscribe'
                }, (response) => {
                    $(this).sbLoading(false);
                    if (response) {
                        infoPanel(JSON.stringify(response));
                    } else {
                        settings_area.find('#messenger-pages .repeater-item > i').click();
                        setTimeout(() => {
                            SBSettings.save();
                            infoPanel('Operation successful.');
                        }, 300);
                    }
                });
            });
            return false;
        });

        $(settings_area).on('change', '#open-ai-mode select', function () {
            SBSettings.visibility(2, $(this).val() != 'assistant');
        });

        // WordPress
        $(settings_area).on('click', '#wp-sync a', function (e) {
            e.preventDefault();
            if (loading(this)) return false;
            SBApps.wordpress.ajax('wp-sync', {}, (response) => {
                if (response === true || response === '1') {
                    SBUsers.update();
                    infoPanel('WordPress users successfully imported.');
                } else {
                    infoPanel('Error. Response: ' + JSON.stringify(response));
                }
                $(this).sbLoading(false);
            });
            return false;
        });

        $('body').on('click', '#wp-admin-bar-logout', function () {
            SBF.logout(false);
        });

        $(settings_area).on('click', '#whatsapp-clear-flows a', function (e) {
            e.preventDefault();
            SBF.ajax({
                function: 'whatsapp-clear-flows'
            });
        });

        // Translations
        $(settings_area).on('click', '#tab-translations', function () {
            let nav = settings_area.find('.sb-translations > .sb-nav > ul');
            if (!nav.html()) {
                let code = '';
                for (var key in SB_LANGUAGE_CODES) {
                    if (key == 'en') continue;
                    code += `<li data-code="${key}"><img src="${SB_URL}/media/flags/${key}.png" />${SB_LANGUAGE_CODES[key]}</li>`;
                }
                nav.html(code);
            }
        });

        $(settings_area).on('click', '.sb-translations .sb-nav li', function () {
            SBSettings.translations.load($(this).data('code'));
        });

        $(settings_area).on('click', '.sb-translations .sb-menu-wide li', function () {
            settings_area.find(`.sb-translations [data-area="${$(this).data('value')}"]`).sbActive(true).siblings().sbActive(false);
        });

        $(settings_area).on('click', '.sb-add-translation', function () {
            settings_area.find('.sb-translations-list > .sb-active').prepend(`<div class="sb-setting sb-type-text sb-new-translation"><input type="text" placeholder="${sb_('Enter original text...')}"><input type="text" placeholder="${sb_('Enter translation...')}"></div></div>`);
        });

        $(settings_area).on('input', '.sb-search-translation input', function () {
            let search = $(this).val().toLowerCase();
            SBF.search(search, () => {
                if (search.length > 1) {
                    settings_area.find('.sb-translations .sb-content > .sb-active label').each(function () {
                        let value = $(this).html().toLowerCase();
                        if (value.includes(search) && value != temp) {
                            let scroll_area = settings_area.find('.sb-scroll-area');
                            scroll_area[0].scrollTop = 0;
                            scroll_area[0].scrollTop = $(this).position().top - 80;
                            temp = value;
                            return false;
                        }
                    });
                }
            });
        });

        // Email piping manual sync
        $(settings_area).on('click', '[data-id="email-piping-sync"]', function (e) {
            if (loading(this)) return;
            SBF.ajax({
                function: 'email-piping',
                force: true
            }, (response) => {
                infoPanel(response === true ? 'Syncronization completed.' : response);
                $(this).sbLoading(false);
            });
            e.preventDefault();
        });

        // Automations
        $(settings_area).on('click', '#tab-automations', function () {
            SBSettings.automations.get(() => {
                SBSettings.automations.populate();
                loadingGlobal(false);
            }, true);
            loadingGlobal();
        });

        $(admin).on('click', '.sb-add-condition', function () {
            SBSettings.automations.addCondition($(this).prev());
        });

        $(admin).on('change', '.sb-condition-1 select', function () {
            SBSettings.automations.updateCondition(this);
        });

        $(admin).on('change', '.sb-condition-2 select', function () {
            $(this).parent().next().setClass('sb-hide', ['is-set', 'is-not-set'].includes($(this).val()));
        });

        $(automations_area_select).on('click', 'li', function () {
            SBSettings.automations.populate($(this).data('value'));
        });

        $(automations_area_nav).on('click', 'li', function () {
            SBSettings.automations.show($(this).attr('data-id'));
        });

        $(automations_area).on('click', '.sb-add-automation', function () {
            SBSettings.automations.add();
        });

        $(automations_area_nav).on('click', 'li i', function () {
            infoPanel(`The automation will be deleted permanently.`, 'alert', () => {
                SBSettings.automations.delete(this);
            });
        });

        // Conflicts alerts and warnings
        let warning_messages = ['Settings > {R} won\'t work if Settings > {R2} is active.'];
        $(settings_area).on('click', '.sb-setting', function (e) {
            let id = $(this).attr('id');
            if ($(this).hasClass('sb-type-multi-input')) {
                id = $(e.target).parent().attr('id');
            }
            switch (id) {
                case 'close-chat':
                case 'close-message':
                    if (settings_area.find('#close-active input').is(':checked') && settings_area.find('#close-chat input').is(':checked')) {
                        infoBottom(warning_messages[0].replace('{R}', 'Messages > Close message').replace('{R2}', 'Chat > Close chat'), 'info');
                    }
                    break;
                case 'chat-timetable':
                case 'follow-message':
                case 'queue':
                case 'routing':
                    if (((id == 'queue' && settings_area.find('#queue-active input').is(':checked')) || (id == 'routing' && settings_area.find('#routing input').is(':checked')) || (id == 'follow-message' && settings_area.find('#follow-active input').is(':checked')) || (id == 'chat-timetable' && settings_area.find('#chat-timetable-active input').is(':checked'))) && settings_area.find('#dialogflow-human-takeover-active input').is(':checked')) {
                        infoBottom('Since Settings > Artificial Intelligence > Human takeover is active, this option will only take effect during human takeover.', 'info');
                    }
                    break;
                case 'notify-agent-email':
                case 'push-notifications':
                case 'sms':
                    if (((id == 'sms' && settings_area.find('#sms-active-agents input').is(':checked')) || (id == 'push-notifications' && settings_area.find('#push-notifications-active input').is(':checked')) || (id == 'notify-agent-email' && settings_area.find('#notify-agent-email input').is(':checked'))) && settings_area.find('#dialogflow-human-takeover-active input').is(':checked')) {
                        infoBottom('Since Settings > Artificial Intelligence > Human takeover is active, notifications will be sent only after the human takeover.', 'info');
                    }
                    break;
                case 'privacy':
                    if (settings_area.find('#privacy-active input').is(':checked') && settings_area.find('#registration-required select').val()) {
                        infoBottom(warning_messages[0].replace('{R}', 'Messages > Privacy message').replace('{R2}', 'Users > Require registration'), 'info');
                    }
                    break;
                case 'google-multilingual-translation':
                    if ($(e.target).is(':checked') && settings_area.find('#open-ai-active input').is(':checked') && !settings_area.find('#open-ai-training-data-language select').val()) {
                        infoBottom('If your OpenAI training data isn\'t in English, set the default language under OpenAI > Training data language.', 'info');
                    }
                    break;
                case 'open-ai-prompt':
                    infoBottom('Custom prompts may break the chatbot, we advise leaving it empty.', 'info');
                    break;
                case 'open-ai-tokens':
                case 'open-ai-temperature':
                case 'open-ai-presence-penalty':
                case 'open-ai-frequency-penalty':
                case 'open-ai-logit-bias':
                case 'open-ai-custom-model':
                    infoBottom('This is an advanced setting, incorrect values may break the chatbot. If you\'re unsure, leave it empty.', 'info');
                    break;
                case 'open-ai-user-train-conversations':
                    if ($(e.target).is(':checked')) {
                        infoBottom('This method is not recommended. See the docs for details.', 'info');
                    }
                    break;
            }
        });

        $(users_table_menu).on('click', '[data-type="online"]', function () {
            if (!SB_ADMIN_SETTINGS.visitors_registration) {
                infoBottom('Settings > Users > Register all visitors must be enabled to see online users.', 'info');
            }
        });

        $(settings_area).on('click', '#dialogflow-active,#dialogflow-welcome,#dialogflow-departments', function (e) {// Depreceated
            infoBottom('Warning! We will stop supporting Dialogflow by the end of 2025. All its features will be available in Support Board through OpenAI. Please use OpenAI instead of Dialogflow.', 'info');
        });

        $(settings_area).on('change', '#registration-required select', function () {
            let value = $(this).val();
            if (['registration-login'].includes(value) && !settings_area.find('[id="reg-email"] input').is(':checked')) {
                infoBottom('The email field is required to activate the login form.', 'info');
            }
            if (value && settings_area.find('#privacy-active input').is(':checked')) {
                infoBottom(warning_messages[0].replace('{R}', 'Messages > Privacy message').replace('{R2}', 'Users > Require registration'), 'info');
            }
        });

        /*
        * ----------------------------------------------------------
        * Chatbot area
        * ----------------------------------------------------------
        */

        $(chatbot_area).on('click', '#sb-flow-add', function () {
            SBAdmin.genericPanel('flow-add', 'Enter the flow name', '<div class="sb-setting"><input type="text"></div>', ['Add new flow']);
        });

        $(admin).on('click', '#sb-add-new-flow', function () {
            SBApps.openAI.flows.set(admin.find('.sb-flow-add-box input').val().replace(/[^a-zA-Z\u00C0-\u1FFF\u2C00-\uD7FF\uAC00-\uD7A3]/g, ''));
            admin.sbHideLightbox();
        });

        $(flows_area).on('click', '.sb-flow-block', function () {
            flows_area.find('.sb-flow-block,.sb-flow-add-block').sbActive(false);
            $(this).sbActive(true);
            let block = SBApps.openAI.flows.blocks.get();
            let code;
            let code_2 = '';
            let type = $(this).attr('data-type');
            let code_repeater = `<div class="sb-title">{R}</div><div data-type="repeater" class="sb-setting sb-type-repeater"><div class="input"><div class="sb-repeater">{R2}</div><div class="sb-btn sb-btn-white sb-repeater-add sb-icon"><i class="sb-icon-plus"></i>${sb_('Add new item')}</div></div></div>`;
            let code_conditions = `<div class="sb-title">${sb_('Conditions')}</div><div class="sb-flow-conditions"></div><div class="sb-add-condition sb-btn sb-icon sb-btn-white"><i class="sb-icon-plus"></i>${sb_('Add condition')}</div>`;
            let code_message = `<div class="sb-title">${sb_('Message')}</div><div class="sb-setting"><textarea placeholder="${sb_('The message sent to the user...')}">${block.message}</textarea></div>`;
            let code_select_user_details = SBApps.openAI.getCode.select_user_details();
            switch (type) {
                case 'start':
                    code = `<div class="sb-title">${sb_('Start event')}</div><div class="sb-setting"><select class="sb-flow-start-select"><option value="message"${block.start == 'message' ? ' selected' : ''}>${sb_('User message')}</option><option value="conversation"${block.start == 'conversation' ? ' selected' : ''}>${sb_('New conversation started')}</option><option value="load"${block.start == 'load' ? ' selected' : ''}>${sb_('On page load')}</option></select></div><div class="sb-title sb-title-flow-start${block.start == 'message' ? `` : ` sb-hide`}">${sb_('User message')}</div><div data-type="repeater" class="sb-setting sb-flow-start-messages sb-type-repeater"><div class="input"><div class="sb-repeater"><div class="repeater-item"><div class="sb-setting"><textarea data-id="message"></textarea></div><i class="sb-icon-close"></i></div></div><div class="sb-btn sb-btn-white sb-repeater-add sb-icon"><i class="sb-icon-plus"></i>${sb_('Add message')}</div></div></div>${code_conditions}<div class="sb-title">${sb_('Disabled')}</div><div class="sb-setting"><input type="checkbox" id="sb-flow-disabled"${block.disabled ? ' checked' : ''}></div>`;
                    break;
                case 'button_list':
                    if (!block.options || !block.options.length) {
                        block.options = [''];
                    }
                    for (var i = 0; i < block.options.length; i++) {
                        code_2 += `<div class="repeater-item"><div><input data-id type="text" value="${block.options[i]}"></div><i class="sb-icon-close"></i></div>`;
                    }
                    code = code_message + code_repeater.replace(`{R}`, sb_('Buttons')).replace(`{R2}`, code_2);
                    break;
                case 'message':
                    if (!block.attachments || !block.attachments.length) {
                        block.attachments = [''];
                    }
                    for (var i = 0; i < block.attachments.length; i++) {
                        code_2 += `<div class="repeater-item"><div><input data-id type="text" value="${block.attachments[i]}" placeholder="${sb_('Enter a link...')}"></div><i class="sb-icon-close"></i></div>`;
                    }
                    code = code_message + code_repeater.replace(`{R}`, sb_('Attachments')).replace(`{R2}`, code_2).replace(`</div></div></div>`, `</div><i class="sb-repeater-upload sb-btn-icon sb-icon-clip"></i></div></div>`);
                    break;
                case 'video':
                    code = `${code_message}<div class="sb-title">${sb_('Video URL')}</div><div class="sb-setting"><input type="url" placeholder="${sb_('Enter a YouTube or Vimeo link...')}" value="${block.url}"></div>`;
                    break;
                case 'get_user_details':
                    if (!block.details || !block.details.length) {
                        block.details = [['', '', false]];
                    }
                    for (var i = 0; i < block.details.length; i++) {
                        code_2 += `<div class="repeater-item"><div>${code_select_user_details.replace(`"${block.details[i][0]}"`, `"${block.details[i][0]}" selected`)}<div class="sb-setting"><input type="text" placeholder="${sb_('Enter a description...')}" value="${block.details[i][1]}" /></div><div class="sb-setting"><label>${sb_('Required')}</label><input type="checkbox" ${block.details[i][2] ? ' checked' : ''}></div></div><i class="sb-icon-close"></i></div>`;
                    }
                    code = code_message + code_repeater.replace(`{R}`, sb_('User details')).replace(`{R2}`, code_2).replace('sb-type-repeater', 'sb-type-repeater sb-repeater-block-user-details');
                    break;
                case 'set_data':
                    code = SBApps.openAI.getCode.set_data(block.data);
                    break;
                case 'action':
                    code = SBApps.openAI.getCode.actions(block.actions);
                    break;
                case 'rest_api':
                    let keys = ['headers', 'save_response'];
                    code = `<div class="sb-title">${sb_('URL')}</div><div class="sb-setting"><input type="url" class="sb-rest-api-url" value="${block.url}"></div><div class="sb-title">${sb_('Method')}</div><div class="sb-setting"><select class="sb-rest-api-method"><option value="GET"${block.method == 'GET' ? ' selected' : ''}>GET</option><option value="POST"${block.method == 'POST' ? ' selected' : ''}>POST</option><option value="PUT"${block.method == 'PUT' ? ' selected' : ''}>PUT</option><option value="PATH"${block.method == 'PATH' ? ' selected' : ''}>PATH</option><option value="DELETE"${block.method == 'DELETE' ? ' selected' : ''}>DELETE</option></select></div><div class="sb-title">${sb_('Body')}</div><div class="sb-setting"><textarea placeholder="JSON">${block.body}</textarea></div>`;
                    for (var i = 0; i < keys.length; i++) {
                        let values = block[keys[i]];
                        if (!values || !values.length) {
                            values = [['', '']];
                        }
                        code += `<div class="sb-title">${sb_(SBF.slugToString(keys[i]))}</div><div data-type="repeater" class="sb-setting sb-type-repeater sb-repeater-block-rest-api sb-rest-api-${keys[i]}"><div class="input"><div class="sb-repeater">`;
                        for (var j = 0; j < values.length; j++) {
                            code += `<div class="repeater-item"><div>${i == 1 ? code_select_user_details.replace(`"${values[j][0]}"`, `"${values[j][0]}" selected`) : `<div class="sb-setting"><input type="text" placeholder="${sb_('Key')}" value="${values[j][0]}" /></div>`}<div class="sb-setting"><input type="text" placeholder="${sb_(i == 1 ? 'e.g. data.id' : 'Value')}" value="${values[j][1]}" /></div></div><i class="sb-icon-close"></i></div>`;
                        }
                        code += `</div><div class="sb-btn sb-btn-white sb-repeater-add sb-icon"><i class="sb-icon-plus"></i>${sb_('Add new item')}</div></div></div>`;
                    }
                    break;
                case 'condition':
                    code = code_conditions;
                    break;
            }
            code += `<div id="sb-block-delete" class="sb-btn-text"><i class="sb-icon-delete"></i>${sb_('Delete')}</div>`
            SBAdmin.genericPanel('flow-block', SBF.slugToString(type), code, ['Save changes'], '', true);
            if (type == 'start' || type == 'condition') {
                if (!Array.isArray(block.message)) block.message = [{ message: block.message }]; // Depreceated
                let repeater = admin.find('.sb-flow-start-messages .sb-repeater');
                let code = SBSettings.repeater.set(block.message, repeater.find('.repeater-item:last-child'));
                SBSettings.automations.setConditions(block.conditions, admin.find('.sb-flow-conditions'));
                if (code) {
                    repeater.html(code);
                }
            }
            step_scroll_positions = [];
            flows_area.find('> div').each(function () {
                step_scroll_positions.push($(this).find('> div')[0].scrollTop);
            });
        });

        $(admin).on('click', '.sb-flow-block-box #sb-save-changes', function () {
            let block = SBApps.openAI.flows.blocks.get();
            let box = admin.find('.sb-flow-block-box');
            block.message = box.find('textarea').val();
            switch (block.type) {
                case 'start':
                    block.message = SBSettings.repeater.get(box.find('.sb-flow-start-messages .repeater-item'));
                    block.start = box.find('select').val();
                    block.disabled = box.find('#sb-flow-disabled').is(':checked');
                    block.conditions = SBSettings.automations.getConditions(box.find('.sb-flow-conditions'));
                    if (block.message.length && block.message[0].message.trim().split(' ').length < 3) {
                        return box.find('.sb-info').sbActive(true).html(sb_('The message must contain at least 3 words.'));
                    }
                    break;
                case 'button_list':
                    block.options = box.find('.sb-repeater input').map(function () { return $(this).val().trim() }).get().filter(function (value) { return value != '' });
                    break;
                case 'message':
                    block.attachments = box.find('.sb-repeater input').map(function () { return $(this).val().trim() }).get().filter(function (value) { return value != '' });
                    break;
                case 'video':
                    block.url = box.find('input').val();
                    break;
                case 'get_user_details':
                    block.details = box.find('.repeater-item').map(function () { return [[$(this).find('select').val(), $(this).find('input[type=text]').val(), $(this).find('input[type=checkbox]').is(':checked')]] }).get();
                    break;
                case 'action':
                case 'set_data':
                    block[block.type == 'action' ? 'actions' : 'data'] = box.find('.repeater-item').map(function () { return [[$(this).find('select').val(), $(this).find('input').length ? $(this).find('input').val().replace(/https?:\/\/|["|:]/g, '') : '']] }).get();
                    break;
                case 'rest_api':
                    block.headers = box.find('.sb-rest-api-headers .repeater-item').map(function () { return [[$(this).find('input').eq(0).val(), $(this).find('input').eq(1).val()]] }).get();
                    block.save_response = box.find('.sb-rest-api-save_response .repeater-item').map(function () { return [[$(this).find('select').val(), $(this).find('input').val()]] }).get();
                    block.url = box.find('.sb-rest-api-url').val();
                    block.method = box.find('.sb-rest-api-method').val();
                    block.body = box.find('textarea').val();
                    delete block.message;
                    break;
                case 'condition':
                    block.conditions = SBSettings.automations.getConditions(box.find('.sb-flow-conditions'));
                    break;
            }
            SBApps.openAI.flows.blocks.set(block);
            flows_area.find('> div').each(function () {
                $(this).find('> div')[0].scrollTop = step_scroll_positions[$(this).index()];
            });
            admin.sbHideLightbox();
        });

        $(admin).on('change', '.sb-repeater-block-actions select', function () {
            $(this).parent().next().remove();
            $(this).parent().parent().append(SBApps.openAI.getCode.action($(this).val(), ''));
        });

        $(admin).on('change', '.sb-flow-start-select', function () {
            admin.find('.sb-title-flow-start, .sb-flow-start-messages').setClass('sb-hide', $(this).val() != 'message');
        });

        $(flows_area).on('mouseleave', '.sb-flow-connectors > div, .sb-flow-block', function () {
            flows_area.find('.sb-flow-block-cnt').sbActive(false);
            is_over_connector = false;
            if ($(this).parent().hasClass('sb-flow-connectors')) {
                SBApps.openAI.flows.blocks.activateLinkedCnts($(this).closest('.sb-flow-block'));
            } else {
                flows_area.find('.sb-flow-connectors > div').sbActive(false);
            }
        });

        $(flows_area).on('mouseenter', '.sb-flow-connectors > div', function () {
            let block_cnt = $(this).closest('.sb-flow-block').parent();
            let next_block_cnt_indexes = SBApps.openAI.flows.blocks.getNextCntIndexes(SBApps.openAI.flows.getActiveIndex(), block_cnt.parent().parent().index(), block_cnt.index());
            is_over_connector = true;
            flows_area.find('> div').eq(block_cnt.parent().parent().index() + 1).find('.sb-flow-block-cnt').sbActive(false).eq(next_block_cnt_indexes[$(this).index()]).sbActive(true);
        });

        $(flows_area).on('mouseenter', '.sb-flow-block', function () {
            SBApps.openAI.flows.blocks.activateLinkedCnts(this);
        });

        $(flows_area).on('click', '.sb-flow-add-block', function () {
            flows_area.find('.sb-flow-block,.sb-flow-add-block').sbActive(false);
            $(this).sbActive(true);
            let active_blocks = SBApps.openAI.flows.steps.get()[SBApps.openAI.flows.blocks.getActiveCntIndex()].map(item => item.type);
            let all = !active_blocks.some(element => ['message', 'button_list', 'video', 'get_user_details', 'condition'].includes(element));
            let nav_items = [['set_data', 'Set data'], ['action', 'Action'], ['condition', 'Condition'], ['rest_api', 'REST API']];
            let code = '';
            for (var i = 0; i < nav_items.length; i++) {
                if (!active_blocks.includes(nav_items[i][0])) {
                    code += `<li data-value="${nav_items[i][0]}">${sb_(nav_items[i][1])}</li>`;
                }
            }
            SBAdmin.genericPanel('flows-blocks-nav', '', `<ul class="sb-menu">${all ? `<li>${sb_('Messages')} <ul><li data-value="message">${sb_('Send message')}</li><li data-value="button_list">${sb_('Send button list')}</li><li data-value="video">${sb_('Send video')}</li></ul></li>` : ``}<li>${sb_('More')} <ul>${all ? `<li data-value="get_user_details">${sb_('Get user details')}</li>` : ``}${code}</ul></li></ul>`);
        });

        $(admin).on('click', '#sb-block-delete', function () {
            SBApps.openAI.flows.blocks.delete();
            admin.sbHideLightbox();
        });

        $(flows_nav).on('click', 'li', function () {
            SBApps.openAI.flows.show($(this).attr('data-value'));
        });

        $(flows_nav).on('click', 'li i', function (e) {
            infoPanel('The flow will be deleted.', 'alert', () => {
                SBApps.openAI.flows.delete($(this).parent().attr('data-value'));
            });
            e.preventDefault();
            return false;
        });

        $(admin).on('click', '.sb-flows-blocks-nav-box [data-value]', function () {
            SBApps.openAI.flows.blocks.add($(this).data('value'));
            admin.sbHideLightbox();
        });

        $(admin).on('mouseenter', '.sb-flow-scroll', function () {
            let is_back = $(this).hasClass('sb-icon-arrow-left');
            flow_scroll_interval = setInterval(() => {
                flows_area[0].scrollLeft += 10 * (is_back ? -1 : 1);
            }, 10);
        });

        $(admin).on('mouseleave', '.sb-flow-scroll', function () {
            clearInterval(flow_scroll_interval);
        });

        $(chatbot_area).on('click', '#sb-train-chatbot', function (e) {
            let success_text = 'The chatbot has been successfully trained.';
            let nav = chatbot_area.find('.sb-nav [data-value="conversations"]');
            infoPanel('<br><br><br><br><br>', 'info', false, 'sb-embeddings-box');
            e.preventDefault();
            if (SB_ADMIN_SETTINGS.cloud && SBCloud.creditsAlert(this, e)) {
                return false;
            }
            if (loading(this)) {
                return false;
            }
            if (chatbot_area.find('.sb-menu-chatbot .sb-active').attr('data-type') == 'flows') {
                SBApps.openAI.flows.save((response) => {
                    infoPanel(success_text, 'info', false, false, 'Success');
                });
                $(this).sbLoading(false);
                return;
            }
            if (nav.sbActive()) {
                let to_update = [];
                for (var i = 0; i < conversations_qea.length; i++) {
                    let qea = chatbot_area.find(`#sb-chatbot-conversations [data-index="${i}"]`);
                    if (qea.length) {
                        qea = [qea.find('input').val(), qea.find('textarea').val()];
                        if (qea[0] != $('<textarea />').html(conversations_qea[i].question).text() || qea[1] != $('<textarea />').html(conversations_qea[i].answer).text()) {
                            conversations_qea[i].question = qea[0];
                            conversations_qea[i].answer = qea[1];
                            to_update.push(conversations_qea[i]);
                        }
                    } else {
                        conversations_qea[i].question = false;
                        conversations_qea[i].answer = false;
                        to_update.push(conversations_qea[i]);
                    }
                }
                if (to_update.length) {
                    SBF.ajax({
                        function: 'open-ai-save-conversation-embeddings',
                        qea: to_update
                    }, (response) => {
                        if (response[0] === true) {
                            infoPanel(success_text, 'info', false, false, 'Success');
                        } else if (!SBApps.openAI.train.isError(response[0])) {
                            infoPanel(response[0]);
                        }
                        nav.click();
                        $(this).sbLoading(false);
                    });
                } else {
                    $(this).sbLoading(false);
                    infoPanel(success_text, 'info', false, false, 'Success');
                }
                return;
            }
            SBApps.openAI.train.errors = [];

            // Files
            let index = 0;
            SBApps.openAI.train.files((response) => {

                // Website
                SBApps.openAI.train.urls = chatbot_area.find('[data-id="open-ai-sources-url"]').map(function () { return $(this).val().trim() }).get();
                SBApps.openAI.train.extract_url = chatbot_area.find('[data-id="open-ai-sources-extract-url"]').map(function () { return $(this).is(':checked') }).get();
                SBApps.openAI.train.website((response) => {

                    // Q&A
                    SBApps.openAI.train.qea((response) => {

                        // Articles
                        SBApps.openAI.train.articles((response) => {

                            // Finish
                            SBApps.openAI.init();
                            chatbot_area.find('#sb-repeater-chatbot-website .repeater-item i').click();

                            if (SBApps.openAI.train.errors.length) {
                                infoPanel(sb_('The chatbot has been trained with errors. Check the console for more details.') + '\n\n<pre>' + SBApps.openAI.train.errors.join('<br>') + '</pre>', 'info', false, 'sb-errors-list-box', false, true);
                                console.error(SBApps.openAI.train.errors);
                            } else if (!SBApps.openAI.train.isError(response)) {
                                infoPanel(success_text, 'info', false, false, 'Success');
                            }
                            $(this).sbLoading(false);
                        });
                    });
                });
            });
            return false;
        });

        $(chatbot_area).on('click', '#sb-table-chatbot-files td i, #sb-table-chatbot-website td i, #sb-chatbot-delete-files, #sb-chatbot-delete-website, #sb-chatbot-delete-all-training, #sb-chatbot-delete-all-training-conversations', function () {
            let is_i = $(this).is('i');
            let tr = is_i ? $(this).closest('tr') : false;
            if (is_i && tr.hasClass('sb-pending')) {
                SBApps.openAI.train.skip_files.push(tr.attr('data-name'));
                tr.remove();
                return;
            }
            infoPanel('The training data will be permanently deleted.', 'alert', () => {
                let sources_to_delete = [];
                let id = $(this).attr('id');
                if (is_i) {
                    sources_to_delete = [tr.attr('data-url')];
                } else if (id == 'sb-chatbot-delete-all-training') {
                    sources_to_delete = 'all';
                } else if (id == 'sb-chatbot-delete-all-training-conversations') {
                    sources_to_delete = 'all-conversations';
                } else {
                    let table = $(id == 'sb-chatbot-delete-files' ? chatbot_files_table : chatbot_website_table);
                    if (!table.find('input:checked').length) {
                        table.find('input').prop('checked', true);
                    }
                    table.find('tr').each(function () {
                        if ($(this).find('input:checked').length) {
                            if ($(this).hasClass('sb-pending')) {
                                SBApps.openAI.train.skip_files.push($(this).attr('data-name'));
                                $(this).remove();
                            } else {
                                let url = $(this).attr('data-url');
                                sources_to_delete.push(url);
                                if (SBApps.openAI.train.sitemap_processed_urls.indexOf(url) > -1) {
                                    SBApps.openAI.train.sitemap_processed_urls[SBApps.openAI.train.sitemap_processed_urls.indexOf(url)] = false;
                                }
                            }
                        }
                    });
                }
                if (sources_to_delete.length) {
                    if (loading(this)) return;
                    SBF.ajax({
                        function: 'open-ai-embeddings-delete',
                        sources_to_delete: sources_to_delete
                    }, (response) => {
                        SBApps.openAI.init();
                        if (sources_to_delete == 'all') {
                            chatbot_area.find('.sb-nav [data-value="info"]').click();
                        } else if (sources_to_delete == 'all-conversations') {
                            chatbot_area.find('.sb-nav [data-value="conversations"]').click();
                        }
                        if (response === true) {
                            infoBottom('Training data deleted.');
                        } else {
                            infoPanel(response);
                        }
                        $(this).sbLoading(false);
                    });
                }
            });
            return false;
        });

        $(chatbot_area).on('click', '.sb-nav [data-value="conversations"]', function () {
            let area = chatbot_area.find('#sb-chatbot-conversations');
            if (loading(area)) return;
            SBF.ajax({
                function: 'open-ai-get-conversation-embeddings'
            }, (response) => {
                if (!response.length) {
                    area.html(`<p class="sb-no-results">${sb_('No conversations found.')}</p>`);
                } else {
                    let code = '';
                    conversations_qea = response;
                    for (var i = 0; i < response.length; i++) {
                        code += `<div class="repeater-item" data-value="${response[i].id}" data-index=${i}><div><label>${sb_('Question')}</label><input data-id="q" type="text" value="${response[i].question}" /></div><div class="sb-qea-repeater-answer"><label>${sb_('Answer')}</label><textarea data-id="a">${response[i].answer}</textarea></div><i class="sb-icon-close"></i></div>`;
                    }
                    area.find('.sb-repeater').html(code);
                }
                area.sbLoading(false);
            });
        });

        $(chatbot_area).on('click', '.sb-nav [data-value="info"]', function () {
            let area = chatbot_area.find('#sb-chatbot-info');
            if (loading(area)) return;
            SBF.ajax({
                function: 'open-ai-get-information'
            }, (response) => {
                let list = [['files', 'Files'], ['website', 'Website URLs'], ['qea', 'Q&A'], ['flows', 'Flows'], ['articles', 'Articles'], ['conversations', 'Conversations']];
                let code = `<h2>${sb_('Sources')}</h2><p>`;
                for (var i = 0; i < list.length; i++) {
                    code += response[list[i][0]] ? `${response[list[i][0]][1]} ${sb_(list[i][1])} (${response[list[i][0]][0]} ${sb_('chars')})<br>` : '';
                }
                code += `</p><h2>${sb_('Total detected characters')}</h2><p>${response.total} ${sb_('chars') + (response.limit ? ' / ' + response.limit + ' ' + sb_('limit') : '')}</p><hr><div id="sb-chatbot-delete-all-training" class="sb-btn sb-btn-white">${sb_('Delete all training data')}</div>`;
                area.html(code);
                area.sbLoading(false);
            });
        });

        $(chatbot_area).on('click', '.sb-menu-chatbot [data-type]', function (e) {
            let type = $(this).data('type');
            switch (type) {
                case 'flows':
                case 'training':
                case 'playground':
                    let area = chatbot_area.find(`> [data-id="${type}"]`);
                    chatbot_area.find('> [data-id]').sbActive(false)
                    area.sbActive(true);
                    if (type == 'flows' && area.sbLoading()) {
                        SBF.ajax({ function: 'open-ai-flows-get' }, (response) => {
                            for (var i = 0; i < response.length; i++) {
                                if (response[i] && response[i].steps && response[i].name) {
                                    SBApps.openAI.flows.flows.push(response[i]);
                                }
                            }
                            let code = '';
                            for (var i = 0; i < response.length; i++) {
                                if (response[i]) {
                                    code += SBApps.openAI.flows.navCode(response[i].name);
                                }
                            }
                            flows_nav.html(code);
                            flows_nav.find('li:first-child').click();
                            area.sbLoading(false);
                        });
                    }
                    break;
                case 'settings':
                    SBSettings.open('dialogflow', true);
                    e.preventDefault;
                    return false;
            }
        });

        $(chatbot_qea_repeater).on('click', '.sb-enlarger-function-calling', function () {
            $(this).parent().parent().find('.sb-qea-repeater-answer').addClass('sb-hide');
        });

        $(chatbot_qea_repeater).on('change', '[data-id="open-ai-faq-set-data"] select', function () {
            $(this).parent().next().find('input').setClass('sb-hide', ['transcript', 'transcript_email', 'human_takeover', 'archive_conversation'].includes($(this).val()));
        });

        $(chatbot_qea_repeater).on('input click', '[data-id="open-ai-faq-answer"]', function () {
            $(this).prev().find('i').sbActive($(this).val().length > 2 && $(this).val().indexOf(' '));
        });

        $(chatbot_qea_repeater).on('click', '.sb-qea-repeater-answer > label > i', function () {
            let textarea = $(this).closest('.repeater-item').find('[data-id="open-ai-faq-answer"]');
            if (loading(this)) return;
            SBApps.openAI.rewrite(textarea.val(), (response) => {
                $(this).sbLoading(false);
                if (response[0]) {
                    textarea.val(response[1]);
                }
            });
        });

        $(chatbot_playground_editor).on('click', '[data-value="add"], [data-value="send"]', function () {
            let textarea = chatbot_playground_editor.find('textarea');
            let message = textarea.val().trim();
            textarea.val('');
            if (message) {
                SBApps.openAI.playground.addMessage(message, chatbot_playground_editor.find('[data-value="user"], [data-value="assistant"]').attr('data-value'));
            }
            if ($(this).data('value') == 'send') {
                let length = SBApps.openAI.playground.messages.length;
                if (length && !loading(this)) {
                    SBF.ajax({
                        function: 'open-ai-playground-message',
                        messages: SBApps.openAI.playground.messages
                    }, (response) => {
                        if (response[0]) {
                            if (response[1]) {
                                SBApps.openAI.playground.addMessage(response[1], 'assistant', response[6]);
                                if (response[4]) {
                                    let code = '';
                                    for (var key in response[4].usage) {
                                        if (['string', 'number'].includes(typeof response[4].usage[key])) {
                                            code += `<b>${SBF.slugToString(key)}</b>: ${response[4].usage[key]}<br>`;
                                        }
                                    }
                                    SBApps.openAI.playground.last_response = response[4];
                                    chatbot_area.find('.sb-playground-info').html(code + `<div id="sb-playground-query" class="sb-btn-text">${sb_('View code')}</div>${response[4].embeddings ? `<div id="sb-playground-embeddings" class="sb-btn-text">${sb_('Embeddings')}</div>` : ``}`);
                                    if (response[4].payload) {
                                        SBApps.openAI.playground.messages[length - 1].push(response[4].payload);
                                    }
                                }
                            }
                            if (response[8]) {
                                conversations_admin_list_ul.find(`[data-conversation-id="${response[8]}"]`).remove();
                            }
                        } else {
                            infoPanel(response);
                            console.error(response);
                        }
                        $(this).sbLoading(false);
                    });
                }
            }
        });

        $(chatbot_area).on('click', '#sb-playground-query', function () {
            infoPanel('<pre>' + JSON.stringify(SBApps.openAI.playground.last_response.query, null, 4).replaceAll('\\"', '"') + '</pre>', 'info', false, 'sb-playground-query-panel', false, true);
        });

        $(chatbot_area).on('click', '#sb-playground-embeddings', function () {
            let code = '';
            let embeddings = SBApps.openAI.playground.last_response.embeddings;
            for (var i = embeddings.length - 1; i > -1; i--) {
                code += `<span><b>${sb_('Source')}</b>: ${embeddings[i].source ? embeddings[i].source.autoLink({ target: '_blank' }) : ''}<br><b>${sb_('Score')}</b>: ${embeddings[i].score}<br><span>${embeddings[i].text}</span></span>`;
            }
            infoPanel(code, 'info', false, 'sb-playground-embeddings-panel', false, true);
        });

        $(chatbot_playground_editor).on('click', '[data-value="clear"]', function () {
            SBApps.openAI.playground.messages = [];
            chatbot_playground_area.html('');
            chatbot_area.find('.sb-playground-info').html('');
        });

        $(chatbot_playground_area).on('click', '.sb-icon-close', function () {
            let element = $(this).closest('[data-type]');
            SBApps.openAI.playground.messages.splice(element.index(), 1);
            element.remove();
        });

        $(chatbot_playground_area).on('click', '.sb-rich-chips .sb-btn', function () {
            chatbot_playground_editor.find('textarea').val($(this).html());
            chatbot_playground_editor.find('[data-value="send"]').click();
        });

        $(chatbot_playground_editor).on('click', '[data-value="user"], [data-value="assistant"]', function () {
            let is_user = $(this).attr('data-value') == 'user';
            $(this).attr('data-value', is_user ? 'assistant' : 'user').html('<i class="sb-icon-reload"></i> ' + sb_(is_user ? 'Assistant' : 'User'));
        });

        $(admin).on('click', '#open-ai-troubleshoot a, #google-troubleshoot a', function (e) {
            let id = $(this).parent().attr('id');
            e.preventDefault();
            if (id != 'google-troubleshoot' && ![true, 'mode'].includes(SBApps.openAI.troubleshoot())) {
                return false;
            }
            if (loading(this)) return;
            SBF.ajax({
                function: $(this).parent().attr('id')
            }, (response) => {
                if (response === true) {
                    infoBottom('Success. No issues found.');
                } else {
                    infoPanel(response);
                }
                $(this).sbLoading(false);
                $(conversations_area).find('.sb-admin-list .sb-select li.sb-active').click();
            });
            return false;
        });

        /*
        * ----------------------------------------------------------
        * Articles area
        * ----------------------------------------------------------
        */

        $(articles_area).on('click', '.ce-settings__button--delete.ce-settings__button--confirm', function () {
            let url = articles_area.find('.image-tool--filled img').attr('src');
            if (url) {
                SBF.ajax({ function: 'delete-file', path: url });
            }
        });

        $(articles_area).on('click', '.ul-articles li', function (e) {
            infoPanel('The changes will be lost.', 'alert', () => {
                SBArticles.show($(this).attr('data-id'));
                articles_area.find('.sb-scroll-area:not(.sb-nav)').scrollTop(0);
            }, false, false, false, !articles_save_required, () => {
                $(this).parent().find('li').sbActive(false);
                $(this).parent().find(`[data-id="${SBArticles.activeID()}"]`).sbActive(true);
            });
        });

        $(articles_area).on('click', '.ul-categories li', function (e) {
            SBArticles.categories.show($(this).attr('data-id'));
        });

        $(articles_area).on('click', '.sb-add-article', function () {
            SBArticles.add();
        });

        $(articles_area).on('click', '.sb-add-category', function () {
            SBArticles.categories.add();
        });

        $(articles_area).on('click', '.sb-nav i', function (e) {
            let parent = $(this).parent();
            let nav = parent.closest('ul');
            let is_category = nav.hasClass('ul-categories');
            infoPanel(`The ${is_category ? 'category' : 'article'} will be deleted permanently.`, 'alert', () => {
                let id = parent.attr('data-id');
                if (is_category) {
                    SBArticles.categories.delete(id);
                } else {
                    articles_area.find('#editorjs .image-tool__image-picture').each(function () {
                        SBF.ajax({ function: 'delete-file', path: $(this).attr('src') });
                    });
                    if (!id) {
                        return parent.remove();
                    }
                    loading(articles_content);
                    SBArticles.delete(id, (response) => {
                        articles_content.sbLoading(false);
                        editorJSDestroy();
                        if (nav.find('li').length > 1) {
                            setTimeout(() => {
                                if (parent.prev().length) {
                                    parent.prev().click();
                                } else {
                                    parent.next().click();
                                }
                                parent.remove();
                            }, 300);
                        }
                    });
                }
            });
            e.preventDefault();
            return false;
        });

        $(articles_area).on('click', '.sb-menu-wide li', function () {
            let type = $(this).data('type');
            if (type == 'settings') {
                SBSettings.open('articles', true);
            } else if (type == 'reports') {
                SBReports.open('articles-searches');
            } else {
                articles_area.attr('data-type', type);
                SBArticles.categories.update();
            }
        });

        $(articles_area).on('click', '.sb-save-articles', function () {
            if (loading(this)) return;
            if (articles_area.attr('data-type') == 'categories') {
                SBArticles.categories.save((response) => {
                    $(this).sbLoading(false);
                });
            } else {
                SBArticles.save((response) => {
                    $(this).sbLoading(false);
                });
            }
        });

        $(articles_area).on('change input', 'input, textarea, select', function () {
            articles_save_required = true;
        });

        $(articles_category_select).on('change', function () {
            if (!articles_category_parent_select.val()) {
                infoBottom('Select a parent category first.', 'error');
                $(this).val('');
            }
        });

        /*
        * ----------------------------------------------------------
        * Reports area
        * ----------------------------------------------------------
        */

        $(reports_area).on('click', '.sb-nav [id]', function () {
            let id = $(this).attr('id');
            SBReports.active_report = false;
            reports_area.find('#sb-date-picker').val('');
            reports_area.attr('class', 'sb-area-reports sb-area-reports_new sb-active sb-report-' + id);
            SBReports.initReport($(this).attr('id'));
            if (SBF.getURL('report') != id) {
                pushState('?report=' + id);
            }
        });

        $(reports_area).on('change', '#sb-date-picker', function () {
            SBReports.initReport(false, $(this).val());
        });

        $(reports_area).on('click', '.sb-report-export', function () {
            if ($(this).sbLoading()) return;
            SBReports.export((response) => {
                $(this).sbLoading(false);
                if (response) {
                    dialogDeleteFile(response, 'sb-export-report-close', 'Report exported')
                }
            });
        });

        if (SBF.getURL('report')) {
            if (!reports_area.sbActive()) {
                header.find('.sb-admin-nav #sb-reports').click();
            }
            setTimeout(() => {
                reports_area.find('#' + SBF.getURL('report')).click()
            }, 500);
        }

        /*
        * ----------------------------------------------------------
        * Woocommerce
        * ----------------------------------------------------------
        */

        // Panel reload button
        $(conversations_area).on('click', '.sb-panel-woocommerce > i', function () {
            SBApps.woocommerce.conversationPanel();
        });

        // Get order details
        $(conversations_area).on('click', '.sb-woocommerce-orders > div > span', function (e) {
            let parent = $(this).parent();
            if (!$(e.target).is('span')) return;
            if (!parent.sbActive()) {
                SBApps.woocommerce.conversationPanelOrder(parent.attr('data-id'));
            }
        });

        // Products popup 
        $(conversations_area).on('click', '.sb-btn-woocommerce', function () {
            if (woocommerce_products_box_ul.sbLoading() || (activeUser() != false && activeUser().language != SBApps.itemsPanel.panel_language)) {
                SBApps.itemsPanel.populate('woocommerce');
            }
            woocommerce_products_box.find('.sb-search-btn').sbActive(true).find('input').get(0).focus();
            woocommerce_products_box.sbTogglePopup(this);
        });

        // Products popup pagination
        $(woocommerce_products_box).find('.sb-woocommerce-products-list').on('scroll', function () {
            if (scrollPagination(this, true)) {
                SBApps.itemsPanel.pagination(this, 'woocommerce');
            }
        });

        // Products popup filter
        $(woocommerce_products_box).on('click', '.sb-select li', function () {
            SBApps.itemsPanel.filter(this, 'woocommerce');
        });

        // Products popup search
        $(woocommerce_products_box).on('input', '.sb-search-btn input', function () {
            SBApps.itemsPanel.search(this, 'woocommerce');
        });

        $(woocommerce_products_box).on('click', '.sb-search-btn i', function () {
            SBF.searchClear(this, () => { SBApps.itemsPanel.search($(this).next(), 'woocommerce') });
        });

        // Cart popup insert product
        $(woocommerce_products_box).on('click', '.sb-woocommerce-products-list li', function () {
            let action = woocommerce_products_box.attr('data-action');
            let id = $(this).data('id');
            if (SBF.null(action)) {
                SBChat.insertText(`{product_card id="${id}"}`);
            } else {
                woocommerce_products_box_ul.sbLoading(true);
                conversations_area.find('.sb-add-cart-btn').sbLoading(true);
                SBChat.sendMessage(-1, '', [], (response) => {
                    if (response) {
                        SBApps.woocommerce.conversationPanelUpdate(id);
                        admin.sbHideLightbox();
                    }
                }, { 'event': 'woocommerce-update-cart', 'action': 'cart-add', 'id': id });
            }
            SBF.deactivateAll();
            admin.removeClass('sb-popup-active');
        });

        // Cart add product
        $(conversations_area).on('click', '.sb-panel-woocommerce .sb-add-cart-btn', function () {
            if ($(this).sbLoading()) return;
            if (SBChat.user_online) {
                SBApps.itemsPanel.populate('woocommerce');
                woocommerce_products_box.sbShowLightbox(true, 'cart-add');
            } else {
                infoPanel('The user is offline. Only the carts of online users can be updated.');
            }
        });

        // Cart remove product
        $(conversations_area).on('click', '.sb-panel-woocommerce .sb-list-items > a > i', function (e) {
            let id = $(this).parent().attr('data-id');
            SBChat.sendMessage(-1, '', [], () => {
                SBApps.woocommerce.conversationPanelUpdate(id, 'removed');
            }, { 'event': 'woocommerce-update-cart', 'action': 'cart-remove', 'id': id });
            $(this).sbLoading(true);
            e.preventDefault();
            return false;
        });

        /*
        * ----------------------------------------------------------
        * Apps functions
        * ----------------------------------------------------------
        */

        // Ump
        $(conversations_area).on('click', '.sb-panel-ump > i', function () {
            SBApps.ump.conversationPanel();
        });

        // ARMember
        $(conversations_area).on('click', '.sb-panel-armember > i', function () {
            SBApps.armember.conversationPanel();
        });

        // OpenCart
        $(conversations_area).on('click', '.sb-panel-opencart > i', function () {
            SBApps.opencart.conversationPanel();
        });

        $(conversations_area).on('click', '.sb-opencart-orders > a', function () {
            SBApps.opencart.openOrder($(this).attr('data-id'));
        });

        $(settings_area).on('click', '#opencart-sync a', function (e) {
            e.preventDefault();
            if (loading(this)) return;
            SBF.ajax({
                function: 'opencart-sync'
            }, (response) => {
                $(this).sbLoading(false);
                infoPanel(response === true ? 'Users successfully imported.' : response);
            });
        });

        // Perfex, whmcs, aecommerce
        $(settings_area).on('click', '#perfex-sync a, #whmcs-sync a, #perfex-articles-sync a, #whmcs-articles-sync a, #aecommerce-sync a, #aecommerce-sync-admins a, #aecommerce-sync-sellers a, #martfury-sync a, #martfury-sync-sellers a', function (e) {
            if (loading(this)) return;
            let function_name = $(this).closest('[id]').attr('id');
            let articles = function_name.indexOf('article') > 0;
            SBF.ajax({
                function: function_name
            }, (response) => {
                if (response === true) {
                    if (!articles) {
                        SBUsers.update();
                    }
                    infoPanel(articles ? 'Articles successfully imported.' : 'Users successfully imported.');
                } else {
                    infoPanel('Error. Response: ' + JSON.stringify(response));
                }
                $(this).sbLoading(false);
            });
            e.preventDefault();
        });

        // Zendesk
        $(conversations_area).on('click', '#sb-zendesk-btn', function (e) {
            if (loading(this)) return;
            SBF.ajax({
                function: 'zendesk-create-ticket',
                conversation_id: SBChat.conversation.id
            }, (response) => {
                if (response === true) {
                    SBApps.zendesk.conversationPanel();
                } else {
                    infoPanel('Error. Response: ' + JSON.stringify(response));
                }
                $(this).sbLoading(false);
            });
            e.preventDefault();
        });

        $(conversations_area).on('click', '#sb-zendesk-update-ticket', function (e) {
            if (loading(this)) return;
            SBF.ajax({
                function: 'zendesk-update-ticket',
                conversation_id: SBChat.conversation.id,
                zendesk_ticket_id: $(this).closest('[data-id]').attr('data-id')
            }, () => {
                $(this).sbLoading(false);
            });
            e.preventDefault();
            return false;
        });

        /*
        * ----------------------------------------------------------
        * Miscellaneous
        * ----------------------------------------------------------
        */

        $(admin).on('click', '.sb-enlarger', function () {
            $(this).sbActive(true);
        });

        $(admin).on('mouseenter', '[data-sb-tooltip-init]', function () {
            $(this).parent().sbInitTooltips();
            $(this).removeAttr('data-sb-tooltip-init');
            $(this).trigger('mouseenter');
        });

        // Language switcher
        $(admin).on('click', '.sb-language-switcher > i', function () {
            let switcher = $(this).parent();
            let active_languages = switcher.find('[data-language]').map(function () { return $(this).attr('data-language') }).get();
            let code = '';
            active_languages.push('en');
            for (var key in SB_LANGUAGE_CODES) {
                if (!active_languages.includes(key)) {
                    code += `<div data-language="${key}"><img src="${SB_URL}/media/flags/${key}.png" />${sb_(SB_LANGUAGE_CODES[key])}</div>`;
                }
            }
            language_switcher_target = switcher;
            SBAdmin.genericPanel('languages', 'Choose a language', code, [], ' data-source="' + switcher.attr('data-source') + '"', true);
        });

        $(admin).on('click', '.sb-language-switcher img', function () {
            let item = $(this).parent();
            let active = item.sbActive();
            let language = active ? false : item.attr('data-language');
            switch (item.parent().attr('data-source')) {
                case 'article-categories':
                    SBArticles.categories.show(SBArticles.categories.activeID(), language);
                    break;
                case 'articles':
                    let previous_active = articles_content.find('.sb-language-switcher .sb-active');
                    infoPanel('The changes will be lost.', 'alert', () => {
                        let id = item.attr('data-id');
                        if (!id && !active) {
                            // SBArticles.clear();
                        } else {
                            SBArticles.show(id && !active ? id : SBArticles.activeID(true));
                        }
                    }, false, false, false, !articles_save_required, () => {
                        item.sbActive(false);
                        previous_active.sbActive(true);
                    });
                    break;
                case 'automations':
                    SBSettings.automations.show(false, language);
                    break;
                case 'settings':
                    let active_language = item.parent().find('[data-language].sb-active');
                    SBSettings.translations.save(item, active ? item.attr('data-language') : (active_language.length ? active_language.attr('data-language') : false));
                    SBSettings.translations.activate(item, language);
                    break;
            }
            item.siblings().sbActive(false);
            item.sbActive(!active);
        });

        $(admin).on('click', '.sb-language-switcher span > i', function () {
            let item = $(this).parent();
            let language = item.attr('data-language');
            infoPanel(sb_('The {T} translation will be deleted.').replace('{T}', sb_(SB_LANGUAGE_CODES[language])), 'alert', () => {
                switch (item.parent().attr('data-source')) {
                    case 'article-categories':
                        SBArticles.categories.translations.delete(language);
                        break;
                    case 'articles':
                        SBArticles.translations.delete(language);
                        break;
                    case 'automations':
                        SBSettings.automations.deleteTranslation(false, language);
                        SBSettings.automations.show();
                        break;
                    case 'settings':
                        SBSettings.translations.delete(item, language);
                        break;
                }
                item.remove();
            });
        });

        $(admin).on('click', '.sb-languages-box [data-language]', function () {
            let box = $(this).parents().eq(1);
            let language = $(this).attr('data-language');
            let hide = true;
            switch (box.attr('data-source')) {
                case 'article-categories':
                    SBArticles.categories.translations.add(language);
                    break;
                case 'articles':
                    infoPanel('The changes will be lost.', 'alert', () => {
                        SBArticles.translations.add(language);
                        admin.sbHideLightbox();
                    }, false, false, false, !articles_save_required);
                    hide = false;
                    break;
                case 'automations':
                    SBSettings.automations.addTranslation(false, false, language);
                    SBSettings.automations.show(false, language);
                    break;
                case 'settings':
                    SBSettings.translations.add(language);
                    break;
            }
            if (hide) {
                admin.sbHideLightbox();
            }
        });

        // Lightbox
        $(admin).on('click', '.sb-lightbox .sb-top-bar .sb-close', function () {
            admin.sbHideLightbox();
        });

        $(admin).on('click', '.sb-lightbox .sb-info', function () {
            $(this).sbActive(false);
        });

        // Alert and information box
        $(admin).on('click', '.sb-dialog-box a', function () {
            let lightbox = $(this).closest('.sb-lightbox');
            if ($(this).hasClass('sb-confirm')) {
                alertOnConfirmation();
            }
            if ($(this).hasClass('sb-cancel') && alertOnCancel) {
                alertOnCancel();
            }
            if (admin.find('.sb-lightbox.sb-active').length == 1) {
                overlay.sbActive(false);
            }
            SBAdmin.open_popup = false;
            lightbox.sbActive(false);
        });

        $(admin).on('click', '#add-conversation-to-ticket a', function () {
            let lightbox = $(this).closest('.sb-lightbox');
            if ($(this).hasClass('sb-confirm')) {
                alertOnConfirmation();
            }
            if ($(this).attr('id') == 'link-to-existing-ticket') {
                $('#ticket-action-selector').hide();
                $('#ticket-selector').show();

                $('#selected_ticket_id').select2({
                    placeholder: 'Type and search...',
                    minimumInputLength: 0,
                    ajax: {
                        transport: function (params, success, failure) {
                            const term = (params.data.q || '').toLowerCase();
                            const loginCookie = SBF.loginCookie();

                            $.ajax({
                                url: SB_URL + '/include/ajax.php',
                                method: 'POST',
                                dataType: 'json',
                                data: {
                                    function: 'ajax_calls',
                                    'calls[0][function]': 'search-get-tickets',
                                    'login-cookie': loginCookie,
                                    'q': term,
                                    'type': 'all'
                                },
                                success: function (response) {
                                    if (response[0][0] === 'success') {
                                        const tickets = response[0][1];
                                        let results;

                                        // if (!term) {
                                        //     // Show latest 5 users
                                        //     results = latestFiveCustomers.slice(-5).reverse().map(user => ({
                                        //         id: user.id,
                                        //         text: user.first_name + ' ' + user.last_name,
                                        //         email: user.email,
                                        //         name: user.first_name + ' ' + user.last_name
                                        //     }));
                                        // } else {
                                        const term = (params.data.q || '').toLowerCase();

                                        // normalize term same as PHP (remove leading t/T if followed by digits)
                                        const normalizedTerm = term.replace(/^[tT](\d+)/, '$1');

                                        results = tickets
                                            .filter(ticket =>
                                                ticket.id.toLowerCase().includes(normalizedTerm) ||
                                                (ticket.subject && ticket.subject.toLowerCase().includes(normalizedTerm))
                                            )
                                            .map(ticket => ({
                                                id: ticket.id,
                                                text: 'T' + ticket.id + ': ' + ticket.subject
                                            }));

                                        // if (results.length === 0) {
                                        //     results.push({
                                        //         id: '__add__' + term,
                                        //         text: 'â Add "' + term + '" as New Customer',
                                        //         name: term,
                                        //         email: '',
                                        //         isAddNew: true
                                        //     });
                                        // }
                                        //}

                                        success({ results });
                                    } else {
                                        failure();
                                    }
                                },
                                error: failure
                            });
                        },
                        cache: true
                    },
                    templateResult: function (data) {
                        if (data.loading) return data.text;
                        if (data.isAddNew) {
                            return $('<div style="color: #fff;"><strong>' + data.text + '</strong></div>');
                        }
                        return $('<div><strong>' + data.text + '</strong><br/><small>' + (data.email || '') + '</small></div>');
                    },
                    templateSelection: function (data) {
                        return data.text;
                    }
                });

            }
            else {
                if (admin.find('.sb-lightbox.sb-active').length == 1) {
                    overlay.sbActive(false);
                }
                SBAdmin.open_popup = false;
                lightbox.sbActive(false);
            }
        });

        $(admin).on('click', '#link-ticket', function () {
            const ticket_id = $('#selected_ticket_id').val();
            const conversation_id = $('#selected_conversation_id').val();

            SBF.ajax({
                function: 'link-conversation-to-ticket',
                ticket_id: ticket_id,
                conversation_id: conversation_id
            }, (response) => {
                if (response.success) {
                    infoBottom(response.msg);
                }
                else {
                    infoBottom(response.msg, 'error')
                }

                setTimeout(function () {
                    window.location.reload();
                }, 1200);
            });
        });
        $(admin).on('click', '.sb-menu-wide li, .sb-nav li', function () {
            $(this).siblings().sbActive(false);
            $(this).sbActive(true);
        });

        $(admin).on('click', '.sb-nav:not(.sb-nav-only) li:not(.sb-tab-nav-title)', function () {
            let area = $(this).closest('.sb-tab');
            let tab = $(area).find(' > .sb-content > div').sbActive(false).eq($(this).parent().find('li:not(.sb-tab-nav-title)').index(this));
            tab.sbActive(true);
            tab.find('textarea').each(function () {
                $(this).autoExpandTextarea();
                $(this).manualExpandTextarea();
            });
            area.find('.sb-scroll-area:not(.sb-nav)').scrollTop(0);
        });

        $(admin).sbInitTooltips();

        $(admin).on('click', '[data-button="toggle"]', function () {
            let show = admin.find('.' + $(this).data('show'));
            let hide = admin.find('.' + $(this).data('hide'));
            show.addClass('sb-show-animation').show();
            hide.hide();
            SBAdmin.open_popup = show.hasClass('sb-lightbox') || show.hasClass('sb-popup') ? show : false;
        });

        $(admin).on('click', '.sb-info-card', function () {
            $(this).sbActive(false);
        });

        $(upload_input).on('change', function () {
            if (upload_function) {
                upload_function();
                upload_function = false;
            } else {
                $(upload_target).sbLoading($(this).prop('files').length);
                $(this).sbUploadFiles((response) => {
                    $(upload_target).sbLoading(false);
                    response = JSON.parse(response);
                    if (response[0] == 'success') {
                        let type = $(upload_target).closest('[data-type]').data('type');
                        if (type == 'upload-image') {
                            if ($(upload_target).attr('data-value')) {
                                SBF.ajax({ function: 'delete-file', path: $(upload_target).attr('data-value') });
                            }
                            $(upload_target).attr('data-value', response[1]).css('background-image', `url("${response[1]}")`);
                        }
                        if (upload_on_success) {
                            upload_on_success(response[1]);
                        }
                    } else {
                    }
                });
            }
        });

        $(admin).on('click', '.sb-accordion > div > span', function (e) {
            let parent = $(this).parent();
            let active = $(parent).sbActive();
            if (!$(e.target).is('span')) return;
            parent.siblings().sbActive(false);
            parent.sbActive(!active);
        });

        $(admin).on('mousedown', function (e) {

            if ($(SBAdmin.open_popup).length) {
                let popup = $(SBAdmin.open_popup);
                let target = $(e.target);

                // Add safe classes for Choices.js
                const safeClasses = [
                    'sb-btn-saved-replies',
                    'sb-btn-emoji',
                    'sb-btn-woocommerce',
                    'sb-btn-shopify',
                    'sb-btn-open-ai',
                    'choices', // container
                    'choices__inner',
                    'choices__list',
                    'choices__item',
                    'choices__input',
                    'choices__button',
                    'is-highlighted',
                    'choice-remove'
                ];

                const targetClassList = target.attr('class') || '';
                const isSafe = safeClasses.some(safe => targetClassList.includes(safe)) || target.closest('.choices').length;

                //if (!popup.is(e.target) && popup.has(e.target).length === 0 && !['sb-btn-saved-replies', 'sb-btn-emoji', 'sb-btn-woocommerce', 'sb-btn-shopify', 'sb-btn-open-ai'].includes($(e.target).attr('class'))) {
                if (!popup.is(e.target) && popup.has(e.target).length === 0 && !isSafe) {
                    if (popup.hasClass('sb-popup')) {
                        popup.sbTogglePopup();
                    } else if (popup.hasClass('sb-select')) {
                        popup.find('ul').sbActive(false);
                    } else if (popup.hasClass('sb-menu-mobile')) {
                        popup.find('i').sbActive(false);
                    } else if (popup.hasClass('sb-menu')) {
                        popup.sbActive(false);
                    } else if (!SBAdmin.open_popup || !['sb-embeddings-box'].includes(SBAdmin.open_popup.attr('id'))) {
                        admin.sbHideLightbox();
                    }
                    SBAdmin.open_popup = false;
                }
            }
        });
    });

    function initialization() {
    let SB_URL_NEW = SB_URL.replace(/\/script\/?$/, '/');
        const hasSearchParams = window.location.search.length > 1;
        // const isHome = window.location.pathname === '/' || window.location.href === SB_URL_NEW;
        const isHome = window.location.href === SB_URL_NEW;
        if (isHome && !hasSearchParams) {
            header.find('.sb-admin-nav #sb-dashboard').click();
        }

        if (SBF.getURL('ticket')) {
            let ticketId = SBF.getURL('ticket');
            header.find('.sb-admin-nav #sb-tickets').click();
            SBTicket.openTicketArea(ticketId);

            SBF.ajax({
            function: 'get-conversations'
            }, (response) => {
                console.log('get-conversations');
                if (!response.length) {
                    conversations_area.find('.sb-board').addClass('sb-no-conversation');
                }
                SBConversations.populateList(response);
            });
            return;
        }

        SBF.ajax({
            function: 'get-conversations'
        }, (response) => {
            console.log('get-conversations');
            if (!response.length) {
                conversations_area.find('.sb-board').addClass('sb-no-conversation');
            }
            SBConversations.populateList(response);
            if (responsive) {
                conversations_area.find('.sb-admin-list').sbActive(true);
            }
            if (SBF.getURL('conversation')) {
                if (!conversations_area.sbActive()) {
                    header.find('.sb-admin-nav #sb-conversations').click();
                }
                SBConversations.openConversation(SBF.getURL('conversation'));
            } else if (!responsive && !SBF.getURL('user') && !SBF.getURL('setting') && !SBF.getURL('report') && (!SBF.getURL('area') || SBF.getURL('area') == 'conversations')) {
                setTimeout(() => {
                    console.log('click first conversation');
                    SBConversations.clickFirst();
                }, 100);
            }
            SBConversations.startRealTime();
            SBConversations.datetime_last_conversation = SB_ADMIN_SETTINGS.now_db;
            loadingGlobal(false);
        });

        SBF.serviceWorker.init();
        if (SB_ADMIN_SETTINGS.push_notifications) {
            SBF.serviceWorker.initPushNotifications();
        }
        setInterval(function () {
            SBF.ajax({
                function: 'get-active-user',
                db: true
            }, (response) => {
                if (!response) SBF.reset();
            });
        }, 3600000);
    }
}(jQuery));

// tinyColorPicker v1.1.1 2016-08-30 

!function (a, b) { "object" == typeof exports ? module.exports = b(a) : "function" == typeof define && define.amd ? define("colors", [], function () { return b(a) }) : a.Colors = b(a) }(this, function (a, b) { "use strict"; function c(a, c, d, f, g) { if ("string" == typeof c) { var c = v.txt2color(c); d = c.type, p[d] = c[d], g = g !== b ? g : c.alpha } else if (c) for (var h in c) a[d][h] = k(c[h] / l[d][h][1], 0, 1); return g !== b && (a.alpha = k(+g, 0, 1)), e(d, f ? a : b) } function d(a, b, c) { var d = o.options.grey, e = {}; return e.RGB = { r: a.r, g: a.g, b: a.b }, e.rgb = { r: b.r, g: b.g, b: b.b }, e.alpha = c, e.equivalentGrey = n(d.r * a.r + d.g * a.g + d.b * a.b), e.rgbaMixBlack = i(b, { r: 0, g: 0, b: 0 }, c, 1), e.rgbaMixWhite = i(b, { r: 1, g: 1, b: 1 }, c, 1), e.rgbaMixBlack.luminance = h(e.rgbaMixBlack, !0), e.rgbaMixWhite.luminance = h(e.rgbaMixWhite, !0), o.options.customBG && (e.rgbaMixCustom = i(b, o.options.customBG, c, 1), e.rgbaMixCustom.luminance = h(e.rgbaMixCustom, !0), o.options.customBG.luminance = h(o.options.customBG, !0)), e } function e(a, b) { var c, e, k, q = b || p, r = v, s = o.options, t = l, u = q.RND, w = "", x = "", y = { hsl: "hsv", rgb: a }, z = u.rgb; if ("alpha" !== a) { for (var A in t) if (!t[A][A]) { a !== A && (x = y[A] || "rgb", q[A] = r[x + "2" + A](q[x])), u[A] || (u[A] = {}), c = q[A]; for (w in c) u[A][w] = n(c[w] * t[A][w][1]) } z = u.rgb, q.HEX = r.RGB2HEX(z), q.equivalentGrey = s.grey.r * q.rgb.r + s.grey.g * q.rgb.g + s.grey.b * q.rgb.b, q.webSave = e = f(z, 51), q.webSmart = k = f(z, 17), q.saveColor = z.r === e.r && z.g === e.g && z.b === e.b ? "web save" : z.r === k.r && z.g === k.g && z.b === k.b ? "web smart" : "", q.hueRGB = v.hue2RGB(q.hsv.h), b && (q.background = d(z, q.rgb, q.alpha)) } var B, C, D, E = q.rgb, F = q.alpha, G = "luminance", H = q.background; return B = i(E, { r: 0, g: 0, b: 0 }, F, 1), B[G] = h(B, !0), q.rgbaMixBlack = B, C = i(E, { r: 1, g: 1, b: 1 }, F, 1), C[G] = h(C, !0), q.rgbaMixWhite = C, s.customBG && (D = i(E, H.rgbaMixCustom, F, 1), D[G] = h(D, !0), D.WCAG2Ratio = j(D[G], H.rgbaMixCustom[G]), q.rgbaMixBGMixCustom = D, D.luminanceDelta = m.abs(D[G] - H.rgbaMixCustom[G]), D.hueDelta = g(H.rgbaMixCustom, D, !0)), q.RGBLuminance = h(z), q.HUELuminance = h(q.hueRGB), s.convertCallback && s.convertCallback(q, a), q } function f(a, b) { var c = {}, d = 0, e = b / 2; for (var f in a) d = a[f] % b, c[f] = a[f] + (d > e ? b - d : -d); return c } function g(a, b, c) { return (m.max(a.r - b.r, b.r - a.r) + m.max(a.g - b.g, b.g - a.g) + m.max(a.b - b.b, b.b - a.b)) * (c ? 255 : 1) / 765 } function h(a, b) { for (var c = b ? 1 : 255, d = [a.r / c, a.g / c, a.b / c], e = o.options.luminance, f = d.length; f--;)d[f] = d[f] <= .03928 ? d[f] / 12.92 : m.pow((d[f] + .055) / 1.055, 2.4); return e.r * d[0] + e.g * d[1] + e.b * d[2] } function i(a, c, d, e) { var f = {}, g = d !== b ? d : 1, h = e !== b ? e : 1, i = g + h * (1 - g); for (var j in a) f[j] = (a[j] * g + c[j] * h * (1 - g)) / i; return f.a = i, f } function j(a, b) { var c = 1; return c = a >= b ? (a + .05) / (b + .05) : (b + .05) / (a + .05), n(100 * c) / 100 } function k(a, b, c) { return a > c ? c : b > a ? b : a } var l = { rgb: { r: [0, 255], g: [0, 255], b: [0, 255] }, hsv: { h: [0, 360], s: [0, 100], v: [0, 100] }, hsl: { h: [0, 360], s: [0, 100], l: [0, 100] }, alpha: { alpha: [0, 1] }, HEX: { HEX: [0, 16777215] } }, m = a.Math, n = m.round, o = {}, p = {}, q = { r: .298954, g: .586434, b: .114612 }, r = { r: .2126, g: .7152, b: .0722 }, s = function (a) { this.colors = { RND: {} }, this.options = { color: "rgba(0,0,0,0)", grey: q, luminance: r, valueRanges: l }, t(this, a || {}) }, t = function (a, d) { var e, f = a.options; u(a); for (var g in d) d[g] !== b && (f[g] = d[g]); e = f.customBG, f.customBG = "string" == typeof e ? v.txt2color(e).rgb : e, p = c(a.colors, f.color, b, !0) }, u = function (a) { o !== a && (o = a, p = a.colors) }; s.prototype.setColor = function (a, d, f) { return u(this), a ? c(this.colors, a, d, b, f) : (f !== b && (this.colors.alpha = k(f, 0, 1)), e(d)) }, s.prototype.setCustomBackground = function (a) { return u(this), this.options.customBG = "string" == typeof a ? v.txt2color(a).rgb : a, c(this.colors, b, "rgb") }, s.prototype.saveAsBackground = function () { return u(this), c(this.colors, b, "rgb", !0) }, s.prototype.toString = function (a, b) { return v.color2text((a || "rgb").toLowerCase(), this.colors, b) }; var v = { txt2color: function (a) { var b = {}, c = a.replace(/(?:#|\)|%)/g, "").split("("), d = (c[1] || "").split(/,\s*/), e = c[1] ? c[0].substr(0, 3) : "rgb", f = ""; if (b.type = e, b[e] = {}, c[1]) for (var g = 3; g--;)f = e[g] || e.charAt(g), b[e][f] = +d[g] / l[e][f][1]; else b.rgb = v.HEX2rgb(c[0]); return b.alpha = d[3] ? +d[3] : 1, b }, color2text: function (a, b, c) { var d = c !== !1 && n(100 * b.alpha) / 100, e = "number" == typeof d && c !== !1 && (c || 1 !== d), f = b.RND.rgb, g = b.RND.hsl, h = "hex" === a && e, i = "hex" === a && !h, j = "rgb" === a || h, k = j ? f.r + ", " + f.g + ", " + f.b : i ? "#" + b.HEX : g.h + ", " + g.s + "%, " + g.l + "%"; return i ? k : (h ? "rgb" : a) + (e ? "a" : "") + "(" + k + (e ? ", " + d : "") + ")" }, RGB2HEX: function (a) { return ((a.r < 16 ? "0" : "") + a.r.toString(16) + (a.g < 16 ? "0" : "") + a.g.toString(16) + (a.b < 16 ? "0" : "") + a.b.toString(16)).toUpperCase() }, HEX2rgb: function (a) { return a = a.split(""), { r: +("0x" + a[0] + a[a[3] ? 1 : 0]) / 255, g: +("0x" + a[a[3] ? 2 : 1] + (a[3] || a[1])) / 255, b: +("0x" + (a[4] || a[2]) + (a[5] || a[2])) / 255 } }, hue2RGB: function (a) { var b = 6 * a, c = ~~b % 6, d = 6 === b ? 0 : b - c; return { r: n(255 * [1, 1 - d, 0, 0, d, 1][c]), g: n(255 * [d, 1, 1, 1 - d, 0, 0][c]), b: n(255 * [0, 0, d, 1, 1, 1 - d][c]) } }, rgb2hsv: function (a) { var b, c, d, e = a.r, f = a.g, g = a.b, h = 0; return g > f && (f = g + (g = f, 0), h = -1), c = g, f > e && (e = f + (f = e, 0), h = -2 / 6 - h, c = m.min(f, g)), b = e - c, d = e ? b / e : 0, { h: 1e-15 > d ? p && p.hsl && p.hsl.h || 0 : b ? m.abs(h + (f - g) / (6 * b)) : 0, s: e ? b / e : p && p.hsv && p.hsv.s || 0, v: e } }, hsv2rgb: function (a) { var b = 6 * a.h, c = a.s, d = a.v, e = ~~b, f = b - e, g = d * (1 - c), h = d * (1 - f * c), i = d * (1 - (1 - f) * c), j = e % 6; return { r: [d, h, g, g, i, d][j], g: [i, d, d, h, g, g][j], b: [g, g, i, d, d, h][j] } }, hsv2hsl: function (a) { var b = (2 - a.s) * a.v, c = a.s * a.v; return c = a.s ? 1 > b ? b ? c / b : 0 : c / (2 - b) : 0, { h: a.h, s: a.v || c ? c : p && p.hsl && p.hsl.s || 0, l: b / 2 } }, rgb2hsl: function (a, b) { var c = v.rgb2hsv(a); return v.hsv2hsl(b ? c : p.hsv = c) }, hsl2rgb: function (a) { var b = 6 * a.h, c = a.s, d = a.l, e = .5 > d ? d * (1 + c) : d + c - c * d, f = d + d - e, g = e ? (e - f) / e : 0, h = ~~b, i = b - h, j = e * g * i, k = f + j, l = e - j, m = h % 6; return { r: [e, l, f, f, k, e][m], g: [k, e, e, l, f, f][m], b: [f, f, k, e, e, l][m] } } }; return s }), function (a, b) { "object" == typeof exports ? module.exports = b(a, require("jquery"), require("colors")) : "function" == typeof define && define.amd ? define(["jquery", "colors"], function (c, d) { return b(a, c, d) }) : b(a, a.jQuery, a.Colors) }(this, function (a, b, c, d) { "use strict"; function e(a) { return a.value || a.getAttribute("value") || b(a).css("background-color") || "#FFF" } function f(a) { return a = a.originalEvent && a.originalEvent.touches ? a.originalEvent.touches[0] : a, a.originalEvent ? a.originalEvent : a } function g(a) { return b(a.find(r.doRender)[0] || a[0]) } function h(c) { var d = b(this), f = d.offset(), h = b(a), k = r.gap; c ? (s = g(d), s._colorMode = s.data("colorMode"), p.$trigger = d, (t || i()).css(r.positionCallback.call(p, d) || { left: (t._left = f.left) - ((t._left += t._width - (h.scrollLeft() + h.width())) + k > 0 ? t._left + k : 0), top: (t._top = f.top + d.outerHeight()) - ((t._top += t._height - (h.scrollTop() + h.height())) + k > 0 ? t._top + k : 0) }).show(r.animationSpeed, function () { c !== !0 && (y.toggle(!!r.opacity)._width = y.width(), v._width = v.width(), v._height = v.height(), u._height = u.height(), q.setColor(e(s[0])), n(!0)) }).off(".tcp").on(D, ".cp-xy-slider,.cp-z-slider,.cp-alpha", j)) : p.$trigger && b(t).hide(r.animationSpeed, function () { n(!1), p.$trigger = null }).off(".tcp") } function i() { return b("head")[r.cssPrepend ? "prepend" : "append"]('<style type="text/css" id="tinyColorPickerStyles">' + (r.css || I) + (r.cssAddon || "") + "</style>"), b(H).css({ margin: r.margin }).appendTo("body").show(0, function () { p.$UI = t = b(this), F = r.GPU && t.css("perspective") !== d, u = b(".cp-z-slider", this), v = b(".cp-xy-slider", this), w = b(".cp-xy-cursor", this), x = b(".cp-z-cursor", this), y = b(".cp-alpha", this), z = b(".cp-alpha-cursor", this), r.buildCallback.call(p, t), t.prepend("<div>").children().eq(0).css("width", t.children().eq(0).width()), t._width = this.offsetWidth, t._height = this.offsetHeight }).hide() } function j(a) { var c = this.className.replace(/cp-(.*?)(?:\s*|$)/, "$1").replace("-", "_"); (a.button || a.which) > 1 || (a.preventDefault && a.preventDefault(), a.returnValue = !1, s._offset = b(this).offset(), (c = "xy_slider" === c ? k : "z_slider" === c ? l : m)(a), n(), A.on(E, function () { A.off(".tcp") }).on(C, function (a) { c(a), n() })) } function k(a) { var b = f(a), c = b.pageX - s._offset.left, d = b.pageY - s._offset.top; q.setColor({ s: c / v._width * 100, v: 100 - d / v._height * 100 }, "hsv") } function l(a) { var b = f(a).pageY - s._offset.top; q.setColor({ h: 360 - b / u._height * 360 }, "hsv") } function m(a) { var b = f(a).pageX - s._offset.left, c = b / y._width; q.setColor({}, "rgb", c) } function n(a) { var b = q.colors, c = b.hueRGB, e = (b.RND.rgb, b.RND.hsl, r.dark), f = r.light, g = q.toString(s._colorMode, r.forceAlpha), h = b.HUELuminance > .22 ? e : f, i = b.rgbaMixBlack.luminance > .22 ? e : f, j = (1 - b.hsv.h) * u._height, k = b.hsv.s * v._width, l = (1 - b.hsv.v) * v._height, m = b.alpha * y._width, n = F ? "translate3d" : "", p = s[0].value, t = s[0].hasAttribute("value") && "" === p && a !== d; v._css = { backgroundColor: "rgb(" + c.r + "," + c.g + "," + c.b + ")" }, w._css = { transform: n + "(" + k + "px, " + l + "px, 0)", left: F ? "" : k, top: F ? "" : l, borderColor: b.RGBLuminance > .22 ? e : f }, x._css = { transform: n + "(0, " + j + "px, 0)", top: F ? "" : j, borderColor: "transparent " + h }, y._css = { backgroundColor: "#" + b.HEX }, z._css = { transform: n + "(" + m + "px, 0, 0)", left: F ? "" : m, borderColor: i + " transparent" }, s._css = { backgroundColor: t ? "" : g, color: t ? "" : b.rgbaMixBGMixCustom.luminance > .22 ? e : f }, s.text = t ? "" : p !== g ? g : "", a !== d ? o(a) : G(o) } function o(a) { v.css(v._css), w.css(w._css), x.css(x._css), y.css(y._css), z.css(z._css), r.doRender && s.css(s._css), s.text && s.val(s.text), r.renderCallback.call(p, s, "boolean" == typeof a ? a : d) } var p, q, r, s, t, u, v, w, x, y, z, A = b(document), B = b(), C = "touchmove.tcp mousemove.tcp pointermove.tcp", D = "touchstart.tcp mousedown.tcp pointerdown.tcp", E = "touchend.tcp mouseup.tcp pointerup.tcp", F = !1, G = a.requestAnimationFrame || a.webkitRequestAnimationFrame || function (a) { a() }, H = '<div class="cp-color-picker"><div class="cp-z-slider"><div class="cp-z-cursor"></div></div><div class="cp-xy-slider"><div class="cp-white"></div><div class="cp-xy-cursor"></div></div><div class="cp-alpha"><div class="cp-alpha-cursor"></div></div></div>', I = ".cp-color-picker{position:absolute;overflow:hidden;padding:6px 6px 0;background-color:#444;color:#bbb;font-family:Arial,Helvetica,sans-serif;font-size:12px;font-weight:400;cursor:default;border-radius:5px}.cp-color-picker>div{position:relative;overflow:hidden}.cp-xy-slider{float:left;height:128px;width:128px;margin-bottom:6px;background:linear-gradient(to right,#FFF,rgba(255,255,255,0))}.cp-white{height:100%;width:100%;background:linear-gradient(rgba(0,0,0,0),#000)}.cp-xy-cursor{position:absolute;top:0;width:10px;height:10px;margin:-5px;border:1px solid #fff;border-radius:100%;box-sizing:border-box}.cp-z-slider{float:right;margin-left:6px;height:128px;width:20px;background:linear-gradient(red 0,#f0f 17%,#00f 33%,#0ff 50%,#0f0 67%,#ff0 83%,red 100%)}.cp-z-cursor{position:absolute;margin-top:-4px;width:100%;border:4px solid #fff;border-color:transparent #fff;box-sizing:border-box}.cp-alpha{clear:both;width:100%;height:16px;margin:6px 0;background:linear-gradient(to right,#444,rgba(0,0,0,0))}.cp-alpha-cursor{position:absolute;margin-left:-4px;height:100%;border:4px solid #fff;border-color:#fff transparent;box-sizing:border-box}", J = function (a) { q = this.color = new c(a), r = q.options, p = this }; J.prototype = { render: n, toggle: h }, b.fn.colorPicker = function (c) { var d = this, f = function () { }; return c = b.extend({ animationSpeed: 150, GPU: !0, doRender: !0, customBG: "#FFF", opacity: !0, renderCallback: f, buildCallback: f, positionCallback: f, body: document.body, scrollResize: !0, gap: 4, dark: "#222", light: "#DDD" }, c), !p && c.scrollResize && b(a).on("resize.tcp scroll.tcp", function () { p.$trigger && p.toggle.call(p.$trigger[0], !0) }), B = B.add(this), this.colorPicker = p || new J(c), this.options = c, b(c.body).off(".tcp").on(D, function (a) { -1 === B.add(t).add(b(t).find(a.target)).index(a.target) && h() }), this.on("focusin.tcp click.tcp", function (a) { p.color.options = b.extend(p.color.options, r = d.options), h.call(this, a) }).on("change.tcp", function () { q.setColor(this.value || "#FFF"), d.colorPicker.render(!0) }).each(function () { var a = e(this), d = a.split("("), f = g(b(this)); f.data("colorMode", d[1] ? d[0].substr(0, 3) : "HEX").attr("readonly", r.preventFocus), c.doRender && f.css({ "background-color": a, color: function () { return q.setColor(a).rgbaMixBGMixCustom.luminance > .22 ? c.dark : c.light } }) }) }, b.fn.colorPicker.destroy = function () { b("*").off(".tcp"), p.toggle(!1), B = b() } });
=======
"use strict";!function(e){function t(e,t=!1){return dt.infoBottom(e,t)}function i(e,t="info",i=!1,s="",a="",n=!1,o=!1,r=!1){return dt.infoPanel(e,t,i,s,a,n,o,r)}function s(e){return dt.activeUser(e)}function a(e){return dt.loading(e)}function n(e=!0,t=!0){return dt.loadingGlobal(e,t)}function o(e){return SB_TRANSLATIONS&&e in SB_TRANSLATIONS?SB_TRANSLATIONS[e]:e}function r(){typeof caches!==Ke&&caches.delete("sb-pwa-cache")}function l(e,t){dt.collapse(e,t)}function c(t,i){let s=e(t).parent().find("i"),a=e(t).val();SBF.search(a,()=>{s.sbLoading(!0),i(a,s)})}function d(t,i=!1,s=0){if(i)return e(t).scrollTop()+e(t).innerHeight()>=e(t)[0].scrollHeight-1;e(t).scrollTop(e(t)[0].scrollHeight-s)}function u(t=!1){if(!it){if(!1===tt)return tt=!0,void e.getScript(SB_URL+"/vendor/editorjs.js",()=>{u(t)});p(),it=!0,tt=new EditorJS({data:h(t)?{time:Date.now(),blocks:[t?{id:"sb",type:"raw",data:{html:t}}:{id:"sb",type:"paragraph",data:{text:""}}]}:t,i18n:{messages:{ui:{blockTunes:{toggler:{"Click to tune":o("Click to tune")}},inlineToolbar:{converter:{"Convert to":o("Convert to")}},toolbar:{toolbox:{Add:o("Add")}}},toolNames:{Text:o("Text"),Heading:o("Heading"),List:o("List"),Image:o("Image"),Code:o("Code"),"Raw HTML":o("Raw HTML"),Bold:o("Bold"),Italic:o("Italic"),Link:o("Link")},tools:{list:{Ordered:o("Ordered"),Unordered:o("Unordered")}},blockTunes:{delete:{Delete:o("Delete")},moveUp:{"Move up":o("Move up")},moveDown:{"Move down":o("Move down")}}},direction:k.hasClass("sb-rtl")?"rtl":"ltr"},tools:{list:{class:List,inlineToolbar:!0},image:{class:ImageTool,config:{uploader:{uploadByFile(t){let i=new FormData;return i.append("file",t),new Promise(t=>{e.ajax({url:SB_URL+"/include/upload.php",cache:!1,contentType:!1,processData:!1,data:i,type:"POST",success:function(e){"success"==(e=JSON.parse(e))[0]?t({success:1,file:{url:e[1]}}):console.log(e)}})})}}}},header:Header,code:CodeTool,raw:RawTool},onReady:()=>{it=!1,qe=!0,Pe=!1},onChange:()=>{qe?qe=!1:Pe=!0},minHeight:50})}}function p(){typeof tt.destroy!==Ke&&(tt.destroy(),tt=!1)}function h(e){return"string"==typeof e}function f(e){et||window.history.pushState("","",e)}function g(){return SB_ADMIN_SETTINGS.cloud?"&cloud="+SB_ADMIN_SETTINGS.cloud.token:""}function b(e){return e.replace("https://","").replace("http://","").replace("www.","").replace(/\/$/,"")}function v(e){SBF.search(e,()=>{let t="",i=!(e.length>1),s=Fe.find(".sb-replies-list > ul"),a=`<li class="sb-no-results">${o("No results found.")}</li>`;for(var n=0;n<Ne.length;n++){let s=Ne[n]["reply-name"];(i||s.toLowerCase().includes(e)||s.replaceAll("-"," ").toLowerCase().includes(e)||Ne[n]["reply-text"].toLowerCase().includes(e))&&(t+=`<li><div>${s}</div><div>${Ne[n]["reply-text"]}</div></li>`)}if(s.html(t),i||!SB_ADMIN_SETTINGS.dialogflow&&!SB_ADMIN_SETTINGS.chatbot_features)t||s.html(a);else{let i=s.closest(".sb-popup").find(".sb-icon-search");i.sbLoading(!0),SB_ADMIN_SETTINGS.dialogflow?st.dialogflow.getIntents(n=>{let o=st.dialogflow.searchIntents(e,!0),r="";for(var l=0;l<o.length;l++){let e=o[l].messages[0].text;e&&e.text&&(r+=`<li><div>${o[l].displayName}</div><div>${o[l].messages[0].text.text[0]}</div></li>`)}s.html(r?t+r:t||a),i.sbLoading(!1)}):SBF.ajax({function:"open-ai-message",model:SB_ADMIN_SETTINGS.open_ai_model,message:e},e=>{s.html(!e[1]||e[5]&&e[5].unknow_answer?t||a:`${t}<li><div></div><div>${e[1]}</div></li>`),i.sbLoading(!1)})}})}function m(e){let i=k.find("#sb-whatsapp-send-template-box");n(),SBF.ajax({function:"whatsapp-get-templates"},s=>{let a='<option value=""></option>',o=s[0],r="twilio"==o;if((s=s[1]).error)return t(s.error.message,"error");if(!Array.isArray(s))return t(s,"error");for(var l=0;l<s.length;l++)"official"!=o||"APPROVED"!=s[l].status||SB_ACTIVE_AGENT.department&&s[l].department.length&&!s[l].department.includes(SB_ACTIVE_AGENT.department)||(a+=`<option value="${s[l].name}" data-languages="${s[l].languages}" data-phone-id="${s[l].phone_number_id}">${s[l].name} (${s[l].label})</option>`),r&&(a+=`<option value="${s[l].sid}">${s[l].friendly_name}</option>`);i.attr("data-provider",o),i.find("#sb-whatsapp-send-template-list").html(a),SBForm.clear(i),i.find(".sb-direct-message-users").val(e.length?e.join(","):"all"),i.find(".sb-bottom > div").html(""),i.find(".sb-loading").sbLoading(!1),n(!1),i.sbShowLightbox()})}function _(e,t,s){window.open(e),i(`${o("For security reasons, delete the file after downloading it. Close this window to automatically delete it. File location:")}<pre>${e}</pre>`,"info",!1,t,s)}function S(){xe=!1,Be=!1,setTimeout(()=>{ke&&(ke[1].css("transform",""),ke[1].removeClass("sb-touchmove"))},100)}function w(e){return C.find(`[data-conversation-id="${e}"]`)}function y(){SBF.ajax({function:"get-conversations"},e=>{e.length||A.find(".sb-board").addClass("sb-no-conversation"),lt.populateList(e),We&&A.find(".sb-admin-list").sbActive(!0),SBF.getURL("conversation")?(A.sbActive()||x.find(".sb-admin-nav #sb-conversations").click(),lt.openConversation(SBF.getURL("conversation"))):We||SBF.getURL("user")||SBF.getURL("setting")||SBF.getURL("report")||SBF.getURL("area")&&"conversations"!=SBF.getURL("area")||setTimeout(()=>{lt.clickFirst()},100),lt.startRealTime(),lt.datetime_last_conversation=SB_ADMIN_SETTINGS.now_db,n(!1)}),SBF.serviceWorker.init(),SB_ADMIN_SETTINGS.push_notifications&&SBF.serviceWorker.initPushNotifications(),setInterval(function(){SBF.ajax({function:"get-active-user",db:!0},e=>{e||SBF.reset()})},36e5)}var k,x,B,A,T,I,$,C,F,N,E,L,D,M,R,j,G,U,P,q,O,V,H,W,z,J,Y,X,Q,Z,K,ee,te,ie,se,ae,ne,oe,re,le,ce,de,ue,pe,he,fe,ge,be,ve,me,_e,Se,we,ye,ke,xe,Be,Ae,Te,Ie,$e,Ce=[],Fe=!1,Ne=!1,Ee=!1,Le=!1,De=1,Me=1,Re={},je=1,Ge=1,Ue=!0,Pe=!1,qe=!0,Oe=!1,Ve=[],He=[],We=e(window).width()<465,ze={last:0,header:!0,always_hidden:!1},Je="localhost"===location.hostname||"127.0.0.1"===location.hostname,Ye=new Date,Xe=!1,Qe=!0,Ze=!1,Ke="undefined",et=!1,tt=!1,it=!1;e.fn.miniTip=function(t){var i=e.extend({title:"",content:!1,delay:300,anchor:"n",event:"hover",fadeIn:200,fadeOut:200,aHide:!0,maxW:"250px",offset:5,stemOff:0,doHide:!1},t);k&&0==k.find("#miniTip").length&&k.append('<div id="miniTip" class="sb-tooltip"><div></div></div>');var s=k.find("#miniTip"),a=s.find("div");return i.doHide?(s.stop(!0,!0).fadeOut(i.fadeOut),!1):this.each(function(){var t=e(this),n=i.content?i.content:t.attr("title");if(""!=n&&void 0!==n){window.delay=!1;var o=!1,r=!0;i.content||t.removeAttr("title"),"hover"==i.event?(t.hover(function(){s.removeAttr("click"),r=!0,l.call(this)},function(){r=!1,c()}),i.aHide||s.hover(function(){o=!0},function(){o=!1,setTimeout(function(){!r&&!s.attr("click")&&c()},20)})):"click"==i.event&&(i.aHide=!0,t.click(function(){return s.attr("click","t"),s.data("last_target")!==t?l.call(this):"none"==s.css("display")?l.call(this):c(),s.data("last_target",t),e("html").unbind("click").click(function(t){"block"==s.css("display")&&!e(t.target).closest("#miniTip").length&&(e("html").unbind("click"),c())}),!1}));var l=function(){i.show&&i.show.call(this,i),i.content&&""!=i.content&&(n=i.content),a.html(n),i.render&&i.render(s),s.hide().width("").width(s.width()).css("max-width",i.maxW);var o=t.is("area");if(o){var r,l=[],c=[],d=t.attr("coords").split(",");function u(e,t){return e-t}for(r=0;r<d.length;r++)l.push(d[r++]),c.push(d[r]);var p=t.parent().attr("name"),h=e("img[usemap=\\#"+p+"]").offset(),f=parseInt(h.left,10)+parseInt((parseInt(l.sort(u)[0],10)+parseInt(l.sort(u)[l.length-1],10))/2,10),g=parseInt(h.top,10)+parseInt((parseInt(c.sort(u)[0],10)+parseInt(c.sort(u)[c.length-1],10))/2,10)}else g=parseInt(t.offset().top,10),f=parseInt(t.offset().left,10);var b=o?0:parseInt(t.outerWidth(),10),v=o?0:parseInt(t.outerHeight(),10),m=s.outerWidth(),_=s.outerHeight(),S=Math.round(f+Math.round((b-m)/2)),w=Math.round(g+v+i.offset+8),y=Math.round(m-16)/2-parseInt(s.css("borderLeftWidth"),10),k=0,x=f+b+m+i.offset+8>parseInt(e(window).width(),10),B=m+i.offset+8>f,A=_+i.offset+8>g-e(window).scrollTop(),T=g+v+_+i.offset+8>parseInt(e(window).height()+e(window).scrollTop(),10),I=i.anchor;B||"e"==i.anchor&&!x?"w"!=i.anchor&&"e"!=i.anchor||(I="e",k=Math.round(_/2-8-parseInt(s.css("borderRightWidth"),10)),y=-8-parseInt(s.css("borderRightWidth"),10),S=f+b+i.offset+8,w=Math.round(g+v/2-_/2)):(x||"w"==i.anchor&&!B)&&("w"!=i.anchor&&"e"!=i.anchor||(I="w",k=Math.round(_/2-8-parseInt(s.css("borderLeftWidth"),10)),y=m-parseInt(s.css("borderLeftWidth"),10),S=f-m-i.offset-8,w=Math.round(g+v/2-_/2))),T||"n"==i.anchor&&!A?"n"!=i.anchor&&"s"!=i.anchor||(I="n",k=_-parseInt(s.css("borderTopWidth"),10),w=g-(_+i.offset+8)):(A||"s"==i.anchor&&!T)&&("n"!=i.anchor&&"s"!=i.anchor||(I="s",k=-8-parseInt(s.css("borderBottomWidth"),10),w=g+v+i.offset+8)),"n"==i.anchor||"s"==i.anchor?m/2>f?(S=S<0?y+S:y,y=0):f+m/2>parseInt(e(window).width(),10)&&(S-=y,y*=2):A?(w+=k,k=0):T&&(w-=k,k*=2),delay&&clearTimeout(delay),delay=setTimeout(function(){s.css({"margin-left":S+"px","margin-top":w+"px"}).stop(!0,!0).fadeIn(i.fadeIn)},i.delay),s.attr("class","sb-tooltip "+I)},c=function(){(!i.aHide&&!o||i.aHide)&&(delay&&clearTimeout(delay),delay=setTimeout(function(){d()},i.delay))},d=function(){!i.aHide&&!o||i.aHide?(s.stop(!0,!0).fadeOut(i.fadeOut),i.hide&&i.hide.call(this)):setTimeout(function(){c()},200)}}})},e.fn.sbLanguageSwitcher=function(t=[],i="",s=!1){let a=`<div class="sb-language-switcher" data-source="${i}">`,n=[],r=e(this).hasClass("sb-language-switcher-cnt")?e(this):e(this).find(".sb-language-switcher-cnt");for(var l=0;l<t.length;l++){let e=h(t[l])?t[l]:t[l][0],i=!(h(t[l])||!t[l][1])&&t[l][1];n.includes(e)||(a+=`<span ${s==e?'class="sb-active" ':""}data-language="${e}"${i?' data-id="'+i+'"':""}><i class="sb-icon-close"></i><img src="${SB_URL}/media/flags/${e.toLowerCase()}.png" /></span>`,n.push(e))}return r.find(".sb-language-switcher").remove(),r.append(a+`<i data-sb-tooltip="${o("Add translation")}" class="sb-icon-plus"></i></div>`),r.sbInitTooltips(),this},e.fn.sbShowLightbox=function(t=!1,i=""){return k.find(".sb-lightbox").sbActive(!1),we.sbActive(!0),e(this).sbActive(!0),t?e(this).addClass("sb-popup-lightbox").attr("data-action",i):e(this).css({"margin-top":e(this).outerHeight()/-2+"px","margin-left":e(this).outerWidth()/-2+"px"}),e("body").addClass("sb-lightbox-active"),setTimeout(()=>{dt.open_popup=this},500),this.preventDefault,this},e.fn.sbHideLightbox=function(){return e(this).find(".sb-lightbox,.sb-popup-lightbox").sbActive(!1).removeClass("sb-popup-lightbox").removeAttr("data-action"),we.sbActive(!1),e("body").removeClass("sb-lightbox-active"),dt.open_popup=!1,this},e.fn.sbInitTooltips=function(){return e(this).find("[data-sb-tooltip]").each(function(){e(this).miniTip({content:e(this).attr("data-sb-tooltip"),anchor:"s",delay:500})}),this};var st={dialogflow:{intents:!1,qea:[],token:SBF.storage("dialogflow-token"),dialogflow_languages:[],original_response:!1,smart_reply_busy:!1,smartReply:function(e=!1){let t=SBChat.conversation.id;this.smart_reply_busy!=t&&(this.smart_reply_busy=t,SBF.ajax({function:"dialogflow-smart-reply",message:e,token:this.token,conversation_id:t,dialogflow_languages:this.dialogflow_languages},e=>{if(this.smart_reply_busy=!1,SBChat.conversation.id&&t===SBChat.conversation.id){let t=e.suggestions,s="",a=T[0].scrollTop===T[0].scrollHeight-T[0].offsetHeight,n=!(!SBChat.conversation||!SBChat.conversation.getLastMessage())&&SBChat.conversation.getLastMessage().message;e.token&&(this.token=e.token,SBF.storage("dialogflow-token",e.token));for(var i=0;i<t.length;i++)t[i]!=n&&(s+=`<span>${SBF.escape(t[i])}</span>`);R.html(s),a&&SBChat.scrollBottom()}e.dialogflow_languages&&(this.dialogflow_languages=e.dialogflow_languages)}))},showCreateIntentBox:function(e){let t="",i=SBChat.conversation.getMessage(e),s=i.message;if(SBF.isAgent(i.get("user_type")))t=SBChat.conversation.getLastUserMessage(i.get("index")),t=t&&t.payload("sb-human-takeover")?SBChat.conversation.getLastUserMessage(t.get("index")).message:t.message;else{t=s;let e=SBChat.conversation.getNextMessage(i.id,"agent");e&&(s=e.message)}M.hasClass("sb-dialogflow-disabled")?(SBF.ajax({function:"open-ai-get-qea-training"},e=>{let t='<option value="">'+o("New Q&A")+"</option>";for(var i=0;i<e.length;i++)this.qea=e,t+=`<option value="${i}">${e[i][0][0]}</option>`;M.find("#sb-qea-select").html(t)}),st.openAI.generateQuestions(t)):this.getIntents(e=>{let i='<option value="">'+o("New Intent")+"</option>";for(var s=0;s<e.length;s++)i+=`<option value="${e[s].name}">${e[s].displayName}</option>`;M.find("#sb-intents-select").html(i),st.openAI.generateQuestions(t)}),M.attr("data-message-id",i.id),M.find(".sb-type-text:not(.sb-first)").remove(),M.find(".sb-type-text input").val(t),M.find("#sb-intents-select,#sb-qea-select").val(""),M.find(".sb-search-btn").sbActive(!1).find("input").val(""),this.searchIntents(""),this.original_response=s,M.find("textarea").val(s),M.sbShowLightbox()},submitIntent:function(i){if(a(i))return;let s=[],n=M.find("textarea").val(),o=M.find("#sb-intents-select,#sb-qea-select").val(),r=M.find("#sb-train-chatbots").val(),l="open-ai"==r||M.hasClass("sb-dialogflow-disabled");if(M.find(".sb-type-text input").each(function(){e(this).val()&&s.push(e(this).val())}),!n&&!o||0==s.length)SBForm.showErrorMessage(M,"Please insert the bot response and at least one user expression."),e(i).sbLoading(!1);else{let a;l&&(o?(this.qea[o][0]=this.qea[o][0].concat(s),a=this.qea[o]):a=[[s,n]]),SBF.ajax({function:l?"open-ai-qea-training":o?"dialogflow-update-intent":"dialogflow-create-intent",questions_answers:a,expressions:s,response:n,agent_language:M.find(".sb-dialogflow-languages select").val(),conversation_id:SBChat.conversation.id,intent_name:o,update_index:o,services:r,language:M.find(".sb-dialogflow-languages select").val()},s=>{e(i).sbLoading(!1),!0===s?(k.sbHideLightbox(),t("Training completed")):SBForm.showErrorMessage(M,s.error&&s.error.message?s.error&&s.error.message:"Error")})}},getIntents:function(e){!1===this.intents?SBF.ajax({function:"dialogflow-get-intents"},t=>{this.intents=Array.isArray(t)?t:[],e(this.intents)}):e(this.intents)},searchIntents:function(e,t=!1){if(M.hasClass("sb-dialogflow-disabled")){let t=!(e.length>1),s=t?`<option value="">${o("New Q&A")}</option>`:"";e=e.toLowerCase();for(i=0;i<this.qea.length;i++)(t||this.qea[i][0].join("").toLowerCase().includes(e)||this.qea[i][1].toLowerCase().includes(e))&&(s+=`<option value="${i}">${this.qea[i][0][0]}</option>`);M.find("#sb-qea-select").html(s).change(),t&&M.find("textarea").val(this.original_response)}else{let n=!(e.length>1),r=n?`<option value="">${o("New Intent")}</option>`:"",l=this.intents,c=[];e=e.toLowerCase();for(var i=0;i<l.length;i++){let o=n||l[i].displayName.toLowerCase().includes(e);if(!o&&l[i].trainingPhrases){let t=l[i].trainingPhrases;for(var s=0;s<t.length;s++){for(var a=0;a<t[s].parts.length;a++)if(t[s].parts[a].text.toLowerCase().includes(e)){o=!0;break}if(o)break}}o&&(t?c.push(l[i]):r+=`<option value="${l[i].name}">${l[i].displayName}</option>`)}if(t)return c;M.find("#sb-intents-select").html(r).change(),e||M.find("textarea").val(this.original_response)}},previewIntentDialogflow:function(e){let t="",s=this.getIntent(e);if(s){let e=s.trainingPhrases?s.trainingPhrases:[],o=e.length;if(o>1){for(var a=0;a<o;a++)for(var n=0;n<e[a].parts.length&&(t+=`<span>${e[a].parts[n].text}</span>`,15!=n);n++);i(t,"info",!1,"intent-preview-box","",o>10)}}},previewIntent:function(e){if(e){let s="",a=this.qea[e];if(a[0].length>1){let e=a[0].length>15?15:a[0].length;for(var t=0;t<e;t++)s+=`<span>${a[0][t]}</span>`;i(s,"info",!1,"qea-preview-box","",e>10)}}},getIntent:function(e){for(var t=0;t<this.intents.length;t++)if(this.intents[t].name==e)return this.intents[t];return!1},translate:function(e,t,i,s,a){e.length&&SBF.ajax({function:"google-translate",strings:e,language_code:t,token:this.token,message_ids:s,conversation_id:a},e=>{if(this.token=e[1],!Array.isArray(e[0]))return SBF.error(JSON.stringify(e[0]),"SBApps.dialogflow.translate"),!1;i(e[0])})}},openAI:{urls_history:[],progress:1,rewriteButton:function(e){j.length&&j.sbActive(e.length>2&&e.indexOf(" "))},rewrite:function(e,t){SBF.ajax({function:"open-ai-message",model:SB_ADMIN_SETTINGS.open_ai_model,message:(SB_ADMIN_SETTINGS.open_ai_prompt_rewrite?SB_ADMIN_SETTINGS.open_ai_prompt_rewrite:"Make the following text more friendly and professional, do no add any additional text or comments, always return the rewritten text only.")+` The text must be in ${SB_LANGUAGE_CODES[SB_ADMIN_SETTINGS.active_agent_language]} language: ${e}.`,extra:"rewrite"},i=>{i[0]||console.error("OpenAI: "+JSON.stringify(i[1])),lt.previous_editor_text=e,t(i)})},troubleshoot:function(){let e=SB_ADMIN_SETTINGS.open_ai_chatbot_status;return!0!==e&&t("inactive"==e?"Enable the chatbot in Settings > Artificial Intelligence > OpenAI > Chatbot.":"key"==e?"Enter the OpenAI API key in Settings > Artificial Intelligence > OpenAI > API key.":"The training data is ignored. Change the chatbot mode in Settings > Artificial Intelligence > OpenAI > Chatbot mode.","error"),e},getCode:{set_data:function(e){let t="",i=this.select_user_details();e&&e.length||(e=[["",""]]);for(var s=0;s<e.length;s++)t+=`<div class="repeater-item"><div>${i.replace(`"${e[s][0]}"`,`"${e[s][0]}" selected`)}<div class="sb-setting"><input type="url" placeholder="${o("Enter the value")}" value="${e[s][1]}"></div></div><i class="sb-icon-close"></i></div>`;return this.repeater_("Data",t)},actions:function(e){let t=[["tags","Assign tags"],["department","Assign a department"],["agent","Assign an agent"],["redirect","Go to URL"],["open_article","Show an article"],["transcript","Download transcript"],["transcript_email","Email transcript"],["send_email","Send email to user"],["send_email_agents","Send email to agents"],["archive_conversation","Archive the conversation"],["human_takeover","Human takeover"]],i="",s="";e&&e.length||(e=[["tags",""]]);for(a=0;a<t.length;a++)i+=`<option value="${t[a][0]}">${o(t[a][1])}</option>`;for(var a=0;a<e.length;a++)s+=`<div class="repeater-item"><div><div class="sb-setting"><select>${i.replace(`"${e[a][0]}"`,`"${e[a][0]}" selected`)}</select></div>${this.action(e[a][0],e[a][1])}</div><i class="sb-icon-close"></i></div>`;return this.repeater_("Actions",s)},action:function(e,t){let i={department:"number",agent:"number",redirect:"url"};return["send_email_agents","send_email","open_article","redirect","agent","department","tags"].includes(e)?`<div class="sb-setting"><input type="${i[e]?i[e]:"text"}" value="${t}" placeholder="${o({tags:"Enter tag names, separated by commas",department:"Enter the department ID",agent:"Enter the agent ID",redirect:"Enter the URL",open_article:"Enter the article ID",send_email:"Enter a message",send_email_agents:"Enter a message"}[e])}" value="${t}"></div>`:""},select_user_details:function(){let e='<div class="sb-setting"><select>',t=[["full_name","Name"],["email","Email"],["password","Password"]].concat(rt.getExtraDetailsList());for(var i=0;i<t.length;i++)e+=`<option value="${t[i][0]}">${o(t[i][1])}</option>`;return e+"</select></div>"},repeater_:function(e,t){return`<div class="sb-title">${o(e)}</div><div data-type="repeater" class="sb-setting sb-type-repeater"><div class="input"><div class="sb-repeater sb-repeater-block-${SBF.stringToSlug(e)}">${t}</div><div class="sb-btn sb-btn-white sb-repeater-add sb-icon"><i class="sb-icon-plus"></i>${o("Add new item")}</div></div></div>`}},generateQuestions:function(e){if(SB_ADMIN_SETTINGS.open_ai_user_expressions&&e){let t=M.find('[data-value="add"]');t.sbLoading(!0),M.find(".sb-open-ai-intent").remove(),SBF.ajax({function:"open-ai-user-expressions",message:e},e=>{let i="";for(var s=0;s<e.length;s++)e[s]&&(i+=`<div class="sb-setting sb-type-text sb-open-ai-intent"><input type="text" value="${e[s].replace(/"/g,"")}"></div>`);i&&M.find("> div > .sb-type-text").last().after(i),t.sbLoading(!1)})}},flows:{flows:[],set:function(e){if("string"==typeof e)(e=e.trim().replaceAll('"',"").replaceAll("_","-"))&&(e={name:e.replace(/[^a-zA-Z\u00C0-\u1FFF\u2C00-\uD7FF\uAC00-\uD7A3]/g,""),label:e,steps:[[[{type:"start",start:"message",message:"",conditions:[],disabled:!1}]],[[]]]});else for(var t=0;t<this.flows.length;t++)if(this.flows[t].name==e.name)return this.flows[t]=e,this.show(e.name),!0;this.flows.push(e),re.find(".sb-active").sbActive(!1),re.append(this.navCode(e.name,e.label,!0)),this.show(e.name)},get:function(e=!1){e||(e=this.getActiveName());for(var t=0;t<this.flows.length;t++)if(this.flows[t].name==e)return this.flows[t].steps||(this.flows[t].steps=[]),this.flows[t];return!1},show:function(t=!1){t||(t=this.getActiveName());let i,s=this.get(t),a="";if(s){let t=[],d=[];for(var n=0;n<s.steps.length;n++){let e=s.steps[n],u=0;t=d,d=[],a+="<div><div>";for(var r=0;r<e.length;r++){let s=e[r];a+='<div class="sb-flow-block-cnt">',t[r]&&(a+=`<div class="sb-flow-block-cnt-name">${t[r]}</div>`);for(var l=0;l<s.length;l++){"start"!=s[l].type||Array.isArray(s[l].message)||(s[l].message=[{message:s[l].message}]);let e=s[l].message?Array.isArray(s[l].message)?s[l].message.length?s[l].message[0].message:"":s[l].message:"";switch(e&&(e=`<div>${e.length>45?e.substring(0,45)+"...":e}</div>`),a+=`<div class="sb-flow-block" data-type="${s[l].type}"><div>${o(SBF.slugToString(s[l].type))}</div>${e}`,s[l].type){case"get_user_details":d.push(!1);break;case"condition":case"button_list":let t="condition"==s[l].type,n=t?[o("True"),o("False")]:s[l].options;if(t){a+="<div>",i=s[l].conditions;for(c=0;c<i.length;c++)a+=`<div>${SBF.slugToString(i[c][0]+" "+i[c][1])}${i[c][2]?": "+i[c][2]:""}</div>`;a+="</div>"}a+='<div class="sb-flow-connectors">';for(c=0;c<n.length;c++)d.push("ABCDEFGHIJKLMNOPQRSTUVWXYZ"[u]+(c+1)),a+=`<div>${n[c]}<span>${d[d.length-1]}</span></div>`;a+="</div>",u++;break;case"video":a+=`<div>${s[l].url}</div>`;break;case"action":case"set_data":a+="<div>",i=s[l]["set_data"==s[l].type?"data":"actions"];for(var c=0;c<i.length;c++)a+=`<div>${SBF.slugToString(i[c][0])}${i[c][1]?": "+i[c][1]:""}</div>`;a+="</div>";break;case"rest_api":a+=`<div>${s[l].url}</div>`}a+="</div>"}s.length<4&&(a+='<div class="sb-flow-add-block sb-icon-plus"></div>'),a+="</div>"}a+='</div><div class="sb-flow-add-step sb-icon-plus"></div></div>'}le.html(a),e(k).find(".sb-flow-scroll").sbActive(250*s.steps.length>le.outerWidth())}},delete:function(e){for(var t=0;t<this.flows.length;t++)if(this.flows[t].name==e){let i=re.find(`[data-value="${e}"]`);return this.flows[t].steps.forEach(e=>{e.forEach(e=>{e.forEach(e=>{e.attachments&&e.attachments.forEach(e=>{SBF.ajax({function:"delete-file",path:e})})})})}),this.flows.splice(t,1),i.sbActive()&&(i.prev().length?i.prev().click():i.next().length?i.next().click():le.html("")),i.remove(),!0}return!1},save:function(e=!1){SBF.ajax({function:"open-ai-flows-save",flows:JSON.stringify(this.flows)},t=>{e(t)})},navCode:function(e,t,i=!1){return`<li${i?' class="sb-active"':""} data-value="${e}">${t||e}<i class="sb-icon-delete"></i></li>`},getActive:function(){return re.find(".sb-active")},getActiveName:function(){return this.getActive().attr("data-value")},getActiveIndex:function(){return this.getActive().index()},steps:{get:function(e=!1,t=!1){return st.openAI.flows.get(e).steps[t||this.getActiveIndex()]},getActiveIndex:function(){return st.openAI.flows.blocks.getActive().parent().parent().parent().index()}},blocks:{set:function(e,t=!1,i=!1,s=!1,a=!1){let n=this.getIndexes(t,i,s,a),o=st.openAI.flows.get(t);if(o){let i=!1;if(o.steps.length>n.step){let t=o.steps[n.step];if(t.length>n.cnt){let s=t[n.cnt];s.length>n.block&&(s[n.block]=e,i=!0)}i||(o.steps[n.step][n.cnt].push(e),i=!0)}i||o.steps.push([[e]]);let s=o.steps[n.step],a=o.steps[st.openAI.flows.steps.getActiveIndex()+1],c=0;for(l=0;l<s.length;l++)for(var r=0;r<s[l].length;r++)switch(s[l][r].type){case"get_user_details":c+=1;break;case"button_list":c+=s[l][r].options.length;break;case"condition":c+=2}if(a)if(a.length>c)a.splice(-1*(c-1),c);else{let e=a.length;for(e;e<c;e++)a.splice(n.cnt,0,[])}else{a=[];for(var l=0;l<c;l++)a.push([]);a.length&&o.steps.push(a)}return st.openAI.flows.show(t),!0}return!1},get:function(e=!1,t=!1,i=!1,s=!1){let a=st.openAI.flows.get(e);if(a){let n=this.getIndexes(e,t,i,s);return a.steps[n.step][n.cnt][n.block]}return!1},add:function(e,t=!1,i=!1,s=!1,a=!1){let n=this.getIndexes(t,i,s,a);this.set(Object.assign({button_list:{message:"",options:[]},message:{message:""},video:{message:"",url:""},get_user_details:{message:"",details:[]},set_data:{data:[]},action:{actions:[]},rest_api:{url:"",method:"",headers:[],body:"",save_response:[]},condition:{conditions:[]}}[e],{type:e}),n.name,n.step,n.cnt,n.block),st.openAI.flows.show(t),setTimeout(()=>{le.find("> div").eq(n.step).find(".sb-flow-block-cnt").eq(n.cnt).find(".sb-flow-block").eq(n.block).click()},100)},delete:function(e=!1,t=!1,i=!1,s=!1){let a=this.getIndexes(e,t,i,s);for(var n=0;n<st.openAI.flows.flows.length;n++){let e=st.openAI.flows.flows[n];if(a.name==e.name){if(["get_user_details","button_list","condition"].includes(e.steps[a.step][a.cnt][a.block].type)){let t=this.delete_(n,a.step,a.cnt),i=Object.assign({},e);for(o=0;o<t.length;o++)e.steps[t[o][0]][t[o][1]]=!1;e.steps[a.step][a.cnt].splice(a.block,1),i.steps=[];for(var o=0;o<e.steps.length;o++){let t=[];for(var r=0;r<e.steps[o].length;r++)e.steps[o][r]&&t.push(e.steps[o][r]);t.length&&i.steps.push(t)}st.openAI.flows.flows[n]=i}else e.steps[a.step][a.cnt].splice(a.block,1);return st.openAI.flows.show(a.name),!0}}return!1},delete_:function(e,t,i,s=[]){let a=st.openAI.flows.blocks.getNextCntIndexes(e,t,i);for(var n=0;n<a.length;n++)s.push([t+1,a[n]]),this.delete_(e,t+1,a[n],s);return s},getActive:function(){return le.find(".sb-flow-add-block.sb-active, .sb-flow-block.sb-active")},getActiveIndex:function(){let e=this.getActiveCnt().find(".sb-flow-block"),t=e.index(this.getActive());return-1===t?e.length:t},getActiveCnt:function(){return this.getActive().parent()},getActiveCntIndex:function(){return this.getActive().parent().index()},getNextCnt:function(e,t,i,s=0){let a=this.getNextCntIndexes(e,t,i,s);return a.length>s&&st.openAI.flows.flows[e].steps[t+1][a[s]]},getNextCntIndexes:function(e,t,i){let s=st.openAI.flows.flows[e],a=[];if(s&&s.steps[t+1]){let e=0;for(var n=0;n<=i;n++){let l=s.steps[t][n];for(var o=0;o<l.length;o++)if("button_list"==l[o].type)for(r=0;r<l[o].options.length;r++)n==i&&a.push(e),e++;else if("get_user_details"==l[o].type)n==i&&a.push(e),e++;else if("condition"==l[o].type)for(var r=0;r<2;r++)n==i&&a.push(e),e++}}return a},getPreviousCntIndex:function(e,t,i){let s=st.openAI.flows.flows[e].steps[t-1];if(s){let e=0;for(var a=0;a<s.length;a++){let t=s[a];for(var n=0;n<t.length;n++)e+="button_list"==t[n].type?t[n].options.length:"get_user_details"==t[n].type?1:"condition"==t[n].type?2:0;if(e>i)return a}return e}},getIndexes:function(e,t,i,s){return{name:e||st.openAI.flows.getActiveName(),step:t||st.openAI.flows.steps.getActiveIndex(),cnt:i||this.getActiveCntIndex(),block:s||this.getActiveIndex()}},activateLinkedCnts:function(t){let i=e(t).parent(),s=st.openAI.flows.getActiveIndex(),a=i.parent().parent().index(),n=le.find("> div"),o=n.eq(a-1).find(".sb-flow-block-cnt").eq(st.openAI.flows.blocks.getPreviousCntIndex(s,a,i.index()));if(!Oe){let e=n.eq(a+1).find(".sb-flow-block-cnt"),t=st.openAI.flows.blocks.getNextCntIndexes(s,a,i.index());for(var r=0;r<t.length;r++)e.eq(t[r]).sbActive(!0)}le.find(".sb-flow-connectors > div").sbActive(!1),o.sbActive(!0).find(".sb-flow-block-cnt-name").sbActive(!0),i.find(".sb-flow-block-cnt-name").length&&o.find(".sb-flow-connectors > div").sbActive(!1).eq(parseInt(i.find(".sb-flow-block-cnt-name").html().substring(1))-1).sbActive(!0)}}},train:{urls:[],errors:[],base_url:!1,start_urls:[],sitemap_processed_urls:[],active_source:!1,history:[],training_button:!1,extract_url:[],skip_files:[],files:function(e,t=0){let i=de.prop("files");if(t>=i.length)return e(!0);let s=i[t].name;this.isFile(s)&&!this.skip_files.includes(s)?(k.find("#sb-embeddings-box p").html(o("We are processing the source")+"<pre>"+s+"</pre><span>"+o("Only {R} sources left to complete.").replace("{R}",i.length-t)+"</span>"),de.sbUploadFiles(i=>{"success"==(i=JSON.parse(i))[0]&&SBF.ajax({function:"open-ai-file-training",url:i[1]},i=>{this.isError(i)||this.files(e,t+1)})},t)):this.files(e,t+1)},website:function(e,t=0){if(t>=this.urls.length)return e(!0);let i=this.urls[t];i&&i.includes("http")?(k.find("#sb-embeddings-box p").html(o("We are processing the source")+"<pre>"+i+"</pre><span>"+o("Only {R} sources left to complete.").replace("{R}",this.urls.length-t)+"</span>"),i.includes(".xml")?SBF.ajax({function:"get-sitemap-urls",sitemap_url:i},i=>{Array.isArray(i)?this.urls=this.urls.concat(i):this.errors.push(i),this.website(e,t+1)}):!this.sitemap_processed_urls.includes(i)&&this.extract_url[t]?(this.sitemap_processed_urls.push(i),this.sitemap(i,i=>{this.urls=this.urls.concat(i),this.website(e,t+1)})):SBF.ajax({function:"open-ai-url-training",url:i},i=>{this.isError(i)||(i[0]||i[1].includes("http-error-404")||i[1].includes("http-error-302")||(i[1].includes("http-error")&&0===t?this.errors.push(i[2]):!0!==i[0][0]&&this.errors.push(i)),this.website(e,t+1))})):(i&&this.errors.push(o("Use a valid URL starting with http. The URL {R} is not valid.").replace("{R}",i)),this.website(e,t+1))},sitemap:function(e,t,i=[]){k.find("#sb-embeddings-box p").html(o("We are generating the sitemap")+"<pre>"+e+"</pre>"),SBF.ajax({function:"generate-sitemap",url:e},e=>{t(e)})},qea:function(e){k.find("#sb-embeddings-box p").html(o("We are processing the Q&A."));let t=at.repeater.get(ae.find(".sb-repeater").eq(0).find("> .repeater-item")).map(e=>[e["open-ai-faq-questions"].map(e=>e.question),e["open-ai-faq-answer"],e["open-ai-faq-function-calling-url"],e["open-ai-faq-function-calling-method"],e["open-ai-faq-function-calling-headers"],!!e["open-ai-faq-function-calling-properties"].length&&e["open-ai-faq-function-calling-properties"].map(e=>[e.name,e.description,e.allowed]),e["open-ai-faq-set-data"].map(e=>[e.id,e.value])]);SBF.ajax({function:"open-ai-qea-training",questions_answers:t,reset:!0},t=>{e(t)})},articles:function(e){k.find("#sb-embeddings-box p").html(o("We are processing the articles.")),SBF.ajax({function:"open-ai-articles-training"},t=>{e(t)})},isFile:function(e){return e.includes(".pdf")||e.includes(".txt")||e.includes(".json")||e.includes(".csv")},isError:function(e){let t="chars-limit-exceeded"==e[1],s=t||e[1]&&e[1][0]&&e[1][0].error;return s&&(te.find("#sb-train-chatbot").sbLoading(!1),i(t?o("The chatbot cannot be trained with these sources because the limit of your plan is {R} characters. Upgrade your plan to increase the number of characters.").replace("{R}",e[2]):e[1][0].error.message)),s}},playground:{messages:[],last_response:!1,addMessage:function(e,t="user",i=[]){oe.append(`<div data-type="${t}"><div>${o("user"==t?"User":"Assistant")}<div><i class="sb-icon-close sb-btn-icon sb-btn-red"></i></div></div><div>${new SBMessage({id:1,message:SBF.escape(e),creation_time:"0000-00-00 00:00:00",status_code:0,user_type:"agent",attachments:JSON.stringify(i)}).getCode()}</div></div>`),oe[0].scrollTop=oe[0].scrollHeight,this.messages.push([t,e])}},init:function(){SBF.ajax({function:"open-ai-get-training-files"},e=>{let t=["",""];for(var i=0;i<e.length;i++)if(!["sb-conversations","sb-articles","sb-database","sb-flows"].includes(e[i])){let s=this.train.isFile(e[i]);t[s?1:0]+=`<tr data-url="${e[i]}"><td><input type="checkbox" /></td><td>${s?SBF.beautifyAttachmentName(e[i].split("/").pop()):b(e[i])}</td><td></td><td><i class="sb-icon-delete"></i></td></tr>`}ie.html(t[1]).sbLoading(!1),se.html(t[0]).sbLoading(!1),te.find("#sb-chatbot-delete-website").setClass("sb-hide",!t[0])}),SBF.ajax({function:"open-ai-get-qea-training"},t=>{for(var i=0;i<t.length;i++)t[i][0]&&!Array.isArray(t[i][0])&&(t[i][0]=[t[i][0]]);let s=t.map(e=>({"open-ai-faq-questions":e[0]?e[0].map(e=>({question:e})):[""],"open-ai-faq-answer":e[1],"open-ai-faq-function-calling-url":e[2],"open-ai-faq-function-calling-method":e[3],"open-ai-faq-function-calling-headers":e[4],"open-ai-faq-function-calling-properties":e[5]&&e[5].length?e[5].map(e=>({name:e[0],description:e[1],allowed:e[2]})):[["","",""]],"open-ai-faq-set-data":e[6]&&e[6].length?e[6].map(e=>({id:e[0],value:e[1]})):[["",""]]}));s.length&&(ae.find("> div > .sb-repeater").html(at.repeater.set(s,ae.find("> div > .sb-repeater > .repeater-item:last-child"))),ae.find(".sb-enlarger").each(function(){let t=e(this).find("select"),i=["transcript","transcript_email","human_takeover","archive_conversation"];(e(this).find("input").val()||i.includes(t.val()))&&(e(this).sbActive(!0),e(this).hasClass("sb-enlarger-function-calling")&&e(this).closest(".repeater-item").find(".sb-qea-repeater-answer").addClass("sb-hide")),t.each(function(){i.includes(e(this).val())&&e(this).parent().next().find("input").addClass("sb-hide")})}))})}},messenger:{check:function(e){return["fb","ig"].includes(e.get("source"))},send:function(e,t,i="",s=[],a,n=!1,o=!1){SBF.ajax({function:"messenger-send-message",psid:e,facebook_page_id:t,message:i,message_id:n,attachments:s,metadata:a},e=>{o&&o(e),st.unsupportedRichMessages(i,"Messenger")})}},whatsapp:{check:function(e){return"wa"==e.get("source")},send:function(e,t="",s=[],a=!1,n=!1){SBF.ajax({function:"whatsapp-send-message",to:e,message:t,attachments:s,phone_id:a},e=>{e.error&&i(e.error.message,"info",!1,"error-wa"),n&&n(e),st.unsupportedRichMessages(t,"WhatsApp")})},activeUserPhone:function(e=s()){return!!e.getExtra("phone")&&e.getExtra("phone").value.replace("+","")}},telegram:{check:function(e){return"tg"==e.get("source")},send:function(e,t="",i=[],s=!1,a=!1,n=!1,o=!1){SBF.ajax({function:"telegram-send-message",chat_id:e,message:t,message_id:n,attachments:i,conversation_id:s,reply:a},e=>{o&&o(e),st.unsupportedRichMessages(t,"Telegram")})}},viber:{check:function(e){return"vb"==e.get("source")},send:function(e,t="",i=[],s=!1){SBF.ajax({function:"viber-send-message",viber_id:e,message:t,attachments:i},e=>{s&&s(e),st.unsupportedRichMessages(t,"Viber")})}},zalo:{check:function(e){return"za"==e.get("source")},send:function(e,t="",i=[],s=!1){SBF.ajax({function:"zalo-send-message",zalo_id:e,message:t,attachments:i},e=>{s&&s(e),st.unsupportedRichMessages(t,"Zalo")})}},twitter:{check:function(e){return"tw"==e.get("source")},send:function(e,t="",i=[],s=!1){SBF.ajax({function:"twitter-send-message",twitter_id:e,message:t,attachments:i},e=>{s&&s(e),st.unsupportedRichMessages(t,"Twitter")})}},line:{check:function(e){return"ln"==e.get("source")},send:function(e,t="",i=[],s=!1,a=!1){SBF.ajax({function:"line-send-message",line_id:e,message:t,attachments:i,conversation_id:s},e=>{a&&a(e),st.unsupportedRichMessages(t,"LINE")})}},wechat:{token:!1,check:function(e){return"wc"==e.get("source")},send:function(e,t="",i=[],s=!1){SBF.ajax({function:"wechat-send-message",open_id:e,message:t,attachments:i,token:this.token},e=>{Array.isArray(e)&&(this.token=e[1],e=e[0]),s&&s(e),st.unsupportedRichMessages(t,"WeChat")})}},aecommerce:{conversationPanel:function(){let t="",i=s().getExtra("aecommerce-id");this.panel||(this.panel=A.find(".sb-panel-aecommerce")),i&&!a(this.panel)&&SBF.ajax({function:"aecommerce-get-conversation-details",aecommerce_id:i.value},i=>{t=`<h3>${SB_ADMIN_SETTINGS.aecommerce_panel_title}</h3><div><div class="sb-split"><div><div class="sb-title">${o("Number of orders")}</div><span>${i.orders_count} ${o("orders")}</span></div><div><div class="sb-title">${o("Total spend")}</div><span>${i.total} ${i.currency_symbol}</span></div></div><div class="sb-title">${o("Cart")}</div><div class="sb-list-items sb-list-links sb-aecommerce-cart">`;for(s=0;s<i.cart.length;s++){let e=i.cart[s];t+=`<a href="${e.url}" target="_blank" data-id="${e.id}"><span>#${e.id}</span> <span>${e.name}</span> <span>x ${e.quantity}</span></a>`}if(t+=(i.cart.length?"":"<p>"+o("The cart is currently empty.")+"</p>")+"</div>",i.orders.length){t+=`<div class="sb-title">${o("Orders")}</div><div class="sb-list-items sb-list-links sb-aecommerce-orders">`;for(var s=0;s<i.orders.length;s++){let e=i.orders[s],a=e.id;t+=`<a data-id="${a}" href="${e.url}" target="_blank"><span>#${e.id}</span> <span>${SBF.beautifyTime(e.time,!0)}</span> <span>${e.price} ${i.currency_symbol}</span></a>`}t+="</div>"}e(this.panel).html(t).sbLoading(!1),l(this.panel,160)}),e(this.panel).html(t)}},martfury:{conversationPanel:function(){let t=s().getExtra("martfury-id");this.panel||(this.panel=A.find(".sb-panel-martfury")),t&&!a(this.panel)&&SBF.ajax({function:"martfury-get-conversation-details",martfury_id:t.value},t=>{e(this.panel).html(t).sbLoading(!1),l(this.panel,160)}),e(this.panel).html("")}},whmcs:{conversationPanel:function(){let t="",i=s().getExtra("whmcs-id");this.panel||(this.panel=A.find(".sb-panel-whmcs")),i&&!a(this.panel)&&SBF.ajax({function:"whmcs-get-conversation-details",whmcs_id:i.value},i=>{let s=["products","addons","domains"];t=`<h3>WHMCS</h3><div><div class="sb-split"><div><div class="sb-title">${o("Number of services")}</div><span>${i.services_count} ${o("services")}</span></div><div><div class="sb-title">${o("Total spend")}</div><span>${i.total} ${i.currency_symbol}</span></div></div></div>`;for(var a=0;a<s.length;a++){let e=i[s[a]];if(e.length){t+=`<div class="sb-title">${o(SBF.slugToString(s[a]))}</div><div class="sb-list-items">`;for(var n=0;n<e.length;n++)t+=`<div>${e[n].name}</div>`;t+="</div>"}}t+=`<a href="${SB_ADMIN_SETTINGS.whmcs_url}/clientssummary.php?userid=${i["client-id"]}" target="_blank" class="sb-btn sb-whmcs-link">${o("View on WHMCS")}</a>`,e(this.panel).html(t).sbLoading(!1),l(this.panel,160)}),e(this.panel).html(t)}},perfex:{conversationPanel:function(){let e=s().getExtra("perfex-id");A.find(".sb-panel-perfex").html(e?`<a href="${SB_ADMIN_SETTINGS.perfex_url}/admin/clients/client/${e.value}" target="_blank" class="sb-btn sb-perfex-link">${o("View on Perfex")}</a>`:"")}},ump:{conversationPanel:function(){if(a(this.panel))return;this.panel||(this.panel=A.find(".sb-panel-ump"));let t,i="";SBF.ajax({function:"ump-get-conversation-details"},s=>{if((t=s.subscriptions).length){i='<i class="sb-icon-refresh"></i><h3>Membership</h3><div class="sb-list-names">';for(var a=0;a<t.length;a++){let e=t[a].expired;i+=`<div${e?' class="sb-expired"':""}><span>${t[a].label}</span><span>${o(e?"Expired on":"Expires on")} ${SBF.beautifyTime(t[a].expire_time,!1,!e)}</span></div>`}i+=`</div><span class="sb-title">${o("Total spend")} ${s.total} ${s.currency_symbol}</span>`}e(this.panel).html(i).sbLoading(!1),l(this.panel,160)})}},armember:{conversationPanel:function(){let t=s().getExtra("wp-id");if(this.panel||(this.panel=A.find(".sb-panel-armember")),SBF.null(t)||a(this.panel))e(this.panel).html("");else{let i,a="";t=t.value,SBF.ajax({function:"armember-get-conversation-details",wp_user_id:t},t=>{if((i=t.subscriptions).length){a=`<i class="sb-icon-refresh"></i><h3>${o("Plans")}</h3><div class="sb-list-names">`;for(var n=0;n<i.length;n++){let e=i[n].expired;a+=`<div${e?' class="sb-expired"':""}><span>${i[n].arm_current_plan_detail.arm_subscription_plan_name}</span><span>${"never"==i[n].expire_time?"":o(e?"Expired on":"Expires on")+" "+SBF.beautifyTime(i[n].expire_time,!1,!e)}</span></div>`}a+=`</div><span class="sb-title">${o("Total spend")} ${t.total} ${t.currency_symbol}<a href="${window.location.href.substr(0,window.location.href.lastIndexOf("/"))+"?page=arm_manage_members&member_id="+s().getExtra("wp-id").value}" target="_blank" class="sb-btn-text"><i class="sb-icon-user"></i> ${o("View member")}</a></span>`}e(this.panel).html(a).sbLoading(!1),l(this.panel,160)})}}},zendesk:{conversationPanel:function(){if(!SB_ADMIN_SETTINGS.zendesk_active)return;let t=s().getExtra("zendesk-id"),i=s().getExtra("phone"),n=s().get("email"),o=A.find(".sb-panel-zendesk");(t||i||n)&&!a(o)?SBF.ajax({function:"zendesk-get-conversation-details",conversation_id:SBChat.conversation.id,zendesk_id:!!t&&t.value,phone:!!i&&i.value,email:n},t=>{e(o).html(t).sbLoading(!1),o.find(".sb-zendesk-date").each(function(){e(this).html(SBF.beautifyTime(e(this).html()))}),l(o,160)}):e(o).html("")}},woocommerce:{timeout:!1,conversationPanel:function(){if(a(this.panel))return;this.panel||(this.panel=A.find(".sb-panel-woocommerce"));let t="";SBF.ajax({function:"woocommerce-get-conversation-details"},i=>{t=`<i class="sb-icon-refresh"></i><h3>WooCommerce</h3><div><div class="sb-split"><div><div class="sb-title">${o("Number of orders")}</div><span>${i.orders_count} ${o("orders")}</span></div><div><div class="sb-title">${o("Total spend")}</div><span>${i.total} ${i.currency_symbol}</span></div></div><div class="sb-title">${o("Cart")}<i class="sb-add-cart-btn sb-icon-plus"></i></div><div class="sb-list-items sb-list-links sb-woocommerce-cart">`;for(s=0;s<i.cart.length;s++){let e=i.cart[s];t+=`<a href="${e.url}" target="_blank" data-id="${e.id}"><span>#${e.id}</span> <span>${e.name}</span> <span>x ${e.quantity}</span><i class="sb-icon-close"></i></a>`}if(t+=(i.cart.length?"":"<p>"+o("The cart is currently empty.")+"</p>")+"</div>",i.orders.length){t+=`<div class="sb-title">${o("Orders")}</div><div class="sb-list-items sb-woocommerce-orders sb-accordion">`;for(var s=0;s<i.orders.length;s++){let e=i.orders[s],a=e.id;t+=`<div data-id="${a}"><span><span>#${a}</span> <span>${SBF.beautifyTime(e.date,!0)}</span><a href="${ye}/wp-admin/post.php?post=${a}&action=edit" target="_blank" class="sb-icon-next"></a></span><div></div></div>`}t+="</div>"}e(this.panel).html(t).sbLoading(!1),l(this.panel,160)})},conversationPanelOrder:function(e){let t=this.panel.find(`[data-id="${e}"] > div`);t.html(""),SBF.ajax({function:"woocommerce-get-order",order_id:e},e=>{let i="",s=this.panel.find(".sb-collapse-btn:not(.sb-active)");if(e){let t=e.products;i+=`<div class="sb-title">${o("Order total")}: <span>${e.total} ${e.currency_symbol}<span></div><div class="sb-title">${o("Order status")}: <span>${SBF.slugToString(e.status.replace("wc-",""))}<span></div><div class="sb-title">${o("Date")}: <span>${SBF.beautifyTime(e.date,!0)}<span></div><div class="sb-title">${o("Products")}</div>`;for(a=0;a<t.length;a++)i+=`<a href="${ye}?p=${t[a].id}" target="_blank"><span>#${t[a].id}</span> <span>${t[a].quantity} x</span> <span>${t[a].name}</span></a>`;for(var a=0;a<2;a++){let t=0==a?"shipping":"billing";e[t+"_address"]&&(i+=`<div class="sb-title">${o((0==a?"Shipping":"Billing")+" address")}</div><div class="sb-multiline">${e[t+"_address"].replace(/\\n/g,"<br>")}</div>`)}}s.length&&s.click(),t.html(i)})},conversationPanelUpdate:function(e,t="added"){let i=!1,s=0;this.timeout=setInterval(()=>{i||(SBF.ajax({function:"woocommerce-get-conversation-details"},a=>{let n=!0;for(var o=0;o<a.cart.length;o++)a.cart[o].id==e&&("added"==t?s=61:n=!1);(s>60||n)&&(this.conversationPanel(),A.find(".sb-add-cart-btn,.sb-woocommerce-cart > a i").sbLoading(!1),clearInterval(this.timeout)),s++,i=!1}),i=!0)},1e3)}},opencart:{conversationPanel:function(){let e=A.find(".sb-panel-opencart"),t=s().getExtra("opencart_id"),i=s().getExtra("opencart_store_url");if(!t)return e.html("");a(e)||SBF.ajax({function:"opencart-panel",opencart_id:t.value,store_url:!!i&&i.value},t=>{e.html(t).sbLoading(!1),l(this.panel,160)})},openOrder:function(e){SBF.ajax({function:"opencart-order-details",order_id:e},t=>{dt.infoPanel(t,"info",!1,"opencart-order-details",o("Order")+" #"+e,!0)})}},wordpress:{ajax:function(t,i,s){e.ajax({method:"POST",url:SB_WP_AJAX_URL,data:e.extend({action:"sb_wp_ajax",type:t},i)}).done(e=>{!1!==s&&s(e)})}},is:function(e){if(typeof SB_VERSIONS==Ke)return!1;switch(e){case"opencart":case"zendesk":case"twitter":case"wechat":case"line":case"viber":case"zalo":case"telegram":case"armember":case"aecommerce":case"martfury":case"whmcs":case"perfex":case"ump":case"messenger":case"whatsapp":case"woocommerce":case"dialogflow":case"slack":case"tickets":return typeof SB_VERSIONS[e]!=Ke&&SB_VERSIONS[e];case"wordpress":return typeof SB_WP!=Ke;case"sb":return!0}return!1},unsupportedRichMessages:function(e,i,s=[]){s.push("timetable","registration","table","inputs"),["Messenger","WhatsApp"].includes(i)||s.push("email");for(var a=0;a<s.length;a++)e.includes("["+s[a])&&t("The {R} rich message is not supported by {R2}. The rich message was not sent to {R2}.".replace(/{R}/g,SBF.slugToString(s[a])).replace(/{R2}/g,i),"error")},getName:function(e){let t={fb:"Facebook",wa:"WhatsApp",tm:"Text message",ig:"Instagram",tg:"Telegram",tk:"Tickets",wc:"WeChat",em:"Email",tw:"Twitter",bm:"Business Messages",vb:"Viber",ln:"LINE",za:"Zalo"};return e in t?t[e]:e},itemsPanel:{pagination_reference:1,panel_language:"",code:function(e,t,i=!0){let s="";for(var a=0;a<e.length;a++)s+=`<li data-id="${e[a].id.split("/").pop()}"><div class="sb-image" style="background-image:url('${e[a].image?"shopify"==t?e[a].image.replace(".jpg","_small.jpg"):e[a].image:SB_URL+"/media/thumb.svg"}')"></div><div><span>${e[a].name?e[a].name:e[a].title}</span><span>${e[a].price?e[a].price:e[a].variants.edges[0].node.price} ${SB_ADMIN_SETTINGS.currency}</span></div></li>`;return i?s||`<p class="sb-no-results">${o("No products found")}</p>`:s},getAppInfo:function(e){switch(e){case"woocommerce":return{area:Ee,ul:Le,search:"woocommerce-search-products",filter:"woocommerce-get-products",populate:"woocommerce-products-popup",pagination:"woocommerce-get-products"};case"shopify":return{area:SBCloud.shopify_products_box,ul:SBCloud.shopify_products_box_ul,search:"shopify-get-products",filter:"shopify-get-products",populate:"shopify-get-products",pagination:"shopify-get-products"}}},search:function(t,i){let s=this.getAppInfo(i);c(t,(t,a)=>{t?(this.pagination_reference=1,SBF.ajax({function:s.search,search:t},t=>{"shopify"==i&&(this.pagination_reference=t[1],t=t[0]),this.getAppInfo(i).ul.html(this.code(t,i)),e(a).sbLoading(!1)})):this.populate(i,function(){e(a).sbLoading(!1)})})},filter:function(t,i){let s=this.getAppInfo(i),n=e(t).data("value");a(s.ul)||(s.ul.html(""),this.pagination_reference=1,SBF.ajax({function:s.filter,user_language:this.panel_language,filters:{taxonomy:n},collection:n},e=>{"shopify"==i&&(this.pagination_reference=e[1],e=e[0]),s.ul.html(this.code(e,i)).sbLoading(!1)}))},populate:function(e,t=!1){let i=this.getAppInfo(e);this.panel_language=s()&&SB_ADMIN_SETTINGS.languages&&SB_ADMIN_SETTINGS.languages.includes(s().language)?s().language:"",this.pagination_reference=1,i.ul.html("").sbLoading(!0),SBF.ajax({function:i.populate,user_language:this.panel_language},s=>{let a="",n=i.area.find(".sb-select");for(var r=0;r<s[1].length;r++)a+=`<li data-value="${s[1][r].id}">${s[1][r].name}</li>`;s[2]&&(this.pagination_reference=s[2]),s[3]&&(SB_ADMIN_SETTINGS.currency=s[3]),n.find("> p").html(o("All")),n.find("ul").html(`<li data-value="" class="sb-active">${o("All")}</li>`+a),i.ul.html(this.code(s[0],e)).sbLoading(!1),!1!==t&&t()})},pagination:function(t,i){let s=this.getAppInfo(i),a=e(t).parent().find(".sb-select p").attr("data-value");this.pagination_reference&&(s.ul.sbLoading(t),SBF.ajax({function:s.pagination,filters:{taxonomy:a},collection:a,pagination:this.pagination_reference,user_language:this.panel_language},e=>{"shopify"==i?(this.pagination_reference=e[1],e=e[0]):this.pagination_reference++,s.ul.append(this.code(e,i,!1)).sbLoading(!1),e.length||(this.pagination_reference=0)}))}}},at={init:!1,save:function(i=!1){if(i&&a(i))return;let s={},n={};switch(H.find(" > .sb-tab > .sb-nav .sb-active").attr("id")){case"tab-automations":let a=J.find(".sb-active").attr("data-id");at.automations.save(s=>{t(!0===s?"Automations saved":s),at.automations.populate(),J.find(`[data-id="${a}"]`).click(),i&&e(i).sbLoading(!1)});break;case"tab-translations":this.translations.updateActive(),SBF.ajax({function:"save-translations",translations:JSON.stringify(this.translations.to_update)},()=>{t("Translations saved"),i&&e(i).sbLoading(!1)});break;default:H.find(".sb-setting").each((t,i)=>{let a=this.get(i),o=e(i).data("setting");if(a[0])if(typeof o!=Ke){let t=!1;if(e(i).find("[data-language]").length){let s=e(i).find("[data-language].sb-active");if(t=a[0]in this.translations.originals&&this.translations.originals[a[0]],this.translations.save(i,!!s.length&&s.attr("data-language")),t&&"string"!=typeof t)for(var r in t)t[r]=[t[r],a[1][r][1]]}o in s||(s[o]={}),s[o][a[0]]=[t||a[1],a[2]]}else n[a[0]]=[a[1],a[2]]}),SBF.ajax({function:"save-settings",settings:JSON.stringify(n),external_settings:s,external_settings_translations:this.translations.translations},()=>{i&&(t("Settings saved. Reload to apply the changes."),e(i).sbLoading(!1)),SBF.event("SBSettingsSaved",{settings:n,external_settings:s,external_settings_translations:this.translations.translations})})}},get:function(t){let i=(t=e(t)).attr("id"),s=t.data("type");switch(s){case"upload":case"range":case"number":case"text":case"password":case"color":case"upload-file":return[i,t.find("input").val(),s];case"textarea":return[i,t.find("textarea").val(),s];case"select":return[i,t.find("select").val(),s];case"checkbox":return[i,t.find("input").is(":checked"),s];case"radio":let a=t.find("input:checked").val();return SBF.null(a)&&(a=""),[i,a,s];case"upload-image":let n=t.find(".image").attr("data-value");return SBF.null(n)&&(n=""),[i,n,s];case"multi-input":let o={};return t.find(".input > div").each((e,t)=>{let i=this.get(t);i[0]&&(o[i[0]]=[i[1],i[2]])}),[i,o,s];case"select-images":return[i,t.find(".input > .sb-active").data("value"),s];case"repeater":return[i,this.repeater.get(t.find(".repeater-item")),s];case"double-select":let r={};return t.find(".input > div").each(function(){let t=e(this).find("select").val();-1!=t&&(r[e(this).attr("data-id")]=[t])}),[i,r,s];case"select-checkbox":return[i,t.find(".sb-select-checkbox input:checked").map(function(){return e(this).attr("id")}).get(),s];case"timetable":let l={};return t.find(".sb-timetable > [data-day]").each(function(){let t=e(this).attr("data-day"),i=[];e(this).find("> div > div").each(function(){let t=e(this).html(),s=e(this).attr("data-value");SBF.null(s)?i.push(["",""]):"closed"==s?i.push(["closed","Closed"]):i.push([s,t])}),l[t]=i}),[i,l,s];case"color-palette":return[i,t.attr("data-value"),s]}return["","",""]},set:function(t,i){let s=e(i)[1],a=e(i)[0];switch(t=`#${t}`,s){case"color":case"upload":case"number":case"text":case"password":case"upload-file":H.find(`${t} input`).val(a);break;case"textarea":H.find(`${t} textarea`).val(a);break;case"select":H.find(`${t} select`).val(a);break;case"checkbox":H.find(`${t} input`).prop("checked","false"!=a&&a);break;case"radio":H.find(`${t} input[value="${a}"]`).prop("checked",!0);break;case"upload-image":a&&H.find(t+" .image").attr("data-value",a).css("background-image",`url("${a}")`);break;case"multi-input":for(var n in a)this.set(n,a[n]);break;case"range":let i=a;H.find(t+" input").val(i),H.find(t+" .range-value").html(i);break;case"select-images":H.find(t+" .input > div").sbActive(!1),H.find(t+` .input > [data-value="${a}"]`).sbActive(!0);break;case"select-checkbox":for(o=0;o<a.length;o++)H.find(`input[id="${a[o]}"]`).prop("checked",!0);H.find(t+" .sb-select-checkbox-input").val(a.join(", "));break;case"repeater":let r=this.repeater.set(a,H.find(t+" .repeater-item:last-child"));r&&H.find(t+" .sb-repeater").html(r);break;case"double-select":for(var n in a)H.find(`${t} .input > [data-id="${n}"] select`).val(a[n]);break;case"timetable":for(var n in a){let i=H.find(`${t} [data-day="${n}"] > div > div`);for(var o=0;o<i.length;o++)e(i[o]).attr("data-value",a[n][o][0]).html(a[n][o][1])}break;case"color-palette":a&&H.find(t).attr("data-value",a)}},repeater:{set:function(t,i){var s="";if(this.clear(e(i)),i=e(i).html(),t.length){e(i).find("> .sb-icon-close").remove();for(var a=0;a<t.length;a++){let o=e(e.parseHTML(`<div>${i}</div>`));for(var n in t[a])at.input.set(o.find(`[data-id="${n}"]`),t[a][n]);s+=`<div class="repeater-item">${o.html().replaceAll('<i class="sb-icon-close"></i>',"")}<i class="sb-icon-close"></i></div>`}}return s},get:function(t){let i=[];return e(t).each(function(){let t={},s=!0;e(this).find("[data-id]").removeClass("sb-exclude"),e(this).find(".sb-repeater [data-id]").addClass("sb-exclude"),e(this).find("[data-id]:not(.sb-exclude)").each(function(){let i=at.input.get(this);s&&i&&"hidden"!=e(this).attr("type")&&"auto-id"!=e(this).attr("data-type")&&(s=!1),t[e(this).attr("data-id")]=i}),s||i.push(t)}),i},add:function(t){let i=e(t).parent();t=e(e.parseHTML(`<div>${i.find("> .sb-repeater > .repeater-item:last-child").html()}</div>`)),this.clear(t),t.find(".repeater-item:not(:first-child)").remove(),t.find("[data-id]").each(function(){if(at.input.reset(this),"auto-id"==e(this).data("type")){let t=1;i.find('[data-type="auto-id"]').each(function(){let i=parseInt(e(this).val());i>t&&(t=i)}),e(this).attr("value",t+1)}}),i.find("> .sb-repeater").append(`<div class="repeater-item">${t.html()}</div>`)},delete:function(t){let i=e(t).parent(),s=i.parent();s.parent().find(".sb-repeater-upload").length&&SBF.ajax({function:"delete-file",path:i.find("input").val()}),s.find("> .repeater-item").length>1?i.remove():i.find('[data-id]:not([data-type="auto-id"]').each((e,t)=>{at.input.reset(t)})},clear:function(e){e.find(".sb-active").sbActive(!1),e.find('input:not([data-type="auto-id"]').removeAttr("value checked"),e.find("option").removeAttr("selected"),e.find(".sb-hide").removeClass("sb-hide")}},input:{set:function(t,i){if(t=e(t),"object"!=typeof i&&(i=e.trim(i)),t.is("select"))t.find(`option[value="${i}"]`).attr("selected","");else if(t.is(":checkbox")&&i&&"false"!=i)t.attr("checked","");else if(t.is("textarea"))t.html(i);else{let e=t.is("div");t.hasClass("sb-repeater")?t.html(at.repeater.set(i,"<div>"+t.find("> .repeater-item").eq(0).html()+"</div>").replaceAll("sb-icon-close","sb-icon-close sb-sub-repeater-close")):e||t.is("i")||t.is("li")?(t.attr("data-value",i),e&&t.hasClass("image")&&t.css("background-image",i?`url("${i}")`:"")):t.attr("value",i)}},get:function(t){if((t=e(t)).is(":checkbox"))return t.is(":checked");if(t.hasClass("sb-repeater"))return at.repeater.get(t.find("> .repeater-item"));if(t.is("div")||t.is("i")||t.is("li")){let e=t.attr("data-value");return e||""}return t.val()},reset:function(t){(t=e(t)).is("select")?t.val("").find("[selected]").removeAttr("selected"):t.is(":checkbox")?t.removeAttr("checked").prop("checked",!1):t.is("textarea")?(t.val(""),t.html("")):t.hasClass("sb-repeater")?t.find(".repeater-item:not(:first-child)").remove():t.removeAttr("value style data-value").val("")}},initColorPicker:function(t=!1){e(t||H).find(".sb-type-color input").colorPicker({renderCallback:function(t,i){e(t.context).closest(".input").find("input").css("background-color",t.text)}})},getSettingObject:function(t){return e(t)[0].hasAttribute("data-setting")?e(t):e(t).closest("[data-setting]")},visibility:function(e,t){let i=[["#push-notifications-onesignal-sw-url, #push-notifications-onesignal-app-id, #push-notifications-onesignal-api-key, #push-notifications-sw-path","#push-notifications-id, #push-notifications-key"],["#messenger-key, #messenger-path-btn","#messenger-sync-btn"],["#open-ai-assistant-id","#open-ai-prompt,#open-ai-model, #open-ai-tokens, #open-ai-temperature, #open-ai-presence-penalty, #open-ai-frequency-penalty, #open-ai-logit-bias, #open-ai-custom-model, #open-ai-source-links"]];H.find(i[e][0]).sbActive(!t),H.find(i[e][1]).setClass("sb-hide",!t)},open:function(e,t=!1){x.find(".sb-admin-nav #sb-settings").click(),t&&setTimeout(()=>{H.find("#tab-"+e).click().get(0).scrollIntoView()},300)},automations:{items:{messages:[],emails:[],sms:[],popups:[],design:[],more:[]},translations:{},conditions:function(){let e={datetime:["Date time",["Is between","Is exactly"],"dd/mm/yyyy hh:mm - dd/mm/yyyy hh:mm"],repeat:["Repeat",["Every day","Every week","Every month","Every year"]],browsing_time:["Browsing time",[],"seconds"],scroll_position:["Scroll position",[],"px"],url:["Current URL",["Contains","Does not contain"],"URLs parts separated by commas"],referring:["Referring URL",["Contains","Does not contain"],"URLs parts separated by commas"],user_type:["User type",["Is visitor","Is lead","Is user","Is not visitor","Is not lead","Is not user"]],returning_visitor:["Returning visitor",["First time visitor","Returning visitor"]],countries:["Country",["Is included","Is not included","Is set","Is not set"],"Country codes separated by commas"],languages:["Language",["Is included","Is not included","Is set","Is not set"],"Language codes separated by commas"],cities:["City",["Is included","Is not included","Is set","Is not set"],"Cities separated by commas"],website:["Website",["Contains","Does not contain","Is set","Is not set"],"URLs parts separated by commas"],birthdate:["Birthdate",["Is between","Is exactly","Is set","Is not set"],"dd/mm - dd/mm"],company:["Company",["Is included","Is not included","Is set","Is not set"],"Company names separated by commas"],postal_code:["Postal code",["Is included","Is not included","Is set","Is not set"],"Postal codes separated by commas"],email:["Email",["Contains","Does not contain","Is set","Is not set"],"Email addresses separated by commas"],phone:["Phone",["Contains","Does not contain","Is set","Is not set"],"Phone numbers separated by commas"],creation_time:["Creation time",["Is between","Is exactly"],"dd/mm/yyyy hh:mm - dd/mm/yyyy hh:mm"],custom_variable:["Custom variable",[],"variable=value"]},t=rt.getExtraDetailsList(!0);for(var i=0;i<t.length;i++)e[t[i][0]]=[t[i][1],["Contains","Does not contain","Is set","Is not set"],"Values separated by commas"];return e},get:function(e){SBF.ajax({function:"automations-get"},t=>{this.items=t[0],this.translations=Array.isArray(t[1])&&!t[1].length?{}:t[1],e(t)})},save:function(e=!1){this.updateActiveItem(),SBF.ajax({function:"automations-save",automations:this.items,translations:this.translations},t=>{e&&e(t)})},show:function(e=!1,t=!1){this.updateActiveItem();let i=t?t in this.translations?this.translations[t]:[]:this.items,s=W.find(" > .sb-tab > .sb-content");!1===e&&(e=this.activeID()),this.hide(!1);for(var a in i)for(var n=0;n<i[a].length;n++){let o=i[a][n];if(o.id==e){for(var a in o){let e=s.find(`[data-id="${a}"]`);e.hasClass("image")?(e.css("background-image",`url(${o[a]})`).attr("data-value",o[a]),o[a]||e.removeAttr("data-value")):"checkbox"==e.attr("type")?e.prop("checked",o[a]):e.val(o[a])}return this.setConditions(o.conditions,Y),Y.parent().setClass("sb-hide",t),s.sbLanguageSwitcher(this.getTranslations(e),"automations",t),!0}}return!1},add:function(){let e=SBF.random(),t=`${o("Item")} ${J.find("li:not(.sb-no-results)").length+1}`;this.updateActiveItem(),this.items[this.activeType()].push(this.itemArray(this.activeType(),e,t)),this.hide(!1),J.find(".sb-active").sbActive(!1),J.find(".sb-no-results").remove(),J.append(`<li class="sb-active" data-id="${e}">${t}<i class="sb-icon-delete"></i></li>`),W.find(".sb-automation-values").find("input, textarea").val(""),W.sbLanguageSwitcher([],"automations"),Y.html("")},delete:function(t){this.items[this.activeType()].splice(e(t).parent().index(),1),e(t).parent().remove(),this.hide(),0==this.items[this.activeType()].length&&J.html(`<li class="sb-no-results">${o("No results found.")}</li>`)},populate:function(e=!1){!1===e&&(e=this.activeType());let t="",i=this.items[e];if(this.updateActiveItem(),i.length)for(s=0;s<i.length;s++)t+=`<li data-id="${i[s].id}">${i[s].name}<i class="sb-icon-delete"></i></li>`;else t=`<li class="sb-no-results">${o("No results found.")}</li>`;switch(J.html(t),t="",e){case"emails":t=`<h2>${o("Subject")}</h2><div class="sb-setting sb-type-text"><div><input data-id="subject" type="text"></div></div>`;break;case"popups":t=`<h2>${o("Title")}</h2><div class="sb-setting sb-type-text"><div><input data-id="title" type="text"></div></div><h2>${o("Profile image")}</h2><div data-type="upload-image" class="sb-setting sb-type-upload-image"><div class="input"><div data-id="profile_image" class="image"><i class="sb-icon-close"></i></div></div></div><h2>${o("Message fallback")}</h2><div class="sb-setting sb-type-checkbox"><div><input data-id="fallback" type="checkbox"></div></div>`;break;case"design":t=`<h2>${o("Header title")}</h2><div class="sb-setting sb-type-text"><div><input data-id="title" type="text"></div></div>`;for(s=1;s<4;s++)t+=`<h2>${o((1==s?"Primary":2==s?"Secondary":"Tertiary")+" color")}</h2><div data-type="color" class="sb-setting sb-type-color"><div class="input"><input data-id="color_${s}" type="text"><i class="sb-close sb-icon-close"></i></div></div>`;for(var s=1;s<4;s++)t+=`<h2>${o(1==s?"Header background image":2==s?"Header brand image":"Chat button icon")}</h2><div data-type="upload-image" class="sb-setting sb-type-upload-image"><div class="input"><div data-id="${1==s?"background":2==s?"brand":"icon"}" class="image"><i class="sb-icon-close"></i></div></div></div>`;break;case"more":t=`<h2>${o("Department ID")}</h2><div class="sb-setting sb-type-number"><div><input data-id="department" type="number"></div></div><h2>${o("Agent ID")}</h2><div class="sb-setting sb-type-number"><div><input data-id="agent" type="number"></div></div><h2>${o("Tags")}</h2><div class="sb-setting sb-type-text"><div><input data-id="tags" type="text"></div></div><h2>${o("Article IDs")}</h2><div class="sb-setting sb-type-number"><div><input data-id="articles" type="text"></div></div><h2>${o("Articles category")}</h2><div class="sb-setting sb-type-number"><div><input data-id="articles_category" type="text"></div></div>`}W.find(".sb-automation-extra").html(t),W.attr("data-automation-type",e),at.initColorPicker(W),this.hide()},updateActiveItem:function(){let t=this.activeID();if(t){let s=W.find(".sb-language-switcher [data-language].sb-active").attr("data-language"),a=this.activeType(),n=s?s in this.translations?this.translations[s][a]:[]:this.items[a];for(var i=0;i<n.length;i++)if(n[i].id==t){n[i]={id:t,conditions:[]},W.find(".sb-automation-values").find('input,textarea,[data-type="upload-image"] .image').each(function(){n[i][e(this).attr("data-id")]=e(this).hasClass("image")&&e(this)[0].hasAttribute("data-value")?e(this).attr("data-value"):"checkbox"==e(this).attr("type")?e(this).is(":checked"):e(this).val()}),n[i].conditions=this.getConditions(Y),SBF.null(n[i].name)&&this.delete(J.find(`[data-id="${t}"] i`));break}}},getConditions:function(t){let i=[];return t.find(" > div").each(function(){let t=[];e(this).find("input,select").each(function(){t.push(e(this).val())}),t[0]&&t[1]&&(2==t.length||t[2]||["is-set","is-not-set"].includes(t[1]))&&i.push(t)}),i},setConditions:function(e,t){if(t.html(""),e)for(var i in e){this.addCondition(t);let s=t.find(" > div:last-child");s.find("select").val(e[i][0]),this.updateCondition(s.find("select")),s.find(" > div").eq(1).find("select,input").val(e[i][1]),e[i].length>2&&(["is-set","is-not-set"].includes(e[i][1])?s.find(" > div").eq(2).addClass("sb-hide"):s.find(" > div").eq(2).find("input").val(e[i][2]))}},addCondition:function(e){e.append(`<div><div class="sb-setting sb-type-select sb-condition-1"><select>${this.getAvailableConditions()}</select></div></div>`)},updateCondition:function(t){e(t).parent().siblings().remove();let i=e(t).parents().eq(1);if(e(t).val()){let a=this.conditions()[e(t).val()],n="";if(a[1].length){n='<div class="sb-setting sb-type-select sb-condition-2"><select>';for(var s=0;s<a[1].length;s++)n+=`<option value="${SBF.stringToSlug(a[1][s])}">${o(a[1][s])}</option>`;n+="</select></div>"}i.append(n+(a.length>2?`<div class="sb-setting sb-type-text"><input placeholder="${o(a[2])}" type="text"></div>`:"")),i.siblings().find(".sb-condition-1 select").each(function(){let t=e(this).val();e(this).html(at.automations.getAvailableConditions([t])),e(this).val(t)})}else i.remove()},getAvailableConditions:function(t=[],i=[]){let s='<option value=""></option>',a=[],n=this.conditions();Y.find(".sb-condition-1 select").each(function(){a.push(e(this).val())});for(var r in n)i.includes(r)||a.includes(r)&&!t.includes(r)||(s+=`<option value="${r}">${o(n[r][0])}</option>`);return s},addTranslation:function(e=!1,t=!1,i){if(!1===e&&(e=this.activeID()),!1===t&&(t=this.activeType()),this.getTranslations(e).includes(e))return console.warn("Automation translation already in array.");i in this.translations||(this.translations[i]={messages:[],emails:[],sms:[],popups:[],design:[]}),t in this.translations[i]||(this.translations[i][t]=[]),this.translations[i][t].push(this.itemArray(t,e))},getTranslations:function(e=!1){let t=[];!1===e&&(e=this.activeID());for(var i in this.translations){let n=this.translations[i];for(var s in n){let o=n[s];for(var a=0;a<o.length;a++)if(o[a].id==e){t.push(i);break}}}return t},deleteTranslation:function(e=!1,t){if(!1===e&&(e=this.activeID()),t in this.translations){let a=this.translations[t];for(var i in a){let n=a[i];for(var s=0;s<n.length;s++)if(n[s].id==e)return this.translations[t][i].splice(s,1),!0}}return!1},activeID:function(){let e=J.find(".sb-active");return!!e.length&&e.attr("data-id")},activeType:function(){return z.find("li.sb-active").data("value")},itemArray:function(t,i,s="",a=""){return e.extend({id:i,name:s,message:a},"emails"==t?{subject:""}:"popups"==t?{title:"",profile_image:""}:"design"==t?{title:"",color_1:"",color_2:"",color_3:"",background:"",brand:"",icon:""}:{})},hide:function(e=!0){W.find(" > .sb-tab > .sb-content").setClass("sb-hide",e)}},translations:{translations:{},originals:{},to_update:{},add:function(e){let t=at.getSettingObject(fe),i=t.attr("id"),s=fe.find("[data-language].sb-active");this.save(t,!!s.length&&s.attr("data-language")),t.find('textarea,input[type="text"]').val(""),this.save(t,e),fe.remove(),t.sbLanguageSwitcher(this.getLanguageCodes(i),"settings",e)},delete:function(e,t){let i=(e=at.getSettingObject(e)).attr("id");delete this.translations[t][i],e.find(`.sb-language-switcher [data-language="${t}"]`).remove(),this.activate(e)},activate:function(e,t=!1){let i=(e=at.getSettingObject(e)).attr("id"),s=t?this.translations[t][i]:this.originals[i];if(h(s))e.find("input, textarea").val(s);else for(var a in s)e.find("#"+a).find("input, textarea").val(h(s[a])?s[a]:s[a][0])},updateActive:function(){let t=H.find(".sb-translations-list"),i={front:{},admin:{},"admin/js":{},"admin/settings":{}},s=t.attr("data-value");if(!SBF.null(s)){for(var a in i)t.find(' > [data-area="'+a+'"] .sb-setting:not(.sb-new-translation)').each(function(){i[a][e(this).find("label").html()]=e(this).find("input").val()}),t.find('> [data-area="'+a+'"] .sb-new-translation').each(function(){let t=e(this).find("input:first-child").val(),s=e(this).find("input:last-child").val();t&&s&&(i[a][t]=s)});this.to_update[s]=i}},save:function(t,i=!1){t=at.getSettingObject(t);let s={},a=e(t).attr("id");"multi-input"==t.data("type")?t.find(".multi-input-textarea,.multi-input-text").each(function(){s[e(this).attr("id")]=e(this).find("input, textarea").val()}):s=t.find("input, textarea").val(),i?(i in this.translations||(this.translations[i]={}),this.translations[i][a]=s):this.originals[a]=s},load:function(e){let t=H.find(".sb-translations > .sb-content");t.find(" > .sb-hide").removeClass("sb-hide"),this.updateActive(),SBF.ajax({function:"get-translation",language_code:e},i=>{e in this.to_update&&(i=this.to_update[e]);let s="",a=["front","admin","admin/js","admin/settings"];for(var n=0;n<a.length;n++){let e=i[a[n]];s+=`<div${n?"":' class="sb-active"'} data-area="${a[n]}">`;for(var o in e)s+=`<div class="sb-setting sb-type-text"><label>${o}</label><div><input type="text" value="${e[o]}"></div></div>`;s+="</div>"}t.find(".sb-translations-list").attr("data-value",e).html(s),t.find(".sb-menu-wide li").sbActive(!1).eq(0).sbActive(!0),t.sbLoading(!1)}),t.sbLoading(!0)},getLanguageCodes:function(e){let t=[];for(var i in this.translations)e in this.translations[i]&&t.push(i);return t}}},nt={category_list:[],page_url:!1,get:function(e,t=!1,i=!1,s=!0,a=!1){SBF.ajax({function:"get-articles",id:t,categories:i,articles_language:a,full:s},t=>{e(t)})},save:function(e=!1){let t,i=this.activeID();if(!(t={id:i,title:X.find(".sb-article-title input").val(),content:X.find(".sb-article-content textarea").val(),link:X.find(".sb-article-link input").val(),parent_category:ee.val(),category:K.val(),language:X.find(".sb-language-switcher [data-language].sb-active").attr("data-language")}).title&&!t.content)return e(!1);t.language&&(t.parent_id=this.activeID(!0)),tt&&typeof tt.save!==Ke?tt.save().then(i=>{t.editor_js=i,t.content=function(e){let t="";return e.map(e=>{switch(e.type){case"header":t+=`<h${e.data.level}>${e.data.text}</h${e.data.level}>`;break;case"paragraph":t+=`<p>${e.data.text}</p>`;break;case"image":t+=`<img class="img-fluid" src="${e.data.file.url}" title="${e.data.caption}" /><em>${e.data.caption}</em>`;break;case"list":t+='<ul class="sb-ul-'+e.data.style+'">',e.data.items.forEach(function(e){t+=`<li>${e}</li>`}),t+="</ul>";break;case"code":t+=`<code>${e.data.code}</code>`;break;case"raw":t+=`<div class="bxc-raw-html">${e.data.html}</div>`}}),t}(i.blocks),this.save_2(t,e)}).catch(e=>{console.log(e)}):this.save_2(t,e)},save_2:function(e,i=!1){SBF.ajax({function:"save-article",article:JSON.stringify(e)},s=>{let a=!0!==s&&!isNaN(s);if(Pe=!1,a&&(Q.attr("data-id",s),e.id=s,this.viewButton(s),e.language)){let t=nt.translations.get(e.parent_id);Q.find(`.sb-language-switcher [data-language="${e.language}"]`).attr("data-id",s);for(var n=0;n<t.length;n++)if(t[n][0]==e.language){t[n][1]=e.id,nt.translations.list[e.parent_id]=t;break}}e.language||X.find(".ul-articles .sb-active").html(e.title+'<i class="sb-icon-delete"></i>').attr("data-id",e.id),i&&i(s),t(!0===s||a?"Article saved":s)})},show:function(e){e&&(a(Q),this.get(t=>{Q.sbLoading(!1),t=t[0],Q.sbLanguageSwitcher(this.translations.get(t.parent_id?t.parent_id:e),"articles",t.language),Q.attr("data-id",e),X.find(".sb-article-title input").val(t.title),X.find(".sb-article-link input").val(t.link),X.find("#sb-article-id").html(`ID <span>${e}</span>`),X.find(".sb-article-categories").setClass("sb-hide",t.language),tt||X.find("#editorjs").length?u(t.editor_js?h(t.editor_js)?JSON.parse(t.editor_js):t.editor_js:t.content):X.find(".sb-article-content textarea").val(t.content),t.language||(ee.val(t.parent_category),K.val(t.category)),this.viewButton(e),Pe=!1},e))},add:function(){let e=X.find(".ul-articles");e.find(".sb-active").sbActive(!1),e.append('<li class="sb-active"></li>'),Q.sbLanguageSwitcher([],"articles"),this.clear()},clear:function(){Q.removeAttr("data-id").removeClass("sb-hide"),Q.find("input, textarea, select").val(""),Q.find("input").prop("checked",!1),u(),this.viewButton(),Pe=!1},delete:function(e,t=!1){SBF.ajax({function:"save-article",article:JSON.stringify({id:e,delete:!0})},e=>{this.clear(),t&&t(e)})},populate:function(t,i=!1){let s="";for(var a=0;a<t.length;a++)s+=`<li data-id="${t[a].id}">${t[a].title}<i class="sb-icon-delete"></i></li>`;X.find(i?".ul-categories":".ul-articles").html(s),X.find(i?".ul-categories > li":".ul-articles > li").eq(0).click(),t.length||e(i?Z:Q).sbLoading(!1).addClass("sb-hide")},activeID:function(e=!1){return e?X.find(".ul-articles .sb-active").attr("data-id"):Q.attr("data-id")},viewButton:function(e=!1){if(this.page_url){X.find(".sb-view-article").attr("href",e?this.page_url+(this.is_url_rewrite?("/"==this.page_url.charAt(this.page_url.length-1)?"":"/")+(this.cloud_chat_id?this.cloud_chat_id+"/":""):"?article_id=")+e:"")}},categories:{list:[],save:function(e=!1){this.updateActive(),SBF.ajax({function:"save-articles-categories",categories:JSON.stringify(this.list)},i=>{e&&e(i),t(!0===i?"Categories saved":i)})},show:function(t,i=!1){let s=this.getIndex(t);if(!1!==s){let t=i?this.list[s].languages[i]:this.list[s],a=Z.find("#category-image");this.updateActive(),Z.find("#category-title").val(t.title),Z.find("#category-description").val(t.description),Z.find("#category-parent").prop("checked",!!t.parent),Z.sbLanguageSwitcher(e.map(this.list[s].languages,function(e,t){return t}),"article-categories",i),t.image?a.attr("data-value",t.image).css("background-image",`url("${t.image}")`):a.removeAttr("data-value style"),Z.find(".category-parent").setClass("sb-hide",i)}Z.sbLoading(!1)},add:function(){let e=SBF.random();this.list.push({id:e,title:"",description:"",image:"",languages:[]});let t=`<li data-id="${e}">${o("New category")}<i class="sb-icon-delete"></i></li>`;X.find(".ul-categories").append(t),X.find(".ul-categories li").eq(X.find(".ul-categories li").length-1).click(),Z.removeClass("sb-hide")},delete:function(e){let t=this.getIndex(e),i=X.find(".ul-categories");return!1!==t&&(this.list.splice(t,1),i.find(`[data-id="${e}"]`).remove(),i.find("li").eq(0).click(),!0)},update:function(){let e=K.val(),t=ee.val(),i=["","<option></option>"],s=this.list.map(function(e){return e.id});for(var a=0;a<this.list.length;a++)i[this.list[a].parent?0:1]+=`<option value="${this.list[a].id}">${this.list[a].title}</option>`;ee.html(i[0]),K.html(i[1]),this.list.length&&(ee.val(s.includes(t)?t:ee[0].selectedIndex>-1?this.list[ee[0].selectedIndex].id:""),K.val(s.includes(e)?e:K[0].selectedIndex>-1?this.list[K[0].selectedIndex].id:""))},updateActive:function(){let e=this.activeID();if(e){let t=this.getIndex(e),i=Z.find(".sb-language-switcher .sb-active").attr("data-language"),s={title:Z.find("#category-title").val(),description:Z.find("#category-description").val(),image:Z.find("#category-image").attr("data-value")};i?this.list[t].languages[i]=s:(s.id=SBF.stringToSlug(s.title),s.parent=Z.find("#category-parent").is(":checked"),s.languages=this.list[t].languages,this.list[t]=s,X.find(".ul-categories .sb-active").html(s.title+'<i class="sb-icon-delete"></i>').attr("data-id",s.id))}},clear:function(){Z.find("input, textarea").val(""),Z.find("#category-image").removeAttr("data-value style")},getIndex:function(e){for(var t=0;t<this.list.length;t++)if(this.list[t].id==e)return t;return!1},activeID:function(){return X.find(".ul-categories .sb-active").attr("data-id")},translations:{add:function(t,i=!1){nt.categories.updateActive(),i||(i=nt.categories.activeID());let s=nt.categories.getIndex(i);SBF.null(nt.categories.list[s].languages)&&(nt.categories.list[s].languages={}),nt.categories.list[s].languages[t]={title:"",description:"",image:""},Z.sbLanguageSwitcher(e.map(nt.categories.list[s].languages,function(e,t){return t}),"article-categories",t),nt.categories.clear()},delete:function(e,t=!1){let i=nt.categories.activeID();t||(t=nt.categories.activeID(i)),delete nt.categories.list[nt.categories.getIndex(t)].languages[e],nt.categories.show(i)}}},translations:{list:{},add:function(e,t=!1){t||(t=nt.activeID(!0));let i=this.get(t);i.push([e,!1]),this.list[t]=i,Q.sbLanguageSwitcher(i,"articles",e),nt.clear()},delete:function(e,t=!1){t||(t=nt.activeID(!0));let i=this.get(t);for(var s=0;s<i.length;s++)if(i[s][0]==e){nt.delete(i[s][1],e=>{!0===e&&(i.splice(s,1),this.list[t]=i,nt.show(t))});break}return!1},get:function(e){return e in this.list?this.list[e]:[]}}},ot={chart:!1,active_report:!1,active_date_range:!1,initChart:function(e,t="line",i=1){let s=[],a=[],n=SB_ADMIN_SETTINGS.color?[SB_ADMIN_SETTINGS.color]:["#049CFF","#74C4F7","#B9E5FF","#0562A0","#003B62","#1F74C4","#436786"];for(var o in e)s.push(e[o][0]),a.push(o);if("line"!=t&&s.length>6)for(var r=0;r<s.length;r++)n.push("hsl(210, "+Math.floor(100*Math.random())+"%, "+Math.floor(100*Math.random())+"%)");this.chart&&this.chart.destroy(),this.chart=new Chart(Te.find("canvas"),{type:t,data:{labels:a,datasets:s&&Array.isArray(s[0])?[{data:s.map(e=>e[0]),backgroundColor:"#13ca7e"},{data:s.map(e=>e[1]),backgroundColor:"#ca3434"}]:[{data:s,backgroundColor:"line"==t?SB_ADMIN_SETTINGS.color?"#cbcbcb82":"#028be530":n,borderColor:"line"==t?SB_ADMIN_SETTINGS.color?SB_ADMIN_SETTINGS.color:"#049CFF":"#FFFFFF",borderWidth:0}]},options:{legend:{display:!1},scales:{yAxes:[{ticks:{callback:function(e,t,s){return 1==i?e:2==i?new Date(1e3*e).toISOString().substr(11,8):e},beginAtZero:!0}}],xAxes:[{ticks:{beginAtZero:!0}}]},tooltips:{callbacks:{label:function(e,t){let a=e.index,n=t.datasets[e.datasetIndex].data[a];switch(i){case 1:return n;case 2:return new Date(1e3*s[a]).toISOString().substr(11,8);case 3:return n+"%";case 4:let e=Te.find(".sb-table tbody tr").eq(a).find("td");return e.eq(0).text()+" "+e.eq(1).text()}}},displayColors:!1}}})},initTable:function(e,t,i=!1){let s="<thead><tr>",a=t[Object.keys(t)[0]].length-1,n=[];for(r=0;r<e.length;r++)s+=`<th>${e[r]}</th>`;s+="</tr></thead><tbody>";for(var o in t)0!=t[o][a]&&n.push([o,t[o][a]]);i&&n.reverse();for(var r=0;r<n.length;r++)s+=`<tr><td><div>${n[r][0]}</div></td><td>${n[r][1]}</td></tr>`;s+="</tbody>",Te.find("table").html(s)},initReport:function(e=!1,t=!1){let i=Te.find(".sb-tab > .sb-content");t=SBF.null(t)?[!1,!1]:t.split(" - "),i.sbLoading(!0),e&&(this.active_report=e),this.active_report&&(this.active_date_range=t,this.getData(this.active_report,t[0],t[1],e=>{0==e?i.addClass("sb-no-results-active"):(i.removeClass("sb-no-results-active"),this.initChart(e.data,e.chart_type,e.label_type),this.initTable(e.table,e.data,e.table_inverse),Te.find(".sb-reports-title").html(e.title),Te.find(".sb-reports-text").html(e.description),Te.find(".sb-collapse-btn").remove(),We||l(Te.find(".sb-collapse"),Te.find("canvas").outerHeight()-135)),i.sbLoading(!1)}))},getData:function(e,t=!1,i=!1,s){SBF.ajax({function:"reports",name:e,date_start:t,date_end:i,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone},e=>{s(e)})},initDatePicker:function(){let e={ranges:{},locale:{format:"DD/MM/YYYY",separator:" - ",applyLabel:o("Apply"),cancelLabel:o("Cancel"),fromLabel:o("From"),toLabel:o("To"),customRangeLabel:o("Custom"),weekLabel:o("W"),daysOfWeek:[o("Su"),o("Mo"),o("Tu"),o("We"),o("Th"),o("Fr"),o("Sa")],monthNames:[o("January"),o("February"),o("March"),o("April"),o("May"),o("June"),o("July"),o("August"),o("September"),o("October"),o("November"),o("December")],firstDay:1},showCustomRangeLabel:!0,alwaysShowCalendars:!0,autoApply:!0,opens:k.hasClass("sb-rtl")?"left":"right"};e.ranges[o("Today")]=[moment(),moment()],e.ranges[o("Yesterday")]=[moment().subtract(1,"days"),moment().subtract(1,"days")],e.ranges[o("Last 7 Days")]=[moment().subtract(6,"days"),moment()],e.ranges[o("Last 30 Days")]=[moment().subtract(29,"days"),moment()],e.ranges[o("This Month")]=[moment().startOf("month"),moment().endOf("month")],e.ranges[o("Last Month")]=[moment().subtract(1,"month").startOf("month"),moment().subtract(1,"month").endOf("month")],Te.find("#sb-date-picker").daterangepicker(e).val("")},export:function(e){SBF.ajax({function:"reports-export",name:this.active_report,date_start:this.active_date_range[0],date_end:this.active_date_range[1],timezone:Intl.DateTimeFormat().resolvedOptions().timeZone},t=>{e(t)})},open:function(e){x.find(".sb-admin-nav #sb-reports").click(),setTimeout(()=>{Te.find("#"+e).click().get(0).scrollIntoView()},300)}},rt={real_time:null,datetime_last_user:"2000-01-01 00:00:00",sorting:["creation_time","DESC"],user_types:["visitor","lead","user"],user_main_fields:["id","first_name","last_name","email","password","profile_image","user_type","creation_time","token","last_activity","department"],search_query:"",init:!1,busy:!1,table_extra:!1,history:[],get:function(e,t=!1,i=!1){let s=[];for(var n=0;n<q.length;n++)s.push(q.eq(n).find("li.sb-active").data("value"));i||a(U),SBF.ajax({function:t?"get-online-users":"get-users",sorting:t?this.sorting[0]:this.sorting,pagination:!!i&&je,user_types:this.user_types,search:this.search_query,extra:this.table_extra,department:s[0],source:s[1],tag:s[2]},t=>{e(t),U.sbLoading(!1)})},filter:function(e){e="all"==e?["visitor","lead","user"]:"agent"==e?["agent","admin"]:[e],this.user_types=e,je=1,Ge=1,this.get(e=>{this.populate(e)},"online"==e[0])},sort:function(e,t="DESC"){this.sorting=[e,t],je=1,Ge=1,this.get(e=>{this.populate(e)})},search:function(t){c(t,(t,i)=>{je=1,Ge=1,this.search_query=t,this.get(t=>{this.user_types=["visitor","lead","user"],this.populate(t),e(i).sbLoading(!1),P.find("li").sbActive(!1).eq(0).sbActive(!0)})})},populate:function(t){let i="",s=t.length;if(s)for(var a=0;a<s;a++)i+=this.getRow(new SBUser(t[a],t[a].extra));else i=`<p class="sb-no-results">${o("No users found.")}</p>`;U.parent().scrollTop(0),U.find("tbody").html(i),this.user_types.includes("agent")&&SBF.ajax({function:"get-online-users",agents:!0},t=>{let i=[];for(var s=0;s<t.length;s++)i.push(t[s].id);U.find("[data-user-id]").each(function(){e(this).find(".sb-td-profile").addClass("sb-"+(i.includes(e(this).attr("data-user-id"))?"online":"offline"))})})},update:function(){if(!this.busy){let e=["user","visitor","lead","agent"],t=e.includes(this.user_types[0])&&!this.search_query,i=P.find(".sb-active").data("type");"online"==i?this.filter(i):(this.busy=!0,SBF.ajax({function:"get-new-users",datetime:this.datetime_last_user},s=>{let a=s.length;if(this.busy=!1,a>0){let o="";for(n=0;n<a;n++){let e=new SBUser(s[n]);Re[e.id]=e,this.updateMenu("add",e.type),t&&(o+=this.getRow(e))}if(t&&(U.find("tbody").prepend(o),e.includes(i))){let t="";for(var n=0;n<e.length;n++)t+=e[n]==i?"":`[data-user-type="${e[n]}"],`;U.find(t.slice(0,-1)).remove()}this.datetime_last_user=s[0].creation_time}}))}},getRow:function(e){if(e instanceof SBUser){let i="";for(var t=0;t<this.table_extra.length;t++){let s=this.table_extra[t];i+=`<td class="sb-td-${s}">${this.user_main_fields.includes(s)?e.get(s):e.getExtra(s)}</td>`}return`<tr data-user-id="${e.id}" data-user-type="${e.type}"><td><input type="checkbox" /></td><td class="sb-td-profile"><a class="sb-profile"><img loading="lazy" src="${e.image}" /><span>${e.name}</span></a></td>${i}<td class="sb-td-email">${e.get("email")}</td><td class="sb-td-ut">${o(e.type)}</td><td>${SBF.beautifyTime(e.get("last_activity"),!0)}</td><td>${SBF.beautifyTime(e.get("creation_time"))}</td></tr>`}return SBF.error("User not of type SBUser","SBUsers.getRow"),!1},updateRow:function(e){let t=U.find(`[data-user-id="${e.id}"]`);if(t.length){let i=P.find(".sb-active").data("type");if(e.type==i||"admin"==e.type&&"agent"==i||"all"==i)t.replaceWith(this.getRow(e));else{let i=k.find(`[data-type="${"admin"==e.type?"agent":e.type}"] span`),s=parseInt(i.attr("data-count"));i.html(s+1).attr("data-count",s+1),t.remove()}}else U.find("tbody").append(this.getRow(e))},updateMenu:function(e="all",t=!1){let i=["all","user","lead","visitor"];"all"==e?SBF.ajax({function:"count-users"},e=>{for(var t=0;t<i.length;t++)this.updateMenuItem("set",i[t],e[i[t]])}):this.updateMenuItem(e,t)},updateMenuItem:function(e="set",t=!1,i=1){let s=P.find(`[data-type="${t}"] span`),a=["user","lead","visitor"];"set"!=e&&(i=parseInt(s.attr("data-count"))+1*("add"==e?1:-1)),s.html(`(${i})`).attr("data-count",i),i=0;for(var n=0;n<a.length;n++)i+=parseInt(P.find(`[data-type="${a[n]}"] span`).attr("data-count"));P.find('[data-type="all"] span').html(`(${i})`).attr("data-count",i)},delete:function(e){if(a(U),Array.isArray(e)){if(SB_ADMIN_SETTINGS.cloud&&!(e=SBCloud.removeAdminID(e)).length)return;SBF.ajax({function:"delete-users",user_ids:e},()=>{for(var i=0;i<e.length;i++)delete Re[e[i]],U.find(`[data-user-id="${e[i]}"]`).remove(),C.find(`[data-user-id="${e[i]}"]`).remove(),SBF.event("SBUserDeleted",e[i]);0==U.find("[data-user-id]").length&&this.filter(P.find(".sb-active").data("type")),t("Users deleted"),this.updateMenu(),U.sbLoading(!1)})}else Re[e].delete(()=>{let i=C.find(`[data-user-id="${e}"]`);s().id==e&&s(!1),i.sbActive()&&(SBChat.conversation=!1,setTimeout(()=>{lt.clickFirst()},300)),delete Re[e],U.find(`[data-user-id="${e}"]`).remove(),i.remove(),k.sbHideLightbox(),t("User deleted"),this.updateMenu(),U.sbLoading(!1)})},startRealTime:function(){SBPusher.active||(this.stopRealTime(),this.real_time=setInterval(()=>{this.update()},1e3))},stopRealTime:function(){clearInterval(this.real_time)},csv:function(){SBF.ajax({function:"csv-users",users_id:rt.getSelected()},e=>{_(e,"sb-export-users-close","Users exported"),window.open(e)})},updateUsersActivity:function(){SBF.updateUsersActivity(Qe?SB_ACTIVE_AGENT.id:-1,s()?s().id:-1,function(e){rt.setActiveUserStatus("online"==e)})},setActiveAgentStatus:function(e=!0){let t=e?"online":"offline";Qe=e,x.find('[data-value="status"]').html(o(SBF.slugToString(t))).attr("class","sb-"+t),SBPusher.active&&(e?(SBPusher.presence(),"queue"!=SB_ADMIN_SETTINGS.routing&&"routing"!=SB_ADMIN_SETTINGS.routing||SBF.ajax({function:"assign-conversations-active-agent",is_queue:"queue"==SB_ADMIN_SETTINGS.routing},()=>{lt.update()})):SBPusher.presenceUnsubscribe()),SB_ADMIN_SETTINGS.reports_disabled||SBF.ajax({function:"reports-update",name:t})},setActiveUserStatus:function(e=!0){let t=A.find(".sb-conversation .sb-top > .sb-labels");t.find(".sb-status-online").remove(),e&&t.prepend(`<span class="sb-status-online">${o("Online")}</span>`),SBChat.user_online=e},onlineUserNotification:function(e){let t=SB_ADMIN_SETTINGS.online_users_notification;if(t){let i=e.info.first_name+" "+e.info.last_name,s=this.userProfileImage(e.info.profile_image);SB_ADMIN_SETTINGS.push_notifications&&e.info.id&&!this.history.includes(e.info.id)?SBF.ajax({function:"push-notification",title:t,message:i,icon:s,interests:SB_ACTIVE_AGENT.id,user_id:e.info.id}):lt.desktop_notifications&&SBChat.desktopNotification(t,i,s,!1,e.info.id),this.history.push(e.info.id)}},userProfileImage:function(e){return!e||e.indexOf("user.svg")?SB_ADMIN_SETTINGS.notifications_icon:e},getSelected:function(){let t=[];return U.find("tr").each(function(){e(this).find('td input[type="checkbox"]').is(":checked")&&t.push(e(this).attr("data-user-id"))}),t},getExtraDetailsList:function(t=!1){return V.find(".sb-additional-details .sb-edit-box > "+(t?".sb-custom-detail":".sb-input")).map(function(){return[[e(this).attr("id"),e(this).find("span").html().trim()]]}).get()}},lt={real_time:null,datetime_last_conversation:!1,user_typing:!1,desktop_notifications:!1,flash_notifications:!1,busy:!1,busy_2:!1,is_search:!1,menu_count_ajax:!1,previous_editor_text:!1,open:function(e=-1,t){-1!=e&&this.openConversation(e,t),k.sbHideLightbox(),x.find(".sb-admin-nav a").sbActive(!1).parent().find("#sb-conversations").sbActive(!0),k.find(" > main > div").sbActive(!1),A.sbActive(!0).find(".sb-board").removeClass("sb-no-conversation"),Ie.find(" > p").attr("data-id","").attr("data-value","").html(o("None")),this.notes.update([]),this.tags.update([]),this.startRealTime()},openConversation:function(i,a=!1,n=!0){if(SBChat.label_date.sbActive(!1),SBChat.label_date_show=!1,this.busy_2!=i)if(!1===a&&i)this.busy_2=i,SBF.ajax({function:"get-user-from-conversation",conversation_id:i},e=>{this.busy_2=!1,SBF.null(e.id)?this.clickFirst():this.openConversation(i,e.id,n)});else{let r=SBF.null(Re[a])||!Re[a].details.email,l=A.find(`[data-conversation-id="${i}"]`),c=C.find("li");T.html(""),T.sbLoading(!0),r?(s(new SBUser({id:a})),s().update(()=>{Re[a]=s(),this.updateUserDetails()})):(s(Re[a]),this.updateCurrentURL()),SBPusher.active&&(SBPusher.event("client-typing",e=>{e.user_id==s().id&&(lt.typing(!0),clearTimeout(me),me=setTimeout(()=>{lt.typing(!1)},1e3))}),SBPusher.event("new-message",()=>{SBChat.update()}),SBPusher.event("agent-active-conversation-changed",e=>{e.previous_conversation_id==i&&A.find(".sb-conversation-busy").remove()},"agents"),SBPusher.event("init",e=>{lt.updateCurrentURL(e.current_url)}),SBPusher.event("message-status-update",e=>{SBChat.conversation&&SBChat.conversation.updateMessagesStatus(e.message_ids)})),SB_ADMIN_SETTINGS.smart_reply&&R.html(""),c.sbActive(!1),SB_ADMIN_SETTINGS.departments_show||c.attr("data-color",""),l.sbActive(!0),-1!=i?(this.busy_2=i,s().getFullConversation(i,a=>{let r=a.status_code,d=F.eq(0),u=d.find(".sb-active").attr("data-value");if(this.busy_2=!1,SBChat.setConversation(a),SBChat.populate(),this.setReadIcon(r),A.find(".sb-conversation-busy").remove(),this.updateUserDetails(),A.find(".sb-top > a").html(a.get("title")),dt.must_translate=SB_ADMIN_SETTINGS.translation&&s().language&&SB_ADMIN_SETTINGS.active_agent_language!=s().language,dt.must_translate){let e=[],t=[],s=[],n=[];for(f=0;f<a.messages.length;f++){let i=a.messages[f];i.message&&(i.payload("original-message")&&(!i.payload("original-message-language")||i.payload("original-message-language")==SB_ADMIN_SETTINGS.active_agent_language)||i.payload("translation")&&(!i.payload("translation-language")||i.payload("translation-language")==SB_ADMIN_SETTINGS.active_agent_language)?n.push(i):(e.push(i.message),t.push(i.id),s.push(i.get("user_type"))))}e.length?st.dialogflow.translate(e,SB_ADMIN_SETTINGS.active_agent_language,e=>{if(e)for(var i=0;i<e.length;i++){let a=SBChat.conversation.getMessage(t[i]);a.payload("translation",e[i]),a.payload("translation-language",SB_ADMIN_SETTINGS.active_agent_language),this.openConversation_2(t[i],s[i])}SB_ADMIN_SETTINGS.smart_reply&&this.openConversation_1(SBChat.conversation,R)},t,i):SB_ADMIN_SETTINGS.smart_reply&&this.openConversation_1(SBChat.conversation,R);for(f=0;f<n.length;f++)this.openConversation_2(n[f].id,n[f].get("user_type"))}if(Ie.length){let e=!!a.get("department")&&this.getDepartments(a.get("department")),t=e?e["department-color"]:"";SB_ADMIN_SETTINGS.departments_show||c.attr("data-color",""),w(i).attr("data-color",t),Ie.find(" > p").attr("data-id",e?e["department-id"]:"").attr("data-value",t).html(e?e["department-name"]+"<span></span>":o("None"))}let p=A.find("#conversation-agent");if(p.length){let e=p.find(`[data-id="${a.get("agent_id")}"]`);p.find(" > p").attr("data-value",e.data("id")).html(e.html())}[1,2,"1","2"].includes(r)&&(r=0),u==r||e($).find(".sb-search-btn").sbActive()||lt.filters()[1]||lt.filters()[3]||(d.find(`[data-value="${r}"]`).click(),d.find("ul").sbActive(!1)),We&&this.mobileOpenConversation(),l.length||u!=r&&(0!=u||1!=r)||C.prepend(lt.getListCode(a)),C.find("li").sbActive(!1),l.sbActive(!0),n&&this.scrollTo(),this.notificationsCounterReset(i,l),T.sbInitTooltips();let h=a.get("busy");h&&A.find(".sb-editor > .sb-labels").prepend(`<span data-agent="${h.id}" class="sb-status-warning sb-conversation-busy">${h.first_name} ${h.last_name} ${o("is replying to this conversation")}</span>`),st.is("woocommerce")&&st.woocommerce.conversationPanel(),st.is("ump")&&st.ump.conversationPanel(),st.is("perfex")&&st.perfex.conversationPanel(),st.is("whmcs")&&st.whmcs.conversationPanel(),st.is("aecommerce")&&st.aecommerce.conversationPanel(),st.is("martfury")&&st.martfury.conversationPanel(),st.is("armember")&&st.armember.conversationPanel(),st.is("zendesk")&&st.zendesk.conversationPanel(),st.is("opencart")&&st.opencart.conversationPanel(),s()&&SB_ADMIN_SETTINGS.cloud&&(SBCloud.shopify.panel&&SBCloud.shopify.panel.html(""),SBCloud.shopify.conversationPanel()),this.notes.update(a.details.notes),this.tags.update(a.details.tags),this.attachments(),SB_ADMIN_SETTINGS.smart_reply&&!dt.must_translate&&this.openConversation_1(a,R);for(f=a.messages.length-1;f>0;f--){let e=a.messages[f].get("payload");if(e.rating){A.find(".sb-profile-list > ul").append(`<li data-id="rating"><i class="sb-icon sb-icon-${1==e.rating?"like":"dislike"}"></i><span>${o("User rating")}</span><label>${o(1==e.rating?"Helpful":"Not helpful")}${e.message?" - "+e.message:""}</label></li>`);break}}if("em"==a.get("source")&&this.cc(a.get("extra").split(",")),"wa"==a.get("source")){let e=a.getLastUserMessage();e&&new Date-new Date(e.get("creation_time").replace(" ","T"))>864e5&&t(o("You can't send a WhatsApp message more than 24 hours after the user's last messageâuse a template instead.")+'<i id="sb-whatsapp-alert-btn" class="sb-icon-social-wa"</i>',"info")}if(k.on("click","#sb-whatsapp-alert-btn",function(){lt.showDirectMessageBox("whatsapp",[s().id])}),s().getConversations(function(e){A.find(".sb-user-conversations").html(1==e.length?"":s().getConversationsCode(e)).prev().setClass("sb-hide",1==e.length)}),this.is_search){let t=$.find(".sb-search-btn input").val();for(var f=0;f<a.messages.length;f++)if(a.messages[f].message.toLowerCase().includes(t)){let t=a.messages[f].id;setTimeout(()=>{let i="";T.find("> div").each(function(){let s=e(this);s.attr("data-id")==t?(s.addClass("sb-highlight"),setTimeout(()=>{s.removeClass("sb-highlight")},3600),SBChat.label_date.html(i),SBChat.label_date_show=!0,s.index()?s.prev()[0].scrollIntoView():s[0].scrollIntoView()):s.hasClass("sb-label-date")&&(i=s.html())})},300)}}T.sbLoading(!1)})):(SBChat.clear(),C.find("li").sbActive(!1),T.sbLoading(!1),A.find(".sb-top > a").html(""),r||this.updateUserDetails()),A.find(".sb-board").removeClass("sb-no-conversation"),lt.previous_editor_text=!1,rt.updateUsersActivity(),this.startRealTime(),SBF.getURL("conversation")!=i&&-1!=i&&f("?conversation="+i)}},openConversation_1:function(e,t){let i=e.getLastUserMessage();t.html(""),i&&i.payload("sb-human-takeover")&&(i=e.getLastUserMessage(i.get("index"))),i&&st.dialogflow.smartReply(i.message)},openConversation_2:function(e,t){let i=SBChat.conversation.getMessage(e);if(i){let s=SBF.isAgent(t)&&"bot"!=t;T.find(`[data-id="${e}"]`).replaceWith(i.getCode()),T.find(`[data-id="${e}"] .sb-menu`).prepend(`<li data-value="${s?"translation":"original"}">${o(s?"View translation":"View original message")}</li>`)}},populate:function(e,t,i){this.openConversation(e,t,i)},populateList:function(e){let t="";Ce=[];for(var i=0;i<e.length;i++)t+=this.getListCode(e[i]),Ce.push(new SBConversation([new SBMessage(e[i])],e[i]));t||(t=`<p class="sb-no-results">${o("No conversations found.")}</p>`),C.html(t),this.updateMenu(),SBF.event("SBAdminConversationsLoaded",{conversations:e})},update:function(){if(!this.busy&&0==F.eq(0).find("p").attr("data-value")&&this.datetime_last_conversation){let t=lt.filters();if(this.busy=!0,SBF.ajax({function:"get-new-conversations",datetime:this.datetime_last_conversation,department:t[1],source:t[2],tag:t[3],agent_id:t[4]},t=>{if(this.busy=!1,t.length){let n,o="",r="",l=SBChat.conversation?SBChat.conversation.id:-1,c=!1,d=[];t[0].last_update_time&&(this.datetime_last_conversation=t[0].last_update_time);for(i=0;i<t.length;i++)if(!d.includes(t[i].id)){let e=new SBMessage(t[i]),a=new SBConversation([e],t[i]),u=a.status_code,p=2==u||SB_ADMIN_SETTINGS.order_by_date&&(0==u||1==u),h=a.user_id,f=a.id,g=w(f),b=g.length,v=e.get("user_type"),m=a.get("message"),_=l==f,S=!SBF.isAgent(v);if(!m&&e.payload("preview")&&(m=e.payload("preview")),p&&(!_||"hidden"==SBF.visibility_status)&&(S||e.payload("human-takeover-message-confirmation"))){let t=SBF.storage("notifications-counter");t||(t={}),t[f]||(t[f]=[]),t[f].includes(e.id)||(t[f].push(e.id),SBF.storage("notifications-counter",t))}let y=this.getListCode(a,null);_?(this.updateUserDetails(),b?(m&&g.replaceWith(y),this.setStatus(u,f)):c=!0):b&&(Ce[g.index()]=a,w(f).remove()),h in Re||(Re[h]=new SBUser({id:h,first_name:a.get("first_name"),last_name:a.get("last_name"),profile_image:a.get("profile_image"),user_type:v})),_&&b||(p?(o+=y,Ce.unshift(a)):0!=u&&1!=u||((n=C.find('[data-conversation-status="2"]').last()).length?(Ce.splice(n.index()+1,0,a),r+=y):o+=y),s()&&h==s().id&&s().getConversations(e=>{A.find(".sb-user-conversations").html(s().getConversationsCode(e))}),SBF.event("SBAdminNewConversation",{conversation:a})),!s()||"update-user"!=e.payload("event")&&Re[h].type==v||s().update(()=>{this.updateUserDetails(),Re[s().id]=s()});let k=e.payload("preview");if(!SBChat.tab_active&&2==u&&(S||k)&&(m||a.getAttachments().length||k)){if(this.desktop_notifications){let e=[Re[h].nameBeautified,Re[h].image];SBChat.desktopNotification(e[0],k||m,e[1],f,h)}this.flash_notifications&&SBChat.flashNotification(),SBChat.audio&&SB_ADMIN_SETTINGS.sound&&SBChat.playSound()}d.push(f)}lt.is_search||(o&&C.prepend(o),r&&e(r).insertAfter(n),c&&this.scrollTo(),this.updateMenu());for(var i=0;i<SBChat.notifications.length;i++){let e=!1;for(var a=0;a<Ce.length;a++)if(Ce[a].id==SBChat.notifications[i][0]){e=2==Ce[a].status_code;break}e||(SBChat.notifications.splice(i,1),i--)}}}),SB_ADMIN_SETTINGS.assign_conversation_to_agent||SB_ACTIVE_AGENT.department){let t=C.find(" > li").map(function(){return e(this).attr("data-conversation-id")}).get();t.length&&SBF.ajax({function:"check-conversations-assignment",conversation_ids:t,agent_id:!!SB_ADMIN_SETTINGS.assign_conversation_to_agent&&SB_ACTIVE_AGENT.id,department:SB_ACTIVE_AGENT.department},e=>{if(e)for(var t=0;t<e.length;t++)w(e[t]).remove()})}}},updateMenu:function(){let e=C.find('[data-conversation-status="2"]').length,t=F.eq(0),i=t.find(" > p span");if(100==e||this.menu_count_ajax||SB_ADMIN_SETTINGS.order_by_date){let e=t.find("li.sb-active").data("value");this.menu_count_ajax=!0,SBF.ajax({function:"count-conversations",status_code:0==e?2:e},e=>{i.html(`(${e})`)})}else i.html(`(${e})`)},messageMenu:function(e,t=!1,i=!1){return`<i class="sb-menu-btn sb-icon-menu"></i><ul class="sb-menu">${(t&&SB_ADMIN_SETTINGS.chatbot_features?`<li data-value="bot">${o("Train chatbot")}</li>`:"")+(e&&!SB_ADMIN_SETTINGS.supervisor&&SB_ADMIN_SETTINGS.allow_agent_delete_message||SB_ADMIN_SETTINGS.supervisor&&SB_ADMIN_SETTINGS.allow_supervisor_delete_message?`<li data-value="delete">${o("Delete")}</li>`:"")+(i?`<li data-value="reply">${o("Reply")}</li>`:"")}</ul>`},updateUserDetails(){s()&&(A.find(`[data-user-id="${s().id}"] .sb-name`).html(s().name),A.find(".sb-top > a").html(SBChat.conversation?SBChat.conversation.title:s().name),I.find(".sb-profile").setProfile(),ct.populate(s(),A.find(".sb-profile-list")))},setReadIcon(e){let t=2==e;A.find('.sb-top [data-value="read"],.sb-top [data-value="unread"]').sbActive([0,1,2].includes(parseInt(e))).attr("data-value",t?"read":"unread").attr("data-sb-tooltip",o(t?"Mark as read":"Mark as unread")).parent().sbInitTooltips().find("i").attr("class",t?"sb-icon-check-circle":"sb-icon-circle")},setStatus(e,t=!1,i=!1){t||(t=SBChat.conversation.id),t&&(Ce[w(t).index()].set("status_code",e),this.setReadIcon(e),i&&C.find(`[data-conversation-id="${t}"]`).attr("data-conversation-status",e))},getListCode:function(e,t){e instanceof SBConversation||(e=new SBConversation([new SBMessage(e)],e));let i=e.getCode(!0),s=SB_ADMIN_SETTINGS.tags_show?e.get("tags"):"",a=e.get("department"),n="",o=e.get("last_update_time"),r=SBChat.conversation&&SBChat.conversation.id==e.id;return SBF.null(t)&&(t=e.status_code),s&&(s=lt.tags.codeLeft(s)),SBChat.conversation&&r&&"hidden"!=SBF.visibility_status||((n=SBF.storage("notifications-counter"))&&n[e.id]&&n[e.id].length?2==t?n=`<span class="sb-notification-counter">${n[e.id].length}</span>`:(n[e.id]=[],SBF.storage("notifications-counter",n),n=""):n=""),o||(o=e.getLastMessage()?e.getLastMessage().get("creation_time"):e.get("creation_time")),`<li${r?' class="sb-active"':""} data-user-id="${e.get("user_id")}" data-conversation-id="${e.id}" data-conversation-status="${t}"${a?` data-department="${a}"${SB_ADMIN_SETTINGS.departments_show?' data-color="'+this.getDepartments(a)["department-color"]+'"':""}`:""}${SBF.null(e.get("source"))?"":` data-conversation-source="${e.get("source")}"`}>${""+n}<div class="sb-profile"><img loading="lazy" src="${e.get("profile_image")}"><span class="sb-name">${e.get("first_name")+" "+e.get("last_name")}</span>${s}<span class="sb-time">${SBF.beautifyTime(o)}</span></div><p>${i}</p></li>`},startRealTime:function(){SBPusher.active||(this.stopRealTime(),this.real_time=setInterval(()=>{this.update(),this.updateCurrentURL()},1e4),SBChat.startRealTime())},stopRealTime:function(){clearInterval(this.real_time),SBChat.stopRealTime()},transcript:function(e,t,i=!1,a=!1){SBF.ajax({function:"transcript",conversation_id:e},e=>{"email"==i?s()&&s().id==t&&!s().get("email")||SBChat.sendEmail(SB_ADMIN_SETTINGS.transcript_message,[[e,e]],t,t=>{a&&a(!0===t?e:t)}):(a&&a(e),window.open(e))})},typing:function(e){e?(SBChat.user_online||rt.setActiveUserStatus(!0),this.user_typing||(A.find(".sb-conversation .sb-top > .sb-labels").append('<span class="sb-status-typing">'+o("Typing")+"</span>"),this.user_typing=!0)):this.user_typing&&(A.find(".sb-conversation .sb-top .sb-status-typing").remove(),this.user_typing=!1)},scrollTo:function(){let e=C.find(".sb-active"),t=e.length?e[0].offsetTop:0;C.parent().scrollTop(t-(We?120:80))},search:function(t){t&&c(t,(t,i)=>{if(Me=1,t.length>1)SBF.ajax({function:"search-conversations",search:t},t=>{lt.populateList(t),e(i).sbLoading(!1),this.scrollTo(),this.is_search=!0});else{let t=lt.filters();De=1,SBF.ajax({function:"get-conversations",status_code:t[0],department:t[1],source:t[2],tag:t[3],agent_id:t[4]},t=>{lt.populateList(t),e(i).sbLoading(!1),this.is_search=!1,SBChat.conversation&&(w(SBChat.conversation.id).sbActive(!0),this.scrollTo())})}})},notificationsCounterReset:function(e,t=!1){let i=SBF.storage("notifications-counter");if(i&&i[e]){t||(t=C.find('[data-conversation-id="'+e+'"]'));let s=t.find(".sb-notification-counter");i[e]=[],SBF.storage("notifications-counter",i),s.addClass("sb-fade-out"),setTimeout(()=>{s.remove()},200)}},updateCurrentURL:function(e=!1){e?this.ucurl(e):SBChat.user_online&&s()&&s().getExtra("current_url")&&SBF.ajax({function:"current-url"},e=>{e&&this.ucurl(e)})},ucurl(e){let t=s().getExtra("current_url");e=b(e),A.find('.sb-profile-list [data-id="current_url"] label').attr("data-value",e).html(e),t&&(t.value=e,s().setExtra("current_url",t))},assignDepartment:function(e,t,i){SBF.ajax({function:"update-conversation-department",conversation_id:e,department:t,message:SBChat.conversation.getLastMessage().message},e=>{i(e)})},assignAgent:function(e,t,i=!1){SBF.ajax({function:"update-conversation-agent",conversation_id:e,agent_id:t,message:SBChat.conversation.getLastMessage().message},e=>{i&&i(e)})},setActiveDepartment:function(e){if(SBChat.conversation&&SBChat.conversation.get("department")==e)return;let i=!!e&&this.getDepartments(e),s=i?i["department-color"]:"",a=w(SBChat.conversation.id),n=lt.filters()[1];Ie.find(" > p").attr("data-id",i?i["department-id"]:"").attr("data-value",s).html((i?i["department-name"]:o("None"))+"<span></span>").next().sbActive(!1),SBChat.conversation.set("department",e),n&&n!=e||"agent"==SB_ACTIVE_AGENT.user_type&&SB_ACTIVE_AGENT.department&&SB_ACTIVE_AGENT.department!=e?(a.remove(),lt.clickFirst()):a.attr("data-color",s),t("Department updated. The agents have been notified.")},getDepartments:function(e=!1){if(e){for(var t=0;t<SB_ADMIN_SETTINGS.departments.length;t++)if(SB_ADMIN_SETTINGS.departments[t]["department-id"]==e)return SB_ADMIN_SETTINGS.departments[t];return!1}return SB_ADMIN_SETTINGS.departments},setActiveAgent:function(e){let i=A.find("#conversation-agent"),s=i.find(`[data-id="${e}"]`);SBChat.conversation.set("agent_id",e),i.find(" > p").attr("data-value",s.data("id")).html(s.html()).next().sbActive(!1),"agent"!=SB_ACTIVE_AGENT.user_type||SB_ADMIN_SETTINGS.assign_conversation_to_agent&&!e||(w(SBChat.conversation.id).remove(),lt.clickFirst()),e&&t("Agent assigned. The agent has been notified.")},getSelectedConversations:function(){return C.find(".sb-active").map(function(){return{id:e(this).attr("data-conversation-id"),user_id:e(this).attr("data-user-id"),status_code:e(this).attr("data-conversation-status")}}).toArray()},mobileOpenConversation:function(){A.find(".sb-admin-list").sbActive(!1),B.sbActive(!0),x.addClass("sb-hide")},mobileCloseConversation:function(){C.find("li.sb-active").sbActive(!1),A.find(".sb-admin-list").sbActive(!0),A.find(".sb-conversation,.sb-user-details").removeClass("sb-active"),k.find('.sb-menu-mobile [data-value="panel"]').sbActive(!1),x.removeClass("sb-hide"),window.history.replaceState({},document.title,SBF.URL())},clickFirst:function(e=!1){e||(e=C.find("li:first-child")),e.length?(e.click(),lt.scrollTo()):(A.find(".sb-board").addClass("sb-no-conversation"),C.find("li").length||C.html(`<p class="sb-no-results">${o("No conversations found.")}</p>`),SBF.getURL("conversation")&&window.history.replaceState({},document.title,SBF.URL().replace("?conversation="+SBF.getURL("conversation"),"")))},savedReplies:function(t,i){let s=i.charAt(t.selectionStart-1),a=i.substr(0,i.lastIndexOf("#"));if("#"==s){if(i.length>1&&"#"==i.charAt(t.selectionStart-2))return e(t).val(a.substr(0,a.length-1)),B.find(".sb-btn-saved-replies").click();SBChat.editor_listening=!0}if(SBChat.editor_listening&&" "==s){let s=i.substr(i.lastIndexOf("#")+1).replace(" ","");SBChat.editor_listening=!1;for(var n=0;n<Ne.length;n++)if(Ne[n]["reply-name"]==s)return void e(t).val(a+Ne[n]["reply-text"])}},attachments:function(){if(L.length){let i=SBChat.conversation.getAttachments(),s="",a="",n=[];for(t=i.length-1;t>-1;t--){let e=SBF.getFileType(i[t][1]);s+=`<a href="${i[t][1]}" target="_blank"><i class="sb-icon sb-icon-download"></i>${i[t][0]}</a>`,n.includes(e)||n.push(e)}if(i.length>4&&n.length>1){a=`<div id="sb-attachments-filter" class="sb-select"><p>${o("All")}</p><ul><li data-value="">${o("All")}</li>`;for(var t=0;t<n.length;t++)a+=`<li data-value="${n[t]}">${o(SBF.slugToString(n[t])+"s")}</li>`;a+="</ul></div>"}e(L).html(s?`<h3${a?' class="sb-flex"':""}>${o("Attachments")}${a}</h3><div class="sb-list-items sb-list-links sb-list-icon">${s}</div>`:""),l(L,160)}},filters:function(){let e=[];for(var t=0;t<F.length;t++)e.push(F.eq(t).find("li.sb-active").data("value"));return e},notes:{busy:!1,add:function(e,t,i,s,a=!1,n=!1){SBF.ajax({function:n?"update-note":"add-note",conversation_id:e,user_id:t,note_id:n,name:i,message:s},e=>{a&&a(e)})},update:function(e,t=!1){if(N.length){let s="",a=N.find(" > div");if(e){for(var i=0;i<e.length;i++){let t=e[i];s+=`<div data-id="${t.id}"><span${SB_ADMIN_SETTINGS.notes_hide_information?' class="sb-note-hide-info"':""}>${SB_ADMIN_SETTINGS.notes_hide_information?"":t.name}${SB_ADMIN_SETTINGS.notes_hide_information||!t.date?"":`<span>${SBF.beautifyTime(t.date,!0)}</span>`}${SB_ACTIVE_AGENT.id==t.user_id?'<i class="sb-edit-note sb-icon-edit"></i><i class="sb-delete-note sb-icon-close"></i>':""}</span><span class="sb-note-text">${t.message.replace(/\n/g,"<br>")}</span></div>`}s=s.autoLink({target:"_blank"})}t?a.append(s):a.html(s),a.attr("style",""),N.find(".sb-collapse-btn").remove(),l(N,155),this.busy=!1}},delete:function(e,t,i=!1){this.busy||(this.busy=!0,SBF.ajax({function:"delete-note",conversation_id:e,note_id:t},e=>{this.busy=!1,i&&i(e)}))}},tags:{busy:!1,update:function(e){if(E.length){let i="",s=E.find(" > div");for(var t=0;t<e.length;t++){let s=this.get(e[t]);s&&(i+=this.code(s))}s.html(i),this.busy=!1}},get:function(e){for(var t=0;t<SB_ADMIN_SETTINGS.tags.length;t++)if(e==SB_ADMIN_SETTINGS.tags[t]["tag-name"])return SB_ADMIN_SETTINGS.tags[t]},getAll:function(e=[]){let t="";for(var i=0;i<SB_ADMIN_SETTINGS.tags.length;i++)t+=this.code(i,e.includes(SB_ADMIN_SETTINGS.tags[i]["tag-name"]));return t},code:function(e,t){let i=isNaN(e)?e:SB_ADMIN_SETTINGS.tags[e];if(i){let e=i["tag-name"];return`<span data-value="${e}" data-color="${i["tag-color"]}"${t?' class="sb-active"':""}>${o(e)}</span>`}return""},codeLeft:function(e){let t='<span class="sb-tags-area">';for(var i=0;i<e.length;i++){let s=this.get(e[i]);s&&(t+=`<i class="sb-icon-tag" data-color-text="${s["tag-color"]}"></i>`)}return t+"</span>"}},showDirectMessageBox:function(e,t=[]){if("whatsapp"==e)m(t);else{let i="custom_email"==e;SBForm.clear(D),D.find(".sb-direct-message-users").val(t.length?t.join(","):"all"),D.find(".sb-bottom > div").html(""),D.find(".sb-top-bar > div:first-child").html(o(`Send a ${{sms:"text message",custom_email:"email",message:"chat message"}[e]}`)),D.find(".sb-loading").sbLoading(!1),D.find(".sb-direct-message-subject").sbActive(i).find("input").attr("required",i),D.attr("data-type",e),D.sbShowLightbox()}},getDeliveryFailedMessage:function(e){return`<i class="sb-icon-warning sb-delivery-failed" data-sb-tooltip="${o("Message not delivered to {R}.").replace("{R}",st.getName(e))}" data-sb-tooltip-init></i>`},cc:function(e){let t="";for(var i=0;i<e.length;i++)e[i]&&(t+=`<li data-id="cc"><i class="sb-icon sb-icon-envelope"></i><span>CC</span><label>${e[i]}</label></li>`);A.find('[data-id="cc"]').remove(),A.find('[data-id="email"]').attr("data-em","true").after(t)}},ct={getAll:function(e){return SBForm.getAll(e)},get:function(e){return SBForm.get(e)},set:function(e,t){return SBForm.set(e,t)},show:function(e){n(),s(new SBUser({id:e})),s().update(t=>{t?(this.populate(s(),O.find(".sb-profile-list")),O.find(".sb-profile").setProfile(),s().getConversations(t=>{let i=s().type,a=s().getConversationsCode(t);SBF.isAgent(i)&&this.agentData(),O.find(".sb-user-conversations").html(a).prev().setClass("sb-hide",!a),O.find(".sb-top-bar [data-value]").sbActive(!1),SBF.null(s().get("email"))||O.find('.sb-top-bar [data-value="email"]').sbActive(!0),s().getExtra("phone")&&(SB_ADMIN_SETTINGS.sms&&O.find('.sb-top-bar [data-value="sms"]').sbActive(!0),O.find('.sb-top-bar [data-value="whatsapp"]').sbActive(!0)),this.boxClasses(O,i),O.attr("data-user-id",s().id).sbShowLightbox(),n(!1,!1),SBF.event("SBProfileBoxOpened",{user_id:e})}),Re[e]=s(),SBF.getURL("user")==e||SBF.getURL("conversation")||f("?user="+e)):k.sbHideLightbox()})},showEdit:function(e){if(!(e instanceof SBUser))return SBF.error("User not of type SBUser","SBUsers.showEdit"),!1;{let i=V.find("#password input"),s=e.type,a=V.find("#user_type select");V.removeClass("sb-user-new").attr("data-user-id",e.id),V.find(".sb-top-bar .sb-save").html(`<i class="sb-icon-check"></i>${o("Save changes")}`),V.find(".sb-profile").setProfile(),V.find(".sb-unlisted-detail").remove(),V.find("input,select,textara").removeClass("sb-error");let n="",r=V.find(".sb-additional-details [id]").map(function(){return this.id}).get().concat(["wp-id","perfex-id","whmcs-id","aecommerce-id","facebook-id","ip","os","current_url","country_code","browser_language","browser","martfury-id","martfury-session"]);for(var t in e.extra)r.includes(t)||(n+=`<div id="${t}" data-type="text" class="sb-input sb-unlisted-detail"><span>${o(e.extra[t].name)}</span><input type="text"></div>`);V.find(".sb-additional-details .sb-edit-box").append(n),this.populateEdit(e,V),this.updateRequiredFields(s),"admin"==SB_ACTIVE_AGENT.user_type&&SBF.isAgent(s)&&a.html(`<option value="agent">${o("Agent")}</option><option value="admin"${"admin"==s?" selected":""}>${o("Admin")}</option>`),i.val()&&i.val("********"),SB_ADMIN_SETTINGS.cloud&&V.setClass("sb-cloud-admin",1==e.id),this.boxClasses(V,s),V.sbShowLightbox(),SBF.event("SBProfileEditBoxOpened",{user_id:e.id})}},populate:function(e,t){let i=["first_name","last_name","password","profile_image"],s="";if(t.hasClass("sb-profile-list-conversation")&&SBChat.conversation){let e=SBChat.conversation.get("source");s=this.profileRow("conversation-id",SBChat.conversation.id,o("Conversation ID")),SBF.null(e)||(s+=this.profileRow("conversation-source",st.getName(e),o("Source")))}"admin"!=SB_ACTIVE_AGENT.user_type&&i.push("token");for(var a in e.details)i.includes(a)||(s+=this.profileRow(a,e.get(a),"id"==a?"User ID":a));if(t.html(`<ul>${s}</ul>`),s="",e.isExtraEmpty())SBF.ajax({function:"get-user-extra",user_id:e.id},i=>{for(var a=0;a<i.length;a++){let t=i[a].slug;e.setExtra(t,i[a]),s+=this.profileRow(t,i[a].value,i[a].name)}t.find("ul").append(s),l(t,145),SBF.event("SBUserLoaded",e)});else{for(var a in e.extra){let t=e.getExtra(a);s+=this.profileRow(a,t.value,t.name)}t.find("ul").append(s),l(t,145),SBF.event("SBUserLoaded",e)}},profileRow:function(e,t,i=e){if(!t)return"";let s,a={id:"user",full_name:"user",email:"envelope",phone:"phone",user_type:"user",last_activity:"calendar",creation_time:"calendar",token:"shuffle",currency:"currency",location:"marker",country:"marker",address:"marker",city:"marker",postal_code:"marker",browser:"desktop",os:"desktop",current_url:"next",timezone:"clock"},n=`<i class="sb-icon sb-icon-${e in a?a[e]:"plane"}"></i>`,r=!1;switch(e){case"last_activity":case"creation_time":t=SBF.beautifyTime(t);break;case"user_type":t=SBF.slugToString(t);break;case"country":case"country_code":case"language":case"browser_language":let i=t;"ar"!=t||"language"!=e&&"browser_language"!=e||(i="arc"),n=`<img src="${SB_URL}/media/flags/${i.toLowerCase()}.png" />`;break;case"browser":(s=t.toLowerCase()).includes("chrome")?r="chrome":s.includes("edge")?r="edge":s.includes("firefox")?r="firefox":s.includes("opera")?r="opera":s.includes("safari")&&(r="safari");break;case"os":(s=t.toLowerCase()).includes("windows")?r="windows":s.includes("mac")||s.includes("apple")||s.includes("ipad")||s.includes("iphone")?r="apple":s.includes("android")?r="android":s.includes("linux")?r="linux":s.includes("ubuntu")&&(r="ubuntu");break;case"conversation-source":r=t.toLowerCase();case"browser":case"os":case"conversation-source":r&&(n=`<img src="${SB_URL}/media/${"conversation-source"==e?"apps":"devices"}/${r}.svg" />`);break;case"current_url":t=b(t)}return`<li data-id="${e}">${n}<span>${o(SBF.slugToString(i))}</span><label>${t}</label></li>`},populateEdit:function(t,i){i.find(".sb-details .sb-input").each((i,s)=>{this.set(s,t.details[e(s).attr("id")])}),i.find(".sb-additional-details .sb-input").each((i,s)=>{let a=e(s).attr("id");a in t.extra?this.set(s,t.extra[a].value):this.set(s,"")})},clear:function(e){SBForm.clear(e)},errors:function(e){return SBForm.errors(e.find(".sb-details"))},showErrorMessage:function(e,t){SBForm.showErrorMessage(e,t)},agentData:function(){let e=`<div class="sb-title">${o("Feedback rating")}</div><div class="sb-rating-area sb-loading"></div>`,t=O.find(".sb-agent-area");t.html(e),SBF.ajax({function:"get-rating"},i=>{if(0==i[0]&&0==i[1])e=`<p class="sb-no-results">${o("No ratings yet.")}</p>`;else{let t=i[0]+i[1],s=100*i[0]/t,a=100*i[1]/t;e=`<div><div>${o("Helpful")}</div><span data-count="${i[0]}" style="width: ${Math.round(2*s)}px"></span><div>${s.toFixed(2)} %</div></div><div><div>${o("Not helpful")}</div><span data-count="${i[1]}" style="width: ${Math.round(2*a)}px"></span><div>${a.toFixed(2)} %</div></div><p class="sb-rating-count">${t} ${o("Ratings")}</p>`}t.find(".sb-rating-area").html(e).sbLoading(!1)})},boxClasses:function(t,i=!1){e(t).removeClass("sb-type-admin sb-type-agent sb-type-lead sb-type-user sb-type-visitor").addClass(`${0!=i?`sb-type-${i}`:""} sb-agent-${SB_ACTIVE_AGENT.user_type}`)},updateRequiredFields:function(e){let t=SBF.isAgent(e);V.find("#password input").prop("required",t),V.find("#email input").prop("required",t)}},dt={infoBottom:function(e,t=!1){var i=k.find(".sb-info-card");t?"error"==t?i.addClass("sb-info-card-error"):i.addClass("sb-info-card-info"):(i.removeClass("sb-info-card-error sb-info-card-warning sb-info-card-info"),clearTimeout(ge),ge=setTimeout(()=>{i.sbActive(!1)},5e3)),i.html(`<h3>${o(e)}</h3>`).sbActive(!0)},infoPanel:function(t,i="info",s=!1,a="",n="",r=!1,l=!1,c=!1){if(l&&s)return s();let d=k.find(".sb-dialog-box").attr("data-type",i),u=d.find("p");d.attr("id",a).setClass("sb-scroll-area",r).css("height",r?parseInt(e(window).height())-200+"px":""),d.find(".sb-title").html(o(n)),u.html(("alert"==i?o("Are you sure?")+" ":"")+o(t)),d.sbActive(!0).css({"margin-top":d.outerHeight()/-2+"px","margin-left":d.outerWidth()/-2+"px"}),we.sbActive(!0),be=s,ve=c,setTimeout(()=>{dt.open_popup=d},500)},genericPanel:function(e,t,i,s=[],a="",n=!1){let r="",l=k.find("#sb-generic-panel");for(var c=0;c<s.length;c++)s[c]=h(s[c])||s[c]instanceof String?[s[c],!1]:s[c],r+=`<a id="sb-${SBF.stringToSlug(s[c][0])}" class="sb-btn${s[c][1]?" sb-icon":""}">${s[c][1]?`<i class="sb-icon-${s[c][1]}"></i>`:""} ${o(s[c][0])}</a>`;l.html(`<div class="sb-lightbox sb-${e}-box"${a}><div class="sb-info"></div><div class="sb-top-bar"><div>${o(t)}</div>\n                        <div>\n                            ${r}\n                            <a class="sb-close sb-btn-icon sb-btn-red">\n                                <i class="sb-icon-close"></i>\n                            </a>\n                        </div>\n                    </div>\n                    <div class="sb-main${n?" sb-scroll-area":""}">\n                        ${i}\n                    </div>\n             </div>`),l.find("> div").sbShowLightbox()},activeUser:function(e){if(typeof e==Ke)return window.sb_current_user;window.sb_current_user=e},loadingGlobal:function(t=!0,i=!0){k.find(".sb-loading-global").sbActive(t),i&&(we.sbActive(t),e("body").setClass("sb-lightbox-active",t))},loading:function(t){return!!e(t).sbLoading()||(e(t).sbLoading(!0),!1)},collapse(t,i){let s=(t=e(t)).find("> div, > ul");s.css({height:"","max-height":""}),t.find(".sb-collapse-btn").remove(),t.hasClass("sb-collapse")&&e(s).prop("scrollHeight")>i&&(t.sbActive(!0).attr("data-height",i),t.append(`<a class="sb-btn-text sb-collapse-btn">${o("View more")}</a>`),s.css({height:i+"px","max-height":i+"px"}))},open_popup:!1,must_translate:!1,is_logout:!1,conversations:lt,users:rt,settings:at,profile:ct,apps:st};window.SBAdmin=dt,e(document).ready(function(){function c(e,i,s,a=0,n=[],r,l=!1,d=!1,u=!1,p=!1,h=!1){let f={whatsapp:["whatsapp-send-template","messages"," a phone number.","direct-whatsapp"],email:["create-email","emails"," an email address.",!1],custom_email:["send-custom-email","emails"," an email address.","direct-emails"],sms:["send-sms","text messages"," a phone number.","direct-sms"]}[r];SBF.ajax({function:f[0],to:e[i][a].value,recipient_id:e[i][a].id,sender_name:SB_ACTIVE_AGENT.full_name,sender_profile_image:SB_ACTIVE_AGENT.profile_image,subject:l,message:s,template_name:d,parameters:u,template_languages:p,template:!1,phone_id:h,user_name:!!e.first_name&&(e.first_name[a].value+" "+e.last_name[a].value).trim(),user_email:!!e.email&&e.email[a].value},g=>{let b=e[i].length,v="whatsapp"==r?k.find("#sb-whatsapp-send-template-box"):D;if(v.find(".sb-bottom > div").html(`${o("Sending")} ${o(f[1])}... ${a+1} / ${b}`),g){if(!0!==g&&("status"in g&&400==g.status||"error"in g&&![131030,131009].includes(g.error.code)))return SBForm.showErrorMessage(v,g.error?g.error.message:`${g.message} Details at ${g.more_info}`),console.error(g),v.find(".sb-loading").sbLoading(!1),void v.find(".sb-bottom > div").html("");if(a<b-1)return c(e,i,s,a+1,n,r,l,d,u,p,h);n.length?c(n,i,s,0,[],"sms",!1):(k.sbHideLightbox(),f[3]&&SBF.ajax({function:"reports-update",name:f[3],value:s.substr(0,18)+" | "+b})),t(1==b?"The message has been sent.":o("The message was sent to all users who have"+f[2]))}else console.warn(g)})}if(k=e(".sb-admin"),x=k.find("> .sb-header"),A=k.find(".sb-area-conversations"),B=A.find(".sb-conversation"),T=A.find(".sb-conversation .sb-list"),$=A.find(".sb-admin-list"),C=$.find(".sb-scroll-area ul"),F=$.find(".sb-select"),I=A.find(".sb-user-details"),G=k.find(".sb-area-users"),U=G.find(".sb-table-users"),P=G.find(".sb-menu-users"),q=G.find(".sb-filter-btn .sb-select"),O=k.find(".sb-profile-box"),V=k.find(".sb-profile-edit-box"),H=k.find(".sb-area-settings"),W=H.find(".sb-automations-area"),Y=W.find(".sb-conditions"),z=W.find(" > .sb-select"),J=W.find(" > .sb-tab > .sb-nav > ul"),Te=k.find(".sb-area-reports"),X=k.find(".sb-area-articles"),Q=X.find(".sb-content-articles"),Z=X.find(".sb-content-categories"),ee=k.find("#article-parent-categories"),K=k.find("#article-categories"),Fe=A.find(".sb-replies"),we=k.find(".sb-lightbox-overlay"),ye=typeof SB_URL!=Ke?SB_URL.substr(0,SB_URL.indexOf("-content")-3):"",Ee=A.find(".sb-woocommerce-products"),Le=Ee.find(" > div > ul"),N=A.find(".sb-panel-notes"),E=A.find(".sb-panel-tags"),L=A.find(".sb-panel-attachments"),D=k.find(".sb-direct-message-box"),et=st.is("wordpress")&&e(".wp-admin").length,M=k.find(".sb-dialogflow-intent-box"),R=A.find(".sb-editor > .sb-suggestions"),j=A.find(".sb-btn-open-ai"),Ie=A.find("#conversation-department"),de=k.find(".sb-upload-form-admin .sb-upload-files"),te=k.find(".sb-area-chatbot"),ie=te.find("#sb-table-chatbot-files"),se=te.find("#sb-table-chatbot-website"),ae=te.find("#sb-chatbot-qea"),ne=te.find(".sb-playground-editor"),oe=te.find(".sb-playground .sb-scroll-area"),le=te.find('[data-id="flows"] > .sb-content'),re=te.find("#sb-flows-nav"),window.onpopstate=function(){k.sbHideLightbox(),We&&A.sbActive()&&B.sbActive()&&lt.mobileCloseConversation(),SBF.getURL("user")?(G.sbActive()||x.find(".sb-admin-nav #sb-users").click(),ct.show(SBF.getURL("user"))):SBF.getURL("area")?x.find(".sb-admin-nav #sb-"+SBF.getURL("area")).click():SBF.getURL("conversation")?(A.sbActive()||x.find(".sb-admin-nav #sb-conversations").click(),lt.openConversation(SBF.getURL("conversation"))):SBF.getURL("setting")?(H.sbActive()||x.find(".sb-admin-nav #sb-settings").click(),H.find("#tab-"+SBF.getURL("setting")).click()):SBF.getURL("report")&&(Te.sbActive()||x.find(".sb-admin-nav #sb-reports").click(),Te.find("#"+SBF.getURL("report")).click())},SBF.getURL("area")&&setTimeout(()=>{x.find(".sb-admin-nav #sb-"+SBF.getURL("area")).click()},300),typeof SB_ADMIN_SETTINGS==Ke){let t=k.find(".sb-intall"),i=window.location.href.replace("/admin","").replace(".php","").replace(/#$|\/$/,"");return e(k).on("click",".sb-submit-installation",function(){if(a(this))return;let s=!1,n=t.find("#first-name").length;SBForm.errors(t)?s=n?"All fields are required. Minimum password length is 8 characters. Be sure you've entered a valid email.":"All fields are required.":n&&t.find("#password input").val()!=t.find("#password-check input").val()?s="The passwords do not match.":(SBF.cookie("SA_VGCKMENS",0,0,"delete"),i.includes("?")&&(i=i.substr(0,i.indexOf("?"))),e.ajax({method:"POST",url:i+"/include/ajax.php",data:{function:"installation",details:e.extend(SBForm.getAll(t),{url:i})}}).done(a=>{if(h(a)&&(a=JSON.parse(a)),(a=a[1])&&!a.error)return SBF.cookie("SA_VGCKMENS",a.cv,30,"set"),void setTimeout(()=>{window.location.href=i+"/admin.php?refresh=true"},1e3);!1!==(s=a.error?a.error:a)&&(SBForm.showErrorMessage(t,s),e("html, body").animate({scrollTop:0},500)),e(this).sbLoading(!1)})),!1!==s&&(SBForm.showErrorMessage(t,s),e("html, body").animate({scrollTop:0},500),e(this).sbLoading(!1))}),void fetch("https://board.support/synch/index.php?site="+encodeURI(i.split("?")[0]))}if(!k.length)return;if(n(),k.removeAttr("style"),(window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone||document.referrer.includes("android-app://"))&&k.addClass("sb-pwa"),Je&&r(),k.find(" > .sb-rich-login").length)return;SBF.storage("notifications-counter",[]),SB_ADMIN_SETTINGS.pusher?(SBPusher.active=!0,SBPusher.init(()=>{SBPusher.presence(1,()=>{rt.updateUsersActivity()}),SBPusher.event("update-conversations",()=>{lt.update()},"agents"),SBPusher.event("set-agent-status",e=>{e.agent_id==SB_ACTIVE_AGENT.id&&(rt.setActiveAgentStatus("online"==e.status),Ue=!1)},"agents"),y()})):(y(),setInterval(function(){rt.updateUsersActivity()},1e4)),rt.table_extra=U.find("th[data-extra]").map(function(){return e(this).attr("data-field")}).get(),typeof SB_CLOUD_FREE!=Ke&&SB_CLOUD_FREE&&setTimeout(()=>{location.reload()},36e5),e(window).on("beforeunload",function(){s()&&e.ajax({method:"POST",url:SB_AJAX_URL,data:{function:"on-close"}})}),e(window).keydown(function(e){let t=e.which,i=!1;if(Ae=t,[13,27,32,37,38,39,40,46,90].includes(t)){if(k.find(".sb-dialog-box").sbActive()){let e=k.find(".sb-dialog-box");switch(t){case 46:case 27:e.find(".sb-cancel").click();break;case 32:case 13:e.find("info"!=e.attr("data-type")?".sb-confirm":".sb-close").click()}i=!0}else if([38,40,46,90].includes(t)&&A.sbActive()&&!k.find(".sb-lightbox").sbActive()){let s=A.find(".sb-editor textarea"),a=s.is(":focus");if(46==t){if(a||"INPUT"==e.target.tagName)return;let t=A.find(" > div > .sb-conversation");t.find('.sb-top [data-value="'+(3==t.attr("data-conversation-status")?"delete":"archive")+'"]').click(),i=!0}else if(e.ctrlKey){let e=C.find(".sb-active");40==t?e.next().click():38==t?e.prev().click():90==t&&a&&lt.previous_editor_text&&(s.val(lt.previous_editor_text),lt.previous_editor_text=!1,i=!0),38!=t&&40!=t||(i=!0,lt.scrollTo())}}else if([37,39].includes(t)&&G.sbActive()&&k.find(".sb-lightbox").sbActive()){let e=U.find(`[data-user-id="${s().id}"]`);(e=39==t?e.next():e.prev()).length&&(k.sbHideLightbox(),ct.show(e.attr("data-user-id"))),i=!0}else if(27==t&&k.find(".sb-lightbox").sbActive())k.sbHideLightbox(),i=!0;else if(46==t){let e=k.find(".sb-search-btn.sb-active");e.length&&(e.find("i").click(),i=!0)}else 13==t&&te.find(".sb-playground-editor textarea").is(":focus")&&(te.find('.sb-playground-editor [data-value="send"]').click(),i=!0);i&&e.preventDefault()}}),e(window).keyup(function(e){Ae=!1}),e(document).on("click keydown mousemove",function(){SBF.debounce(()=>{SBChat.tab_active||SBF.visibilityChange(),SBChat.tab_active=!0,clearTimeout(Ze),Ze=setTimeout(()=>{SBChat.tab_active=!1},1e4)},"#3",8e3),!We&&SB_ADMIN_SETTINGS.away_mode&&SBF.debounce(()=>{Ue&&(rt.setActiveAgentStatus(),clearTimeout(_e),_e=setTimeout(()=>{rt.setActiveAgentStatus(!1)},6e5))},"#4",558e3)}),document.onpaste=function(e){let t=e.clipboardData.items[0];if(0===t.type.indexOf("image")){var i=new FileReader;i.onload=function(e){let t=e.target.result.split(","),i=t[0].indexOf("base64")>=0?atob(t[1]):decodeURI(t[1]),s=new Uint8Array(i.length);for(let e=0;e<i.length;e++)s[e]=i.charCodeAt(e);let a=new FormData;a.append("file",new Blob([s],{type:t[0].split(":")[1].split(";")[0]}),"image_print.jpg"),SBF.upload(a,function(e){SBChat.uploadResponse(e)})},i.readAsDataURL(t.getAsFile())}};let u=[o("Please go to Settings > Miscellaneous and enter the Envato Purchase Code of Support Board."),`${o("Your license key is expired. Please purchase a new license")} <a href="https://board.support/shop/{R}" target="_blank">${o("here")}</a>.`];e(x).on("click",".sb-version",function(){let e=k.find(".sb-updates-box");SBF.ajax({function:"get-versions"},t=>{let i="",s={sb:"Support Board",slack:"Slack",dialogflow:"Artificial Intelligence",tickets:"Tickets",woocommerce:"Woocommerce",ump:"Ultimate Membership Pro",perfex:"Perfex",whmcs:"WHMCS",aecommerce:"Active eCommerce",messenger:"Messenger",whatsapp:"WhatsApp",armember:"ARMember",telegram:"Telegram",viber:"Viber",line:"LINE",wechat:"WeChat",zalo:"Zalo",twitter:"Twitter",zendesk:"Zendesk",martfury:"Martfury",opencart:"OpenCart",zalo:"Zalo"},a=!1;for(var r in t)if(st.is(r)){let e=SB_VERSIONS[r]==t[r];e||(a=!0),i+=`<div class="sb-input"><span>${s[r]}</span><div${e?' class="sb-green"':""}>${o(e?"You are running the latest version.":"Update available! Please update now.")} ${o("Your version is")} V ${SB_VERSIONS[r]}.</div></div>`}a?e.find(".sb-update").removeClass("sb-hide"):e.find(".sb-update").addClass("sb-hide"),n(!1),e.find(".sb-main").prepend(i),e.sbShowLightbox()}),n(),e.sbActive(!1),e.find(".sb-input").remove()}),e(k).on("click",".sb-updates-box .sb-update",function(){if(a(this))return;let i=k.find(".sb-updates-box");SBF.ajax({function:"update",domain:SB_URL},s=>{let a="";if(SBF.errorValidation(s,"envato-purchase-code-not-found"))a=u[0];else if(SBF.errorValidation(s))a=SBF.slugToString(s[1]);else{let e=!0;for(var n in s)if("success"!=s[n]){e=!1,"expired"==s[n]&&(a=u[1].replace("{R}",n)),"license-key-not-found"==s[n]&&(a=o("License key for the {R} app missing. Add it in Settings > Apps.").replace("{R}",SBF.slugToString(n.replace("dialogflow","Artificial Intelligence"))));break}e||a||(a=JSON.stringify(s))}r(),a?SBForm.showErrorMessage(i,a):(t("Update completed."),location.reload()),e(this).sbLoading(!1)})}),setTimeout(function(){let i=SBF.storage("last-update-check"),s=[Ye.getMonth(),Ye.getDate()];SB_ADMIN_SETTINGS.cloud||((0==i||s[0]!=i[0]||s[1]>i[1]+10)&&(SBF.storage("last-update-check",s),SB_ADMIN_SETTINGS.auto_updates?SBF.ajax({function:"update",domain:SB_URL},e=>{h(e)||Array.isArray(e)||(t("Automatic update completed. Reload the admin area to apply the update."),r())}):"admin"==SB_ACTIVE_AGENT.user_type&&SBF.ajax({function:"updates-available"},e=>{!0===e&&t(`${o("Update available.")} <span onclick="$('.sb-version').click()">${o("Click here to update now")}</span>`,"info")})),SBF.cookie("SA_VGCKMENS")||setTimeout(()=>{e("body").html("")},1e4))},1e3),e(k).on("click",".sb-apps > div:not(.sb-disabled)",function(){let t=k.find(".sb-app-box"),i=e(this).data("app"),s=SB_ADMIN_SETTINGS.cloud,a=st.is(i)&&(!s||SB_CLOUD_ACTIVE_APPS.includes(i)),n="?utm_source=plugin&utm_medium=admin_area&utm_campaign=plugin";s||SBF.ajax({function:"app-get-key",app_name:i},e=>{t.find("input").val(e)}),t.setClass("sb-active-app",a),t.find("input").val(""),t.find(".sb-top-bar > div:first-child").html(e(this).find("h2").html()),t.find("p").html(e(this).find("p").html()),t.attr("data-app",i),t.find(".sb-btn-app-setting").sbActive(a),t.find(".sb-btn-app-puchase").attr("href","https://board.support/shop/"+i+n),t.find(".sb-btn-app-details").attr("href",(s?WEBSITE_URL:"https://board.support/")+i+n),t.sbShowLightbox()}),e(k).on("click",".sb-app-box .sb-activate",function(){let i=k.find(".sb-app-box"),s=i.find("input").val(),n=i.attr("data-app");if(s||SB_ADMIN_SETTINGS.cloud){if(a(this))return;SBF.ajax({function:"app-activation",app_name:n,key:s},a=>{if(SBF.errorValidation(a)){let t="";t="envato-purchase-code-not-found"==(a=a[1])?u[0]:"invalid-key"==a?"It looks like your license key is invalid. If you believe this is an error, please contact support.":"expired"==a?u[1].replace("{R}",s):"app-purchase-code-limit-exceeded"==a?SBF.slugToString(n)+" app purchase code limit exceeded.":"Error: "+a,SBForm.showErrorMessage(i,t),e(this).sbLoading(!1)}else t("Activation complete! Page reload in progress..."),setTimeout(function(){location.reload()},1e3)})}else SBForm.showErrorMessage(i,"Please insert the license key.")}),e(k).on("click",".sb-app-box .sb-btn-app-setting",function(){H.find("#tab-"+e(this).closest("[data-app]").attr("data-app")).click(),k.sbHideLightbox()}),typeof Notification===Ke||"all"!=SB_ADMIN_SETTINGS.desktop_notifications&&"agents"!=SB_ADMIN_SETTINGS.desktop_notifications||SB_ADMIN_SETTINGS.push_notifications||(lt.desktop_notifications=!0),["all","agents"].includes(SB_ADMIN_SETTINGS.flash_notifications)&&(lt.flash_notifications=!0),Ye.getDate()!=SBF.storage("admin-clean")&&setTimeout(function(){SBF.ajax({function:"cron-jobs"}),SBF.storage("admin-clean",Ye.getDate())},1e4),e(k).on("click",".sb-collapse-btn",function(){let t=e(this).sbActive(),i=t?e(this).parent().data("height")+"px":"";e(this).html(o(t?"View more":"Close")),e(this).parent().find("> div, > ul").css({height:i,"max-height":i}),e(this).sbActive(!t)}),e(k).on("click",".sb-popup-close",function(){k.sbHideLightbox()}),We?(I.find("> .sb-scroll-area").prepend('<div class="sb-profile"><img><span class="sb-name"></span></div>'),e(k).on("click",".sb-menu-mobile > i",function(){e(this).toggleClass("sb-active"),dt.open_popup=e(this).parent()}),e(k).on("click",".sb-menu-mobile a",function(){e(this).closest(".sb-menu-mobile").find(" > i").sbActive(!1)}),e(k).on("click",".sb-menu-wide,.sb-nav",function(){e(this).toggleClass("sb-active")}),e(k).on("click",".sb-menu-wide > ul > li, .sb-nav > ul > li",function(t){let i=e(this).parent().parent();return i.find("li").sbActive(!1),i.find("> div:not(.sb-menu-wide):not(.sb-btn)").html(e(this).html()),i.sbActive(!1),i.find("> .sb-menu-wide").length&&i.closest(".sb-scroll-area").scrollTop(i.next()[0].offsetTop-(k.hasClass("sb-header-hidden")?70:130)),t.preventDefault(),!1}),e(k).find(".sb-admin-list .sb-scroll-area, main > div > .sb-scroll-area,.sb-area-settings > .sb-tab > .sb-scroll-area,.sb-area-reports > .sb-tab > .sb-scroll-area").on("scroll",function(){let t=e(this).scrollTop();ze.last<t-10&&ze.header?(k.addClass("sb-header-hidden"),ze.header=!1):ze.last>t+10&&!ze.header&&!ze.always_hidden&&(k.removeClass("sb-header-hidden"),ze.header=!0),ze.last=t}),e(k).on("click",".sb-search-btn i,.sb-filter-btn i",function(){e(this).parent().sbActive()?(k.addClass("sb-header-hidden"),ze.always_hidden=!0):(ze.always_hidden=!1,C.parent().scrollTop()<10&&k.removeClass("sb-header-hidden"))}),e(k).on("click",".sb-top .sb-btn-back",function(){lt.mobileCloseConversation()}),e(U).find("th:first-child").html(o("Order by")),e(U).on("click","th:first-child",function(){e(this).parent().toggleClass("sb-active")}),document.addEventListener("touchstart",e=>{xe=e.changedTouches[0].clientX,Be=e.changedTouches[0].clientY},!1),document.addEventListener("touchend",()=>{S()},!1),document.addEventListener("touchmove",e=>{var t=e.changedTouches[0].clientX,i=xe-t,a=e.changedTouches[0].clientY,n=Be-a;if(Math.abs(i)>Math.abs(n)){var o=[];ke=A.sbActive()?[C.find(".sb-active"),T,1]:[U.find(`[data-user-id="${s().id}"]`),O,2],i>150?(1==ke[2]?ke[0].next().click():o=ke[0].next(),S()):i<-150&&(1==ke[2]?ke[0].prev().click():o=ke[0].prev(),S()),2==ke[2]&&o.length&&(k.sbHideLightbox(),ct.show(o.attr("data-user-id"))),(i>80||i<-80)&&(ke[1].css("transform","translateX("+-1*i+"px)"),ke[1].addClass("sb-touchmove"))}},!1)):SB_ADMIN_SETTINGS.hide_conversation_details?A.find('.sb-menu-mobile [data-value="panel"]').sbActive(!0):I.sbActive(!0),e(window).width()<913&&e(A).on("click","> .sb-btn-collapse",function(){e(this).toggleClass("sb-active"),A.find(e(this).hasClass("sb-left")?".sb-admin-list":".sb-user-details").toggleClass("sb-active")}),e(x).on("click"," .sb-admin-nav a",function(){switch($e=e(this).attr("id").substr(3),dt.active_admin_area=$e,x.find(".sb-admin-nav a").sbActive(!1),k.find(" > main > div").sbActive(!1),k.find(".sb-area-"+$e).sbActive(!0),e(this).sbActive(!0),SBF.deactivateAll(),$e){case"conversations":We||SBF.getURL("conversation")||lt.clickFirst(),lt.update(),lt.startRealTime(),rt.stopRealTime();break;case"users":rt.startRealTime(),lt.stopRealTime(),rt.init||(n(),je=1,Ge=1,rt.get(e=>{rt.populate(e),rt.updateMenu(),rt.init=!0,rt.datetime_last_user=SBF.dateDB("now"),n(!1)}));break;case"settings":at.init||(n(),SBF.ajax({function:"get-all-settings"},i=>{if(i){let e=i["external-settings-translations"];if(i["slack-agents"]){let e="";for(var s in i["slack-agents"][0])e+=`<div data-id="${s}"><select><option value="${i["slack-agents"][0][s]}"></option></select></div>`;H.find("#slack-agents .input").html(e)}at.translations.translations=Array.isArray(e)&&!e.length?{}:e,delete i["external-settings-translations"];for(var s in i)at.set(s,i[s])}SBF.getURL("refresh_token")&&(k.find("#google-refresh-token input").val(SBF.getURL("refresh_token")),at.save(),t("Synchronization completed."),k.find("#google")[0].scrollIntoView()),H.find("textarea").each(function(){e(this).autoExpandTextarea(),e(this).manualExpandTextarea()}),H.find("[data-setting] .sb-language-switcher-cnt").each(function(){e(this).sbLanguageSwitcher(at.translations.getLanguageCodes(e(this).closest("[data-setting]").attr("id")),"settings")}),at.init=!0,n(!1),i&&!SB_ADMIN_SETTINGS.cloud&&at.visibility(0,i["push-notifications"]&&"pusher"==i["push-notifications"][0]["push-notifications-provider"][0]),at.visibility(1,!i.messenger||"manual"!=i.messenger[0]["messenger-sync-mode"][0]),at.visibility(2,!i["open-ai"]||"assistant"!=i["open-ai"][0]["open-ai-mode"][0]),SBF.event("SBSettingsLoaded",i)})),rt.stopRealTime(),lt.stopRealTime();break;case"reports":Te.sbLoading()&&e.getScript(SB_URL+"/vendor/moment.min.js",()=>{e.getScript(SB_URL+"/vendor/daterangepicker.min.js",()=>{e.getScript(SB_URL+"/vendor/chart.min.js",()=>{ot.initDatePicker(),ot.initReport("conversations"),Te.sbLoading(!1)})})}),rt.stopRealTime(),lt.stopRealTime();break;case"articles":let i=X.find(".sb-menu-wide li").eq(0);X.sbLoading()?(i.sbActive(!0).next().sbActive(!1),SBF.ajax({function:"init-articles-admin"},e=>{nt.categories.list=e[1],nt.translations.list=e[2],nt.page_url=e[3],nt.is_url_rewrite=e[4],nt.cloud_chat_id=e[5],nt.populate(e[0]),nt.populate(e[1],!0),nt.categories.update(),X.sbLoading(!1)})):i.click(),rt.stopRealTime(),lt.stopRealTime();break;case"chatbot":ie.sbLoading()&&st.openAI.init(),st.openAI.troubleshoot()}SBF.getURL("area")!=$e&&("conversations"==$e&&!SBF.getURL("conversation")||"users"==$e&&!SBF.getURL("user")||"settings"==$e&&!SBF.getURL("setting")||"reports"==$e&&!SBF.getURL("report")||"articles"==$e&&!SBF.getURL("article")||"chatbot"==$e&&!SBF.getURL("chatbot"))&&f("?area="+$e)}),e(x).on("click",".sb-profile",function(){e(this).next().toggleClass("sb-active")}),e(x).on("click",'[data-value="logout"],.logout',function(){dt.is_logout=!0,SBF.ajax({function:"on-close"}),rt.stopRealTime(),lt.stopRealTime(),setTimeout(()=>{SBF.logout()},300)}),e(x).on("click",'[data-value="edit-profile"],.edit-profile',function(){n();let e=new SBUser({id:SB_ACTIVE_AGENT.id});e.update(()=>{s(e),A.find(".sb-board").addClass("sb-no-conversation"),C.find(".sb-active").sbActive(!1),ct.showEdit(e)})}),e(x).on("click",'[data-value="status"]',function(){let t=!e(this).hasClass("sb-online");rt.setActiveAgentStatus(t),Ue=t}),e(x).find(".sb-account").setProfile(SB_ACTIVE_AGENT.full_name,SB_ACTIVE_AGENT.profile_image),e(C).on("click","li",function(){17==Ae?e(this).sbActive(!e(this).sbActive()):(lt.openConversation(e(this).attr("data-conversation-id"),e(this).attr("data-user-id"),!1),SBF.deactivateAll())}),e(k).on("click",".sb-user-conversations li",function(){lt.openConversation(e(this).attr("data-conversation-id"),s().id,e(this).attr("data-conversation-status"))}),e(A).on("click",".sb-top ul a",function(){let t,n=lt.getSelectedConversations(),r=n.length,l=r>1?"All the selected conversations will be ":"The conversation will be ",c=(t,i)=>{let s=t.includes(".txt");e(this).sbLoading(!1),"email"==i&&actioninfoBottom(s?o("Transcript sent to user's email.")+' <a href="'+t+'" target="_blank">'+o("View transcript")+"</a>":"Transcript sending error: "+t,s?"":"error")};switch(e(this).attr("data-value")){case"inbox":t=1,l+="restored.";break;case"archive":l+="archived.",t=3;break;case"delete":l+="deleted.",t=4;break;case"empty-trash":t=5,l="All conversations in the trash (including their messages) will be deleted permanently.";break;case"transcript":let i=e(this).attr("data-action");"email"!=i||s()&&s().get("email")||(i=""),lt.transcript(n[0].id,n[0].user_id,i,e=>c(e,i)),a(this);break;case"read":t=1,l+="marked as read.";break;case"unread":t=2,l+="marked as unread.";break;case"panel":e([I,this]).toggleClass("sb-active")}t&&i(l,"alert",function(){let e=F.eq(0).find("p").attr("data-value"),i=n[r-1].id;for(var s=0;s<r;s++){let a=n[s];SBF.ajax({function:"update-conversation-status",conversation_id:a.id,status_code:t},()=>{let s=C.find(`[data-conversation-id="${a.id}"]`);if([0,3,4].includes(t))for(var n=0;n<Ce.length;n++)if(Ce[n].id==a.id){Ce[n].set("status_code",t);break}if(SB_ADMIN_SETTINGS.close_message&&3==t&&(SBF.ajax({function:"close-message",conversation_id:a.id,bot_id:SB_ADMIN_SETTINGS.bot_id}),SB_ADMIN_SETTINGS.close_message_transcript&&lt.transcript(a.id,a.user_id,"email",e=>c(e))),[0,1,2].includes(t)&&(s.attr("data-conversation-status",t),lt.updateMenu()),SBChat.conversation&&st.is("slack")&&[3,4].includes(t)&&SBF.ajax({function:"archive-slack-channels",conversation_user_id:SBChat.conversation.get("user_id")}),0==e&&[3,4].includes(t)||3==e&&[0,1,2,4].includes(t)||4==e&&4!=t){let e=!1;lt.updateMenu(),SBChat.conversation&&SBChat.conversation.id==a.id&&(e=s.prev(),SBChat.conversation=!1),s.remove(),a.id==i&&lt.clickFirst(e)}4==e&&5==t&&(C.find("li").remove(),lt.updateMenu(),lt.clickFirst())}),SBChat.conversation&&SBChat.conversation.id==a.id&&(SBChat.conversation.set("status_code",t),lt.setReadIcon(t))}})}),SBF.ajax({function:"saved-replies"},e=>{let t=`<p class="sb-no-results">${o("No saved replies found. Add new saved replies via Settings > Admin.")}</p>`;if(Array.isArray(e)&&e.length&&e[0]["reply-name"]){t="",Ne=e;for(var i=0;i<e.length;i++)t+=`<li><div>${e[i]["reply-name"]}</div><div>${e[i]["reply-text"].replace(/\\n/g,"\n")}</div></li>`}Fe.find(".sb-replies-list > ul").html(t).sbLoading(!1)}),e(A).on("click",".sb-btn-saved-replies",function(){Fe.sbTogglePopup(this),Fe.find(".sb-search-btn").sbActive(!0).find("input").get(0).focus()}),e(Fe).on("click",".sb-replies-list li",function(){SBChat.insertText(e(this).find("div:last-child").text().replace(/\\n/g,"\n")),SBF.deactivateAll(),k.removeClass("sb-popup-active")}),e(Fe).on("input",".sb-search-btn input",function(){v(e(this).val().toLowerCase())}),e(Fe).on("click",".sb-search-btn i",function(){SBF.searchClear(this,()=>{v("")})}),e(k).on("click",".sb-btn-open-ai",function(){if(!SBChat.conversation||a(this))return;let t=e(this).hasClass("sb-btn-open-ai-editor"),i=t?A.find(".sb-editor textarea"):M.find("textarea");st.openAI.rewrite(i.val(),s=>{e(this).sbLoading(!1),s[0]&&(i.val(t?"":s[1]),t&&SBChat.insertText(s[1]))})}),e($).find(".sb-scroll-area").on("scroll",function(){if(!Xe&&!lt.is_search&&d(this,!0)&&Me){let e=A.find(".sb-admin-list"),t=lt.filters();Xe=!0,e.append('<div class="sb-loading-global sb-loading"></div>'),SBF.ajax({function:"get-conversations",pagination:De,status_code:t[0],department:t[1],source:t[2],tag:t[3],agent_id:t[4]},t=>{if(setTimeout(()=>{Xe=!1},500),Me=t.length){let e="";for(var i=0;i<Me;i++){let s=new SBConversation([new SBMessage(t[i])],t[i]);e+=lt.getListCode(s),Ce.push(s)}De++,C.append(e)}e.find(" > .sb-loading").remove(),SBF.event("SBAdminConversationsLoaded",{conversations:t})})}}),e(document).on("SBMessageDeleted",function(){let e=SBChat.conversation.getLastMessage();0!=e?C.find("li.sb-active p").html(e.message):(C.find("li.sb-active").remove(),lt.clickFirst(),lt.scrollTo())}),e(document).on("SBMessageSent",function(s,a){let n=a.conversation_id,r=(w(n),o("Error. Message not sent to")),l=a.conversation,c=a.user,d=!(!a.payload||!a.payload.reply)&&a.payload.reply;a.conversation_status_code&&lt.updateMenu(),st.messenger.check(l)&&st.messenger.send(c.getExtra("facebook-id").value,l.get("extra"),a.message,a.attachments,a.message_id,a.message_id,e=>{for(var t=0;t<e.length;t++)e[t]&&e[t].error&&i(r+" Messenger: "+e[t].error.message,"info",!1,"error-fb")}),st.whatsapp.check(l)&&st.whatsapp.send(st.whatsapp.activeUserPhone(c),a.message,a.attachments,l.get("extra"),e=>{(e.ErrorCode||e.meta&&!e.meta.success)&&i(r+" WhatsApp: "+("ErrorCode"in e?e.errorMessage:e.meta.developer_message),"info",!1,"error-wa")}),st.telegram.check(l)&&st.telegram.send(l.get("extra"),a.message,a.attachments,n,d,a.message_id,e=>{e&&e.ok||i(r+" Telegram: "+JSON.stringify(e),"info",!1,"error-tg")}),st.viber.check(l)&&st.viber.send(c.getExtra("viber-id").value,a.message,a.attachments,e=>{e&&"ok"==e.status_message||i(r+" Viber: "+JSON.stringify(e),"info",!1,"error-vb")}),st.zalo.check(l)&&st.zalo.send(c.getExtra("zalo-id").value,a.message,a.attachments,e=>{e&&e.error.error&&i(r+" Zalo: "+e.error.message?e.error.message:e.message,"info",!1,"error-za")}),st.twitter.check(l)&&st.twitter.send(c.getExtra("twitter-id").value,a.message,a.attachments,e=>{e&&!e.event?i(JSON.stringify(e),"info",!1,"error-tw"):a.attachments.length>1&&t("Only the first attachment was sent to Twitter.")}),st.line.check(l)&&st.line.send(c.getExtra("line-id").value,a.message,a.attachments,n,e=>{e.error&&i(r+" LINE: "+JSON.stringify(e),"info",!1,"error-ln")}),st.wechat.check(l)&&st.wechat.send(c.getExtra("wechat-id").value,a.message,a.attachments,e=>{e&&"ok"==e.errmsg||i(r+" WeChat: "+JSON.stringify(e),"info",!1,"error-wc")}),SB_ADMIN_SETTINGS.smart_reply&&R.html(""),SB_ADMIN_SETTINGS.assign_conversation_to_agent&&SBF.null(l.get("agent_id"))&&lt.assignAgent(n,SB_ACTIVE_AGENT.id,()=>{SBChat.conversation.id==n&&(SBChat.conversation.set("agent_id",SB_ACTIVE_AGENT.id),e(A).find("#conversation-agent > p").attr("data-value",SB_ACTIVE_AGENT.id).html(SB_ACTIVE_AGENT.full_name))})}),e(document).on("SBNewMessagesReceived",function(e,s){let a=s.messages;for(var n=0;n<a.length;n++){let e=a[n],r=e.payload(),l=SBF.isAgent(e.get("user_type"));if(setTimeout(function(){B.find(".sb-top .sb-status-typing").remove()},300),dt.must_translate){let t=B.find(`[data-id="${e.id}"]`),i=!!r["original-message"]&&r["original-message"];i?(t.replaceWith(e.getCode()),B.find(`[data-id="${e.id}"] .sb-menu`).prepend(`<li data-value="translation">${o("View translation")}</li>`),SB_ADMIN_SETTINGS.smart_reply&&st.dialogflow.smartReply(SBF.escape(i))):e.message&&st.dialogflow.translate([e.message],SB_ADMIN_SETTINGS.active_agent_language,i=>{i&&(e.payload("translation",i[0]),e.payload("translation-language",SB_ADMIN_SETTINGS.active_agent_language),t.replaceWith(e.getCode()),B.find(`[data-id="${e.id}"] .sb-menu`).prepend(`<li data-value="original">${o("View original message")}</li>`)),SB_ADMIN_SETTINGS.smart_reply&&st.dialogflow.smartReply(i[0]),C.find(`[data-conversation-id="${s.conversation_id}"] p`).html(i[0])},[e.id],SBChat.conversation.id)}else SB_ADMIN_SETTINGS.smart_reply&&st.dialogflow.smartReply(e.message);r&&(r.department&&lt.setActiveDepartment(r.department),r.agent&&lt.setActiveAgent(r.agent)),("ErrorCode"in r||r.errors&&r.errors.length)&&i("Error. Message not sent to WhatsApp. Error message: "+(r.ErrorCode?r.ErrorCode:r.errors[0].title)),"whatsapp-templates"in r&&t(`Message sent as text message.${"whatsapp-template-fallback"in r?" The user has been notified via WhatsApp Template notification.":""}`),"whatsapp-template-fallback"in r&&!("whatsapp-templates"in r)&&t("The user has been notified via WhatsApp Template notification."),l||SBChat.conversation.id!=s.conversation_id||SBChat.user_online||rt.setActiveUserStatus()}lt.update()}),e(document).on("SBNewConversationCreated",function(){lt.update()}),e(document).on("SBEmailSent",function(){t("The user has been notified by email.")}),e(document).on("SBSMSSent",function(){t("The user has been notified by text message.")}),e(document).on("SBNotificationsSent",function(e,i){t(`The user ${i.includes("cron")?"will be":"has been"} notified by email${i.includes("sms")?" and text message":""}.`)}),e(document).on("SBTyping",function(e,t){lt.typing(t)}),e($).on("input",".sb-search-btn input",function(){lt.search(this)}),e(A).on("click",".sb-admin-list .sb-search-btn i",function(){SBF.searchClear(this,()=>{lt.search(e(this).next())})}),e(F).on("click","li",function(t){let i=C.parent();if(a(i))return t.preventDefault(),!1;setTimeout(()=>{let t=lt.filters();De=1,Me=1,SBF.ajax({function:"get-conversations",status_code:t[0],department:t[1],source:t[2],tag:t[3],agent_id:t[4]},s=>{if(lt.populateList(s),B.attr("data-conversation-status",t[0]),s.length){if(!We){if(SBChat.conversation){let e=w(SBChat.conversation.id);e.length?e.sbActive(!0):t[0]==SBChat.conversation.status_code?C.prepend(lt.getListCode(SBChat.conversation)):lt.clickFirst()}else lt.clickFirst();lt.scrollTo()}}else A.find(".sb-board").addClass("sb-no-conversation"),SBChat.conversation=!1;e(this).closest(".sb-filter-btn").attr("data-badge",F.slice(1).toArray().reduce((t,i)=>t+!!e(i).find("li.sb-active").data("value"),0)),i.sbLoading(!1)})},100)}),e(A).on("click",".sb-user-details .sb-profile,.sb-top > a",function(){let e=C.find(".sb-active").attr("data-user-id");s().id!=e&&s(Re[e]),ct.show(s().id)}),e(k).on("click",".sb-profile-list-conversation li",function(){let a=e(this).find("label"),r=a.html();switch(e(this).attr("data-id")){case"location":i('<iframe src="https://maps.google.com/maps?q='+r.replace(", ","+")+'&output=embed"></iframe>',"map");break;case"timezone":SBF.getLocationTimeString(s().extra,e=>{n(!1),i(e)});break;case"current_url":window.open("//"+(SBF.null(a.attr("data-value"))?r:a.attr("data-value")));break;case"conversation-source":let c=r.toLowerCase();"whatsapp"==c&&s().getExtra("phone")?window.open("https://wa.me/"+st.whatsapp.activeUserPhone()):"facebook"==c?window.open("https://www.facebook.com/messages/t/"+SBChat.conversation.get("extra")):"instagram"==c?window.open("https://www.instagram.com/direct/inbox/"):"twitter"==c&&window.open("https://twitter.com/messages/");break;case"wp-id":window.open(window.location.href.substr(0,window.location.href.lastIndexOf("/"))+"/user-edit.php?user_id="+s().getExtra("wp-id").value);break;case"envato-purchase-code":n(),SBF.ajax({function:"envato",purchase_code:r},e=>{let s="";if(e&&e.item){e.name=e.item.name;for(var a in e)!h(e[a])&&isNaN(e[a])||(s+=`<b>${SBF.slugToString(a)}</b> ${e[a]} <br>`);n(!1),i(s,"info",!1,"sb-envato-box")}else t(SBF.slugToString(e))});break;case"email":case"cc":if(SBChat.conversation&&"em"==SBChat.conversation.get("source")){let e=SBChat.conversation.get("extra").split(","),t='<div data-type="repeater" class="sb-setting sb-type-repeater"><div class="input"><div class="sb-repeater">';for(var l=0;l<e.length;l++)t+=`<div class="repeater-item"><div><input data-id="cc" type="text" value="${e[l]}"></div><i class="sb-icon-close"></i></div>`;t+=`</div><div class="sb-btn sb-btn-white sb-repeater-add sb-icon"><i class="sb-icon-plus"></i>${o("Add new item")}</div></div></div>`,dt.genericPanel("cc","Manage CC",t,["Save changes"],"",!0)}}}),e(I).on("click",".sb-user-details-close",function(){A.find('.sb-menu-mobile [data-value="panel"]').click().sbActive(!0)}),e(M).on("click",'.sb-intent-add [data-value="add"]',function(){M.find("> div > .sb-type-text").last().after('<div class="sb-setting sb-type-text"><input type="text"></div>')}),e(M).on("click",'.sb-intent-add [data-value="previous"],.sb-intent-add [data-value="next"]',function(){let t=M.find(".sb-first input"),i=t.val(),s="next"==e(this).attr("data-value"),a=SBChat.conversation.getUserMessages(),n=a.length;for(var o=0;o<n;o++)if(a[o].message==i&&(s&&o<n-1||!s&&o>0)){o+=s?1:-1,t.val(a[o].message),M.attr("data-message-id",a[o].id),st.openAI.generateQuestions(a[o].message);break}}),e(M).on("click",".sb-send",function(){st.dialogflow.submitIntent(this)}),e(M).on("input",".sb-search-btn input",function(){st.dialogflow.searchIntents(e(this).val())}),e(M).on("click",".sb-search-btn i",function(){SBF.searchClear(this,()=>{st.dialogflow.searchIntents(e(this).val())})}),e(M).on("click","#sb-intent-preview",function(){st.dialogflow.previewIntentDialogflow(M.find("#sb-intents-select").val())}),e(M).on("click","#sb-qea-preview",function(){st.dialogflow.previewIntent(M.find("#sb-qea-select").val())}),e(M).on("change","#sb-intents-select",function(){let t=e(this).val();M.find(".sb-bot-response").css("opacity",t?.5:1).find("textarea").val(t?st.dialogflow.getIntent(t).messages[0].text.text[0]:st.dialogflow.original_response),M.find("#sb-train-chatbots").val(t?"dialogflow":"")}),e(M).on("change","#sb-qea-select",function(){let t=e(this).val();M.find(".sb-bot-response").setClass("sb-disabled",t).find("textarea").val(t?st.dialogflow.qea[t][1]:st.dialogflow.original_response),M.find("#sb-train-chatbots").val(t?"dialogflow":"")}),e(M).on("change","textarea",function(){clearTimeout(ge),ge=setTimeout(()=>{st.dialogflow.original_response=M.find("textarea").val()},500)}),e(M).on("change","#sb-train-chatbots",function(){M.find(".sb-type-text:not(.sb-first)").setClass("sb-hide","open-ai"==e(this).val())}),e(Ie).on("click","li",function(t){let s=e(this).parent().parent();return e(this).data("id")==s.find(" > p").attr("data-id")?(setTimeout(()=>{e(this).sbActive(!1)},100),!0):SBChat.conversation?(s.sbLoading()||i(`${o("All agents assigned to the new department will be notified. The new department will be")} ${e(this).html()}.`,"alert",()=>{let t=e(this).data("id");s.sbLoading(!0),lt.assignDepartment(SBChat.conversation.id,t,()=>{lt.setActiveDepartment(t),s.sbLoading(!1)})}),t.preventDefault(),!1):(e(this).parent().sbActive(!1),t.preventDefault(),!1)}),e(A).on("click","#conversation-agent li",function(t){let s=e(this).parent().parent(),a=e(this).data("id");return a==s.find(" > p").attr("data-value")||(SBChat.conversation?(s.sbLoading()||i(`${o("The new agent will be")} ${e(this).html()}.`,"alert",()=>{s.sbLoading(!0);lt.getSelectedConversations().forEach(e=>{lt.assignAgent(e.id,a,()=>{SBChat.conversation&&SBChat.conversation.id==e.id&&lt.setActiveAgent(a)})}),s.sbLoading(!1)}),t.preventDefault(),!1):(e(this).parent().sbActive(!1),t.preventDefault(),!1))}),N.on("click","> i,.sb-edit-note",function(t){let i=!!e(this).hasClass("sb-edit-note")&&e(this).closest("[data-id]");if(dt.genericPanel("notes",i?"Edit note":"Add new note",`<div class="sb-setting sb-type-textarea"><textarea${i?' data-id="'+i.attr("data-id")+'"':""} placeholder="${o("Write here your note...")}">${i?i.find(".sb-note-text").html().replace(/<a\s+href="([^"]*)".*?>(.*?)<\/a>/gi,"$1").replaceAll("<br>","\n"):""}</textarea></div>`,[[i?"Update note":"Add note",i?"check":"plus"]]),st.is("dialogflow")&&SB_ADMIN_SETTINGS.note_data_scrape){let e="";for(var s in SB_ADMIN_SETTINGS.note_data_scrape)e+=`<option value="${s}">${SB_ADMIN_SETTINGS.note_data_scrape[s]}</option>`;k.find("#sb-add-note").parent().prepend(`<div id="note-ai-scraping" class="sb-setting sb-type-select"><select><option value="">${o("Data scraping")}</option>${e}</select></div>`)}return t.preventDefault(),!1}),e(k).on("change","#note-ai-scraping select",function(){let i=e(this).val();i&&!a(e(this).parent())&&SBF.ajax({function:"data-scraping",conversation_id:SBChat.conversation.id,prompt_id:i},i=>{if(i&&i.error)return console.error(i),t(i.error.message,"error");e(this).parent().sbLoading(!1);let s=k.find(".sb-notes-box textarea");s.val((s.val()+"\n"+i).trim())})}),N.on("click",".sb-delete-note",function(){let t=e(this).parents().eq(1);lt.notes.delete(SBChat.conversation.id,t.attr("data-id"),e=>{!0===e?t.remove():SBF.error(e)})}),e(k).on("click","#sb-add-note, #sb-update-note",function(){let i=e(this).parent().parents().eq(1).find("textarea"),s=i.val(),n=i.attr("data-id");if(0==s.length)SBForm.showErrorMessage(k.find(".sb-notes-box"),"Please write something...");else{if(a(this))return;s=SBF.escape(s),lt.notes.add(SBChat.conversation.id,SB_ACTIVE_AGENT.id,SB_ACTIVE_AGENT.full_name,s,a=>{Number.isInteger(a)||!0===a?(e(this).sbLoading(!1),k.sbHideLightbox(),n&&N.find(`[data-id="${n}"]`).remove(),lt.notes.update([{id:n||a,conversation_id:SBChat.conversation.id,user_id:SB_ACTIVE_AGENT.id,name:SB_ACTIVE_AGENT.full_name,message:s}],!0),i.val(""),t(n?"Note successfully updated.":"New note successfully added.")):SBForm.showErrorMessage(a)},n)}}),E.on("click","> i",function(e){let t=lt.tags.getAll(SBChat.conversation.details.tags);SBChat.conversation.details.tags;return dt.genericPanel("tags","Manage tags",t?'<div class="sb-tags-cnt">'+t+"</div>":"<p>"+o("Add tags from Settings > Admin > Tags.")+"</p>",["Save tags"]),e.preventDefault(),!1}),e(k).on("click",".sb-tags-cnt > span",function(){e(this).toggleClass("sb-active")}),e(k).on("click","#sb-add-tag",function(){e('<input type="text">').insertBefore(this)}),e(k).on("click","#sb-save-tags",function(){if(a(this))return;let i=k.find(".sb-tags-box").find("span.sb-active").map(function(){return e(this).attr("data-value")}).toArray(),s=SBChat.conversation.id;SBF.ajax({function:"update-tags",conversation_id:s,tags:i},a=>{if(e(this).sbLoading(!1),!0===a&&(lt.tags.update(i),SBChat.conversation&&s==SBChat.conversation.id)){let t=lt.filters()[3],a=w(s);if(SBChat.conversation.set("tags",i),t&&!i.includes(t))a.remove(),lt.clickFirst();else if(SB_ADMIN_SETTINGS.tags_show){let t=a.find(".sb-tags-area"),s=lt.tags.codeLeft(i);t.length?t.replaceWith(s):e(s).insertAfter(a.find(".sb-name"))}}k.sbHideLightbox(),t(!0===a?"Tags have been successfully updated.":a)})}),e(R).on("click","span",function(){SBChat.insertText(e(this).text()),R.html("")}),e(R).on("mouseover","span",function(){ge=setTimeout(()=>{e(this).addClass("sb-suggestion-full")},2500)}),e(R).on("mouseout","span",function(){clearTimeout(ge),R.find("span").removeClass("sb-suggestion-full")}),e(A).on("click",".sb-list .sb-menu > li",function(){let t=e(this).closest("[data-id]"),i=t.attr("data-id"),s=SBChat.conversation.getMessage(i),a=s.get("user_type"),n=e(this).attr("data-value");switch(n){case"delete":SBChat.user_online?SBF.ajax({function:"update-message",message_id:i,message:"",attachments:[],payload:{event:"delete-message"}},()=>{SBChat.conversation.deleteMessage(i),t.remove()}):SBChat.deleteMessage(i);break;case"translation":case"original":let r="translation"==n,l=["translation","translation-language","original-message","original-message-language"],c=l.map(e=>s.payload(e)).concat(s.details.message);s.set("message",r?s.payload("translation")||s.get("message"):s.payload("original-message")||s.get("message")),l.forEach(e=>delete s.details.payload[e]),t.replaceWith(s.getCode().replace('sb-menu">',`sb-menu"><li data-value="${r?"original":"translation"}">${o(r?"View original message":"View translation")}</li>`)),l.forEach((e,t)=>s.payload(e,c[t])),s.details.message=c[4];break;case"bot":st.dialogflow.showCreateIntentBox(e(this).closest("[data-id]").attr("data-id"));break;case"reply":let d=SBF.isAgent(a),u=s.get("message");u||s.attachments.forEach(e=>{u+='<i class="sb-icon-clip"></i>'+e[0]}),A.find(".sb-editor [data-reply]").remove(),A.find(".sb-editor").prepend(`<div data-reply="${i}"${d?' class="sb-reply-color"':""}><span>${d&&k||!d&&!k?o("You"):s.get("full_name")}</span>${u}<i class="sb-icon-close" onclick="SBChat.cancelReply()"></i></div>`),T.addClass("sb-reply-active")}}),e(A).on("click",".sb-filter-btn i",function(){e(this).parent().toggleClass("sb-active")}),e(A).on("click",".sb-filter-star",function(){e(this).parent().find("li").sbActive(!1),e(this).parent().find(`li[data-value="${e(this).sbActive()?"":e(this).attr("data-value")}"]`).last().sbActive(!0).click(),e(this).toggleClass("sb-active")}),L.on("click","#sb-attachments-filter li",function(){let t=L.find("a:not(.sb-collapse-btn)"),i=e(this).attr("data-value");t.each(function(){e(this).setClass("sb-hide",i&&SBF.getFileType(e(this).attr("href"))!=i)}),l(L,160)}),e(k).on("click",".sb-cc-box #sb-save-changes",function(){let t=k.find(".sb-cc-box .repeater-item input").map(function(){return e(this).val()}).get().join(",");a(this),SBF.ajax({function:"update-conversation-extra",conversation_id:SBChat.conversation.id,extra:t||"NULL"},()=>{SBChat.conversation.set("extra",t),lt.cc(t.split(",")),e(this).sbLoading(!1),k.sbHideLightbox()})}),SBF.getURL("user")&&(x.find(".sb-admin-nav #sb-users").click(),setTimeout(()=>{ct.show(SBF.getURL("user"))},500)),e(U).on("click","th :checkbox",function(){U.find("td :checkbox").prop("checked",e(this).prop("checked"))}),e(U).on("click",":checkbox",function(){let e=G.find('[data-value="delete"]');U.find("td input:checked").length?e.removeAttr("style"):e.hide()}),e(P).on("click","li",function(){rt.filter(e(this).data("type"))}),e(q).on("click","li",function(){let t=q.closest(".sb-filter-btn");setTimeout(()=>{rt.get(e=>{rt.populate(e)}),t.attr("data-badge",q.toArray().reduce((t,i)=>t+!!e(i).find("li.sb-active").data("value"),0))},100),t.sbActive(!1)}),e(G).on("input",".sb-search-btn input",function(){rt.search(this)}),e(G).on("click",".sb-search-btn i",function(){SBF.searchClear(this,()=>{rt.search(e(this).next())})}),e(U).on("click","th:not(:first-child)",function(){let t=e(this).hasClass("sb-order-asc")?"DESC":"ASC";e(this).toggleClass("sb-order-asc"),e(this).siblings().sbActive(!1),e(this).sbActive(!0),rt.sort(e(this).data("field"),t)}),e(U).parent().on("scroll",function(){!Xe&&!rt.search_query&&d(this,!0)&&Ge&&(Xe=!0,G.append('<div class="sb-loading-global sb-loading sb-loading-pagination"></div>'),rt.get(e=>{if(setTimeout(()=>{Xe=!1},500),Ge=e.length){let i="";for(var t=0;t<Ge;t++){let s=new SBUser(e[t],e[t].extra);i+=rt.getRow(s),Re[s.id]=s}je++,U.find("tbody").append(i)}G.find(" > .sb-loading-pagination").remove()},!1,!0))}),e(V).on("click",".sb-delete",function(){if(SB_ACTIVE_AGENT.id==s().id)return t("You cannot delete yourself.","error");i("This user will be deleted permanently including all linked data, conversations, and messages.","alert",function(){rt.delete(s().id)})}),e(U).on("click","td:not(:first-child)",function(){ct.show(e(this).parent().attr("data-user-id"))}),e(O).on("click",".sb-top-bar .sb-edit",function(){ct.showEdit(s())}),e(G).on("click",".sb-new-user",function(){V.addClass("sb-user-new"),V.find(".sb-top-bar .sb-profile span").html(o("Add new user")),V.find(".sb-top-bar .sb-save").html(`<i class="sb-icon-check"></i>${o("Add user")}`),V.find("input,select,textara").removeClass("sb-error"),V.removeClass("sb-cloud-admin"),"admin"==SB_ACTIVE_AGENT.user_type&&V.find("#user_type").find("select").html(`<option value="user">${o("User")}</option><option value="agent">${o("Agent")}</option><option value="admin">${o("Admin")}</option>`),ct.clear(V),ct.boxClasses(V),ct.updateRequiredFields("user"),V.sbShowLightbox()}),e(V).on("click",".sb-save",function(){if(a(this))return;let i=!!V.hasClass("sb-user-new"),n=V.attr("data-user-id"),r=ct.getAll(V.find(".sb-details")),l=ct.getAll(V.find(".sb-additional-details"));return e.map(r,function(e,t){r[t]=e[0]}),ct.errors(V)?(ct.showErrorMessage(V,SBF.isAgent(V.find("#user_type :selected").val())?"First name, last name, password and a valid email are required. Minimum password length is 8 characters.":V.find("#password").val().length<8?"Minimum password length is 8 characters.":"First name is required."),void e(this).sbLoading(!1)):SB_ACTIVE_AGENT.id==s().id&&"agent"==r.user_type&&"admin"==SB_ACTIVE_AGENT.user_type?(ct.showErrorMessage(V,"You cannot change your status from admin to agent."),void e(this).sbLoading(!1)):(r.user_type||(r.user_type="user"),void SBF.ajax({function:i?"add-user":"update-user",user_id:n,settings:r,settings_extra:l},a=>{if(SBF.errorValidation(a,"duplicate-email")||SBF.errorValidation(a,"duplicate-phone"))return ct.showErrorMessage(V,`This ${SBF.errorValidation(a,"duplicate-email")?"email":"phone number"} is already in use.`),void e(this).sbLoading(!1);i&&(n=a,s(new SBUser({id:n}))),s().update(()=>{Re[n]=s(),i?(ct.clear(V),rt.update()):(rt.updateRow(s()),A.sbActive()&&lt.updateUserDetails(),n==SB_ACTIVE_AGENT.id&&(SBF.loginCookie(a[1]),SB_ACTIVE_AGENT.full_name=s().name,SB_ACTIVE_AGENT.profile_image=s().image,x.find(".sb-account").setProfile())),i&&V.find(".sb-profile").setProfile(o("Add new user")),e(this).sbLoading(!1),i||k.sbHideLightbox(),t(i?"New user added":"User updated")}),SBF.event("SBUserUpdated",{new_user:i,user_id:n})}))}),e(V).on("change","#user_type",function(){let t=e(this).find("option:selected").val();ct.boxClasses(V,t),ct.updateRequiredFields(t)}),e(O).on("click",".sb-user-conversations li",function(){lt.open(e(this).attr("data-conversation-id"),e(this).find("[data-user-id]").attr("data-user-id"))}),e(O).on("click",".sb-start-conversation",function(){lt.open(-1,s().id),lt.openConversation(-1,s().id),We&&lt.mobileOpenConversation()}),e(O).on("click",".sb-top-bar [data-value]",function(){lt.showDirectMessageBox(e(this).attr("data-value"),[s().id])}),e(G).on("click",".sb-top-bar [data-value]",function(){let s=e(this).data("value"),a=rt.getSelected();switch(s){case"whatsapp":m(a);break;case"message":case"custom_email":case"sms":lt.showDirectMessageBox(s,a);break;case"csv":rt.csv();break;case"delete":if(a.includes(SB_ACTIVE_AGENT.id))return t("You cannot delete yourself.","error");i("All selected users will be deleted permanently including all linked data, conversations, and messages.","alert",()=>{rt.delete(a),e(this).hide(),U.find("th:first-child input").prop("checked",!1)})}}),e(k).on("click",".sb-send-direct-message",function(){let i=e(this).attr("data-type")?e(this).attr("data-type"):D.attr("data-type"),s="whatsapp"==i,n=s?k.find("#sb-whatsapp-send-template-box"):D,o=n.find(".sb-direct-message-subject input").val(),r=s?"":n.find("textarea").val(),l=n.find(".sb-direct-message-users").val().replace(/ /g,""),d=!1,u=!1,p=[],h=!1;if(s){let e=n.find("#sb-whatsapp-send-template-list");d=e.val(),u=e.find("option:selected").attr("data-languages"),h=e.find("option:selected").attr("data-phone-id"),p=["header","body","button"].map(e=>n.find(`#sb-whatsapp-send-template-${e}`).val())}if(SBForm.errors(n))SBForm.showErrorMessage(n,"Please complete the mandatory fields.");else{if(a(this))return;let s=[];if((r.includes("recipient_name")||p.join("").includes("recipient_name"))&&s.push("first_name","last_name"),(r.includes("recipient_email")||p.join("").includes("recipient_email"))&&s.push("email"),"message"==i)SBF.ajax({function:"direct-message",user_ids:l,message:r},a=>{e(this).sbLoading(!1);let d=SB_ADMIN_SETTINGS.notify_user_email,u=SB_ADMIN_SETTINGS.sms_active_users;if(SBF.errorValidation(a))return SBForm.showErrorMessage(n,"An error has occurred. Please make sure all user ids are correct.");(d||u)&&SBF.ajax({function:"get-users-with-details",user_ids:l,details:s.concat(d&&u?["email","phone"]:[d?"email":"phone"])},e=>{d&&e.email.length?c(e,"email",r,0,u?e.phone:[],"email",o):u&&e.phone.length?c(e,"phone",r,0,[],"sms"):k.sbHideLightbox()}),t(`${SBF.slugToString(i)} sent to all users.`)});else{let t="custom_email"==i?"email":"phone";SBF.ajax({function:"get-users-with-details",user_ids:l,details:s.concat([t])},s=>{if(!s[t].length)return e(this).sbLoading(!1),SBForm.showErrorMessage(n,"No users found.");c(s,t,r,0,[],i,o,d,p,u,h)})}}}),e(G).on("click",".sb-filter-btn > i",function(){e(this).parent().toggleClass("sb-active")}),SBF.getURL("setting")&&at.open(SBF.getURL("setting"),!0),e(H).on("click"," > .sb-tab > .sb-nav [id]",function(){let t=e(this).attr("id").substr(4);SBF.getURL("setting")!=t&&f("?setting="+t)}),e(k).on("click",'.sb-repeater-upload, [data-type="upload-image"] .image, [data-type="upload-file"] .sb-btn, #sb-chatbot-add-files, #sb-import-settings a, #sb-import-users a',function(){let s="";ue=this,"sb-chatbot-add-files"==e(this).attr("id")?(s=".pdf,.txt,.json,.csv",ie.find(".sb-pending").remove(),st.openAI.train.skip_files=[],pe=function(){let e=de.prop("files"),t="";for(var i=0;i<e.length;i++){let s=parseInt(e[i].size/1e3);t+=`<tr class="sb-pending" data-name="${e[i].name}"><td><input type="checkbox" /></td><td>${e[i].name}<label>${o("Pending")}</label></td><td>${s||1} KB</td><td><i class="sb-icon-delete"></i></td></tr>`}ie.append(t)}):"sb-import-settings"==e(this).parent().parent().attr("id")?(s=".json",he=(s=>{a(this)||(SBF.ajax({function:"import-settings",file_url:s},s=>{s?t("Settings saved. Reload to apply the changes."):i(s),e(this).sbLoading(!1)}),he=!1)})):"sb-import-users"==e(this).parent().parent().attr("id")?(s=".csv",he=(s=>{a(this)||(SBF.ajax({function:"import-users",file_url:s},s=>{s?t("Users imported successfully."):i(s),e(this).sbLoading(!1)}),he=!1)})):e(this).hasClass("image")?s=".png,.jpg,.jpeg,.gif,.webp":e(this).hasClass("sb-repeater-upload")&&(he=(t=>{let i=e(this).parent();i.find(".repeater-item:last-child input").val()&&at.repeater.add(this),i.find(".repeater-item:last-child input").val(t)})),de.attr("accept",s).prop("value","").click()}),e(H).on("click",'[data-type="upload-image"] .image > i',function(t){return SBF.ajax({function:"delete-file",path:e(this).parent().attr("data-value")}),e(this).parent().removeAttr("data-value").css("background-image",""),t.preventDefault(),!1}),e(k).on("click",".sb-repeater-add",function(){at.repeater.add(this)}),e(k).on("click",".repeater-item > i",function(){setTimeout(()=>{at.repeater.delete(this)},100)}),at.initColorPicker(),e(H).find('[data-type="color"]').focusout(function(){let t=e(this).find("input").val();"rgb(255, 255, 255)"==t&&["color-admin-1","color-1"].includes(e(this).attr("id"))&&(t=""),setTimeout(()=>{e(this).find("input").val(t),e(this).find(".color-preview").css("background-color",t)},300),at.set(e(this).attr("id"),[t,"color"])}),e(H).on("click",".sb-type-color .input i",function(t){e(this).parent().find("input").removeAttr("style").val("")}),e(H).on("click",".sb-color-palette span",function(){let t=e(this).sbActive();e(this).closest(".sb-repeater").find(".sb-active").sbActive(!1),e(this).sbActive(!t)}),e(H).on("click",".sb-color-palette ul li",function(){e(this).parent().parent().attr("data-value",e(this).data("value")).find("span").sbActive(!1)}),e(H).on("click",'[data-type="select-images"] .input > div',function(){e(this).siblings().sbActive(!1),e(this).sbActive(!0)}),e(H).on("click",".sb-select-checkbox-input",function(){e(this).toggleClass("sb-active")}),e(H).on("click",".sb-select-checkbox input",function(){let t=e(this).closest("[data-type]");t.find(".sb-select-checkbox-input").val(at.get(t)[1].join(", "))}),e(H).on("click",".sb-save-changes",function(){at.save(this)}),e(H).on("change",'#saved-replies [data-id="reply-name"], [data-id="rich-message-name"]',function(){e(this).val(e(this).val().replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^-+/,"").replace(/-+$/,"").replace(/ /g,""))}),e(H).on("change",'#user-additional-fields [data-id="extra-field-name"]',function(){e(this).parent().next().find("input").val(SBF.stringToSlug(e(this).val()))}),e(H).on("click","#timetable-utc input",function(){e(this).val()||e(this).val(Ye.getTimezoneOffset()/60)}),e(H).on("click","#dialogflow-sync-btn a",function(e){let t="https://accounts.google.com/o/oauth2/auth?scope=https%3A%2F%2Fwww.googleapis.com/auth/dialogflow%20https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcloud-translation%20https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcloud-language&response_type=code&access_type=offline&redirect_uri="+SB_URL+"/apps/dialogflow/functions.php&client_id={client_id}&prompt=consent";if(!SB_ADMIN_SETTINGS.cloud||"auto"!=H.find("#google-sync-mode select").val()){let s=H.find("#google-client-id input").val();return s&&H.find("#google-client-secret input").val()?window.open(t.replace("{client_id}",s)):i("Before continuing enter Client ID and Client secret. Check the docs for more details."),e.preventDefault(),!1}if(SB_ADMIN_SETTINGS.credits)return window.open(t.replace("{client_id}",SB_ADMIN_SETTINGS.google_client_id)),e.preventDefault(),!1}),e(H).on("click","#dialogflow-redirect-url-btn a",function(e){return i(`<pre>${SB_URL}/apps/dialogflow/functions.php</pre>`),e.preventDefault(),!1}),e(H).on("click","#dialogflow-saved-replies a",function(t){return i("","alert",()=>{a(this)||SBF.ajax({function:"dialogflow-saved-replies"},()=>{e(this).sbLoading(!1)})}),t.preventDefault(),!1}),e(H).on("click","#test-email-user a, #test-email-agent a",function(){let t=e(this).parent().find("input").val();t&&t.indexOf("@")>0&&!a(this)&&SBF.ajax({function:"send-test-email",to:t,email_type:"test-email-user"==e(this).parent().parent().attr("id")?"user":"agent"},t=>{i(!0===t?"The message has been sent.":t,"info"),e(this).sbLoading(!1)})}),e(H).on("click","#email-server-troubleshoot a",function(e){return H.find("#test-email-user input").val(SB_ACTIVE_AGENT.email).next().click()[0].scrollIntoView({behavior:"smooth"}),e.preventDefault(),!1}),e(H).on("click","#test-sms-user a, #test-sms-agent a",function(){let t=e(this).parent().find("input").val();t&&!a(this)&&SBF.ajax({function:"send-sms",message:"Hello World!",to:t},t=>{i(t&&["sent","queued"].includes(t.status)?"The message has been sent.":`<pre>${JSON.stringify(t)}</pre>`),e(this).sbLoading(!1)})}),e(H).on("click",".sb-timetable > div > div > div",function(){let t=e(this).closest(".sb-timetable"),i=e(this).sbActive();if(e(t).find(".sb-active").sbActive(!1),i)e(this).sbActive(!1).find(".sb-custom-select").remove();else{let i=e(t).find("> .sb-custom-select").html();e(t).find(" > div .sb-custom-select").remove(),e(this).append(`<div class="sb-custom-select">${i}</div>`).sbActive(!0)}}),e(H).on("click",".sb-timetable .sb-custom-select span",function(){let t=[e(this).html(),e(this).attr("data-value")];e(this).closest(".sb-timetable").find("> div > div > .sb-active").html(t[0]).attr("data-value",t[1]),e(this).parent().sbActive(!1)}),e(H).on("click","#system-requirements a",function(e){let t="";return SBF.ajax({function:"system-requirements"},e=>{for(var i in e)t+=`<div class="sb-input"><span>${o(SBF.slugToString(i))}</span><div${e[i]?' class="sb-green"':""}>${o(e[i]?"Success":"Error")}</div></div>`;n(!1),dt.genericPanel("requirements","System requirements",t)}),n(),e.preventDefault(),!1}),e(H).on("click","#sb-path a",function(e){return SBF.ajax({function:"path"},e=>{i(`<pre>${e}</pre>`)}),e.preventDefault(),!1}),e(H).on("click","#sb-url a",function(e){return i(`<pre>${SB_URL}</pre>`),e.preventDefault(),!1}),e(H).on("click","#delete-leads a",function(t){return e(this).sbLoading()||i("All leads, including all the linked conversations and messages, will be deleted permanently.","alert",()=>{e(this).sbLoading(!0),SBF.ajax({function:"delete-leads"},()=>{i("Leads and conversations successfully deleted."),e(this).sbLoading(!1)})}),t.preventDefault(),!1}),e(H).on("click","#sb-export-settings a",function(t){if(t.preventDefault(),!a(this))return SBF.ajax({function:"export-settings"},t=>{_(t,"sb-export-settings-close","Settings exported"),e(this).sbLoading(!1)}),!1}),e(k).on("click","#sb-export-settings-close .sb-close, #sb-export-users-close .sb-close, #sb-export-report-close .sb-close",function(){SBF.ajax({function:"delete-file",path:k.find(".sb-dialog-box p pre").html()})}),SB_ADMIN_SETTINGS.cloud||(e(H).on("change","#push-notifications-provider select",function(){let t="pusher"==e(this).val();at.visibility(0,t),SBF.ajax({function:"update-sw",url:t?"https://js.pusher.com/beams/service-worker.js":"https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.sw.js"})}),e(H).on("click","#push-notifications-sw-path a",function(e){let t=b(location.href.replace(location.host,"")).replace("admin.php","");return t.includes("?")&&(t=t.substring(0,t.indexOf("?"))),i("<pre>"+t+"</pre>"),e.preventDefault(),!1})),e(H).on("click","#push-notifications-btn a",function(e){return SB_ADMIN_SETTINGS.cloud||"onesignal"==H.find("#push-notifications-provider select").val()?typeof OneSignal!=Ke?OneSignal.Slidedown.promptPush({force:!0}):SBF.serviceWorker.initPushNotifications():Notification.requestPermission(),e.preventDefault(),!1}),e(H).on("input","#sb-search-settings",function(){let t=e(this).val().toLowerCase();SBF.search(t,()=>{let i="",s=H.find(".sb-search-dropdown-items");if(t.length>2){let s=H.find("> .sb-tab > .sb-nav li").map(function(){return e(this).text().trim()}).get();H.find(".sb-setting").each(function(){let a=e(this).attr("data-keywords"),n=e(this).attr("id");if(a&&a.includes(t)||n&&n.replaceAll("-","-").includes(t)||e(this).find(".sb-setting-content").text().toLowerCase().includes(t)){let t=e(this).parent().index();i+=`<div data-tab-index="${t}" data-setting="${e(this).attr("id")}">${s[t]} > ${e(this).find("h2").text()}</div>`}})}s.html(i),s.outerHeight()>e(window).height()-100?(s.css("max-height",e(window).height()-100),s.addClass("sb-scroll-area")):s.removeClass("sb-scroll-area")})}),e(H).on("click",".sb-search-dropdown-items div",function(){let t=e(this).attr("data-tab-index"),i=H.find("> .sb-tab > .sb-nav li").eq(t);i.click(),i.get(0).scrollIntoView(),H.find("#"+e(this).attr("data-setting"))[0].scrollIntoView()}),e(H).on("click","#slack-button a",()=>(window.open("https://board.support/synch/?service=slack&plugin_url="+SB_URL+g()),!1)),e(H).on("click","#slack-test a",function(t){if(!a(this))return SBF.ajax({function:"send-slack-message",user_id:!1,full_name:SB_ACTIVE_AGENT.full_name,profile_image:SB_ACTIVE_AGENT.profile_image,message:"Lorem ipsum dolor sit amete consectetur adipiscing elite incidido labore et dolore magna aliqua.",attachments:[["Example link",SB_URL+"/media/user.svg"],["Example link two",SB_URL+"/media/user.svg"]],channel:H.find("#slack-channel input").val()},t=>{i(SBF.errorValidation(t)?"slack-not-active"==t[1]?"Please first activate Slack, then save the settings and reload the admin area.":"Error. Response: "+JSON.stringify(t):"success"==t[0]?"Slack message successfully sent. Check your Slack app!":JSON.stringify(t)),e(this).sbLoading(!1)}),t.preventDefault(),!1}),e(H).on("click","#tab-slack",function(){let e=H.find("#slack-agents .input");e.html('<div class="sb-loading"></div>'),SBF.ajax({function:"slack-users"},t=>{let i="";if(SBF.errorValidation(t,"slack-token-not-found"))i=`<p>${o("Synchronize Slack and save changes before linking agents.")}</p>`;else{let e='<option value="-1"></option>';for(s=0;s<t.agents.length;s++)e+=`<option value="${t.agents[s].id}">${t.agents[s].name}</option>`;for(var s=0;s<t.slack_users.length;s++)i+=`<div data-id="${t.slack_users[s].id}"><label>${t.slack_users[s].name}</label><select>${e}</select></div>`}e.html(i),at.set("slack-agents",[t.saved,"double-select"])})}),e(H).on("click","#slack-archive-channels a",function(t){t.preventDefault(),a(this)||SBF.ajax({function:"archive-slack-channels"},t=>{!0===t&&i("Slack channels archived successfully!"),e(this).sbLoading(!1)})}),e(H).on("click","#slack-channel-ids a",function(t){t.preventDefault(),a(this)||SBF.ajax({function:"slack-channels",code:!0},t=>{i(t,"info",!1,"","",!0),e(this).sbLoading(!1)})}),e(H).on("click",'#whatsapp-twilio-btn a, #whatsapp-twilio-get-configuartion-btn a, #sms-btn a, #wechat-btn a, #twitter-callback a, #viber-webhook a, #zalo-webhook a, [data-id="line-webhook"], #messenger-path-btn a',function(t){let s=e(this).closest("[id]").attr("id"),a="";if(t.preventDefault(),"line"==s){if(!(a=e(this).closest(".repeater-item").find('[data-id="line-secret"]').val()))return;a="?line_secret="+a}return i(`<pre>${SB_URL+("sms-btn"==s?"/include/api.php":"/apps/"+(s.includes("-")?s.substring(0,s.indexOf("-")):s)+"/post.php")+a+g().replace("&",a?"&":"?")}</pre>`),!1}),e(H).on("click",'[data-id="telegram-numbers-button"], #viber-button a, #whatsapp-360-button a',function(t){let s,n={"telegram-button":["#telegram-token input","telegram-synchronization",["result",!0]],"viber-button":["#viber-token input","viber-synchronization",["status_message","ok"]],"whatsapp-360-button":["#whatsapp-360-key input","whatsapp-360-synchronization",["success",!0]]},o=e(this).parent().attr("id"),r=!1;if(o)s=H.find(n[o][0]).val().trim();else{o={"telegram-numbers-button":"telegram-button"}[e(this).attr("data-id")],s=e(this).closest(".repeater-item").find(`[data-id="${{"telegram-button":"telegram-numbers-token"}[o]}"]`).val().trim(),r=!0}return n=n[o],t.preventDefault(),!(!s||a(this))&&(SBF.ajax({function:n[1],token:s,cloud_token:g(),is_additional_number:r},t=>{i(n[2][0]in t&&t[n[2][0]]==n[2][1]?"Synchronization completed.":JSON.stringify(t)),e(this).sbLoading(!1)}),!1)}),e(H).on("click","#whatsapp-test-template a",function(t){t.preventDefault();let s=e(this).parent().find("input").val();if(s&&!a(this))return SBF.ajax({function:"whatsapp-send-template",to:s},t=>{i(t?"error"in t?t.error.message?t.error.message:t.error:"Message sent, check your WhatsApp!":t),e(this).sbLoading(!1)}),!1}),e(H).on("click","#twitter-subscribe a",function(t){return t.preventDefault(),!a(this)&&(SBF.ajax({function:"twitter-subscribe",cloud_token:g()},t=>{i(!0===t?"Synchronization completed.":JSON.stringify(t)),e(this).sbLoading(!1)}),!1)}),SB_ADMIN_SETTINGS.cloud||e(H).on("click","#messenger-sync-btn a",()=>(window.open("https://board.support/synch/?service=messenger&plugin_url="+SB_URL+g()),!1)),e(H).on("change","#messenger-sync-mode select",function(){at.visibility(1,"manual"!=e(this).val())}),e(H).on("click","#messenger-unsubscribe a",function(t){return t.preventDefault(),i("","alert",()=>{if(a(this))return!1;SBF.ajax({function:"messenger-unsubscribe"},t=>{e(this).sbLoading(!1),t?i(JSON.stringify(t)):(H.find("#messenger-pages .repeater-item > i").click(),setTimeout(()=>{at.save(),i("Operation successful.")},300))})}),!1}),e(H).on("change","#open-ai-mode select",function(){at.visibility(2,"assistant"!=e(this).val())}),e(H).on("click","#wp-sync a",function(t){return t.preventDefault(),!a(this)&&(st.wordpress.ajax("wp-sync",{},t=>{!0===t||"1"===t?(rt.update(),i("WordPress users successfully imported.")):i("Error. Response: "+JSON.stringify(t)),e(this).sbLoading(!1)}),!1)}),e("body").on("click","#wp-admin-bar-logout",function(){SBF.logout(!1)}),e(H).on("click","#whatsapp-clear-flows a",function(e){e.preventDefault(),SBF.ajax({function:"whatsapp-clear-flows"})}),e(H).on("click","#tab-translations",function(){let e=H.find(".sb-translations > .sb-nav > ul");if(!e.html()){let i="";for(var t in SB_LANGUAGE_CODES)"en"!=t&&(i+=`<li data-code="${t}"><img src="${SB_URL}/media/flags/${t}.png" />${SB_LANGUAGE_CODES[t]}</li>`);e.html(i)}}),e(H).on("click",".sb-translations .sb-nav li",function(){at.translations.load(e(this).data("code"))}),e(H).on("click",".sb-translations .sb-menu-wide li",function(){H.find(`.sb-translations [data-area="${e(this).data("value")}"]`).sbActive(!0).siblings().sbActive(!1)}),e(H).on("click",".sb-add-translation",function(){H.find(".sb-translations-list > .sb-active").prepend(`<div class="sb-setting sb-type-text sb-new-translation"><input type="text" placeholder="${o("Enter original text...")}"><input type="text" placeholder="${o("Enter translation...")}"></div></div>`)}),e(H).on("input",".sb-search-translation input",function(){let t=e(this).val().toLowerCase();SBF.search(t,()=>{t.length>1&&H.find(".sb-translations .sb-content > .sb-active label").each(function(){let i=e(this).html().toLowerCase();if(i.includes(t)&&i!=Se){let t=H.find(".sb-scroll-area");return t[0].scrollTop=0,t[0].scrollTop=e(this).position().top-80,Se=i,!1}})})}),e(H).on("click",'[data-id="email-piping-sync"]',function(t){a(this)||(SBF.ajax({function:"email-piping",force:!0},t=>{i(!0===t?"Syncronization completed.":t),e(this).sbLoading(!1)}),t.preventDefault())}),e(H).on("click","#tab-automations",function(){at.automations.get(()=>{at.automations.populate(),n(!1)},!0),n()}),e(k).on("click",".sb-add-condition",function(){at.automations.addCondition(e(this).prev())}),e(k).on("change",".sb-condition-1 select",function(){at.automations.updateCondition(this)}),e(k).on("change",".sb-condition-2 select",function(){e(this).parent().next().setClass("sb-hide",["is-set","is-not-set"].includes(e(this).val()))}),e(z).on("click","li",function(){at.automations.populate(e(this).data("value"))}),e(J).on("click","li",function(){at.automations.show(e(this).attr("data-id"))}),e(W).on("click",".sb-add-automation",function(){at.automations.add()}),e(J).on("click","li i",function(){i("The automation will be deleted permanently.","alert",()=>{at.automations.delete(this)})});let me=["Settings > {R} won't work if Settings > {R2} is active."];e(H).on("click",".sb-setting",function(i){let s=e(this).attr("id");switch(e(this).hasClass("sb-type-multi-input")&&(s=e(i.target).parent().attr("id")),s){case"close-chat":case"close-message":H.find("#close-active input").is(":checked")&&H.find("#close-chat input").is(":checked")&&t(me[0].replace("{R}","Messages > Close message").replace("{R2}","Chat > Close chat"),"info");break;case"chat-timetable":case"follow-message":case"queue":case"routing":("queue"==s&&H.find("#queue-active input").is(":checked")||"routing"==s&&H.find("#routing input").is(":checked")||"follow-message"==s&&H.find("#follow-active input").is(":checked")||"chat-timetable"==s&&H.find("#chat-timetable-active input").is(":checked"))&&H.find("#dialogflow-human-takeover-active input").is(":checked")&&t("Since Settings > Artificial Intelligence > Human takeover is active, this option will only take effect during human takeover.","info");break;case"notify-agent-email":case"push-notifications":case"sms":("sms"==s&&H.find("#sms-active-agents input").is(":checked")||"push-notifications"==s&&H.find("#push-notifications-active input").is(":checked")||"notify-agent-email"==s&&H.find("#notify-agent-email input").is(":checked"))&&H.find("#dialogflow-human-takeover-active input").is(":checked")&&t("Since Settings > Artificial Intelligence > Human takeover is active, notifications will be sent only after the human takeover.","info");break;case"privacy":H.find("#privacy-active input").is(":checked")&&H.find("#registration-required select").val()&&t(me[0].replace("{R}","Messages > Privacy message").replace("{R2}","Users > Require registration"),"info");break;case"google-multilingual-translation":e(i.target).is(":checked")&&H.find("#open-ai-active input").is(":checked")&&!H.find("#open-ai-training-data-language select").val()&&t("If your OpenAI training data isn't in English, set the default language under OpenAI > Training data language.","info");break;case"open-ai-prompt":t("Custom prompts may break the chatbot, we advise leaving it empty.","info");break;case"open-ai-tokens":case"open-ai-temperature":case"open-ai-presence-penalty":case"open-ai-frequency-penalty":case"open-ai-logit-bias":case"open-ai-custom-model":t("This is an advanced setting, incorrect values may break the chatbot. If you're unsure, leave it empty.","info");break;case"open-ai-user-train-conversations":e(i.target).is(":checked")&&t("This method is not recommended. See the docs for details.","info")}}),e(P).on("click",'[data-type="online"]',function(){SB_ADMIN_SETTINGS.visitors_registration||t("Settings > Users > Register all visitors must be enabled to see online users.","info")}),e(H).on("click","#dialogflow-active,#dialogflow-welcome,#dialogflow-departments",function(e){t("Warning! We will stop supporting Dialogflow by the end of 2025. All its features will be available through OpenAI. Please use OpenAI instead of Dialogflow.","info")}),e(H).on("change","#registration-required select",function(){let i=e(this).val();["registration-login"].includes(i)&&!H.find('[id="reg-email"] input').is(":checked")&&t("The email field is required to activate the login form.","info"),i&&H.find("#privacy-active input").is(":checked")&&t(me[0].replace("{R}","Messages > Privacy message").replace("{R2}","Users > Require registration"),"info")}),e(te).on("click","#sb-flow-add",function(){dt.genericPanel("flow-add","Enter the flow name",'<div class="sb-setting"><input type="text"></div>',["Add new flow"])}),e(k).on("click","#sb-add-new-flow",function(){st.openAI.flows.set(k.find(".sb-flow-add-box input").val()),k.sbHideLightbox()}),e(le).on("click",".sb-flow-block",function(){le.find(".sb-flow-block,.sb-flow-add-block").sbActive(!1),e(this).sbActive(!0);let t,i=st.openAI.flows.blocks.get(),s="",a=e(this).attr("data-type"),n=`<div class="sb-title">{R}</div><div data-type="repeater" class="sb-setting sb-type-repeater"><div class="input"><div class="sb-repeater">{R2}</div><div class="sb-btn sb-btn-white sb-repeater-add sb-icon"><i class="sb-icon-plus"></i>${o("Add new item")}</div></div></div>`,r=`<div class="sb-title">${o("Conditions")}</div><div class="sb-flow-conditions"></div><div class="sb-add-condition sb-btn sb-icon sb-btn-white"><i class="sb-icon-plus"></i>${o("Add condition")}</div>`,l=`<div class="sb-title">${o("Message")}</div><div class="sb-setting"><textarea placeholder="${o("The message sent to the user...")}">${i.message}</textarea></div>`,c=st.openAI.getCode.select_user_details();switch(a){case"start":t=`<div class="sb-title">${o("Start event")}</div><div class="sb-setting"><select class="sb-flow-start-select"><option value="message"${"message"==i.start?" selected":""}>${o("User message")}</option><option value="conversation"${"conversation"==i.start?" selected":""}>${o("New conversation started")}</option><option value="load"${"load"==i.start?" selected":""}>${o("On page load")}</option></select></div><div class="sb-title sb-title-flow-start${"message"==i.start?"":" sb-hide"}">${o("User message")}</div><div data-type="repeater" class="sb-setting sb-flow-start-messages sb-type-repeater"><div class="input"><div class="sb-repeater"><div class="repeater-item"><div class="sb-setting"><textarea data-id="message"></textarea></div><i class="sb-icon-close"></i></div></div><div class="sb-btn sb-btn-white sb-repeater-add sb-icon"><i class="sb-icon-plus"></i>${o("Add message")}</div></div></div>${r}<div class="sb-title">${o("Disabled")}</div><div class="sb-setting"><input type="checkbox" id="sb-flow-disabled"${i.disabled?" checked":""}></div>`;break;case"button_list":i.options&&i.options.length||(i.options=[""]);for(d=0;d<i.options.length;d++)s+=`<div class="repeater-item"><div><input data-id type="text" value="${i.options[d]}"></div><i class="sb-icon-close"></i></div>`;t=l+n.replace("{R}",o("Buttons")).replace("{R2}",s);break;case"message":i.attachments&&i.attachments.length||(i.attachments=[""]);for(d=0;d<i.attachments.length;d++)s+=`<div class="repeater-item"><div><input data-id type="text" value="${i.attachments[d]}" placeholder="${o("Enter a link...")}"></div><i class="sb-icon-close"></i></div>`;t=l+n.replace("{R}",o("Attachments")).replace("{R2}",s).replace("</div></div></div>",'</div><i class="sb-repeater-upload sb-btn-icon sb-icon-clip"></i></div></div>');break;case"video":t=`${l}<div class="sb-title">${o("Video URL")}</div><div class="sb-setting"><input type="url" placeholder="${o("Enter a YouTube or Vimeo link...")}" value="${i.url}"></div>`;break;case"get_user_details":i.details&&i.details.length||(i.details=[["","",!1]]);for(d=0;d<i.details.length;d++)s+=`<div class="repeater-item"><div>${c.replace(`"${i.details[d][0]}"`,`"${i.details[d][0]}" selected`)}<div class="sb-setting"><input type="text" placeholder="${o("Enter a description...")}" value="${i.details[d][1]}" /></div><div class="sb-setting"><label>${o("Required")}</label><input type="checkbox" ${i.details[d][2]?" checked":""}></div></div><i class="sb-icon-close"></i></div>`;t=l+n.replace("{R}",o("User details")).replace("{R2}",s).replace("sb-type-repeater","sb-type-repeater sb-repeater-block-user-details");break;case"set_data":t=st.openAI.getCode.set_data(i.data);break;case"action":t=st.openAI.getCode.actions(i.actions);break;case"rest_api":let e=["headers","save_response"];t=`<div class="sb-title">${o("URL")}</div><div class="sb-setting"><input type="url" class="sb-rest-api-url" value="${i.url}"></div><div class="sb-title">${o("Method")}</div><div class="sb-setting"><select class="sb-rest-api-method"><option value="GET"${"GET"==i.method?" selected":""}>GET</option><option value="POST"${"POST"==i.method?" selected":""}>POST</option><option value="PUT"${"PUT"==i.method?" selected":""}>PUT</option><option value="PATH"${"PATH"==i.method?" selected":""}>PATH</option><option value="DELETE"${"DELETE"==i.method?" selected":""}>DELETE</option></select></div><div class="sb-title">${o("Body")}</div><div class="sb-setting"><textarea placeholder="JSON">${i.body}</textarea></div>`;for(var d=0;d<e.length;d++){let s=i[e[d]];s&&s.length||(s=[["",""]]),t+=`<div class="sb-title">${o(SBF.slugToString(e[d]))}</div><div data-type="repeater" class="sb-setting sb-type-repeater sb-repeater-block-rest-api sb-rest-api-${e[d]}"><div class="input"><div class="sb-repeater">`;for(var u=0;u<s.length;u++)t+=`<div class="repeater-item"><div>${1==d?c.replace(`"${s[u][0]}"`,`"${s[u][0]}" selected`):`<div class="sb-setting"><input type="text" placeholder="${o("Key")}" value="${s[u][0]}" /></div>`}<div class="sb-setting"><input type="text" placeholder="${o(1==d?"e.g. data.id":"Value")}" value="${s[u][1]}" /></div></div><i class="sb-icon-close"></i></div>`;t+=`</div><div class="sb-btn sb-btn-white sb-repeater-add sb-icon"><i class="sb-icon-plus"></i>${o("Add new item")}</div></div></div>`}break;case"condition":t=r}if("start"!=a&&(t+=`<div id="sb-block-delete" class="sb-btn-text"><i class="sb-icon-delete"></i>${o("Delete")}</div>`),dt.genericPanel("flow-block",SBF.slugToString(a),t,["Save changes"],"",!0),"start"==a||"condition"==a){Array.isArray(i.message)||(i.message=[{message:i.message}]);let e=k.find(".sb-flow-start-messages .sb-repeater"),t=at.repeater.set(i.message,e.find(".repeater-item:last-child"));at.automations.setConditions(i.conditions,k.find(".sb-flow-conditions")),t&&e.html(t)}He=[],le.find("> div").each(function(){He.push(e(this).find("> div")[0].scrollTop)})}),e(k).on("click",".sb-flow-block-box #sb-save-changes",function(){let t=st.openAI.flows.blocks.get(),i=k.find(".sb-flow-block-box");switch(t.message=i.find("textarea").val(),t.type){case"start":if(t.message=at.repeater.get(i.find(".sb-flow-start-messages .repeater-item")),t.start=i.find("select").val(),t.disabled=i.find("#sb-flow-disabled").is(":checked"),t.conditions=at.automations.getConditions(i.find(".sb-flow-conditions")),t.message.length&&t.message[0].message.trim().split(" ").length<3)return i.find(".sb-info").sbActive(!0).html(o("The message must contain at least 3 words."));break;case"button_list":t.options=i.find(".sb-repeater input").map(function(){return e(this).val().trim()}).get().filter(function(e){return""!=e});break;case"message":t.attachments=i.find(".sb-repeater input").map(function(){return e(this).val().trim()}).get().filter(function(e){return""!=e});break;case"video":t.url=i.find("input").val();break;case"get_user_details":t.details=i.find(".repeater-item").map(function(){return[[e(this).find("select").val(),e(this).find("input[type=text]").val(),e(this).find("input[type=checkbox]").is(":checked")]]}).get();break;case"action":case"set_data":t["action"==t.type?"actions":"data"]=i.find(".repeater-item").map(function(){return[[e(this).find("select").val(),e(this).find("input").length?e(this).find("input").val().replace(/https?:\/\/|["|:]/g,""):""]]}).get();break;case"rest_api":t.headers=i.find(".sb-rest-api-headers .repeater-item").map(function(){return[[e(this).find("input").eq(0).val(),e(this).find("input").eq(1).val()]]}).get(),t.save_response=i.find(".sb-rest-api-save_response .repeater-item").map(function(){return[[e(this).find("select").val(),e(this).find("input").val()]]}).get(),t.url=i.find(".sb-rest-api-url").val(),t.method=i.find(".sb-rest-api-method").val(),t.body=i.find("textarea").val(),delete t.message;break;case"condition":t.conditions=at.automations.getConditions(i.find(".sb-flow-conditions"))}st.openAI.flows.blocks.set(t),le.find("> div").each(function(){e(this).find("> div")[0].scrollTop=He[e(this).index()]}),k.sbHideLightbox()}),e(k).on("change",".sb-repeater-block-actions select",function(){e(this).parent().next().remove(),e(this).parent().parent().append(st.openAI.getCode.action(e(this).val(),""))}),e(k).on("change",".sb-flow-start-select",function(){k.find(".sb-title-flow-start, .sb-flow-start-messages").setClass("sb-hide","message"!=e(this).val())}),e(le).on("mouseleave",".sb-flow-connectors > div, .sb-flow-block",function(){le.find(".sb-flow-block-cnt").sbActive(!1),Oe=!1,e(this).parent().hasClass("sb-flow-connectors")?st.openAI.flows.blocks.activateLinkedCnts(e(this).closest(".sb-flow-block")):le.find(".sb-flow-connectors > div").sbActive(!1)}),e(le).on("mouseenter",".sb-flow-connectors > div",function(){let t=e(this).closest(".sb-flow-block").parent(),i=st.openAI.flows.blocks.getNextCntIndexes(st.openAI.flows.getActiveIndex(),t.parent().parent().index(),t.index());Oe=!0,le.find("> div").eq(t.parent().parent().index()+1).find(".sb-flow-block-cnt").sbActive(!1).eq(i[e(this).index()]).sbActive(!0)}),e(le).on("mouseenter",".sb-flow-block",function(){st.openAI.flows.blocks.activateLinkedCnts(this)}),e(le).on("click",".sb-flow-add-block",function(){le.find(".sb-flow-block,.sb-flow-add-block").sbActive(!1),e(this).sbActive(!0);let t=st.openAI.flows.steps.get()[st.openAI.flows.blocks.getActiveCntIndex()].map(e=>e.type),i=!t.some(e=>["message","button_list","video","get_user_details","condition"].includes(e)),s=[["set_data","Set data"],["action","Action"],["condition","Condition"],["rest_api","REST API"]],a="";for(var n=0;n<s.length;n++)t.includes(s[n][0])||(a+=`<li data-value="${s[n][0]}">${o(s[n][1])}</li>`);dt.genericPanel("flows-blocks-nav","",`<ul class="sb-menu">${i?`<li>${o("Messages")} <ul><li data-value="message">${o("Send message")}</li><li data-value="button_list">${o("Send button list")}</li><li data-value="video">${o("Send video")}</li></ul></li>`:""}<li>${o("More")} <ul>${i?`<li data-value="get_user_details">${o("Get user details")}</li>`:""}${a}</ul></li></ul>`)}),e(k).on("click","#sb-block-delete",function(){st.openAI.flows.blocks.delete(),k.sbHideLightbox()}),e(re).on("click","li",function(){st.openAI.flows.show(e(this).attr("data-value"))}),e(re).on("click","li i",function(t){return i("The flow will be deleted.","alert",()=>{st.openAI.flows.delete(e(this).parent().attr("data-value"))}),t.preventDefault(),!1}),e(k).on("click",".sb-flows-blocks-nav-box [data-value]",function(){st.openAI.flows.blocks.add(e(this).data("value")),k.sbHideLightbox()}),e(k).on("mouseenter",".sb-flow-scroll",function(){let t=e(this).hasClass("sb-icon-arrow-left");ce=setInterval(()=>{le[0].scrollLeft+=10*(t?-1:1)},10)}),e(k).on("mouseleave",".sb-flow-scroll",function(){clearInterval(ce)}),e(te).on("click","#sb-train-chatbot",function(t){let s="The chatbot has been successfully trained.",n=te.find('.sb-nav [data-value="conversations"]');if(i("<br><br><br><br><br>","info",!1,"sb-embeddings-box"),t.preventDefault(),SB_ADMIN_SETTINGS.cloud&&SBCloud.creditsAlert(this,t))return!1;if(a(this))return!1;if("flows"==te.find(".sb-menu-chatbot .sb-active").attr("data-type"))return st.openAI.flows.save(e=>{i(s,"info",!1,!1,"Success")}),void e(this).sbLoading(!1);if(n.sbActive()){let t=[];for(var r=0;r<Ve.length;r++){let i=te.find(`#sb-chatbot-conversations [data-index="${r}"]`);i.length?(i=[i.find("input").val(),i.find("textarea").val()])[0]==e("<textarea />").html(Ve[r].question).text()&&i[1]==e("<textarea />").html(Ve[r].answer).text()||(Ve[r].question=i[0],Ve[r].answer=i[1],t.push(Ve[r])):(Ve[r].question=!1,Ve[r].answer=!1,t.push(Ve[r]))}return void(t.length?SBF.ajax({function:"open-ai-save-conversation-embeddings",qea:t},t=>{!0===t[0]?i(s,"info",!1,!1,"Success"):st.openAI.train.isError(t[0])||i(t[0]),n.click(),e(this).sbLoading(!1)}):(e(this).sbLoading(!1),i(s,"info",!1,!1,"Success")))}st.openAI.train.errors=[];return st.openAI.train.files(t=>{st.openAI.train.urls=te.find('[data-id="open-ai-sources-url"]').map(function(){return e(this).val().trim()}).get(),st.openAI.train.extract_url=te.find('[data-id="open-ai-sources-extract-url"]').map(function(){return e(this).is(":checked")}).get(),st.openAI.train.website(t=>{st.openAI.train.qea(t=>{st.openAI.train.articles(t=>{st.openAI.init(),te.find("#sb-repeater-chatbot-website .repeater-item i").click(),st.openAI.train.errors.length?(i(o("The chatbot has been trained with errors. Check the console for more details.")+"\n\n<pre>"+st.openAI.train.errors.join("<br>").replaceAll("false,","")+"</pre>","info",!1,"sb-errors-list-box",!1,!0),console.error(st.openAI.train.errors)):st.openAI.train.isError(t)||i(s,"info",!1,!1,"Success"),e(this).sbLoading(!1)})})})}),!1}),e(te).on("click","#sb-table-chatbot-files td i, #sb-table-chatbot-website td i, #sb-chatbot-delete-files, #sb-chatbot-delete-website, #sb-chatbot-delete-all-training, #sb-chatbot-delete-all-training-conversations",function(){let s=e(this).is("i"),n=!!s&&e(this).closest("tr");return s&&n.hasClass("sb-pending")?(st.openAI.train.skip_files.push(n.attr("data-name")),void n.remove()):(i("The training data will be permanently deleted.","alert",()=>{let o=[],r=e(this).attr("id");if(s)o=[n.attr("data-url")];else if("sb-chatbot-delete-all-training"==r)o="all";else if("sb-chatbot-delete-all-training-conversations"==r)o="all-conversations";else{let t=e("sb-chatbot-delete-files"==r?ie:se);t.find("input:checked").length||t.find("input").prop("checked",!0),t.find("tr").each(function(){if(e(this).find("input:checked").length)if(e(this).hasClass("sb-pending"))st.openAI.train.skip_files.push(e(this).attr("data-name")),e(this).remove();else{let t=e(this).attr("data-url");o.push(t),st.openAI.train.sitemap_processed_urls.indexOf(t)>-1&&(st.openAI.train.sitemap_processed_urls[st.openAI.train.sitemap_processed_urls.indexOf(t)]=!1)}})}if(o.length){if(a(this))return;SBF.ajax({function:"open-ai-embeddings-delete",sources_to_delete:o},s=>{st.openAI.init(),"all"==o?te.find('.sb-nav [data-value="info"]').click():"all-conversations"==o&&te.find('.sb-nav [data-value="conversations"]').click(),!0===s?t("Training data deleted."):i(s),e(this).sbLoading(!1)})}}),!1)}),e(te).on("click",'.sb-nav [data-value="conversations"]',function(){let e=te.find("#sb-chatbot-conversations");a(e)||SBF.ajax({function:"open-ai-get-conversation-embeddings"},t=>{if(t.length){let s="";Ve=t;for(var i=0;i<t.length;i++)s+=`<div class="repeater-item" data-value="${t[i].id}" data-index=${i}><div><label>${o("Question")}</label><input data-id="q" type="text" value="${t[i].question}" /></div><div class="sb-qea-repeater-answer"><label>${o("Answer")}</label><textarea data-id="a">${t[i].answer}</textarea></div><i class="sb-icon-close"></i></div>`;e.find(".sb-repeater").html(s)}else e.html(`<p class="sb-no-results">${o("No conversations found.")}</p>`);e.sbLoading(!1)})}),e(te).on("click",'.sb-nav [data-value="info"]',function(){let e=te.find("#sb-chatbot-info");a(e)||SBF.ajax({function:"open-ai-get-information"},t=>{let i=[["files","Files"],["website","Website URLs"],["qea","Q&A"],["flows","Flows"],["articles","Articles"],["conversations","Conversations"]],s=`<h2>${o("Sources")}</h2><p>`;for(var a=0;a<i.length;a++)s+=t[i[a][0]]?`${t[i[a][0]][1]} ${o(i[a][1])} (${t[i[a][0]][0]} ${o("chars")})<br>`:"";s+=`</p><h2>${o("Total detected characters")}</h2><p>${t.total} ${o("chars")+(t.limit?" / "+t.limit+" "+o("limit"):"")}</p><hr><div id="sb-chatbot-delete-all-training" class="sb-btn sb-btn-white">${o("Delete all training data")}</div>`,e.html(s),e.sbLoading(!1)})}),e(te).on("click",".sb-menu-chatbot [data-type]",function(t){let i=e(this).data("type");switch(i){case"flows":case"training":case"playground":let e=te.find(`> [data-id="${i}"]`);te.find("> [data-id]").sbActive(!1),e.sbActive(!0),"flows"==i&&e.sbLoading()&&SBF.ajax({function:"open-ai-flows-get"},t=>{for(s=0;s<t.length;s++)t[s]&&t[s].steps&&t[s].name&&st.openAI.flows.flows.push(t[s]);let i="";for(var s=0;s<t.length;s++)t[s]&&(i+=st.openAI.flows.navCode(t[s].name,t[s].label));re.html(i),re.find("li:first-child").click(),e.sbLoading(!1)});break;case"settings":return at.open("dialogflow",!0),t.preventDefault,!1}}),e(se).on("click","[data-url]",function(){window.open(e(this).attr("data-url"))}),e(ae).on("click",".sb-enlarger-function-calling",function(){e(this).parent().parent().find(".sb-qea-repeater-answer").addClass("sb-hide")}),e(ae).on("change",'[data-id="open-ai-faq-set-data"] select',function(){e(this).parent().next().find("input").setClass("sb-hide",["transcript","transcript_email","human_takeover","archive_conversation"].includes(e(this).val()))}),e(ae).on("input click",'[data-id="open-ai-faq-answer"]',function(){e(this).prev().find("i").sbActive(e(this).val().length>2&&e(this).val().indexOf(" "))}),e(ae).on("click",".sb-qea-repeater-answer > label > i",function(){let t=e(this).closest(".repeater-item").find('[data-id="open-ai-faq-answer"]');a(this)||st.openAI.rewrite(t.val(),i=>{e(this).sbLoading(!1),i[0]&&t.val(i[1])})}),e(ne).on("click",'[data-value="add"], [data-value="send"]',function(){let t=ne.find("textarea"),s=t.val().trim();if(t.val(""),s&&st.openAI.playground.addMessage(s,ne.find('[data-value="user"], [data-value="assistant"]').attr("data-value")),"send"==e(this).data("value")){let t=st.openAI.playground.messages.length;t&&!a(this)&&SBF.ajax({function:"open-ai-playground-message",messages:st.openAI.playground.messages},s=>{if(s[0]){if(s[1]&&(st.openAI.playground.addMessage(s[1],"assistant",s[6]),s[4])){let e="";for(var a in s[4].usage)["string","number"].includes(typeof s[4].usage[a])&&(e+=`<b>${SBF.slugToString(a)}</b>: ${s[4].usage[a]}<br>`);st.openAI.playground.last_response=s[4],te.find(".sb-playground-info").html(e+`<div id="sb-playground-query" class="sb-btn-text">${o("View code")}</div>${s[4].embeddings?`<div id="sb-playground-embeddings" class="sb-btn-text">${o("Embeddings")}</div>`:""}`),s[4].payload&&st.openAI.playground.messages[t-1].push(s[4].payload)}s[8]&&C.find(`[data-conversation-id="${s[8]}"]`).remove()}else i(s),console.error(s);e(this).sbLoading(!1)})}}),e(te).on("click","#sb-playground-query",function(){i("<pre>"+JSON.stringify(st.openAI.playground.last_response.query,null,4).replaceAll('\\"','"')+"</pre>","info",!1,"sb-playground-query-panel",!1,!0)}),e(te).on("click","#sb-playground-embeddings",function(){let e="",t=st.openAI.playground.last_response.embeddings;for(var s=t.length-1;s>-1;s--)e+=`<span><b>${o("Source")}</b>: ${t[s].source?t[s].source.autoLink({target:"_blank"}):""}<br><b>${o("Score")}</b>: ${t[s].score}<br><span>${t[s].text}</span></span>`;i(e,"info",!1,"sb-playground-embeddings-panel",!1,!0)}),e(ne).on("click",'[data-value="clear"]',function(){st.openAI.playground.messages=[],oe.html(""),te.find(".sb-playground-info").html("")}),e(oe).on("click",".sb-icon-close",function(){let t=e(this).closest("[data-type]");st.openAI.playground.messages.splice(t.index(),1),t.remove()}),e(oe).on("click",".sb-rich-chips .sb-btn",function(){ne.find("textarea").val(e(this).html()),ne.find('[data-value="send"]').click()}),e(ne).on("click",'[data-value="user"], [data-value="assistant"]',function(){let t="user"==e(this).attr("data-value");e(this).attr("data-value",t?"assistant":"user").html('<i class="sb-icon-reload"></i> '+o(t?"Assistant":"User"))}),e(k).on("click","#open-ai-troubleshoot a, #google-troubleshoot a",function(s){let n=e(this).parent().attr("id");return s.preventDefault(),!("google-troubleshoot"!=n&&![!0,"mode"].includes(st.openAI.troubleshoot()))&&(a(this)?void 0:(SBF.ajax({function:e(this).parent().attr("id")},s=>{!0===s?t("Success. No issues found."):i(s),e(this).sbLoading(!1),e(A).find(".sb-admin-list .sb-select li.sb-active").click()}),!1))}),e(X).on("click",".ce-settings__button--delete.ce-settings__button--confirm",function(){let e=X.find(".image-tool--filled img").attr("src");e&&SBF.ajax({function:"delete-file",path:e})}),e(X).on("click",".ul-articles li",function(t){i("The changes will be lost.","alert",()=>{nt.show(e(this).attr("data-id")),X.find(".sb-scroll-area:not(.sb-nav)").scrollTop(0)},!1,!1,!1,!Pe,()=>{e(this).parent().find("li").sbActive(!1),e(this).parent().find(`[data-id="${nt.activeID()}"]`).sbActive(!0)})}),e(X).on("click",".ul-categories li",function(t){nt.categories.show(e(this).attr("data-id"))}),e(X).on("click",".sb-add-article",function(){nt.add()}),e(X).on("click",".sb-add-category",function(){nt.categories.add()}),e(X).on("click",".sb-nav i",function(t){let s=e(this).parent(),n=s.closest("ul"),o=n.hasClass("ul-categories");return i(`The ${o?"category":"article"} will be deleted permanently.`,"alert",()=>{let t=s.attr("data-id");if(o)nt.categories.delete(t);else{if(X.find("#editorjs .image-tool__image-picture").each(function(){SBF.ajax({function:"delete-file",path:e(this).attr("src")})}),!t)return s.remove();a(Q),nt.delete(t,e=>{Q.sbLoading(!1),p(),n.find("li").length>1&&setTimeout(()=>{s.prev().length?s.prev().click():s.next().click(),s.remove()},300)})}}),t.preventDefault(),!1}),e(X).on("click",".sb-menu-wide li",function(){let t=e(this).data("type");"settings"==t?at.open("articles",!0):"reports"==t?ot.open("articles-searches"):(X.attr("data-type",t),nt.categories.update())}),e(X).on("click",".sb-save-articles",function(){a(this)||("categories"==X.attr("data-type")?nt.categories.save(t=>{e(this).sbLoading(!1)}):nt.save(t=>{e(this).sbLoading(!1)}))}),e(X).on("change input","input, textarea, select",function(){Pe=!0}),e(K).on("change",function(){ee.val()||(t("Select a parent category first.","error"),e(this).val(""))}),e(Te).on("click",".sb-nav [id]",function(){let t=e(this).attr("id");ot.active_report=!1,Te.find("#sb-date-picker").val(""),Te.attr("class","sb-area-reports sb-active sb-report-"+t),ot.initReport(e(this).attr("id")),SBF.getURL("report")!=t&&f("?report="+t)}),e(Te).on("change","#sb-date-picker",function(){ot.initReport(!1,e(this).val())}),e(Te).on("click",".sb-report-export",function(){e(this).sbLoading()||ot.export(t=>{e(this).sbLoading(!1),t&&_(t,"sb-export-report-close","Report exported")})}),SBF.getURL("report")&&(Te.sbActive()||x.find(".sb-admin-nav #sb-reports").click(),setTimeout(()=>{Te.find("#"+SBF.getURL("report")).click()},500)),e(A).on("click",".sb-panel-woocommerce > i",function(){st.woocommerce.conversationPanel()}),e(A).on("click",".sb-woocommerce-orders > div > span",function(t){let i=e(this).parent();e(t.target).is("span")&&(i.sbActive()||st.woocommerce.conversationPanelOrder(i.attr("data-id")))}),e(A).on("click",".sb-btn-woocommerce",function(){(Le.sbLoading()||0!=s()&&s().language!=st.itemsPanel.panel_language)&&st.itemsPanel.populate("woocommerce"),Ee.find(".sb-search-btn").sbActive(!0).find("input").get(0).focus(),Ee.sbTogglePopup(this)}),e(Ee).find(".sb-woocommerce-products-list").on("scroll",function(){d(this,!0)&&st.itemsPanel.pagination(this,"woocommerce")}),e(Ee).on("click",".sb-select li",function(){st.itemsPanel.filter(this,"woocommerce")}),e(Ee).on("input",".sb-search-btn input",function(){st.itemsPanel.search(this,"woocommerce")}),e(Ee).on("click",".sb-search-btn i",function(){SBF.searchClear(this,()=>{st.itemsPanel.search(e(this).next(),"woocommerce")})}),e(Ee).on("click",".sb-woocommerce-products-list li",function(){let t=Ee.attr("data-action"),i=e(this).data("id");SBF.null(t)?SBChat.insertText(`{product_card id="${i}"}`):(Le.sbLoading(!0),A.find(".sb-add-cart-btn").sbLoading(!0),SBChat.sendMessage(-1,"",[],e=>{e&&(st.woocommerce.conversationPanelUpdate(i),k.sbHideLightbox())},{event:"woocommerce-update-cart",action:"cart-add",id:i})),SBF.deactivateAll(),k.removeClass("sb-popup-active")}),e(A).on("click",".sb-panel-woocommerce .sb-add-cart-btn",function(){e(this).sbLoading()||(SBChat.user_online?(st.itemsPanel.populate("woocommerce"),Ee.sbShowLightbox(!0,"cart-add")):i("The user is offline. Only the carts of online users can be updated."))}),e(A).on("click",".sb-panel-woocommerce .sb-list-items > a > i",function(t){let i=e(this).parent().attr("data-id");return SBChat.sendMessage(-1,"",[],()=>{st.woocommerce.conversationPanelUpdate(i,"removed")},{event:"woocommerce-update-cart",action:"cart-remove",id:i}),e(this).sbLoading(!0),t.preventDefault(),!1}),e(A).on("click",".sb-panel-ump > i",function(){st.ump.conversationPanel()}),e(A).on("click",".sb-panel-armember > i",function(){st.armember.conversationPanel()}),e(A).on("click",".sb-panel-opencart > i",function(){st.opencart.conversationPanel()}),e(A).on("click",".sb-opencart-orders > a",function(){st.opencart.openOrder(e(this).attr("data-id"))}),e(H).on("click","#opencart-sync a",function(t){t.preventDefault(),a(this)||SBF.ajax({function:"opencart-sync"},t=>{e(this).sbLoading(!1),i(!0===t?"Users successfully imported.":t)})}),e(H).on("click","#perfex-sync a, #whmcs-sync a, #perfex-articles-sync a, #whmcs-articles-sync a, #aecommerce-sync a, #aecommerce-sync-admins a, #aecommerce-sync-sellers a, #martfury-sync a, #martfury-sync-sellers a",function(t){if(a(this))return;let s=e(this).closest("[id]").attr("id"),n=s.indexOf("article")>0;SBF.ajax({function:s},t=>{!0===t?(n||rt.update(),i(n?"Articles successfully imported.":"Users successfully imported.")):i("Error. Response: "+JSON.stringify(t)),e(this).sbLoading(!1)}),t.preventDefault()}),e(A).on("click","#sb-zendesk-btn",function(t){a(this)||(SBF.ajax({function:"zendesk-create-ticket",conversation_id:SBChat.conversation.id},t=>{!0===t?st.zendesk.conversationPanel():i("Error. Response: "+JSON.stringify(t)),e(this).sbLoading(!1)}),t.preventDefault())}),e(A).on("click","#sb-zendesk-update-ticket",function(t){if(!a(this))return SBF.ajax({function:"zendesk-update-ticket",conversation_id:SBChat.conversation.id,zendesk_ticket_id:e(this).closest("[data-id]").attr("data-id")},()=>{e(this).sbLoading(!1)}),t.preventDefault(),!1}),e(k).on("click",".sb-enlarger",function(){e(this).sbActive(!0)}),e(k).on("mouseenter","[data-sb-tooltip-init]",function(){e(this).parent().sbInitTooltips(),e(this).removeAttr("data-sb-tooltip-init"),e(this).trigger("mouseenter")}),e(k).on("click",".sb-language-switcher > i",function(){let t=e(this).parent(),i=t.find("[data-language]").map(function(){return e(this).attr("data-language")}).get(),s="";i.push("en");for(var a in SB_LANGUAGE_CODES)i.includes(a)||(s+=`<div data-language="${a}"><img src="${SB_URL}/media/flags/${a}.png" />${o(SB_LANGUAGE_CODES[a])}</div>`);fe=t,dt.genericPanel("languages","Choose a language",s,[],' data-source="'+t.attr("data-source")+'"',!0)}),e(k).on("click",".sb-language-switcher img",function(){let t=e(this).parent(),s=t.sbActive(),a=!s&&t.attr("data-language");switch(t.parent().attr("data-source")){case"article-categories":nt.categories.show(nt.categories.activeID(),a);break;case"articles":let e=Q.find(".sb-language-switcher .sb-active");i("The changes will be lost.","alert",()=>{let e=t.attr("data-id");e||s?nt.show(e&&!s?e:nt.activeID(!0)):nt.clear()},!1,!1,!1,!Pe,()=>{t.sbActive(!1),e.sbActive(!0)});break;case"automations":at.automations.show(!1,a);break;case"settings":let n=t.parent().find("[data-language].sb-active");at.translations.save(t,s?t.attr("data-language"):!!n.length&&n.attr("data-language")),at.translations.activate(t,a)}t.siblings().sbActive(!1),t.sbActive(!s)}),e(k).on("click",".sb-language-switcher span > i",function(){let t=e(this).parent(),s=t.attr("data-language");i(o("The {T} translation will be deleted.").replace("{T}",o(SB_LANGUAGE_CODES[s])),"alert",()=>{switch(t.parent().attr("data-source")){case"article-categories":nt.categories.translations.delete(s);break;case"articles":nt.translations.delete(s);break;case"automations":at.automations.deleteTranslation(!1,s),at.automations.show();break;case"settings":at.translations.delete(t,s)}t.remove()})}),e(k).on("click",".sb-languages-box [data-language]",function(){let t=e(this).parents().eq(1),s=e(this).attr("data-language"),a=!0;switch(t.attr("data-source")){case"article-categories":nt.categories.translations.add(s);break;case"articles":i("The changes will be lost.","alert",()=>{nt.translations.add(s),k.sbHideLightbox()},!1,!1,!1,!Pe),a=!1;break;case"automations":at.automations.addTranslation(!1,!1,s),at.automations.show(!1,s);break;case"settings":at.translations.add(s)}a&&k.sbHideLightbox()}),e(k).on("click",".sb-lightbox .sb-top-bar .sb-close",function(){k.sbHideLightbox()}),e(k).on("click",".sb-lightbox .sb-info",function(){e(this).sbActive(!1)}),e(k).on("click",".sb-dialog-box a",function(){let t=e(this).closest(".sb-lightbox");e(this).hasClass("sb-confirm")&&be(),e(this).hasClass("sb-cancel")&&ve&&ve(),1==k.find(".sb-lightbox.sb-active").length&&we.sbActive(!1),dt.open_popup=!1,t.sbActive(!1)}),e(k).on("click",".sb-menu-wide li, .sb-nav li",function(){e(this).siblings().sbActive(!1),e(this).sbActive(!0)}),e(k).on("click",".sb-nav:not(.sb-nav-only) li:not(.sb-tab-nav-title)",function(){let t=e(this).closest(".sb-tab"),i=e(t).find(" > .sb-content > div").sbActive(!1).eq(e(this).parent().find("li:not(.sb-tab-nav-title)").index(this));i.sbActive(!0),i.find("textarea").each(function(){e(this).autoExpandTextarea(),e(this).manualExpandTextarea()}),t.find(".sb-scroll-area:not(.sb-nav)").scrollTop(0)}),e(k).sbInitTooltips(),e(k).on("click",'[data-button="toggle"]',function(){let t=k.find("."+e(this).data("show")),i=k.find("."+e(this).data("hide"));t.addClass("sb-show-animation").show(),i.hide(),dt.open_popup=!(!t.hasClass("sb-lightbox")&&!t.hasClass("sb-popup"))&&t}),e(k).on("click",".sb-info-card",function(){e(this).sbActive(!1)}),e(de).on("change",function(){pe?(pe(),pe=!1):(e(ue).sbLoading(e(this).prop("files").length),e(this).sbUploadFiles(t=>{if(e(ue).sbLoading(!1),"success"==(t=JSON.parse(t))[0]){"upload-image"==e(ue).closest("[data-type]").data("type")&&(e(ue).attr("data-value")&&SBF.ajax({function:"delete-file",path:e(ue).attr("data-value")}),e(ue).attr("data-value",t[1]).css("background-image",`url("${t[1]}")`)),he&&he(t[1])}else console.log(t[1])}))}),e(k).on("click",".sb-accordion > div > span",function(t){let i=e(this).parent(),s=e(i).sbActive();e(t.target).is("span")&&(i.siblings().sbActive(!1),i.sbActive(!s))}),e(k).on("mousedown",function(t){if(e(dt.open_popup).length){let i=e(dt.open_popup);i.is(t.target)||0!==i.has(t.target).length||["sb-btn-saved-replies","sb-btn-emoji","sb-btn-woocommerce","sb-btn-shopify","sb-btn-open-ai"].includes(e(t.target).attr("class"))||(i.hasClass("sb-popup")?i.sbTogglePopup():i.hasClass("sb-select")?i.find("ul").sbActive(!1):i.hasClass("sb-menu-mobile")?i.find("i").sbActive(!1):i.hasClass("sb-menu")?i.sbActive(!1):dt.open_popup&&["sb-embeddings-box"].includes(dt.open_popup.attr("id"))||k.sbHideLightbox(),dt.open_popup=!1)}})})}(jQuery),function(e,t){"object"==typeof exports?module.exports=t(e):"function"==typeof define&&define.amd?define("colors",[],function(){return t(e)}):e.Colors=t(e)}(this,function(e,t){function i(e,i,a,n,o){if("string"==typeof i){a=(i=m.txt2color(i)).type,p[a]=i[a],o=o!==t?o:i.alpha}else if(i)for(var c in i)e[a][c]=r(i[c]/l[a][c][1],0,1);return o!==t&&(e.alpha=r(+o,0,1)),s(a,n?e:t)}function s(e,t){var i,s,r,h=t||p,f=m,g=u.options,b=l,v=h.RND,_="",S="",w={hsl:"hsv",rgb:e},y=v.rgb;if("alpha"!==e){for(var k in b)if(!b[k][k]){e!==k&&(S=w[k]||"rgb",h[k]=f[S+"2"+k](h[S])),v[k]||(v[k]={}),i=h[k];for(_ in i)v[k][_]=d(i[_]*b[k][_][1])}y=v.rgb,h.HEX=f.RGB2HEX(y),h.equivalentGrey=g.grey.r*h.rgb.r+g.grey.g*h.rgb.g+g.grey.b*h.rgb.b,h.webSave=s=a(y,51),h.webSmart=r=a(y,17),h.saveColor=y.r===s.r&&y.g===s.g&&y.b===s.b?"web save":y.r===r.r&&y.g===r.g&&y.b===r.b?"web smart":"",h.hueRGB=m.hue2RGB(h.hsv.h),t&&(h.background=function(e,t,i){var s=u.options.grey,a={};return a.RGB={r:e.r,g:e.g,b:e.b},a.rgb={r:t.r,g:t.g,b:t.b},a.alpha=i,a.equivalentGrey=d(s.r*e.r+s.g*e.g+s.b*e.b),a.rgbaMixBlack=o(t,{r:0,g:0,b:0},i,1),a.rgbaMixWhite=o(t,{r:1,g:1,b:1},i,1),a.rgbaMixBlack.luminance=n(a.rgbaMixBlack,!0),a.rgbaMixWhite.luminance=n(a.rgbaMixWhite,!0),u.options.customBG&&(a.rgbaMixCustom=o(t,u.options.customBG,i,1),a.rgbaMixCustom.luminance=n(a.rgbaMixCustom,!0),u.options.customBG.luminance=n(u.options.customBG,!0)),a}(y,h.rgb,h.alpha))}var x,B,A,T=h.rgb,I=h.alpha,$="luminance",C=h.background;return x=o(T,{r:0,g:0,b:0},I,1),x[$]=n(x,!0),h.rgbaMixBlack=x,B=o(T,{r:1,g:1,b:1},I,1),B[$]=n(B,!0),h.rgbaMixWhite=B,g.customBG&&(A=o(T,C.rgbaMixCustom,I,1),A[$]=n(A,!0),A.WCAG2Ratio=function(e,t){var i=1;return i=e>=t?(e+.05)/(t+.05):(t+.05)/(e+.05),d(100*i)/100}(A[$],C.rgbaMixCustom[$]),h.rgbaMixBGMixCustom=A,A.luminanceDelta=c.abs(A[$]-C.rgbaMixCustom[$]),A.hueDelta=function(e,t,i){return(c.max(e.r-t.r,t.r-e.r)+c.max(e.g-t.g,t.g-e.g)+c.max(e.b-t.b,t.b-e.b))*(i?255:1)/765}(C.rgbaMixCustom,A,!0)),h.RGBLuminance=n(y),h.HUELuminance=n(h.hueRGB),g.convertCallback&&g.convertCallback(h,e),h}function a(e,t){var i={},s=0,a=t/2;for(var n in e)s=e[n]%t,i[n]=e[n]+(s>a?t-s:-s);return i}function n(e,t){for(var i=t?1:255,s=[e.r/i,e.g/i,e.b/i],a=u.options.luminance,n=s.length;n--;)s[n]=s[n]<=.03928?s[n]/12.92:c.pow((s[n]+.055)/1.055,2.4);return a.r*s[0]+a.g*s[1]+a.b*s[2]}function o(e,i,s,a){var n={},o=s!==t?s:1,r=a!==t?a:1,l=o+r*(1-o);for(var c in e)n[c]=(e[c]*o+i[c]*r*(1-o))/l;return n.a=l,n}function r(e,t,i){return e>i?i:t>e?t:e}var l={rgb:{r:[0,255],g:[0,255],b:[0,255]},hsv:{h:[0,360],s:[0,100],v:[0,100]},hsl:{h:[0,360],s:[0,100],l:[0,100]},alpha:{alpha:[0,1]},HEX:{HEX:[0,16777215]}},c=e.Math,d=c.round,u={},p={},h={r:.298954,g:.586434,b:.114612},f={r:.2126,g:.7152,b:.0722},g=function(e){this.colors={RND:{}},this.options={color:"rgba(0,0,0,0)",grey:h,luminance:f,valueRanges:l},b(this,e||{})},b=function(e,s){var a,n=e.options;v(e);for(var o in s)s[o]!==t&&(n[o]=s[o]);a=n.customBG,n.customBG="string"==typeof a?m.txt2color(a).rgb:a,p=i(e.colors,n.color,t,!0)},v=function(e){u!==e&&(u=e,p=e.colors)};g.prototype.setColor=function(e,a,n){return v(this),e?i(this.colors,e,a,t,n):(n!==t&&(this.colors.alpha=r(n,0,1)),s(a))},g.prototype.setCustomBackground=function(e){return v(this),this.options.customBG="string"==typeof e?m.txt2color(e).rgb:e,i(this.colors,t,"rgb")},g.prototype.saveAsBackground=function(){return v(this),i(this.colors,t,"rgb",!0)},g.prototype.toString=function(e,t){return m.color2text((e||"rgb").toLowerCase(),this.colors,t)};var m={txt2color:function(e){var t={},i=e.replace(/(?:#|\)|%)/g,"").split("("),s=(i[1]||"").split(/,\s*/),a=i[1]?i[0].substr(0,3):"rgb",n="";if(t.type=a,t[a]={},i[1])for(var o=3;o--;)n=a[o]||a.charAt(o),t[a][n]=+s[o]/l[a][n][1];else t.rgb=m.HEX2rgb(i[0]);return t.alpha=s[3]?+s[3]:1,t},color2text:function(e,t,i){var s=!1!==i&&d(100*t.alpha)/100,a="number"==typeof s&&!1!==i&&(i||1!==s),n=t.RND.rgb,o=t.RND.hsl,r="hex"===e&&a,l="hex"===e&&!r,c="rgb"===e||r?n.r+", "+n.g+", "+n.b:l?"#"+t.HEX:o.h+", "+o.s+"%, "+o.l+"%";return l?c:(r?"rgb":e)+(a?"a":"")+"("+c+(a?", "+s:"")+")"},RGB2HEX:function(e){return((e.r<16?"0":"")+e.r.toString(16)+(e.g<16?"0":"")+e.g.toString(16)+(e.b<16?"0":"")+e.b.toString(16)).toUpperCase()},HEX2rgb:function(e){return e=e.split(""),{r:+("0x"+e[0]+e[e[3]?1:0])/255,g:+("0x"+e[e[3]?2:1]+(e[3]||e[1]))/255,b:+("0x"+(e[4]||e[2])+(e[5]||e[2]))/255}},hue2RGB:function(e){var t=6*e,i=~~t%6,s=6===t?0:t-i;return{r:d(255*[1,1-s,0,0,s,1][i]),g:d(255*[s,1,1,1-s,0,0][i]),b:d(255*[0,0,s,1,1,1-s][i])}},rgb2hsv:function(e){var t,i,s,a=e.r,n=e.g,o=e.b,r=0;return o>n&&(n=o+(o=n,0),r=-1),i=o,n>a&&(a=n+(n=a,0),r=-2/6-r,i=c.min(n,o)),t=a-i,s=a?t/a:0,{h:1e-15>s?p&&p.hsl&&p.hsl.h||0:t?c.abs(r+(n-o)/(6*t)):0,s:a?t/a:p&&p.hsv&&p.hsv.s||0,v:a}},hsv2rgb:function(e){var t=6*e.h,i=e.s,s=e.v,a=~~t,n=t-a,o=s*(1-i),r=s*(1-n*i),l=s*(1-(1-n)*i),c=a%6;return{r:[s,r,o,o,l,s][c],g:[l,s,s,r,o,o][c],b:[o,o,l,s,s,r][c]}},hsv2hsl:function(e){var t=(2-e.s)*e.v,i=e.s*e.v;return i=e.s?1>t?t?i/t:0:i/(2-t):0,{h:e.h,s:e.v||i?i:p&&p.hsl&&p.hsl.s||0,l:t/2}},rgb2hsl:function(e,t){var i=m.rgb2hsv(e);return m.hsv2hsl(t?i:p.hsv=i)},hsl2rgb:function(e){var t=6*e.h,i=e.s,s=e.l,a=.5>s?s*(1+i):s+i-i*s,n=s+s-a,o=~~t,r=a*(a?(a-n)/a:0)*(t-o),l=n+r,c=a-r,d=o%6;return{r:[a,c,n,n,l,a][d],g:[l,a,a,c,n,n][d],b:[n,n,l,a,a,c][d]}}};return g}),function(e,t){"object"==typeof exports?module.exports=t(e,require("jquery"),require("colors")):"function"==typeof define&&define.amd?define(["jquery","colors"],function(i,s){return t(e,i,s)}):t(e,e.jQuery,e.Colors)}(this,function(e,t,i,s){function a(e){return e.value||e.getAttribute("value")||t(e).css("background-color")||"#FFF"}function n(e){return(e=e.originalEvent&&e.originalEvent.touches?e.originalEvent.touches[0]:e).originalEvent?e.originalEvent:e}function o(e){return t(e.find(f.doRender)[0]||e[0])}function r(i){var s=t(this),n=s.offset(),r=t(e),u=f.gap;i?(g=o(s),g._colorMode=g.data("colorMode"),p.$trigger=s,(b||l()).css(f.positionCallback.call(p,s)||{left:(b._left=n.left)-((b._left+=b._width-(r.scrollLeft()+r.width()))+u>0?b._left+u:0),top:(b._top=n.top+s.outerHeight())-((b._top+=b._height-(r.scrollTop()+r.height()))+u>0?b._top+u:0)}).show(f.animationSpeed,function(){!0!==i&&(w.toggle(!!f.opacity)._width=w.width(),m._width=m.width(),m._height=m.height(),v._height=v.height(),h.setColor(a(g[0])),d(!0))}).off(".tcp").on(A,".cp-xy-slider,.cp-z-slider,.cp-alpha",c)):p.$trigger&&t(b).hide(f.animationSpeed,function(){d(!1),p.$trigger=null}).off(".tcp")}function l(){return t("head")[f.cssPrepend?"prepend":"append"]('<style type="text/css" id="tinyColorPickerStyles">'+(f.css||F)+(f.cssAddon||"")+"</style>"),t(C).css({margin:f.margin}).appendTo("body").show(0,function(){p.$UI=b=t(this),I=f.GPU&&b.css("perspective")!==s,v=t(".cp-z-slider",this),m=t(".cp-xy-slider",this),_=t(".cp-xy-cursor",this),S=t(".cp-z-cursor",this),w=t(".cp-alpha",this),y=t(".cp-alpha-cursor",this),f.buildCallback.call(p,b),b.prepend("<div>").children().eq(0).css("width",b.children().eq(0).width()),b._width=this.offsetWidth,b._height=this.offsetHeight}).hide()}function c(e){var i=this.className.replace(/cp-(.*?)(?:\s*|$)/,"$1").replace("-","_");(e.button||e.which)>1||(e.preventDefault&&e.preventDefault(),e.returnValue=!1,g._offset=t(this).offset(),(i="xy_slider"===i?function(e){var t=n(e),i=t.pageX-g._offset.left,s=t.pageY-g._offset.top;h.setColor({s:i/m._width*100,v:100-s/m._height*100},"hsv")}:"z_slider"===i?function(e){var t=n(e).pageY-g._offset.top;h.setColor({h:360-t/v._height*360},"hsv")}:function(e){var t=(n(e).pageX-g._offset.left)/w._width;h.setColor({},"rgb",t)})(e),d(),k.on(T,function(){k.off(".tcp")}).on(B,function(e){i(e),d()}))}function d(e){var t=h.colors,i=t.hueRGB,a=(t.RND.rgb,t.RND.hsl,f.dark),n=f.light,o=h.toString(g._colorMode,f.forceAlpha),r=t.HUELuminance>.22?a:n,l=t.rgbaMixBlack.luminance>.22?a:n,c=(1-t.hsv.h)*v._height,d=t.hsv.s*m._width,p=(1-t.hsv.v)*m._height,b=t.alpha*w._width,k=I?"translate3d":"",x=g[0].value,B=g[0].hasAttribute("value")&&""===x&&e!==s;m._css={backgroundColor:"rgb("+i.r+","+i.g+","+i.b+")"},_._css={transform:k+"("+d+"px, "+p+"px, 0)",left:I?"":d,top:I?"":p,borderColor:t.RGBLuminance>.22?a:n},S._css={transform:k+"(0, "+c+"px, 0)",top:I?"":c,borderColor:"transparent "+r},w._css={backgroundColor:"#"+t.HEX},y._css={transform:k+"("+b+"px, 0, 0)",left:I?"":b,borderColor:l+" transparent"},g._css={backgroundColor:B?"":o,color:B?"":t.rgbaMixBGMixCustom.luminance>.22?a:n},g.text=B?"":x!==o?o:"",e!==s?u(e):$(u)}function u(e){m.css(m._css),_.css(_._css),S.css(S._css),w.css(w._css),y.css(y._css),f.doRender&&g.css(g._css),g.text&&g.val(g.text),f.renderCallback.call(p,g,"boolean"==typeof e?e:s)}var p,h,f,g,b,v,m,_,S,w,y,k=t(document),x=t(),B="touchmove.tcp mousemove.tcp pointermove.tcp",A="touchstart.tcp mousedown.tcp pointerdown.tcp",T="touchend.tcp mouseup.tcp pointerup.tcp",I=!1,$=e.requestAnimationFrame||e.webkitRequestAnimationFrame||function(e){e()},C='<div class="cp-color-picker"><div class="cp-z-slider"><div class="cp-z-cursor"></div></div><div class="cp-xy-slider"><div class="cp-white"></div><div class="cp-xy-cursor"></div></div><div class="cp-alpha"><div class="cp-alpha-cursor"></div></div></div>',F=".cp-color-picker{position:absolute;overflow:hidden;padding:6px 6px 0;background-color:#444;color:#bbb;font-family:Arial,Helvetica,sans-serif;font-size:12px;font-weight:400;cursor:default;border-radius:5px}.cp-color-picker>div{position:relative;overflow:hidden}.cp-xy-slider{float:left;height:128px;width:128px;margin-bottom:6px;background:linear-gradient(to right,#FFF,rgba(255,255,255,0))}.cp-white{height:100%;width:100%;background:linear-gradient(rgba(0,0,0,0),#000)}.cp-xy-cursor{position:absolute;top:0;width:10px;height:10px;margin:-5px;border:1px solid #fff;border-radius:100%;box-sizing:border-box}.cp-z-slider{float:right;margin-left:6px;height:128px;width:20px;background:linear-gradient(red 0,#f0f 17%,#00f 33%,#0ff 50%,#0f0 67%,#ff0 83%,red 100%)}.cp-z-cursor{position:absolute;margin-top:-4px;width:100%;border:4px solid #fff;border-color:transparent #fff;box-sizing:border-box}.cp-alpha{clear:both;width:100%;height:16px;margin:6px 0;background:linear-gradient(to right,#444,rgba(0,0,0,0))}.cp-alpha-cursor{position:absolute;margin-left:-4px;height:100%;border:4px solid #fff;border-color:#fff transparent;box-sizing:border-box}",N=function(e){h=this.color=new i(e),f=h.options,p=this};N.prototype={render:d,toggle:r},t.fn.colorPicker=function(i){var s=this,n=function(){};return i=t.extend({animationSpeed:150,GPU:!0,doRender:!0,customBG:"#FFF",opacity:!0,renderCallback:n,buildCallback:n,positionCallback:n,body:document.body,scrollResize:!0,gap:4,dark:"#222",light:"#DDD"},i),!p&&i.scrollResize&&t(e).on("resize.tcp scroll.tcp",function(){p.$trigger&&p.toggle.call(p.$trigger[0],!0)}),x=x.add(this),this.colorPicker=p||new N(i),this.options=i,t(i.body).off(".tcp").on(A,function(e){-1===x.add(b).add(t(b).find(e.target)).index(e.target)&&r()}),this.on("focusin.tcp click.tcp",function(e){p.color.options=t.extend(p.color.options,f=s.options),r.call(this,e)}).on("change.tcp",function(){h.setColor(this.value||"#FFF"),s.colorPicker.render(!0)}).each(function(){var e=a(this),s=e.split("("),n=o(t(this));n.data("colorMode",s[1]?s[0].substr(0,3):"HEX").attr("readonly",f.preventFocus),i.doRender&&n.css({"background-color":e,color:function(){return h.setColor(e).rgbaMixBGMixCustom.luminance>.22?i.dark:i.light}})})},t.fn.colorPicker.destroy=function(){t("*").off(".tcp"),p.toggle(!1),x=t()}});
>>>>>>> vendor-update
